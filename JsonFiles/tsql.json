{"total":16599,"page":1,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":7,"up_vote_count":18,"down_vote_count":0,"view_count":2043,"score":18,"question_id":1597442,"title":"Subquery using Exists 1 or Exists *","body":"<p>I used to write my EXISTS checks like this:</p>\n\n<pre><code>IF EXISTS (SELECT * FROM TABLE WHERE Columns=@Filters)\nBEGIN\n   UPDATE TABLE SET ColumnsX=ValuesX WHERE Where Columns=@Filters\nEND\n</code></pre>\n\n<p>One of the DBA's in a previous life told me that when I do an <code>EXISTS</code> clause, use <code>SELECT 1</code> instead of <code>SELECT *</code></p>\n\n<pre><code>IF EXISTS (SELECT 1 FROM TABLE WHERE Columns=@Filters)\nBEGIN\n   UPDATE TABLE SET ColumnsX=ValuesX WHERE Columns=@Filters\nEND\n</code></pre>\n\n<p>Does this really make a difference?</p>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":13241518,"title":"sql query including month columns?","body":"<p>I was wondering if I could get some ideas or direction on a sql query that would output column months. Here is my current query..</p>\n\n<pre><code>select A.assetid, A.Acquisition_Cost, B.modepreciaterate from FA00100 A\ninner join FA00200 B on A.assetindex = B.assetindex\nwhere MoDepreciateRate != '0'\n</code></pre>\n\n<p>I would like to add more columns that look as such:</p>\n\n<pre><code>select assetid, acquisition_cost, perdeprrate, Dec_2012, Jan_2013, Feb_2013....\n\nwhere Dec_2012 = (acquisition_cost - MoDepreciateRate*(# of months))\nand Jan_2013 = (acquisition_cost - MoDepreciateRate*(# of months))\n</code></pre>\n\n<p>where # of months can be changed.</p>\n\n<p>Any help would be really appreciated. Thank you!</p>\n\n<p>Here is an example of what I would like the output to be with '# of months' = 4</p>\n\n<pre><code>assetid SHRTNAME    Acquisition_Cost    perdeprrate Dec_2012    Jan_2013    Feb_2013    Mar_2013\nCS-013  GEH INTEG   17490.14            485.83      17004.31    16518.48    16032.65    15546.82\nCS-014  WEB BRD     14560               404.4507    14155.5493  13751.0986  13346.6479  12942.1972\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13297530,"title":"Retrieve a column from a table then insert it to a new table","body":"<p>I just created a table in SQL 2008. This table has two columns.</p>\n\n<pre><code>CREATE TABLE [dbo].[MyTable]\n(\n[pkey] [bigint] not null,\n[Number] [int]  not null\n)\n</code></pre>\n\n<p>Now I want to insert values into it. The first column can be obtained from another table <code>dbo.OldTable</code>. It has many records and I don't want to manually insert the data. The second column <code>Number</code> can be a <code>0</code> in each row. What is the best way to do this?</p>\n"},{"tags":["tsql","dynamics-crm","dynamics-crm-2011","crm","dynamics-crm-4"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":6,"score":0,"question_id":13297593,"title":"CRM Reports: Grouping by a related Entity","body":"<p>There is an N&lt;>N relationship between Contacts and Complaints.  </p>\n\n<p>My report currently looks like this: </p>\n\n<pre><code>      Status 1    Status 2    Status 3    Status 4\n         3           4           32          34\n</code></pre>\n\n<p>With the following query: </p>\n\n<pre><code>SELECT \n    SUM(case WHEN status = 1 then 1 else 0 end) Status1,\n    SUM(case WHEN status = 2 then 1 else 0 end) Status2,\n    SUM(case WHEN status = 3 then 1 else 0 end) Status3,\n    SUM(case WHEN status = 4 then 1 else 0 end) Status4,\n    SUM(case WHEN status = 5 then 1 else 0 end) Status5\nFROM [DB].[dbo].[Contact]\n</code></pre>\n\n<p>This is listing the number of contacts in each status.  I'm now trying to GROUP BY a field in a related entity in CRM - complaints.  </p>\n\n<pre><code>                                         Status 1    Status 2    Status 3    Status 4\nContact.Complaints.CreatedBy[1]             3           4           32          34\nContact.Complaints.CreatedBy[2]             3           4           32          34\nContact.Complaints.CreatedBy[3]             3           4           32          34\nContact.Complaints.CreatedBy[4]             3           4           32          34\n</code></pre>\n\n<p>I'm not sure where to get started in my GROUP BY statement - any pointers would be awesome.  I feel like I have to have another FROM statement pointing to the NN relationship, or at least Complaints.  </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":40,"score":3,"question_id":13296853,"title":"SQL Server: how do I get data from a history table?","body":"<p>Can you please help me build an SQL query to retrieve data from a history table?</p>\n\n<p>I'm a newbie with only a one-week coding experience. I've been trying simple SELECT statements so far but have hit a stumbling block.</p>\n\n<p>My football club's database has three tables. The first one links balls to players:</p>\n\n<pre><code>BallDetail\n\n| BallID | PlayerID | TeamID |\n|-------------------|--------|\n|      1 |       11 |     21 |\n|      2 |       12 |     22 |\n</code></pre>\n\n<p>The second one lists things that happen to the balls:</p>\n\n<pre><code>BallEventHistory\n\n| BallID | Event |  EventDate |\n|--------|------ |------------|\n|      1 |  Pass | 2012-01-01 |\n|      1 | Shoot | 2012-02-01 |\n|      1 |  Miss | 2012-03-01 |\n|      2 |  Pass | 2012-01-01 |\n|      2 | Shoot | 2012-02-01 |\n</code></pre>\n\n<p>And the third one is a history change table. After a ball changes hands, history is recorded:</p>\n\n<pre><code>HistoryChanges\n\n| BallID | ColumnName | ValueOld | ValueNew |\n|--------|------------|----------|----------|\n|      2 |   PlayerID |       11 |       12 |\n|      2 |     TeamID |       21 |       22 |\n</code></pre>\n\n<p>I'm trying to obtain a table that would list all passes and shoots Player 11 had done to all balls before the balls went to other players. Like this:</p>\n\n<pre><code>| PlayerID | BallID | Event | Month |\n|----------|--------|-------|-------|\n|       11 |      1 |  Pass |   Jan |\n|       11 |      1 | Shoot |   Feb |\n|       11 |      2 |  Pass |   Jan |\n</code></pre>\n\n<p>I begin so:</p>\n\n<pre><code>SELECT PlayerID, BallID, Event, DateName(month, EventDate)\nFROM BallDetail bd INNER JOIN BallEventHistory beh ON bd.BallID = beh.BallID\nWHERE PlayerID = 11 AND Event IN (Pass, Shoot) ...\n</code></pre>\n\n<p>But how to make sure that Ball 2 also gets included despite being with another player now? </p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":1002,"score":0,"question_id":5043443,"title":"Delete with inner join across 3 tables","body":"<p>I have three tables one of this storing users basic information, the other one is profile information and the last one is storing user picture.</p>\n\n<p>When i deleting these user i need to delete all of the data in these tables. So i write a query like this.</p>\n\n<pre><code>DELETE Kullanicilar FROM Kullanicilar \nINNER JOIN ProfilBilgileri ON Kullanicilar.ID = ProfilBilgileri.UyeID \nINNER JOIN UyeResim ON Kullanicilar.ID = UyeResim.UyeID \nWHERE Kullanicilar.ID=@ID\n</code></pre>\n\n<p>But it just deleting the data from \"Kullanicilar\" table.<br />\nAny suggestions?</p>\n\n<p>EDIT : I'm using MSSQL 2008 but hosting firm 2000 so i need compatible code.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3738,"score":1,"question_id":10914576,"title":"Tsql split string","body":"<p>I have a sql server 2008 r2 column containing a string which I need to split by a comma. I have seen many answers on stackoverflow but none of them work in R2. I have made sure I have select permissions on any split function examples. Any help greatly appreciated.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13296106,"title":"Transpose rows into columns","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/7002069/how-to-transpose-a-resultset-from-sql\">How to Transpose a resultset from SQL</a>  </p>\n</blockquote>\n\n\n\n<p>How can I transform the following result set :</p>\n\n<pre><code>month       value1   value2  value3\n-----------------------------------\njanuary     100000   200000  300000\nfebruary    250000   650000  600000\nmarch       350000   300000  900000\n</code></pre>\n\n<p>into the following:</p>\n\n<pre><code>month     january  february  march\n------------------------------------\nvalue1    1000000  2000000   3000000\nvalue2    2500000  6500000   6000000\nvalue3    3500000  3000000   9000000\n</code></pre>\n\n<p>using T-SQL</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2012"],"answer_count":0,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13295559,"title":"Remove extra blank lines in Alter stored procedure or function","body":"<p>In SQL Server 2012 when I write code for a stored procedure and for any function. After that when I want to alter it added extra blank line gap Each and Every time, that's why it seem very bad..</p>\n\n<p><img src=\"http://i.stack.imgur.com/xOec6.png\" alt=\"enter image description here\"></p>\n\n<p>I want to know some SQL Server setting or any other to resolve this issue</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":17,"score":1,"question_id":13295900,"title":"Deriving a text string from a date","body":"<p>I could use some help deriving a year quarter from a text string that represents a date. I have a string, say '20121230', to represent 12/30/2012. Somehow, someway, I need to convert this value into '4Q12.' I get stuck after converting the 20121230 into a date:</p>\n\n<pre><code>CONVERT(date,datestringfield,111)\n</code></pre>\n\n<p>I need help deriving the quarter and year from this date and then converting the quarter and year to a string format 4Q12. Any help would be greatly appreciated</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":20,"score":0,"question_id":13294882,"title":"Have one part of a query update based on another","body":"<p>I'm not looking for a specific answer to a question so much as a general direction of what to look for when doing further research.  I have a query which is very useful and a certain aspect, <code>mytable.column1</code> I frequently change.  Depending on what <code>mytable.column1</code> is, there is an alias in the table that I would like to change as well.  So, if <code>mytable.column1</code> is 1 the alias needs to be something like <code>aliasFor1</code>, if it's two, then the alias needs to be <code>aliasFor2</code>.  What is the nomenclature for doing something such as this, and what are some good resources for reading up on it?  </p>\n\n<p>If you're going to down vote a question, please respectfully say why you believe it to be not a valid question.</p>\n"},{"tags":["tsql","group-by","multicolumn"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":1,"view_count":23,"score":1,"question_id":13294578,"title":"TSQL Group based on 2 conditions in the same Recordset","body":"<p>I have a question which has been confusing me to 2 days. Here is the problem.  I have a table which looks something like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/98Egu.png\" alt=\"enter image description here\"></p>\n\n<p>What I would like to do is to have to groupings that end up in the same table.  For the example above, I would end up with the following:</p>\n\n<p><img src=\"http://i.stack.imgur.com/6Pv9a.png\" alt=\"enter image description here\"></p>\n\n<p>Can something like this be accomplished?  As you can notice, we are grouping by different columns.  This does not have to be done with one query, however, it does have to end up in one table/dataset.</p>\n"},{"tags":["sql","sql-server","tsql","date"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":127,"score":1,"question_id":12474658,"title":"Calculate total working days left of the month","body":"<p>Below is my code to calculate the total amount of working days in the current month.</p>\n\n<pre><code>DECLARE @my int\nDECLARE @myDeduct int\nDECLARE @day INT\nDECLARE @mydate DATETIME\n\nSET @mydate = getDate()\n\nSET @myDeduct = 0\nSET DateFirst 1 -- Set it monday=1 (value)\n\n--Saturday and Sunday on the first and last day of a month will Deduct 1\nIF (DATEPART(weekday,(DATEADD(dd,-(DAY(@mydate)-1),@mydate))) &gt; 5)\nSET @myDeduct = @myDeduct + 1\n\nIF (DATEPART(weekday,(DATEADD(dd,-(DAY(DATEADD(mm,1,@mydate))),\n                                                 DATEADD(mm,1,@mydate)))) &gt; 5)\nSET @myDeduct = @myDeduct + 1\n\nSET @my = day(DATEADD(dd,-(DAY(DATEADD(mm,1,@mydate))),DATEADD(mm,1,@mydate)))\n\nselect (((@my/7) * 5 + (@my%7)) - @myDeduct) as Working_Day_per_month\n</code></pre>\n\n<p>How can I now calculate how many of those working days are left for the current month?\nNot worried about public holidays.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2","common-table-expression"],"answer_count":1,"favorite_count":2,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":13293359,"title":"Joining massive CTE tables (13,000,000 rows+) performance problems","body":"<p>We have a production database that manages personnel booking at 100s of branches for years in advance with minute level accuracy.</p>\n\n<p>Part of this system are reports that highlight gaps, i.e. compare branch opening hours and staff bookings to see if any branches are open with nobody booked.</p>\n\n<p>It also checks for overlaps, double bookings etc all at the same time, basically minute level accuracy is required.</p>\n\n<p>The way we're doing this is to expand the start and end times of openings hours and bookings into minutes with an integer tally table:</p>\n\n<pre><code>--===== Create and populate the Tally table on the fly\n SELECT TOP 16777216\n        IDENTITY(INT,1,1) AS N\n   INTO dbo.Tally\n   FROM Master.dbo.SysColumns sc1,\n        Master.dbo.SysColumns sc2,\n        Master.dbo.SysColumns sc3\n\n--===== Add a Primary Key to maximize performance\n  ALTER TABLE dbo.Tally\n    ADD CONSTRAINT PK_Tally_N \n        PRIMARY KEY CLUSTERED (N) WITH FILLFACTOR = 100\n</code></pre>\n\n<p>We utilise this static indexed tally table to expand opening hours and bookings as follows:</p>\n\n<pre><code>SELECT   [BranchID] ,\n        [DayOfWeek] ,\n        DATEADD(MINUTE, N - 1, StartTime)\nFROM     OpeningHours\n        LEFT OUTER JOIN tally ON tally.N BETWEEN 0\n                                         AND     DATEDIFF(MINUTE, OpeningHours.StartTime, OpeningHours.EndTime) + 1\n</code></pre>\n\n<p>The problem is, once we have the 13,000,000 \"open minutes\" and the \"booked minutes\" we then need to join the results to see what's covered:</p>\n\n<pre><code>SELECT   OpenDatesAndMinutes.[Date] ,\n                                OpenDatesAndMinutes.[Time] ,\n                                OpenDatesAndMinutes.[BranchID] ,\n                                ISNULL(BookedMinutes.BookingCount, 0) AS BookingCount\n                       FROM     OpenDatesAndMinutes\n                                LEFT OUTER JOIN BookedMinutes ON OpenDatesAndMinutes.BranchID = BookedMinutes.BranchID\n                                                                 AND OpenDatesAndMinutes.[Date] = BookedMinutes.[Date]\n                                                                 AND OpenDatesAndMinutes.[Time] = BookedMinutes.[Time]\n</code></pre>\n\n<p>As you can imagine, joining on the branch, date &amp; time with 13,000,000 rows all stored in CTE tables takes AGES - running it for a week isnt too bad, about 10 seconds but if we run it for 6 months (13,000,000 minutes) bloats to 25 minutes+</p>\n\n<p>Once we have joined the open minutes to the booked minutes we then group the data on islands and present to the user:</p>\n\n<pre><code>CrossTabPrep ( [Date], [Time], [BranchID], [BookingCount], [Grp] )\n  AS ( SELECT   [Date] ,\n                [Time] ,\n                [BranchID] ,\n                [BookingCount] ,\n                DATEPART(HOUR, Time) * 60 + DATEPART(MINUTE, Time) - ROW_NUMBER() OVER ( PARTITION BY [BranchID], Date, [BookingCount] ORDER BY Time ) AS [Grp]\n       FROM     PreRender\n     ),\nFinalRender ( [BranchID], [Date], [Start Time], [End Time], [Duration], [EntryCount], [EntryColour] )\n  AS ( SELECT   [BranchID] ,\n                [Date] ,\n                MIN([Time]) AS [Start Time] ,\n                MAX([Time]) AS [End Time] ,\n                ISNULL(DATEDIFF(MINUTE, MIN([Time]), MAX([Time])), 0) AS Duration ,\n                [BookingCount] AS EntryCount ,\n                CASE WHEN [BookingCount] = 0 THEN 'Red'\n                     WHEN [BookingCount] = 1 THEN 'Green'\n                     ELSE 'Yellow'\n                END AS EntryColour\n       FROM     CrossTabPrep\n       GROUP BY [BranchID] ,\n                [Date] ,\n                [BookingCount] ,\n                [Grp]\n     )\n</code></pre>\n\n<p>Quite simply, is my method efficient? is there any way i can improve on this method whilst retaining minute level accuracy? When dealing with massive CTE tables such as this, would there be any benefit in dumping this data to indexed temp tables &amp; joining them instead?</p>\n\n<p>Another thing I was considering is replacing the DATE &amp; TIME(0) data types that the big join uses, would is be more efficient if I cast these to integers?</p>\n\n<p>Here is the Full CTE in case that helps:</p>\n\n<pre><code>WITH    OpeningHours ( [BranchID], [DayOfWeek], [StartTime], [EndTime] )\n          AS ( SELECT   BranchID ,\n                        DayOfWeek ,\n                        CONVERT(TIME(0), AM_open) ,\n                        CONVERT(TIME(0), AM_close)\n               FROM     db_BranchDetails.dbo.tbl_ShopOpeningTimes (NOLOCK)\n                        INNER JOIN @tbl_Days Filter_Days ON db_BranchDetails.dbo.tbl_ShopOpeningTimes.DayOfWeek = Filter_Days.DayNumber\n               WHERE    CONVERT(TIME(0), AM_open) &lt;&gt; CONVERT(TIME(0), '00:00:00')\n               UNION ALL\n               SELECT   BranchID ,\n                        DayOfWeek ,\n                        CONVERT(TIME(0), PM_open) ,\n                        CONVERT(TIME(0), PM_close)\n               FROM     db_BranchDetails.dbo.tbl_ShopOpeningTimes (NOLOCK)\n                        INNER JOIN @tbl_Days Filter_Days ON db_BranchDetails.dbo.tbl_ShopOpeningTimes.DayOfWeek = Filter_Days.DayNumber\n               WHERE    CONVERT(TIME(0), PM_open) &lt;&gt; CONVERT(TIME(0), '00:00:00')\n               UNION ALL\n               SELECT   BranchID ,\n                        DayOfWeek ,\n                        CONVERT(TIME(0), EVE_open) ,\n                        CONVERT(TIME(0), EVE_close)\n               FROM     db_BranchDetails.dbo.tbl_ShopOpeningTimes (NOLOCK)\n                        INNER JOIN @tbl_Days Filter_Days ON db_BranchDetails.dbo.tbl_ShopOpeningTimes.DayOfWeek = Filter_Days.DayNumber\n               WHERE    CONVERT(TIME(0), EVE_open) &lt;&gt; CONVERT(TIME(0), '00:00:00')\n             ),\n        DateRange ( [Date], [DayOfWeek] )\n          AS ( SELECT   CONVERT(DATE, DATEADD(DAY, N - 1, @StartDate)) ,\n                        DATEPART(WEEKDAY, DATEADD(DAY, N - 1, @StartDate))\n               FROM     tally (NOLOCK)\n               WHERE    N &lt;= DATEDIFF(DAY, @StartDate, @EndDate) + 1\n             ),\n        OpenMinutes ( [BranchID], [DayOfWeek], [Time] )\n          AS ( SELECT   [BranchID] ,\n                        [DayOfWeek] ,\n                        DATEADD(MINUTE, N - 1, StartTime)\n               FROM     OpeningHours\n                        LEFT OUTER JOIN tally ON tally.N BETWEEN 0\n                                                         AND     DATEDIFF(MINUTE, OpeningHours.StartTime, OpeningHours.EndTime) + 1\n             ),\n        OpenDatesAndMinutes ( [Date], [Time], [BranchID] )\n          AS ( SELECT   DateRange.[Date] ,\n                        OpenMinutes.[Time] ,\n                        OpenMinutes.BranchID\n               FROM     DateRange\n                        LEFT OUTER JOIN OpenMinutes ON DateRange.DayOfWeek = OpenMinutes.DayOfWeek\n               WHERE    OpenMinutes.BranchID IS NOT NULL\n             ),\n        WhiteListEmployees ( [DET_NUMBERA] )\n          AS ( SELECT   DET_NUMBERA\n               FROM     [dbo].[tbl_ChrisCache_WhiteList]\n               WHERE    [TimeSheetV2_SecurityContext] = @TimeSheetV2_SecurityContext\n             ),\n        BookedMinutesByRole ( [Date], [Time], [BranchID], BookingCount )\n          AS ( SELECT   [BookingDate] ,\n                        DATEADD(MINUTE, N - 1, StartTime) ,\n                        BranchID ,\n                        COUNT(BookingID) AS Bookings\n               FROM     tbl_Booking (NOLOCK)\n                        INNER JOIN tbl_BookingReason  (NOLOCK) ON dbo.tbl_BookingReason.ReasonID = dbo.tbl_Booking.ReasonID\n                        INNER JOIN tbl_ChrisCache  (NOLOCK) ON dbo.tbl_Booking.DET_NUMBERA = dbo.tbl_ChrisCache.DET_NUMBERA\n                        INNER JOIN @ValidPosCodes AS Filter_PostCodes ON dbo.tbl_ChrisCache.POS_NUMBERA = Filter_PostCodes.POSCODE\n                        LEFT OUTER JOIN tally (NOLOCK) ON tally.N BETWEEN 0\n                                                                  AND     DATEDIFF(MINUTE, tbl_Booking.StartTime, tbl_Booking.EndTime) + 1\n               WHERE    ( Void = 0 )\n                        AND tbl_BookingReason.CoverRequired = 0 --#### Only use bookings that dont require cover\n                        AND tbl_booking.BranchID &lt;&gt; '023'   --#### Branch 23 will always have messy data\n                        AND ( dbo.tbl_Booking.BookingDate BETWEEN @StartDate\n                                                          AND     @EndDate )\n               GROUP BY [BookingDate] ,\n                        BranchID ,\n                        DATEADD(MINUTE, N - 1, StartTime)\n             ),\n        BookedMinutesByWhiteList ( [Date], [Time], [BranchID], BookingCount )\n          AS ( SELECT   [BookingDate] ,\n                        DATEADD(MINUTE, N - 1, StartTime) ,\n                        BranchID ,\n                        COUNT(BookingID) AS Bookings\n               FROM     tbl_Booking(NOLOCK)\n                        INNER JOIN tbl_BookingReason (NOLOCK) ON dbo.tbl_BookingReason.ReasonID = dbo.tbl_Booking.ReasonID\n                        INNER JOIN tbl_ChrisCache (NOLOCK) ON dbo.tbl_Booking.DET_NUMBERA = dbo.tbl_ChrisCache.DET_NUMBERA\n                        INNER JOIN WhiteListEmployees Filter_WhiteList ON dbo.tbl_Booking.DET_NUMBERA = Filter_WhiteList.DET_NUMBERA\n                        LEFT OUTER JOIN tally (NOLOCK) ON tally.N BETWEEN 0\n                                                                  AND     DATEDIFF(MINUTE, tbl_Booking.StartTime, tbl_Booking.EndTime) + 1\n               WHERE    ( Void = 0 )\n                        AND tbl_BookingReason.CoverRequired = 0 --#### Only use bookings that dont require cover\n                        AND tbl_booking.BranchID &lt;&gt; '023'   --#### Branch 23 will always have messy data\n                        AND ( dbo.tbl_Booking.BookingDate BETWEEN @StartDate\n                                                          AND     @EndDate )\n               GROUP BY [BookingDate] ,\n                        BranchID ,\n                        DATEADD(MINUTE, N - 1, StartTime)\n             ),\n        BookedMinutes ( [Date], [Time], [BranchID], BookingCount )\n          AS ( SELECT   [Date] ,\n                        [Time] ,\n                        [BranchID] ,\n                        BookingCount\n               FROM     BookedMinutesByRole\n               UNION\n               SELECT   [Date] ,\n                        [Time] ,\n                        [BranchID] ,\n                        BookingCount\n               FROM     BookedMinutesByWhiteList\n             ),\n        PreRender ( [Date], [Time], [BranchID], [BookingCount] )\n          AS ( SELECT   OpenDatesAndMinutes.[Date] ,\n                        OpenDatesAndMinutes.[Time] ,\n                        OpenDatesAndMinutes.[BranchID] ,\n                        ISNULL(BookedMinutes.BookingCount, 0) AS BookingCount\n               FROM     OpenDatesAndMinutes\n                        LEFT OUTER JOIN BookedMinutes ON OpenDatesAndMinutes.BranchID = BookedMinutes.BranchID\n                                                         AND OpenDatesAndMinutes.[Date] = BookedMinutes.[Date]\n                                                         AND OpenDatesAndMinutes.[Time] = BookedMinutes.[Time]\n             ),\n        CrossTabPrep ( [Date], [Time], [BranchID], [BookingCount], [Grp] )\n          AS ( SELECT   [Date] ,\n                        [Time] ,\n                        [BranchID] ,\n                        [BookingCount] ,\n                        DATEPART(HOUR, Time) * 60 + DATEPART(MINUTE, Time) - ROW_NUMBER() OVER ( PARTITION BY [BranchID], Date, [BookingCount] ORDER BY Time ) AS [Grp]\n               FROM     PreRender\n             ),\n        DeletedBranches ( [BranchID] )\n          AS ( SELECT   [ShopNo]\n               FROM     [dbo].[vw_BranchList]\n               WHERE    [Branch_Deleted] = 1\n             ),\n        FinalRender ( [BranchID], [Date], [Start Time], [End Time], [Duration], [EntryCount], [EntryColour] )\n          AS ( SELECT   [BranchID] ,\n                        [Date] ,\n                        MIN([Time]) AS [Start Time] ,\n                        MAX([Time]) AS [End Time] ,\n                        ISNULL(DATEDIFF(MINUTE, MIN([Time]), MAX([Time])), 0) AS Duration ,\n                        --dbo.format_timeV2(ISNULL(DATEDIFF(SECOND, MIN([Time]), MAX([Time])), 0)) AS DurationF ,\n                        [BookingCount] AS EntryCount ,\n                        CASE WHEN [BookingCount] = 0 THEN 'Red'\n                             WHEN [BookingCount] = 1 THEN 'Green'\n                             ELSE 'Yellow'\n                        END AS EntryColour\n               FROM     CrossTabPrep\n               GROUP BY [BranchID] ,\n                        [Date] ,\n                        [BookingCount] ,\n                        [Grp]\n             )\n            SELECT  [BranchID] ,\n                    CONVERT(VARCHAR(10), DATEADD(DAY, 7, CONVERT(DATETIME, CONVERT(VARCHAR(10), DATEADD(day, -1 - ( DATEPART(dw, [Date]) + @@DATEFIRST - 2 ) % 7, [Date]), 103) + ' 23:59:59', 103)), 103) AS WeekEnding ,\n                    [Date] ,\n                    [Start Time] ,\n                    [End Time] ,\n                    [Duration] ,\n                    CONVERT(VARCHAR, ( [Duration] * 60 ) / 3600) + 'h ' + CONVERT(VARCHAR, ROUND(( ( CONVERT(FLOAT, ( ( [Duration] * 60 ) % 3600 )) ) / 3600 ) * 60, 0)) + 'm' AS [DurationF] ,\n                    [EntryCount] ,\n                    [EntryColour] ,\n                    CASE WHEN [EntryCount] = 0 THEN 'Red'\n                         WHEN [EntryCount] &gt;= 1 THEN 'Green'\n                    END AS DurationColour ,\n                    CASE WHEN [EntryCount] = 0 THEN 'This period of open-time isnt covered'\n                         WHEN [EntryCount] &gt;= 1 THEN 'This period of open-time is covered by ' + CONVERT(VARCHAR, [EntryCount]) + ' booking(s)'\n                    END AS [DurationComment]\n            FROM    FinalRender\n            WHERE   FinalRender.BranchID NOT IN ( SELECT    [BranchID]\n                                                  FROM      DeletedBranches )\n</code></pre>\n"},{"tags":["sql-server","tsql","triggers","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":146,"score":0,"question_id":10866548,"title":"Trigger not firing in production but does in non-production","body":"<p>I have a trigger that is firing with out issue in non-production but the same exact code is failing to fire in production. I've confirmed it's not disabled and I've done a trace to see that it is not even executing in production.. I've checked the relevant <code>OBJECTPROPERTY</code> elements and they are the same. I've confirm the code is the same. I've confirmed the same inserts are coming from the application. Below is the code for this trigger:</p>\n\n<pre><code>/****** \n  Object:  Trigger [dbo].[tr_trigger_ins]    \n  Script Date: 06/02/2012 16:51:51 \n******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER OFF\nGO\n\nCREATE TRIGGER [dbo].[tr_trigger_ins] ON [dbo].[table_1]\nFOR INSERT\nAS\nBEGIN\n  UPDATE table_2\n    SET col_1 =\n      CASE \n        WHEN i.col_2 = '0' THEN 0 ELSE 1\n      END\n  FROM INSERTED i\n  INNER JOIN table_3 pa \n    ON i.col_3 = pa.col_3 AND pa.col_4 = 'ispublic'\n  INNER JOIN table_4 pp  \n    ON i.col_5 = pp.col_5\n  INNER JOIN table_2 cs\n    ON pp.col_6 = cs.col_6\nEND\nGO\n</code></pre>\n\n<p>Below is a trigger that is an instead of insert on the same table that is executing in both environments:</p>\n\n<pre><code>/****** \n  Object:  Trigger [dbo].[tr_trigger_before_ins]    \n  Script Date: 06/02/2012 16:55:52 \n******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER OFF\nGO\n\nCREATE TRIGGER [dbo].[tr_trigger_before_ins] ON [dbo].[table_1]\nINSTEAD OF INSERT\nAS\nBEGIN\n  INSERT INTO table_1\n    SELECT * FROM INSERTED\n    WHERE col_3 in (73, 199)\nEND\nGO\n</code></pre>\n\n<p>Any help is greatly appreciated. </p>\n"},{"tags":["sql-server","tsql","inner-join"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":13277252,"title":"Effectively COUNTing and SUMing on a large inner join","body":"<p>Please consider the following case (simplified for the sake of the question):</p>\n\n<p>I have the following tables in the SQL Server 2012 database:</p>\n\n<pre><code>Parent_Table\n\nId  | Parent table fields\n----+--------------------\n1   | ...\n2   | ...\n3   | ...\n...\n\nChild_Table\n\nId  | ParentId | Child table fields\n----+----------+-------------------\n1   | 2        | ...\n2   | 1        | ...\n3   | 1        | ...\n4   | 3        | ...\n5   | 2        | ...\n...\n\nBig_Table\n\nId      | ChildId  | Value  | Status  | Other fields\n--------+----------+--------|---------------------\n1       | 12       | 672    | Closed  |\n2       | 23       | 133    | Closed  |\n3       | 7        | 2611   | Open    |\n4       | 14       | 84     | Closed  |\n...\n1295769 | 23       | 458    | Closed  |\n1295770 | 18       | 1046   | Open    |\n1295771 | 7        | 8      | Open    |\n</code></pre>\n\n<p>The Child and Parent tables are relatively small (roughly 100 Parent entries and 5 Child entries per parent) and their entries are inserted or deleted only a few times a day.</p>\n\n<p>The \"Big Table\", on the other hand, is growing fast (100 entries per second, for the sake of discussion), and the status of rows becomes Closed after a while (think of client sessions, which is the actually the case here).</p>\n\n<p>I need to periodically (every few seconds) provide the number of Big_Table rows and the sum of the Big_Table.Value column <strong>for a specified Parent.Id</strong> - a different one every time.</p>\n\n<p>I suspect that the straightforward implementation (using inner joins etc.) might be extremely inefficient, and better solution may include additional tables, a table of counters of some sort or I should just implement this in my service code (?!) and take care of persistence somehow.</p>\n\n<p>What would be the \"right\" (efficiency-wise) way of implementing the above?  A solution which handles additional levels of parents/children would be the best one. </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":15,"score":0,"question_id":13293278,"title":"No Date Returned from Conversion","body":"<p>There are values there for the 3 fields that make up the date here, but I get null back..so something is wrong with my syntax.  I also want just the date (no time) `</p>\n\n<pre><code>   case when isdate(CAST(someTable.DATE_MM as varchar(8)) + CAST(someTable.DATE_DD as varchar(8)) + CAST (someTable.DATE_YY as varchar(8))) = 1\n        then convert(date,CAST(someTable.DATE_MM as varchar(8)) + '/' + CAST(someTable.DATE_DD as varchar(8)) + '/' + CAST (someTable.DATE_YY as varchar(8))) else null end as BirthDate,\n</code></pre>\n\n<p>that's in my select statement and it's giving me NULL for the data.  The values for those 3 fields are:</p>\n\n<pre><code>DATE_MM: 3\nDATE_DD: 4\nDATE_YY: 1959\n</code></pre>\n\n<p>the data type behind those 3 fields is int</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","query-optimization"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":13290797,"title":"Is there any potential probelm removing this ISNULL statement?","body":"<p>So recently we uncovered a long running proc and one of my colleagues pointed out that that dropping the ISNULL in the where clause sped things up for reasons pointed out in this post <a href=\"http://stackoverflow.com/questions/8924913/is-there-is-any-performance-issue-while-using-isnull-in-sql-server\">Is there is any Performance issue while using ISNULL() in SQL Server?</a>. I did some Google searching but couldn't find out for sure if there was any danger in missing data. I know if you say something like this </p>\n\n<pre><code>WHERE ID NOT IN (SELECT MemberID FROM Person WHERE MemberId IS NOT Null)\n</code></pre>\n\n<p>and MemberId is nullable you won't get any matches if you don't include the \"IS NOT NULL\" but I think that is a different issue? Maybe not? </p>\n\n<p>Here is the change my coworker is proposing. </p>\n\n<pre><code>where ISNULL(ct.DisabilityBenefitsConnectAuthorized,0) = 1\n</code></pre>\n\n<p>Would become</p>\n\n<pre><code>where ct.DisabilityBenefitsConnectAuthorized = 1\n</code></pre>\n\n<p>It doesn't seem to be effecting results however I am not 100% sure that it couldn't and we just don't know it. </p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","sql-server-2008"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":5565,"score":0,"question_id":7430560,"title":"How to check if cursor exists (open status)","body":"<p>How do I check if a cursor is open or not? Because many times I am encountering the error 'Cursor already exists'. Please let me know how can I check whether a cursor is already in open status.</p>\n\n<p>In fact I have closed as well as Deallocated it at the end (CLOSE ppm_cursor; DEALLOCATE ppm_cursor;) But Still i am getting the same error what could be the reason.</p>\n"},{"tags":["sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":13291710,"title":"How to wait for a query to return results?","body":"<p>Is it possible to have a query wait until it has results instead of returning immediately with an empty result set. For example:</p>\n\n<pre><code>SELECT Column1 FROM Table1\n</code></pre>\n\n<p>If <code>Table1</code> is empty, the query would return with an empty result set. However, I want it to not return, but wait until at least one row is available, preferably with a timeout of some sort. I would prefer to do this without involving Service Broker into the equation, if possible.</p>\n\n<p><strong>Clarification:</strong></p>\n\n<p>CLR is enabled on the server, but the call is coming from a platform independent C++ program via SQLAPI++/ODBC. So, no C#/.NET tricks are possible. The goal is to make a call into a stored procedure, specify a timeout and not return until data is available (and returned by the stored proc) or the specified timeout expires.</p>\n\n<p>For example:</p>\n\n<pre><code>EXEC GetData @Timeout=2000 -- Wait for upto 5000 milliseconds for a result set to be \n                           -- available\n</code></pre>\n"},{"tags":["c#","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13292722,"title":"Trouble adding OPTION to T-SQL Query syntax","body":"<p>for some reason I just can't get the syntax right on this for adding the OPTION</p>\n\n<pre><code>   Database db = DatabaseFactory.CreateDatabase(Config.DbConnectionString);\n\n    using (DbCommand cmd = db.GetSqlStringCommand(string.Format(@\"  SELECT  t.customerID,\n                                                                            t.Photo\n                                                                    FROM SomeTable t\n                                                                    WHERE t.PhotoID = (SELECT MAX(PhotoID) FROM SomeTable WHERE customerID = @{0} OPTION (OPTIMIZE FOR UNKNOWN)\n                                                                    GROUP BY CustomerID ) \", \"customerID\")))\n    {\n        try\n        {\n            db.AddInParameter(cmd, \"@customerID\", DbType.String, customerID);\n</code></pre>\n"},{"tags":["oracle","tsql","plsql"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":404,"score":2,"question_id":9474513,"title":"Converting T-SQL to PL/SQL","body":"<p>How can I convert the following T-SQL Statement to PL/SQL</p>\n\n<pre><code>set @disbursement_no = (select isnull(max(convert(numeric, right(DV_NO, 6))), 0) + 1\n            from CD_T_DV_HDR where year(DATE_DV) = year(getdate()))\n</code></pre>\n\n<p>The data type of <code>DV_NO</code> is varchar and <code>Date_Dv</code> is date.</p>\n\n<p>I'm really new to PL/SQL, and I'm having a hard time to convert my SQL statement to  PL/SQL. I Hope you can help me.</p>\n"},{"tags":["tsql","sql-update","record","last"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13292789,"title":"T-SQL How to update the bottom/last row only?","body":"<p>I want to update the bottom/the last row in my table. I have try to implement <a href=\"http://stackoverflow.com/questions/1198364/how-can-i-update-top-100-records-in-sql-server\">this</a> solution, but nothing seems as correct syntax:</p>\n\n<pre><code>UPDATE TOP(1) @ResultTable\nSET PeriodLastDate=DATEADD(DAY,-1,PeriodLastDate)\nORDER BY PeriodID DESC\n</code></pre>\n\n<p>OR</p>\n\n<pre><code>UPDATE TOP(1) @ResultTable\nSET PeriodLastDate=DATEADD(DAY,-1,PeriodLastDate)\nFROM @ResultTable\nORDER BY PeriodID DESC\n</code></pre>\n\n<p>What I have till now working is:</p>\n\n<pre><code>UPDATE @ResultTable\nSET PeriodLastDate=DATEADD(DAY,-1,PeriodLastDate)\nWHERE PeriodID=(SELECT COUNT(PeriodID) FROM @ResultTable)-1\n</code></pre>\n\n<p>but this will not always works, as in my function some of the records are deleted and I am not always having PeriodIDs incremented with 1.</p>\n"},{"tags":["sql","sql-server","regex","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13291639,"title":"TSQL Simple Regex Matching","body":"<p>I need to check if a variable is a value 10.00 through 10.09. How can I do this by regex ?</p>\n\n<pre><code>IF SomeRegExFunction(@var, '10.0*')\n    print 'It worked'\n</code></pre>\n\n<p>Is there some way to do this? </p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","tsql","join","inner-join"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":28,"score":2,"question_id":13291855,"title":"Invalid Column name when using INNER JOIN to get values from two tables","body":"<p>I have two tables:</p>\n\n<p>tbl_profiles_and_users:</p>\n\n<pre><code>[id] [int] IDENTITY(1,1) NOT NULL,\n[profile_id] [int] NOT NULL,\n[user_id] [nvarchar](50) NULL\n</code></pre>\n\n<p>tbl_profiles_and_activities:</p>\n\n<pre><code>[id] [int] IDENTITY(1,1) NOT NULL,\n[profile_id] [int] NOT NULL,\n[user_id] [nvarchar](50) NOT NULL,\n[activity_name] [nvarchar](50) NULL,\n[check] [int] NULL,\n[preferred] [int] NULL\n</code></pre>\n\n<p>both tables have entries in them, and I am trying to select the user, and activities, only from within a specified profile.</p>\n\n<p>I am trying to do this with the following join:</p>\n\n<pre><code>use [dbName]\n\nSELECT p1.user_id AS User_ID, [p2.activity_name] as [Activity_Name]\nFROM tbl_profiles_and_users AS p1 \nINNER JOIN tbl_profiles_and_activities AS p2 \nON p1.user_id = p2.user_id AND p1.profile_id = p2.profile_id\n</code></pre>\n\n<p>but I receive the message \nInvalid column name 'p2.activity_name'\nWhat am I doing wrong? Can I achieve the desired results with a Join?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":13246511,"title":"Improving SQL Server query performance","body":"<p>I have a written a query in which I create a string and take distinct values from the table based on conditions.</p>\n\n<p>The table has some 5000 rows. This query takes almost 20 second to execute.</p>\n\n<p>I believe that the string comparisons have made the query so slow. But I wonder what are my alternatives. </p>\n\n<p><strong>Query:</strong></p>\n\n<pre><code>select distinct\n   Convert(nvarchar, p1.trafficSerial) +' ('+  p1.sourceTraffic + ' - ' + p1.sinkTraffic + ' )' as traffic\nfrom \n   portList as p1\ninner join \n   portList as p2 ON p1.pmId = p2.sinkId\n                  AND P1.trafficSerial IS NOT NULL \n                  AND (p1.trafficSerial = p2.trafficSerial) \n                  AND (P1.sourceTraffic = P2.sourceTraffic) \n                  AND (P1.sinkTraffic = P2.sinkTraffic)\nwhere \n   p1.siteCodeID = @SiteId\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2012"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":47,"score":-1,"question_id":13291007,"title":"SQL Server 2012 Joining columns from two tables into one","body":"<p>I have two tables in different places</p>\n\n<p>the end result has to be</p>\n\n<pre><code>VendorName  InvoiceNumber  InvoiceTotal\n</code></pre>\n\n<p><code>VendorName</code> is in a table called <code>Vendors</code></p>\n\n<p><code>InvoiceNumber</code> and <code>InvoiceTotal</code> are in a table called <code>Invoices</code></p>\n\n<p>it needs to show all the vendors in the result even if the vendors dont have any invoices, display the largest invoice totals first DESC and sort the Vendor Names in Alphabetical order.</p>\n\n<p>I tried to Join the Invoices into my </p>\n\n<pre><code>SELECT VendorName FROM Vendors \n</code></pre>\n\n<p>but I cannot figure out the syntax :/</p>\n"},{"tags":["sql","sql-server","tsql","math","calculator"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":4,"view_count":33,"score":-4,"question_id":13291491,"title":"SQL Server 2012 Calculate total with tax","body":"<p>there needs to be 3 columns </p>\n\n<p>the tax needs to be 13%</p>\n\n<p>the tax amount needs to be added to the InvoiceTotal the amount that it adds needs to be put in the tax column and the InvoiceTotal needs to be added by the Tax amount and put into the Total Column but only if the InvoiceTotal is greater then 0$ aka if there is a balance owed </p>\n\n<p>InvoiceTotal is the only place you need to draw data from and InvoiceTotal is a column in the tables called Invoices</p>\n\n<p>Structure below: </p>\n\n<p>InvoiceTotal  Tax  Total</p>\n"},{"tags":["sql","tsql","sql-server-2012"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":27,"score":-2,"question_id":13290738,"title":"How to join two SQL queries?","body":"<p>Making two SQL queries into the same table</p>\n\n<pre><code>SELECT FirstName,\n       LastName,\n       LEFT(FirstName, 1) + '.' + LEFT(LastName, 1) AS Initial\nFROM   ContactUpdates\n</code></pre>\n\n<p>This outputs:</p>\n\n<pre><code>FirstName    LastName    Initial\n</code></pre>\n\n<p>I want this to join this other one on the right side where Initial ends</p>\n\n<pre><code>SELECT LOWER(LEFT(FirstName, 1) + REPLACE(LastName,'''','' ) )\n         + '@email.com' AS Email\nFROM   ContactUpdates\n</code></pre>\n\n<p>In the end I want it to be</p>\n\n<pre><code> FirstName    LastName    Initial    Email \n</code></pre>\n\n<p>But I can't figure out how to make them join any help?</p>\n"},{"tags":["sql-server","tsql","default-value","between","divide"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13290775,"title":"T-SQL Divide value across rows","body":"<p>I have the following columns and data in table:</p>\n\n<pre><code>PeriodID Days\n1        NULL\n2        NULL\n3        NULL\n4        NULL\n5        NULL\n</code></pre>\n\n<p>Then I have days that should divide across the rows as follows:</p>\n\n<ol>\n<li><p>If Days &lt; 5 (for example 2) I will have:</p>\n\n<pre><code>PeriodID Days\n1        NULL\n2        NULL\n3        NULL\n4        1\n5        1\n</code></pre></li>\n<li><p>If days >= 5 and days%5=0 (for example 5) I will have:</p>\n\n<pre><code>PeriodID Days\n1        1    \n2        1    \n3        1    \n4        1    \n5        1\n</code></pre></li>\n<li><p>If days > 5 and days%5!=0 (for example 12) I will have:</p>\n\n<pre><code>PeriodID Days\n1        3    \n2        3    \n3        2    \n4        2    \n5        2\n</code></pre></li>\n</ol>\n\n<p>I am able doing this with loops, and I hope for better solution using some smart technique or T-SQL function. Thanks in advance.</p>\n"},{"tags":["tsql","error-handling","xact-abort"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":12,"score":0,"question_id":13290997,"title":"What is the effect of having XACT_ABORT on/off in parent/child stored procedures respectively?","body":"<p>I'm trying to improve the error handling of a current system to produce more meaningful error messages. I have a \"root\" stored procedure that makes several calls to other nested stored procedures. In the root sp, XACT_ABORT is set to ON but in the nested procedures, XACT_ABORT is set to OFF. I want to capture the specific errors from the lower level procedures rather than getting the root procedure's error. I often see the error, \"uncommittable transaction is detected at the end of the batch, the transaction is being rolled back.\" Is there any effect to having these \"mixed\" environments with the XACT_ABORTs? Also, if you have any suggestions for advanced error handling, that would be much appreciated. I think I would like to use sp_executesql so I can pass parameters to get error output without having to modify all of the stored procedures and use RAISERROR to invoke the parent procedure's CATCH block.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13290889,"title":"SQL Server -- Efficient String Contains Over Very Large Tables","body":"<p>I have a table that currently contains 10 million records.</p>\n\n<p>One of the columns is <code>SourceText</code> of type <code>nvarchar(4000)</code>.</p>\n\n<p>I need a <em>very</em> efficient way to search the SourceText to see if it contains another string. </p>\n\n<p>I have extreme flexibility will the table structures--I can modify the insert procedure and use other, better indexed tables to track things.  One thought was to  tokenize the SourceText by word and store the words in an indexed table, then use a mapping table to map to the main table.  The problem is that the <code>SourceText</code> column can be any language, and there are always rules re:parantheses, etc.  For example, in english if I tokenize using ' ' as the delimiter, I will still get things like <code>(Where</code> instead of <code>Where</code>, which is problematic.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["asp.net-mvc","linq","entity-framework","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13278891,"title":"Complex SQL to LINQ to populate Grid (Count items year by month) (MVC, EF Code First)","body":"<p>I have a grid that I want to fill with the following:</p>\n\n<p>It is tracking tickets that have been open each month for the last year. The grid is filtered by priority so I have a something like this:</p>\n\n<pre><code>| Mon | Critical | High | Tot |\n| Jan |    5     |  2   |  7  |\n| Feb |    2     |  3   |  5  |\n</code></pre>\n\n<p>This is my SQL statement:</p>\n\n<pre><code>SELECT\n    MONTH(CreateDate),\n    DATENAME(MONTH,m.CreateDate) AS 'Month',\n    SUM(CASE WHEN (m.PriorityId = 1) THEN 1 ELSE 0 END) AS 'Critical',\n    SUM(CASE WHEN (m.PriorityId = 2) THEN 1 ELSE 0 END) AS 'High',\n    SUM(CASE WHEN (m.PriorityId = 3) THEN 1 ELSE 0 END) AS 'Normal',\n    SUM(CASE WHEN (m.PriorityId = 4) THEN 1 ELSE 0 END) AS 'Low',\n    SUM(CASE WHEN (m.PriorityId = 5) THEN 1 ELSE 0 END) AS 'Not Ready',\n    Count(m.Id) AS Total\nFROM\n    [projects].[dbo].[tblMaintenanceTicket] m\nINNER JOIN\n    [projects].[dbo].[tblPriority] p\nON\n    p.Id = m.PriorityId\nWHERE\n    StatusId = 1\n    AND YEAR(CreateDate) = year(getdate())\nGROUP BY \n    MONTH(CreateDate),\n    DATENAME(MONTH,m.CreateDate)\nORDER BY\n    MONTH(CreateDate)\n</code></pre>\n\n<p>I am looking to convert this in VB LINQ but I am not sure this is the best method. I am also thinking calling a stored procedure, but I want to stay out of the DB really. I am using MVC 3 with the repository pattern, so calling my code is something like this output for JSON:</p>\n\n<pre><code>Dim tickets = ticketRepo.GetAll().Include(Function(p) p.Priority).ToArray()\n</code></pre>\n\n<p>Any assistance?</p>\n"},{"tags":["mysql","sql","tsql","join"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":65,"score":1,"question_id":13289546,"title":"Which query is the correct way?","body":"<p>Can somebody please tell me which is the better way, they both produce the same results but which is more 'correct'?</p>\n\n<p>Personally I feel the first query is easier to read, but I seem to read elsewhere that aliases should always be used.</p>\n\n<p>Thanks</p>\n\n<pre><code>SELECT Patient.PatientSurname, Doctor.DoctorSurname\nFROM Patient\nJOIN Operation\nON Operation.PatientCode=Patient.PatientCode\nJOIN Doctor\nON Doctor.DoctorCode=Operation.DoctorCode\nWHERE Operation.OperationType='Broken Arm'\nGROUP BY Patient.PatientSurname\nHAVING count(Patient.PatientSurname) &gt; 0\n\n\nSELECT PatientSurname, DoctorSurname\nFROM Patient as p, Operation as o, Doctor as d\nWHERE o.PatientCode=p.PatientCode\nAND  d.DoctorCode=o.DoctorCode\nAND o.OperationType='Broken Arm'\nGROUP BY p.PatientSurname\nHAVING count(p.PatientSurname) &gt; 0\n</code></pre>\n"},{"tags":["tsql","ssms"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":15,"score":0,"question_id":13290428,"title":"SQL Server Management Studio Transaction and Variable","body":"<p>In SSMS 2012, after setting <code>Options &gt; Query Execution &gt; ANSI &gt; SET IMPLICIT_TRANSACTIONS</code>, cf <a href=\"http://stackoverflow.com/questions/3047676/how-to-enable-automatic-transaction-scoping-on-sql-server-management-studio\">this SO post</a></p>\n\n<p>I have the following code in a query window:</p>\n\n<pre><code>begin transaction \n    select @@TRANCOUNT\n    begin\n    declare @someNumber int; set @someNumber = 1; \n    print @someNumber;\n    end\nrollback \n</code></pre>\n\n<p>When I select the whole block and press <code>Execute</code>, I see the expected result, i.e. 1. </p>\n\n<p>However, when I select the first 4 lines and execute, then select line 5, i.e. <code>print @someNumber;</code>, I got the following message:</p>\n\n<blockquote>\n  <p><em>Msg 137, Level 15, State 2, Line 1</em><br>\n  <em>Must declare the scalar variable \"@someNumber\".</em></p>\n</blockquote>\n\n<p>What is exactly the scope of the variable? </p>\n\n<p>I'm baffled. Can someone shed any light or point me to the right direction please? </p>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":9,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":7828,"score":2,"question_id":1227707,"title":"How to get last insert/update/delete datetime on Sql Server 2005?","body":"<p>not a duplicate of <a href=\"http://stackoverflow.com/questions/1227593/how-to-get-last-modification-datetime-on-sql-server-2005\">my previous question</a></p>\n\n<p>Is there any way to get the latest datetime when a table/database had an insert/update/delete on Sql Server 2005? Preferably without creating triggers..</p>\n\n<p>I know that when you need the last update per row, you need triggers. But I am not sure if they are needed when you just want to get the last update for the whole table.</p>\n"},{"tags":["sql-server-2008","tsql","select"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13288608,"title":"sql return data from select statement and insert to table variable at the same time","body":"<pre><code>declare @RelevantMachines Table (MachineId int)\n\nSelect MachineId, ClusterId, MachineGuid, MachineName, RegisteredDate, MachineDetail, LastServiceCall, MachineType as MachineTypeId, ProductSetId\nFrom PatchHub.Machine\nWhere ClusterId = @ClusterId\n</code></pre>\n\n<p>I would like to be able to return the select statement as a result set whilst at the same time populating the table variable with all of the returned rows MachineId values, this is in sql server 2008. How could you achieve this without running the select statement twice?</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13288527,"title":"How to group and count items in groups and get the full row?","body":"<p>This query gets the desired rows -grouped by subject- and I also want to know the items count in each group.</p>\n\n<pre><code>SELECT log.* FROM [hm_deliverylog] AS log\nWHERE log.deliveryid IN\n    (\n        SELECT MAX([deliveryid])  FROM [hm_deliverylog]\n        WHERE [deliverytime] &gt; DATEADD(HOUR, -12, GETDATE())\n        GROUP BY deliverysubject\n    )\n\nORDER BY deliveryid DESC\n</code></pre>\n\n<p>How can I count the groups? Like below?</p>\n\n<pre><code>SELECT joined.groupcount, log.* FROM [hm_deliverylog] AS log\n</code></pre>\n\n<p>P.S: Imagine the Gmail inbox; it displays the newest message and shows the message count. I want to group the messages with same subject and count them...</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":24373,"score":2,"question_id":1781946,"title":"Getting only Month and Year from SQL DATE","body":"<p>I need to access only Month.Year from Date field in SQL Server.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":13286621,"title":"Does ROLLBACK TRANSACTION imply a commit if not rolled-back","body":"<p>My <code>SQL-Server</code> learning curve has been back-to-front and after several yrs I'm battling to use <code>TRANSACTION</code> code effectively. </p>\n\n<p>If <code>COMMIT TRANSACTION</code> is not explicitly stated then at the point of <code>ROLLBACK TRANSACTION</code> if no errors have occurred in preceding code will the transaction then be committed? The question is in connection with a structure like the following:</p>\n\n<pre><code>USE MyDataBase;\nGO\n     BEGIN TRANSACTION;\n        --complex query X here  \n     ROLLBACK TRANSACTION; PRINT N'Rolled back the transaction.';\nGO\n</code></pre>\n\n<p>...I thought <code>ROLLBACK TRANSACTION</code> was used in a situation where you do not want changes to be made to a db if an error has occured in the <em>preceding</em> script - in the above this would be <code>X</code>. If i wanted to explicitly state <code>COMMIT TRANSACTION</code> in the above then where should it be located?</p>\n\n<p>To confuse myself even more I've got the following - why is it rolling back twice? Is an error occuring to create the <code>ROLLBACK</code>?</p>\n\n<pre><code>USE WHAnalysis;\nGO\n    BEGIN TRANSACTION;\n\n        IF @@TRANCOUNT = 1\n            SELECT @@TRANCOUNT\n            --do a complex query here\n\n    ROLLBACK TRANSACTION; PRINT N'Rolled back the transaction.';\nGO\n</code></pre>\n"},{"tags":["algorithm","tsql","optimization","geolocation","geocoding"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":18,"score":0,"question_id":13286496,"title":"T-SQL Optimize geographic search by longitude and lattitude","body":"<p>What I have stored in one of my tables are geographic points in the following format:</p>\n\n<blockquote>\n  <p>Longitude Latitude PostalCode</p>\n</blockquote>\n\n<p>The idea is to get the closest available postal code by given longitude and latitude using the information in the table.</p>\n\n<p>My algorithm work as follows:</p>\n\n<ol>\n<li>Init UserLongitude and UserLatitude</li>\n<li>Init StepVariable as 1.0</li>\n<li><p>Get all records from my table where </p>\n\n<pre><code>longitude&gt;UserLongitude-StepVariable \nand\nlongitude&lt;UserLongitude+StepVariable \nand\nlatitude&gt;Userlatitude-StepVariable   \nand\nlatitude&lt;Userlatitude+StepVariable\n</code></pre></li>\n<li>If no records are found, increase StepVariable with 1.0 and  executed step 3</li>\n</ol>\n\n<p>As I have <a href=\"http://www.zodiacal.com/tools/lat_table.php\" rel=\"nofollow\">read</a> the longitude value for 1.0 is smaller as we move to the poles. So, my algorithm will extend the search area in not correct way when value for 1.0 for longitude and latitude are not the same.</p>\n\n<p>Is there a tricky way to extend my searchable area as Square, because for now, in some place I have rectangles instead and I believe this make my search slower.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":1922,"score":2,"question_id":6807711,"title":"Backup/Restore the database using T-SQL (MSSQL2005, 2008)","body":"<p>I need to be able to backup and restore my database using t-sql. The approach I'm using is:</p>\n\n<pre><code>-- backup\nbackup database testdb1 to disk='c:\\testdb1.bak'\n\n-- restore\nalter database testdb1 set single_user with rollback immediate\ndrop database testdb1\nrestore database testdb1 from disk='c:\\testdb1.bak'\n</code></pre>\n\n<p>This works fine, but requires having the existing file at 'c:\\testdb1.bak'. It's not a problem as long as I have SQL server installed locally, but what do I do if I connect to the server remotely? Any solutions for getting rid of this requirement?</p>\n\n<p>For me, it doesn really matter what are the name and path to this file, I just need to be sure that I would be able to restore the DB if my alter scripts go wrong.</p>\n\n<p>Thanks.</p>\n\n<p><strong>Update: the problem was, creating files at the root of \"c:\\\" is prohibited by some versions of Windows. \"C:\\1\\\" is fine.</strong></p>\n"},{"tags":["sql","sql-server","tsql","sql-function"],"answer_count":3,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":51,"score":5,"question_id":13284222,"title":"Database Function VS Case Statement","body":"<p>Yesterday we got a scenario where had to get type of a <code>db field</code> and on base of that we had to write the description of the field. Like </p>\n\n<pre><code>Select ( Case DB_Type When 'I' Then 'Intermediate'\n                      When 'P' Then 'Pending'\n                      Else 'Basic'\n         End)\nFrom DB_table\n</code></pre>\n\n<p>I suggested to write a db function instead of this case statement because that would be more reusable. Like</p>\n\n<pre><code>Select dbo.GetTypeName(DB_Type) \nfrom DB_table\n</code></pre>\n\n<p>The interesting part is, One of our developer said using database function will be <strong>inefficient</strong> as <code>database functions</code> are <strong>slower</strong> than <code>Case statement</code>. I searched over the internet to find the answer which is better approach in terms of efficiency but unfortunately I found nothing that could be considered satisfied answer. Please enlighten me with your thoughts, which approach is better?</p>\n"},{"tags":["c#","tsql","ado.net","database-performance"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":13282826,"title":"Query runs faster in SQL Server than via ADO.NET command being sent","body":"<p>So I have the following in my CRUD method in my DL which brings back a photo blob:</p>\n\n<pre><code>    public static MemberPhoto RetrievePhoto(string customerID)\n    {\n        Database db = DatabaseFactory.CreateDatabase(Config.DbConnectionString);\n\n        using (DbCommand cmd = db.GetSqlStringCommand(string.Format(@\" SELECT  customerID,\n                                                                                p.Photo as PhotoBlob\n\n                                                                         FROM \n                                                                         SomeTable t\n\n                                                                         WHERE \n                                                                         t.PhotoID = (SELECT MAX(t.PhotoID) FROM SomeTable t\n                                                                                      WHERE t.customerID = @{0} \n                                                                                      GROUP BY t.CustomerID)\", \"customerID\")))\n        {\n            try\n            {\n                db.AddInParameter(cmd, \"@customerID\", DbType.String, customerID);\n\n                using (IDataReader reader = db.ExecuteReader(cmd))\n                {\n                    if (reader.Read())\n                    {\n                        Photo photo = new Photo();\n                        photo.LoadFromDataReader(reader);\n                        return photo;\n                    }\n                }\n            }\n</code></pre>\n\n<p>so that runs about 10 seconds slower than if I run this straight from management studio:</p>\n\n<pre><code>SELECT  customerID,\n    t.Photo as PhotoBlob\n\n    FROM \n    SomeTable t\n\n    WHERE \n    t.PhotoID = (SELECT MAX(t.PhotoID) FROM SomeTable t\n              WHERE t.customerID = '0000900595555' \n              GROUP BY t.CustomerID)\n</code></pre>\n\n<p>I don't know if it's because it takes a while for the reader to read the blob and bring that back or what?  If that's the problem how do you speed this up?  its instant at the DB, I run that query and it's a millisecond result timing.</p>\n\n<p>UPDATE:</p>\n\n<p>more info; the field type in the table is type Image in SQL Sever for that BLOB.</p>\n\n<p>I also ran my Unit Test, same amount of time, even after it hits my LoadFromReader:</p>\n\n<pre><code>[Test]\npublic void GetMemberPhoto_ByContractNumber_ReturnsAValidMemberPhoto()\n{\n    // Arrange\n    const string customerID = \"0044664176\";\n\n    // Act\n    DTO.MemberPhoto memberPhoto = MemberPhotoCRUD.RetrieveMemberPhotoFromBlob(customerID);\n\n    //Assert\n    Assert.IsNotNull(memberPhoto);\n    Assert.IsTrue(memberPhoto.CustomerID &gt; 0);\n    Assert.IsNotNull(memberPhoto.PhotoBinary.Length &gt; 0);\n}\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":13281741,"title":"SQL Trigger is Updating random row not the joined row","body":"<p>I have this query in a update trigger</p>\n\n<pre><code>UPDATE [FSSQLPROD01].[collectionsDELETE].[dbo].[collections] \nSET \n    Defendant_1 = i.DisplayName \n    , Loan_Number_1 = i.Comments \n    , Client = i.KS_BookName \n    , Date_Instructed = i.OpenDate \n    , Person_Responsible_name = i.ResponsibleFeeEarnerName \n    , Person_Responsible_Email = i.ResponsibleFeeEarnerEmail \n    , Person_Acting_name = i.BillingFeeEarnerName \n    , Person_Acting_email = i.BillingFeeEarnerEmail \n    , Agent_Acting_name = i.BillingFeeEarnerName \n    , Agent_Acting_email = i.BillingFeeEarnerEmail \n    , CBA_Panel_Service_Area = i.KS_ServiceCat \n    , HBN_Number = i.KS_ClientAcctRef \n    , St_George_Contact = i.KS_Instructor \nFROM \n    [FSSQLPROD01].[collectionsDELETE].[dbo].[collections] c\nINNER JOIN \n    Inserted i\nON\n    Left(c.file_number, 6) COLLATE DATABASE_DEFAULT = i.MatterNumber COLLATE DATABASE_DEFAULT\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/cjJ1P.jpg\" alt=\"enter image description here\">\nNow the Join connection matches up on the File_Number e.g. 70003-1 but for some unknown reason the data that should be updated to this Row is been updated to a toally random row 614864-7 </p>\n\n<p>I can continue to execute the trigger and tring to update the 70003-1 row but i continues to update the other row  614864-7 </p>\n\n<p>This is also running across a linked server the trigger is on one server up dating the other servers</p>\n\n<p>Server tigger sits on Microsoft SQL Server 2005 - 9.00.3042.00 (X64)   Feb 10 2007 00:59:02   Copyright (c) 1988-2005 Microsoft Corporation  Enterprise Edition (64-bit) on Windows NT 5.2 (Build 3790: Service Pack 2) </p>\n\n<p>Server trigger is updating Microsoft SQL Server 2005 - 9.00.3042.00 (X64)   Feb 10 2007 00:59:02   Copyright (c) 1988-2005 Microsoft Corporation  Enterprise Edition (64-bit) on Windows NT 5.2 (Build 3790: Service Pack 2) </p>\n\n<p>I have been thinking that updating the servers SP to SP4 may fix the problem?</p>\n\n<p>Does anyone have a reson why this might be haapening the Server </p>\n\n<p>Ammendment </p>\n\n<p>Yeah i actually hardcoded the values and simplified the SQL Statement it works as it should </p>\n\n<pre><code>DECLARE @MatterNumber as varchar(50)\nSET @MatterNumber = (SELECT i.MAtternumber FRom Inserted as i) + '-1'\nPrint @MatterNumber\n\nUPDATE [FSSQLPROD01].[collectionsDELETE].[dbo].[collections] \n       SET Loan_Number_1 = 123\n       WHERE file_number =  @MatterNumber\n</code></pre>\n\n<p>But as soon as I set a Declared Varible value to Loan_Number_1 or any of the other columes this is when the problem starts to happen</p>\n\n<pre><code>DECLARE @LoanNumber as varchar(50)\nSET @LoanNumber =    (SELECT i.Comments FRom Inserted as i)\n    Print @LoanNumber\nDECLARE @MatterNumber as varchar(50)\nSET @MatterNumber = (SELECT i.MAtternumber FRom Inserted as i) + '-1'\n\nPrint @MatterNumber -I print here I see 70003-1\n\nUPDATE [FSSQLPROD01].[collectionsDELETE].[dbo].[collections] \n       SET Loan_Number_1 = @LoanNumber\n\n       WHERE file_number =  @MatterNumber\n\nPrint @MatterNumber -I print here I see 70003-1\n</code></pre>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":4033,"score":1,"question_id":4856089,"title":"How to update a part of the string using replace function in tsql?","body":"<p>Hi\nI have a column of nvarchar(1000) type. I need to get rid of encode characters from that column and replace them with their special characters.\nFor Example:</p>\n\n<pre><code>column value is : 'This text values contains this '&amp;amp;' this'.\n</code></pre>\n\n<p>I have to replace <code>'&amp;amp;'</code> with '&amp;'.</p>\n\n<ol>\n<li>First have to find the record which has <code>'&amp;amp;'</code> in the column (may be using like condition)</li>\n<li>And then replace only this word with its special character</li>\n</ol>\n\n<p>How do i do that? Pl. help</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13282155,"title":"Invalid Syntax for CTE","body":"<p>what in the world could be wrong, the syntax looks fine:</p>\n\n<pre><code>With photos(PhotoID, MemberID) as\n(\n    select  photoID,\n            memberID\n    from MemberPhotos\n)\n\nselect PhotoID, MemberID from photos\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":13274628,"title":"SQL Server - Count characters between two characters","body":"<p>How would one count the number of letters (alphabetically a to z or z to a) between two characters?</p>\n\n<p>For example:</p>\n\n<pre><code>WITH    ExampleData\n          AS ( SELECT   'a' AS StartChar, 'e' AS EndChar\n               UNION ALL\n               SELECT   'm', 'r'\n               UNION ALL\n               SELECT   'f', 'a'\n             )\n    SELECT  StartChar ,\n            EndChar\n    FROM    ExampleData\n</code></pre>\n\n<p>Would need to produce:</p>\n\n<pre><code>StartChar   EndChar    Diff\na           e          4\nm           r          5\nf           a          -5\n</code></pre>\n\n<p>I see how this could easily be done using udf's and a while loop but I was wondering if there was a faster way?</p>\n"},{"tags":["sql","sql-server","performance","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13280548,"title":"Performance issue in retrieving multiple output of the same column with different values from a single table","body":"<p>is there anyway to get the following results from query without joining the same table three times (or) without reading the same \"wordlocation\" table three times (or more if there are more words)? If there are three or more words, it takes about over a minute for the results to be returned.</p>\n\n<p>Currently \"wordlocation\" table has three rows being (\"bookid\",\"wordid\",\"location\") and it currently has 917802 rows.</p>\n\n<p>What I am trying to do is </p>\n\n<ol>\n<li>retrieve the \"bookid\" that contains all the words specified in the query by \"wordid\".</li>\n<li>sum word count of all words (from the query) from each book</li>\n<li>minimum values of each word location, e.g. (min(w0.location), min (w1.location)</li>\n</ol>\n\n<p>I have tried commenting out count(w0.wordid) and min(location) calculations to see whether they are affecting the performance but this is not the case. Joining the same table multiple time was the case.</p>\n\n<p><img src=\"http://i.stack.imgur.com/SYLB7.jpg\" alt=\"enter image description here\"></p>\n\n<p>(this is the same code as the above image)   </p>\n\n<pre><code>select \n    w0.bookid, \n    count(w0.wordid) as wcount, \n    abs(min(w0.location) + min(w1.location) + min(w2.location)) as wordlocation, \n    (abs(min(w0.location) - min(w1.location)) + abs(min(w1.location) - min(w2.location))) as distance \n    from \n    wordlocation as w0 \n    inner join \n    wordlocation as w1 on w0.bookid = w1.bookid \n    join \n    wordlocation as w2 on w1.bookid = w2.bookid \n    where \n    w0.wordid =3 \n    and \n    w1.wordid =52 \n    and \n    w2.wordid =42\n    group by w0.bookid \n    order by wcount desc;\n</code></pre>\n\n<p>This is the result that I am looking for, and which I got from running the above query, but it takes too long if I specify more than 3 words, e.g. (w0 = 3, w1 = 52 , w2 = 42, w3 = 71)</p>\n\n<p><img src=\"http://i.stack.imgur.com/08dD5.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":49,"score":2,"question_id":13279901,"title":"Grouping by Week in SQL, but displaying full datetime?","body":"<p>the following statement: </p>\n\n<pre><code>group by datepart(wk, createdon)\n</code></pre>\n\n<p>Groups the selected rows according to the week in which they fall.  My select statement shows the following: </p>\n\n<pre><code>SELECT \n    datepart(wk, createdon) week,\n</code></pre>\n\n<p>How do I display the actual datetime of the week(\"12-10-2012\"), instead of the number (\"12\")?</p>\n"},{"tags":["java","tsql","jdbc","sqljdbc"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":13278830,"title":"Valid SQL using temp tables returning no result set","body":"<p>I've been searching google and stack overflow for the past several hours, and can't seem to find an exact match on this issue. I'm relatively new to java, so please correct me if I'm just doing something incredibly silly!</p>\n\n<p>Issue: When executing a try-with-resource query (statement.executeQuery(stmt)) I am getting a 'Statement did not return a result set'</p>\n\n<p>I can guarantee this is valid SQL, and when run through SSMS the query works - and when using the select...into...from style syntax, this query works as well [in java]. The select...into...from is not a viable option though as it creates performance issues (23 second query turns into a 5+ minute query due to resource utilization)</p>\n\n<p>Proof of concept:\nSQL file: c:\\test.sql</p>\n\n<pre><code>set nocount on\ncreate table #test (loannum int)\ninsert into #test (loannum)\nselect 1\nselect * from #test\ndrop table #test\n</code></pre>\n\n<p>This query is used to make a cached result set so that I can pass the data around other functions without leaving an open connection to the database...</p>\n\n<p><strong>Note: SQLInfo in the below is just \"C:\\test.sql\"</strong>\n&lt; snip></p>\n\n<pre><code>try(BufferedReader in = new BufferedReader(new FileReader(SQLInfo)))\n                {\n                    String str;\n                    StringBuffer sb = new StringBuffer();\n                    while((str = in.readLine()) != null)\n                    {\n                        sb.append(str + System.getProperty(\"line.separator\"));\n                    }\n\n                    _stmt = sb.toString();\n                }\n</code></pre>\n\n<p>&lt; /snip></p>\n\n<p>which is later used in the below...\n&lt; snip></p>\n\n<pre><code>try (Connection connection = DriverManager.getConnection(CONNECTION);\n                Statement statement = connection.createStatement();\n                ResultSet resultset = statement.executeQuery(_stmt)\n            ) \n        {\n\n            crs.populate(resultset);\n\n            return crs;\n        }\n        catch (SQLException e) \n        {\n            e.printStackTrace();\n        }\n        return crs;\n</code></pre>\n\n<p>&lt; /snip></p>\n\n<p>What I'm expecting, is a cached result set that will be used in a defaulttablemodel to display a \"loannum\" field, and value of 1 -- what I really get is the following error: \"com.microsoft.sqlserver.jdbc.SQLServerException: The statement did not return a result set...\"</p>\n\n<p>If I modify the SQL to the following:</p>\n\n<pre><code>set nocount on\nselect 1 as loannum\ninto #test\nselect * from #test\ndrop table #test\n</code></pre>\n\n<p>I get the expected return result of \"loannum\" with value of 1.</p>\n\n<p>It appears to have something to do with the create table statement in the executeQuery method, but it's a temporary table! Is there any way to make the above to work with the create table (value type, value type, value type) insert into... method?</p>\n\n<p>**Note: I've attempted to use the .execute(String) method, and parse through the return results. It appears to have the same issue, but it's entirely possible I'm implementing it incorrectly.</p>\n\n<p>**Secondary note: The defaulttablemodel works fine, and returns information to a JTable that displays on screen. This dynamically allocates the column names, and displays the associated values. I can provide a sample of this code if needed, but i don't think it's relevant to the issue as this is failing on simply creating the resultset, rather then when it's trying to assign the information to the table model.</p>\n\n<p>[Editing this in]: Stored procedures on SQL side are not a viable option in this instance. This is a query against a data warehouse that does not allow stored procs as company policy (I've pushed back, and have been smacked down) - As a result, I'm working on this ... hackish solution.</p>\n\n<p>Hopefully somebody has some insight into this issue!</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":13278552,"title":"GROUP BY WEEK with SQL","body":"<p>I have the following: </p>\n\n<p><a href=\"http://sqlfiddle.com/#!6/226ae/1\" rel=\"nofollow\">http://sqlfiddle.com/#!6/226ae/1</a></p>\n\n<p>I'm trying to now add one row for each week of the year, and filter the contacts accordingly.  CONTACTS has a datetime column.  The new table will look like: </p>\n\n<pre><code>        Status 1    Status 2    Status 3\nWeek 1      3          4           2\nWeek 2      1          5           3\nWeek 3      2          2           4\n</code></pre>\n\n<p>I think that DATEADD needs to be used, however I'm at a loss in terms of how to begin changing my query.  </p>\n\n<p>I do know that MySQL has a GROUP BY WEEK command, but I don't think that SQL has an equivalent.  What's the best way to accomplish this? </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":27,"score":1,"question_id":13277646,"title":"SQL Grouping by predefined date range","body":"<p>I have the following: </p>\n\n<p><a href=\"http://sqlfiddle.com/#!2/fca3d/1\" rel=\"nofollow\">http://sqlfiddle.com/#!2/fca3d/1</a></p>\n\n<p>I'm trying to now add one row for each week in the year, and filter the contacts accordingly.  The new table will look like: </p>\n\n<pre><code>        Status 1    Status 2    Status 3\nWeek 1      3          4           2\nWeek 2      1          5           3\nWeek 3      2          2           4\n</code></pre>\n\n<p>I think that DATEADD needs to be used, however I'm at a loss in terms of how to begin changing my query.  Any help would be much appreciated!  </p>\n"},{"tags":["tsql","select","duplicates"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":21,"score":1,"question_id":13278337,"title":"Select Single Record if ID/Name is Duplicated","body":"<p>This seems like a really simple problem but I can't seem to figure it out right now...</p>\n\n<p>Here is a simplified view of the data that I am fetching from my current stored proc:</p>\n\n<pre><code>ID     Name         Class     Desc\n---    -----        ------    -----\n84     Calvin J.    2B\n53     Fred D.      3B\n53     Fred D.      ADJ       Change/Correction\n47     Mary F.      3A\n47     Mary F.      ADJ       New Product\n09     Donald M.    ADJ       Cancelled\n</code></pre>\n\n<p>I need to modify my procedure to select only one record per individual. If a person has an adjustment, I only want to select the record with the adjustment and disregard the other record. Based on the above, this is the result set that I am trying to return:</p>\n\n<pre><code>ID     Name         Class     Desc\n---    -----        ------    -----\n84     Calvin J.    2B\n53     Fred D.      ADJ       Change/Correction\n47     Mary F.      ADJ       New Product\n09     Donald M.    ADJ       Cancelled\n</code></pre>\n\n<p>Help please!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":39,"score":1,"question_id":13277588,"title":"SQL INNER JOINS in SP converting date and/or time from character string getting error message","body":"<p>I have searched about 20 results apertaining to the error message \"Conversion failed when converting date and/or time from character string.\" and none seem to address my issue.</p>\n\n<p>A little history, last Friday the queries were working just fine and the data returned was proper. On the following Monday, the queries no longer worked and gave this error message, \"Conversion failed when converting date and/or time from character string.\"  So, after a few hours of battling it was able to run a function with the offending code in it and the query ran perfect again. Until this morning. I came into the office and ran the query and received the error \"Conversion failed when converting date and/or time from character string.\"  So now I am pulling my hair out.</p>\n\n<p>I started by verifying each record being returned is, in fact, a valid date using the isDate function. All the dates are valid dates in string format. I am simply doing a check to see whether or not the record is older than 1 year. </p>\n\n<p>I do have several INNER JOINS and have been wondering if they are affecting the output.</p>\n\n<pre><code>SELECT \ngc2p.partnumber, gc2p.orderby, gc2p.campaigncode, gp2a.assetfilename\nFROM [StepMirror].[dbo].[stepview_nwppck_ngn_getclassification2productrefs] gc2p\n,[StepMirror].[dbo].[stepview_nwppck_ngn_getpimweblegalattrlist1] gpwa\n,[StepMirror].[dbo].[stepview_nwppck_ngn_getclassification2assetrefs] gc2a \n,[StepMirror].[dbo].[stepview_nwppck_ngn_getproduct2assetrefs] gp2a \nWHERE gc2p.partnumber=gpwa.PARTNUMBER and\ngc2p.id=gc2a.id and\ngp2a.PRODUCTNAME=gpwa.PARTNUMBER and\nATTRIBUTENAME='New Date' AND \nATTRIBUTEVALUE &gt; dateadd(month,-12,getdate()) AND \ngc2p.id = '5665976' and \ngc2a.assettype='Primary Image' AND \ngp2a.ASSETTYPE = 'Primary Image'\norder by gc2p.orderby\n</code></pre>\n\n<p>If anyone could give me a helping hand that would be wonderful.</p>\n\n<p>Edit: The query runs fine when I remove 'ATTRIBUTEVALUE > dateadd(month,-12,getdate())'. I forgot to mention the exact part of the query throwing the error.</p>\n\n<p>Edit: Updated Query - <strong>Now Working Query</strong> for those seeking a similar answer.</p>\n\n<pre><code>SELECT TOP 18 gc2p.partnumber, gpwa.ATTRIBUTECNAME,gp2a.ASSETFILENAME, gpwa.ATTRIBUTEVALUE\nFROM [StepMirror].[dbo].[stepview_nwppck_ngn_getclassification2productrefs] gc2p\nINNER JOIN [StepMirror].[dbo].[stepview_nwppck_ngn_getpimweblegalattrlist1] gpwa ON gc2p.partnumber=gpwa.PARTNUMBER and gpwa.ORDERBY='96'\nINNER JOIN [StepMirror].[dbo].[stepview_nwppck_ngn_getclassification2assetrefs] gc2a ON gc2p.id=gc2a.id\nINNER JOIN [StepMirror].[dbo].[stepview_nwppck_ngn_getproduct2assetrefs] gp2a ON gc2p.partnumber=gp2a.PRODUCTNAME\nWHERE gc2p.id = 5665976 AND gp2a.assettype='Primary Image' AND gc2a.assettype='Primary Image' \nAND(CASE WHEN ISDATE(ATTRIBUTEVALUE)  = 0 then NULL ELSE ATTRIBUTEVALUE END) &gt; dateadd(month,-12,getdate())\norder by gc2p.orderby\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":35,"score":1,"question_id":13275431,"title":"Finding the total amount for my query","body":"<p>I have a query that allows me to retrieve customer orders.</p>\n\n<pre><code>Select ID, OrderID, Item, Price from customerOrders\nWhere Order = 1\n</code></pre>\n\n<p>is there a way of totalling up the final amount to pay and have it visible below, but still be able to view all details needed in the sql query, for example</p>\n\n<pre><code>ID    |  OrderID |  Item  | Price\n1     |   1      |  Book  | 9.99\n2     |   1      |  DVD   | 12.99\n\n                    total = 22.98\n</code></pre>\n\n<p>Many thanks in advance</p>\n"},{"tags":["xml","tsql","insert","dml"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":23,"score":4,"question_id":13274572,"title":"how to assign IDs to xml nodes in the same level","body":"<p>I'm trying to modify a third party xml so that all the elements have Id's from T-SQL.</p>\n\n<p>This is the original xml (section):</p>\n\n<p></p>\n\n<pre><code>&lt;Tables&gt;\n   &lt;Table Type=\"LineItem\"&gt;\n      &lt;TableRow&gt;\n        &lt;Field Name=\"LI_NominalCode\" Type=\"wd_lit_nominalcode\"&gt;244234&lt;/Field&gt;\n        &lt;Field Name=\"LI_NominalDesc\" Type=\"lit_nominaldesc\"&gt;RENT RECEIVABLE - INTERNAL&lt;/Field&gt;\n        &lt;Field Name=\"LI_Account\" Type=\"lit_wd_account\" /&gt;\n        &lt;Field Name=\"LI_AccountDesc\" Type=\"lit_wd_accountdesc\" /&gt;\n        &lt;Field Name=\"LI_SecondAccount\" Type=\"lit_wd_2ndaccount\" /&gt;\n        &lt;Field Name=\"LI_SecondAccountDesc\" Type=\"lit_wd_2ndaccountdesc\" /&gt;\n        &lt;Field Name=\"LI_NetValue\" Type=\"lit_vatexcludedamount\"&gt;4522.89&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyUsage\" Type=\"wd_energyusage\"&gt;56666&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyType\" Type=\"wd_energytype\"&gt;ELECTRICITY&lt;/Field&gt;\n      &lt;/TableRow&gt;\n      &lt;TableRow&gt;\n        &lt;Field Name=\"LI_NominalCode\" Type=\"wd_lit_nominalcode\"&gt;150021&lt;/Field&gt;\n        &lt;Field Name=\"LI_NominalDesc\" Type=\"lit_nominaldesc\"&gt;Rent Building 1&lt;/Field&gt;\n        &lt;Field Name=\"LI_Account\" Type=\"lit_wd_account\" /&gt;\n        &lt;Field Name=\"LI_AccountDesc\" Type=\"lit_wd_accountdesc\" /&gt;\n        &lt;Field Name=\"LI_SecondAccount\" Type=\"lit_wd_2ndaccount\" /&gt;\n        &lt;Field Name=\"LI_SecondAccountDesc\" Type=\"lit_wd_2ndaccountdesc\" /&gt;\n        &lt;Field Name=\"LI_NetValue\" Type=\"lit_vatexcludedamount\"&gt;456.37&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyUsage\" Type=\"wd_energyusage\"&gt;2805.00&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyType\" Type=\"wd_energytype\"&gt;ELECTRICITY&lt;/Field&gt;\n      &lt;/TableRow&gt;\n      &lt;TableRow&gt;\n        &lt;Field Name=\"LI_NominalCode\" Type=\"wd_lit_nominalcode\"&gt;2342341&lt;/Field&gt;\n        &lt;Field Name=\"LI_NominalDesc\" Type=\"lit_nominaldesc\"&gt;Rent Building 2&lt;/Field&gt;\n        &lt;Field Name=\"LI_Account\" Type=\"lit_wd_account\" /&gt;\n        &lt;Field Name=\"LI_AccountDesc\" Type=\"lit_wd_accountdesc\" /&gt;\n        &lt;Field Name=\"LI_SecondAccount\" Type=\"lit_wd_2ndaccount\" /&gt;\n        &lt;Field Name=\"LI_SecondAccountDesc\" Type=\"lit_wd_2ndaccountdesc\" /&gt;\n        &lt;Field Name=\"LI_NetValue\" Type=\"lit_vatexcludedamount\"&gt;355&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyUsage\" Type=\"wd_energyusage\"&gt;6900&lt;/Field&gt;\n        &lt;Field Name=\"LI_EnergyType\" Type=\"wd_energytype\"&gt;ELECTRICITY&lt;/Field&gt;\n      &lt;/TableRow&gt;\n    &lt;/Table&gt;\n    &lt;Table Type=\"BankAccountTable\" /&gt;\n    &lt;Table Type=\"VATTable\" /&gt;\n  &lt;/Tables&gt;\n</code></pre>\n\n<p>As you can see, the <code>&lt;Table&gt;</code> elements don't have Id's, so later in the process is difficult to identify them.</p>\n\n<p>I'd like to create a loop to go through all the <code>&lt;Table&gt;</code> elements and execute a snippet like this:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>set @xml.modify('\ninsert attribute ID {sql:variable(\"@idString\")}\ninto (/Documents/Document/Invoice/Tables/Table[@Type=\"LineItem\"]/TableRow)[sql:variable(\"@id\")]')\n</code></pre>\n\n<p>The problem lies on the last sql variable, the error is:</p>\n\n<blockquote>\n  <p>XQuery [modify()]: Only 'http://www.w3.org/2001/XMLSchema#decimal?',\n  'http://www.w3.org/2001/XMLSchema#boolean?' or 'node()*' expressions\n  allowed as predicates, found 'xs:string ?'</p>\n</blockquote>\n\n<p>This works fine, but I dont want to change always the same row (number 1).</p>\n\n<pre><code>set @xml.modify('\ninsert attribute ID {sql:variable(\"@idString\")}\ninto (/Documents/Document/Invoice/Tables/Table[@Type=\"LineItem\"]/TableRow)[1]')\n</code></pre>\n\n<p>By the way, if I use an int variable instead of a string as such:</p>\n\n<pre><code>set @xml.modify('insert attribute ID {sql:variable(\"@idString\")} \n                 into (/Documents/Document/Invoice/Tables/Table[@Type=\"LineItem\"]/TableRow)[sql:variable(\"@idInt\")]')` \n</code></pre>\n\n<p>I get another error:</p>\n\n<blockquote>\n  <p>XQuery [modify()]: The target of 'insert' must be a single node, found\n  'element(TableRow,xdt:untyped) *</p>\n</blockquote>\n"},{"tags":["sql-server","tsql","database-performance"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":13274083,"title":"COLLATE clause cannot be used on expressions containing a COLLATE clause","body":"<p>I have two tables: tab1 and tab2. Every table has only one VARCHAR(MAX) column.</p>\n\n<p>I need to obtain only those pairs of values, which are equals, but differs in only case.</p>\n\n<p>Example input:</p>\n\n<pre><code>tab1.t1     tab2.t2\n-----------------------\nfff     fff\nFFF     fff\nFff     fff\nFFF     FFA\nFfA     FFF\nFFF     aaa\nbbb     aaa\n\nRelated output:\n\nt1      t2\n-----------------------\nfff     FFF\nFFF     fff\nFff     fff\nFff     FFF\nFfA     FFA\n</code></pre>\n\n<p>Tables tab1 and tab2 are big enough in real our real database (~ 800-1000 rows). And there are about 500-600 columns for which I need to produce this operation.</p>\n\n<p>So I need to write a fast solution.\nI write an alghoritm:</p>\n\n<ol>\n<li>remove all duplicates using case sensitive collation from tab1</li>\n<li>remove all duplicates using case sensitive collation from tab2</li>\n<li>join result sets from previous steps using case insensitive collation</li>\n<li>filter out (WHERE clause) rows which values are not equals using case sensitive collation</li>\n<li>remove duplicate rows using case sensitive collation</li>\n</ol>\n\n<p>I tried so:</p>\n\n<pre><code>SELECT DISTINCT tt.t1 COLLATE Cyrillic_General_CS_AS, tt.t2 COLLATE Cyrillic_General_CS_AS\nFROM (\n    SELECT tt1.t1, tt2.t2\n    FROM \n    (\n        SELECT tab1.t1 COLLATE Cyrillic_General_CS_AS\n                       AS t1\n        FROM (VALUES('fff'),('FFF'),('Fff'),('FFF'),('FfA'),('FFF'),('bbb')) AS tab1(t1)\n        GROUP BY tab1.t1 COLLATE Cyrillic_General_CS_AS\n    ) tt1 INNER JOIN\n    (\n        SELECT tab2.t2 COLLATE Cyrillic_General_CS_AS\n                       AS t2\n        FROM (VALUES('fff'),('fff'),('fff'),('FFA'),('FFF'),('aaa'),('aaa')) AS tab2(t2)\n        GROUP BY tab2.t2 COLLATE Cyrillic_General_CS_AS\n    ) tt2\n    ON tt1.t1 = tt2.t2 COLLATE Cyrillic_General_CI_AS\n) AS tt\nWHERE tt.t1 &lt;&gt; tt.t2 COLLATE Cyrillic_General_CS_AS\n</code></pre>\n\n<p>but it an error occur:</p>\n\n<blockquote>\n  <p>\"COLLATE clause cannot be used on expressions containing a COLLATE clause.\"</p>\n</blockquote>\n\n<p>Please suggest me how to avoid this problem without using user defined functions, temp tables, or removing group by clause (i tried them - they hardly slow down execution).</p>\n"},{"tags":["sql-server","tsql","binary","hex","like-operator"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13262433,"title":"Binary column SELECT with LIKE","body":"<p>I'm trying to find specific lines of data from a <code>BINARY</code> column.</p>\n\n<p>Example data in the <code>BINARY(2000)</code> column:</p>\n\n<pre><code>0x0600700701000C006B6173616E74696E676B6F000000000003000A0078009C0000000000E612101E000000000000000000006B031813361E00000000000000000000D4014B13141C0000000000000000000053017C13261E00000000000000000000A102E113361E000000000000000000009E02FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF2201073200000000000000000000D604D11C101C000000000000000000008C01FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0170000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000220047003700280016000F0001000B0003003F000000480200001D0000003101000000000000562B00003710000000000000134B000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFB517010000000000000000000000000012060200000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF191404000000000000000000000000009A13051D00000000000000000000A0029A13051D00000000000000000000A002BC3B0700000000000000000000000000FE050817000000000000000000000000FE05091E00000000000000000000000012060200000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF191404000000000000000000000000009A13051D00000000000000000000A0029A13051D00000000000000000000A002FB050F0D000000000000000000000100FB05101E000000000000000000000100FB05111E000000000000000000000100FE13121D00000000000000000000B402FE13121D00000000000000000000B402E213141E00000000000000000000BC02E213141E00000000000000000000BC023613161D00000000000000000000FE003613161D00000000000000000000FE00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFB05191E000000000000000000000100FE13121D00000000000000000000B402FE13121D00000000000000000000B402E213141E00000000000000000000BC02E213141E00000000000000000000BC023613161D00000000000000000000FE003613161D00000000000000000000FE000413201E00000000000000000000CC000413201E00000000000000000000CC002E01222C000000000000000000008F052E01222C000000000000000000008F05FB05241E000000000000000000000100FB05251E000000000000000000000100FB05261E000000000000000000000100FB05271E0000000000000000000001000413201E00000000000000000000CC000413201E00000000000000000000CC002E01222C000000000000000000008F052E01222C000000000000000000008F05FB052C1E000000000000000000000100FC052D1E000000000000000000000000A9262E2E000000000000000000000000A9262E2E000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF2E01222C000000000000000000008F052E01222C000000000000000000008F05FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA9262E2E000000000000000000000000A9262E2E000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000005E000000000000000000000000000000000000000500000000000000FFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n</code></pre>\n\n<p>This data has 1 result of <code>2201</code> somewhere in it. (try searching the data for 2201 and you will get 1.)</p>\n\n<p>Now I'm trying to use this query: (it should give me 512 rows of results)</p>\n\n<pre><code>SELECT * \nFROM table\nWHERE binaryfield LIKE '%2201%'\nORDER BY key\n</code></pre>\n\n<p>But no luck in getting results.</p>\n\n<p>Notes: 2201 actually is 290. I'm trying to look for the decimal value 290 which is 2201 in hex in the data that is in endian.</p>\n\n<p><strong>Update:</strong></p>\n\n<p>Tried this query (searching for: 15584)</p>\n\n<pre><code>SELECT *\nFROM CHAR_DATA1\nWHERE CHAR_DATA LIKE '%'+CAST(0xE03C AS nvarchar(MAX))+'%'\nORDER BY CHAR_KEY;\n</code></pre>\n\n<p>Now its returning almost all rows. Even manually checked the rows for E03C but none was found, but when running the query it gets returned. very odd. ideas?</p>\n"},{"tags":["tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":13274798,"title":"Convert trims off leading zeros","body":"<p>You'd think the two would both bring up the same result.  But this doesn't because the convert is trimming off the 2 zeros hence the 2nd doesn't return results as it's comparing 446641 to 446641</p>\n\n<pre><code>select memberID, \n            Photo as PhotoBlob \n    from    SomeTable\nWHERE memberId = '00446641'\n\nSelect  memberID, \n        Photo as PhotoBlob \nfrom    SomeTable\nWHERE memberId = convert(char(13), 00446641) - this is trimming off the 2 zeros\n</code></pre>\n\n<p>memberID for whatever odd reason isn't an int, it's a char(13) in that table</p>\n\n<p>UPDATE</p>\n\n<p>Here's the context:</p>\n\n<pre><code>public static MemberPhoto RetrieveMemberPhotoFromBlob(Int64 contractNumber)\n{\n    Database db = DatabaseFactory.CreateDatabase(Config.DbConnectionString_MemberPhotos);\n\n    using ( DbCommand cmd = db.GetSqlStringCommand(string.Format(@\" Select  memberID, \n                                                                            Photo as PhotoBlob \n                                                                    from    SomeTable\n                                                                    WHERE memberId = convert(char(13), @{0})\",\"memberID\")))\n    {\n        try\n        {\n            db.AddInParameter(cmd, \"@contractNumber\", DbType.Int64, contractNumber);\n</code></pre>\n"},{"tags":["tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":40,"score":-2,"question_id":13273780,"title":"Which way is a better way to code","body":"<pre><code>SELECT DISTINCT DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())) AS Query_Date,\n                pr.ixProject                               AS 'Project_Type',\n                pr.sProject                                AS 'Project_Type_Name',\n                f.ixFixFor                                 AS 'FixFor_Milestone_Type',\n                f.sFixFor                                  'FixFor_Milestone_Type_Name',\n                c.ixCategory                               AS 'Category_Bug_Type',\n                c.sCategory                                AS 'Category_Bug_Type_Name',\n                tick.Category_Bug_Count,\n                tick.Category_Bug_Hours\nFROM   [fogbugz].[dbo].[Bug] AS b\n       JOIN [fogbugz].[dbo].[FixFor] AS f\n         ON b.ixFixFor = f.ixFixFor\n       JOIN [fogbugz].[dbo].[Project] AS pr\n         ON f.ixProject = pr.ixProject\n       JOIN [fogbugz].[dbo].[Category] AS c\n         ON b.ixCategory = c.ixCategory\n       CROSS APPLY dbo.spfGetFogbugzTicketCount(b.ixProject, b.ixCategory, b.ixFixFor) AS tick\nWHERE  f.fInactive = 0\n       --AND f.ixProject NOT IN (8) --(8) implementation\n       AND b.fOpen = 1 -- true\nORDER  BY pr.sProject,\n          f.sFixFor,\n          c.sCategory\n\n--*****************FUCNTION*************\nALTER FUNCTION [dbo].[spfGetFogbugzTicketCount] (\n-- Add the parameters for the function here \n@Project_Number  AS INT,\n@Category_Number AS INT,\n@FixFor_Number   AS INT)\nRETURNS TABLE\nAS\n    RETURN\n      (SELECT TOP 1 Category_Bug_Count = COUNT(*),\n                    Category_Bug_Hours = sum(CASE\n                                               WHEN ( round(b.hrsElapsed - b.hrsCurrEst, 2) ) &lt;= 0 THEN 0\n                                               ELSE round(b.hrsElapsed - b.hrsCurrEst, 2)\n                                             END)\n       FROM   [SP03].[fogbugz].[dbo].[Bug] AS b\n       WHERE  b.ixProject = @Project_Number\n              AND b.ixCategory = @Category_Number\n              AND b.ixFixFor = @FixFor_Number\n              AND b.fOpen = 1)\n\nGO\n</code></pre>\n\n<p>Or</p>\n\n<pre><code>--******************FUNCTION******************\nSELECT DISTINCT DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())) AS Query_Date,\n                pr.ixProject                               AS 'Project_Type',\n                pr.sProject                                AS 'Project_Type_Name',\n                f.ixFixFor                                 AS 'FixFor_Milestone_Type',\n                f.sFixFor                                  'FixFor_Milestone_Type_Name',\n                c.ixCategory                               AS 'Category_Bug_Type',\n                c.sCategory                                AS 'Category_Bug_Type_Name',\n                tick.Category_Bug_Count,\n                tick.Category_Bug_Hours\nFROM   [fogbugz].[dbo].[Bug] AS b\n       JOIN [fogbugz].[dbo].[FixFor] AS f\n         ON b.ixFixFor = f.ixFixFor\n       JOIN [fogbugz].[dbo].[Project] AS pr\n         ON f.ixProject = pr.ixProject\n       JOIN [fogbugz].[dbo].[Category] AS c\n         ON b.ixCategory = c.ixCategory\n       JOIN (SELECT b.ixProject,\n                    b.ixFixFor,\n                    b.ixCategory,\n                    Category_Bug_Count = COUNT(*),\n                    Category_Bug_Hours = sum(CASE\n                                               WHEN ( round(b.hrsElapsed - b.hrsCurrEst, 2) ) &lt;= 0 THEN 0\n                                               ELSE round(b.hrsElapsed - b.hrsCurrEst, 2)\n                                             END)\n             FROM   [SP03].[fogbugz].[dbo].[Bug] AS b\n             WHERE  b.ixProject = b.ixProject\n                    AND b.ixCategory = b.ixCategory\n                    AND b.ixFixFor = b.ixFixFor\n                    AND b.fOpen = 1\n             GROUP  BY b.ixProject,\n                       b.ixFixFor,\n                       b.ixCategory) AS tick\n         ON tick.ixProject = b.ixProject\n            AND tick.ixFixFor = b.ixFixFor\n            AND tick.ixCategory = b.ixCategory\n--CROSS APPLY dbo.spfGetFogbugzTicketCount( b.ixProject, b.ixCategory, b.ixFixFor) AS tick\nWHERE  f.fInactive = 0\n       --AND f.ixProject NOT IN (8) --(8) implementation\n       AND b.fOpen = 1 -- true\nORDER  BY pr.sProject,\n          f.sFixFor,\n          c.sCategory \n</code></pre>\n"},{"tags":["sql","sql-server-2008","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":16,"score":1,"question_id":13273705,"title":"SQL to bring back material names","body":"<p>The below code is a result of a query i have created, it all works fine apart from one thing.  I have Material ID's for material names:</p>\n\n<pre><code>1 = bath\n2 = sink\n3 = toilet\n</code></pre>\n\n<p>The below works but displays sink for every material</p>\n\n<pre><code>Select cu.FName + '  ' + cu.SName as 'Name', \ncu.Address1 + ', ' + cu.Address2 + ', ' + cu.Address3 as 'Dispatch Address', \ncu.PostCode, \nco.DateOrdered,\nco.Material1,\nma.MaterialName,\nco.material2, \nma.MaterialName, \nma.Price as 'Item Price' \nfrom Customers cu \nleft join CustomerOrder co on co.CustomerID = cu.CustomerID\nleft join ItemOrder it on it.OrderID = co.OrderID \nleft join Materials ma on ma.MaterialID = co.Material1 \nor co.material2 = ma.MaterialItemID or co.material3 = ma.MaterialItemID\n</code></pre>\n\n<p>it displays as follows (just the materials are listed to stop confusion)</p>\n\n<pre><code>Material1 | MaterialName | Material2 | Material2Name | Material3 | Material3Name\n    1          Sink            2           Sink           3             Sink\n</code></pre>\n\n<p>Can anybody help with this?</p>\n"},{"tags":["tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":21,"score":2,"question_id":13269569,"title":"Drive EndDate of Current Row From StarDate of Next Row","body":"<p>Can some one please help me with how to create end date from start date.</p>\n\n<p>Products referred to a company for testing while the product with the company they carry out multiple tests on different dates and record the test date to establish the product condition i.e. (outcomeID). \nI need to establish the StartDate which is the testDate and EndDate which is the start date of the next row. But if multiple consecutive tests resulted in the same OutcomeID I need to return only one row with the StartDate of the first test and the end date of the last test. In another word if the outcomeID did not change over a few consecutive tests.\nHere is my data set \n<pre><code>\nDECLARE @ProductTests TABLE</p>\n\n<p>(\n  RequestID int not null,\n  ProductID int not null,\n  TestID int not null,\n  TestDate datetime null,\n  OutcomeID int \n)\ninsert into @ProductTests\n(RequestID ,ProductID ,TestID ,TestDate ,OutcomeID )\nselect 1,2,22,'2005-01-21',10\nunion all\nselect 1,2,42,'2007-03-17',10\nunion all\nselect 1,2,45,'2010-12-25',10\nunion all\nselect 1,2,325,'2011-01-14',13\nunion all\nselect 1,2,895,'2011-08-10',15\nunion all\nselect 1,2,111,'2011-12-23',15\nunion all\nselect 1,2,636,'2012-05-02',10\nunion all\nselect 1,2,554,'2012-11-08',17\n</pre></code></p>\n\n<p>--select *from @producttests\n<pre><code>\nRequestID   ProductID   TestID    TestDate        OutcomeID\n1               2           22    2005-01-21         10\n1               2           42    2007-03-17         10\n1               2           45    2010-12-25         10\n1               2           325   2011-01-14         13\n1               2           895   2011-08-10         15\n1               2           111   2011-12-23         15\n1               2           636   2012-05-02         10\n1               2           554   2012-11-08         17\n</pre></code>\nAnd this is what I need to achieve.</p>\n\n<p><pre><code>\nRequestID ProductID  StartDate        EndDate           OutcomeID\n1            2       2005-01-21       2011-01-14        10\n1            2       2011-01-14       2011-08-10        13\n1            2       2011-08-10       2012-05-02        15\n1            2       2012-05-02       2012-11-08        10\n1            2       2012-11-08       NULL              17\n</pre></code></p>\n\n<p>As you see from the dataset the first three tests (22, 42, and 45) all resulted in OutcomeID  10 so in my result I only need start date of test 22 and end date of test 45 which is the start date of test 325.As you see in test 636 outcomeID has gone back to 10 from 15 so it needs to be returned too. \n<br><br/></p>\n\n<p>--This is what I have managed to achieve at the moment using the following script</p>\n\n<pre><code>\nselect T1.RequestID,T1.ProductID,T1.TestDate AS StartDate\n       ,MIN(T2.TestDate) AS EndDate ,T1.OutcomeID \nfrom   @producttests T1\nleft join @ProductTests T2 ON T1.RequestID=T2.RequestID \nand T1.ProductID=T2.ProductID and T2.TestDate>T1.TestDate\n\ngroup by T1.RequestID,T1.ProductID ,T1.OutcomeID,T1.TestDate\n\norder by T1.TestDate\n</code></pre>\n\n<p>Result:\n<pre><code>\nRequestID   ProductID   StartDate   EndDate       OutcomeID\n1                  2    2005-01-21  2007-03-17         10\n1                  2    2007-03-17  2010-12-25         10\n1                  2    2010-12-25  2011-01-14         10\n1                  2    2011-01-14  2011-08-10         13\n1                  2    2011-08-10  2011-12-23         15\n1                  2    2011-12-23  2012-05-02         15\n1                  2    2012-05-02  2012-11-08         10\n1                  2    2012-11-08  NULL               17</p>\n\n<p></pre></code></p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13255746,"title":"Can Execute Procedure But Job That Runs Procedure Errors?","body":"<p>I have a procedure that pulls data from my database and uses MSDB.DBO.sp_send_dbmail to send out e-mails.  The procedure itself runs without a hitch when I use 'EXEC myprocedure'.  But when I set up a job for the procedure, the job fails with the following error </p>\n\n<blockquote>\n  <p>'Error formating query, probably invalid parameters [SQLState\n  42000](Error 22050).  The step failed'</p>\n</blockquote>\n\n<p>There is one step in the job with the TSQL statement 'EXEC myprocedure', using the database that my procedure is stored on.  Does anyone know what could be causing this error?</p>\n\n<p><strong>Update</strong></p>\n\n<p>I've narrowed the problem down. It's something with the Exchange server I use. I was using a domain address (ie. mail.mycompany.com) as the 'Server name' under Database Mail's account configuration wizard. I was unable to send e-mails to listservs and external users using this domain address. I talked to our Exchange guy and he recommended using the actual IP address of one of the mail servers (ie. 10.123.53.53). That fixed the problem with listservs and external users, but now I am unable to send e-mails when I run my procedure using a job (the procedure itself executes properly when I manually run it). Does anyone know what criteria on our Exchange server I will need to change to fix this? </p>\n"},{"tags":["sql","tsql","entity-attribute-value"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":17,"score":1,"question_id":13270727,"title":"Recreating historical field changes from an EAV audit table","body":"<p>Given the following tables recs and audit, how would one in SQL transform into the resultant table.</p>\n\n<p>A little background, the former table is a simplified example of an standard SQL table used in a CRUD application collecting data. On any update to a column a record is written to an audit table in EAV form. There is now a requirement to transform the recs table into a historical table with a copy of each row as it was at a point in time for reporting (the data will be stored in a star schema data warehouse ultimately.</p>\n\n<p>It seems like this would be straightforward enough in a procedural language and manageable (if ugly) using cursors, but is there a set based approach that would work?</p>\n\n<p>I'm using T-SQL right now, but I imagine that I could port any examples or ideas from any sufficiently rich SQL dialect.</p>\n\n<h2>Setup</h2>\n\n<pre><code>create table recs\n(\n    ID int identity(1,1) not null primary key,\n    Column1 nvarchar(30) not null,\n    Column2 nvarchar(30) not null,\n    sys_updated_on datetime not null\n)\n\ncreate table audit\n(\n    ID int identity(1,1) not null primary key,\n    recs_id int not null,\n    fieldname nvarchar(30) not null,\n    old_value nvarchar(30) not null,\n    new_value nvarchar(30) not null,\n    sys_updated_on datetime not null\n)\n\ninsert into recs (Column1, Column2, sys_updated_on)\nvalues ('A', 'B', '2012-10-31 22:00')\n    , ('C', 'D', '2012-10-31 22:30')\n\ninsert into audit (recs_id, fieldname, old_value, new_value, sys_updated_on)\nvalues (1, 'Column1', 'Z', 'A', '2012-10-31 22:00')\n    , (2, 'Column2','X', 'D', '2012-10-31 22:30')\n    , (1, 'Column1', 'Y', 'Z', '2012-10-31 21:00')\n</code></pre>\n\n<h2>Resultant Data</h2>\n\n<pre>\nRecs            \n\nID  Column1 Column2 sys_updated_on\n1         A       B 31/10/2012 22:00:00\n2         C       D 31/10/2012 22:30:00\n</pre>\n\n<pre>\nAudit                   \n\nID  recs_id fieldname   old_value   new_value   sys_updated_on\n1         1   Column1           Z           A   31/10/2012 22:00:00\n2         2   Column2           X           D   31/10/2012 22:30:00\n3         1   Column1           Y           Z   31/10/2012 21:00:00\n</pre>\n\n<h2>Desired result</h2>\n\n<pre>           \nrecs_id              sys_updated_on       Column1   Column2\n1                          null             Y             B\n1           31/10/2012 21:00:00             Z             B\n1           31/10/2012 22:00:00             A             B\n2                          null             C             X\n2           31/10/2012 22:30:00             C             D\n\n</pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":79,"score":2,"question_id":13271400,"title":"Allowing * in SQL query","body":"<p>I have a stored procedure and I want to allow * in it so that if user:</p>\n\n<ul>\n<li>types t* then taller, tea returns</li>\n<li>types * or <em>.</em> then all results are returned</li>\n<li>types t then all results which have t are returned like ptv, tall, sit</li>\n</ul>\n\n<p>my stored procedure is this:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[SearchEntityDataNew]\n    @SearchText varchar(100) = '*'\n\nAS\nBEGIN\n    SELECT 'Entity' as pagetype,EntityID,EntityData,EntityDataID \n    FROM EntityData \n    WHERE  EntityData LIKE '%' + @SearchText+ '%'\n    OR @SearchText = '*'\n\n    union all\n\n    SELECT 'Property' as pagetype,PropertyID,PropertyValue,EntityDataID  \n    FROM EntityDataProperty \n    WHERE  PropertyValue LIKE '%' + @SearchText+ '%'\n    OR @SearchText = '*'\nEND\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":34,"score":-3,"question_id":13271591,"title":"tsql : Delete query","body":"<pre><code>DELETE abc \nFROM abc INNER JOIN xyz ON \nabc.RECORD_TYPE = xyz.RECORD_TYPE AND \nabc.IN = xyz.IN \nOPTION (MERGE JOIN, LOOP JOIN)\n</code></pre>\n\n<p>can anyone tell me what exactly the query doing ? </p>\n"},{"tags":["sql-server-2008","tsql","if-statement","null"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":30,"score":1,"question_id":13271477,"title":"TSQL parameter with NULL value does not enter IF condition","body":"<p>I have a query that looks like this:</p>\n\n<pre><code>use [dbName]\n\nDECLARE @profile_id int\nSET @profile_id = 18\nDECLARE @test int\n\nSET @test = (SELECT user_profile_id FROM tbl_profiles WHERE id = @profile_id)\n\nSELECT @test as test\n\nif @test = NULL\n    SELECT 1\n\nelse \n    SELECT 2\n</code></pre>\n\n<p>I know that the value in the table is null, and I can see that @test is correctly being set to that value because the first SELECT shows:</p>\n\n<pre><code> |test\n1|NULL\n</code></pre>\n\n<p>However, in the IF condition the variable is not being treated as NULL because only the third SELECT is returned, showing:</p>\n\n<pre><code> |(no column name)\n1| 2\n</code></pre>\n\n<p>Why is that?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":13270462,"title":"Case when in variable declaration","body":"<p><img src=\"http://i.stack.imgur.com/jvpqC.jpg\" alt=\"enter image description here\"></p>\n\n<p>I'm looking for another column that will give the overall total counts from each gender next to the <code>eduCounts</code> column.  The rest of the query works fine.  Finding the distinct gender counts in this case has to be done by <code>select count(distinct patid) from...</code></p>\n\n<p>first try:</p>\n\n<pre><code>declare @sexcounts int\nset @sexcounts = case when members.sex 'm' then (select COUNT(distinct patid) from members where sex='m')\n                 when members.sex 'f' then (select COUNT(distinct patid) from members where sex='f')\n\nselect sex, edutext, COUNT(*) as eduCounts from \n(\nselect distinct m.patid, m.sex, e.eduText\n    from members as m\n    inner join claims as c on c.patid=m.PATID\n    inner join icdClm as ic on ic.clmid=c.clmid\n    inner join tblICD as t on t.ICD=ic.icd\n    inner join EducationTable as e on e.eduID=m.education\n    inner join IncomeTable as i on i.incomeID=m.income\n    where ISNUMERIC(ic.icd)=1 and SUBSTRING(ic.icd,1,3)='707'\n)t\ngroup by sex, eduText\norder by sex\n</code></pre>\n\n<p>second try:</p>\n\n<pre><code>declare @sexcounts int\nset @sexcounts = (select COUNT(distinct patid),case when sex 'm' then (select COUNT(distinct PATID) from members where sex='m') else (select COUNT(distinct patid) from members where sex='f') \n                    from members)\n\n    select sex, edutext, COUNT(*) as eduCounts from \n    (\n    select distinct m.patid, m.sex, e.eduText\n        from members as m\n        inner join claims as c on c.patid=m.PATID\n        inner join icdClm as ic on ic.clmid=c.clmid\n        inner join tblICD as t on t.ICD=ic.icd\n        inner join EducationTable as e on e.eduID=m.education\n        inner join IncomeTable as i on i.incomeID=m.income\n        where ISNUMERIC(ic.icd)=1 and SUBSTRING(ic.icd,1,3)='707'\n    )t\n    group by sex, eduText\n    order by sex\n</code></pre>\n\n<p>I know I could make a derived table and join on the sex column, but I'd like to know how to do it with a variable if at all possible.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":13240037,"title":"How to return only a single resultset in a stored procedure","body":"<p>Consider the following stored procedure :</p>\n\n<pre><code>create procedure [dbo].[MyTest] ( @p_SqlStatement nvarchar(max) )\nas\nbegin\n\n    exec sp_executesql @p_SqlStatement\n\n    if @@ROWCOUNT = 1\n    begin\n      select 1;\n    end\n    else if @@ROWCOUNT &lt;&gt; 1\n    begin\n      select 0;\n    end\n\nend\n</code></pre>\n\n<p>This stored procedure currently returns 2 datasets, one with the <code>exec sp_executesql @p_SqlStatement</code> data, and the other one would be either 1 or 0. Is there a way to suppress the first dataset? I mean, would it be possible that this stored procedure returns only 1 or 0 ?</p>\n\n<p>I tried adding a <code>RAISERROR( 'MyError', 18, 1 )</code> right after the <code>exec sp_executesql @p_SqlStatement</code> and then in the catch block select something else, but the first result set is always returned to my stored procedure caller...</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":13269586,"title":"SQL adding additional columns to a query","body":"<p>I'm trying to create a query that allows me to see all of the customers orders and to add an additional column using sql to view the total amount that the customer owes.</p>\n\n<p>the following code retrieves the correct data:</p>\n\n<pre><code>SELECT\n    cu.FName + '  ' + cu.SName as 'Name', \n    cu.Address1 + ', ' + cu.Address2 + ', ' + cu.Address3 as 'Dispatch Address', \n    cu.PostCode, \n    co.DateOrdered, co.DateDispatched, \n    ma.MaterialName, \n    it.Quantity, \n    ma.Price as 'Total' \nFROM\n    Customers cu \nLEFT JOIN \n    CustomerOrder co ON co.CustomerID = cu.CustomerID \nLEFT JOIN\n    ItemOrder it ON it.OrderID = co.OrderID \nLEFT JOIN \n    Materials ma ON ma.MaterialID = it.MaterialID \n</code></pre>\n\n<p>I now need to add additional code to the above to add a column to show the total amount the customer owes, but I'm stuck, can anybody help?</p>\n\n<pre><code>Date Order   |    Dispatch Date | Item  | QTY  |   Price | TOTAL AMOUNT FOR BOTH ROWS\n2012-10-30   |    2012-11-25    | Bath  | 1    |   49.99 |  \n2012-10-30   |    2012-11-25    | Sink  | 1    |   55.99 |\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":10,"down_vote_count":0,"view_count":11677,"score":10,"question_id":1383494,"title":"Alter user defined type in Sql Server","body":"<p>I created few user defined types in DB as below</p>\n\n<pre><code>CREATE TYPE [dbo].[StringID] FROM [nvarchar](20) NOT NULL\n</code></pre>\n\n<p>and assigned to various tables. My tables in db are in various schemas (not only dbo)</p>\n\n<p>But I realized I need bigger field, and I need to alter, e.g increase from nvarchar to nvarchar, but there is no ALTER TYPE statement</p>\n\n<p>I need a script that temp table/ cursor whatever and save there all tables and fields where my type is used. Then change existing fields to base type - e.g. from CustID [StringID] to CustID [nvarchar(20)].\nDrop the user type and recreate it with new type - e.g. nvarchar(50)\nand finally set back fields to user type</p>\n\n<p>I do not have rules define on types, so don't have to drop rules and re-add them</p>\n\n<p>I'm not very familiar with T-Sql, so any help is appreciated.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":3086,"score":4,"question_id":528529,"title":"Self-referencing constraint in MS SQL","body":"<p>Is it true that MS SQL restrict self-referencing constraints with ON DELETE CASCADE option? \nI have a table with parent-child relation, PARENT_ID column is foreign key for ID. Creating it with ON DELETE CASCADE option causes error </p>\n\n<blockquote>\n  <p>\"Introducing FOREIGN KEY constraint\n  may cause cycles or multiple cascade\n  paths. Specify ON DELETE NO ACTION or\n  ON UPDATE NO ACTION, or modify other\n  FOREIGN KEY constraints.\"</p>\n</blockquote>\n\n<p>I can't believe that I have to delete this hierarchy in recursive mode. Is there any issue except triggers?</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":13267349,"title":"T-SQL stored procedure - how to make parameter that accepts either integer or text","body":"<p>I have created a stored procedure that accepts 3 parameters.</p>\n\n<pre><code>@row int\n,@column VARCHAR(17)\n,@value int\n</code></pre>\n\n<p>I want the <code>@value</code> parameter to accept either text or integer because it updates different columns depending on <code>@column</code> parameter.</p>\n\n<p>Please advise</p>\n"},{"tags":["sql-server","tsql","udf"],"answer_count":4,"favorite_count":2,"up_vote_count":1,"down_vote_count":1,"view_count":394,"score":0,"question_id":4035024,"title":"How to create a UDF or View in another database that references the correct sys.objects table in the caller?","body":"<p>Using SQL Server 2008, I'd like to create a UDF that gives me the create date of an object.  This is the code:</p>\n\n<pre><code>create function dbo.GetObjCreateDate(@objName sysname) returns datetime as\nbegin\n    declare @result datetime\n    select @result = create_date from sys.objects where name = @objname\n    return @result\nend\ngo\n</code></pre>\n\n<p>I'd like to put this UDF in the master database or some other shared database so that it is accessible from anywhere, except that if I do that then the <code>sys.objects</code> reference pulls from the <code>master</code> database instead of the database that I'm initiating my query from.  I know you can do this as the <code>information_schema</code> views sit in <code>master</code> and just wrap calls to local instances of sys.objects, so I'm hoping there's a simple way to do that with my UDF as well.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":15,"score":0,"question_id":13258755,"title":"How to load image into varbinary column","body":"<p>I have table like this</p>\n\n<pre><code>CREATE TABLE [dbo].[Product](\n    [Id] [int] IDENTITY(1,1) NOT NULL,\n    [Name] [nvarchar](100) NOT NULL,\n    [Description] [nvarchar](max) NOT NULL,\n    [Price] [decimal](16, 3) NOT NULL,\n    [SmallPhoto] [varbinary](max) NULL);\n</code></pre>\n\n<p>I want load image into [SmallPhoto] field</p>\n\n<p>Main script looks like this</p>\n\n<pre><code>declare @filePath varchar(max)\ndeclare @productId int\n\nset @filePath = 'D:\\myfile.png'\nset @productId = 1\n\nupdate Product\nset SmallPhoto = -- some actions\nwhere Id = @productId\n</code></pre>\n\n<p>Expected result</p>\n\n<p>Command(s) completed successfully. :)</p>\n\n<p>UPD:</p>\n\n<p>1) My database located in other machine</p>\n\n<p>2) I do not have opportunity to copy file to remote machine</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":13264519,"title":"Getting weekly data from sql","body":"<p>I have a table which has a date column ands values according to dates.Normally if i want to select the data between two dates we use the <code>BETWEEN</code> syntax but it brings each day between those 2 values i have given.Is it possible to change it so it brings the dates with sopme interval i have given? For example if do a simple </p>\n\n<pre><code>SELECT * FROM METABLE WHERE DATE BETWEEN '2012-06-11' AND '2012-07-11'\n</code></pre>\n\n<p>It should bring me the dates as:</p>\n\n<pre><code>2012-06-11 myValue Stuff \n2012-06-12 myValue Stuff \n.\n.\n.\n2012-07-11 myValue Stuff.\n</code></pre>\n\n<p>IS it possible to change it to,</p>\n\n<pre><code>2012-06-11 myValue Stuff \n2012-06-18 myValue Stuff \n2012-06-25 myValue Stuff \n.\n.\n.\nUntil my end date.\n</code></pre>\n\n<p>So this gives me my weekly values.\nHow can i achieve that?</p>\n"},{"tags":["tsql","triggers","insert"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":19,"score":0,"question_id":13247514,"title":"Trigger insert -doesn't fire on real table with where clause","body":"<p>Hi I created trigger insert which work fine on test field \n1. when i copy data to table on which trigger is set or i use code insert into.\nThe insert look like this:</p>\n\n<pre><code>SET ANSI_NULLS ON GO\n\nSET QUOTED_IDENTIFIER ON GO\nCreate TRIGGER sometr ON [dbo].[mpomiar] For INSERT\n AS\nBegin \niNSERT INTO  \n[Database].dbo.[eksport] ([Repair_Date],[idKard],[Position],[error][Pos_X],[Pos_Y],[Pos_Z],[name],[model],[parent]) \n\nSELECT i.[Repair_Date],c.idKard,i.[Position],i.error,i.[Pos_X],i.[Pos_Y],i.[Pos_Theta],s.name, mo.Model, pn.Parent \n\nFROM inserted i\n inner join dbo.test t on i.idtst=t.idtst\n\n inner join dbo.Kard c on t.idKard=c.idKard\n\n inner join dbo.TFILE AS s ON t.idTFILE = s.idTFILE INNER JOIN\n\n        dbo.MACHINE AS mc ON t.idMC = mc.idMC INNER JOIN\n\n         dbo.PANEL AS p ON c.idPANEL = p.idPANEL INNER JOIN\n\n        dbo.PARENT AS pn ON i.idPARENT = pn.idPARENT INNER JOIN\n\n         dbo.MODEL AS mo ON pn.idMOD = mo.idMOD\n\nwhere [Repair_Error] in (400,300)     and c.idKard not in (select idKard from dbo.eksport)\n\nend\n</code></pre>\n\n<p>But when the trigger is set on real table in the MS SQL Server 2005 it only fire when i delete from code</p>\n\n<blockquote>\n  <blockquote>\n    <p>where [Repair_Error] in (400,300)     and c.idKard not in (select idKard from dbo.eksport)</p>\n  </blockquote>\n</blockquote>\n"},{"tags":["sql","sql-server-2008","tsql","subquery","cross-join"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":37,"score":1,"question_id":13263856,"title":"SQL Server subquery in cross join returns error","body":"<p>I have tables <code>A</code>, <code>B</code> and <code>C</code>. Now table <code>A</code> as column <code>A1</code>(Primary Key), table <code>B</code> has column <code>B1</code>(Primary Key) and table <code>C</code> has columns <code>A1</code>(Foreign Key to Table <code>A.A1</code>), <code>B1</code>(Foreign Key to Table <code>B.B1</code>).</p>\n\n<p>Now I'm writing a query which list all rows from <code>A</code> and <code>B</code> and a bit column which will be set to to 1 if a row is found matching in table <code>C</code> otherwise 0.</p>\n\n<pre><code>SELECT \n     ISNULL((SELECT CAST(1 AS BIT) \n             FROM C \n             WHERE C.A1 = A.A1 AND C.B1 = B.B1),0) AS [TAG],\n     A.A1,\n     B.B1\nFROM A CROSS JOIN B\n</code></pre>\n\n<p>This query is producing an <code>Subquery returned more than 1 value.</code> error even though the query has no duplicate rows after combining the <code>A1</code> and <code>B1</code> columns.</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":13243430,"title":"How to solve this variable pass into batch_date?","body":"<p>I want to pass in @batch date into batch_date...But it shows error...The error is </p>\n\n<blockquote>\n  <p>Column 'dbo.tnx_tid_InvCheck_Details.Batch_Date' is invalid in the\n  select list because it is not contained in either an aggregate\n  function or the GROUP BY clause.</p>\n</blockquote>\n\n<p>The <code>InvCheck_Details</code> table has <code>batch_date</code> for each and every <code>part_no</code>. I want to group the part_no so that I can count(tid) and sum(tid_bal) by part_no. What should i do in order to run this script? TQ...</p>\n\n<pre><code>DECLARE @batch_date datetime\nSET @batch_date = '2012-10-13 00:00:00.000'\n\n\n\nCREATE TABLE #inv_check\n(batch_date datetime,part_no varchar(25),Number_of_tid int,Updated_DT int, Tot_Tid_Bal int)\n\nINSERT INTO #inv_check\nSELECT batch_date,part_no,COUNT(tid)as Number_of_tid,0,sum(Tid_Bal)\nFROM dbo.tnx_tid_InvCheck_Details\nwhere batch_date = @batch_date\nGroup by part_no\norder by part_no\n\nUPDATE #inv_check \nSET Updated_DT = isnull(d.Updated_DT,0) \n--select i.part_no,i.Number_of_tid, isnull(d.Updated_DT,0)\nFROM #inv_check i\nLEFT OUTER JOIN \n    (SELECT part_no, COUNT(LastUpdate_DT)as Updated_DT,\n    sum(tid_bal) as Tid_bal_sum\n    FROM dbo.tnx_tid_InvCheck_Details\n    Where NOT LastUpdate_DT IS NULL\n    Group by part_no) d on i.part_no=d.part_no  \n\n\n\n    DECLARE @sql int\n    DECLARE @sql1 int\n\n\nSELECT @sql1 = count(part_no) \nFROM #inv_check\n\nSELECT @sql = count(part_no)\nFROM #inv_check\nWHERE number_of_tid= Updated_DT\n\nSELECT @sql AS Parts_Counted,@sql1 AS Full_Parts\n\nDrop table #inv_check\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":544,"score":3,"question_id":1070741,"title":"MS SQL Stored Procedure Problem","body":"<p>I have a stored procedure that works fine on my local SQL Server (2005 or 2008 cant recall off hand) but fails when I try to create the procedure on the Production server (SQL 2000). \nAny help would be appreciated. TIA. </p>\n\n<p>The stored procedure declaration is this:</p>\n\n<pre><code>/****** Object:  StoredProcedure [dbo].[AssignPCSCheckNumbers]    Script Date: 06/29/2009 13:12:24 ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nCREATE PROCEDURE [dbo].[AssignPCSCheckNumbers]          \n(          \n    @MonthEnd    DATETIME,          \n    @Seed        INT,          \n    @ManifestKey UNIQUEIDENTIFIER,          \n    @Threshold   DECIMAL(9,2)          \n)          \n\nAS          \n\nSET NOCOUNT ON          \n\nBEGIN          \n\n\n--Create a temporary table variable to store our data          \nDECLARE @MyTemp TABLE \n( \n     ProducerNumber VARCHAR(20), \n     LastCheckDate DATETIME, \n     Due DECIMAL(9,2) DEFAULT 0,\n     Returned DECIMAL(9,2) DEFAULT 0          \n)\n\n--Fill the table with a listing of producers from our PCSItems table and their ACH Status\nINSERT INTO @MyTemp ( ProducerNumber ) \nSELECT      PCSItems.ProducerNumber \nFROM        PCSItems\nLEFT JOIN   Producer\nON          PCSItems.ProducerNumber = Producer.prodNum\nWHERE       ISNULL(Producer.PayCommissionByACH,0) = 0\n\n--UPDATE the table with the last time a check was printed for each\n--of these producers\nUPDATE      @MyTemp\nSET         LastCheckDate = (\nSELECT      ISNULL(MAX(EntryDate),'1/1/1901') \nFROM        CommissionLedger WITH (NOLOCK)\nWHERE       CommissionLedger.TransactionType = 1\nAND         CommissionLedger.ProducerNumber = [@MyTemp].ProducerNumber\n)\n\n\n--update the table with the amount of comission owed to each producer          \nUPDATE      @MyTemp           \nSET         Due = (\nSELECT      IsNull(SUM(CommPaid),0)          \nFROM        ProducerComm WITH (NOLOCK)          \nWHERE       ProducerComm.CommApplies = [@MyTemp].ProducerNumber\nAND         ProducerComm.EntryDate &gt;= LastCheckDate\nAND         ProducerComm.EntryDate &lt;= @MonthEnd\n)          \n\n--update the table with the amount of commission returned by each producer                             \nUPDATE      @MyTemp          \nSET         Returned = (\nSELECT      ISNULL(SUM(Amount), 0)\nFROM        CommissionLedger WITH (NOLOCK)          \nWHERE       CommissionLedger.ProducerNumber = [@MyTemp].ProducerNumber          \nAND         CommissionLedger.EntryDate  &gt;= [@MyTemp].LastCheckDate          \nAND         CommissionLedger.EntryDate  &lt;= @MonthEnd\n)\n\n--create a table to assist with our operations          \nDECLARE @MyFinal TABLE \n(\n    ID INT IDENTITY(1,1),           \n    ProducerNumber VARCHAR(10)          \n)\n\n--just insert the producers that are owed an amount over a user specified           \n--threshold          \nINSERT INTO @MyFinal ( ProducerNumber )           \nSELECT      ProducerNumber          \nFROM        @MyTemp          \nWHERE       (Due + Returned) &gt; @Threshold           \n\n--update our items with the check numbers finally =)          \nUPDATE      PCSItems           \nSET         CheckNumber = (SELECT  (([@MyFinal].ID - 1) + @Seed)      \n                           FROM    @MyFinal          \n                           WHERE   [@MyFinal].ProducerNumber = PCSItems.ProducerNumber)          \n\nSET NOCOUNT OFF          \n\nEND\nGO\n</code></pre>\n\n<p>And the error the server responds with is this:</p>\n\n<pre><code>Msg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 35\nThe column prefix '@MyTemp' does not match with a table name or alias name used in the query.\nMsg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 45\nThe column prefix '@MyTemp' does not match with a table name or alias name used in the query.\nMsg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 55\nThe column prefix '@MyTemp' does not match with a table name or alias name used in the query.\nMsg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 55\nThe column prefix '@MyTemp' does not match with a table name or alias name used in the query.\nMsg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 79\nThe column prefix '@MyFinal' does not match with a table name or alias name used in the query.\nMsg 107, Level 16, State 2, Procedure AssignPCSCheckNumbers, Line 79\nThe column prefix '@MyFinal' does not match with a table name or alias name used in the query.\n</code></pre>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":38,"score":0,"question_id":13261194,"title":"Get Maximum Date for each month (T-SQL)","body":"<p>I have a table with data given in the screen shot</p>\n\n<p>.<img src=\"http://i.stack.imgur.com/CqhEG.jpg\" alt=\"enter image description here\"></p>\n\n<p>I need to take only those records which has maximum Snapshot_Date for each month.</p>\n\n<p>I need my resultant dataset as below</p>\n\n<p><img src=\"http://i.stack.imgur.com/fTUNa.jpg\" alt=\"enter image description here\"></p>\n\n<p>How could i do this. I need your ideas.</p>\n\n<p>I tried using </p>\n\n<pre><code>select * \nfrom table \nwhere Snapshot_Date = (select MAX(Snapshot_Date) \n                       from table \n                      where DATEPART(MONTH,Snapshot_Date)=11) \n</code></pre>\n\n<p>but i need to hardcode the month number here!!\nThanks for your time!!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":1526,"score":2,"question_id":2561130,"title":"Merge overlapping date intervals","body":"<p>Is there a better way of merging overlapping date intervals?<br>\nThe solution I came up with is so simple that now I wonder if someone else has a better idea of how this could be done.</p>\n\n<pre><code>/***** DATA EXAMPLE *****/\nDECLARE @T TABLE (d1 DATETIME, d2 DATETIME)\nINSERT INTO @T (d1, d2)\n        SELECT '2010-01-01','2010-03-31' UNION SELECT '2010-04-01','2010-05-31' \n  UNION SELECT '2010-06-15','2010-06-25' UNION SELECT '2010-06-26','2010-07-10' \n  UNION SELECT '2010-08-01','2010-08-05' UNION SELECT '2010-08-01','2010-08-09' \n  UNION SELECT '2010-08-02','2010-08-07' UNION SELECT '2010-08-08','2010-08-08' \n  UNION SELECT '2010-08-09','2010-08-12' UNION SELECT '2010-07-04','2010-08-16' \n  UNION SELECT '2010-11-01','2010-12-31' UNION SELECT '2010-03-01','2010-06-13' \n\n/***** INTERVAL ANALYSIS *****/\nWHILE (1=1)  BEGIN\n  UPDATE t1 SET t1.d2 = t2.d2\n  FROM @T AS t1 INNER JOIN @T AS t2 ON \n            DATEADD(day, 1, t1.d2) BETWEEN t2.d1 AND t2.d2 \n  IF @@ROWCOUNT = 0 BREAK\nEND\n\n/***** RESULT *****/\nSELECT StartDate = MIN(d1) , EndDate = d2\nFROM @T\nGROUP BY d2\nORDER BY StartDate, EndDate\n\n/***** OUTPUT *****/\n/*****\nStartDate   EndDate\n2010-01-01  2010-06-13 \n2010-06-15  2010-08-16 \n2010-11-01  2010-12-31 \n*****/\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","geospatial","spatial"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":12,"score":1,"question_id":13259215,"title":"STintersects() to find the Intersection point","body":"<p>I have two geometry which I am using to check if they intersect and if they do I need the intersection point.</p>\n\n<p>Currently I can get only Boolean output where if it intersects = 1 and if it does not intersect it will give =0 . Is there any way I can find the intersection of two shapes in geometry?</p>\n\n<p>Cheers,</p>\n"},{"tags":["tsql","datetime","null"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":13258699,"title":"INSERT null datetime value into SQL table","body":"<p>Below is a stored procedure we use are using to populate a table in an SQL database. The @expDate is a parameter that is sent in from a C# batch job, which gets it's values from and Excel spreadsheet. </p>\n\n<p>If the training for the current agent is active, the spreadsheet will not have a value in the expiration date cell. This causes a blank string to be sent to the stored procedure from the C# code, which then gets translated into the datetime value 1900-01-01. This is fine up until the point where I need to insert new records into the table using the cursor. </p>\n\n<p>If the @expDate value is 1900-01-01, then I need the value in the SQL record's expiration date field to be NULL. However, I cannot set @expDate = NULL nor can I simply set it to blank ('') [EDIT: I cannot set to blank due to a business rule. A blank value will cause the field's value to be set at 1900-01-01]. Any suggestions? </p>\n\n<pre><code>    DECLARE @date datetime = GETDATE()\n    IF @expDate = '1900-01-01' SET @flag = '1'\n    IF @expDate = '1900-01-01' SET @expDate = GETDATE()\n\n    DECLARE prod_cursor CURSOR LOCAL SCROLL FOR\n    SELECT ProductCode \n    FROM CourseToProduct \n    WHERE CourseCode = @courseCode and (TerminationDate &gt;= @expDate OR TerminationDate IS NULL)\n\n    IF @flag = '1' SET @expDate = ''\n\n    OPEN prod_cursor\n\n    FETCH NEXT FROM prod_cursor\n    INTO @productCode\n\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        IF NOT EXISTS\n        (\n        SELECT *\n        FROM AgentProductTraining\n        WHERE @sNumber = SNumber and \n              @courseCode = CourseCode and \n              @productCode = ProductCode and \n              @dateTaken = DateTaken\n        )\n        BEGIN\n            IF @sNumber IS NOT NULL\n            BEGIN\n                INSERT INTO AgentProductTraining\n                            (\n                             SNumber,\n                             CourseCode,\n                             ProductCode,\n                             DateTaken,\n                             DateExpired,\n                             LastChangeOperator,\n                             LastChangeDate\n                            ) \n                VALUES      (\n                             @sNumber,\n                             @courseCode,\n                             @productCode,\n                             @dateTaken,\n                             COALESCE(@expDate, 'NULL'),\n                             @lastChangeOperator,\n                             @lastChangeDate\n                           )    \n            END\n        END\n\n        FETCH NEXT FROM prod_cursor\n        INTO @productCode\n    END\n    CLOSE prod_cursor;\n    DEALLOCATE prod_cursor;\n</code></pre>\n"},{"tags":["tsql","duration","sequential"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":82,"score":3,"question_id":13048728,"title":"t-sql sequential duration","body":"<p>I have a table that tracks user interactions with a customers record.  I want to track the duration of each touch by a user, that is, the amount of time spent by each user every time we are required to access the customers record.  Ive got the basics down by using ROW_NUMBER() OVER (PARTITION BY | ORDER BY).  The issue that I cant get my pea brain around is how to separate two distinct user touches when those touches are sequential, but separated by a significant amount of time.  I dont know that Ive explained that clearly, but the examples below should clarify:</p>\n\n<p>Here is an example of data that I can query successfully:</p>\n\n<pre><code>DATE        TIME        USER\n11/17/2011  1:30:47     ZDBatch\n11/17/2011  1:32:40     ZDBatch\n12/13/2011  10:39:46    EMSZC27\n12/13/2011  10:45:48    EMSZC27\n</code></pre>\n\n<p>The desired result set is</p>\n\n<pre><code>DURATION (MIN)  USER\n1.883   ZDBatch\n6.033   EMSZC27\n</code></pre>\n\n<p>and is achieved with the following query (note that Ive left some columns out of the above example):</p>\n\n<pre><code>; WITH CTE1 AS\n    (\n    SELECT  ROW_NUMBER() OVER (PARTITION BY thr.[tdate], thr.[job], thr.[who], thr.[moddate]  ORDER BY thr.[moddate]) AS RowNo,\n    thr.[tdate], thr.[job], thr.[moddate], thr.[modtime], thr.[seq], thr.[who], \n         thr.[description], thr.[histtype], thr.[attachment], thr.[data1], thr.[data2]\n    FROM    Trip_History_Reporting thr\n    WHERE   thr.[tdate] = '2011-10-24' --AND thr.[job] IN ('0653-A', '0128-A')\n        AND LEFT(thr.[description], 8) &lt;&gt; 'Recalled'\n        AND (LEFT(thr.[who],5) = 'EMSZC' OR thr.[who] = 'ZDBatch')\n        --ORDER BY thr.[moddate], thr.[modtime]\n    )\n\nSELECT  tdate, job, MIN(RowNo), MAX(RowNo), MIN(modtime) AS [Start], MAX(modtime) AS [End], \n    CAST(CAST(DATEDIFF(SECOND, MIN(modtime), MAX(modtime)) AS DECIMAL(6,0))/60 AS DECIMAL(8,2)) AS [Duration (Min)], \n    who, moddate\nFROM    CTE1\nGROUP BY    tdate, job, who, moddate\n</code></pre>\n\n<p>Here is an example of data that I cannot query successfully (sequential distinct touches by the same user):</p>\n\n<pre><code>DATE           TIME     USER\n11/1/2011       6:34:48 EMSZC34\n11/1/2011       6:35:08 EMSZC34\n11/1/2011       6:35:08 EMSZC34\n11/1/2011       6:35:08 EMSZC34\n11/1/2011       6:35:08 EMSZC34\n11/1/2011       6:35:08 EMSZC34\n11/15/2011      11:08:32    EMSZC34\n11/15/2011      11:09:14    EMSZC34\n11/15/2011      11:09:14    EMSZC34\n11/15/2011      11:09:14    EMSZC34\n11/15/2011      11:09:14    EMSZC34\n11/15/2011      11:09:14    EMSZC34\n</code></pre>\n\n<p>The issue arises when a significant amount of time passes between the end of the first touch and the beginning of the second touch (for arguments sake, if an hour passes between touches, those are distinct touches).</p>\n\n<p>The desired result set from the above data is</p>\n\n<pre><code>DURATION (MIN)      USER\n     0.333          EMSZC34\n     0.7             EMSZC34\n</code></pre>\n\n<p>This seems so simple, but I cannot figure it out.  Thanks in advance for any ideas, suggestions, outright mockery at my thickheadedness. </p>\n\n<p>I apologize for the delay in responding.  I realize that this group is providing free assistance and I do not intend to take advantage of that by not replying quickly.  I will do my best to not let this happen again.</p>\n\n<p>Pursuant to EricZ's request, here is the example with the desired output:</p>\n\n<pre><code>DATE           TIME     USER\n11/1/2011     6:34:48   EMSZC34\n11/1/2011     6:35:08   EMSZC34\n11/1/2011     6:35:08   EMSZC34\n11/1/2011   6:35:08 EMSZC34\n11/1/2011   6:35:08 EMSZC34\n11/1/2011   6:35:08 EMSZC34\n11/15/2011    11:08:32  EMSZC34\n11/15/2011    11:09:14  EMSZC34\n11/15/2011    11:09:14  EMSZC34\n11/15/2011    11:15:24  EMSZC34\n11/15/2011    11:26:38  EMSZC34\n11/15/2011    11:34:55  EMSZC34\n11/15/2011    11:36:22  EMSZC34\n</code></pre>\n\n<p>Desired output:</p>\n\n<pre><code>DURATION (MIN)  USER\n0.333   EMSZC34\n27.833  EMSZC34\n</code></pre>\n\n<p>Thanks in advance for any assistance you can provide.  I've been researching islands and gaps in an attempt to resolve this dilemma, but I still can't figure it out.</p>\n"},{"tags":["tsql","stored-procedures","permissions","amazon-rds","sql-server-express-2008"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":13,"score":0,"question_id":13258590,"title":"How to grant access to sp_OACreate on SQL Server 2008 Express on Amazon RDS?","body":"<p>On my own SQL server, I have been using the <a href=\"http://www.simple-talk.com/sql/t-sql-programming/tsql-regular-expression-workbench/\" rel=\"nofollow\">TSQL Regular Expression Workbench</a>.  Now setting up my ecosystem on Amazon RDS, I am disappointed to find out that a <a href=\"https://forums.aws.amazon.com/thread.jspa?threadID=100954\" rel=\"nofollow\">SysAdmin role is not available with RDS</a>, which I require for using the sp_OACreate and other related sprocs as part of the workbench.</p>\n\n<p>What can I do to get around this and enable the use of these sprocs?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","query","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":13257860,"title":"When I run simple select query, is it possible not to show number of rows affected at the end?","body":"<p>I try to use OSQL in order to save query results in text file and later bulk insert those text file to a table. OSQL part is ok, however, in bulk insert, number of rows affected at the end of query results causes error. Here is an example;</p>\n\n<pre><code>select item_number, description, price from item\n\n3536114   Fruit mix     $3.99\n\n3536229   DO 20 liquid  $9.99\n\n3536251   Peppermint    $7.99\n\n(3 rows affected) ------&gt; I do not need this line.\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":8,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":1603,"score":5,"question_id":9740256,"title":"How to compare if two strings contain the same words in T-SQL for SQL Server 2008?","body":"<p>When I compare two strings in SQL Server, there are couple of simple ways with <code>=</code> or <code>LIKE</code>.</p>\n\n<p>I want to redefine equality as:  </p>\n\n<p><em>If two strings contain the same words - no matter in what order - they are equal, otherwise they are not.</em></p>\n\n<p>For example:  </p>\n\n<ul>\n<li><code>'my word'</code> and <code>'word my'</code> are equal</li>\n<li><code>'my word'</code> and <code>'aaamy word'</code> are not</li>\n</ul>\n\n<p>What's the best simple solution for this problem?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":57,"score":2,"question_id":13256813,"title":"SELECT SUM() FROM (SELECT (SELECT ())","body":"<p>I have a correct working T-SQL-script in this form</p>\n\n<pre><code>SELECT  columnA\n        AS\n        'numbers'\nFROM    tableA\nWHERE   clause\n</code></pre>\n\n<p>This script gives me as one column, called numbers, of integers. I want to sum these.</p>\n\n<p>Calling the above lines 'script' I tried the following setup</p>\n\n<pre><code>SELECT  SUM(numbers)\nFROM    (\n            script\n        )\n</code></pre>\n\n<p>Reading <a href=\"http://stackoverflow.com/questions/10439122/select-count-from-select\">select count(*) from select</a> I supposed this to work, however, it does not. I keep getting \"Incorrect syntax near.\"</p>\n\n<p>I do not know if it is important but that is here named columnA is itself maked by a SELECT statement.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":13256336,"title":"fill empty column with sequence","body":"<p>Is there any way to fill an empty column with a ascending sequence of numbers starting from 1, without using identity?</p>\n\n<p>I tried the following cursor but it is filling the same value (450) for all rows in the column:</p>\n\n<pre><code>declare cur3 cursor for\nselect new_id from sheet1$\ndeclare @no int\ndeclare @no1 int\nset @no1 = 1\nopen cur3\nfetch next from cur3 into @no\nwhile(@@FETCH_STATUS = 0)\nbegin\nupdate sheet1$ set new_id = @no1\nset @no1 = @no1 + 1\nfetch next from cur3 into @no\nend\nclose cur3\ndeallocate cur3\n</code></pre>\n"},{"tags":["tsql","sql-server-2000","grouping","matching","suppress"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":24,"score":2,"question_id":13255582,"title":"Eliminating matching values in a SQL result set","body":"<p>I have a table with a list of transactions (invoices and credits) and I need to get a list of all the rows where the invoices and credits don't match up.</p>\n\n<p>eg</p>\n\n<pre><code>user     product    value\nbill     ThingA     200\njim      ThingA    -200\nsue      ThingB     100\nliz      ThingC      50\n</code></pre>\n\n<p>I only want to see the third and fourth rows, as the values of the others match off.</p>\n\n<p>I can do this if I select product, sum(value)\n...\ngroup by product\nhaving sum(value) &lt;> 0</p>\n\n<p>which works well, but I want to return the user name as well.</p>\n\n<p>As soon as I add the user to the select, I need to group by it as well, which messes it up as the amounts don't match up by user AND product.</p>\n\n<p>Any ideas ?  I am using MS SQL 2000...</p>\n\n<p>Cheers</p>\n"},{"tags":["sql","sql-server","tsql","triggers"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":33,"score":-1,"question_id":13254417,"title":"trying to create a trigger that check age from an insert and place into another table if less than 18","body":"<p>Develop a trigger that will be placed on the marketing list table that will insert a record into the child table if the person's age is less than 18 once an insert is attempted.</p>\n\n<p>SEE the code below: </p>\n\n<pre><code>Create Trigger on_insert_marketing_list\nOn marketing_list for insert\nAs\nBEGIN\n        Declare @Name varchar (100)\n        Declare @Dob date\n        Declare @Gender char(1)\n        Declare @Parish VARCHAR(50)\n        Declare @Mobile varchar(50)\n        Declare @Provider varchar(50)\n        Declare @age int\n\n        Select @age = datediff(year,@dob,getdate())from inserted\n\n        If (@age) &lt; 18      \n        BEGIN\n        Insert Into Childlist values(@Name,@Dob,@Gender,@Parish,@Mobile,@Provider)\n        END\n\nEnd\n\ninsert into marketing_list (Name, Dob, Gender,  Parish,  Mobile, Mobile_Provider) values\n('Kendrick Lamar', '3/4/2005','M','Kingston', '18764532345','LIME')\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":594,"score":1,"question_id":6068619,"title":"Merging date intervals in SQL Server","body":"<p>I have the following data:</p>\n\n<pre><code>StartDate   |  EndDate\n-------------------------\n1982.03.02  |  1982.09.30 \n1982.10.01  |  1985.01.17 \n1985.06.26  |  1985.07.26 \n1985.07.30  |  1991.12.31 \n1992.01.01  |  1995.12.31 \n1996.01.01  |  2004.05.31 \n2004.06.05  |  2006.01.31 \n2006.02.01  |  2011.05.20              \n</code></pre>\n\n<p>I need to merge any intervals that are adjacent (both start and the end date are included in the intervals, so an interval ending on 2003.05.06 is adjacent with an interval starting on 2003.05.07), so in this case, the resulting set should be:</p>\n\n<pre><code>StartDate   |  EndDate\n-------------------------\n1982.03.02  |  1985.01.17 \n1985.06.26  |  1985.07.26 \n1985.07.30  |  2004.05.31 \n2004.06.05  |  2011.05.20              \n</code></pre>\n\n<p>For me, the obvious way to do this is to iterate the set with a cursor, and construct a result set row-by-row. However, this functionality will be within code that could potentially be called thousands of times in a day, on a server under heavy load, so I'd prefer not having any performance issues. Any data set is small (20 rows tops), and the data range is large, so any solution that generates all the dates in a range is unfeasible.</p>\n\n<p>Is there a better way I'm not seeing?</p>\n\n<hr>\n\n<p>Initialization code (from Damien's answer):</p>\n\n<pre><code>CREATE TABLE Periods (\n    StartDate datetime NOT NULL CONSTRAINT PK_Periods PRIMARY KEY CLUSTERED,\n    EndDate datetime NOT NULL\n)\n\nINSERT INTO Periods(StartDate,EndDate)\nSELECT '19820302', '19820930'\nUNION ALL SELECT '19821001', '19850117'\nUNION ALL SELECT '19850626', '19850726'\nUNION ALL SELECT '19850730', '19911231'\nUNION ALL SELECT '19920101', '19951231'\nUNION ALL SELECT '19960101', '20040531'\nUNION ALL SELECT '20040605', '20060131'\nUNION ALL SELECT '20060201', '20110520'\n</code></pre>\n"},{"tags":["c#","xml","tsql","stored-procedures","xml-parsing"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":13252185,"title":"System.Data.SqlClient.SqlException: XML parsing illegal name character\\r\\n","body":"<p>I have a T-SQL stored procedure in a SQL Server 2008 database that I am calling from some C# code. The stored procedure is as follows:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[spDeleteActivityFromUserProfile](\n        @profile_id int,\n        @user_id nvarchar(50),\n        @activity_name nvarchar(50)\n)\nAS\nBEGIN\n   SET NOCOUNT ON;\n\n    -- statements for procedure here\n    DECLARE @profiles_xml xml\n    SET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE profiles.value('(Profile/ID)[1]','int')= @profile_id)\n    SET @dprofiles_xml.modify('\n    delete /Profile/User[ID = sql:variable(\"@user_id\")]/Activities/Activity[Name=sql:variable(\"@activity_name\")]\n    ')\n\n    UPDATE tbl_applied_profiles\n    SET profiles = @profiles_xml\n    WHERE profiles.value('(Profile/ID)[1]','int')= @profile_id\nEND\n</code></pre>\n\n<p>An example of the XML entries from the table, such as would be contained in <code>@profiles_xml</code> would be :</p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;20&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;somename&lt;/Name&gt;\n    &lt;Activities&gt;\n      &lt;Activity&gt;\n         &lt;Name&gt;activity1&lt;/Name&gt;\n      &lt;/Activity&gt;\n    &lt;/Activities&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n\n<p>This stored procedure functions as expected when I execute it in the the SQL Server Management Studio, and deletes a specified element from the targeted xml. However When I try and call it from my C# code, I get the following error:</p>\n\n<blockquote>\n  <p><em>System.Data.SqlClient.SqlException: XML parsing: line 1, character 143, \n  illegal name character\\r\\n</em></p>\n</blockquote>\n\n<p>I am calling it from my C# code as follows:</p>\n\n<pre><code>public Boolean DeleteServiceFromServerProfile(int profileID, String userID, String activityName)\n{\n            try\n            {\n                SqlCommand com = odbchelper.SQLConnection.CreateCommand();\n                com.CommandText = \"spDeleteActivityFromUserProfile\";\n\n                /*add command parameters*/\n                SqlParameter paramProfileID = new SqlParameter(\"@profile_id\", profileID);\n                com.Parameters.Add(paramProfileID);\n\n                SqlParameter paramUserID = new SqlParameter(\"@user_id\", userID);\n                com.Parameters.Add(paramuserID);\n\n                SqlParameter paramActivityName = new SqlParameter(\"@activity_name\", activityName);\n                com.Parameters.Add(paramActivityName);\n\n                // execute query\n                com.ExecuteNonQuery();\n\n                return true;\n            }\n            catch(Exception ex)\n            {\n                sLastError = ex.ToString();\n            }\n\n            return false;\n        }\n</code></pre>\n\n<p>I am not sure how the <code>\\r\\n</code> (which is a system new line character) is getting injected into the command. Is there a way I can check for that and strip it out from either the command in the C# or from the parameters within the stored procedure itself?</p>\n"},{"tags":["sql","xml","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":34,"score":1,"question_id":13225424,"title":"Insert elements/values into specific child element of XML column in t-sql","body":"<p>In SQL Server 2008, I would like to insert some elements and values into a specific child element of an xml column based on the value of another of that element's children (ID in this case). The xml currently looks like this: </p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;16&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;test&lt;/Name&gt;\n    &lt;Activities /&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n\n<p>However, there could potentially be multiple <code>&lt;User&gt;</code> elements within the xml, and I need to insert only into the <code>&lt;User&gt;</code> of a specific <code>&lt;ID&gt;</code> value. How can I achieve this in MS SQL Server 2008/ t-sql? Thanks in advance.</p>\n\n<p><strong>Edit:</strong>\nTo simplify, I am grabbing the xml from that column and setting it to a variable:</p>\n\n<pre><code>DECLARE @profiles_xml xml\nDECLARE @profile_id int\nSET @profile_id = 16\nSET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE\nprofiles.value('(Profile/ID)[1]','int')= @profile_id)\n</code></pre>\n\n<p>The resulting xml value of @profiles_xml looks like what I have above.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":11110775,"title":"How to generate table name by datetime?","body":"<p>I realize this is syntactically bad but I figure it somewhat explains what I'm trying to do. Essentially, I have a batch job that is going to run each morning on a small table and as a part of the spec I need to create a backup prior to each load that can be accessed by a report.</p>\n\n<p>What I have so far is:</p>\n\n<pre><code>select  *\ninto    report_temp.MSK_Traffic_Backup_ + getdate()\nfrom    property.door_traffic\n</code></pre>\n\n<p>How can I make this function or should I consider doing this a better way?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":34,"score":3,"question_id":13253233,"title":"Easiest way to remove the first instance of two different words in a stored procedure","body":"<p>I've got a column that has some <code>&lt;p&gt;</code> tags like:</p>\n\n<pre><code>&lt;p&gt;test  test 2&lt;/p&gt;    &lt;p&gt;this is a test 2&lt;/p&gt;    &lt;p&gt;this is a test 3&lt;/p&gt;\n</code></pre>\n\n<p>What is the best way to always remove the first <code>&lt;p&gt;</code> with corresponding <code>&lt;/p&gt;</code>.</p>\n\n<p>So that the result becomes:</p>\n\n<pre><code>test test 2 &lt;p&gt; this is a test 2 &lt;/p&gt; &lt;p&gt; this is a test 3&lt;/p&gt;\n</code></pre>\n\n<p>It should work for any case even <code>&lt;p&gt;1&lt;/p&gt;</code> it should result in just <code>1</code>.</p>\n\n<p>I tried using <code>CHARINDEX</code> and <code>SUBSTRING</code> but I end up with a lot of hardcoded #'s :(.</p>\n"},{"tags":["sql","string","tsql","count","symbols"],"answer_count":3,"favorite_count":2,"up_vote_count":18,"down_vote_count":0,"view_count":12364,"score":18,"question_id":1860457,"title":"How to count instances of character in SQL Column","body":"<p>I have an sql column that is a string of 100 'Y' or 'N' characters. For example: </p>\n\n<blockquote>\n  <p>YYNYNYYNNNYYNY...</p>\n</blockquote>\n\n<p>What is the easiest way to get the count of all 'Y' symbols in each row.</p>\n"},{"tags":["c#","linq","tsql","linq-to-entities"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":47,"score":3,"question_id":13250550,"title":"Linq to Entity Join and Group By","body":"<p>I am new to Linq to Entity and here is my test scenario:</p>\n\n<ul>\n<li>There are Users</li>\n<li>Users have Photo Albums. An album belongs to only one User</li>\n<li>Albums have Photos. A Photo belongs to only one Album</li>\n<li>Photos have Tags. A Tag may belong to many Photos</li>\n</ul>\n\n<p><img src=\"http://i.stack.imgur.com/pdgTy.png\" alt=\"Db Tables\"></p>\n\n<p>I want to write a method which displays Count and Name of Tags used in Albums of a particular User using Linq.</p>\n\n<p>Here is the method that I wrote and it works fine</p>\n\n<pre><code>    public static void TestStatistics(int userId)\n    {\n        // select AlbumTitle, TagName, TagCount where UserId = userId\n        var results = from photo in dbSet.PhotoSet\n                      join album in dbSet.AlbumSet on photo.AlbumId equals album.Id into albumSet\n                      from alb in albumSet\n                      where alb.UserId == userId\n                      join photoTag in dbSet.PhotoTagSet on photo.Id equals photoTag.PhotoId into photoTagSet\n                      from pt in photoTagSet\n                      join tag in dbSet.TagSet on pt.TagId equals tag.Id\n                      group new { alb, tag } by new { alb.Title, tag.Name }\n                          into resultSet\n                          orderby resultSet.Key.Name\n                          select new\n                          {\n                              AlbumTitle = resultSet.Key.Title,\n                              TagName = resultSet.Key.Name,\n                              TagCount = resultSet.Count()\n                          };\n\n        foreach (var item in results)\n        {\n            Console.WriteLine(item.AlbumTitle + \"\\t\" + item.TagName + \"\\t\" + item.TagCount);\n        }\n    }\n</code></pre>\n\n<p>And this is the standart T-SQL query which does the same</p>\n\n<pre><code>SELECT  a.Title AS AlbumTitle, t.Name AS TagName , COUNT(t.Name) AS TagCount\nFROM    TblPhoto p, TblAlbum a, TblTag t, TblPhotoTag pt\nWHERE   p.Id = pt.PhotoId AND t.Id = pt.TagId AND p.AlbumId = a.Id AND a.UserId = 1\nGROUP BY a.Title, t.Name \nORDER BY t.Name\n</code></pre>\n\n<p>It is pretty obvious that standard T-SQL query is much simpler than the Linq query.\nI know Linq does not supposed to be simpler than T-SQL but this complexity difference makes me think that I am doing something terribly wrong. Besides the SQL query generated by Linq is extremly complex.</p>\n\n<p>Is there any way to make the Linq query simpler?</p>\n\n<h2>UPDATE 1:</h2>\n\n<p>I made it a little simpler without using joins but using a approach like used in T-SQL. Actually it is now as simple as T-SQL. Still no navigation properties and no relations on db.</p>\n\n<pre><code>var results = from photo in dbSet.PhotoSet\n              from album in dbSet.AlbumSet\n              from photoTag in dbSet.PhotoTagSet\n              from tag in dbSet.TagSet\n              where photo.AlbumId == album.Id &amp;&amp; photo.Id == photoTag.PhotoId &amp;&amp;\n                    tag.Id == photoTag.TagId &amp;&amp; album.UserId == userId\n              group new { album, tag } by new { album.Title, tag.Name } into resultSet\n              orderby resultSet.Key.Name\n              select new {\n                  AlbumTitle = resultSet.Key.Title,\n                  TagName = resultSet.Key.Name,\n                  TagCount = resultSet.Count()\n              };\n</code></pre>\n"}]}
{"total":16599,"page":2,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql","sql-server-2000","sql-update"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2470,"score":1,"question_id":3867164,"title":"SQL update query syntax with inner join","body":"<p>Can anyone find my error in this query?  I'm using SQL Server 2000 and I want to update all entries in the CostEntry table to the corresponding value in the ActiveCostDetails table.  The where clause DOES work with a select statement.</p>\n\n<pre><code>    UPDATE CostEntry CE \nINNER JOIN ActiveCostDetails As AD ON CostEntry.lUniqueID = ActiveCostDetails.UniqueID\n       SET CostEntry.sJobNumber = ActiveCostDetails.JobNumber\n     WHERE CostEntry.SEmployeeCode = '002'\n       AND SubString(CostCentre, 1, 1) = sDepartmentCode\n       AND substring(CostCentre, 3, 1) = sCategoryCode\n       AND substring(CostCentre, 5, 2) = sOperationCode\n</code></pre>\n"},{"tags":["sql-server","query","tsql","time"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":53,"score":-2,"question_id":13246987,"title":"TSQL query to sum time periods per range","body":"<p>I need to create a query to sum day's hours and night's hours from a range intersec.\nFor example with this range:</p>\n\n<pre><code>8AM-8PM -&gt; day\n8PM-8AM -&gt; night\n</code></pre>\n\n<p>and one or more start-end time period:</p>\n\n<pre><code>7.30AM 10.00PM\n</code></pre>\n\n<p>I would like to get this values:</p>\n\n<pre><code>12 day's hours\n2.5 night's hours\n</code></pre>\n\n<p>I don't know which is the bast way to accomplish this function.</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":17,"score":0,"question_id":13249308,"title":"T-SQL Unpivot with column values","body":"<p>I have a table like below:</p>\n\n<blockquote>\n  <h2>Check |  Bill Total  | D1 | D2 | D3 | D4 | D5 |</h2>\n\n<pre><code>1              100       10           2\n2               50       10                   5    7\n</code></pre>\n</blockquote>\n\n<p>D1 - D5 stands for different discount type, how can I get to the following?</p>\n\n<blockquote>\n  <h2>Check |  Bill Total  | Discount Type | Discount |</h2>\n\n<pre><code>1        100            D1             10\n1        100            D3              2\n2        100            D1             10\n2        100            D4              5\n2        100            D5              7\n</code></pre>\n</blockquote>\n\n<p>Many Thanks.</p>\n"},{"tags":["sql-server","sql-server-2005","tsql","truncate","foreign-keys"],"answer_count":13,"favorite_count":14,"up_vote_count":60,"down_vote_count":0,"view_count":77724,"score":60,"question_id":253849,"title":"Cannot truncate table because it is being referenced by a FOREIGN KEY constraint?","body":"<p>Using MSSQL2005, Can I truncate a table with a foreign key constraint if I first truncate the child table(the table with the primary key of the FK relationship)?</p>\n\n<p>I know I can use a DELETE without a where clause and then RESEED the identity OR</p>\n\n<p>Remove the FK, truncate and recreate but I thought as long as you truncate the child table you'll be OK however I'm getting a </p>\n\n<p>\"Cannot truncate table 'TableName' because it is being referenced by a FOREIGN KEY constraint.\"</p>\n\n<p>error.</p>\n"},{"tags":["sql-server","tsql","join"],"answer_count":9,"favorite_count":11,"up_vote_count":21,"down_vote_count":0,"view_count":28223,"score":21,"question_id":111341,"title":"Combine multiple results in a subquery into a single comma-separated value","body":"<p>I've got two tables:</p>\n\n<pre><code>TableA\n------\nID, Name\n\nTableB\n------\nID, SomeColumn, TableA_ID (FK for TableA)\n</code></pre>\n\n<p>The relationship is one row of <code>TableA</code> - many of <code>TableB</code>.</p>\n\n<p>Now, I want to see a result like this:</p>\n\n<pre><code>ID     Name      SomeColumn\n\n1.     ABC       X, Y, Z (these are three different rows)\n2.     MNO       R, S\n</code></pre>\n\n<p>This won't work (multiple results in a subquery):</p>\n\n<pre><code>SELECT ID, Name, (SELECT SomeColumn FROM TableB WHERE F_ID=TableA.ID) FROM TableA\n</code></pre>\n\n<p>This is a trivial problem if I do the processing on the client side. But this will mean I will have to run X queries on every page, where X is the number of results of <code>TableA</code>. </p>\n\n<p>Note that I can't simply do a GROUP BY or something similar, as it will return multiple results for rows of <code>TableA</code>. </p>\n\n<p>I'm not sure if a UDF, utilizing COALESCE or something similar might work?</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":45,"score":2,"question_id":12999172,"title":"TSQL select records without duplicates by last date","body":"<p>I have several tables:</p>\n\n<pre><code>1 table: Measure with column:[id], [idTEST], [Position], [idPARENT] ,[Pos_X],[Pos_Y],[Pos_Z], [Error_Comment], [Repair_Date]\n\n2 table: Test with coulmns: [idTEST], [idKARD], [Panel_Time],[idTFILE]\n\n3 table: Kard with columns: [idKARD], [Kard_Code], [idPANEL],[Kard_Nr]  \n4. table tstFile: [idTFILE],[Name],[Side],[Descr]\n5. table Parent: [idPARENT], [Parent] ,[idMODL]\n6. table Panel: idPANEL, PanelCode\n</code></pre>\n\n<p>I need select data from table Measure which will be:</p>\n\n<pre><code>1. with most old Repair_Date for each Kard_Code \n2. and with most recent Panel_Time for each card :\n</code></pre>\n\n<p>With columns like this: c.Kard_Code,m.Position,m.Pos_X, m.Pos_Y, m.Pos_Z,s.Name, pn.Parent, m.Repair_Date</p>\n\n<p>I've tried something like this:</p>\n\n<pre><code>SELECT c.KardCode,\n        m.Position,\n        m.Pos_X,\n        m.Pos_Y,\n        m.Pos_Z,\n        s.NAME,\n        pn.Parent,\n        max(m.Repair_Date) AS Repair_Date,\n        max(m.id),\n        PanelCode\nFROM dbo.measure m\nINNER JOIN dbo.TEST AS t\n        ON m.id_TEST = t.id_TEST\nINNER JOIN dbo.tstFILE AS s\n        ON t.idTFILE = s.idTFILE\nINNER JOIN dbo.KARD AS c\n        ON t.idKard = c.idKadr\nINNER JOIN dbo.PANELS AS p\n        ON c.id_PANELS = p.id_PANELS\nINNER JOIN dbo.PARENT AS pn\n        ON m.idPARENT = pn.idPARENT\nWHERE m.Repair_Date = (\n                SELECT DISTINCT min(Repair_Date)\n                FROM Measure AS m2\n                WHERE m2.idTEST = m.idTEST\n                )\n        AND (\n                t.Panel_Time IN (\n                        SELECT DISTINCT MAX(Panel_Time) AS Panel_Time\n                        FROM TEST\n                        GROUP BY id_CARDS\n                        )\n                )\nGROUP BY c.KardCode,\n        m.Position,\n        m.Pos_X,\n        m.Pos_Y,\n        m.Pos_Z,\n        s.NAME,\n        pn.Parent\nORDER BY m.idTEST,\n        c.KardCode\n</code></pre>\n\n<p>Results:\nI ended with duplicates IN Repair_Date where date was similiar E.G:</p>\n\n<pre><code>KardCode Position Pos_X Pos_Y Pos_Z Name Parent PanelCode Repair_Date              id\na        CX       0     0     0     Blue_Card   SKY       2012-10-03 00:06:41.000  1514\na        CY       0     0     0     Blue_Card   SKY       2012-10-03 00:06:41.000  1515\n...\n</code></pre>\n\n<p>How can i retrieve data without this duplicates ?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","transactions","rollback"],"answer_count":0,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":40,"score":2,"question_id":13246038,"title":"which is better approach for roll back transaction in sql server?","body":"<p>I came to know we can go for roll back transaction using \"<strong>set xact_abort on</strong>\"\ni want to know which is the better way for roll back transaction: use \"set xact_abort on\" or simple the following code</p>\n\n<pre><code>begin try\nbegin tran\n-- statements \ncommit tran\nend try\nbegin catch\nrollback tran\nend catch\n</code></pre>\n\n<p>Please help me to choose which is better approach while inserting number of records one time.</p>\n"},{"tags":["mysql","sql","tsql","group"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":51,"score":4,"question_id":13238464,"title":"Group data based on certain value","body":"<p>I have a table called x, the table has id column and repeat status column. The id can store same values even 6 of them while the repeat status increments each time an id is inserted 1,2...n. If a new different id is inserted the repeat status starts from 1 e.g</p>\n\n<pre><code> xid       repeat_status\nxx123           1\nxx123           1\nxx123           2\nxx123           3\nxx123           3 \nxxx45           1\nxxx45           2\nxxx45           2\n</code></pre>\n\n<p>How can i modify the query below to return something like this:</p>\n\n<pre><code> xid           repeat_status\nxx123             1\nxx123             2\nxx123             3\n\nxxx45             1\nxxx45             2\n\nSELECT xid\n      ,repeat_status \nFROM x \nGROUP BY repeat_status;\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":1048,"score":5,"question_id":3650690,"title":"SQL SERVER Foreign Keys and Indexes","body":"<p>Is it a good practice to create an index to every foreing key  in my database?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":13238726,"title":"Time Breaking in SQL Server","body":"<p>I have a fun challenge with some time data in my application. I have a table of start and end times; and need to subtract out shift times keeping the difference to get multiple rows. Im trying to do this on my SQL Server 2008 box at the moment.</p>\n\n<p>The idea is if i have a time row like</p>\n\n<pre><code>Start 09:00 End 19:12\n</code></pre>\n\n<p>And the shift says 09:00 -> 17:00 I need to split / break the data into two rows</p>\n\n<pre><code>Start 09:00 End 17:00\nStart 17:00 End 19:12\n</code></pre>\n\n<p>This needs to work over midnight too; created some scratch data as I have been playing around with some ideas but am wondering if there is a way out of case statement heck.</p>\n\n<pre><code>Create Table dbo.tblClockEvents\n(\nDayOfWeek Int,\nClockOn Time,\nClockOff Time\n)\n\nCreate Table dbo.tblShiftPattern\n(\nDayOfWeek Int,\nStartTime Time,\nEndTime Time\n)\n\ninsert into dbo.tblShiftPattern\nselect 1, '07:30', '17:00'\nunion select 2, '09:30', '18:00'\nunion select 3, '09:30', '18:00'\nunion select 4, '09:30', '18:00'\nunion select 5, '20:30', '04:00'\n\n\ninsert into dbo.tblClockEvents\nselect 1, '07:30', '17:00'\nunion select 2, '09:22', '18:14'\nunion select 3, '09:12', '18:01'\nunion select 4, '09:22', '18:14'\nunion select 5, '20:22', '04:14'\n\nSelect * \nfrom dbo.tblClockEvents aa\ninner join tblShiftPattern bb\non  aa.DayOfWeek = bb.DayOfWeek\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":52,"score":3,"question_id":13238866,"title":"Stored procedure containing inner join with count not working","body":"<p>Let's say i've got a databasetable looking a bit like this, containing information about some assignments.</p>\n\n<pre><code>Id   | ProfessionId      | Title       | Deadline     | DateCreated | ClosingDate\n1    |  5                | Something   | 01-12-2012   | 05-11-2012  | 12-11-2012\n2    |  6                | Something   | 01-12-2012   | 05-11-2012  | 12-11-2012\n3    |  7                | Something   | 01-12-2012   | 05-11-2012  | 12-11-2012\n4    |  7                | Something   | 01-12-2012   | 05-11-2012  | 12-11-2012\n</code></pre>\n\n<p>I want to generate an overview foreach profession (assignments belong to a certain profession) and count the number of assignment in each profession. The overview coming from the database should look like this;</p>\n\n<pre><code>Id | Name           | FriendlyUrl     | Ordinal   | NumberOfAssignments\n5  | Profession 1   | profession-1    | 1         | 1\n6  | Profession 2   | profession-2    | 1         | 1\n7  | Profession 3   | profession-3    | 1         | 2\n8  | Profession 4   | profession-4    | 1         | 0\n</code></pre>\n\n<p>I've currently got a stored procedure returning the overview above, except that the amount of assignments isn't correct. Assignments with a closingdate in the past (we then assume the assignment is closed) shouldn't be taken into the the total number of assignment.</p>\n\n<p>The current stored procedure is like this:</p>\n\n<pre><code>BEGIN\n    SELECT  p.Id, \n            p.Naam, \n            p.FriendlyUrl, \n            p.Ordinal, \n            COUNT(a.ProfessionId) AS NumberOfAssignments\n    FROM ME_Profession AS p \n    LEFT OUTER JOIN ME_Assignment AS a ON a.ProfessionId = p.Id\n    INNER JOIN ME_Client AS c ON a.ClientId = c.Id\n    INNER JOIN aspnet_Membership AS m ON m.UserId = c.UserId\n    WHERE m.IsApproved = 1 \n    GROUP BY p.Id, p.Naam, p.FriendlyUrl, p.Ordinal\nEND\n</code></pre>\n\n<p>I've already came up with and modified procedure like the one below, but it doesn't work. It feels like i'm either thinking too difficult or missing something obvious. What could go wrong?</p>\n\n<pre><code>SELECT        p.Id, p.Naam, p.FriendlyUrl, p.Ordinal, pc.NumberOfAssignments\nFROM            ME_Profession AS p \nINNER JOIN ME_Assignment AS a ON a.ProfessionId = p.Id \nINNER JOIN ME_Client AS c ON a.ClientId = c.Id\nINNER JOIN aspnet_Membership AS m ON m.UserId = c.UserId\nINNER JOIN (SELECT a2.ProfessionId, COUNT(*) AS NumberOfAssignments FROM ME_Assignment AS a2 GROUP BY a2.ProfessionId WHERE a2.Closingdate &gt; GETDATE()) pc ON p.ProfessionId = pc.ProfessionId\nWHERE        m.IsApproved = 1 AND a.Closingdate &gt; GETDATE()\nGROUP BY p.Id, p.Naam, p.FriendlyUrl, p.Ordinal\n</code></pre>\n\n<p><strong>UPDATE 1:</strong> Added where condition for date</p>\n"},{"tags":["sql-server","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":13234761,"title":"Multiple rows in one","body":"<p>I know there are similar questions like mine but unfortunately I haven't found the corresponding solution to my problem.</p>\n\n<p>First off here's a simplified overview of my tables:</p>\n\n<ul>\n<li><p><code>Partner</code> table: <code>PartnerID, Name</code></p></li>\n<li><p><code>Address</code> table: <code>PartnerID, Street, Postcode, City, ValidFrom</code></p></li>\n<li><p><code>Contact</code> table: <code>PartnerID, TypID, TelNr, Email, ValidFrom</code></p></li>\n</ul>\n\n<p>A partner can have one or more addresses as well as contact info. With the contact info a partner could have let's say 2 tel numbers, 1 mobile number and 1 email. In the table it would look like this:</p>\n\n<pre><code>PartnerID   TypID   TelNr                   Email               ValidFrom\n1           1       0041 / 044 - 2002020                        01.01.2010\n1           1       0041 / 044 - 2003030                        01.01.2011\n1           2       0041 / 079 - 7003030                        01.04.2011\n1           3                               myemail@hotmail.com 01.06.2011\n</code></pre>\n\n<p>What I need in the end is, combining all tables for each partner, is like this:</p>\n\n<pre><code>PartnerID   Name    Street              Postcode        City            TelNr                               Email\n1           SomeGuy MostActualStreet    MostActualPC    MostActualCity  MostActual Nr (either type 1 or 2)  MostActual Email\n</code></pre>\n\n<p>Any help?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":32,"score":2,"question_id":13238668,"title":"Select into a view","body":"<p>I have a simple CTE <code>x</code> and I wish to select its contents into a view.  Can you select into a view using the same type of syntax that you can for a table? i.e.</p>\n\n<pre><code>SELECT * \nINTO newTable\nFROM OldTable\n</code></pre>\n\n<p>Can new views be created dynamically like this?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":13237015,"title":"scope_identity returns null","body":"<p>I am writing a SP in SQL server</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[spAddUserBadge]\nAS\nBEGIN\nINSERT INTO dbo.SE_UserBadge\n(    \n[UID],\nBadgeID,\nBadgeAssignmentOrRenewalDate,\nBadgeExpiryDate ,\nAmountPaid, \nRemarks ,\nAssignedBy          \n)\nVALUES\n(\n17,1, 12-12-2012, 12-12-2013, 0.00, '', ''\n)\nSELECT SCOPE_IDENTITY() AS id    \nEND\nGO\n</code></pre>\n\n<p>SCOPE_IDENTITY is coming as NULL. where I am wrong?</p>\n"},{"tags":["sql-server","tsql","ado.net","triggers"],"answer_count":9,"favorite_count":4,"up_vote_count":2,"down_vote_count":0,"view_count":3983,"score":2,"question_id":1798156,"title":"How to keep an audit/history of changes to the table","body":"<p>I've been asked to create a simple DataGrid-style application to edit a single table of a database, and that's easy enough. But part of the request is to create an audit trail of changes made, who made them, and the date/time.</p>\n\n<p>How might you solve this kind of thing?</p>\n\n<p>(I'll be using C# in VS2008, ADO.NET connected to SQL Server 2005, WPF and Xceed's DataGrid, if it makes any difference.)</p>\n"},{"tags":["sql","tsql"],"answer_count":6,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":13640,"score":5,"question_id":808611,"title":"SQL Count for each date","body":"<p>I have the following need</p>\n\n<p>I have a logging table which logs som leads generated each day.</p>\n\n<p>Now I need to pull a report over the amount of leads for each day over the last 10 days.</p>\n\n<p>Lets say the table looks like this:</p>\n\n<pre><code>tbl_leads\nid int,\nfirst_name nvarchar(100),\nlast_name nvarchar(100),\ncreated_date datetime\n</code></pre>\n\n<p>And I need to count the number of leads for each day, 10 days total.\nSO the result set should look something like this:</p>\n\n<pre><code>counted_leads | count_date\n5             | 2009-04-30\n7             | 2009-04-29\n5             | 2009-04-28\n7             | 2009-04-27\n</code></pre>\n\n<p>... and so on</p>\n\n<p>Anyone know how to do this the best possible way?\nMy current solution is iterating with a foreach in c# but I would very much like to hand it on the sql server instead in a sp.</p>\n"},{"tags":["sql-server","query","tsql","insert"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":13235720,"title":"SQL Server append query","body":"<p>I have the following (not working) query:  </p>\n\n<pre><code>insert into [MyDB].[dbo].[Reports_StepsStat]  \n    (ActivityID,TaskID,StepIndex,StepStatus,TimeSpanInSeconds,Score)\nVALUES (\n  SELECT\n    tasks.ActivityID as ActivityID,\n    tasks.ID as TaskID,\n    [StepIndex]=item.value('(StepIndex)[1]', 'NVARCHAR(MAX)'),\n    [StepStatus]=item.value('(Status)[1]', 'NVARCHAR(MAX)'),\n    [TimeSpanInSeconds] = DATEDIFF(MINUTE, item.value('(StartedOn)[1]',    'datetime'),item.value('(FinishedOn)[1]', 'datetime')),\n    tasks.Score as Score\n  FROM \n    [MyDB].[dbo].[Tasks] as tasks \n  CROSS APPLY \n    [Progress].nodes ('//Progress/Steps/ProgressStep') Progress(item)\n)  \n</code></pre>\n\n<p>The inner select query (<code>SELECT task.ActivityID..</code>) works perfectly and produces the expected table.  </p>\n\n<p>The outer <code>insert into</code> part is supposed to append the result of the inner part to a table by the name of <code>Reports_StepsStat</code>. This does not work.  </p>\n\n<p>I have tried and succeeded doing that with <code>SELECT INTO</code>, but apparently <code>SELECT INTO</code> can only be used to create a new table, and not to append to an existing table, which is what I need.  </p>\n\n<p>The errors I get are:  </p>\n\n<blockquote>\n  <p><em>Msg 156, Level 15, State 1, Line 6</em><br>\n  <em>Incorrect syntax near the keyword 'SELECT'.</em><br>\n  <em>Msg 102, Level 15, State 1, Line 14</em><br>\n  <em>Incorrect syntax near ')'.</em></p>\n</blockquote>\n"},{"tags":["tsql","plsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13236231,"title":"Oracle to_char conversion causing hour offset?","body":"<p>I want to run this issue by those who know more about PL/SQL and T-SQL than I do. Below is some code that I inherited and it's returning dates that are 1 hour off. When I remove the \"to_char(i.UPDATE_DT, ''YYYY-MM-DD HH24:MI:SS.FF3'')\" in the select statement of the remote query the hour offset goes away. I'm worried about other impacts this change could have, so my question is why would someone convert an Oracle time to a string via an OpenQuery and then use T-SQL convert in the select statement? What am I missing here and why would the to_char cause an offset (if it is the reason)?</p>\n\n<pre><code>SELECT\n    CSE_ID                         AS ID,\n    OTHR_CSE_ID                   AS Case_Num,\n    convert(datetime,UPDATE_DT,121) AS Export_Time\nFROM\n    OpenQuery( OracleTbl, '\n    SELECT c.CSE_ID, r.OTHR_CSE_ID, to_char(i.UPDATE_DT,''YYYY-MM-DD HH24:MI:SS.FF3'') UPDATE_DT \n    FROM AE_CSES c\n    INNER JOIN CSES i ON i.CASE_ID = c.CSE_ID AND i.ACTION_CD = ''INS''\n    INNER JOIN OTH_CSE_REFS r ON r.CSE_ID = c.CSE_ID AND r.OTH_CS_REF_SEQ_NBR = 1 AND r.OTHER_SOURCE_TYPE = ''SIE''\n    ') AS i\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-ce"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":47,"score":-1,"question_id":13235429,"title":"Tsql subquery in where clause","body":"<p>I have an error message:</p>\n\n<blockquote>\n  <p>There was an error parsing the query. [ Token line number = 5,Token\n  line offset = 4,Token in error = select ]</p>\n</blockquote>\n\n<p>When I try to execute this query:</p>\n\n<pre><code>select ename, loc\nfrom emp e join dept on (e.deptno = dept.deptno)    \nwhere\n    e.sal &gt;\n        (select avg(sal)\n        from emp\n        group by job\n        having job = e.job);\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":46,"score":3,"question_id":13235048,"title":"Multiple Rows in INSERTED table","body":"<p>On a table in MS SQL Server I need to run a CLR Stored Procedure on new rows if those rows meet certain criteria.  I thought that would be more or less straightforward:</p>\n\n<pre><code>if ((SELECT Cabinet FROM INSERTED) = 1 OR (SELECT Cabinet FROM INSERTED) = 3) AND (SELECT Result_02 FROM INSERTED) = 'N'\nBEGIN\n    DECLARE @id int\n    SET @id = (SELECT ID FROM INSERTED)\n    exec PrintLabel\n        @id,\n        N'LP 2844 LGE'\nEND;\n</code></pre>\n\n<p>However, this recently started throwing errors about a subquery returning multiple rows. I learned that INSERT triggers run once for each statement, not necessarily on individual rows. So, that IF statement can be working on multiple rows, and thus the error.</p>\n\n<p>My question is: how can I iterate over each new row if the rows are added in a batch (in this case via a MERGE statement). </p>\n"},{"tags":["sql","xml","sql-server-2008","tsql","xquery"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":13234175,"title":"Use of xml.modify to insert parameters into specific element of an xml column","body":"<p>I would like to use a stored procedure to insert some values passed in as parameters into elements in the xml of a column. I have this so far\nThe following parameters:</p>\n\n<pre><code>@profile_id int,\n@user_id nvarchar(50),\n@activity_name nvarchar(50),\n@display_name nvarchar(50)\n</code></pre>\n\n<p>Retrieve the desired xml:</p>\n\n<pre><code>DECLARE @profiles_xml xml\nSET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE profiles.value('(Profile/ID)[1]','int')= @profile_id)\n</code></pre>\n\n<p>The xml from the column inside the @profiles_xml looks like this:</p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;20&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;somename&lt;/Name&gt;\n    &lt;Activities&gt;\n      &lt;Activity&gt;\n         &lt;Name&gt;activity1&lt;/Name&gt;\n      &lt;/Activity&gt;\n    &lt;/Activities&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n\n<p>Attempt to Insert into User with specific ID the activity name and display name:</p>\n\n<pre><code>SET @profiles_xml.modify('\n    insert\n    if(/Profile/User/ID=sql:variable(\"@user_id\"))\n    then Activity[Name=sql:variable(\"@activity_name\")][DisplayName=sql:variable(\"@display_name\")]\n    else()\n    as first\n    into (/Profile/User/Activities)[1]')\n</code></pre>\n\n<p>I have also tried this with no success:</p>\n\n<pre><code> SET @devices_xml.modify('\n    insert /Profile/User[ID=sql:variable(\"@user_id\")]/Activity[Name=sql:variable(\"@activity_name\")][DisplayName=sql:variable(\"@display_name\")]\n    into (/Profile/User/Activities)[1]')\n</code></pre>\n\n<p>And this:</p>\n\n<pre><code> SET @devices_xml.modify('\ninsert\n /Profile/User[ID=sql:variable(\"@user_id\")]/Activities/Activity[Name=sql:variable(\"@activity_name\")][DisplayName=sql:variable(\"@display_name\")]\n    into (/Profile/User/Activities)[1]')\n</code></pre>\n\n<p>What is the correct way to do this?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13234465,"title":"Multiple variables assignment using SET and SELECT","body":"<p>I use the following t-sql code for assign to variable a value obtained from select statement</p>\n\n<pre><code> DECLARE @cfMitt nvarchar(16)\n\n SET @cfMitt = (SELECT CfMittente\n    FROM Messaggi\n    WHERE IDMessaggio = @IDMessaggio)\n</code></pre>\n\n<p>If I want use multiple assignement I try with the following  code, but something is wrong:</p>\n\n<pre><code>DECLARE @cfMitt nvarchar(16)\nDECLARE @cfDest nvarchar(16)\n\nSET @cfMitt, @cfDest= (SELECT CfMittente, CfDestinatario\nFROM Messaggi\nWHERE IDMessaggio = @IDMessaggio)\n</code></pre>\n\n<p>Where is the error?</p>\n"},{"tags":["sql","xml","sql-server-2008","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13233034,"title":"Use of logical and for an xquery delete in tsql","body":"<p>Is it possible to use a logical and operator with an xquery statement inside a stored procedure to delete an element only if its parent element has a specific value AND it has a specific value? Such as:</p>\n\n<pre><code>SET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE profiles.value('(Profile/ID)[1]','int')= @profile_id)\n    SET @profiles_xml.modify('\n    delete\n    if(/Profile/User/ID=sql:variable(\"@user_id\")) and (/Profile/User/Activities/Activity/Name = sql:variable(\"@activity_name\"))\n    then (/Profile/User/Activities/Activity)\n    else()\n    ')\n</code></pre>\n\n<p>I would like to delete the Activity only if the User ID element and Activity Name element match the given parameters.\nThe xml in profiles_xml looks like this:</p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;20&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;somename&lt;/Name&gt;\n    &lt;Activities&gt;\n      &lt;Activity&gt;\n         &lt;Name&gt;activity1&lt;/Name&gt;\n      &lt;/Activity&gt;\n    &lt;/Activities&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n\n<p>But in the future there will potentially be multiple  elements in each  and Multiple  elements as children of the  element.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13232583,"title":"Scripting for SQL Server 2005","body":"<p>This script works only in 2008 version:</p>\n\n<pre><code>declare @tab table(\nid_emp int,\nFIL_ROT_WID xml\n)\n\ninsert into @tab\nselect 0, '&lt;xml&gt;&lt;/xml&gt;'\n\ndeclare @xml_rot_widget xml\nset @xml_rot_widget = '&lt;ati id=\"1123\" val=\"new()\" /&gt;'\n\nupdate @tab\nset FIL_ROT_WID.modify('insert sql:variable(\"@xml_rot_widget\")\n                    as last\n                    into (/xml)[1]')\nwhere id_emp = 0\n\nselect * from @tab\n</code></pre>\n\n<p>In 2005 I receive the follow error:</p>\n\n<pre><code>XQuery: SQL type 'xml' is not supported in XQuery.\n</code></pre>\n\n<p>So, my question is:\nHow can I write code on 2008 (SQL Server Management Studio) that I will be sure that will works fine on 2005?</p>\n\n<p>Ps.: ** Tools > Options > SQL Server Object Explorer > Scripting > Script for server version** does not work.</p>\n\n<p>Tks</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":4,"up_vote_count":6,"down_vote_count":0,"view_count":94,"score":6,"question_id":13229946,"title":"Difference between Tables and Temp Tables","body":"<p>why this code work without problem :</p>\n\n<pre><code>drop table t1 \nselect * into t1 from  master..spt_values\ndrop table t1 \nselect * into t1 from  master..spt_values\n</code></pre>\n\n<p>Output </p>\n\n<pre><code>Msg 3701, Level 11, State 5, Line 1\nCannot drop the table 't1', because it does not exist or you do not have permission.\n\n(2508 row(s) affected)\n\n(2508 row(s) affected)\n</code></pre>\n\n<p>but this code does not :</p>\n\n<pre><code>drop table #t1 \nselect * into #t1 from  master..spt_values\ndrop table #t1 \nselect * into #t1 from  master..spt_values\n</code></pre>\n\n<p>Output</p>\n\n<pre><code>Msg 2714, Level 16, State 1, Line 4\nThere is already an object named '#t1' in the database.\n</code></pre>\n\n<p>what is the difference between Tables and Temp Tables in this code ?</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":27,"score":0,"question_id":13230372,"title":"Order By alphanumeric values like numeric","body":"<p>there is a table's fields on MSSQL Serrver 2005 as VARCHAR. It contains alphanumeric values like \"A,B,C,D ... 1,2,3,...,10,11,12\" etc.</p>\n\n<p>When i use below codes;</p>\n\n<pre><code>....   \nORDER BY TableFiledName\n</code></pre>\n\n<p><strong>Ordering result is as follow</strong> 11,12,1,2,3 etc.</p>\n\n<p>When i use codes as below,</p>\n\n<pre><code>....   \n ORDER BY\n    CASE WHEN ISNUMERIC(TableFiledName) = 0 THEN CAST(TableFiledNameAS INT) ELSE TableFiledName END\n</code></pre>\n\n<p>I get error message as below;</p>\n\n<blockquote>\n  <p>Msg 8114, Level 16, State 5, Line 1 Error converting data type varchar\n  to float.</p>\n</blockquote>\n\n<p><strong>How can get like this ordering result:</strong> 1,2,3,4,5,6,7,8,9,10,11,12 etc..</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":13745,"score":6,"question_id":1586560,"title":"How do I escape a single quote in sqlserver?","body":"<p>I'm trying to insert some text data into a table in SQLServer 9.\nThe text includes a single quote.\nHow do I escape that?\nI tried using two single quotes, but it threw me some errors.\neg. insert into my_table values('hi, my name''s tim.');</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":13229241,"title":"How to create procedure with the same WHERE column","body":"<p>How can I create one procedure and the <code>WHERE</code> column is the same?</p>\n\n<p>The <code>WHERE</code> column is <code>QuotationNo</code></p>\n\n<p>This is the procedure signature:</p>\n\n<pre><code>create procedure (QUO1 int, QUO2 int, QUO3 int, QUO4 int)\n</code></pre>\n\n<p>Output:</p>\n\n<pre><code>Quote     price     quantity\n---------------------------------\n1234       2000        1000\n5678       2500        4000\n9012        3000        4500 \n3456        1000        1000\n</code></pre>\n\n<p>Thanks,</p>\n\n<p>Captain16</p>\n"},{"tags":["tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":65,"score":1,"question_id":12805893,"title":"TSQL: Possible to reference different database, depending on the environment?","body":"<p>So we have the situation where we have two different databases and stored procedures need to reference the other database to get information.  We will typically write the query to look like this</p>\n\n<pre><code>select * from Mercury.dbo.MyTable a join Purchasing.dbo.OtherTable b on a.a = b.a\n</code></pre>\n\n<p>Which works fine for us in Production and our Development environment, but recently we split development into Dev/QA/ST and we have different versions of the databases to match the environments.  </p>\n\n<pre><code>Example\nPurchasing, PurchasingQA, PurchasingST\nMercury, MercuryQA, MercuryST\n</code></pre>\n\n<p>So now we are running into issues when we promote code because the stored procs in QA will reference a database for dev..</p>\n\n<p>So my question is how can I change the database that is being accessed based on an environment variable?  I have started using DynSQL for this, but this leads to a lot of more difficult to maintain code.  </p>\n\n<p>Perhaps is there a way to create a \"DB Alias\" that is database wide?</p>\n"},{"tags":["asp.net","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":13223599,"title":"Insert multiple rows into SQL Server based on start and end dates","body":"<p>I need to insert several rows into a SQL Server database based on <code>Start Date</code> and <code>End Date</code> textboxes. </p>\n\n<p>E.G. <code>tbStartDate.Text = \"25/12/2012\"</code> and <code>tbEndDate.Text = \"29/12/2012\"</code> therefore I need to insert individual rows for the following dates:</p>\n\n<pre><code>25/12/2012\n26/12/2012\n27/12/2012\n28/12/2012\n29/12/2012\n</code></pre>\n\n<p>Please can you help me with the necessary T-SQL to achieve this?</p>\n"},{"tags":["sql","xml","sql-server-2008","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":20,"score":1,"question_id":13225619,"title":"Error when using modify and insert on XML data retreived from table: Must be single node","body":"<p>I am attempting to insert into some xml I am retreiving from a column in a table. I retrieve it as follows:</p>\n\n<pre><code>DECLARE @profiles_xml xml\nDECLARE @profile_id int\nSET @profile_id = 16\nSET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE\nprofiles.value('(Profile/ID)[1]','int')= @profile_id)\n</code></pre>\n\n<p>The resulting xml looks like this:</p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;16&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;test&lt;/Name&gt;\n    &lt;Activities /&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n\n<p>However when I try and insert an element into it like this:</p>\n\n<pre><code>SET @devices_xml.modify('insert &lt;Activity&gt;&lt;Name&gt;testname&lt;/Name&gt;&lt;/Activity&gt;\n as first into (Profiles/User/Activities[1])')\n</code></pre>\n\n<p>I get the following error:</p>\n\n<pre><code>XQuery [modify()]: The target of 'insert' must be a single node, found 'element(Activities,xdt:untyped) *'\n</code></pre>\n\n<p>I don't understand why there is an error, as there is only one Activities element currently. Thanks in advance.</p>\n"},{"tags":["sql","xml","sql-server-2008","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":13226336,"title":"Use varchar stored procedure parameter in If condition of xquery insert","body":"<p>Is it possible to use a nvarchar type sproc variable in an xquery insert statement within the stored procedure?\nWhat I mean is something like this, in which an element is inserted only if a child element with the sought for value is present:</p>\n\n<pre><code>DECLARE @profiles_xml xml\nDECLARE @profile_id int\nDECLARE @user_id nvarchar(50)\nSET @profile_id = 20\nSET @user_id ='BC4A18CA-AFB5-4268-BDA9-C990DAFE7783'\nSET @profiles_xml = (SELECT profiles from tbl_applied_profiles WHERE profiles.value('(Profile/ID)[1]','int')= @profile_id)\nSET @profiles_xml.modify('\ninsert\nif(/Profile/User/ID=\"user_id\")\nthen &lt;Activity&gt;activity_name5&lt;/Activity&gt;\nelse()\nas first\ninto (/Profile/User/Activities)[1]')\n</code></pre>\n\n<p>The xml which @profiles_xml contains looks like this:</p>\n\n<pre><code>&lt;Profile&gt;\n  &lt;ID&gt;20&lt;/ID&gt;\n  &lt;User&gt;\n    &lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;\n    &lt;Name&gt;somename&lt;/Name&gt;\n    &lt;Activities&gt;\n      &lt;Activity&gt;activity_name2&lt;/Activity&gt;\n    &lt;/Activities&gt;\n  &lt;/User&gt;\n&lt;/Profile&gt;\n</code></pre>\n"},{"tags":["sql","xml","sql-server-2008","tsql","insert"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":13223781,"title":"XML parsing error: 'A string literal was expected' when inserting values into table","body":"<p>In Microsoft SQL Server 2008 I am attempting to insert values into an sql table with the columns <strong>type_id of datatype int</strong> and <strong>xml_info of datatype XML</strong>. I am using the following query:</p>\n\n<pre><code>INSERT INTO tbl_applied_devices ([type_id],[xml_info])\nVALUES (1,'&lt;Profile ID=99&gt;&lt;Server&gt;&lt;ID&gt;BC4A18CA-AFB5-4268-BDA9-C990DAFE7783&lt;/ID&gt;  &lt;Name&gt;localhost&lt;/Name&gt;&lt;Services&gt;&lt;/Services&gt;&lt;/Server&gt;&lt;/Profile&gt;')\n</code></pre>\n\n<p>But I keep getting this error:</p>\n\n<blockquote>\n  <p>Msg 9413, Level 16, State 1, Line 4<br>\n  XML parsing: line 1, character 13, A string literal was expected  </p>\n</blockquote>\n\n<p>What am I doing incorrectly?</p>\n\n<p><strong>EDIT:</strong>\nI found that the source of the error is the xml element's ID attribute, <code>&lt;Profile ID=99&gt;</code> seems to be what is causing the error. How can I correctly insert xml with an attribute ? Do I need to somehow escape one of the characters?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":1402,"score":3,"question_id":6134016,"title":"How to escape back slash in SQL server","body":"<pre><code>DECLARE @Query nvarchar(max)\nSET @Query ='DECLARE @Test nvarchar(max)\nSELECT @Test = ''\\a'\\b'\\c''\nSELECT @Test\nPRINT @Query\nexec sp_executesql @Query\n</code></pre>\n\n<p>I am trying to get an output as \\a\\b\\c. The above error is probably because I am not able to escape the \\ character.</p>\n"},{"tags":["sql","vb.net","tsql","ado.net","oledb"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":2997,"score":0,"question_id":6414032,"title":"VB.NET Using a SELECT statement to return a row where a DateTime column = variable of type Date?","body":"<p>I am using OleDb, trying to do this:</p>\n\n<pre><code>Dim d as Date = DateSerial(Year(rptDate), Month(rptDate), 1 - 1)\n\nDim conn as OleDbConnection = new OleDbConnection(connStr)\nDim cm as OleDbCommand = new OleDbCommand()\n\nconn.Open()\ncm.Connection = conn\ncm.CommandText = \"SELECT * FROM history WHERE ReportDate = \" &amp; d\n</code></pre>\n\n<p>Okay, so I know it returns 1 row because I'm staring at it in SQL Server. Here is what I've tried so far for the query in the last line, none work:</p>\n\n<pre><code>\"SELECT * FROM history WHERE ReportDate = \" &amp; d\n\"SELECT * FROM history WHERE ReportDate = \" &amp; d.toString(\"G\")\n\"SELECT * FROM history WHERE ReportDate = '\" &amp; d &amp; \"'\"\n\"SELECT * FROM history WHERE ReportDate = '\" &amp; d.toString(\"G\") &amp; \"'\"\n\"SELECT * FROM history WHERE ReportDate = '#\" &amp; d &amp; \"#'\"\n\"SELECT * FROM history WHERE ReportDate = #\" &amp; d &amp; \"#\" 'These last 2 with toString\n</code></pre>\n\n<p>I have also tried:</p>\n\n<pre><code>cm.CommandText = \"SELECT * FROM history WHERE ReportDate = ?\"\ncm.Parameters.Add(d)\n\ncm.CommandText = \"SELECT * FROM history WHERE ReportDate = ?\"\ncm.Parameters.Add(d.toString(\"G\"))\n\ncm.CommandText = \"SELECT * FROM history WHERE ReportDate = '?'\"\ncm.Parameters.Add(d.toString(\"G\"))\n\ncm.CommandText = \"SELECT * FROM history WHERE ReportDate = '?'\"\ncm.Parameters.Add(d)\n</code></pre>\n\n<p>Clearly I am missing something here, help? I know that <code>d</code> is the same date as the one in SQL server, specifically <code>3/31/2011 12:00:00 AM</code>.</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql","sql-server","tsql","adventureworks"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":67,"score":3,"question_id":13220573,"title":"Adventure Works Explanation","body":"<p>I've been looking at Microsoft's Adventure Works 2012 database. I'd be very interested if there's any information explaining why the tables were created as they are. Some sort of schema overview I guess.</p>\n\n<p>For example: </p>\n\n<p>Why they chose to create a <code>BusinessEntity</code> table as a sort of base class for Person, Employee, etc.</p>\n\n<p>Most of the data is normalized so why they chose to put the <code>CountryRegionCode</code> field into the <code>StateProvince</code> table instead of an ID to a separate table.</p>\n\n<p>Anyway I'm very interested in learning more about the decisions that went into the databases design. Anyone know a resource that goes into this sort of thing?</p>\n"},{"tags":["sql-server","tsql","select"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":24,"score":1,"question_id":13218684,"title":"T-SQL replace value on select","body":"<p>I have a column (<code>SERVICE_ID</code>) in my table where I can have only 3 values: 0, 1 and 2. </p>\n\n<p>On a <code>SELECT</code>, I'd like to change those values into English words for display:</p>\n\n<pre><code>select client, SERVICE_ID\nfrom customers\n</code></pre>\n\n<p>Currently displays:</p>\n\n<pre><code>| John     | 1\n| Mike     | 0\n| Jordan   | 1\n| Oren     | 2\n</code></pre>\n\n<p>I'd like to change the query to get:</p>\n\n<pre><code>| John     | QA\n| Mike     | development\n| Jordan   | QA\n| Oren     | management\n</code></pre>\n\n<p>There is any way to do this using only the select?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":66,"score":1,"question_id":13218892,"title":"SQL Server: +(unary) operator on non-numeric Strings","body":"<p>I am surprised! This statement below is valid in <code>SQL SERVER</code>:</p>\n\n<pre><code>SELECT  +'ABCDEF'\n</code></pre>\n\n<p>Has <code>SQL Server</code> defined <code>+</code> as a <code>Unary</code> operator for string types?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","full-text-search"],"answer_count":4,"favorite_count":3,"up_vote_count":10,"down_vote_count":0,"view_count":9953,"score":10,"question_id":6003240,"title":"Cannot use a CONTAINS or FREETEXT predicate on table or indexed view because it is not full-text indexed","body":"<p>I am getting following error in my SQL server 2008 R2 database:</p>\n\n<blockquote>\n  <p>Cannot use a <code>CONTAINS</code> or <code>FREETEXT</code> predicate on table or indexed view 'tblArmy' because it is not full-text indexed.</p>\n</blockquote>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":51,"score":1,"question_id":13192145,"title":"SQL return both table rows separately","body":"<p>I have two tables and want to return both table's rows. Both tables do not have any relation.</p>\n\n<p><code>Table 1</code> has columns <code>userid, name</code>, and other columns... and <code>Table 2</code> has only two columns <code>id, name</code>.</p>\n\n<p>I want both table results in one query result set.</p>\n\n<p>Table results:</p>\n\n<pre><code>userid name and other columns from Table 1.\nid     name and NULL, NULL should show as Table 2 do not have extra columns.\n</code></pre>\n"},{"tags":["sql-server","tsql","case"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":13213055,"title":"Altering a CASE statement to handle NULL values?","body":"<p>I'm in need of help modifying an existing case statement that has to be changed to accommodate the possibility of a null value.</p>\n\n<p>Currently, the statement is as follows:</p>\n\n<pre><code>CASE WHEN \n  DATEDIFF(dd, table.OpenDate, GetDate()) - table.Days_as_Integer) &gt; 0 THEN \n   DATEDIFF(dd, table.OpenDate, GetDate()) - table.Days_as_Integer \n  ELSE NULL END \nAS Days_Past_Due\n</code></pre>\n\n<p>I just want to change the existing CASE statement to be able to handle a null table.OpenDate field, returning a NULL as Days_Past_Due. Is there an easy way to do this?</p>\n\n<p>Thanks!!!</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13213691,"title":"Noob Concern: Sub-query calculations","body":"<p>I've got a table <strong>bbc</strong> with the following columns:</p>\n\n<p><strong>name</strong> (refers to a name of a country within a particular region of the world)</p>\n\n<p><strong>region</strong> (continent of the world)</p>\n\n<p><strong>population</strong> (population of the country in the name name field)\nThe question I'm trying to answer:</p>\n\n<p>The <strong>question</strong> is as follows:<br>\n\"Some countries have populations more than three times that of any of their neighbours (in the same region). Give the countries and regions.\"</p>\n\n<p>I was thinking the answer might be something like:</p>\n\n<pre><code>SELECT a.name, a.region FROM bbc AS a\nWHERE a.region IN\n     (\n        SELECT b.region FROM bbc AS b \n        GROUP By b.region \n        HAVING MIN(b.population) &lt; 3*b.population)\n</code></pre>\n\n<p>But honestly, I lose it at that last line... I have no idea how I would find counteries that have more than three times that of any of their neighbours in the same region!  Quite tough.  O_o  </p>\n\n<p>Any and all help would be appreciated.  </p>\n"},{"tags":["sql","sql-server","tsql","pivot","pivot-without-aggregate"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":13212883,"title":"How can I PIVOT this data?","body":"<p>First, sorry for the middling title.  Didn't have a ton of success on that front.</p>\n\n<p>So - I have a table of data that has one row for each volunteer shift a person is scheduled for.  Many people, being generous with their time, have signed up for multiple shifts.  What I would like is to PIVOT this data s.t. I end up with one row per <em>person</em>, with sets of columns for each shift.  I've spent about 90 minutes on this so far, but can't figure out how to PIVOT without an aggregation function applied.</p>\n\n<p>What I mean by this is that each person is scheduled for at least one shift, so each person's row would have their unique ID, their name, their phone number, and their region.  Then there would be a set of columns for Shift1 - role/status/start time/end time/etc. - which everyone would have filled out since everyone has signed up for at least one shift.  Then, the Shift2 set of columns would be populated for people who have signed up for 2+ shifts, Shift3 for people who signed up for 3+ shifts, etc.</p>\n\n<p>My current table schema:</p>\n\n<pre><code>CREATE TABLE [dbo].[confirmexport](\n    [PersonID] [int] NULL,\n    [EventType] [varchar](14) NULL,\n    [Shift] [varchar](10) NULL,\n    [StartDate] [datetime] NULL,\n    [StartTime] [datetime] NULL,\n    [EndDate] [datetime] NULL,\n    [EndTime] [datetime] NULL,\n    [Location] [varchar](39) NULL,\n    [Role] [varchar](16) NULL,\n    [Status] [varchar](9) NULL,\n    [FirstName] [varchar](20) NULL,\n    [LastName] [varchar](22) NULL,\n    [Phone] [bigint] NULL,\n    [Region] [varchar](9) NULL\n) ON [PRIMARY]\n</code></pre>\n\n<p>All columns but <code>PersonID</code>, <code>FirstName</code>, <code>LastName</code>, <code>Phone</code>, and <code>Region</code> are shift-specific.</p>\n\n<p>In an ideal world, I'd end up with a table that looked something like so:</p>\n\n<pre><code>CREATE TABLE [dbo].[confirmexportpivoted](\n    [PersonID] [int] NULL,\n    [Phone] [bigint] NULL,\n    [FirstName] [varchar](20) NULL,\n    [LastName] [varchar](22) NULL,\n    [Region] [varchar](9) NULL,\n    [EventType1] [varchar](14) NULL,\n    [Shift1] [varchar](10) NULL,\n    [StartDate1] [datetime] NULL,\n    [StartTime1] [datetime] NULL,\n    [EndDate1] [datetime] NULL,\n    [EndTime1] [datetime] NULL,\n    [Location1] [varchar](39) NULL,\n    [Role1] [varchar](16) NULL,\n    [Status1] [varchar](9) NULL,\n    [EventType2] [varchar](14) NULL,\n    [Shift2] [varchar](10) NULL,\n    [StartDate2] [datetime] NULL,\n    [StartTime2] [datetime] NULL,\n    [EndDate2] [datetime] NULL,\n    [EndTime2] [datetime] NULL,\n    [Location2] [varchar](39) NULL,\n    [Role2] [varchar](16) NULL,\n    [Status2] [varchar](9) NULL\n) ON [PRIMARY]\n</code></pre>\n\n<p>Except with as many sets of columns as necessary for my data.  OR - if that's a deal-breaker, I can definitely make do with 3.  Any suggestions?</p>\n\n<p>Thanks in advance - I am super-confused and would appreciate any and all help.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":13213277,"title":"Noob Concern: T-SQL sub-queries","body":"<p>I've got a table <code>bbc</code> with the following columns:</p>\n\n<ul>\n<li><code>name</code> (refers to a name of a country within a particular region of the world)  </li>\n<li><code>region</code> (continent of the world)  </li>\n<li><code>population</code> (population of the country in the name name field)  </li>\n</ul>\n\n<p>The question I'm trying to answer:  </p>\n\n<p><em>Find each country that belongs to a region where all populations are less than 250000000.  Show name, region and population.</em></p>\n\n<p>I was thinking the answer might be something like:  </p>\n\n<pre><code>SELECT name, region, population \nFROM bbc \nGROUP by region \nHAVING MAX(population) &lt; 250000000 \n</code></pre>\n\n<p>I get the feeling I am way off course with this answer... any help would be appreciated!  </p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":313,"score":3,"question_id":3872173,"title":"Compare when value could be both NULL or text","body":"<p>Now I know you can't directly compare NULL to anything (as null is unknown) so how would I achieve the following:</p>\n\n<pre><code>select  *\n    from    Material as m\n    where   MtrlCode = 826 and\n            Exposlimit &lt;&gt; 'compareMe'\n</code></pre>\n\n<p>Where Exposlimit MAY be NULL or it may not be.\n'compareMe' may also be NULL.</p>\n\n<p>Therefore how do I compare the two?  Both sides could be either text or NULL.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":13211268,"title":"returning total records in cte","body":"<p>With help from <a href=\"http://pratchev.blogspot.com/2008/11/paging-with-ranking-functions.html?m=1\" rel=\"nofollow\">article here</a> and recent answers from SO experts I have arrived with the following which will help me efficiently page through a set of records.</p>\n\n<p>I think my last couple of questions are </p>\n\n<ol>\n<li>See how I include the <code>Total Number of Records</code> in the payload at the end\nof SQL CTE called 'Total'. Is that how you would do this? </li>\n<li>Any other suggestions? Potential areas for being more concise or improvements? <code>Return Total Number of Pages</code></li>\n</ol>\n\n<hr>\n\n<pre><code>DECLARE @page_size INT = 5;\nDECLARE @page_nbr INT = 4;\nDECLARE @search NVARCHAR(MAX) = '';\nDECLARE @sort_order INT = 2;\n\nWITH AllProducts\nAS\n(\nSELECT *, \nCASE @sort_order\n    WHEN 1 THEN ROW_NUMBER() OVER ( ORDER BY ProductID )\n    WHEN 2 THEN ROW_NUMBER() OVER ( ORDER BY ProductName )\nEND AS 'Seq'    \nFROM Products\n),\nFiltered\nAS\n(\nSELECT * FROM AllProducts\nWHERE ProductName like '%'+@search+'%'\nOR\n@search is null\n)\nSELECT (select COUNT(*) from Filtered) as 'Total', * FROM Filtered\nWHERE seq &gt; (@page_nbr - 1) * @page_size\n  AND seq &lt;= @page_nbr * @page_size\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":3803,"score":3,"question_id":1344401,"title":"How can I drop all indexes in a SQL database with one command?","body":"<p>So, how can I drop all indexes in a SQL database with one command?   I have this command that will get me all the 20 or so drop statements, but how can I run all of those drop statements from this \"result set\"?</p>\n\n<pre><code>select * from vw_drop_idnex;\n</code></pre>\n\n<p>Another variation that gives me the same list is:</p>\n\n<pre><code>SELECT  'DROP INDEX ' + ix.Name + ' ON ' + OBJECT_NAME(ID)  AS QUERYLIST\nFROM  sysindexes ix\nWHERE   ix.Name IS NOT null and ix.Name like '%pre_%'\n</code></pre>\n\n<p>I tried to do \"exec(select cmd from vw_drop_idnex)\" and it didn't work.  I am looking for something that works like a for loop and runs the queries one by one.</p>\n\n<h2>-----------------------</h2>\n\n<p>With Rob Farleys help, final draft of the script is:</p>\n\n<pre><code>declare @ltr nvarchar(1024);\nSELECT @ltr = ( select 'alter table '+o.name+' drop constraint '+i.name+';'\n  from sys.indexes i join sys.objects o on  i.object_id=o.object_id\n  where o.type&lt;&gt;'S' and is_primary_key=1\n  FOR xml path('') );\nexec sp_executesql @ltr;\n\ndeclare @qry nvarchar(1024);\nselect @qry = (select 'drop index '+o.name+'.'+i.name+';'\n  from sys.indexes i join sys.objects o on  i.object_id=o.object_id\n  where o.type&lt;&gt;'S' and is_primary_key&lt;&gt;1 and index_id&gt;0\nfor xml path(''));\nexec sp_executesql @qry\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":18,"score":1,"question_id":13210915,"title":"dynamic order by conversion error","body":"<p>I'm trying to do a dynamic order by on pubs database and getting the following error\nwhen I try to use <code>@sort_order = 2</code></p>\n\n<p>Msg 245, Level 16, State 1, Line 6\nConversion failed when converting the nvarchar value 'Pavlova' to data type int.</p>\n\n<p><a href=\"http://www.sqlteam.com/article/dynamic-order-by\" rel=\"nofollow\">This is the article</a></p>\n\n<pre><code>SELECT * FROM Paging\nWHERE seq &gt; (@page_nbr - 1) * @page_size\n  AND seq &lt;= @page_nbr * @page_size\nORDER BY CASE\n    WHEN @sort_order = 1 THEN ProductID\n    WHEN @sort_order = 2 THEN ProductName\n    ELSE CategoryID\nEND\n</code></pre>\n"},{"tags":["query","tsql","join","insert-update"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":13195855,"title":"T-SQL Need assistance with complex join","body":"<p>I am really out of ideas of how to solve this issue and need some assistance - not only solution but idea of how to approach will be welcomed. </p>\n\n<p>I have the following table:</p>\n\n<pre><code>TABLE Data\n( \n     RecordID\n    ,DateAdd\n    ,Status\n)\n</code></pre>\n\n<p>with sample date like this:</p>\n\n<pre><code>11  2012-10-01 OK\n11  2012-10-04 NO\n11  2012-11-05 NO\n22  2012-10-01 OK\n33  2012-11-01 NO\n33  2012-11-15 OK\n</code></pre>\n\n<p>And this table with the following example data:</p>\n\n<pre><code>TABLE Periods\n(\n    PeriodID\n   ,PeriodName\n   ,DateStart\n   ,DateEnd\n)\n\n1 Octomer  2012-10-01 2012-10-31\n2 November 2012-11-01 2012-11-30\n</code></pre>\n\n<p>What I need to do, is to populate a new table:</p>\n\n<pre><code>TABLE DataPerPeriods\n(\n    PeriodID,\n    RecordID,\n    Status\n)\n</code></pre>\n\n<p>That will store all possible combinations of PeriodID and RecordID and the latest status for period if available. If status is not available for give period, then the status for previous periods. If there are no previous status at all - then NULL for status.</p>\n\n<p>For example with the following data I need something like this:</p>\n\n<pre><code>1 11 NO //We have status \"OK\" and \"NO\", but \"NO\" is latest for the period\n1 22 OK \n1 33 NULL//Because there are no records for this and previous periods\n2 11 NO //We get the previos status as there are no records in this periods\n2 22 OK //There are not records for this period, but record for last periods is available\n2 33 NO //We have status \"OK\" and \"NO\", but \"OK\" is latest for the period\n</code></pre>\n\n<p>EDIT: I have already populate the period ids and the records ids in the last table, I need more help on the status update.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13209121,"title":"match if column is part of a value in Where clause","body":"<p>I have a question:</p>\n\n<p>I am trying to match a value (url) against a value in dbtable, column UrlPart.</p>\n\n<p>Let's say a column UrlPart in a row has the value 'id=12345'.</p>\n\n<p>Now I have a query:</p>\n\n<pre><code>select * from products\nwhere UrlPart [is part of] \n'http://www.domain.com/category/?id=12345&amp;referrer=www.google.com&amp;etcetera' \n</code></pre>\n\n<p>I would like to see the match [id=12345 [is part of] 'http://www.domain.com/category/?id=12345&amp; as true, so it will return the product row.</p>\n\n<p>Of course [Is part of] doesn't exist, but what I want to know if it is possible to match the value in the column against the expression of the url which will change for each request.\nLike a normal where statement but then reveresed.</p>\n\n<p>Is something like this possible with <code>SQL 2008 Express Edition</code> ?</p>\n\n<p>[UPDATE]</p>\n\n<p>I have tested the like '%' + UrlPart '%' and the CharIndex and according to MS SQL's exectution plan, they are identical. Seems that SQL does the same thing underwater, so both options are good.</p>\n\n<p>I would think that CharIndex might be a bit more raw then like (like might be converted) so I go for that one now.</p>\n\n<p>Thank you all.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":26,"score":2,"question_id":13208158,"title":"Can't drop procedure if object_id is not null","body":"<p>I have a weird problem. I'm trying to drop a procedure only if it exists, and have this code: </p>\n\n<pre><code>IF OBJECT_ID(N'dbo.CreateBlogUser', N'U') IS NOT NULL\n    DROP PROCEDURE CreateBlogUser;\n    PRINT 'IS NOT NULL'\nGO\n</code></pre>\n\n<p>(the print is only there to try if it is true or not).\nAnd when I run it, \"IS NOT NULL\" is printed, but the procedure isn't dropped! It still exists in the database, so when I run my Create procedure, it fails. </p>\n\n<p>However! When I tried to remove the NOT from the code, it works! The procedure is dropped and \"IS NOT NULL\" is still printed. This seems totally backwards and I don't know why it does this. Is is something to do with the extra N:s and U:s in the OBJECT_ID? Found the code <a href=\"http://msdn.microsoft.com/en-us/library/ms190328.aspx\" rel=\"nofollow\">here</a></p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":9,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3616,"score":1,"question_id":1647736,"title":"T-SQL - GROUP BY with LIKE - is this possible?","body":"<p>Is there a way to include a LIKE expression in a GROUP BY query?  For example:  </p>\n\n<pre><code>  SELECT Count(*) \n    from tblWhatever\nGROUP BY column_x [LIKE %Fall-2009%]\n</code></pre>\n\n<p>column_x:</p>\n\n<pre><code>--------\nBIOL-Fall_2009\nHIST Fall_2009\nBIOL Spring_2009\n</code></pre>\n\n<p>Result:</p>\n\n<pre><code>------\nFall_2009   2\nSpring_2009 1\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","error-handling"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":13205827,"title":"Msg 203, Level 16, State 2, is not a valid identifier","body":"<p>I'm getting the following error:</p>\n\n<blockquote>\n  <p><em>Msg 203, Level 16, State 2, Procedure getQuestion, Line 18</em><br>\n  The name 'select top(1) * from tlb_Question inner join tlb_options on tlb_options.qID=tlb_Question.id and tlb_Question.qNumber=1 and tlb_Question.id not in (0,1)' is not a valid identifier</p>\n</blockquote>\n\n<p>from the following stored procedure:</p>\n\n<pre><code>ALTER proc getQuestion\n    @qNo bigint,\n    @total bigint,\n    @next nvarchar(max)\nas\nbegin \n    declare @hisa bigint\n    set @hisa=@total/3\n\n    if(@qNo&lt;=@total/3)\n    begin\n    declare @query nvarchar(max)\n    set @query=('select top(1) * from tlb_Question \n        inner join tlb_options on tlb_options.qID=tlb_Question.id and tlb_Question.qNumber=1 and tlb_Question.id not in ('+cast(@next as varchar)+')')\n    print @query\n    execute @query\n    end\nend\n</code></pre>\n"},{"tags":["nhibernate","tsql","icriteria"],"answer_count":3,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":6712,"score":2,"question_id":1278276,"title":"Nhibernate Criteria: 'select max(id)...'","body":"<p>Can I use a Criteria to execute a t-sql command to select the max value for a column in a table?</p>\n\n<p>'select @cus_id = max(id) + 1 from customers'</p>\n\n<p>Ta</p>\n\n<p>Ollie</p>\n"},{"tags":["sql-server-2008","tsql","cursor"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13195431,"title":"Update using cursor in SQL Server","body":"<p>I have two tables <code>department</code> and <code>employee</code>. </p>\n\n<p>In the <code>department</code> table I have three columsn: <code>DEP_ID, NAME, HIKEINPERCENT</code></p>\n\n<p>In the <code>employee</code> table I have four columns: <code>EMP_ID, DEP_ID, EMP_NAME, SALARY</code></p>\n\n<p>Now if I update the <code>HIKEINPERCENT</code> in the <code>department</code> table, it should update the <code>SALARY</code> of the employees in the <code>employee</code> table by using CURSOR in SQL Server.</p>\n\n<p>PLS GUIDE WITH EXPLANATION..</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":13202070,"title":"How to update day and month of a date field based on another date column present in another table?","body":"<blockquote>\n  <p>I have two tables namely tenant and unit. </p>\n  \n  <p>dtleaseto is the column present in tenant table. dtmovein is the\n  column present in unit table. </p>\n  \n  <p>I need to update only month and day of a date present in dtleaseto\n  with the month and day of a period which is one day prior to dtmovein.</p>\n  \n  <p>E.g. Suppose my dtlease to is 12/20/2012 and dtmovein is 01/01/2011\n  then my updated dtleaseto will be <strong>12</strong> / <strong>31</strong> /2012. </p>\n  \n  <p>*Relationship between tenant and unit is tenant.hunit = unit.hmy</p>\n  \n  <p>Thanks in advance for your help!!! :)</p>\n</blockquote>\n"},{"tags":["sql-server","tsql","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13203513,"title":"CTE Linking on Different ID Fields","body":"<p>I'm trying to create a SQL query that obtains data from 3 different tables.  My thought was to use a CTE to gather the information from 2 tables, and then do a right join to add in the data into the rest of my query.  I need to bring in disparate data from each field but am running into the infamous error <code>multi-part identifier could not be bound</code>  Here's what I've written so far:</p>\n\n<pre><code>with cte1 as\n(\nSELECT          \n[Physician ID] as InternalIdentifier, NPI, [Last Name] as LastName, [First Name]     \nas     \nFirstName,\nPhysician_T1HYCPP.Specialty, DOB, Degree, Department, [State License Number], [UPIN Number],    \n[Physician Status]\nFROM  Physician_T1HYCPP left outer JOIN PhysicianFile \non Physician_T1HYCPP.[Physician ID] = PhysicianFile.[TSI MD Number]\nwhere NPI &lt;&gt; ''\n),\ncteView\nAS\n(\nSelect [Doctor_Number], Address, City, State, Zip, Phone, Fax\nfrom V_PhysicianList\n)\nSelect \nInternalIdentifier, NPI, LastName, FirstName,\nSpecialty, DOB, Degree, Department, [State License Number], [UPIN Number],\n[Physician Status],     \n[Doctor_Number],\nAddress,City, State, Zip, Phone, Fax\nfrom cte1\nright outer join cteView on\nV_PhysicianList.[Doctor_Number] = PhysicianFile.[Doctor Number]\n</code></pre>\n\n<p>Here are the specific errors:</p>\n\n<pre><code>Msg 4104, Level 16, State 1, Line 1\nThe multi-part identifier \"V_PhysicianList.Doctor_Number\" could not be bound.\nMsg 4104, Level 16, State 1, Line 1\nThe multi-part identifier \"PhysicianFile.Doctor Number\" could not be bound.\n</code></pre>\n\n<p>The goal here is to bring in all the fields from the 2 tables in the first CTE and then \"merge\" in the fields from the second CTE so that address etc. get valued in the end result set.  How can I ensure that fields from both cte1 and cteView are merged properly?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":13201826,"title":"SP_SEND_DBMAIL @QUERY Inserts Line Breaks Into E-mail","body":"<p>I use the @query perimeter in sp_send_dbmail to send out an e-mail with a list of warnings (the warnings are returned by the @query perimeter).  The @query perimeter is listed as text in the e-mail.  All of the records returned from the @query perimeter and displayed in the e-mail has a line break between them.  ie. If I have 4 records, I would have 8 lines because of line breaks.</p>\n\n<p>How do I turn the line breaks off?  I read the the msdn article for sp_send_dbmail, but it didn't mention any attributes that could be changed that would affect the line breaks.</p>\n\n<p>Code:</p>\n\n<pre><code>    BEGIN\n    EXEC MSDB.DBO.sp_send_dbmail \n        @PROFILE_NAME = 'Alerts',\n        @RECIPIENTS = @MAIL,\n        @SUBJECT = @NEWSUBJECT,\n        @BODY = @NEWBODY,\n        @QUERY =\n            'SET NOCOUNT ON\n            DECLARE @HEXSTRING AS VARCHAR(100)\n            SET @HEXSTRING = (SELECT HEXADECIMAL_STRING FROM mydb.dbo.statusupdates\n                WHERE MACHINE_ID = ''1111'' AND DATEDIFF(MI, TIME_DATE_RECEIVED, GETDATE()) &lt;= 60)\n            SELECT [Warning_Description] FROM mydb.DBO.BINARYTOTABLE(mydb.DBO.HEXTOBINARY(@HEXSTRING)) AS ABB1\n            JOIN mydb.DBO.WarningMessages  ON mydb.DBO.WarningMessages.[Bit_Offset] = ABB1.BITPLACE\n            WHERE BITVALUE = 1 AND ALERT_LEVEL = ''WARNING''',\n        @QUERY_RESULT_HEADER = 0,\n        @ATTACH_QUERY_RESULT_AS_FILE = 0;\n    END\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","group-by","nvarchar"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":13202691,"title":"group by nvarchar","body":"<p>First of all, sorry for my English I will try to explain in the best way.</p>\n\n<p>Is there a way to group by a column of type <code>nvarchar</code> in SQL Server 2008? </p>\n\n<p>I am going to explain it better: (at least I try)</p>\n\n<p>If I have a table like this:</p>\n\n<pre><code>ID  Quantity   City   Code   WebSiteLink\n__  ________   ____   ____   __________\n1      10      Milan   R2    home/images/1.jpg\n2      20      Milan   R2    home/images/2.jpg\n3      30      Rome    R2    home/images/3.jpg\n4      55      Rome    R2    home/images/4.jpg\n5      4       Naple   R2    home/images/5.jpg\n6      1       London  R2    home/images/6.jpg\n7      30      London  R2    home/images/7.jpg\n8      40      London  R2    home/images/8.jpg\n</code></pre>\n\n<p>I am able to group all columns except <code>WebSitelink</code> because it is an <code>nvarchar</code> type.</p>\n\n<p>My need is to get a random img link, is that possible to do it with a query?</p>\n\n<p>I don't want to use a stored procedure.</p>\n"},{"tags":["sql-server","tsql","powershell-v2.0","cmdlet"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":19,"score":0,"question_id":13202474,"title":"how to execute tsql scripts from cmdlet written in c#","body":"<p>I want to execute tsql scripts from custom cmdlet written in c#. Can you recommend me the best practice to do it?</p>\n\n<p>I have a few .sql scripts and in my cmdlet I need to iterate through them in specific order and execute each sql script. I also need to run all scripts in transaction if is it possible.</p>\n\n<p>And I need to execute scripts remotely. It means, that there may not be sql server installed on the machine from which is cmdlet executed.</p>\n\n<p>The target sql servers are 2008, 2008R2, 2012.</p>\n\n<p>I have read some approaches, but i'm still not sure what is the best one. </p>\n\n<p>thanks in advance</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":31,"score":-1,"question_id":13202413,"title":"Handle bad dates during CAST","body":"<p>How can I gracefully handle bad date integers that are random thorughout my table?  For instance I see some 9999999999 in there at times so consequently this query bombs out. I want to just produce the 1900 date in those cases instead of just stopping like this:</p>\n\n<pre><code>Select convert(date,CAST(trandate as varchar(8))),\n       convert(date,CAST(duedate as varchar(8))), \n        ...\n\nFROM  SomeTable\n</code></pre>\n\n<p>a valid date looks like this in that table for those fields: 20100924 and those work fine when they hit this query.</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":35,"score":2,"question_id":13201516,"title":"Correct syntax for calling a stored procedure with parameters from within another stored procedure","body":"<p>I am having difficulty establishing the correct syntax for calling a stored procedure within a stored procedure. I thought this syntax was correct:</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROCEDURE [dbo].[newProc](\n    @param1 varchar(50),\n    @param2 nvarchar(2000),\n    @param3 int,\n    @param4 int,\n    @param5 int,\n    @param6 int\n)\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    EXEC [dbo].[externProc1] @param1, @param2;\n    GO\n\n    EXEC [dbo].[externProc2] @param3, @param4;\n    GO\n\n    EXEC [dbo].[insertProc3] @param5, @param6;\n    GO\n\nEND\nGO\n</code></pre>\n\n<p>But when I try this, I keep getting \n\"Incorrect syntax near ';'  Must declare the scalar variable @param3.\nMust declare the scalar variable @param5.\"</p>\n\n<p>What is the correct syntax for calling a stored procedure with parameters from within another stored procedure?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":13199290,"title":"Find 2 Business Days","body":"<p>I have a Calendar table. I would like get 2 business before Today's Date while skipping Holidays and weekeends.</p>\n\n<p>For example:</p>\n\n<p>Example 1: New years 2013 falls on a Tuesday. If it was Thursday (1/3), then my starting date would be Monday (12/31).</p>\n\n<p>Example 2: If it was Monday (12/31), then my starting date would be Thursday (12/27).</p>\n\n<p>My Clandar table as been prepopulated with 30 years worth of dates and have flags to determine which ones are weekend and hollidays. The table has these fields:</p>\n\n<p>dt: Date and time for 30 years\nY: year\nD: Day\nM: Month\nIsholiday: (Is a holiday are not, flagged with 0 for \"no\"  and 1 for \"Yes\")\nIsWeekday: (Is a weekday? Flagged with 0 for \"no\"  and 1 for \"Yes\"\nHolidayDescritption: Holiday Names</p>\n\n<p>Please help.</p>\n"},{"tags":["sql-server","tsql","union"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":13200720,"title":"UNION select sql statement returns duplicate results","body":"<p>My objective is to have one record with both HomeNumber &amp; OfficeNumber and I'm keeping the PersonID to reference the customer table. I'm thinking I shouldn't even be using a UNION but maybe a select query from two nested sub queries.</p>\n\n<p>The results returned look like this.</p>\n\n<pre><code>1A370535-9432-45B9-8F08-004F040EE196    ''          ''\n1A370535-9432-45B9-8F08-004F040EE196    6127319561  ''\nE8FA1667-416C-4639-ADDC-02143D651B4E    ''          6512096719\nE8FA1667-416C-4639-ADDC-02143D651B4E    6515786963  ''\n</code></pre>\n\n<p>Here my query:</p>\n\n<pre><code>    SELECT PhoneNumbers.PersonID, PhoneNumbers.HomeNum, PhoneNumbers.OfficeNum\n    FROM (\n      SELECT PhoneHub.PersonID, ISNULL(PhoneHub.PhoneNbr, '') AS HomeNum, '' AS OfficeNum\n      FROM \n        --PhoneType INNER JOIN \n        PhoneHub --ON PhoneType.ID = PhoneHub.TypeID \n      WHERE \n        (PhoneHub.FranID = @FranID) AND\n        (PhoneHub.TypeID = '28321161-668e-4a56-90be-67a146fa1353') -- Home# ID\n      UNION\n      SELECT PhoneHub.PersonID, '' AS HomeNum, ISNULL(PhoneHub.PhoneNbr, '') AS OffNum\n      FROM \n        --PhoneType AS PhoneType_2 INNER JOIN \n        PhoneHub --AS PhoneHub ON PhoneType_2.ID = PhoneHub.TypeID\n      WHERE \n        (PhoneHub.FranID = @FranID) AND\n        (PhoneHub.TypeID = '02a4125b-b968-4dc6-9734-7f75f45f7635') --Office# ID\n     ) AS PhoneNumbers  \n     ORDER BY PhoneNumbers.PersonID\n</code></pre>\n\n<p>Table Schema - PhoneHub</p>\n\n<pre><code>PK  ID          uniqueidentifier    \nFK  FranID      uniqueidentifier      Franchise.ID\nFK  PersonID    uniqueidentifier      Customer.ID   \nFK  TypeID      uniqueidentifier      PhoneType.ID\nPhoneNbr    nvarchar(20)    \nPhoneExt    nvarchar(10)    \nIsDefault   bit \n</code></pre>\n"},{"tags":["tsql","grouping"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13198867,"title":"tsql determinate price trends","body":"<p>I have a table with 3 column</p>\n\n<pre>\n+---------------+-------------------------+-------+\n| InstrumentId  |          Date           | Price |\n+---------------+-------------------------+-------+\n|            39 | 2012-10-31 00:00:00.000 |   150 |\n|            39 | 2012-11-01 00:00:00.000 |   160 |\n|            39 | 2012-11-01 00:00:00.000 |   200 |\n|            40 | 2012-10-31 00:00:00.000 |   150 |\n|            40 | 2012-11-01 00:00:00.000 |   140 |\n|            40 | 2012-11-01 00:00:00.000 |   200 |\n|            50 | 2012-10-31 00:00:00.000 |   150 |\n|            50 | 2012-11-01 00:00:00.000 |   150 |\n|            50 | 2012-11-01 00:00:00.000 |   150 |\n+---------------+-------------------------+-------+</pre>\n\n<p>I need to recive next result:</p>\n\n<pre>\n+--------------+-------+\n| InstrumentId | Price |\n+--------------+-------+\n|           39 |   200 |\n|           40 |     0 |\n|           50 |   150 |\n+--------------+-------+\n\n</pre>\n\n<p>rules:\nif price for same InstrumentId is growing or is equal => return last price (that means every next price greater or equal to a previous price. \nFor instance Id 39: 150 &lt;= 160 &lt;= 200 => return 200)\nif any price for same InstrumentId is less than previous => return 0 (see instrumentId 40)</p>\n\n<p>I can do that with a cursor... but I think that exist a simply workaround to do this. \nAny ideas?</p>\n\n<p>test data:</p>\n\n<pre><code>DECLARE @table TABLE(\n    instrumentId INT NOT NULL,\n    priceListDate DATETIME NOT NULL,\n    price DECIMAL NOT NULL \n)\n\nINSERT INTO @table\n(\n    instrumentId,\n    priceListDate,\n    price\n)\nVALUES( 39, '2012-10-31 00:00:00.000',  150),\n(39,'2012-11-01 00:00:00.000',  160),\n(39,'2012-11-01 00:00:00.000',  200),\n(40,'2012-10-31 00:00:00.000',  150),\n(40,'2012-11-01 00:00:00.000',  140),\n(40,'2012-11-01 00:00:00.000',  200),\n(50,'2012-10-31 00:00:00.000',  150),\n(50,'2012-11-01 00:00:00.000',  150),\n(50,'2012-11-01 00:00:00.000',  150)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":4,"favorite_count":0,"up_vote_count":12,"down_vote_count":0,"view_count":1988,"score":12,"question_id":6376866,"title":"TSQL - How to use GO inside of a BEGIN .. END block?","body":"<p>I am generating a script for automatically migrating changes from multiple development databases to staging/production.  Basically, it takes a bunch of change-scripts, and merges them into a single script, wrapping each script in a <code>IF whatever BEGIN ... END</code> statement.</p>\n\n<p>However, some of the scripts require a <code>GO</code> statement so that, for instance, the SQL parser knows about a new column after it's created.</p>\n\n<pre><code>ALTER TABLE dbo.EMPLOYEE \nADD COLUMN EMP_IS_ADMIN BIT NOT NULL\nGO -- Necessary, or next line will generate \"Unknown column:  EMP_IS_ADMIN\"\nUPDATE dbo.EMPLOYEE SET EMP_IS_ADMIN = whatever\n</code></pre>\n\n<p>However, once I wrap that in an <code>IF</code> block:</p>\n\n<pre><code>IF whatever\nBEGIN\n    ALTER TABLE dbo.EMPLOYEE ADD COLUMN EMP_IS_ADMIN BIT NOT NULL\n    GO\n    UPDATE dbo.EMPLOYEE SET EMP_IS_ADMIN = whatever\nEND\n</code></pre>\n\n<p>It fails because I am sending a <code>BEGIN</code> with no matching <code>END</code>.  However, if I remove the <code>GO</code> it complains again about an unknown column.</p>\n\n<p><strong>Is there any way to create and update the same column within a single <code>IF</code> block?</strong></p>\n"},{"tags":["sql-server","tsql","index"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13199234,"title":"Indexing on a single value only in a column","body":"<p>I have a table in which I use reference counting for removing obsolete rows. In order to do this efficiently, I would like to create an index that only indexes the rows in the table, where the reference count is 0. Is this possible, or am I better off using a view, or something else?</p>\n"},{"tags":["sql","database","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":45,"score":1,"question_id":13198746,"title":"sql - group/order same column DESC and with random values","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/8305920/sql-how-to-sort-order-query-result-in-somewhat-arbitrary-manner\">SQL: How to sort / order query result in somewhat arbitrary manner?</a>  </p>\n</blockquote>\n\n\n\n<p>I want to order a column like so (DESC values):\n c,b,a. \nHowever at the very end of the DESC, I want to display values g,h,i (if exist) . Do I need to do a union on the column from a sub-query?</p>\n\n<p>This is the SQL script so far:</p>\n\n<pre><code>SELECT cars,size from car_table\nGROUP BY cars, size\nORDER BY cars DESC,size ASC\n</code></pre>\n\n<p>Cars is the column I am trying to run my multi-sort on.</p>\n"},{"tags":["sql-server","tsql","inner-join"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":22,"score":0,"question_id":13198223,"title":"The effect of a select with multiple tables in FROM is the same as INNER JOIN but what is the ON clause then?","body":"<p>I have a query like this:</p>\n\n<pre><code>SELECT\n    *\nFROM\n    table1,\n    table2\n</code></pre>\n\n<p>I know this is somewhat equivalent to:</p>\n\n<pre><code>SELECT\n    *\nFROM\n    table1\nINNER JOIN\n    table2\nON ???\n</code></pre>\n\n<p>However, what would be the resulting ON clause for the join?</p>\n\n<h2>Update</h2>\n\n<p>After some testing in SSMS here are my findings</p>\n\n<pre><code>SELECT * FROM table1,table2\n</code></pre>\n\n<p>gives the same execution plan and the same records as</p>\n\n<pre><code>SELECT * FROM table1 INNER JOIN table2 ON 1=1\n</code></pre>\n\n<p>and the same thing for</p>\n\n<pre><code>SELECT * FROM table1 CROSS JOIN table2\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":13197526,"title":"Loop through all records in my SQL Server database","body":"<p>I have the following SQL script. As you can see I manually set the <code>@listingid</code> value to 30653.</p>\n\n<p>But this script should be executed for all records in the <code>[listings]</code> table where <code>@listingid</code> is assigned the value of the <code>[listings].id</code> column.</p>\n\n<pre><code>DECLARE @profname nvarchar(150)\nDECLARE @furl nvarchar(250)\nDECLARE @city nvarchar(250)\nDECLARE @listingid int\n\nset @listingid=30653\n--select the top 1 professionname\nSELECT TOP 1 @profname=REPLACE(LOWER(pn.title),' ','-'),@furl=l.friendlyurl,@city=REPLACE(REPLACE(LOWER(l.city),'''',''),' ','-') FROM healthprof_professionnames hpn\nINNER JOIN professionname pn ON pn.id=hpn.professionnameid\nINNER JOIN listings l on l.id=hpn.healthprofid\nWHERE l.id=@listingid ORDER BY pn.title\n\n--check if current friendlyurl already contains profession\nIF NOT CHARINDEX(@profname,@furl)&gt;0\n    SET @furl = @furl + '-' + @profname\n\nIF NOT CHARINDEX(@city,@furl)&gt;0\nSET @furl = @furl + '-' + @city\n\nSET @furl = @furl + '-3'\n\nUPDATE listings set friendlyurl=@furl WHERE id=@listingid\n</code></pre>\n"},{"tags":["xml","sql-server-2008","tsql","xquery"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":13195922,"title":"How to query xml column in tsql","body":"<p>I have a table, T1, with a XML column, EventXML, on SQL Server 2008. I want to query all the rows where certain node contains a particular value. Better, I'd like to retrieve the value in a different node. The table T1:</p>\n\n<pre><code>T1:\n   EventID, int\n   EventTime, datetime\n   EventXML, XML\n</code></pre>\n\n<p>Here is an example XML hierarchy:</p>\n\n<pre><code>&lt;Event&gt;\n   &lt;Indicator&gt;\n      &lt;Name&gt;GDP&lt;/Name&gt;\n   &lt;/Indicator&gt;\n   &lt;Announcement&gt;\n      &lt;Value&gt;2.0&lt;/Value&gt;\n      &lt;Date&gt;2012-01-01&lt;/Date&gt;\n   &lt;/Announcement&gt;\n&lt;/Event&gt;\n</code></pre>\n\n<ol>\n<li>How to find all the rows related to \"GDP\" Indicator;</li>\n<li>How to get all values for \"GDP\" Indicator;</li>\n</ol>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","rollback"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":13188621,"title":"roll back SQL query executed by mistake","body":"<p>I think the question says it all,\nthe following update query has been executed - by mistake - in SQL Server management studio</p>\n\n<pre><code>update kms_students set student_campus='4' where student_campus='KL'\n</code></pre>\n\n<p>The effected rows are more than 1000, and i can't identify it since that table is already have the <code>student_campus='4'</code> for many previous rows.</p>\n\n<p>Is it possible to roll back?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":13194026,"title":"SQL Dynamic join?","body":"<p>Please see <a href=\"http://sqlfiddle.com/#!3/2506f/2/0\" rel=\"nofollow\">http://sqlfiddle.com/#!3/2506f/2/0</a></p>\n\n<p>I have two tables.  One is a general record, and the other is a table containing related documents that link to that record.</p>\n\n<p>In my example I've created a straightforward query which shows all records and their associated documents.  This is fine, but I want a more complex situation.</p>\n\n<p>In the 'mainrecord' table there is a 'multiple' field.  If this is 0, then I only want the most recent document from the documents table (that is, with the highest ID).  If it is 1, I want to join all linked documents.</p>\n\n<p>So, rather than the result of the query being this:-</p>\n\n<pre><code>ID  NAME    MULTIPLE    DOCUMENTNAME    IDLINK\n1   One     1           first document    1\n1   One     1           second document   1\n2   Two     0           third document    2\n2   Two     0           fourth document   2\n3   Three   1           fifth document    3\n3   Three   1           sixth document    3\n</code></pre>\n\n<p>It should look like this:-</p>\n\n<pre><code>ID  NAME    MULTIPLE    DOCUMENTNAME    IDLINK\n1   One     1           first document    1\n1   One     1           second document   1\n2   Two     0           fourth document   2\n3   Three   1           fifth document    3\n3   Three   1           sixth document    3\n</code></pre>\n\n<p>Is there a way of including this condition into my query to get the results I'm after.  I'm happy to explain further if needed.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":13193627,"title":"SQL - Update causing deadlock error","body":"<p>I'm trying to update a row in a table upon someone viewing the page (it increments the viewed count), however now and then I get a deadlock error, I'm guessing this is due to two or more people trying to update the same row?</p>\n\n<p>The error is:</p>\n\n<pre><code>Transaction (Process ID 60) was deadlocked on lock | communication buffer resources with another process and has been chosen as the deadlock victim. Rerun the transaction.\n</code></pre>\n\n<p>And my SQL is:</p>\n\n<pre><code>UPDATE [ProductDescription] \nSET [ViewCount] = ([ViewCount] + 1) \nWHERE ProductCode = @prodCode \n    AND ApplicationID = @AppID\n</code></pre>\n\n<p>I believe I may need a WITH(NOLOCK)?</p>\n"},{"tags":["tsql","conditional","sybase","ddl"],"answer_count":9,"favorite_count":2,"up_vote_count":7,"down_vote_count":1,"view_count":11430,"score":6,"question_id":307942,"title":"How do I conditionally create a table in Sybase (TSQL)?","body":"<p>OK, so Sybase (12.5.4) will let me do the following to DROP a table if it already exists:</p>\n\n<pre><code>IF EXISTS (\n    SELECT 1\n    FROM sysobjects\n    WHERE name = 'a_table'\n    AND type = 'U'\n)\nDROP TABLE a_table\nGO\n</code></pre>\n\n<p>But if I try to do the same with table creation, I always get warned that the table already exists, because it went ahead and tried to create my table and ignored the conditional statement. Just try running the following statement twice, you'll see what I mean:</p>\n\n<pre><code>IF NOT EXISTS (\n    SELECT 1\n    FROM sysobjects\n    WHERE name = 'a_table'\n    AND type = 'U'\n)\nCREATE TABLE a_table (\n    col1 int not null,\n    col2 int null\n)\nGO\n</code></pre>\n\n<p>Running the above produces the following error:</p>\n\n<blockquote>\n  <p>*SQL Server Error on (localhost)\n  Error:2714 at Line:7 Message:There is\n  already an object named 'a_table' in\n  the database.*</p>\n</blockquote>\n\n<p>What's the deal with that?!</p>\n"},{"tags":["sql-server","tsql","date-range"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":13192073,"title":"TSQL DateRange counting day by day","body":"<p>I solve the problem which counts for 1 day but when I split the days into 1 day I got problem.</p>\n\n<pre><code>    declare @Start datetime\n    declare @Finish datetime\n    declare @TimeRange int\n\n    set @Start = N'2012-10-16 00:00:00.000'\n    set @Finish = N'2012-10-19 00:00:00.000'\n    set @TimeRange = 1 \n\n    declare @TimeRanges as TABLE (SessionStart datetime, SessionEnd datetime);\n\n    with TimeRanges as \n    (   select @Start as StartTime, DATEADD(day, @TimeRange, @Start) as EndTime\n        union all\n        select DATEADD(day, @TimeRange, StartTime), DATEADD(day, @TimeRange, EndTime)\n        from TimeRanges\n        where EndTime  &lt; @Finish \n    )\n</code></pre>\n\n<p>timeRanges tables split the @Start and @Finish into days.</p>\n\n<p>Here is the what the problem starts:</p>\n\n<pre><code> select StartTime, EndTime,TMP.NoOfCalls    \n    from (SELECT TOP 1 DATEADD(SECOND, Number, c.SessionStartTime) CallTime, COUNT(C.ScenarioID) NoOfCalls FROM test c\nINNER JOIN Numbers N ON N.Number &lt;= DATEDIFF(SECOND, C.SessionStartTime, C.SessionCloseTime) \nwhere c.SessionStarttime &gt;= @Start and  c.SessionCloseTime &lt;= @Finish\nGROUP BY DATEADD(SECOND, Number, c.SessionStartTime)\nORDER BY NoOfCalls DESC\n)as TMP left outer join TimeRanges as TR on @Start &lt;= TR.StartTime   and   TR.EndTime &lt;= @Finish\n        group by TR.StartTime, TR.EndTime,TMP.NoOfCalls\n        order by TR.StartTime\n</code></pre>\n\n<p>Here is the result I got:</p>\n\n<p><img src=\"http://i.stack.imgur.com/mGLcC.jpg\" alt=\"enter image description here\"></p>\n\n<p>Actually 260 is the result of between N'2012-10-17 00:00:00.000' and N'2012-10-18 00:00:00.000' but I want result seperately. </p>\n\n<p>My sample test table :</p>\n\n<pre><code>SessionID    SessionStartTime              SessionCloseTime\n24       2012-10-16 01:00:06.000           2012-10-16 01:01:22.000\n24       2012-10-16 01:00:08.000           2012-10-16 01:01:10.000\n24       2012-10-16 01:00:16.000           2012-10-16 01:01:12.000\n24       2012-10-16 01:00:30.000           2012-10-16 01:01:48.000\n24       2012-10-16 01:00:41.000           2012-10-16 01:02:08.000\n24       2012-10-16 01:00:48.000           2012-10-16 01:01:34.000\n24       2012-10-16 01:00:56.000           2012-10-16 01:03:09.000\n24       2012-10-16 01:01:02.000           2012-10-16 01:02:13.000\n24       2012-10-16 01:01:05.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:09.000           2012-10-16 01:02:42.000\n24       2012-10-16 01:01:15.000           2012-10-16 01:02:48.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:14.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:06.000\n24       2012-10-16 01:01:42.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:45.000           2012-10-16 01:03:04.000\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":13071003,"title":"Strange (Caching?) Issue (Bug?) with T-SQL View","body":"<p><strong>This issue was resolved by scripting the view as a create, dropping the view, and then recreating the view using the script, so obviously nothing was <em>wrong</em> with the view, per se.  However, I am very curious as to what the cause could be...</strong></p>\n\n<p>I have a created like this:</p>\n\n<pre><code>CREATE VIEW [dbo].[Employees_V]\nAS\nSELECT  cast(right(EmployeeNo,4) as int) as EmployeeID\n,*\n,cast(0 as bit) AS [IsTerritoryManager]\n,cast(0 as bit) AS [IsCoordinator]\nFROM    AD.dbo.ADEmployees_V\n</code></pre>\n\n<p>The <code>AD.dbo.ADEmployees_V</code> has a lot of different fields, but the relevant fields are <code>Status</code> and <code>ISStatus</code>, defined in the creation of the view as:</p>\n\n<pre><code>,CASE WHEN c.[Status] = 'Active' THEN 'Active' ELSE 'Terminated' END AS [Status]\n,CASE WHEN c.[Status] = 'Active' OR ad.[AccountStatus] LIKE '%Enabled%' THEN 'Active' ELSE 'Terminated' END AS [ISStatus]\n</code></pre>\n\n<p>Today, I added the <code>ISStatus</code> column to <code>AD.dbo.ADEmployees_V</code> (<code>Status</code> was there previously).</p>\n\n<p>After making that change, I did a:</p>\n\n<pre><code>SELECT * FROM [Employees_V]\n</code></pre>\n\n<p>Surprisingly, this did not return the proper results.  <code>ISStatus</code> did not appear as a column header, and instead of being populated with 0s, <code>IsTerritoryManager</code> was populated with the new <code>ISStatus</code> values!</p>\n\n<p>I am guessing that this is some sort of caching issue, but I would <em>love</em> an explanation of what is going on under the covers.  Thanks!</p>\n"},{"tags":["sql","tsql","reporting-services","ssrs-reports"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13189222,"title":"SSRS Force single sided printing","body":"<p>The Current the windows pc have the printer settings defaulted to double sided printing to save paper.<br>\nThere are some reports which they would like SSRS to ignore the windows settings and print single sided.</p>\n\n<p>I dont think this is possible, is it?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":13189706,"title":"SQL Server, how to display (square) ^2 as in column heading?","body":"<p>Please guide me how to display m2 (m with 2 as square small on top of m) in column heading ?</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql","dynamicquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":11,"score":0,"question_id":13188564,"title":"Dynamic Query w/ Quotes issue","body":"<p>I'm trying to write a dynamic query that produces the same results as the following, but replaces the fixed tablename with a variable.  </p>\n\n<pre><code>    SELECT *\n    WHERE tableName = 'Table2A' \n</code></pre>\n\n<p>works fine but</p>\n\n<pre><code>    DECLARE @tablename AS NVARCHAR(100)\n    SET @tablename = N'Table2A'\n    DECLARE @execquery AS NVARCHAR(MAX)\n    SET @execquery = N'\n       SELECT *\n       WHERE tableName = ''' + QUOTENAME(@tablename) + N''''    \n\n    EXECUTE sp_executesql @execquery\n</code></pre>\n\n<p>returns no records.  What am I doing wrong?</p>\n"},{"tags":["sql","sql-server","tsql","group-by"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":45,"score":1,"question_id":13188610,"title":"Sql group by working not properly","body":"<p>This is my query</p>\n\n<pre><code>select  \n (sum(case when offer1_delivered is not null then 1 else null end) ) as PenetrationRate1\n,(sum(case when offer2_delivered is not null then 1 else null end)) as PenetrationRate2\n,count(TargetMkgListID) as TargetMkgListID from tablename\n</code></pre>\n\n<h1>output</h1>\n\n<pre><code>PenetrationRate1    PenetrationRate2    TargetMkgListID \n1                   2                3\n</code></pre>\n\n<p>I need to include customername column in this query</p>\n\n<pre><code>select  customername,\n (sum(case when offer1_delivered is not null then 1 else null end) ) as PenetrationRate1\n,(sum(case when offer2_delivered is not null then 1 else null end)) as PenetrationRate2\n,count(TargetMkgListID) as TargetMkgListID from tablename\ngroup by customername\n</code></pre>\n\n<p>If I include customername in my query, groupby is not working properly.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13186879,"title":"Querying data groups with total row before starting next group?","body":"<p>I need to query some data in the below format in SQL Server:</p>\n\n<ul>\n<li>Id   Group   Price </li>\n<li>1    A   10</li>\n<li>2    A   20 </li>\n<li><p><strong>Sum    30</strong> </p></li>\n<li><p>1    B   6</p></li>\n<li>2    B   4 </li>\n<li><p><strong>Sum    10</strong> </p></li>\n<li><p>1    C   100</p></li>\n<li>2    C   200 </li>\n<li><strong>Sum    300</strong> </li>\n</ul>\n\n<p>I was thinking to do it in the follwoing steps:</p>\n\n<ol>\n<li>Query one group</li>\n<li>In other query do sum</li>\n<li>Use Union operator to combine this result set</li>\n<li>Do step 1-3 for all groups and finally return all sub sets of data using union.</li>\n</ol>\n\n<p>Is there a better way to do this ? May be using some out of box feature ? Please advise.</p>\n\n<p><strong>Edit:</strong></p>\n\n<p>As per suggestions and code sample I tried this code:</p>\n\n<pre><code>Select \nCase \nwhen id is null then 'SUM' \nelse CAST(id as Varchar(10)) end as ID,\n\nCase when [group] is null then 'ALL' else CAST([group] as Varchar(50)) end as [group]\n,Price from\n(\nSELECT Id,  [Group],BGAApplicationID,Section, SUM(PrimaryTotalArea) AS price   \nFROM vwFacilityDetails\nwhere bgaapplicationid=1102\nGROUP BY Id,  [Group],BGAApplicationID,Section  WITH ROLLUP\n) a\n</code></pre>\n\n<p>And Even this code as well:</p>\n\n<pre><code>Select Id,  [Group],BGAApplicationID,Section, SUM(PrimaryTotalArea) AS price           \nFrom   vwFacilityDetails\nWhere  Not ([group] Is Null And id Is Null And BGAApplicationId is null and section is null) and BGAApplicationId=1102\nGroup By Id,  [Group],BGAApplicationID,Section \n    With Rollup\n</code></pre>\n\n<p>In results it groups up the data but for every record it shows it 3 times (in both above codes) like:</p>\n\n<ul>\n<li>2879 Existing Facilities Whole School    25.00</li>\n<li>2879 Existing Facilities Whole School    25.00 </li>\n<li>2879 Existing Facilities    Whole School 25.00 </li>\n<li>2879 ALL 25.00</li>\n</ul>\n\n<p>I guess there is some issue in my query, please guide me here as well.\nThanks</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":6,"favorite_count":1,"up_vote_count":25,"down_vote_count":0,"view_count":39087,"score":25,"question_id":482885,"title":"How do I drop a foreign key constraint only if it exists in sql server?","body":"<p>I can drop a table if it exists using the following code but do not know how to do the same with a constraint:</p>\n\n<pre><code>IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(N'TableName') AND type = (N'U')) DROP TABLE TableName\ngo\n</code></pre>\n\n<p>I also add the constraint using this code:</p>\n\n<pre><code>ALTER TABLE [dbo].[TableName] \n  WITH CHECK ADD CONSTRAINT [FK_TableName_TableName2] FOREIGN KEY([FK_Name])\n    REFERENCES [dbo].[TableName2] ([ID])\ngo\n</code></pre>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":7,"up_vote_count":31,"down_vote_count":0,"view_count":4772,"score":31,"question_id":2668529,"title":"T-SQL GO Statement","body":"<p>I have read and read over MSDN, etc.  Ok, so it signals the end of a batch.</p>\n\n<p>What defines a batch?  I don't see why I need go when I'm pasting in a bunch of scripts to be run all at the same time.</p>\n\n<p>I've never understood GO.  Can anyone explain this better and when I need to use it (after how many or what type of transactions)?</p>\n\n<p>For example why would I need GO after each update here:</p>\n\n<pre><code> UPDATE [Country]\n   SET [CountryCode] = 'IL'\n WHERE code = 'IL'\n\n GO\n\n UPDATE [Country]\n   SET [CountryCode] = 'PT'\n WHERE code = 'PT'\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","jobs"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":175,"score":2,"question_id":12249056,"title":"Executing SQL Server Agent Job from a stored procedure and returning job result","body":"<p>Need to have a stored procedure that calls a SQL Server Agent Job and returns whether or not the job ran successfully or not.</p>\n\n<p>So far I have<br></p>\n\n<pre><code>CREATE PROCEDURE MonthlyData\nAS\nEXEC msdb.dbo.sp_start_job N'MonthlyData'\n\nWAITFOR DELAY '000:04:00'\n\nEXEC msdb.dbo.sp_help_jobhistory @job_name = 'MonthlyData'\nGO\n</code></pre>\n\n<p>Which starts the job, whats the best way to get back if the job ran successfully or not?</p>\n\n<p>Ok made an edit and used WAITFOR DELAY as the job normally runs between 3-4 mins never longer than 4. Does the job but is there a more efficient way to do it?</p>\n"},{"tags":["sql","sql-server","tsql","pivot","unpivot"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":13184637,"title":"pivoting rows to columns in tsql","body":"<p>I have the following table with the following sample data</p>\n\n<pre><code>ID  Language       Question       SubQuestion     SubSubQuestion    TotalCount  TotalPercent\n3      E               9               0                1             88527            73%\n3      E               9               0                2             19684            16%\n3      E               9               0                3             12960            11%\n3      E               9               0                9              933              1%\n</code></pre>\n\n<p>I want all in one row like this</p>\n\n<pre><code>    ID  Language        TotalCount901   TotalPercent901     TotalCount902   TotalPercent902 TotalCount903   TotalPercent903\n     3       E            88527           73%                 19684             16%              12960              11%\n</code></pre>\n\n<p>I've tired using the pivot command, but it dosnt to work for me.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","sql-agent-job"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":690,"score":4,"question_id":10088427,"title":"How to pass a parameter to a SQL Job that will execute a stored procedure","body":"<p>I have the below code (only the portion that is needed)</p>\n\n<pre><code>EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'SomeStep', \n        @step_id=1, \n        @cmdexec_success_code=0, \n        @on_success_action=1, \n        @on_success_step_id=0, \n        @on_fail_action=2, \n        @on_fail_step_id=0, \n        @retry_attempts=0, \n        @retry_interval=0, \n        @os_run_priority=0, @subsystem=N'TSQL', \n        @command=N'exec [dbo].[PORT_Insert_Record] ''https://localhost''',  \n        @database_name=N'MyDatabase', \n        @flags=0\n</code></pre>\n\n<p>Now, I want to pass the <code>https://localhost</code> value into a variable and pass to the stored procedure (for some reason I cannot pass it inside the SP).</p>\n\n<p>So I tried </p>\n\n<pre><code>DECLARE @domainName varchar(max)\nDECLARE @sp varchar(max)\nSET @domainName ='https://localhost:'\nSET @sp ='exec [dbo].[PORT_Insert_Record]' + @domainName\n\nEXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'InsertRecordIntoResellerOpportunities', \n        @step_id=1, \n        @cmdexec_success_code=0, \n        @on_success_action=1, \n        @on_success_step_id=0, \n        @on_fail_action=2, \n        @on_fail_step_id=0, \n        @retry_attempts=0, \n        @retry_interval=0, \n        @os_run_priority=0, @subsystem=N'TSQL', \n        @command=@sp,  \n        @database_name=N'MyDatabase',  \n        @flags=0\n</code></pre>\n\n<p>but it is not working. I also search in the net for any idea/syntax etc.. but no luck as of now.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["sql","tsql","sql-management-studio"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":40,"score":3,"question_id":13184746,"title":"SQL Query to Display Count of Total","body":"<p>I've got a very complex query that joins eight (8) different tables.</p>\n\n<p>For the sake of this question, though, I'll simplify it with this type of structure:</p>\n\n<pre><code>create table table1(PacketID int, RequestID int, EmpID int, PartNo varchar(20))\n\ninsert into table1 values\n (1 , 1, 132, 'abc123'),\n (1 , 2, 132, 'abc456'),\n (1 , 3, 132, 'def123'),\n (1 , 4, 132, 'def456'),\n (2 , 5, 228, 'xyz123'),\n (3 , 6, 239, 'xyz321'),\n (3 , 7, 239, 'aaa000')\n</code></pre>\n\n<p>This type of table creates the following output:</p>\n\n<pre><code>|_P_|_R_|_Emp_|_PartNo_|\n|_1_|_1_|_132_|_abc123_|\n|_1_|_2_|_132_|_abc465_|\n|_1_|_3_|_132_|_def123_|\n|_1_|_4_|_132_|_def456_|\n|_2_|_5_|_228_|_xyz123_|\n|_3_|_6_|_239_|_xyz321_|\n|_3_|_7_|_239_|_aaa000_|\n</code></pre>\n\n<p>I put together a fiddle of it here: <a href=\"http://www.sqlfiddle.com/#!3/a3ce4/1\" rel=\"nofollow\">http://www.sqlfiddle.com/#!3/a3ce4/1</a></p>\n\n<p>I was told they don't really need this <code>PacketID</code> or <code>RequestID</code>, but what they do need is something that shows how many requests are in a packet and what request number of that packet needs attention.</p>\n\n<p>I will still need the <code>PacketID</code> and <code>RequestID</code> values in order to make changes to the data.</p>\n\n<p>So, I want to add a column to the table above to be something like this:</p>\n\n<pre><code>|_P_|_R_|_ReadAs_|_Emp_|_PartNo_|\n|_1_|_1_|_1 of 4_|_132_|_abc123_|\n|_1_|_2_|_2 of 4_|_132_|_abc465_|\n|_1_|_3_|_3 of 4_|_132_|_def123_|\n|_1_|_4_|_4 of 4_|_132_|_def456_|\n|_2_|_5_|_1 of 1_|_228_|_xyz123_|\n|_3_|_6_|_1 of 2_|_239_|_xyz321_|\n|_3_|_7_|_2 of 2_|_239_|_aaa000_|\n</code></pre>\n\n<p>How exactly would I go about doing that?</p>\n\n<p>If you just want to feel my pain and see the complete view defined on my SQL Server, here it is:</p>\n\n<pre><code>SELECT P.ID AS PacketID, R.ID AS RequestID, A.ID AS ActionID,\n  EI.FIRSTNAME + ' ' + EI.LASTNAME AS Employee, P.DateStamp, \n  RQ.Description AS RequestType, L.Description AS Line, R.PartNo,\n  R.Workorder, R.Qty, RZ.Description AS ReasonType, R.MTF,\n  A.StatusID, S.Description AS Status, A.EmpID AS Stator, \n  A.DateStamp AS Stated\nFROM dbo.Packet AS P\n  LEFT OUTER JOIN dbo.Request AS R ON R.PacketID = P.ID\n  INNER JOIN dbo.Action AS A ON R.ID = A.RequestID\n  LEFT OUTER JOIN dbo.Action AS A2 ON A.RequestID = A2.RequestID\n         AND (A.DateStamp &lt; A2.DateStamp OR\n         A.DateStamp = A2.DateStamp AND A.RequestID &lt; A2.RequestID)\n  INNER JOIN CPAPP.AIO_Test_Results.dbo.EmployeeInfo AS EI ON A.EmpID = EI.COUNT\n  INNER JOIN dbo.RequestType AS RQ ON R.RequestTypeID = RQ.ID\n  INNER JOIN dbo.Line AS L ON R.LineID = L.ID\n  INNER JOIN dbo.ReasonType AS RZ ON R.ReasonTypeID = RZ.ID\n  INNER JOIN dbo.Status AS S ON A.StatusID = S.ID\nWHERE (A2.RequestID IS NULL)\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/3RdIZ.png\" alt=\"screenshot\"></p>\n"},{"tags":["sql","tsql","sql-server-2005","pivot","pivot-without-aggregate"],"answer_count":5,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":245,"score":5,"question_id":12221037,"title":"How can I query row data as columns?","body":"<p>I'm sure I'm missing something here.</p>\n\n<p>I have a dataset like this:</p>\n\n<pre>\nFK    RowNumber    Value    Type    Status\n1     1            aaaaa    A       New\n1     2            bbbbb    B       Good\n1     3            ccccc    A       Bad\n1     4            ddddd    C       Good\n1     5            eeeee    B       Good\n2     1            fffff    C       Bad\n2     2            ggggg    A       New\n2     3            hhhhh    C       Bad\n3     1            iiiii    A       Good\n3     2            jjjjj    A       Good\n</pre> \n\n<p>I'd like to query the top 3 results and Pivot them as columns, so the end result set looks like this:</p>\n\n<pre>\nFK    Value1    Type1    Status1    Value2    Type2    Status2    Value3    Type3    Status3\n1     aaaaa     A        New        bbbbb     B        Good       ccccc     A        Bad\n2     fffff     C        Bad        ggggg     A        New        hhhhh     C        Bad\n3     iiiii     A        Good       jjjjj     A        Good\n\n</pre>\n\n<p>How can I accomplish this in SQL Server 2005? </p>\n\n<p>I have been attempting this using <a href=\"http://msdn.microsoft.com/en-us/library/ms177410%28SQL.105%29.aspx\" rel=\"nofollow\">PIVOT</a>, but I am still very unfamiliar with that keyword and cannot get it to work the way I want.</p>\n\n<pre><code>SELECT * --Id, [1], [2], [3]\nFROM\n(\n    SELECT Id, Value, Type, Status\n    , ROW_NUMBER() OVER (PARTITION BY Id ORDER Status, Type) as [RowNumber]\n    FROM MyTable\n) as T\nPIVOT\n(\n    -- I know this section doesn't work. I'm still trying to figure out PIVOT\n    MAX(T.Value) FOR RowNumber IN ([1], [2], [3]),\n    MAX(T.Type) FOR RowNumber IN ([1], [2], [3]),\n    MAX(T.Status) FOR RowNumber IN ([1], [2], [3])\n) AS PivotTable;\n</code></pre>\n\n<p>My actual data set is a bit more complex than this, and I need the top 10 records, not the top 3, so I don't want to simply do <code>CASE WHEN RowNumber = X THEN...</code> for each one.</p>\n\n<p><strong>Update</strong></p>\n\n<p>I tested all the answers below, and found most of them seem about the same with no apparent performance difference in smaller data sets (around 3k records), however there was a slight difference when running the queries against larger data sets. </p>\n\n<p>Here are the results of my tests using 80,000 records and querying for 5 columns in the top 10 rows, so my end result set was 50 columns + the <code>Id</code> column. I'd suggest you test them on your own to decide which one works best for you and your environment.</p>\n\n<ul>\n<li><p><a href=\"http://stackoverflow.com/a/12221580/302677\">bluefoot's answer</a> of unpivoting and re-pivoting the data averaged the fastest at about 12 seconds. I also liked this answer because I found it easiest to read and maintain.</p></li>\n<li><p><a href=\"http://stackoverflow.com/a/12221510/302677\">Aaron's answer</a> and <a href=\"http://stackoverflow.com/a/12221623/302677\">koderoid's answer</a> both suggest using a <code>MAX(CASE WHEN RowNumber = X THEN ...)</code>, and was close behind averaging at around 13 seconds.</p></li>\n<li><p><a href=\"http://stackoverflow.com/a/12221475/302677\">Rodney's answer</a> of using multiple <code>PIVOT</code> statements averaged around 16 seconds, although it might be faster with fewer PIVOT statements (my tests had 5).</p></li>\n<li><p>And the first half of <a href=\"http://stackoverflow.com/a/12221510/302677\">Aaron's answer</a> that suggested using a CTE and <code>OUTER APPLY</code> was the slowest. I don't know how long it would take to run because I cancelled it after 2 minutes, and that was with around 3k records, 3 rows, and 3 columns instead of 80k records, 10 rows, and 5 columns.</p></li>\n</ul>\n"},{"tags":["sql","sql-server","tsql","foreign-keys"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":63,"score":1,"question_id":13179188,"title":"SQL Query to get table names by foreign key dependency","body":"<p>How could I frame a query to get table names in SQL Server by order of Foreign Key dependency?</p>\n\n<p>If there is a Table XYZ, which is the Primary table on which 2 other tables have a Foreign Key constraint, then I would want the Table XYZ to appear first.</p>\n\n<p>This is to enable the creation of tables in the correct order.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":40,"score":1,"question_id":13176954,"title":"Sql Server union with If condition","body":"<p>I have a query like:</p>\n\n<pre><code>DECLARE @tmpValue\nSET @tmpValue = 0 -- it will be change \n\nSELECT * FROM Animal WHERE AniActive = 1\nUNION \nIF @tmpValue &gt; 0 \nSELECT * FROM Animal WHERE.Active = 0\n</code></pre>\n\n<p>When I use like this it is giving error because of if condition. I have to use UNION because of our structure. </p>\n\n<p>How can I use it with if condition?</p>\n\n<p>Thanks, <br/>\nJohn</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":5,"down_vote_count":0,"view_count":62,"score":5,"question_id":13182102,"title":"WHERE on View Alias Causes Error","body":"<p>I have a view like this:</p>\n\n<pre><code>SELECT location, CAST(SUBSTRING(location, 9, 4) AS int) AS ProcessCode\nFROM   dbo.asset\nWHERE  (status NOT IN ('INACTIVE', 'NOT READY', 'LIMITEDUSE'))\nAND (location LIKE '[1-6]-[12]-[0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]-_')\n</code></pre>\n\n<p>If I call it like this, it works:</p>\n\n<pre><code>SELECT * FROM FooView\n</code></pre>\n\n<p>However, if I add a WHERE clause:</p>\n\n<pre><code>SELECT * FROM FooView WHERE ProcessCode &gt; 0\n</code></pre>\n\n<p>I get this error:</p>\n\n<blockquote>\n  <p>Conversion failed when converting the varchar value '-01-' to data\n  type int.</p>\n</blockquote>\n\n<p>Why? Since location must be in the format <code>1-2-100-0800-A</code>, I don't see how there can be a conversion error. Is it possible that the <code>CAST</code> fails before the <code>WHERE</code> has a chance to filter the results? If so, then why does the first query work?</p>\n\n<p><strong>EDIT - WORK-AROUND</strong></p>\n\n<p>I just had a co-worker suggest a good work-around. It works, but it still doesn't explain why the initial problem.</p>\n\n<p>This is in the SELECT for ProcessCode:</p>\n\n<pre><code>CASE WHEN location LIKE '[1-6]-[12]-[0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]-_'\nTHEN CAST(SUBSTRING(location, 9, 4) AS int) ELSE 0 END AS ProcessCode, \n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":64,"score":1,"question_id":13180517,"title":"Casting as float vs int returning different results","body":"<p>Mathematically, these results are similar, I'm just curious about their behavior.  The first version when my local variable is declared as a float, the rounding function stops the decimals displayed at the second decimal. In the second version with the local variable declared as an int the <code>round</code> function rounds to two decimal places, and then adds a bunch of zeroes.  Why would the variable type cause the <code>round</code> function to behave differently?</p>\n\n<pre><code>declare @totalpop float \nset @totalpop = (select count(distinct patid) from members)\nselect @totalpop\nselect edutext\n,COUNT(*) as educationCounts\n,round(100.0*COUNT(*)/@totalpop,2)\nfrom\n(\nselect distinct m.patid, e.eduText\n    from members as m\n    inner join EducationTable as e on e.eduID = m.education\n)x\ngroup by x.eduText\n</code></pre>\n\n<p>--doesn't round to two decimal places</p>\n\n<pre><code>declare @totalpop int\nset @totalpop = (select count(distinct patid) from members)\nselect @totalpop\nselect edutext\n,COUNT(*) as educationCounts\n,round(100.0*COUNT(*)/@totalpop,2)\nfrom\n(\nselect distinct m.patid, e.eduText\n    from members as m\n    inner join EducationTable as e on e.eduID = m.education\n)x\ngroup by x.eduText\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":237,"score":5,"question_id":12867597,"title":"SQL Server insert statement runs successfully but values are not added to table even though row is created","body":"<p>I have an insert statement as below. I am able to debug my stored procedure and step through my code to verify that my code runs, but a funny thing happens. </p>\n\n<p>The values that I expect to be saved in the database are not saved. Instead a row is created in the table and the <code>RecordCreatedField</code> is correctly created, even a primary key is included but the actual columns I expect to be inserted are not. All the columns are <code>nvarchar/varchar</code>, except for the date columns and the ID, but only those columns are populated.  However the following <strong>@PRCUPC ,@PRCEAN ,@PRCGTIN,@PRCatalogNumber</strong> are somehow omitted. </p>\n\n<pre><code>EXEC spinsertprodcode \n                  @pid out, \n                  @ProdID, \n                  @UPC, \n                  @EAN, \n                  @TIN, \n                  @CNumber, \n                  0, \n                  0, \n                  1, \n                  @staid, \n                  @counter out\n\n\n\nINSERT INTO dbo.ProdCodes\n(PRProductID\n,PRCUPC\n,PRCEAN\n,PRCGTIN\n,PRCatalogNumber\n,PRIsReplacement \n,PRIsReplaced \n,PRCRecordCreatedDate \n,PRCIsActive\n,PRStatusFlag)\n\nOUTPUT INSERTED.PRCID INTO @opID\n\nVALUES\n(@PRProductID, \n@PRCUPC, \n@PRCEAN, \n@PRCGTIN, \n@PRCatalogNumber,\n@PRIsReplacement ,\n@PRIsReplaced,\nGETDATE(), \n@PRCIsActive, \n@PRStatusFlag)\n\nSELECT @PRCID = O.ID FROm @opID O\n</code></pre>\n\n<p>Would appreciate any suggestion on how I can fix this  or understand what is going on. </p>\n\n<p><img src=\"http://i.stack.imgur.com/9cJ6p.png\" alt=\"Image of the Debug Screen where I confirm the right values are passed\"></p>\n\n<p>Here is an SQl fiddle of the main Stored proc that calls my insert code. \n<a href=\"http://sqlfiddle.com/#!6/d41d8/9\" rel=\"nofollow\"><strong>SQL Fiddle of my code</strong> </a></p>\n"},{"tags":["sql-server","tsql","sql-server-2008","sqlcompare"],"answer_count":9,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":1182,"score":3,"question_id":3012544,"title":"T-SQL - Is there a (free) way to compare data in two tables?","body":"<p>I have <code>table a</code> and <code>table b</code>. (SQL Server 2008)</p>\n\n<p>Both tables have the exact same schema.</p>\n\n<p>For the purposes of this question, consider <code>table a</code> = my local dev table, <code>table b</code> = the live table.</p>\n\n<p>I need to create a SQL script (containing <code>UPDATE/DELETE/INSERT</code> statements) that will update table b to be the same as table a. This script will then be deployed to the live database.</p>\n\n<p>Any free tools out there that can do this, or better yet a way I can do it myself?</p>\n\n<p>I'm thinking I probably need to do some type of a join on all the fields in the tables, then generate dynamic SQL based on that.</p>\n\n<p>Anyone have any ideas?</p>\n\n<p><strong>EDIT</strong></p>\n\n<p>Okay, thought I'd clarify this question a little.</p>\n\n<p>The table I need to synchronize is a simple look-up table. The data is very simple and straightforward.</p>\n\n<p>Here's an idea of what <code>TABLE A</code> might look like:</p>\n\n<pre><code>IdFoo          Activity      IsFoo\n1              Foo           1\n2              Bar           0\n</code></pre>\n\n<p>Here's an idea of what <code>TABLE B</code> might look like:</p>\n\n<pre><code>IdFoo          Activity      IsFoo\n1              Foo           1\n2              Bar           1\n</code></pre>\n\n<p>Basically, all I want to do is update that <code>BIT</code> column (<code>IsFoo</code>) in <code>TABLE B</code> to match the corresponding value in <code>TABLE A</code> for the same IdFoo.</p>\n\n<p>Keep in mind:</p>\n\n<ul>\n<li><code>TABLE A</code> is on my local machine</li>\n<li><code>TABLE B</code> is on the live server</li>\n</ul>\n\n<p>Obviously I have a (reliable) backup of <code>TABLE B</code> on my local machine which i need to script against, then run the script on the live server.</p>\n\n<p>The table also has referential integrity (other columns I didn't show). Which means I can't just delete everything in <code>TABLE B</code> and do an insert from <code>TABLE A</code>.</p>\n\n<p>This script will be a once off. So no need to do things like linked server, replication, etc. Appreciate the answers though guys. =)</p>\n\n<p><strong>EDIT:</strong></p>\n\n<p>Ok - so I've gone with Oleg's answer (VS2010 Data Compare). Quick, easy, and works a charm.</p>\n\n<p>Not to say the other answers are incorrect. I appreciate all the answers!</p>\n"},{"tags":["sql-server-2008","tsql","join","rownumber"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":40,"score":1,"question_id":13175412,"title":"Return rows around row with a certain value with joins","body":"<p>I have fairly complicated join query from which I want to select a few rows around a result with a certain id.</p>\n\n<p>The query currently looks something like this:</p>\n\n<pre><code>WITH results AS \n  (\n    SELECT t1.id,  t1.position, t1.points, t2.name\n      ROW_NUMBER() OVER(ORDER BY t1.position ASC, t1.points DESC) AS rn\n      FROM Table1 t1\n      JOIN Table2 t2 ON t1.id = t2.Table1id\n      /* Several more joins here, some of which limit the result set */\n  )\nSELECT * FROM results\nWHERE rn &lt; ( SELECT rn+3 FROM results WHERE  id = @someid ) \nAND rn &gt; ( SELECT rn-3 FROM results WHERE id = @someid )\n</code></pre>\n\n<p>Is there a better way to solve this? Most of all I'm worried about performance with these multiple calls to a possibly huge CTE. </p>\n\n<p>The query is run on a <strong>SQL 2008</strong> server.</p>\n"},{"tags":["c#","sql","regex","tsql","like"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":1036,"score":2,"question_id":47052,"title":"What code would I use to convert a SQL like expression to a regex on the fly?","body":"<p>I'm looking to convert a SQL like statement on the fly to the equivalent regex i.e. </p>\n\n<p>LIKE '%this%'\nLIKE 'Sm_th'\nLIKE '[C-P]arsen'</p>\n\n<p>What's the best approach to doing this?</p>\n\n<p>P.S. I'm looking to do this on the .Net Framework (C#).</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":60,"score":1,"question_id":13174399,"title":"Coalesce vs Case","body":"<p>I have 5 fields which are bringing back a mixture of values and NULLS. For reporting purposes I need to replace any potential NULLS with a value. The database that I am interrogating is updated nightly via an SSIS package.</p>\n\n<p>Obviously I will need to alter the .dtsx file to stop NULLS being brought through each day by adding some SQL.</p>\n\n<p>My question is:</p>\n\n<p>What is the most efficient way of dealing with these NULLS in terms of performance. So far ive identified <code>COALESCE</code> and <code>CASE</code> to deal with them and im leaning towards <code>COALESCE</code> because my alternative to <code>NULL</code> is not going to change, but I would be interested to hear if and why this would be the most efficient method.</p>\n"},{"tags":["tsql","time","format","seconds"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":62,"score":2,"question_id":13177192,"title":"T-SQL Format seconds as HH:MM:SS time","body":"<p>Is there any tricky way to format seconds like hours:minutes:seconds. For example,</p>\n\n<blockquote>\n  <p>3660</p>\n</blockquote>\n\n<p>seconds will be displayed as </p>\n\n<blockquote>\n  <p>01h 01m 00s</p>\n</blockquote>\n\n<p>or</p>\n\n<blockquote>\n  <p>01:01:00</p>\n</blockquote>\n\n<p>I am aware of the standard way of doing this:</p>\n\n<ol>\n<li>Divide all seconds on 3600 to get the hours</li>\n<li>Divide the rest seconds on 60 to get the minutes</li>\n<li>The rest are the seconds</li>\n</ol>\n\n<p>I met the following issues:</p>\n\n<ol>\n<li><p>I am not able to create separate function that do this.</p></li>\n<li><p>My code is in view using several CTEs. So, variables can be declare\nusing the CTEs only.</p></li>\n<li>I am not able to use the standard solution because I will have\nresults  bigger then one day - <a href=\"http://stackoverflow.com/questions/1262497/how-to-convert-seconds-to-hhmmss-using-t-sql\">How to convert Seconds to HH:MM:SS using T-SQL</a></li>\n</ol>\n"},{"tags":["sql-server-2008","tsql","computed-columns"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":24,"score":1,"question_id":13173183,"title":"Find SQL Server 2008 computed column dependency","body":"<p>I want to search whether a columns is participating in a computed column expression. </p>\n\n<p>I came up with this </p>\n\n<pre><code>SELECT \n    (select name \n     from sys.columns \n     where column_id = sys.sql_expression_dependencies.referencing_minor_id \n     and object_id = sys.sql_expression_dependencies.referencing_id) as [dependant_column]\nFROM sys.sql_expression_dependencies\nWHERE referencing_minor_id &gt; 0 \n    and referencing_class = 1 \n    and referenced_class = 1 \n    and object_name(referencing_id) = 'trns1'\n    and referenced_minor_id = (select column_id \n                           from sys.columns \n                           where name = 'class1' \n                           and OBJECT_NAME(object_id) = 'trns1')\n</code></pre>\n\n<p>Please help.</p>\n"}]}
{"total":16599,"page":3,"pagesize":100,"questions":[{"tags":["asp.net","sql","asp.net-mvc","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":4510,"score":4,"question_id":2851754,"title":"IDENTITY_INSERT is set to off error","body":"<p>I have a MVC web application with a table in the model that I would like to add to.  I have the primary key set along with the other data fields, but every time I try to add to the table, I get the following error:</p>\n\n<p>\"Cannot insert explicit value for identity column in table 'TABLE_NAME' when IDENTITY_INSERT is set to OFF.\"</p>\n\n<p>I'm not sure why this problem is coming up, I have the primary key set as the identity and it is also set to auto increment in the Visual Studio table designer.  Is there any way I can adjust the IDENTITY_INSERT parameter in the table designer in Visual Studio??  Or is there some other issue that might be causing this.</p>\n\n<p>UPDATE:  @Brian - As far as I can tell, I'm not setting the value explicitly, here is the code that adds to the table(s).</p>\n\n<pre><code>//Add viewer\npublic void addViewer(ModelStateDictionary modelState, Users user)\n{\n   var userToAdd = new UserRoles();\n   userToAdd.Users = user;\n\n   if (String.IsNullOrEmpty(userToAdd.Users.Username))\n   {\n      modelState.AddModelError(\"noName\", \"Please enter a username for the new Viewer\");\n   }\n\n   //See if Committee Member already exists\n   try\n   {\n      userToAdd = _db.UserRoles.First(ur =&gt; ur.Users.Username == userToAdd.Users.Username);\n      modelState.AddModelError(\"userExists\", \"A Viewer with that username already exists in the system\");\n      return;\n    }\n    catch (Exception e)\n    {\n       if (modelState.IsValid)\n       {\n          //Assign Committee Member role\n          userToAdd.Role = \"Viewer\";\n          userToAdd.Users = user;\n          //Add new Committee Member to User Roles and associated username to Users\n          _db.AddToUserRoles(userToAdd);\n          _db.SaveChanges();\n       }\n    }\n}\n</code></pre>\n"},{"tags":["sql","tsql","sybase-ase"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13176975,"title":"moving a few rows from one table to another and rest to some other","body":"<p>I have some staging table to bcp some data from a file to db.<br>\nNow from this table i want to copy some 'valid' data to another table, while all other (some invalid, some duplicate) data to another 'error' table.<br>\nCan I have someway to do this using some query/stored procedure in Sybase-ASE.<br>\n(it would be great if i can use the same thing in oracle as well)</p>\n"},{"tags":["sql","sql-server","tsql","variables","select"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":70,"score":-2,"question_id":13165594,"title":"In SQL Server, is there a way to get a single value from an identity column and repeatedly use it in the same scope?","body":"<p>It's kind of hard to word the question in the title.  Let's say you have a table called Users, and let's say it has an identity / primary key column called \"Id\".  Let's say you want to, in the same transaction, get what you know will only be one instance of Id that falls within a fairly specific WHERE clause or something, then recycle it repeatedly in a very lengthy SELECT statement that's executed immediately afterwards.  Can this be done in SQL Server?  Basically what I'm trying to avoid is something like the following:</p>\n\n<pre><code>Dim id As Int32 = DBA.OneTimeQuery(\"SELECT Id FROM users &lt;where clause&gt;\").Rows(0)(0)\nReturn DBA.OneTimeQuery(\"SELECT &lt;a lot of different things, involving multiple sub\n    -selects that have to pull from the variable id&gt;\")\n'DBA.OneTimeQuery returns a DataTable\n</code></pre>\n\n<p>I know I can avoid using two different connections or whatever by recycling the first where clause, but it's pretty wasteful to have even the same connection and transaction keep re-finding the same exact piece of information.</p>\n\n<p>I want to avoid having Sql Server search for that single value from the Id column more than once, and I also want to be able to put it in the same Sql transaction and connection.  How can this be done?  Thanks!</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":44,"score":2,"question_id":13174208,"title":"SQL reverse column value query","body":"<p>Need some Sql help? My Sql is not quite up to this yet.\nI have a table </p>\n\n<pre><code>ColA    ColB    ColC\nA       B       101\nB       B       102\nC       B       102\nB       A       108\n</code></pre>\n\n<p>I need to be able identify the values in ColC where the rows that have the same entry in  Col A and Col B (but reversed) i.e  where Col B = Col A.  But not like row three where Col B corresponding value  has no match or row two where Col A = Col B.</p>\n\n<p>The results set would be  </p>\n\n<pre><code>Col A      Col B     Col C\nA          B         101\nB          A         108\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":13173615,"title":"Normalizing values in SQL query","body":"<p>I have an data table I wish to perform some numeric analysis on for that I need all the values to be in the same range. 0..1.</p>\n\n<p>I have a somewhat slow and longhanded way of accomplishing this but would like a more straigt forward performant solution to my problem</p>\n\n<p>What I need to do is:</p>\n\n<p>group by projectid\nwith in each project take the average of each of the values and divide by the largest average for the entire set.</p>\n\n<p>currently I have</p>\n\n<pre><code>select avg(foo * 1.0)/ (Select MAX(IL) FROM (select avg(foo * 1.0) as IL from table group by     \n                                             ProjectID) tbl)\nfrom table\n</code></pre>\n\n<p>so if the list is</p>\n\n<pre><code>projectid  | foo\n-----------------\n1          | 1\n1          | 2\n2          | 4\n2          | 2\n</code></pre>\n\n<p>the largest average is 3 and the result should therefor be</p>\n\n<p>0.5,1</p>\n\n<p>where the first is the average for projectId 1 divided by 3 and the second is the average for projectId 2 divided by 3</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":38,"score":4,"question_id":13173921,"title":"Why is T-SQL EXEC not returning decimals?","body":"<p>I have a simple query that I've turned into a stored proc:</p>\n\n<pre><code>create procedure GetAmount as\ndeclare @amnt decimal(25,2)\n\nselect @amnt=66666.67 \nset @amnt = @amnt/3.00\n\nprint @amnt\nreturn @amnt\n</code></pre>\n\n<p>If I print @amnt, it returns 22222.22</p>\n\n<p>But if I use EXEC and assign it to a variable:</p>\n\n<pre><code>declare @x numeric(25,2)\nexec @x=SP_GetAmount()\nprint @x\n</code></pre>\n\n<p>it returns 22222.00</p>\n\n<p>Anyone know why? </p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":100,"score":5,"question_id":13158944,"title":"\"Incorrect syntax\" error using OVER()","body":"<p>I have a sales budget for every trading day of the month.  So for day 1 the budget is 300, for day 2 the budget is 400, and then month to date budget is 700.  I get this error in my query:  <code>Incorrect syntax near 'ROWS'.</code></p>\n\n<pre><code>select \nTradingDate\n,Budget\n,sum(Budget) over (PARTITION BY TradingDate\norder by TradingDate asc\nROWS BETWEEN CURRENT ROW AND 1 FOLLOWING),1) AS BudgetMTD\nfrom #4\n</code></pre>\n"},{"tags":["tsql","datediff","age"],"answer_count":10,"favorite_count":5,"up_vote_count":21,"down_vote_count":0,"view_count":30051,"score":21,"question_id":57599,"title":"How to calculate age in T-SQL with years, months, and days","body":"<p>What would be the best way to calculate someone's age in years, months, and days in T-SQL (SQL Server 2000)?</p>\n\n<p>The <code>datediff</code> function doesn't handle year boundaries well, plus getting the months and days separate will be a bear.  I know I can do it on the client side relatively easily, but I'd like to have it done in my <a href=\"http://en.wikipedia.org/wiki/Stored_procedure\">stored procedure</a>.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":40,"score":1,"question_id":13170371,"title":"Easier way to compare a DATE field to the date value of GETDATE?","body":"<p>I have a field in a table <code>Event.EventDate</code> and it's of the data type <code>DATE</code> rather than <code>DATETIME</code> and then I have a view that has the following <code>WHERE</code> clause:</p>\n\n<pre><code>WHERE e.EventDate &gt;= CAST(CONVERT(VARCHAR(MAX), GETDATE(), 101) AS DATETIME)\n</code></pre>\n\n<p>As you can see, I'm just trying to get all events <code>&gt;=</code> today's <strong>date</strong>. The above code works, but it's ugly. I tried this ...</p>\n\n<pre><code>WHERE e.EventDate &gt;= CONVERT(VARCHAR(MAX), GETDATE(), 101)\n</code></pre>\n\n<p>... and this ...</p>\n\n<pre><code>WHERE e.EventDate &gt;= CONVERT(DATETIME, GETDATE(), 101)\n</code></pre>\n\n<p>... but those didn't work, they gave me every event <code>&gt;</code> today's <strong>date</strong>. However, even if the above worked, it's still ugly.</p>\n\n<p>Isn't there a better way?</p>\n"},{"tags":["mysql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":13168362,"title":"Tricky SQL query - need to get time frames","body":"<p>I am stumbled upon a problem, when I need a query which will produce a list of speeding time frames.</p>\n\n<p>Here is the data example </p>\n\n<pre><code>[idgps_unit_location]   [dt]    [idgps_unit]    [lat]   [long]  [speed_kmh]\n26  10/18/2012 18:53    2   47  56  30\n27  10/18/2012 18:53    2   49  58  31\n28  10/18/2012 18:53    2   28  37  15\n29  10/18/2012 18:54    2   56  65  33\n30  10/18/2012 18:54    2   152 161 73\n31  10/18/2012 18:55    2   134 143 64\n32  10/18/2012 18:56    2   22  31  12\n36  10/18/2012 18:59    2   98  107 47\n37  10/18/2012 18:59    2   122 131 58\n38  10/18/2012 18:59    2   91  100 44\n39  10/18/2012 19:00    2   190 199 98\n40  10/18/2012 19:01    2   194 203 101\n41  10/18/2012 19:02    2   182 191 91\n42  10/18/2012 19:03    2   162 171 78\n43  10/18/2012 19:03    2   174 183 83\n44  10/18/2012 19:04    2   170 179 81\n45  10/18/2012 19:05    2   189 198 97\n46  10/18/2012 19:06    2   20  29  10\n47  10/18/2012 19:07    2   158 167 76\n48  10/18/2012 19:08    2   135 144 64\n49  10/18/2012 19:08    2   166 175 79\n50  10/18/2012 19:09    2   9   18  5\n51  10/18/2012 19:09    2   101 110 48\n52  10/18/2012 19:09    2   10  19  7\n53  10/18/2012 19:10    2   32  41  20\n54  10/18/2012 19:10    1   54  63  85\n55  10/19/2012 19:11    2   55  64  50\n</code></pre>\n\n<p>I need a query that would convert this table into the following report that shows frames of time when speed was >80:</p>\n\n<pre><code>[idgps_unit]    [dt_start]  [lat_start] [long_start]    [speed_start]   [dt_end]    [lat_end]   [long_end]  [speed_end] [speed_average]\n2   10/18/2012 19:00    190 199 98  10/18/2012 19:02    182 191 91  96.66666667\n2   10/18/2012 19:03    174 183 83  10/18/2012 19:05    189 198 97  87\n1   10/18/2012 19:10    54  63  85  10/18/2012 19:10    54  63  85  85\n</code></pre>\n\n<p>Now, what have I tried? I tried putting this into separate tables, queries and do some joins... Nothing works and I am very frustrated... I am not even sure if this could be done via the query. Asking for the expert help!</p>\n"},{"tags":["sql-server","tsql","escaping","character","like-operator"],"answer_count":5,"favorite_count":0,"up_vote_count":10,"down_vote_count":0,"view_count":6064,"score":10,"question_id":439495,"title":"How can I escape square brackets in a LIKE clause?","body":"<p>I am trying to filter items with a stored procedure using like. The column is a varchar(15). The items I am trying to filter have square brackets in the name.</p>\n\n<p>For example:  <code>WC[R]S123456</code>.</p>\n\n<p>If I do a <code>LIKE 'WC[R]S123456'</code> it will not return anything.</p>\n\n<p>I found some information on using the <code>ESCAPE</code> keyword with <code>LIKE</code> but I do not understand how to use it to treat the square brackets as a regular string.</p>\n"},{"tags":["sql","tsql"],"answer_count":8,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":10493,"score":2,"question_id":420741,"title":"Getting list of tables, and fields in each, in a database","body":"<p>I'm looking at creating a basic ORM (purely for fun), and was wondering, is there a way to return the list of tables in a database and also the fields for every table?</p>\n\n<p>Using this, I want to be able to loop through the result set (in C#) and then say for each table in the result set, do this (e.g. use reflection to make a class that will do or contain xyz).</p>\n\n<p>Further to this, what are some good online blogs for SQL Server? I know this question is really about using system SPs and databases in Sql Server, and I am ok with general queries, so I'm interested in some blogs which cover this sort of functionality.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","tsql","sql-server-2008"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":562,"score":2,"question_id":5711518,"title":"how to get the max size used by a field in table","body":"<p>I have a field which has been set to max size. How can i find the max size occupied by the field.</p>\n\n<p>For example if the records are for table TableA</p>\n\n<pre><code>FieldA\n\n123\nabcd\n1234567\n</code></pre>\n\n<p>I need to know which row occupied the most size and what the size is</p>\n\n<p>Thanks</p>\n\n<p>Prady</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":72,"score":1,"question_id":13156038,"title":"Speed up dividing date intervals by minutes in Sql Server","body":"<p>I need to divide some date intervals by minutes. (For example, 2012-01-01 10:00 - 2012-01-01 10:00 interval should be divided into 2012-01-01 10:01, 2012-01-01 10:02, ... 2012-01-01 10:10).\nFor example, there is a table</p>\n\n<pre><code>CREATE TABLE [dbo].[Events](\n    [ID] [int] IDENTITY(1,1) NOT NULL,\n    [EventStart] [datetime] NOT NULL,\n    [EventEnd] [datetime] NOT NULL,\n    [Amount] [float] NOT NULL,\n CONSTRAINT [PK_Events] PRIMARY KEY CLUSTERED \n(\n    [ID] ASC\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]\n) ON [PRIMARY]\n\nGO\n</code></pre>\n\n<p>This table is filled like</p>\n\n<pre><code>DECLARE @i integer = 0;\nDECLARE @initial_date datetime = '2012-01-01';\n\nWHILE @i &lt; 50000\nBEGIN\n    INSERT INTO [Events] (EventStart, EventEnd, Amount) VALUES (DATEADD(MINUTE, 10*@i, @initial_date), DATEADD(MINUTE, 10*(@i + 1), @initial_date), @i);\n    SET @i = @i + 1;\nEND\n</code></pre>\n\n<p>As a result we have many 10 minutes intervals.</p>\n\n<p>To divide it by minutes I use the following recursive CTE:</p>\n\n<pre><code>DECLARE @start_date datetime = '2012-01-01';\nDECLARE @end_date datetime = '2013-01-02';\n\n\nWITH Date_Ranges (StatDate, Amount, IntervalStart, CurrentMinute) AS (\n  SELECT \n    DATEADD(MINUTE, 0,  ev.EventStart) AS StatDate, ev.Amount, ev.EventStart AS IntervalStart, 1 AS CurrentMinute\n  FROM [Events] ev\n  WHERE ev.EventStart BETWEEN @start_date AND @end_date\n  UNION ALL\n  SELECT \n    DATEADD(MINUTE, CurrentMinute, ev.EventStart), ev.Amount, ev.EventStart AS IntervalStart, CurrentMinute + 1\n  FROM [Events] ev\n  INNER JOIN Date_Ranges ranges ON (ranges.IntervalStart = ev.EventStart AND \n    ranges.StatDate &gt;= ev.EventStart AND \n    ranges.StatDate &lt; ev.EventEnd)\n    WHERE DATEADD(MINUTE, CurrentMinute, ev.EventStart) BETWEEN @start_date AND @end_date AND\n        ev.EventStart BETWEEN @start_date AND @end_date\n) \n\nSELECT *\nFROM Date_Ranges --ORDER BY StatDate\n</code></pre>\n\n<p>The main problem is too slow execution of this recursive CTE on a large data amount.</p>\n\n<p>So, how can I speed up this?</p>\n"},{"tags":["sql-server","regex","tsql"],"answer_count":4,"favorite_count":4,"up_vote_count":30,"down_vote_count":2,"view_count":20551,"score":28,"question_id":194652,"title":"SQL Server Regular expressions in T-SQL","body":"<p>Is there any regular expression library written in <em>T-SQL</em> (no CLR, no extended sp, pure t-sql) for SQL Server?</p>\n\n<p>(should work with shared hosting)</p>\n\n<p>Edit:</p>\n\n<ul>\n<li><p>thanks I know about PATINDEX, LIKE, xp_ sps and CLR solutions</p></li>\n<li><p>I also know it is not the best place for regex, the question is theoretical:)</p></li>\n<li><p>reduced functionality is also accepted</p></li>\n</ul>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13165957,"title":"Trouble integrating a where clause into an existing select statement for reporting purposes","body":"<p>So, I have two queries - one that currently creates a report, and another query I wrote to append more data to the report.</p>\n\n<p>I'd like to merge the new query so the data shows in the same dataset when I call to it in ASP.</p>\n\n<p>I'm having trouble placing the new where clause so that it gives me only what I want. The queries work on their own but I just can't seem to figure out how to get them together without giving me a ton of extra data I'm not looking for.</p>\n\n<p>Here is the original query:</p>\n\n<pre><code>SELECT \ntransactions.date,\ntransactions.Pcode,\ntransactions.L,\ntransactions.iL,  \ntransactions.q,\ntransactions.mTo\nFROM\ntransactions, \nproductlist\nWHERE\ntransactions.Pcode=productlist.Pcode \nAND productlist.client=transactions.client \nAND (transactions.mTo='NotAccepted' OR transactions.mTo = 'TheStage') \nAND transactions.client=232 AND ( tophysical = 'Place1' OR fromphysical = 'Place1' ) \nAND transactions.Date&gt;= '2012-10-01' \nAND transactions.Date &lt;= '2012-10-31 11:59:59 PM ' \nORDER BY\nmTo,\ntransactions.date,\ntransactions.pCode\n</code></pre>\n\n<p>The query I want to integrate is:</p>\n\n<pre><code>SELECT \ntransactions.date,\ntransactions.pcode,\ntransactions.L,\ntransactions.iL,  \ntransactions.qty,\ntransactions.mTo,\nFROM\ntransactions, \nproductlist,\nproductarchive,\nShipping\nWHERE \ntransactions.pcode=productlist.pcode \nAND productlist.client=transactions.client \nAND transactions.mFrom='NotAccepted'\nAND ProductArchive.TrID=Transactions.ID\nAND ProductArchive.StID = Shipping.ID\nAND Shipping.SID LIKE 'BAG%'\nAND transactions.Date&gt;= '2012-10-01' \nAND transactions.Date &lt;= '2012-10-31 11:59:59 PM ' \n</code></pre>\n\n<p>Final Query I came up with that's giving me tens of thousands more records than I want.</p>\n\n<pre><code>SELECT \ntransactions.date,\ntransactions.pCode,\ntransactions.L,\ntransactions.iL,  \ntransactions.q,\ntransactions.mTo\nFROM\ntransactions, \nproductlist, \nshipping,\nProductArchive\nWHERE \ntransactions.pCode=productlist.pCode \nAND productlist.client=transactions.client \nAND (transactions.mTo='NotAccepted' OR transactions.mTo = 'TheStage' OR transactions.mFrom='NotAccepted') \nAND transactions.client=232 \nAND \n( tophysical = 'Place1' OR fromphysical = 'Place1' OR \n    ( ProductArchive.TransID=Transactions.ID\n        AND ProductArchive.StID = Shipping.ID\n        AND Shipping.SID LIKE 'BAG%') \n)\nAND transactions.Date&gt;= '2012-10-01' \nAND transactions.Date &lt;= '2012-10-31 11:59:59 PM ' \nORDER BY\ntransactions.mTo,\ntransactions.date,\ntransactions.pCode\n</code></pre>\n\n<p>Thanks for your time, energy and help! Deeply appreciated :)</p>\n"},{"tags":["sql-server","tsql","function"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":42,"score":3,"question_id":13166048,"title":"Execute WITH statement inside a function","body":"<p>I have the following code:</p>\n\n<pre><code>WITH OrderedOrders AS\n(\n\nSELECT *,  ROW_NUMBER() OVER (ORDER BY item) AS RowNumber\n from  dbo.fnSplit('1:2:3:5', ':')  \n)\n\n select * from OrderedOrders where rownumber =2\n</code></pre>\n\n<p>I need to run this code inside a function, however I just can't make the syntax right. Here's how it is right now:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[FN_INDICE_SPLIT]\n    (@sInputList VARCHAR(8000),@sDelimiter VARCHAR(8000),@INDICE INT)\n\nRETURN TABLE \n\n\n;WITH OrderedOrders AS\n( \nSELECT *,  ROW_NUMBER() OVER (ORDER BY item) AS RowNumber\n from  dbo.fnSplit(@sDelimiter, @INDICE)  \n)\nselect ITEM from OrderedOrders where RowNumber=@INDICE\n</code></pre>\n\n<p>If I try to execute this, it gives me this error:</p>\n\n<pre><code>Msg 156, Level 15, State 1, Procedure FN_INDICE_SPLIT, Line 4\nIncorrect syntax near the keyword 'RETURN'.\n</code></pre>\n\n<p>I've tried to do this in many ways, but I keep getting syntax errors and I don't know what's wrong.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","string-to-datetime"],"answer_count":10,"favorite_count":4,"up_vote_count":16,"down_vote_count":0,"view_count":81423,"score":16,"question_id":207190,"title":"Sql Server string to date conversion","body":"<p>I want to convert a string like this:</p>\n\n<pre><code>'10/15/2008 10:06:32 PM'\n</code></pre>\n\n<p>into the equivalent DATETIME value in Sql Server.</p>\n\n<p>In Oracle, I would say this:</p>\n\n<pre><code>TO_DATE('10/15/2008 10:06:32 PM','MM/DD/YYYY HH:MI:SS AM')\n</code></pre>\n\n<p><a href=\"http://stackoverflow.com/questions/202243/custom-datetime-formatting-in-sql-server\">This question</a> implies that I must parse the string into one of the <a href=\"http://msdn.microsoft.com/en-us/library/aa226054(SQL.80).aspx\" rel=\"nofollow\">standard formats</a>, and then convert using one of those codes.  That seems ludicrous for such a mundane operation.  Is there an easier way?</p>\n"},{"tags":["sql-server","tsql","comparison","null"],"answer_count":2,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":1098,"score":6,"question_id":3110980,"title":"Efficient way to compare for a NULL or value for a column in SQL","body":"<p>What's the efficient way to check for a null or value for a column in SQL query. Consider a sql table <code>table</code> with integer column <code>column</code> which has an index. <code>@value</code> can be some integer or null ex: 16 or null. </p>\n\n<p>Query 1: Not sure, but it seems one should not rely on the short-circuit in SQL. However, below query always works correctly when <code>@value</code> is some integer or null. </p>\n\n<pre><code>select * from\ntable\nwhere (@value is null or column = @value)\n</code></pre>\n\n<p>The below query is an expanded version of the above query. It works correctly too. </p>\n\n<pre><code>select * from \ntable \nwhere ((@value is null) \n    or (@value is not null and column = @value))\n</code></pre>\n\n<p>Would the above 2 queries would take the advantage of the index?</p>\n\n<p>Query 2: The below query compares the column with non-null <code>@value</code> else compares the column <code>column</code> with itself which will always be true and returns everything. It works correctly too. Would this query take advantage of the index?</p>\n\n<pre><code>select * from\ntable\nwhere (column = isnull(@value, column))\n</code></pre>\n\n<p>What's the best way? </p>\n\n<p>Note: If the answer varies with databases, I'm interested in MS-SQL. </p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13162953,"title":"Simple query return the same register","body":"<p>I have a problem with the return of a simple query </p>\n\n<p><strong>Table San_ChaveBematech</strong></p>\n\n<pre><code>ID     Chave_Id     Credenciada_Id    Recibo   Impresso\n55     571678       10                Test     0\n</code></pre>\n\n<p><strong>Table San_CadastraBematech</strong></p>\n\n<pre><code>ID     Maquina          Credenciada\n5      000FEAB63D89     10\n6      003067D6A4E7     10\n7      003067D6A4D4     10\n</code></pre>\n\n<p><strong>Query That I has some problem</strong></p>\n\n<pre><code>SELECT San_ChaveBematech.Recibo\nFROM San_ChaveBematech\nJOIN San_CadastraBematech\nON San_ChaveBematech.Credenciada_Id = San_CadastraBematech.Credenciada\nWHERE San_ChaveBematech.Credenciada_Id = \n       (SELECT top 1 credenciada \n        FROM San_CadastraBematech \n        WHERE maquina = '000FEAB63D89')\nAND San_ChaveBematech.Impresso = 0\n</code></pre>\n\n<p><strong>How It Works</strong></p>\n\n<p>I have an application (Windows Form) where my user will be registered. I'll save her register in my <code>San_CadastraBematech</code> table. In my web application I can get some keys and, when I get it, I'll save the data in <code>San_ChaveBematech</code> table. To print it, I do the query that I put here, but look, I have just one register in <code>San_ChaveBematech</code> but my query return the same register 3 times.</p>\n\n<p>Can somebody help me ?</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":45,"score":3,"question_id":13163139,"title":"Sort by Character column 'priority' in sql","body":"<p>I have a table with a coulmn name priority with values :</p>\n\n<pre><code>Urgent, medium, low, high.\n</code></pre>\n\n<p>I want to apply order by such that after order by values are ordered like this:</p>\n\n<pre><code>urgent\nhigh \nmedium\nlow\n</code></pre>\n\n<p>How can I do This</p>\n"},{"tags":["tsql","table","insert","ssms"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13161522,"title":"Inserting a record into Top of Table","body":"<p>Stack Overflow SQL Experts,</p>\n\n<p>Hopefully an easy question for someone with more experience than me. I have a stored procedure that Inserts records into a table. Like all databases that I have worked with, when you insert a record it inserts it into the bottom of the table. I would like to insert it to the top of the table and then move all the existing records down by one (i assume this would happen automatically with the insert)</p>\n\n<p>I want to to do this because I'm using the 'Top #' keyword. I am pretty sure that I could just leave it the way it is, and instead of using the 'Top\" keyword, I could use the 'Bottom\" keyword. But I want to make it easier for people reading it that aren't familiar with it, so they can instantly see the newest entries. I'm going to keep researching this on my own, but If someone knew off the top of their head and could save me the time that would be appreciated. </p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13161986,"title":"\"Incorrect syntax\" error when GRANTing permission to a username containing dots","body":"<p>We are trying to grant an EXECUTE role on a stored procedure, however the following command</p>\n\n<pre><code>GRANT EXECUTE ON dbo.sp_AgentIdAprCheck TO s.AgentData.Dev\n</code></pre>\n\n<p>Keeps giving us the following error (it doesn't like the first period): </p>\n\n<pre><code>Incorrect syntax near 's.AgentData.Dev'.\n</code></pre>\n\n<p>The user account needs to be written as we have it though. Can anyone offer any suggestions? </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":37,"score":2,"question_id":13161044,"title":"Checking if a given date fits between a range of dates","body":"<p>If I have 2 date columns in a table, <code>startDate</code> and <code>endDate</code>.  How do I return rows where a given date fits between those 2 dates?  For example:</p>\n\n<p>If the given date is <code>2012-10-25</code></p>\n\n<p>It should return the following rows</p>\n\n<pre><code>startDate   -   endDate\n2012-10-25  -   2012-10-25\n2011-09-10  -   2013-11-15\n2012-10-20  -   2012-10-25\n2012-10-23  -   2012-10-28\n2012-09-14  -   2012-10-28\n</code></pre>\n\n<p>from the following rows:</p>\n\n<pre><code>startDate   -   endDate\n2012-10-25  -   2012-10-25\n2011-09-10  -   2013-11-15\n2012-01-11  -   2012-10-11\n2012-10-20  -   2012-10-25\n2012-04-15  -   2012-04-16\n2012-05-20  -   2012-05-25\n2012-12-01  -   2012-12-10\n2012-10-23  -   2012-10-28\n2012-09-14  -   2012-10-28\n2012-11-13  -   2012-12-15\n</code></pre>\n\n<p>Is this possible with sql?</p>\n\n<p>I am using sql server 2008.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":87,"score":2,"question_id":13161264,"title":"Arithmetic overflow error converting varchar to data type numeric. '10' <= 9.00","body":"<p>Below is a subset of the kind of table structure and data i'm working with.</p>\n\n<pre><code>CREATE TABLE #Test\n(\n     Val varchar(5)\n    ,Type varchar(5)\n)\n\nINSERT #Test VALUES ('Yes','Text')\nINSERT #Test VALUES ('10','Int')\nINSERT #Test VALUES ('10.00','Float')\nINSERT #Test VALUES ('9.00','Float')\nINSERT #Test VALUES ('9','Int')\n</code></pre>\n\n<p>I want to write a query that will let me know if the column 'Val' is &lt;= 9.00 (must be of numeric data type). I did this by doing the following:</p>\n\n<pre><code>SELECT *\nFROM\n    (\n        SELECT Val\n        FROM #Test\n        WHERE Type = 'Int'\n    ) IntsOnly\nWHERE IntsOnly.Val &lt;= 9.00\n</code></pre>\n\n<p>This gives me an arithmetic overflow error. However, if I exclude the row of data with the value '10':</p>\n\n<pre><code>SELECT *\nFROM\n    (\n        SELECT Val\n        FROM #Test\n        WHERE Type = 'Int'\n        AND Val &lt;&gt; '10'\n    ) IntsOnly\nWHERE IntsOnly.Val &lt;= 9.00\n</code></pre>\n\n<p>It works without any issue. <strong>My question is not how to fix this as I know I can simply convert the data to the format I require.</strong></p>\n\n<p>My question is why the value of '10' in the column 'Val' is returning an error. Surely the logic should just return 'False' and simply exclude the rows because '10' (which I assume is implicitly converted) is greater than 9.00.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":5,"favorite_count":21,"up_vote_count":38,"down_vote_count":0,"view_count":29940,"score":38,"question_id":43249,"title":"T-SQL stored procedure that accepts multiple Id values","body":"<p>Is there a graceful way to handle passing a list of ids as a parameter to a stored procedure.  For instance, I want departments 1, 2, 5, 7, 20 returned by my stored procedure.  In the past, I have passed in a comma delimited list of ids, like the below code, but feel really dirty doing it.  SQL Server 2005 is my only applicable limitation I think.</p>\n\n<pre><code>create procedure getDepartments\n        @DepartmentIds varchar(max)\nas\n    \tdeclare @Sql varchar(max)\n\n    \tselect @Sql = 'select [Name] from Department where DepartmentId in (' + @DepartmentIds + ')'\n\n    \texec(@Sql)\n</code></pre>\n"},{"tags":["sql-server","tsql","triggers"],"answer_count":7,"favorite_count":10,"up_vote_count":26,"down_vote_count":0,"view_count":54216,"score":26,"question_id":741414,"title":"Insert Update trigger how to determine if insert or update","body":"<p>I need to write an Insert, Update Trigger on table A which will delete all rows from table B whose one column (say Desc) has values like the value inserted/updated in the table A's column (say Col1). How would I go around writing it so that I can handle both Update and Insert cases. How would I determine if the trigger is executed for an update or insert.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","hierarchy"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":13158857,"title":"How to query and parse adjacent list hierarchy using cte?","body":"<p>How can I query this parent-child hierarchy to produce a result set in which the levels are in their own columns? Sample data:</p>\n\n<pre><code>SET NOCOUNT ON;\nUSE Tempdb;\n\nIF OBJECT_ID('dbo.Employees', 'U') IS NOT NULL DROP TABLE dbo.Employees;\n\nCREATE TABLE dbo.Employees\n(\n  empid   INT         NOT NULL PRIMARY KEY,\n  mgrid   INT         NULL     REFERENCES dbo.Employees,\n  empname VARCHAR(25) NOT NULL,\n  salary  MONEY       NOT NULL,\n  CHECK (empid &lt;&gt; mgrid),\n  CHECK (empid &gt; 0)\n);\n\nCREATE UNIQUE INDEX idx_unc_mgrid_empid ON dbo.Employees(mgrid, empid);\n\nINSERT INTO dbo.Employees(empid, mgrid, empname, salary) VALUES\n  (1,  NULL, 'David'  , $10000.00),\n  (2,  1,    'Eitan'  ,  $7000.00),\n  (3,  1,    'Ina'    ,  $7500.00),\n  (4,  2,    'Seraph' ,  $5000.00),\n  (5,  2,    'Jiru'   ,  $5500.00),\n  (6,  2,    'Steve'  ,  $4500.00),\n  (7,  3,    'Aaron'  ,  $5000.00),\n  (8,  5,    'Lilach' ,  $3500.00),\n  (9,  7,    'Rita'   ,  $3000.00),\n  (10, 5,    'Sean'   ,  $3000.00),\n  (11, 7,    'Gabriel',  $3000.00),\n  (12, 9,    'Emilia' ,  $2000.00),\n  (13, 9,    'Michael',  $2000.00),\n  (14, 9,    'Didi'   ,  $1500.00);\n\nselect * from dbo.Employees\ngo     \n\n;WITH Tree (empid, mgrid, lv)\nAS (\n\nSELECT empid, mgrid, 1\nFROM Employees\nWHERE mgrid IS NULL \n\nUNION ALL\n\nSELECT E.empid, E.mgrid, lv + 1\nFROM Employees AS E\nJOIN Tree\nON E.mgrid= Tree.empid\n)\nSELECT empid, mgrid, lv\nFROM Tree\nORDER BY Lv, empid\n</code></pre>\n\n<p>The resulting table should have a structure like</p>\n\n<pre><code>+-------+-----+--------+--------+--------+--------+--------+\n| empid | lvl | level1 | level2 | level3 | level4 | level5 |\n+-------+-----+--------+--------+--------+--------+--------+\n|     1 |   1 |      1 | NULL   | NULL   | NULL   | NULL   |\n|     2 |   2 |      1 | 2      | NULL   | NULL   | NULL   |\n|     3 |   2 |      1 | 3      | NULL   | NULL   | NULL   |\n|     4 |   3 |      1 | 2      | 4      | NULL   | NULL   |\n|     5 |   3 |      1 | 2      | 5      | NULL   | NULL   |\n|     6 |   3 |      1 | 2      | 6      | NULL   | NULL   |\n|     7 |   3 |      1 | 3      | 7      | NULL   | NULL   |\n|     8 |   4 |      1 | 2      | 5      | 8      | NULL   |\n|     9 |   4 |      1 | 3      | 7      | 9      | NULL   |\n|    10 |   4 |      1 | 2      | 5      | 10     | NULL   |\n|    11 |   4 |      1 | 3      | 7      | 11     | NULL   |\n|    12 |   5 |      1 | 3      | 7      | 9      | 12     |\n|    13 |   5 |      1 | 3      | 7      | 9      | 13     |\n|    14 |   5 |      1 | 3      | 7      | 9      | 14     |\n+-------+-----+--------+--------+--------+--------+--------+\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","database-performance"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":1,"view_count":42,"score":-1,"question_id":13158751,"title":"When is a database considered a 'large database'?","body":"<p>I have a SQL Server 2008 database, with a single table with apprx 50 columns. Primary key is a datetime. No normalisation further possible, it is simply a table storing values from different sensors every couple of seconds, so ints and decimals. \nSo now, for the past month I have close to 560k rows inserted.\nMy question is, when would I start to see performance problems due to too much data? </p>\n\n<p>To be more specific: \nMy requirement so far is to display(in a chart) the last month(not an issue for this question). If I always get from the DB only the last month, a query filtered by the PK(so indexed), does it matter how big the table gets?</p>\n\n<p>Ups, long rant :) Thanks for the input!</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","query-optimization"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13158956,"title":"UDF performance suddenly degraded","body":"<p>SQL Server 2008 R2</p>\n\n<p>I know this is a common problem (eg: <a href=\"http://connect.microsoft.com/SQLServer/feedback/details/524983/user-defined-function-performance-is-unacceptable\" rel=\"nofollow\">http://connect.microsoft.com/SQLServer/feedback/details/524983/user-defined-function-performance-is-unacceptable</a>) - but ive only just learned of it.</p>\n\n<p>We have a live production database that has performed fine for months, specifically a stored procedure that contains a large CTE that selects into a table variable. Then, based on a parameter on the procedure - data is selected from the table variable in various ways (column sequence, order by clause etc).</p>\n\n<p>This temporary table only has a few hundred rows inserted into it from the CTE - the source data is huge, but the resulting rows are always low in number)</p>\n\n<p>The select satements used on the table variable use 2 very simple UDF's:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[format_timeV2] ( @Time INT )\nRETURNS VARCHAR(20)\nAS \n    BEGIN\n        DECLARE @Time_Varchar VARCHAR(20)\n        SET @Time_Varchar = CONVERT(VARCHAR, @Time / 3600) + 'h ' + CONVERT(VARCHAR, ROUND(( ( CONVERT(FLOAT, ( @Time % 3600 )) ) / 3600 ) * 60, 0)) + 'm'\n        RETURN @Time_Varchar\n    END\nGO\n</code></pre>\n\n<p>And</p>\n\n<pre><code>CREATE FUNCTION [dbo].[udf_WeekEndDate] ( @Date DATETIME )\nRETURNS DATETIME\nAS \n    BEGIN\n        RETURN DATEADD(DAY, 7, CONVERT(DATETIME, CONVERT(VARCHAR(10), DATEADD(day, -1 - ( DATEPART(dw, @Date) + @@DATEFIRST - 2 ) % 7, @Date), 103) + ' 23:59:59', 103))\n    END\nGO\n</code></pre>\n\n<p>These UDF's have been working fine for months, if not years, the stored procedure in question has ALWAYS ran in under 6 seconds - but as soon as the UDF's above are included on the SELECT statement of the table variable the procedure takes MINUTES!</p>\n\n<p>As soon as we comment out the usage of these functions it returns to executing in 3-6 seconds.</p>\n\n<p>These functions are only being used on the <code>SELECT</code> from <code>@TableVar</code> statement (few hundred rows) - so i dont see why the query optimiser if struggling here?!?!</p>\n\n<p>If we run the following - the UDF's and procedure start to work normally again:</p>\n\n<pre><code>DBCC FreeProcCache\nDBCC DropCleanbuffers\n</code></pre>\n\n<p>So i can only assume the query optimiser is doing something stupid in the background - but it's not clear on the execution plan as to what it is.</p>\n\n<p>I have tried recreating the proc with <code>RECOMPILE</code> - this didnt help, only <code>FreeProcCache</code> &amp; <code>DropCleanbuffers</code> helped.</p>\n\n<p>Any ideas what the root cause of this? we dont really want to go re-writing all the UDFs as table valued function (which i understand is a work around for this problem) as this is a live production database which has been working fine for years.</p>\n\n<p><strong>EDIT 1:</strong> Blam requested detail of the actual query that hangs:</p>\n\n<pre><code>    IF @ModeInt = 2 \n        SELECT  [DET_NUMBERA] ,\n                [Name] ,\n                [Branch] ,\n                COUNT(*) OVER ( PARTITION BY [DET_NUMBERA] ) AS RowsForThisEmployee ,\n                CONVERT(VARCHAR(10), dbo.udf_WeekEndDate([Date]), 103) AS [WeekEnding] ,\n                [Date] ,\n                [Start Time] ,\n                [End Time] ,\n                [Duration] ,\n                dbo.format_timeV2([Duration] * 60) AS [DurationF] ,\n                [EntryCount] ,\n                [EntryColour] ,\n                [DurationColour] ,\n                [DurationComment]\n        FROM    @CompletedData\n        WHERE   [EntryCount] = 0\n        ORDER BY [DET_NUMBERA] ,\n                [Date] ,\n                [Start Time]\n\n    IF @ModeInt = 3 \n        SELECT  [DET_NUMBERA] ,\n                [Name] ,\n                [Branch] ,\n                COUNT(*) OVER ( PARTITION BY [DET_NUMBERA] ) AS RowsForThisEmployee ,\n                CONVERT(VARCHAR(10), dbo.udf_WeekEndDate([Date]), 103) AS [WeekEnding] ,\n                [Date] ,\n                [Start Time] ,\n                [End Time] ,\n                [Duration] ,\n                dbo.format_timeV2([Duration] * 60) AS [DurationF] ,\n                [EntryCount] ,\n                [EntryColour] ,\n                [DurationColour] ,\n                [DurationComment]\n        FROM    @CompletedData\n        WHERE   [EntryCount] &gt; 1\n        ORDER BY [DET_NUMBERA] ,\n                [Date] ,\n                [Start Time]\n</code></pre>\n\n<p>The temp table doesnt have an index (didnt think it was needed as it only ever contains 100 - 200 rows:</p>\n\n<pre><code>    DECLARE @CompletedData TABLE\n        (\n          [DET_NUMBERA] VARCHAR(7) ,\n          [Name] VARCHAR(255) ,\n          [Branch] VARCHAR(3) ,\n          [Date] DATE ,\n          [Start Time] TIME(0) ,\n          [End Time] TIME(0) ,\n          [Duration] INT ,\n          [EntryCount] INT ,\n          [EntryColour] VARCHAR(15) ,\n          [DurationColour] VARCHAR(15) ,\n          [DurationComment] VARCHAR(65)\n        )\n</code></pre>\n\n<p>The CTE populates the table in 3 seconds, its only the above SELETS that make use of UDF's that hang, if i remove the UDF's from the SELECT it works instantly.</p>\n"},{"tags":["sql","sql-server-2008","tsql","parsing"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":13122997,"title":"T-SQL: Parsing names to ignore spaces and middle initials","body":"<p>I have a poorly maintained database that includes employee information.  Human Resources requested a report that lists instances where the employee name associated with an insurance coverage does not match the name on the insurance policy.  </p>\n\n<p>There are inconsistencies in the formatting of the names in both tables.  It's always last name then first name, but you might see any of the following in either table for a fictional employee named Steven J. Smith:</p>\n\n<ol>\n<li>Smith, Steven</li>\n<li>Smith,Steven</li>\n<li>Smith, Steven J.</li>\n<li>Smith,Steven J.</li>\n</ol>\n\n<p>I need to run a query looking for instances where EMPLOYEE.EMP_NAME &lt;> INSURANCE.SUBSCRIBER_NAME while allowing for differences in name formatting as shown above (i.e. picking up that \"Smith,Steven J.\" and \"Smith, Steven\" are (probably) the same person and igonring them).  </p>\n\n<pre><code>SELECT \n  EMPLOYEE.EMP_NO\n, EMPLOYEE.EMP_NAME\n, INSURANCE.SUBSCRIBER_NAME\n, INSURANCE.PAYOR_NAME\n\nFROM EMPLOYEE\n     INNER JOIN INSURANCE ON EMPLOYEE.EMP_NO = INSURANCE.EMP_NO\n\nWHERE EMPLOYEE.EMP_NAME &lt;&gt; INSURANCE.SUBSCRIBER_NAME\n</code></pre>\n\n<p>I know I want to do a substring to ignore the middle initial, but how do I account for ignoring whether or not there is a space after the comma?  </p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":13158603,"title":"select 100 records in range","body":"<p>Lets say I have a student table and there are 1000 records in it. </p>\n\n<p>I would like to write such a query that should select only 100 records but I should be able to define the range. </p>\n\n<pre><code>Ex. 100 records showing from 501 to 600\nor 100 records showing from 101 to 200\n</code></pre>\n\n<p>P.S. Yes! There is a identity column but it consists of random numbers.</p>\n\n<p>Thank you for your help.</p>\n"},{"tags":["sql","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":13156879,"title":"T-SQL: How to convert string representations of a date","body":"<p>I've got some dates stored in varchar(10) format.</p>\n\n<p>Dates are like so:</p>\n\n<pre><code>2008-01-06\n2008-01-13\n2008-01-20\n2008-01-27\n2008-02-03\n2008-02-10\n2008-02-17\n2008-02-24\n</code></pre>\n\n<p>I would like them in dd/mm/yyyy format (also a DATE datatype)</p>\n\n<p>I have tried the following:</p>\n\n<pre><code>SELECT CONVERT(VARCHAR(max), startWeek, 103) date\nFROM dbo.GoogledataFinal\n</code></pre>\n\n<p>Why does this output:</p>\n\n<pre><code>2008-01-06\n2008-01-13\n2008-01-20\n2008-01-27\n2008-02-03\n2008-02-10\n2008-02-17\n</code></pre>\n\n<p>Would be great if you could fix my code, but I'm more interested in WHY this behaviour is happening, so explaining like I'm 5 years old might be helpful.</p>\n"},{"tags":["sql-server","tsql","select","views"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":13053668,"title":"Top results from multiple elections in T-SQL","body":"<p>I have a table with votes from multiple sectors (think of each sector as a state or similar) on multiple candidates. Each sector has multiple candidates, each with a different vote count.</p>\n\n<p>Here is my table (simplified)</p>\n\n<pre><code>CREATE TABLE [Results]\n(\n    [SectorID] BIGINT,\n    [CanditateID] BIGINT, \n    [VoteCount] BIGINT,\n    [Newness] DATETIME\n)\n</code></pre>\n\n<p>I obviously keep sector and candidate meta data in another table, but I need to find the highest voted candidate for each sector, so I can join those tables into a view.</p>\n\n<p>The best candidate in each sector, is determined by <code>[VoteCount]</code>, and if there are two with the same number of votes, it is determined by <code>[Newness]</code>. There must remain exactly one line per sector, and I have to be able to use it in a view, joined together with the meta data.</p>\n\n<p>How do I obtain the highest voted candidate from each sector?</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":346,"score":3,"question_id":5874913,"title":"How to support bigint in datetime","body":"<p>The result of datediff(ss, '01/01/1970', '12/31/2050') is a bigint so \"datediff\" is overflowing.</p>\n\n<p>How can I get from a bigint value to its equivalent date and back again if the max a date can be in SQL is \"int\"???</p>\n\n<p>I need to be able to store number of seconds between '01/01/1970' and '12/31/2050' in SQL (which I do as a char) but convert that value to its calendar date for display in a web page.</p>\n\n<p>Any ideas would be appreciated.</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","database-backups"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":29,"score":1,"question_id":13137815,"title":"SQL Server backup devices","body":"<p>I'm trying to find out how to detect if a backup device exists using T-SQL.</p>\n\n<p>This is how I create my backup device:</p>\n\n<blockquote>\n  <p>EXEC master.dbo.sp_addumpdevice @devtype = N'disk', @logicalname =\n  N'TestTest', @physicalname = N'C:\\Program Files\\Microsoft SQL\n  Server\\MSSQL10_50.PTC_SQLPROD\\MSSQL\\Backup\\TestTest.bak'</p>\n</blockquote>\n\n<p>but I can't find how to detect if it already exists first.</p>\n"},{"tags":["c#","sql-server","winforms","tsql","smo"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":70,"score":3,"question_id":13090319,"title":"Could not load file or assembly 'Microsoft.SqlServer.Smo, Version=10.0.0","body":"<ul>\n<li>OS : Microsoft Windows NT 5.2.3790 Service Pack 2 Version: 2.0.50727.42 </li>\n</ul>\n\n<p>Doing: creating Tables... </p>\n\n<blockquote>\n  <p>Rec: system.m.FileNotFoundexception: could not load file or assembly\n  'microsoft.sqlserver.smo, version=10.0.0.0, culture=neutral File name:\n  'microsoft.sqlserver.smo, version=10.0.0.0, culture=neutral,\n  PublicKeyToken=89845dcd8080cc91' at\n  claimsure.Forml.Runsqlscript(string connstring, streamReader sr) at\n  myapp.Forml.bw_Dowork(object sender, DoworkeventArgs e) 'MN: Assembly\n  binding logging is turned OFF. To enable assembly bind failure\n  logging, set the registry value\n  (NKLm\\software\\microsoft\\Fusion!enableLog] (DwoRD) to 1. Note: There\n  is some performance penalty associated with assembly bind failure\n  logging. To turn this feature off, remove the registry value\n  (NKLm\\software\\microsoft\\Fusion!enableLog).</p>\n</blockquote>\n\n<p>I get the above error when running my application on a Windows 2003 server with SQL Server 2005.</p>\n\n<p>I know there is a solution to download SQLServer2005_XMO from <a href=\"http://www.microsoft.com/en-us/download/details.aspx?id=24793\" rel=\"nofollow\">http://www.microsoft.com/en-us/download/details.aspx?id=24793</a></p>\n\n<p>I have done this, but after the install a server reboot is required, which is not feasible for the time being. </p>\n\n<p>I need to make use of the server object.</p>\n\n<pre><code> using Microsoft.SqlServer.Management.Smo;\n using Microsoft.SqlServer.Management.Common;  \n\n        using (SqlConnection connection = new SqlConnection(connString))\n        {\n            Server server = new Server(new ServerConnection(connection));\n            server.ConnectionContext.StatementTimeout = 2400;\n            server.ConnectionContext.ExecuteNonQuery(sqlString);\n\n        }\n</code></pre>\n\n<p>Is is possible to load the dll in the same directory as my app and reference it from within the code? </p>\n\n<p>Thanks.    </p>\n\n<p>edit: added full error</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":13155104,"title":"Select persons which have overlap with other table","body":"<p>I didn't even know how to come up with a good title, so i hope i can describe my problem oin a right way :)</p>\n\n<p>So i have a person table, and it has a N:N relationship with keywords via the table PersonKeywords.</p>\n\n<p>Then i also have a Search table, and it also has a N:N relationship with keywords via the table SearchKeywords.</p>\n\n<p>Now the person can have a relationship with keyword A and B, and the search record can have a relationship with the keywords A and C.</p>\n\n<p>Now i want the person in my resultset, because it has at least one (in this 'A') of the keywords the search record has.</p>\n\n<p>I also want the person who has 'A', the one with 'C', the one with 'A' and 'C', but not the one with only B.</p>\n\n<p>So it's a match on two lists, but i don't know where to start to create such a statement...</p>\n"},{"tags":["sql","tsql","unit-testing"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12171214,"title":"SQL Unit Testing Creating test for Stored procedure that does not necessarily return a value","body":"<p>I am new to sql unit testing but I have written my first test and trying to make sure this is a sensible test. So I have a stored procedure that does a simply Update(if exists) or insert(if not exists). Using TSQLUnit, I wrote the test below to test my stored procedure called <strong>spModifyData</strong>. What the test is designed to do is verify that when an existing ID is passed, a new record is not created in the database. </p>\n\n<pre><code>ALTER PROCEDURE [dbo].[ut_TestspModifyData] \nAS\nBEGIN \n    SET NOCOUNT ON;\n     -- Setup the test conditions by inserting test data\n     DECLARE \n                @newidone uniqueidentifier,\n                @newidtwo uniqueidentifier,\n                @newidthree uniqueidentifier,\n                @ExpectedID uniqueidentifier,\n                @ActualID uniqueidentifier\n\n                SET @ActualID = '13E7C741-9A04-4E84-B604-141874A6A9B4'\n                SET @ExpectedID = '13E7C741-9A04-4E84-B604-141874A6A9B4'\n                SET @newidone = newID()\n                SET @newidtwo = newID()\n                SET @newidthree = newID()\n\n                 INSERT INTO DataSource( [DataSourcePrimarySource],[DataSourceName],[DataSourceRecordCreateDate] \n          ,[DataSourceStatus] ,[DataSourceIsActive]) VALUES ('PRIMARY SOURCE ONE', 'XYZ', GETDATE() , @newidone, 1)\n\n  -- Exercise the test\n EXEC  spModifyDataSource @ActualID , 'PRIMARY SOURCE ONETWO', 'BBB', @newIDone, 0  \n\n -- Assert expectations\n IF (@ExpectedID != @ActualID)\n                EXEC dbo.tsu_Failure 'ModifyData failed.' \n\n-- Teardown\n -- Implicitly done via ROLLBACK TRAN\n\nEND\n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures","ssis"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":139,"score":0,"question_id":13143386,"title":"How to automate the execution of a stored procedure with an SSIS package?","body":"<p>I have a stored procedure that gets executed through SQL SSIS using a Execute SQL Task.</p>\n\n<p>The task has the following:</p>\n\n<pre><code>USE [OPPY_DWUSD]\nGO\nDECLARE @return_value int\nEXEC    @return_value = [dbo].[generate_merge_scdbk]\n    @Schema = N'dim',\n    @Dimension = N'VARIETY',\n    @ETLSchema = N'stg',\n    @ETLTable = N'vw_VARIETY',\n    @Execute = 1\n\nSELECT  'Return Value' = @return_value\nGO\n</code></pre>\n\n<p>Right now the way I have this setup, I have multiple Execute SQL Tasks with the same code but different values, about 20 Execute SQL Tasks.</p>\n\n<p>Is there a more cleaner way to pull this off?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":26,"score":1,"question_id":13153648,"title":"MSSQL - Return Select","body":"<p>I would like to prepare procedure which will take 2 arguments (Int, string) If some row will exist in table I will get @dane = 1; and in the end I would like to select @dane but my procedure is not good. I can not use return @dane. </p>\n\n<pre><code>    USE [SS]\n    GO\n\n    SET ANSI_NULLS ON\n    GO\n    SET QUOTED_IDENTIFIER ON\n    GO\n\n    CREATE PROCEDURE [permission].[CheckSkill] \n(\n    @SkillId INT, -- Identyfikator uytkownika \n    @Description NVARCHAR(100) = NULL\n)\nAS\nBEGIN\n    SET NOCOUNT ON;\n    DECLARE @dana as int\n    SET @dana = 0\n\n    -- this is redundant:\n    --SET @Description = RTRIM(LTRIM(ISNULL(@Description,'')))\n\n    IF EXISTS (SELECT * FROM permission.UserXSkill Where permission.UserXSkill.SkillId = @SkillId)\n    BEGIN\n      SET @dana = 1;\n    END\n\n    SELECT @dana AS ID;\nEND\nGO\n</code></pre>\n\n<p>Topic [closed] Thanks for help.</p>\n"},{"tags":["tsql","sql-order-by","whitespace"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":15,"score":0,"question_id":13153569,"title":"T-SQL Order by whitespace ordering","body":"<p>I would like to ask you about this simple ORDER BY (in T-SQL) clause.\nLet's say we have these varchars in a table. (the table has ID, name, other columns)</p>\n\n<pre><code>'Peter'\n''\n''\n'Anna'\n'Michael'\n'Bert'\n''\n''\n''\n</code></pre>\n\n<p>The goal is to order them in ascending order, but so that the whitespaces will follow and not proceed these names. (I know that it sounds a little bit illogical, but I need all the datarows - including whitespaces - the table has in reality more columns and I cannot change  anything). Of course, the code of these chars precede the alphabet, but how to trick it to produce this output?</p>\n\n<p><code>SELECT name FROM table ORDER BY name</code></p>\n\n<pre><code>'Anna'\n'Bert'\n'Michael'\n'Peter'\n''\n''\n''\n''\n''\n</code></pre>\n\n<p>Thank you !</p>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1026,"score":1,"question_id":4921724,"title":"Returning index of n-th element in string using tsql","body":"<p>How in SQL Server can I return index of n-th element in string. For example I have string: <strong>a,b,c,d,e</strong>\nNow I want to receive all elements, before third coma, so <strong>a,b,c</strong>. For doing this I need to have index of third coma. Charindex does not fit here, because I cannot pass number of coma, for which I want the index. Is there any built-in function which can do it ?</p>\n\n<p><strong>Update</strong>, @Andriy M.</p>\n\n<p>Hey, the link You pointed me to is also useful. Below I've modified the shown sql a bit to get what I want:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[nthindexsub](@String varchar(8000), @Delimiter char(1), @DelimitersCount int)       \n returns varchar(8000)\n as       \n begin       \n     declare @Substring varchar(8000)\n     declare @temptable TABLE (itemindex int identity(1,1), items varchar(8000))\n     declare @idx int       \n     declare @slice varchar(8000)     \n\n     select @idx = 1       \n         if len(@String)&lt;1 or @String is null  return @Substring \n\n     while @idx!= 0       \n     begin       \n         set @idx = charindex(@Delimiter,@String)       \n         if @idx!=0       \n             set @slice = left(@String,@idx - 1)       \n         else       \n             set @slice = @String       \n\n         if(len(@slice)&gt;0)  \n             insert into @temptable(Items) values(@slice)       \n\n         set @String = right(@String,len(@String) - @idx)       \n         if len(@String) = 0 break       \n     end\n\n     select @Substring = COALESCE(@Substring + ',', '') + items from @temptable where itemindex &lt;= @DelimitersCount  \n     return @Substring;\n end\n</code></pre>\n\n<p>usage:</p>\n\n<pre><code>select dbo.nthindexsub('a,b,c,d,e', ',', 3)\n</code></pre>\n\n<p>the result is: <strong>a,b,c</strong></p>\n"},{"tags":["sql","sql-server","performance","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":76,"score":0,"question_id":13140520,"title":"Simple SQL Server query across databases runs extremely slow R2","body":"<p>I have two databases on a local machine, connected to <code>localhost</code>.  They both have roughly two million rows a piece.  I was doing the following very simple join and it took over a minute to complete.  </p>\n\n<pre><code>select distinct x.patid\n    from [i 3 sci study].dbo.clm_extract as x\n    left join [i 3 study].dbo.claims as y on y.patid=x.patid\n    where y.patid is null\n</code></pre>\n\n<p>When I looked at the execution plan I saw that the join showplan operator had this to say\n<img src=\"http://i.stack.imgur.com/eQAu6.jpg\" alt=\"enter image description here\"></p>\n\n<p>Why is the actual number of rows so exorbitantly high compared to the actual number of rows in both tables?</p>\n"},{"tags":["sql","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":39,"score":2,"question_id":13150562,"title":"Noob Concern: T-SQL Nesting Subquery","body":"<p>I've got a table named nobel with the following fields:  yr, subject and winner.  </p>\n\n<p>This table represents winners of nobel prize winners in a variety of subjects over the years.  </p>\n\n<p>I am looking for the years in which the Physics Prize was awarded but no Chemistry prize. </p>\n\n<p>I was thinking the answer would look something like the following:  </p>\n\n<pre><code>SELECT yr FROM nobel \nWHERE subject ('Chemistry') IN (SELECT subject FROM nobel WHERE subject = 'Physics')\n</code></pre>\n\n<p>I'm fairly certain I've got the syntax wrong... and i'm not certain i'm going down the right road.  Help would be appreciated.  Thanks!  </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":27,"score":1,"question_id":13150486,"title":"Get integer part of number","body":"<p>So I have a table with numbers in decimals, say</p>\n\n<pre><code>id    value\n2323   2.43\n4954  63.98\n</code></pre>\n\n<p>And I would like to get</p>\n\n<pre><code>id    value\n2323      2\n4954     63\n</code></pre>\n\n<p>Is there a simple function in T-SQL to do that?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":44,"score":0,"question_id":13149232,"title":"How do I extract a substring from a random position in a string using built-in functions?","body":"<p>I have a series of data stored in the following fashion:</p>\n\n<pre><code>Word of various kinds (ANT\\username1) and even more words\nThis is another row, the words are random (ANT\\username2)\nThankfully the username only ever shows once (ANT\\username1)\n</code></pre>\n\n<p>Above represents three seperate rows. </p>\n\n<p>The general flow of this data is:</p>\n\n<ul>\n<li>Parenthesis can appear anywhere in the text</li>\n<li>The username portion of each string (ANT\\usernamex) will only ever appear once</li>\n<li>The text preceeding and proceeding the username portion is always different lengths.</li>\n<li>The username text may not always be present</li>\n</ul>\n\n<p>As you probably already guessed what I need to do is take the username from each row and where it isn't present return null. Unfortunately I have no idea how to approach this - I've played around with left() and right() functions but don't really know how else to tackle this. Would appreciate if any answers that use a number of functions to accomplish the task have a quick blurb explaining the flow of logic (so I can then read the documentation for the functions to learn).</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","pivot","pivot-without-aggregate"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":63,"score":-1,"question_id":13142554,"title":"X number of Rows into X number of Columns","body":"<p>I need your help again for the following. Please note that I am using SQL SERVER 2008.\nI have a table (below) where we got Number of jobs done from the \"Pickup\" to the \"Dropoff\".\nThe requirements are (output format mentioned below).\n1) Get all the unique postcodes regardless of them being dropoffs or pickups. This will give us all the postcodes.\n2) Present the count of jobs done from PICKUP to the corresponding DROPOFF. For example, we pick passengers up from SE18 postcode twice and took them to SE18 once and SE19 once. It will be cleared from the REQUIRED OUTPUT table.</p>\n\n<pre><code>TABLE:\nJobID        Pickup       Dropoff\n====================================\n1            SE18         SE18\n2            SE18         SE19\n3            SE2          SE18\n4            SE28         SE2\n5            AL1          SE7\n6            BR1          SE10\n7            NW1          TW16\n8            AL1          SE18\n9            BR6          AL1\n10           E6           BR1\n.            .            .\n.            .            .\n.            .            .\n</code></pre>\n\n<p>The require output is as the following:</p>\n\n<pre><code>REQUIRED OUTPUT\n\n     SE18   SE2   SE28   AL1   BR1   NW1   BR6   E6   SE19  SE7  SE10  TW16 ..\n     =========================================================================\nSE18   1     -      -     -     -     -     -     -     1    0    0     0\nSE2    1     -      -     -     -     -     -     -     -    -    -     -         \nSE28   -     1      -     -     -     -     -     -     -    -    -     -          \nAL1    1     -      -     -     -     -     -     -     -    1    -     -       \nBR1    -     -      -     -     -     -     -     -     -    -    1     -        \nNW1    -     -      -     -     -     -     -     -     -    -    -     1      \nBR6    -     -      -     1     -     -     -     -     -    -    -     -       \nE6     -     -      -     -     1     -     -     -     -    -    -     -       \nSE19   -     -      -     -     -     -     -     -     -    -    -     -        \nSE7    -     -      -     -     -     -     -     -     -    -    -     -       \nSE10   -     -      -     -     -     -     -     -     -    -    -     -      \nTW16   -     -      -     -     -     -     -     -     -    -    -     -      \n.\n.\n.\n</code></pre>\n\n<p>Many thanks in advance.\nKind regards</p>\n"},{"tags":["sql","tsql","oracle10g"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":60,"score":1,"question_id":13147705,"title":"sql query to subtract two table values and save them in first table?","body":"<p>How do I subtract one table column value from another table column value, and save the value in the first table column in the process?</p>\n\n<p>Thanks for your help.</p>\n"},{"tags":["tsql","select"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":22,"score":0,"question_id":13144444,"title":"SQL Using more than one result using WITH Clause","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1590994/why-cant-i-access-my-cte-after-i-used-it-once\">why cant I access my CTE after I used it once?</a>  </p>\n</blockquote>\n\n\n\n<p>How can I get more than one result using WITH ?</p>\n\n<pre><code>;WITH X AS\n    (SELECT whatever)\n\n, Y AS\n    (SELECT whatever FROM X)\n\nSELECT * FROM Y WHERE condition\n\nSELECT Count(*) FROM X                &lt;==== X doesn't work here\n</code></pre>\n\n<p>I don't want <strong>@@RecordCount</strong>, this counts <strong>Y</strong>, not <strong>X</strong></p>\n"},{"tags":["tsql","cursor"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":13148192,"title":"Infinite loop in T-SQL cursor","body":"<p>Below is the code for a T-SQL cursor. It works fine through the first iteration, however after that gets stuck in an infinite loop going between the FETCH NEXT statement and the IF NOT EXISTS statement (basically it will insert the first record, however after that the cursor will not move onto the next record so the IF NOT EXISTS is perpetually false). This is my first time using a cursor so was hoping someone could explain what is going on/how to make this thing work!</p>\n\n<pre><code>    DECLARE prod_cursor CURSOR FOR\n    SELECT ProductCode \n    FROM CourseToProduct \n    WHERE CourseCode = @courseCode and (TerminationDate &gt;= @expDate OR TerminationDate IS NULL)\n\n    OPEN prod_cursor\n\n    FETCH NEXT FROM prod_cursor\n    INTO @productCode\n\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        IF NOT EXISTS\n        (\n        SELECT sNumber\n        FROM AgentProductTraining\n        WHERE @sNumber = sNumber and \n              @courseCode = CourseCode and \n              @productCode = ProductCode and \n              @dateTaken = DateTaken\n        )\n        BEGIN\n            IF @sNumber IS NOT NULL\n            BEGIN\n                INSERT INTO AgentProductTraining\n                            (\n                             sNumber,\n                             CourseCode,\n                             ProductCode,\n                             DateTaken,\n                             DateExpired,\n                             LastChangeOperator,\n                             LastChangeDate\n                            ) \n                VALUES      (\n                             @sNumber,\n                             @courseCode,\n                             @productCode,\n                             @dateTaken,\n                             COALESCE(@expDate, 'NULL'),\n                             @lastChangeOperator,\n                             @lastChangeDate\n                           )    \n            END\n        END\n    END\n    CLOSE prod_cursor;\n    DEALLOCATE prod_cursor;\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":13146352,"title":"group By Contact information by customerID","body":"<p>I am trying to to remove the duplicated from my SQL statement Customer id ,firstname and lastName I want to be able group by customerID and Remove the duplicated Customer id form,firstname and lastName From Final output</p>\n\n<pre><code>SELECT customers.customerid, \n       customers.title, \n       customers.firstname, \n       customers.lastname, \n       customers.postion, \n       company.companyname, \n       (SELECT label.labelcontacttype \n        FROM   label \n        WHERE  label.labelcontacttypeid = \n       customer_contacts.labelcontacttypeid)AS \n       contactType, \n       customer_contacts.contactdetails, \n       customer_contacts.status, \n       customer_contacts.notes \nFROM   customers \n       INNER JOIN customer_company \n               ON customers.customerid = customer_company.customerid \n       INNER JOIN company \n               ON customer_company.companyid = company.companyid \n       INNER JOIN customer_contacts \n               ON customers.customerid = customer_contacts.customerid \n</code></pre>\n\n<p>Current output </p>\n\n<pre><code>15  Mr  Mike Smith Web Developer    compudata   Email   email@email.com 1   dvv  \n15  Mr  Mike Smith Web Developer    compudata   Phone   111-111-1111    1   ex:2222\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":13144458,"title":"improving performance of a view that is heavily dependent on dates","body":"<p><strong>This view is taking me HOURS to execute:</strong></p>\n\n<pre><code>USE [SalesDWH]\nGO\n\n/****** Object:  View [dbo].[FirstLastEstablished]    Script Date: 10/29/2012 15:12:47 ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nALTER view [dbo].[FirstLastEstablished] as\n\n\nwith cte_min as(\n\nselect \n      a.client_id\n      ,a.specimen_source\n      ,a.received_date\nfrom\n      millennium_dw_dev..F_ACCESSION_DAILY a\njoin\n            (select distinct\n                  f.client_id\n                  ,f.received_date\n                  ,f.accession_daily_key\n            from \n                  millennium_dw_dev..F_ACCESSION_DAILY f\n            join \n                  (select CLIENT_ID, MIN(received_date) MinRecDate\n                  from millennium_dw_dev..F_ACCESSION_DAILY\n                  group by CLIENT_ID) i\n            on f.CLIENT_ID=i.CLIENT_ID\n            and f.RECEIVED_DATE=i.MinRecDate) b\non    \n      a.ACCESSION_DAILY_KEY=b.ACCESSION_DAILY_KEY \n\n)\n\n,\ncte_max as \n(\n\nselect \n      a.client_id\n      ,a.specimen_source\n      ,a.received_date\nfrom\n      millennium_dw_dev..F_ACCESSION_DAILY a\njoin\n            (select distinct\n                  f.client_id\n                  ,f.received_date\n                  ,f.accession_daily_key\n            from \n                  millennium_dw_dev..F_ACCESSION_DAILY f\n            join \n                  (select CLIENT_ID, max(received_date) MaxRecDate\n                  from millennium_dw_dev..F_ACCESSION_DAILY\n                  group by CLIENT_ID) i\n            on f.CLIENT_ID=i.CLIENT_ID\n            and f.RECEIVED_DATE=i.MaxRecDate) b\non    \n      a.ACCESSION_DAILY_KEY=b.ACCESSION_DAILY_KEY \n\n)\n,\n\n\ncte_est as\n\n(\n\nselect distinct client_id, MLIS_DATE_ESTABLISHED\nfrom millennium_dw_dev..D_CLIENT\nwhere REC_ACTIVE_FLG=1\nand MLIS_DATE_ESTABLISHED is not null\n)\n\n,\n\nmainQuery as(\nselect distinct\n      f.client_id\n      ,cmin.specimen_source first_specimen_source\n      ,cmin.received_date first_received\n      ,cmax.specimen_source last_specimen_source\n      ,cmax.received_date last_received\n      ,cest.MLIS_DATE_ESTABLISHED MLIS_DATE_ESTABLISHED\nfrom millennium_dw_dev..F_ACCESSION_DAILY f\nleft join cte_max cmax\non cmax.CLIENT_ID=f.CLIENT_ID\nleft join cte_min cmin\non cmin.CLIENT_ID=f.CLIENT_ID\nleft join cte_est cest\non cest.CLIENT_ID=f.CLIENT_ID\n)\n,\nDateDifferences\nas\n\n(\nSELECT\nclient_id,\n   (DATEDIFF(dd, MLIS_DATE_ESTABLISHED,first_received) + 1)\n  -(DATEDIFF(wk, MLIS_DATE_ESTABLISHED,first_received) * 2)\n  -(CASE WHEN DATENAME(dw, first_received) = 'Sunday' THEN 1 ELSE 0 END)\n  -(CASE WHEN DATENAME(dw, MLIS_DATE_ESTABLISHED) = 'Saturday' THEN 1 ELSE 0 END)\n -(case when cast('01/01/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('05/26/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('07/04/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('09/01/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('11/27/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('12/25/2008 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('01/01/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('05/25/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('07/03/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('09/07/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('11/26/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('12/25/2009 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('01/01/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('05/31/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('07/05/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('09/06/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('11/25/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('12/24/2010 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('01/03/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('05/30/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('07/04/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('09/05/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('11/24/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('12/26/2011 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('01/02/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('05/28/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('07/04/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('09/03/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('11/22/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n-(case when cast('12/25/2012 ' as date) between MLIS_DATE_ESTABLISHED and first_received then 1 else 0 end)\n\n\n   DifferenceExcludingWeekends\n  from\n  mainQuery\n)\n,\nTerritory \nas\n(\nselect distinct c.client_id,c.MLIS_TERRITORY,s.REGION_NAME\nfrom millennium_dw_dev..D_CLIENT c\nleft join millennium_dw_dev..D_SALES_HIERARCHY s\non s.TERRITORY_NAME=c.MLIS_TERRITORY\nwhere c.REC_ACTIVE_FLG=1\nand s.REC_ACTIVE_FLG=1\n\n)\n\nselect mainQuery.*,d.DifferenceExcludingWeekends,Territory.MLIS_TERRITORY,Territory.REGION_NAME\nfrom mainQuery\nleft join DateDifferences d\non mainQuery.CLIENT_ID=d.CLIENT_ID\nleft join Territory\non mainQuery.CLIENT_ID=Territory.CLIENT_ID\n\nGO\n</code></pre>\n\n<p>I did the sql server database tuning on this, and created all the recommended indexes. After 15min of executing the view again, I stopped it. </p>\n\n<p><strong>Are there obvious things that you could kindly point out to me about my query to optimize it more and improve execution time?</strong></p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":57,"score":4,"question_id":13144970,"title":"Procedure to get dates in between","body":"<p>I have a SQL Server database that contains a <code>timesheet</code> table. This table is used to store roles for employees. Before I perform an insert I check to see of an employee has any preexisting roles in the selected days.</p>\n\n<p>Heres a stored procedure that returns the count of pre-existing roles </p>\n\n<pre><code>set @retVal=(select count(fk_RoleID) from dbo.TimesheetTable where \n(@startdate &gt;=  CAST((\nSTR( YEAR( StartDate ) ) + '/' +\nSTR( MONTH( StartDate ) ) + '/' +\nSTR( DAY( StartDate ) )\n)\nAS DATE\n))-- AND EndDate &lt;= '2012-08-30')\nand\n(@enddate  &lt;  CAST(\n(\nSTR( YEAR( EndDate ) ) + '/' +\nSTR( MONTH( EndDate ) ) + '/' +\nSTR( DAY( EndDate ) )\n)\nAS DATE\n))\nand fk_PersonnelID=@personnelID)\n\nreturn @retVal\n</code></pre>\n\n<p>The following are the records for one employee..</p>\n\n<pre><code>pk_ID  fk_PersonnelID  fk_RoleID  StartDate   EndDate     dateCreated\n62     1               26         2012-10-01  2012-10-02  2012-10-25 15:55:12.940\n81     1               20         2012-10-04  2012-10-06  2012-10-30 14:50:28.300\n</code></pre>\n\n<p>If I try to do an insert of where the start date is <code>2012-10-05</code> and end date is <code>2012-10-11</code>, the query fails to trap the <code>startdate</code> ..and the insert occurs</p>\n\n<p>What am I doing wrong?</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2","cursor"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":13145321,"title":"Using a script to update all columns in a table","body":"<p>The other day I asked a similar question relating to column titles. Now I'm wandering how something like </p>\n\n<pre><code>update table1\nset column1=REPLACE(column1, '\"','')\n\nupdate table2\nset column2=REPLACE(column2, '\"','')\n\nupdate table3\nset column3=REPLACE(column2, '\"','')\n</code></pre>\n\n<p>might be achieved. I'm sure this will be something involving <code>sys.objects</code> or <code>information_schema.columns</code> something along those lines (whatever the green keywords in SSMS are called).  </p>\n\n<p>Would this have to be done with a cursor?</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":13145028,"title":"NCHAR(916) in sql String","body":"<p>I need to put the nchar character  in a string like this:</p>\n\n<pre><code>SET @ANALISE1 =\n\n 'SELECT \n  * \n  FROM \n  (\n    SELECT \n    ''*'' Codigo,\n    ''Total'' Descricao,\n    SUM(#DADOS_VISTA_PRODUTO.[Ms||Volume]) [Ms||'+@MESATUAL+'Ton],\n    SUM(#DADOS_VISTA_PRODUTO.[Ms||Ms Anterior Volume]) [Ms||'+ @MESANTERIOR +' Ton],\n    (((SUM(#DADOS_VISTA_PRODUTO.[Ms||Volume])/SUM(#DADOS_VISTA_PRODUTO.[Ms||Ms Anterior Volume])) -1) * 100)\n    [Ms||'+ **NCHAR(916)**+'%A]\n  '\n\nEXEC (@ANALISE1)\n</code></pre>\n\n<p>but it appears as a question mark.\nAnyone know why?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":13141507,"title":"Check if user is member of dbo role in SQL Server","body":"<p>I need a T-SQL statement to check if a user is member of a database role in SQL Server. Specifically I need to know if the user is member of the dbo role, because then I don't have to grant additional authority to that user.</p>\n\n<p>If I try to add additional authority when the user is dbo it fails, and my script fails...</p>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":13142433,"title":"Tables for recursive hierarchial data in SQL","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1757260/simplest-way-to-do-a-recursive-self-join-in-sql-server\">Simplest way to do a recursive self-join in SQL Server?</a>  </p>\n</blockquote>\n\n\n\n<p>I have to create a table in SQL that will comprise of groups of items/products. Each new group made will be made under one of the <strong>pre-defined</strong> groups or the groups previously formed. I want to keep all this data in a SQL Table. So far, I have though of creating a table like this:</p>\n\n<ul>\n<li>Group ID</li>\n<li>Group Name</li>\n<li>Group Under (This will store the ID of the group under which this group is from</li>\n</ul>\n\n<p>But this can only refer to just the next level, how will I get to know who is the super-parent of this group.</p>\n\n<p>For example:</p>\n\n<ul>\n<li>I have groups <code>A, B, C</code>. </li>\n<li><code>A</code> has further subgroups <code>A1, A2, A3</code>. </li>\n<li><code>A1</code> has further subgroups, <code>A11, A12, A13</code>. </li>\n</ul>\n\n<p>I will I have the information about super-parent group i.e <code>A</code> from <code>A11</code> or <code>A22</code> or <code>A33</code>? </p>\n\n<p>Let me know if the problem is not clear..</p>\n"},{"tags":["asp.net","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":13,"score":2,"question_id":13143782,"title":"aspnet_regsql tool created additional tables","body":"<p>When i used aspnet_regsql tool on my mdf file it created by two copies of some tables. For example UsersInRoles and aspnet_UsersInRoles, Users and aspnet_Users. What does it mean?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":72,"score":5,"question_id":13141899,"title":"Finding the next occurrence of a value in a table","body":"<p>Sorry in advance if this has already been covered.</p>\n\n<p>I am working on a database which isnt particularly well structured but it is owned by a third party and cannot be changed.</p>\n\n<p>I need some assistance with t-sql in find the next occurrence of a value within the table and return records based on the result. Let me first explain the data. I have simplified this to make it easier to understand.</p>\n\n<pre><code>Polref      Effective Date       Transaction Type     Suffix        Value\nABCD1       01/06/2010           New Bus              1             175.00\nABCD1       01/06/2011           Ren                  2             200.00\nABCD1       19/08/2011           Adjust               3              50.00\nABCD1       23/04/2012           Adjust               4              50.00\nABCD1       01/06/2012           Ren                  5             275.00\n</code></pre>\n\n<p>So if I ran my query for 2011, the code would need to return in this example rows with suffix 2,3 and 4. So what I have been trying to do is find the first suffix of a New Bus or Ren for the specified year and then finding the next suffix for a New Bus or Ren for the same polref and then using those two suffix values to limit my recordset. It aint working!!</p>\n\n<p>I cant use MAX() as transactions for 2013 have already been added to the system to I would get more records than I actually need.</p>\n\n<p>There result I should be expecting for this example data would be:</p>\n\n<p>ABCD1       300.00</p>\n\n<p>Any help would be greatly appreciated.</p>\n\n<p>To answer another question, If I select 2011 as my year to run the report, there should only be one New Bus or Ren transaction for 2011 so if its a New Bus transaction, the next main transaction will be a Ren, if its a Ren then the next main transaction will be a Ren. Again in my example below, if I run for 2011, it should find the Ren from 01/06/2011 so I want to return that Ren and the two Adjust records.</p>\n\n<p>Sorry, I've not used this forum before so apologies if I was a little vague.</p>\n\n<p>The table I am using has many polrefs so I need this code to calculate totals for all polrefs that fall within the date range. Some polrefs may only have one row, a New Bus, some will have many rows depending on how many adjustments have been made throughout the year of the policy</p>\n"},{"tags":["tsql","select","nested"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":25,"score":1,"question_id":13142189,"title":"t-sql WITH on WITH","body":"<p>I have to make query on WITH query, something like</p>\n\n<pre><code>; WITH #table1  \n(  \nSELECT id, x from ... WHERE....  \nUNION ALL  \n SELECT id, x from ... WHERE...  \n)  \n\nWITH #table2  \n(  \n SELECT DISTINCT tbl_x.*,ROW_NUMBER() OVER (order by id) as RowNumber  \nWHERE id in ( SELECT id from #table1)  \n)  \n\nSELECT * FROM #table2 WHERE RowNumber &gt; ... and ...\n</code></pre>\n\n<p>So I have to use WITH on WITH and then SELECT on second WITH, How I can do that?</p>\n"},{"tags":["tsql","case-when"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":4661,"score":0,"question_id":3342319,"title":"TSQL Case/When question","body":"<p>I have a huge query which uses <em>case/when</em> often. Now I have this SQL here, which does not work.</p>\n\n<pre><code> (select case when xyz.something = 1\n then\n     'SOMETEXT'\n else\n      (select case when xyz.somethingelse = 1)\n      then\n          'SOMEOTHERTEXT'\n      end) \n\n      (select case when xyz.somethingelseagain = 2)\n      then\n          'SOMEOTHERTEXTGOESHERE'\n      end)\n end) [ColumnName],\n</code></pre>\n\n<p>Whats causing trouble is <strong>xyz.somethingelseagain = 2</strong>, it says it could not bind that expression. xyz is some alias for a table which is joined further down in the query. Whats wrong here? Removing one of the 2 case/whens corrects that, but I need both of them, propably even more cases.</p>\n\n<p>Thanks :-)</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":13141369,"title":"is it possible to set column value to a concatenation of string and iteration value?","body":"<p>Is it possible to set value of a varchar column to a concatenation of a string and the result set iteration.    </p>\n\n<p>for example:</p>\n\n<pre><code>update TB_USER set LOGIN_NAME = 'BOB'+index where LOGIN_NAME = 'BOB'\n</code></pre>\n\n<p>results in the following: </p>\n\n<blockquote>\n  <p>LOGIN_NAME</p>\n  \n  <p>BOB0</p>\n  \n  <p>BOB1</p>\n  \n  <p>BOB2</p>\n</blockquote>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":13139725,"title":"SELECT query on large table","body":"<p>I need to review / refactor an existing stored procedure that targets a table (10+ millons of rows). The stored procedure signature can not be changed easily and it looks like below.</p>\n\n<p>The stored procedure takes two strings delimited by pipes and uses a SQL function (<code>SplitDelimitedVarChar</code>) to split the string into a temp table which is then used in the actual select. The number of strings in the <em>array</em> string ranges from 1 to thousands. </p>\n\n<p>The <code>DateValue</code> and <code>TimeValue</code> columns contains <code>int</code> representations of the timestamp in the row.</p>\n\n<p>My question is if any one has any ides if this is a good (best?) solution or if it could be done better. The main question is if it could be optimized for speed?</p>\n\n<p>Since the table is only accessed through this stored procedure the index is a non clustered with the <code>WHERE</code> columns and includes all the <code>SELECT</code> columns.</p>\n\n<p>Thanks for any suggestions or pointers.</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[spdata_Get_Ana]\n@beginTime INT,\n@endTime INT,\n@subscribers VARCHAR(MAX),\n@exchanges VARCHAR(MAX) = '1:',\n@beginDateValue int, \n@endDateValue int,\n@target int = 1\nAS  \nBEGIN\nSET NOCOUNT ON;\n\nCREATE TABLE #exch (Item Varchar(20) COLLATE database_default)\nINSERT INTO #exch\nSELECT Item FROM [SplitDelimitedVarChar] (@exchanges, '|') ORDER BY Item\nCREATE CLUSTERED INDEX idx ON #exch (Item)\n\nCREATE TABLE #subs (Item Varchar(20) COLLATE database_default)\nINSERT INTO #subs\nSELECT Item FROM [SplitDelimitedVarChar] (@subscribers, '|') ORDER BY Item\nCREATE CLUSTERED INDEX idx ON #subs (Item)\n\nSELECT \n   [Id]\n  ,'' AS 'Name'\n  ,[NameId]\n  ,[Level]\n  ,[Ne]\n  ,[CallId]\n  ,[Bg]\n  ,[DateTime]\n  ,[TimeStamp]\n  ,[LogOwnerSnb]\n  ,[TypeOfLog]\n  ,[AbsenceCode]\n  ,[AnswerTime]\n  ,[CallForwardingReason]\n  ,[CallForwardingToNumber]\n  ,[CallTransferTime]\n  ,[CallTransferReason]\n  ,[SeizedSubscriberType]\n  ,[SeizedSubscriberTime]\n  ,[SeizedSubscriberNumber]\n  ,[CalledSubscriberService]\n  ,[InSubscriberType]\n  ,[InSubscriberNumber]\n  ,[CallDirection]\n  ,[SubscriberService]\n  ,[ClearingCause]\n  ,[ClearingCauseTime]\n  ,[OnHookTime]\n  ,[OutAnswerSubType]\n  ,[OutAnswerTime]\n  ,[OutAnswerSubNum]\n  ,[RingingStartedTime]\n  ,[ReroutedToNumber]\n  ,[InitiatedService]\n  ,[B26]\nFROM [dbo].[data_centrex_Ana] AS A\nWHERE\n    (A.[DateValue] BETWEEN @beginDateValue AND @endDateValue)\nAND\n    EXISTS(SELECT [Item] FROM #exch WHERE [Item] = A.[Level])\nAND\n    (A.[TimeValue] BETWEEN @beginTime AND @endTime)\nAND\n(\n   (@target = 1 AND EXISTS(SELECT [Item] FROM #subs WHERE [Item] = A.[LogOwnerSnb]))\n   OR\n   (@target = 2 AND EXISTS(SELECT [Item] FROM #subs WHERE [Item] = A.[Bg]))\n)\nEND\n</code></pre>\n"},{"tags":["sql","tsql","casting","decimal"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":104,"score":2,"question_id":13127326,"title":"Use Cast() function in where clause - T-SQL","body":"<p>I am trying to use a CAST() function in the where clause of a query. Basically I have a FieldA in TableA that is typed as Decimal(10,0), and a FieldB in TableB that is typed as CHAR, and I would like to join the two tables on the conditions that Fields A and B are identical.</p>\n\n<p>I have tried a simple</p>\n\n<pre><code>select FieldA , FieldB from tableA left join tableB \non cast(FieldB as decimal(10,0))= FieldA\n</code></pre>\n\n<p>But it returns an error</p>\n\n<blockquote>\n  <p>character non admitted in the CAST clause</p>\n</blockquote>\n\n<p>EDIT this was a bad translation from french, the right translation seems to be</p>\n\n<blockquote>\n  <p>invalid character value for cast specification</p>\n</blockquote>\n\n<p>(thx Alex K)</p>\n\n<p>I then tried to do something like</p>\n\n<pre><code>select tableA.fieldA, tableC.fieldC\nfrom tableA left join\n(select cast(fieldB as decimal(10,0)) fieldC from tableB)\nas tableC on fieldC=fieldA\n</code></pre>\n\n<p>But I have the same error being returned</p>\n\n<p>I am really not an expert in SQL and basically just use a few SELECTs here and there, tried to look around for similar problems but can't see an answer that matches my problem.</p>\n\n<p>Anyone have an idea ? Thanks </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":55,"score":1,"question_id":13139189,"title":"SQL set Table 1 COL A = Table 2 COL B if Table 1 COL C = Table 2 COL D","body":"<p>I have two tables</p>\n\n<p><strong>Table1</strong></p>\n\n<pre><code>REF1 REF2\n     A\n     B\n     C\n</code></pre>\n\n<p><strong>Table2</strong></p>\n\n<pre><code>UPN Filename\n1   A\n2   B\n3   C\n</code></pre>\n\n<p>what I want to do in SQL is this</p>\n\n<blockquote>\n  <p>If Table1 REF2 = Table2 Filename then set Table1 REF1 = Table2 UPN</p>\n</blockquote>\n\n<p>this is the sql I did</p>\n\n<pre><code>UPDATE    Table1\nSET       REF1 = Table2.UPN\nFROM      Table1 INNER JOIN Table2 \nON        Table1.REF2 = Table2.FileName \n</code></pre>\n\n<p>all this does is take the first value in row 1 of table2 and put it in every row under table1 in <code>REF1</code></p>\n\n<p>eg this is what I get </p>\n\n<p><strong>TABLE1</strong></p>\n\n<pre><code>REF1 REF2\n1    A\n1    B\n1    C\n</code></pre>\n\n<p>this is what I want</p>\n\n<p><strong>TABLE1</strong></p>\n\n<pre><code>REF1 REF2\n1    A\n2    B\n3    C\n</code></pre>\n\n<p>any help appreciated.</p>\n"},{"tags":["tsql","date-range"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":13139217,"title":"DateRange Max Count in TSQL","body":"<p>This program splits the given daterange according to the specific time and calculates some operations seperately. But the result I get is between 01:20:00 and 01:30:00 but I want to be calculated firstly between 01:20:00 and 01:25:00 then between 01:25:00 and 01:30:00</p>\n\n<pre><code>declare @Start datetime\ndeclare @Finish datetime\ndeclare @TimeRange time\n\nset @Start = N'2012-10-16 01:20:00.000'\nset @Finish = N'2012-10-16 01:30:00.000'\nset @TimeRange = '00:05:00'\n\ndeclare @TimeRanges as TABLE (SessionStart datetime, SessionEnd datetime);\n\n    with TimeRanges as \n     (  select @Start as StartTime, @Start + @TimeRange as EndTime\n        union all  \n        select StartTime + @TimeRange, EndTime + @TimeRange\n        from TimeRanges\n        where EndTime  &lt; @Finish ),\nids as \n(\n    select *, ROW_NUMBER() over (order by SessionStartTime, SessionCloseTime) rid from Test    \n    where SessionStartTime &gt;= N'2012-10-16 01:20:00.000'\n        and SessionCloseTime&lt;= N'2012-10-16 01:30:00.000'\n        and ScenarioID=24\n),\ncte as\n(\n    select SessionStartTime as ChangeTime, 1 as CC, rid from ids    \n    union all\n    select SessionCloseTime as ChangeTime, -1 as CC, rid from ids    \n\n)\n\n    select StartTime,EndTime, MAX( qqq.SessionCount ) as MaximumPeak\n    from (select ids.ScenarioID, ids.SessionStartTime,ids.SessionCloseTime, SessionCount\n    from\n        ids\n        inner join\n    (\n    select cc,rid, changetime,SessionCount from cte\n        cross apply \n        (select SUM(cc) as SessionCount from cte c where c.changetime&lt;=cte.changetime) SessionCount \n\n    ) res\n        on ids.rid=res.rid\n    where CC=1\n    ) as qqq, TimeRanges as TR left outer join\n      dbo.Test as Test on TR.StartTime &lt;= Test.SessionStartTime and Test.SessionCloseTime &lt; TR.EndTime\n    where Test.ScenarioID = 24\n    group by TR.StartTime, TR.EndTime\n</code></pre>\n\n<p>The result only shows between 01:20:00 and 01:30:00 but I want to show them seperately. Here is the result:\n<img src=\"http://i.stack.imgur.com/erEZR.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":503,"score":1,"question_id":10604275,"title":"Fiscal Year To-Date in Where Clause (T-SQL)","body":"<p>Company's Fiscal Year: July 1 - June 30</p>\n\n<p>I have a query where I am trying to capture aggregate # of units and $ revenue by product and cost center for the fiscal year-to-date.  It will run on the 1st of the month and look through the last day of the previous month.  Fiscal year does not appear in the report - it is criteria.</p>\n\n<pre><code>    Mix of pseudocode and SQL:\n    Where\n      If datepart(mm,getdate()) - 1 &lt; 7\n        THEN \n           transaction_post_date BETWEEN 7/1/ previous year AND dateadd(day,-(day(getdate()),getdate())          \n        Else \n           transaction_post_date BETWEEN 7/1/current year AND dateadd(day,-(day(getdate()),getdate())          \n</code></pre>\n\n<p>Am I on the write track?  How do I write the SQL for a specific date on a year that depends on SQL - 7/1/current year?  </p>\n\n<p>I am weak using variables and do not even know if I have access to create them on the SQL Server DB, which is rather locked down.  Definitely can't create a function.  (I'm a business analyst.)</p>\n\n<p>UPDATE, Fiscal year goes forward, so July 1, 2010, is Fiscal Year 2011.</p>\n\n<p>I think this works:</p>\n\n<pre><code>    Year(dateadd(month,6,htx.tx_post_date)) = Year(DateAdd(Month, 5, GetDate()))\n</code></pre>\n\n<p>Feeback?</p>\n\n<p>And now I've been asked to add Fiscal Year-To-Date fields for quantity and revenue to the following query which gave me totals for </p>\n\n<pre><code>    Select \n      inv.ITEM_CODE \n    , inventory.ITEM_NAME \n    , cc.COST_CENTER_CODE \n    , tx.REV_CODE_ID \n    , tx.PRICE \n    , tx.ITEM_SALE_ID\n    , sum(tx.quantity)\n    , sum(tx.amount)\n\n    from\n    transactions tx\n    inner join inventory inv on inv.item_id = tx.item_id\n    left outer join cost_center cc on cc.cost_center_id = tx.cost_center_id\n\n    where \n    DATEPART(mm, tx.tx_date) = DATEPART(mm,dateadd(m,-1,getdate()))\nand DATEPART(yyyy, tx.tx_date) = DATEPART(yyyy,dateadd(m,-1,getdate()))\n\n    group by \n      inv.ITEM_CODE \n    , inventory.ITEM_NAME \n    , cc.COST_CENTER_CODE \n    , tx.REV_CODE_ID \n    , tx.PRICE \n    , tx.ITEM_SALE_ID\n</code></pre>\n\n<p>I need to add the fiscal year-to-date quantity and and amount columns to this report.  Would a correlated subquery by the way to go?  Would the joins be tricky?  I've never used a subquery with an aggregation/grouping query.  </p>\n\n<p>Thanks for all the previous help.  </p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":13135256,"title":"Subtract DateTime intervals in T-SQL","body":"<p>I have first table with defined work times: <code>FreeTimes table (start datetime, end datetime)</code> and second table with already planned tasks: <code>TaskTime table (start datetime, end datetime)</code>.</p>\n\n<p>I need somehow to subtract second table from first, so i get a result set of remainig FreeTimes under this conditions:</p>\n\n<ul>\n<li>in case where TaskTime (or more TaskTimes) is in middle of FreeTime, i need to split FreeTime to time before task and time ramaining after task</li>\n<li>in case when TaskTime is overlapping entire FreeTime i need to filter out this FreeTime</li>\n<li>in case where TaskTime is intersecting with FreeTime i need to subtract TaskTime from FreeTime and leave only remaing part of FreeTime</li>\n</ul>\n"},{"tags":["tsql","date-range"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13136296,"title":"Calculate Sessions Between TimeRange in TSQL","body":"<p>Here is part of database:</p>\n\n<pre><code>SessionID    SessionStartTime              SessionCloseTime\n24       2012-10-16 01:00:06.000           2012-10-16 01:01:22.000\n24       2012-10-16 01:00:08.000           2012-10-16 01:01:10.000\n24       2012-10-16 01:00:16.000           2012-10-16 01:01:12.000\n24       2012-10-16 01:00:30.000           2012-10-16 01:01:48.000\n24       2012-10-16 01:00:41.000           2012-10-16 01:02:08.000\n24       2012-10-16 01:00:48.000           2012-10-16 01:01:34.000\n24       2012-10-16 01:00:56.000           2012-10-16 01:03:09.000\n24       2012-10-16 01:01:02.000           2012-10-16 01:02:13.000\n24       2012-10-16 01:01:05.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:09.000           2012-10-16 01:02:42.000\n24       2012-10-16 01:01:15.000           2012-10-16 01:02:48.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:14.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:06.000\n24       2012-10-16 01:01:42.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:45.000           2012-10-16 01:03:04.000\n</code></pre>\n\n<p>I want to add a new column to this table named as SessionCount and then I will be able to see the call peaks I mean max count of sessions which happened at the same time.</p>\n\n<p>This table should be like this:</p>\n\n<pre><code>SessionID    SessionStartTime              SessionCloseTime            SessionCount\n24       2012-10-16 01:00:06.000           2012-10-16 01:01:22.000     1\n24       2012-10-16 01:00:08.000           2012-10-16 01:01:10.000     2\n24       2012-10-16 01:00:16.000           2012-10-16 01:01:12.000     3\n24       2012-10-16 01:00:30.000           2012-10-16 01:01:48.000     4\n24       2012-10-16 01:00:41.000           2012-10-16 01:02:08.000     5\n24       2012-10-16 01:00:48.000           2012-10-16 01:01:34.000     6\n24       2012-10-16 01:00:56.000           2012-10-16 01:03:09.000     7\n24       2012-10-16 01:01:02.000           2012-10-16 01:02:13.000     8\n24       2012-10-16 01:01:05.000           2012-10-16 01:03:16.000     9\n24       2012-10-16 01:01:09.000           2012-10-16 01:02:42.000     10\n24       2012-10-16 01:01:15.000           2012-10-16 01:02:48.000     10\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:14.000     11\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:06.000     11\n24       2012-10-16 01:01:42.000           2012-10-16 01:03:16.000     7\n24       2012-10-16 01:01:45.000           2012-10-16 01:03:04.000     7\n</code></pre>\n\n<p>so in this table there are maximum 11 call peaks happened at the same time at 01:01:18. There are 11 active calls at 01:01:18. How can I calculate the sessions when session is active then +1 when session is finished then -1?</p>\n"},{"tags":["tsql","contains"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":23,"score":1,"question_id":13135905,"title":"Cannot use t-sql contains with short words","body":"<p>I call my statement with <code>CONTAINS</code> function, but sometimes it does not return correct records, e.g. I want to return row which contain in one field word 'Your':</p>\n\n<pre><code>SELECT [Email]\n      ,[Comment]\n  FROM [USERS]\n  WHERE CONTAINS(Comment, 'Your')\n</code></pre>\n\n<p>It gives mi 0 result despite that this field contains this word (the same with 'as', 'to', 'was', 'me'). When I use 'given' instead of 'Your' then I receive a result. Is there maybe a list of words which cannot be used with <code>CONTAINS</code>? Or maybe this words are to short (when i use 'name' then i receive the results)? The work 'Your' is at the beginning in field <code>Comment</code>.</p>\n\n<p>The field is of type 'text' and has enabled full-text index.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":13134649,"title":"How can i join sys.columns of view to sys.columns of the table it is referencing in T-SQL?","body":"<p>I am trying to join records in <strong>sys.columns</strong> for a view, to the records in <strong>sys.columns</strong> for the table it is referencing, because i need the values of <strong>is_nullable</strong>, <strong>is_computed</strong> and <strong>default_object_id</strong> columns for the columns that are selected in the view.</p>\n\n<p>The <strong>sys.columns</strong> records for the view have \"incorrect\" values, which you can observe by running the example queries below:</p>\n\n<pre><code>CREATE TABLE TestTable (\n    FieldA int NOT NULL,\n    FieldB int DEFAULT (1),\n    FieldC as CONVERT(INT, FieldA + FieldB),\n    FieldD int NOT NULL\n)\nGO\n\nCREATE VIEW TestView WITH SCHEMABINDING AS\nSELECT  FieldA, FieldC as TestC, FieldB + FieldC as TestD\nFROM dbo.TestTable WHERE FieldD = 1\nGO\n\nSELECT  OBJECT_NAME(c.object_id) as ViewName, c.name as ColumnName,\n        c.is_nullable as Nullable, c.is_computed as Computed,\n   cast(CASE WHEN c.default_object_id &gt; 0 THEN 1 ELSE 0 END as bit) as HasDefault\nFROM sys.columns c\nWHERE object_id = OBJECT_ID('TestTable')\nGO\n\nSELECT  OBJECT_NAME(c.object_id) as ViewName, c.name as ColumnName,\n        c.is_nullable as Nullable, c.is_computed as Computed,\n   cast(CASE WHEN c.default_object_id &gt; 0 THEN 1 ELSE 0 END as bit) as HasDefault\nFROM sys.columns c\nWHERE object_id = OBJECT_ID('TestView')\nGO\n</code></pre>\n\n<p>I have tried using system views to join on dependencies, but they do not give us information about which column in the view refers to which column in the table:</p>\n\n<pre><code>-- dm_sql_referenced_entities gives us all columns referenced, but all records\n-- have referencing_minor_id 0, so we do not know which column refers to what\nSELECT * FROM sys.dm_sql_referenced_entities('dbo.TestView', 'OBJECT')\nGO\n\n-- sql_dependencies gives us all columns referenced, but all records has\n-- column_id 0 so we can not use this either of joining the columns\nSELECT * FROM sys.sql_dependencies WHERE object_id = OBJECT_ID('TestView')\nGO\n\n-- sql_expression_dependencies just tells us what table we are referencing \n-- if view is not created WITH SCHEMABINDING. If it is, it will return columns,\n-- but with referencing_minor_id 0 for all records, so not able use this either\nSELECT * FROM sys.sql_expression_dependencies\n    WHERE referencing_id = OBJECT_ID('TestView')\nGO\n</code></pre>\n\n<p>This unanswered post on social.msdn submitted by someone seems to be the same issue:\n<a href=\"http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/4ae5869f-bf64-4eef-a952-9ac40c932cd4\" rel=\"nofollow\">http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/4ae5869f-bf64-4eef-a952-9ac40c932cd4</a></p>\n"},{"tags":["tsql","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":13134320,"title":"Combining multiple CTE in TSQL","body":"<p>I have two CTEs and I want to combine them together. I tried a lot but I got a syntax errors. First Part:</p>\n\n<pre><code>declare @TimeRanges as TABLE (SessionStart datetime, SessionEnd datetime);\n\n     with TimeRanges as (\n  select @Start as StartTime, @Start + @TimeRange as EndTime\n  union all\n  select StartTime + @TimeRange, EndTime + @TimeRange\n    from TimeRanges\n    where EndTime  &lt; @Finish )\n</code></pre>\n\n<p>Here is the second part:</p>\n\n<pre><code>;with cte as\n(\n    select SessionStartTime as changetime,1 as CC from Calls\n    union all\n    select SessionCloseTime,-1 from Calls\n)\n    select top 1 changetime,rt from\n    (\n    select * from cte\n        cross apply \n        (select SUM(cc) as rt from cte c where c.changetime&lt;=cte.changetime) rt         \n    ) v\n    order by rt desc\n</code></pre>\n\n<p>What I want to do:</p>\n\n<pre><code>    @Start datetime, \n    @Finish datetime,\n    @TimeRange time\nAS\nBEGIN\n\n    SET NOCOUNT ON;\n    declare @res int SET @res = 0\n\n    declare @TimeRanges as TABLE (SessionStart datetime, SessionEnd datetime);\n\n    with TimeRanges as \n     (  select @Start as StartTime, @Start + @TimeRange as EndTime\n        union all  \n        select StartTime + @TimeRange, EndTime + @TimeRange\n        from TimeRanges\n        where EndTime  &lt; @Finish ),\n\n\n    cte as\n    (\n    select SessionStart as changetime,1 as CC from TimeRanges\n    union all\n    select SessionEnd,-1 from TimeRanges\n    )\n    select top 1 changetime,rt from\n    (\n    select * from cte\n        cross apply \n        (select SUM(cc) as rt from cte c where c.changetime&lt;=cte.changetime) rt         \n    ) v\n    order by rt desc\n\n\n    select StartTime, EndTime,cte.rt\n    from TimeRanges as TR left outer join\n      dbo.Test as Test on TR.StartTime &lt;= Test.SessionStartTime \n      and Test.SessionCloseTime &lt; TR.EndTime      \n    where Test.ScenarioID = 24 \n    group by TR.StartTime, TR.EndTime,cte.rt    \nEND\n</code></pre>\n\n<p>First CTE, groups or splits times according to the @timerange between StartTime and EndTime. For Example, StartTime 11:00 EndTime 11:10 and TimeRange 05:00(5 min) then splits them into two parts: 11:00 - 11:05 and 11:05 - 11:10. Second CTE counts something for each these ranges. Not important in here. I tried to combine them but I get there errors:</p>\n\n<p>Invalid column name 'SessionStart'</p>\n\n<p>Invalid object name 'TimeRanges'</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":68,"score":1,"question_id":13132222,"title":"Why does Sql Sum of multiple columns containing nulls return incorrect result?","body":"<p>Table containing the following values:</p>\n\n<pre><code>Column1  Column2\n1        NULL\nNULL     4\n2        NULL\nNULL     5\n3        6\n</code></pre>\n\n<p>The following query:</p>\n\n<pre><code>SELECT \n    SUM([Column1] + [Column2] ) \nFROM [myTable]\n</code></pre>\n\n<p>returns a value of <code>9</code> when it should be returning <code>21</code>. Why? How does it arrive at the value?</p>\n\n<p>I know the SUM can be corrected by adding <code>ISNULL</code> like so:</p>\n\n<pre><code>SELECT \n    SUM(ISNULL([Column1], 0) + ISNULL([Column2], 0)) \nFROM [myTable]\n</code></pre>\n\n<p>but I would like to know the logic behind the value <code>9</code></p>\n"},{"tags":["sql","sql-server","tsql","dynamic-sql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":13132253,"title":"OpenQuery in SQL Server","body":"<p>I don't know how to config the <code>OpenQuery</code> function.</p>\n\n<p>I want to use <code>OpenQuery</code> to query database in test project. But I don't know how config the servername param </p>\n\n<pre><code>DECLARE @Sql varchar(max)\nDECLARE @SQLExcuteSentence varchar(max)\n\nSET @Sql = 'declare @UserID INT \nselect @UserID = 1\n\ndeclare @TotalGroupByFields nvarchar(2000)\nselect @TotalGroupByFields = ''Media''\n\ndeclare @CostDataFileds nvarchar(2000)\nselect @CostDataFileds = ''''\n\ndeclare @OtherDataFields nvarchar(max)\nselect @OtherDataFields = ''MonitoringSpotNumber,MonitoringTotalSeconds,BaseCost,ColourLoading,PositionLoading,WeekendLoading,Discount''\n\ndeclare @MasterFilterId nvarchar(max)\nselect @MasterFilterId =''DateRange=20060601-20121231''+char(13)+''IncludeGuests=0''\n\ndeclare @RatingTargetId nvarchar(2000)\nselect @RatingTargetId =''''\n\ndeclare @IsEnableFinancialCloseDate INT\nselect @IsEnableFinancialCloseDate = 0\n\ndeclare @MasterDisplayFormat nvarchar(2000)\nselect @MasterDisplayFormat = ''5''\n\nexec [dbo].[USP_MatrixReport] @UserID, @TotalGroupByFields, @CostDataFileds, @OtherDataFields,  @MasterFilterId, @RatingTargetId, @IsEnableFinancialCloseDate, @MasterDisplayFormat, 0'\n\nSET @SQLExcuteSentence = 'SELECT * FROM OPENQUERY(SQLConn,' + '''' + @Sql + '''' + ')'\nEXEC (@SQLExcuteSentence);\n</code></pre>\n\n<p>the SQLConn is what?? </p>\n"},{"tags":["sql","sql-server","tsql","date"],"answer_count":6,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2368,"score":1,"question_id":5611570,"title":"how i can retrieve rows by specific date in sql server?","body":"<p>I'm working in project for by PHP and SQL Server.</p>\n\n<p>The owner want from me  design page show only users who register in same day</p>\n\n<p>i.e., if today 11-3-2011 i want show only all users who register in 11-3-2011</p>\n\n<p>The table is:</p>\n\n<pre><code>id  username  date\n\n1   john      11\\3\\2011\n2   sara      11\\3\\2011\n3   john      5\\1\\2011\n4   kreem     1\\2\\2011\n</code></pre>\n\n<p>i make it by mysql </p>\n\n<pre><code>where DATE_ADD( items.created_date, INTERVAL 1 DAY ) &gt; NOW() \n</code></pre>\n\n<p>this cable of code show data which only insert in same day thats mean if today 10-4-2011 it will show only data which insert in 10-4-2011 if i today 15-4-2011 and im dose not insert any thing it will not show any thing, how i can build code like this in sql server? hope to be my question clear and understand </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":1880,"score":2,"question_id":4875513,"title":"error in Multiple Select statements in Insert statement","body":"<p>I am writing a query which has multiple select statements in an insert statement</p>\n\n<pre><code>    INSERT INTO dbo.Products \n    (ProductName, \n     SupplierID, \n     CategoryID, \n     UnitsInStock, \n     UnitsOnOrder, \n     ReorderLevel, \n     Discontinued)\nVALUES  \n    ('Twinkies' , \n     (SELECT SupplierID FROM dbo.Suppliers WHERE CompanyName = 'Lyngbysild'),\n     (SELECT CategoryID FROM dbo.Categories WHERE CategoryName = 'Confections'), \n     0, \n     0, \n     10, \n     0)\n</code></pre>\n\n<p>Actually it gives error</p>\n\n<pre><code>Msg 1046, Level 15, State 1, Line 4\nSubqueries are not allowed in this context. Only scalar expressions are allowed.\nMsg 102, Level 15, State 1, Line 4\nIncorrect syntax near ','.\n</code></pre>\n\n<p>Where these two select statements returns only one value.</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":15,"score":2,"question_id":13132556,"title":"How do I modify these group of functions to get everything left of #?","body":"<p>I have a column that has values stored in the following format:</p>\n\n<p>name#URL</p>\n\n<p>All data is stored with this and a second # is never present.</p>\n\n<p>I've got the following statement that strips the URL from this column:</p>\n\n<pre><code>SELECT  SUBSTRING ( wf_name ,PATINDEX ( '%#%' , wf_name )+1 , LEN(wf_name)-(PATINDEX ( '%#%' , wf_name )) )\n</code></pre>\n\n<p>However I want to take the name also (everything left of the #). Unfortuantely I don't understand the functions I'm using above (having read the  documentation I'm still confused). Could somebody please help me to understand the flow and how I can adjust this to get everything left of #?</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":57,"score":2,"question_id":13131046,"title":"TSQL Insert the column default value from Case Statement","body":"<p>I'd like to use the column's default value in an stored procedure insert, so that I don't have to repeat the default value in multiple places (it could change... DRY principle).</p>\n\n<p>The T-SQL INSERT operation has a handy 'default' keyword that I can use as follows:</p>\n\n<pre><code>Declare @newA varchar(10)\nSet @newA = 'Foo2'\n\n-- I can use \"default\" like so...\nInsert into Table_1 (\n    A, \n    B) \nValues (\n    @newA, \n    default)\n</code></pre>\n\n<p>However, If I need to do something conditional,  I can't seem to get the case statement to return 'default'.</p>\n\n<pre><code>-- How do I use 'default' in a case statement? \nINSERT INTO Table_1 (\n    A,\n    B )\nVALUES (\n    @newA,\n    CASE WHEN (@newA &lt;&gt; 'Foo2') THEN 'bar' ELSE default END)\n-- &gt; yeilds \"Incorrect syntax near the keyword 'default'.\"\n</code></pre>\n\n<p>I <em>could</em> insert the default, and then update as needed like so:</p>\n\n<pre><code>INSERT INTO Table_1 (\n    A,\n    B )\nVALUES (\n    @newA,\n    default)\nUPDATE Table_1 \nSET B = CASE WHEN (A &lt;&gt; 'Foo2') THEN 'bar' ELSE B END\nWHERE ID = SCOPE_IDENTITY()\n</code></pre>\n\n<p>But I'd really like somebody to tell me \"There's a better way...\"</p>\n\n<p>Here's a table definition for this example if it helps...</p>\n\n<pre><code>CREATE TABLE dbo.Table_1 (\n    ID int NOT NULL IDENTITY (1, 1),\n    A varchar(10) NULL,\n    B varchar(10) NULL  )  \nGO\nALTER TABLE dbo.Table_1 ADD CONSTRAINT DF_Table_1_A DEFAULT 'A-Def' FOR A\nGO\nALTER TABLE dbo.Table_1 ADD CONSTRAINT DF_Table_1_B DEFAULT 'B-Def' FOR B\nGO\n</code></pre>\n"},{"tags":["xml","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":17,"score":0,"question_id":13130906,"title":"Query each node's inner content","body":"<p>I know that I can do this -</p>\n\n<pre><code>declare @args xml = '&lt;arg&gt;&lt;value&gt;hello&lt;/value&gt;&lt;/arg&gt;&lt;arg&gt;&lt;value&gt;world&lt;/value&gt;&lt;/arg&gt;';\n\nselect arg.value('value[1]', 'nvarchar(max)')\nfrom @args.nodes('//arg') args(arg);\n</code></pre>\n\n<p>But I'd like to do something like this (without the superfluous <code>&lt;value&gt;</code> tags) -</p>\n\n<pre><code>declare @args xml = '&lt;arg&gt;hello&lt;/arg&gt;&lt;arg&gt;world&lt;/arg&gt;';\n\nselect arg.value('?', 'nvarchar(max)')\nfrom @args.nodes('//arg') args(arg);\n</code></pre>\n\n<p>What's the right XQuery expression?</p>\n"},{"tags":["sql","sql-server-2008","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13130303,"title":"SQL Server Query with boolean issue","body":"<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nalter PROCEDURE [dbo].[TCCPAUsersAndNamesByJobPosition] @EmpOrfreeLance bit\n\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    SELECT distinct t1.UserId , tblCustomers.name \n    FROM tblTime t1\n    inner join tblCustomers on t1.UserId=tblCustomers.custID\n    where (t1.userid in (select distinct custID from tblCustomers where sectionCat Like '%,35%') )\n    AND (t1.UserId in (select distinct custID from tblCustomers where IsEmployee = @EmpOrfreeLance))\n\nend\n</code></pre>\n\n<p>tried it also with  <code>IsEmployee = CONVERT(bit,@EmpOrfreeLance)</code></p>\n\n<p>and <code>SET @EmpOrfreeLance= CASE @EmpOrfreeLance WHEN 1 THEN 0 ELSE 0 END</code></p>\n\n<p>same all it retuns same list with same results no matter what </p>\n\n<p>Shouldn't it be simple ???</p>\n\n<p><code>IsEmployee</code> col-datatype is <code>(bit,null)</code></p>\n\n<p>my dev SQL server is 2008 ..online server is 2005 should it be a matter ...  </p>\n"},{"tags":["asp.net","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":13,"score":0,"question_id":13128010,"title":"Manipulating ASP.NET Databound Query","body":"<p>I've got a Databound DropDownList control that is filled with the following query:</p>\n\n<pre><code>&lt;asp:DropDownList ID=\"ddlSelector\" runat=\"server\" DataSourceID=\"dataSelector\"\n  DataTextField=\"Description\" DataValueField=\"Description\"\n  OnSelectedIndexChanged=\"TextBox_TextChanged\"\n  AutoPostBack=\"True\"&gt;\n&lt;/asp:DropDownList&gt;\n&lt;asp:SqlDataSource ID=\"dataSelector\" runat=\"server\"\n  ConnectionString=\"&lt;%$ ConnectionStrings:PRODUCTION %&gt;\"\n  SelectCommand=\"SELECT [ID], [Description] FROM [Status]\"&gt;\n&lt;/asp:SqlDataSource&gt;\n</code></pre>\n\n<p>I have a second Databound DropDownList control who's values need to be selected from the next available <code>Status.ID</code>.</p>\n\n<pre><code>&lt;asp:DropDownList ID=\"ddlChangeTo\" runat=\"server\" DataSourceID=\"dataChangeTo\"\n  DataTextField=\"Description\" DataValueField=\"Description\"&gt;\n&lt;/asp:DropDownList&gt;\n&lt;asp:SqlDataSource ID=\"dataChangeTo\" runat=\"server\"\n  ConnectionString=\"&lt;%$ ConnectionStrings:PRODUCTION %&gt;\"\n  SelectCommand=\"SELECT [ID], [Description] FROM [Status] WHERE ([Description] &amp;lt; @Description)\"&gt;\n  &lt;SelectParameters&gt;\n    &lt;asp:ControlParameter ControlID=\"ddlSelector\" Name=\"Description\" PropertyName=\"SelectedValue\" Type=\"String\" /&gt;\n  &lt;/SelectParameters&gt;\n&lt;/asp:SqlDataSource&gt;\n</code></pre>\n\n<p>The <code>WHERE</code> clause above does not fit the solution I am after. It is filtering alphabetically.</p>\n\n<p>What I need is a way to get the <code>[ID]</code> value from <code>ddlSelector</code> and put all values greater than that <code>ID</code> into my <code>ddlChangeTo</code> control.</p>\n\n<p>How do I get the <code>[ID]</code> value from the <code>ddlSelector</code> DropDownList control to use in the Databinding query for the <code>ddlChangeTo</code> DropDownList control?</p>\n"},{"tags":["tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":186,"score":3,"question_id":13021282,"title":"the multi-part identifier \"#tmpFullname.Item\" could not be bound.\"","body":"<p>The following code is supposed to take a string that may or may not be comma delimited and put it into a table (#tmpFullanme) that part works flawlessly.  The second part is supposed return all the values that are LIKE / NOT LIKE with or without % symbols based on what is input.  The error that I am getting is \"the multi-part identifier \"#tmpFullname.Item\" could not be bound.\"  The best guess I have is that it may be out of scope?  </p>\n\n<pre><code>DROP PROCEDURE uspJudgments; \nGO \nCREATE PROCEDURE uspJudgments \n@fullName varchar(100), @SrchCriteria1 varchar(15), @SrchCriteria2 varchar(15), @qualifier varchar(10) \nAS \nBEGIN \n\nSELECT * \nINTO #tmpFullname \nFROM dbo.DelimitedSplit8K(@fullName, ',') \n\nDECLARE @Query NVarChar(1024) \nSET @Query = 'SELECT d.*' + ' FROM defendants_ALL d, #tmpFullname' + \n' WHERE d.combined_name' + ' ' + @qualifier + ' ' + '''' + @SrchCriteria1 + '''' + ' + ' + '''' + #tmpFullname.Item + '''' + ' + ' + '''' + @SrchCriteria2 + '''' \n\nEND \n\nEXEC sp_executesql @Query \nPRINT(@Query) \n\nIF OBJECT_ID('#tmpFullname', 'U') IS NOT NULL \nDROP TABLE #tmpFullname \n\nEXEC uspJudgments @qualifier = 'LIKE', @fullName = 'johnson', @SrchCriteria1 = '%', @SrchCriteria2 = '%'\n</code></pre>\n\n<p>Cannot get to the PRINT output as \"the multi-part identifier \"#tmpFullname.Item\" could not be bound.\"   If I change #tmpFullname.Item to '#tmpFullname.Item it goes through and returns nothing but it shows that the query is correct minus the issue with that table.</p>\n\n<pre><code>SELECT d.* FROM defendants_ALL d, #tmpFullname WHERE d.combined_name LIKE '%' + '#tmpFullname.Item' + '%'\n</code></pre>\n\n<p>Please note that until I made this into a dynamic query so I can change the statement from LIKE to IN etc it worked very well.  </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":893,"score":5,"question_id":5735551,"title":"ORDER/SORT Column mixed number and number prefixed by char","body":"<p>I have a varchar column conteining a code, this code could by only numbers, or number prefixed by a char for example i have a column containing this data : </p>\n\n<pre><code>+------+\n| Code |\n+------+\n|  1   |\n|  C1  |\n|  2   |\n|  3   |\n|  C3  |\n|  F3  |\n|  F1  |\n|  F17 |\n|  C9  |\n|  C10 |\n|  C47 |\n| C100 |\n| C134 |\n| A234 |\n|C1245 |\n|   10 |\n|  100 |\n+------+\n</code></pre>\n\n<p>And so on ...</p>\n\n<p>I want to sort this column by this rules :</p>\n\n<ol>\n<li>Only numeric code</li>\n<li>Prefixed code with the letter part order alfanumerically and numeric part ordered as a number </li>\n</ol>\n\n<p>I want to achieve a resultset ordered like this :</p>\n\n<pre><code>+------+\n| Code |\n+------+\n|  1   |\n|  2   |\n|  3   |\n| 10   |\n| 100  |\n| A234 |\n|  C1  |\n|  C3  |\n|  C9  |\n|  C10 |\n|  C47 |\n| C100 |\n| C134 |\n|C1245 |\n|  F1  |\n|  F3  |\n|  F17 |\n+------+\n</code></pre>\n\n<p>How can i get a resultset ordered with this criteria ? \nI've tried with a query like this : </p>\n\n<pre><code>SELECT Code FROM Code_List ORDER BY case when Code like '%[a-z]%' then 99999999999999999999999999999999 else convert(decimal, Code) end\n</code></pre>\n\n<p>But i get a result that order first the number and then the prefixed number but the alpha prefixed number is ordered like char and not in the manner i want it...</p>\n\n<p>The only numeric record should be ordered following the rules of the numeric order and no the character order so if the only numeric record are : </p>\n\n<pre><code>+------+\n| Code |\n+------+\n|  1   |\n|  47  |\n|  2   |\n|  3   |\n|  6   |\n|  100 |\n|  112 |\n|  10  |\n</code></pre>\n\n<p>I want to get : </p>\n\n<pre><code>+------+\n| Code |\n+------+\n|  1   |\n|  2   |\n|  3   |\n|  6   |\n|  10  |\n|  47  |\n|  100 |\n|  112 |\n</code></pre>\n\n<p>The Database is Microsoft SQL Server.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":13102493,"title":"tsql: Delete behavior","body":"<p>I want to delete an order that has a header, subheader and line item details, before writing out the same order with whatever the replacement subheader, line item details might now be. I'm getting a pk violation error when I try to write back the newer version with the changes. After analysis, I see that even though my DELETE statements appear to work, after issuing them (e.g. x rows affected) --the target table remains unchanged. So, that would explain the pk vio issue. What am I missing?</p>\n\n<p>Here's one of the statements:</p>\n\n<pre><code>       -- detail level (drop products)\n       DELETE dprods FROM [SQLsever].[WIP].[order].DropProducts as dprods\n        INNER JOIN #dropprods t on t.OrderId = dprods.OrderId\n          AND t.OrderDropId = dprods.OrderDropId\n          AND t.DropProdId = dprods.DropProdId;\n</code></pre>\n\n<p>after issuing the statement, I still have all 200+ rows in the target table AND I have the 200+ ids in the #dropprods temp table. Why?</p>\n\n<p><em><strong></em>**<em></strong>  EDITED TO BETTER DEFINE PROBLEM <strong></em>**<em>*</em>**<em>*</em>**<em>*</em>**<em>*</em>*</strong>\nThe DELETE statements were NOT the issue. The issue is tied to a set of nested/named transactions. The DELETE statements are under one, the INSERT statements under another. Here's what I have. It's obviously wrong. What I am trying to do is assure that I don't commit a DELETE before I know I'll have a good replacement INSERT.  Here's what I've done:\n<strong>*<em></strong> EDITED T-SQL WITH SAVE TRANSACTION FIX *</em>** \nThis TSQL will work now.</p>\n\n<pre><code>   -- CHANGED\n   BEGIN TRANSACTION\n   SAVE TRANSACTION process_orders\n    BEGIN TRY\n    -- detail level \n    DELETE lprods FROM [SQLServer].[WIP].[order].LiftProducts as lprods\n     INNER JOIN #liftprods t on t.OrderId = lprods.OrderId\n      AND t.OrderLiftId = lprods.OrderLiftId\n      AND t.LiftProdId = lprods.LiftProdId;\n           -- the rest of the deletes \n            --NOTE: No commit transaction here; saving it to the end\n     END TRY\n     BEGIN CATCH\n        SELECT \n          ERROR_NUMBER() AS ErrorNumber, \n          ERROR_SEVERITY() AS ErrorSeverity,\n          ERROR_MESSAGE() AS ErrorMessage;\n         IF @@TRANCOUNT &gt; 0\n           ROLLBACK TRANSACTION process_orders;\n       END CATCH\n\n       BEGIN TRANSACTION \n        -- CHANGED\n        SAVE TRANSACTION process_orders\n       BEGIN TRY     \n             -- CHANGED\n                COMMIT TRANSACTION process_orders;     \n       END TRY\n       BEGIN CATCH\n          SELECT \n            ERROR_NUMBER() AS ErrorNumber, \n            ERROR_SEVERITY() AS ErrorSeverity,\n            ERROR_MESSAGE() AS ErrorMessage;\n            IF @@TRANCOUNT &gt; 0\n              ROLLBACK TRANSACTION process_orders ;\n       END CATCH \n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":15,"score":0,"question_id":13128862,"title":"Creating an Entry in Query Result for Date When No Records Exists for That Date in Table","body":"<p>I'm trying to figure out a way to write a query that will pull records for the last 7 days from a log table. The query needs to return the date and the description. If there are no entries for a date, the query still needs to return that date in the results. \nHow do I go about creating a record for a day where there is nothing in the log file for that date?</p>\n\n<p>Thanks,\ncrjunk</p>\n\n<p>This is an example of the expected results:</p>\n\n<pre><code>10/29/2012, null\n\n10/28/2012, null\n\n10/27/2012, null\n\n10/26/2012, \"Error: Unable to load xyz.\"\n\n10/25/2012, null\n\n10/24/2012, null\n\n10/23/2012, null\n</code></pre>\n"},{"tags":["tsql","variables","optimization","while-loop","temptables"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":13128230,"title":"Optimize recursive query using exclusion list","body":"<p>I'm trying to optimizes a recursive query for speed. The full query runs for 15 minutes.\nThe part I'm trying to optimize takes ~3.5min to execute, and the same logic is used twice in the query.</p>\n\n<p>Description:</p>\n\n<pre><code>Table Ret contains over 300K rows with 30 columns (Daily snapshot)\nTable Ret_Wh is the werehouse for Ret with over 5million rows (Snapshot history, 90days)\n</code></pre>\n\n<p>datadate - the day the info was recorded (like 10-01-2012)  </p>\n\n<p>statusA - a status like (Red, Blue) that an account can have.  </p>\n\n<p>statusB - a different status like (Large, Small) that an account can have.  </p>\n\n<p><em>Statuses can change day to day.</em>  </p>\n\n<p>old - an integer age on the account. Age can be increased/decreased if there is a payment on the account. Otherwise incerase by 1 with each day.  </p>\n\n<p>account - the account number, and primary key of a row.  </p>\n\n<p><em>In Ret the account is unique.</em><br>\n<em>In RetWh account is unique per datadate.</em>  </p>\n\n<p>money - dollars in the account<br>\n<strong>Both Ret and Ret_Wh have the columns listed above</strong></p>\n\n<p>Query Goal: Select all accounts from Ret_Wh that had an age in a certain range, at ANY time during he month, and had a specific status while in that range.<br>\nThen select from those results, matching accounts in Ret, with a specific age \"today\", no matter their status.</p>\n\n<p>My Goal: Do this in a way that doesn't take 3.5 minutes</p>\n\n<p>Pseudo_Code:</p>\n\n<pre><code>@sdt='2012-10-01' -- or the beginning of any month\n@dt = getdate()\n\ncreate table #temp (account char(20))\ncreate table #result (account char(20), money money)\n\n\nwhile @sdt &lt; @dt\nBEGIN\n\ninsert into #temp\nselect\n    A.account\n\nfrom Ret_Wh as A\nwhere a.datadate = @sdt\n    and a.statusA = 'Red'\n    and a.statusB = 'Large'\n    and a.old between 61 and 80\n\nset @sdt=(add 1 day to @sdt)\n\nEND\n------\n\nselect distinct\n    b.account\n    ,b.money\n\ninto #result\nfrom #temp as A\njoin (Select account, money from Ret where old = 81) as B\n  on A.account=B.account\n</code></pre>\n\n<p>I want to create a distinct list of accounts in Ret_Wh (call it #shrinking_list). Then, in the while, I join Ret_Wh to #shrkining_list. At the end of the while, I delete one account from #shrinking_list. Then the while iterrates, with a smaller list joined to Ret_Wh, thereby speeding up the query as @sdt increases by 1 day. However, I don't know how to pass the exact same account number selected, to an external variable in the while, so that I can delete it from the #shrinking_list.</p>\n\n<p>Any ideas on that, or how to speed this up in general?</p>\n"},{"tags":["sql","sql-server","tsql","temporary-tables"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":37,"score":2,"question_id":13126578,"title":"SQL Server 2008 - #tmp table throws error when run within an exec command","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/688161/tsql-writing-into-a-temporary-table-from-dynamic-sql\">TSQL Writing into a Temporary Table from Dynamic SQL</a>  </p>\n</blockquote>\n\n\n\n<pre><code> ALTER PROCEDURE [dbo].[usp_ServicesStats1](@PERIOD VARCHAR(30) )\n\n AS\n BEGIN\n-- SET NOCOUNT ON added to prevent extra result SETs FROM\n-- interfering with SELECT statements.\nSET NOCOUNT ON;\n\n\n DELETE FROM servicesstats1;\n DECLARE @QUERY  NVARCHAR(MAX);\n\n DECLARE @mainTable VARCHAR(50)\n\n SET @mainTable = '[ServicesStats' + @PERIOD + ']';\n\n\n\n SET @QUERY = 'INSERT INTO servicesstats1(Department,StudentUsers) \n SELECT department,COUNT(*) FROM ' +  @mainTable + \n 'GROUP BY department';\n\n EXEC(@QUERY); -- runs okay!\n\n\n IF OBJECT_ID('tempdb..[##tmp5]') is not null \nBEGIN \n    drop table [##tmp5] \nEND\n\n SET @QUERY = ' SELECT studentid\n INTO [##tmp5]\n FROM ' + @mainTable + '\n GROUP BY studentid\n having COUNT(*)=1; select * from [##tmp5];';\n PRINT @QUERY;\n\n\n EXEC sp_executesql @QUERY;\n\n IF OBJECT_ID('tempdb..[#tmp3]') is not null \nBEGIN \n    drop table [#tmp3] \nEND\n\n SELECT S.department,COUNT(*) AS No INTO #TMP3 --  ONLY THIS SERVICE \n FROM servicesstats_0511_0412 s, #TMP5 T    -- this is not being replaced yet by the @mainTable\n WHERE S.STUDENTID = T.STUDENTID\n GROUP BY S.department\n</code></pre>\n\n<p>Error : </p>\n\n<blockquote>\n  <p><em>Invalid object name '#TMP5'.</em></p>\n</blockquote>\n\n<p>The problem is temporary table <code>#tmp5</code>, now if I were to run this it would work but it's not dynamic.</p>\n\n<pre><code>SELECT studentid\nINTO [#tmp5]\nFROM tableName\nGROUP BY studentid\nhaving COUNT(*)=1;\n</code></pre>\n\n<p>Basically I'm doing this because of the dynamic table name. But <code>#tmp</code> is throwing that error.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":57,"score":-1,"question_id":13127166,"title":"how to get median for every record?","body":"<p>There's no median function in sql server, so I'm using this wonderful suggestion:</p>\n\n<p><a href=\"http://stackoverflow.com/a/2026609/117700\">http://stackoverflow.com/a/2026609/117700</a></p>\n\n<p>this computes the median over an entire dataset, but I need the median per record.</p>\n\n<p>My dataset is:</p>\n\n<pre><code>+-----------+-------------+\n| client_id | TimesTested |\n+-----------+-------------+\n|    214220 |           1 |\n|    215425 |           1 |\n|    212839 |           4 |\n|    215249 |           1 |\n|    210498 |           3 |\n|    110655 |           1 |\n|    110655 |           1 |\n|    110655 |          12 |\n|    215425 |           4 |\n|    100196 |           1 |\n|    110032 |           1 |\n|    110032 |           1 |\n|    101944 |           3 |\n|    101232 |           2 |\n|    101232 |           1 |\n+-----------+-------------+\n</code></pre>\n\n<p>here's the query I am using:</p>\n\n<pre><code>select client_id,  \n    (\n    SELECT\n    (\n     (SELECT MAX(TimesTested ) FROM\n       (SELECT TOP 50 PERCENT t.TimesTested \n       FROM counted3 t \n       where t.timestested&gt;1 \n       and CLIENT_ID=t.CLIENT_ID \n       ORDER BY t.TimesTested ) AS BottomHalf)\n     +\n     (SELECT MIN(TimesTested ) FROM\n       (SELECT TOP 50 PERCENT t.TimesTested \n       FROM counted3 t \n       where t.timestested&gt;1 \n       and CLIENT_ID=t.CLIENT_ID \n       ORDER BY t.TimesTested DESC) AS TopHalf)\n    ) / 2 AS Median\n    ) TotalAvgTestFreq\nfrom counted3 \n\ngroup by client_id\n</code></pre>\n\n<p>but it is giving my funny data:</p>\n\n<pre><code>+-----------+------------------+\n| client_id | median???????????|\n+-----------+------------------+\n|    100007 |               84 |\n|    100008 |               84 |\n|    100011 |               84 |\n|    100014 |               84 |\n|    100026 |               84 |\n|    100027 |               84 |\n|    100028 |               84 |\n|    100029 |               84 |\n|    100042 |               84 |\n|    100043 |               84 |\n|    100071 |               84 |\n|    100072 |               84 |\n|    100074 |               84 |\n+-----------+------------------+\n</code></pre>\n\n<p><strong>i can i get the median for every client_id ?</strong></p>\n\n<p>I am currently trying to use this <strong>awesome</strong> query from Aaron's site:</p>\n\n<pre><code>select c3.client_id,(\n    SELECT AVG(1.0 * TimesTested ) median\n    FROM\n    (\n        SELECT o.TimesTested , \n        rn = ROW_NUMBER() OVER (ORDER BY o.TimesTested ), c.c\n        FROM counted3 AS o\n        CROSS JOIN (SELECT c = COUNT(*) FROM counted3) AS c\n        where count&gt;1\n    ) AS x\n    WHERE rn IN ((c + 1)/2, (c + 2)/2)\n    ) a\n    from counted3 c3\n    group by c3.client_id\n</code></pre>\n\n<p>unfortunately, as Richardthekiwi points out:</p>\n\n<blockquote>\n  <p>it's for a single median whereas this question is about a median\n  per-partition</p>\n</blockquote>\n\n<p>i would like to know how i can join it on <code>counted3</code> to get the median per partition?></p>\n"},{"tags":["sql","sql-server-2008","tsql","sql-order-by"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":60,"score":1,"question_id":13128296,"title":"SQL Query: Need order by count, most must be on top, the rest follows","body":"<p>TABLEA</p>\n\n<pre><code>JobCode Job1 Job2 Job3 zip\n------- ---- ---- ---- ----------\nF       F    S    NULL 90030\nF       F    S    NULL 90031\nF       F    S    NULL 90031\nF       F    S    NULL 90034\nF       F         NULL 90034\nF       F    S    NULL 90034\nF       F    S    NULL 90034\nF       F         NULL 90034\nF       F    S    NULL 90035\nF       F         NULL 90035-4640\n</code></pre>\n\n<p>EXPECTED RESULTS:</p>\n\n<pre><code>JobCode Job1 Job2 Job3 zip\n------- ---- ---- ---- ----------\nF       F    S    NULL 90034\nF       F         NULL 90034\nF       F    S    NULL 90034\nF       F    S    NULL 90034\nF       F         NULL 90034\nF       F    S    NULL 90031\nF       F    S    NULL 90031\nF       F    S    NULL 90030\nF       F    S    NULL 90035\nF       F         NULL 90035-4640\n</code></pre>\n\n<p>Those with the SAME Zip should be ON top, then the rest follows. \nORDER BY Zip does not work because it DOES sort by ZIP, and NOT by number of occurence</p>\n\n<p>Using SQL Server 08</p>\n"},{"tags":["tsql","sql-server-2008-r2","where","exists"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":57,"score":2,"question_id":13097599,"title":"T-SQL where exists - all - group by?","body":"<p>I use SQL Server 2008 R2.</p>\n\n<p>I have a weird problem as following. I have a table as shown in </p>\n\n<p><img src=\"http://i.stack.imgur.com/6ZWax.jpg\" alt=\"enter image description here\"></p>\n\n<p>I need to write such a query like:</p>\n\n<pre><code>SELECT DISTINCT Field1 \nFROM MYTABLE \nWHERE Field2 IN (96,102)\n</code></pre>\n\n<p>in this query, <code>WHERE Field2 IN (96,102)</code> gives me 96 or 102 or both!</p>\n\n<p>More over, I would like to return rows that contains 96 and 102 at the same time!</p>\n\n<p>Is there any suggestion? please write result oriented...</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":72,"score":1,"question_id":13034169,"title":"how to aggregate values from a pivot?","body":"<p>my query returns a dataset that looks like this:</p>\n\n<pre><code>+-----------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+--------+---------+------------+---------+---------+------------+--------+\n| CLIENT_ID | count1 | TestFreq1 | stdv1 | count2 | TestFreq2 |  stdv2  | count3 | TestFreq3 |  stdv3  | count4 | TestFreq4 |  stdv4  | count5 | TestFreq5 |  stdv5  | count6 | TestFreq6 |  stdv6  | count7 | TestFreq7 |  stdv7  | count8 | TestFreq8 |  stdv8  | count9 | TestFreq9 |  stdv9  | count10 | TestFreq10 | stdv10 | count11 | TestFreq11 | stdv11  | count12 | TestFreq12 | stdv12 |\n+-----------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+--------+---------+------------+---------+---------+------------+--------+\n|    210893 |    136 |         0 |     0 |     81 |        41 | 79.2685 |     19 |        63 | 58.321  |     24 |        21 | 20.4896 |      5 |        25 | 8.228   |      6 |        24 | 24.0638 |      4 |        25 | 24.6103 | 2      | 25        | 2.12132 |      2 |        23 | 21.9203 | 1       | 33         | NULL   |       2 |         29 | 7.77817 | 1       | 38         | NULL   |\n|    123321 |     50 |         0 |     0 |      5 |        26 | 7.87401 |     14 |        45 | 51.8002 |      3 |        25 | 14.7422 |      2 |        22 | 17.6777 |      4 |        36 | 21.4942 |      3 |        36 | 22.2711 | NULL   | NULL      | NULL    |      4 |        35 | 9.30949 | NULL    | NULL       | NULL   |       1 |         31 | NULL    | NULL    | NULL       | NULL   |\n|    454322 |    232 |         0 |     0 |    173 |        10 | 33.8487 |     36 |        36 | 36.6602 |     32 |        15 | 17.485  |     10 |        38 | 22.4809 |     13 |        23 | 20.0477 |      7 |        18 | 11.4143 | 3      | 32        | 24.5425 |      6 |        25 | 16.8602 | 3       | 28         | 21.166 |       2 |         25 | 4.94975 | 1       | 34         | NULL   |\n+-----------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+--------+---------+------------+---------+---------+------------+--------+\n</code></pre>\n\n<p><strong>instead of forcing the data to go out to <code>count13, stdv13, testfreq13, ..14..14..14, 15.15.15</code> how can i aggregate all the values 12 and over in the same field?</strong></p>\n\n<p>here's my query, and thank you so much for your guidance:</p>\n\n<pre><code>;WITH counted AS (\n  SELECT\n    client_id,\n    COUNT(*) AS TimesTested,\n    (datediff(day,MIN(received_date),max(received_date)))\n  /COUNT(*) as TestFreq\n  FROM f_accession_daily\n  GROUP BY\n    client_id,\n    patient_id\n),\ncounted2 as (\n  SELECT\n    client_id,\n    TimesTested,\n    CAST(COUNT(*) AS varchar(30)) AS count,\n    CAST(AVG(testfreq) as varchar(30)) as TestFreq,\n    CAST(STDEV(TestFreq) as varchar(30)) Stdv\n  FROM counted\n  GROUP BY\n    client_id,\n    TimesTested\n    )\n    ,\nunpivoted AS (\n  SELECT\n    client_id,\n    ColumnName + CAST(TimesTested AS varchar(10)) AS ColumnName,\n    ColumnValue\n  FROM counted2\n  UNPIVOT (\n    ColumnValue FOR ColumnName IN (count, TestFreq,stdv)\n  ) u\n),\npivoted AS (\n  SELECT\n    client_id clientid,\n    count1, TestFreq1,stdv1,\n    count2, TestFreq2,stdv2,\n    count3, TestFreq3,stdv3,\n    count4, TestFreq4,stdv4,\n    count5, TestFreq5,stdv5,\n    count6, TestFreq6,stdv6,\n    count7, TestFreq7,stdv7,\n    count8, TestFreq8,stdv8,\n    count9, TestFreq9,stdv9,\n    count10, TestFreq10,stdv10,\n    count11, TestFreq11,stdv11,\n    count12, TestFreq12,stdv12\n  FROM unpivoted\n  PIVOT (\n    MAX(ColumnValue) FOR ColumnName IN (\n      count1,TestFreq1,stdv1,\n      count2,TestFreq2,stdv2,\n      count3,TestFreq3,stdv3,\n      count4,TestFreq4,stdv4,\n      count5,TestFreq5,stdv5,\n      count6,TestFreq6,stdv6,\n      count7,TestFreq7,stdv7,\n    count8, TestFreq8,   stdv8,\n    count9, TestFreq9,   stdv9,\n    count10, TestFreq10,stdv10,\n    count11, TestFreq11,stdv11,\n    count12, TestFreq12,stdv12\n    )\n  ) p\n)\nselect * from pivoted\n</code></pre>\n\n<p>just to clarify i want to return the same exact results, it's just that for the last column i want to aggregate all values that fall into the <code>12+ bucket</code>. all the fields are going to be the same except the last three, which are going to be:</p>\n\n<pre><code>+----------+-------------+---------+\n| count12+ | TestFreq12+ | stdv12+ |\n+----------+-------------+---------+\n| 353      | 32423       | NULL    |\n| NULL     | NULL        | NULL    |\n| 342      | 25324       | NULL    |\n+----------+-------------+---------+\n</code></pre>\n\n<p>please note the much greater numbers above compared to the rest because the <strong>12+</strong> have been aggregated.</p>\n\n<p>thank you so much for your guidance!</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":13122395,"title":"Removing quotes added to column names from Excel import SQL Server 2008","body":"<p>I've noticed that when I use SSMS to import an Excel spreadsheet into SQL Server quotation marks are added.  I've read somewhere that for whatever reason it's necessary for Excel to do this.  Once in SQL Server, these quotes around the column names are useless and I'd like to have a programmatic way to remove them.  The closest thing, which doesn't work, that I have tried to make is <code>EXEC sp_rename 'Table.[\"withquotes\"]', NewColumnName, 'replace(Table.[\"withquotes\",'\"','']</code>.  I'd like to loop through all of the column names in a table and use the <code>replace</code> function wherever a those column names contain quotation marks.  Is there a typical, idiomatic way to do this?</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":5,"view_count":53,"score":-5,"question_id":13125970,"title":"Convert appended text to Date","body":"<pre><code>  convert(datetime,  BIRTH_MM + '/' +  BIRTH_DD + '/' + BIRTH_YY, 103) as Birthdate\n</code></pre>\n\n<p>So the concatenated string looks like this: <code>04/05/88</code></p>\n\n<p>trying to get this working.  </p>\n\n<p>tried this, close I now get a date but it's giving me 1900 for the year or 1905 which is not right</p>\n\n<pre><code>convert(datetime,  BIRTH_MM + BIRTH_DD + BIRTH_YY, 103) as Birthdate\n</code></pre>\n\n<p>UPDATE</p>\n\n<p>tried something out, not quite there yet:</p>\n\n<pre><code> case when(BIRTH_DD &gt; 0 and BIRTH_MM &gt; 0 and BIRTH_YY &gt; 0)\n    then \n            convert(datetime, cast(BIRTH_DD as varchar(1)) + '/' + cast(_BIRTH_MM as varchar(2)) + '/' + cast(BIRTH_YY as varchar(4)), 103)\n    else\n            convert(datetime, '1900-01-01', 103) as Birthdate,\n        end\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":5,"favorite_count":5,"up_vote_count":7,"down_vote_count":0,"view_count":16090,"score":7,"question_id":947281,"title":"Multiple Column Pivot in T-SQL","body":"<p>I am working with a table where there are multiple rows that I need pivoted into columns.  So the pivot is the perfect solution for this, and works well when all I need is one field.  I am needing to return several fields based upon the pivot.  Here is the pseudo code with specifics stripped out:</p>\n\n<pre><code>SELECT \n  field1,\n  [1], [2], [3], [4]\nFROM\n  (\n  SELECT \n    field1, \n    field2, \n    (ROW_NUMBER() OVER(PARTITION BY field1 ORDER BY field2)) RowID\n  FROM tblname\n  ) AS SourceTable\nPIVOT\n  (\n  MAX(field2)\n  FOR RowID IN ([1], [2], [3], [4])\n  ) AS PivotTable;\n</code></pre>\n\n<p>The above syntax works brilliantly, but what do I do when I need to get additional information found in field3, field4....?</p>\n"},{"tags":["database","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":146,"score":1,"question_id":885725,"title":"How do I select all the rows where a varchar field contains non-digit characters?","body":"<p>I want to find all instances in a table where a string field cannot be cast as a number.\nIs there a way to do like a \"try\" in t-sql so that I can get all the id's where the cast failed and delete the value?</p>\n"},{"tags":["sql-server","tsql","ssis"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3127,"score":1,"question_id":1236505,"title":"isdate function in ssis derived component","body":"<p>Hi\n  Is there any way to check Date(like isDate function in TSQL)  column in SSIS package derived column expression after extraction from Sourcefile before loading to target dtabase?</p>\n\n<p>Thanks</p>\n"},{"tags":["linux","tsql","bash","shell","freetds"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":13096018,"title":"freeTDS bash: Executing sql queries in Microsoft SQL server","body":"<p>I am able to connect to a Microsoft SQL Server 2008 instance via a Mint Linux VM using freeTSD and command line to execute sql statements on it. Now I want automate this in a bash script. I am able to successfully login in my bash script:</p>\n\n<pre><code>TDSVER=8.0 tsql -H servername -p 1433 -D dbadmin -U domain\\\\Administrator -P password\n</code></pre>\n\n<p>I then have my SQL query:</p>\n\n<pre><code>USE dbname GO delete from schema.tableA where ID &gt; 5 GO delete from schema.tableB where ID &gt; 5 GO delete from schema.tableC where ID &gt; 5 GO exit\n</code></pre>\n\n<p>This works when doing manually via freeTSD command line, but not when I put in bash file. I followed this post: <a href=\"http://stackoverflow.com/questions/5445374/bash-script-makes-connection-using-freetds-interacts-doesnt-exit-just-hangs\">freeTSD &amp; bash</a>.</p>\n\n<p>Here is my bash script sample:</p>\n\n<pre><code>echo \"USE dbname GO delete from schema.tableA where userid &gt; 5 go delete from schema.tableB where userid &gt; 5 go delete from schema.tableC where ID &gt; 5 GO exit\" &gt; tempfile | TDSVER=8.0 tsql -H servername -p 1433 -D dbname -U domain\\\\Administrator -P password &lt; tempfile\n</code></pre>\n\n<p>the output of the bash script is:</p>\n\n<pre><code>locale is \"en_US.UTF-8\"\nlocale charset is \"UTF-8\"\nDefault database being set to dbname\n1&gt; 2&gt; \n</code></pre>\n\n<p>and then the rest of my script is executed.</p>\n\n<p>Can someone give me a step by step answer to my problem ?</p>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":306,"score":1,"question_id":3616454,"title":"SQL Server: COLLATE CS->CI performance vs UPPER","body":"<p>What's better to use when comparing columns that could contains values with different cases? \nIs Collate faster?\nJust trying to figure this out because in our project with tons of data comparisons.\nwe use:</p>\n\n<pre><code>select * from table t1, table t2 where \nt1.col1 collate SQL_Latin1_General_CP1_CI_AS = t2.colb collate SQL_Latin1_General_CP1_CI_AS \n</code></pre>\n\n<p>why we can't rewrite as:</p>\n\n<pre><code>select * from table t1, table t2 where \nUPPER(t1.col1)  = UPPER(t2.colb)\n</code></pre>\n"},{"tags":["sql","tsql","join"],"answer_count":4,"favorite_count":36,"up_vote_count":23,"down_vote_count":1,"view_count":6829,"score":22,"question_id":3183669,"title":"Difference between JOIN and OUTER JOIN in MySQL","body":"<p>What is the difference in results between:</p>\n\n<ol>\n<li>RIGHT JOIN and RIGHT OUTER JOIN </li>\n<li>LEFT JOIN and LEFT OUTER JOIN ?</li>\n</ol>\n\n<p>Can you please explain it through some examples?</p>\n"}]}
{"total":16599,"page":4,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql","header"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":8365,"score":1,"question_id":4964162,"title":"How to add table column headings to sql select statement","body":"<p>I have a SQL select statement like this:</p>\n\n<pre><code>select FirstName, LastName, Age from People\n</code></pre>\n\n<p>This will return me something like a table:</p>\n\n<pre><code>Peter  Smith    34\nJohn   Walker   46\nPat    Benetar  57\n</code></pre>\n\n<p>What I want is to insert the column headings into the first row like:</p>\n\n<pre><code>First Name  Last Name  Age\n=========== ========== ====\nPeter       Smith      34\nJohn        Walker     46\nPat         Benetar    57\n</code></pre>\n\n<p>Can someone suggest how this could be achieved?</p>\n\n<p>Could you maybe create a temporary table with the headings and append the data one to this?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":49,"score":2,"question_id":13116222,"title":"How to get week number of the month from the date in sql server 2008","body":"<p>In SQL Statement in microsoft sql server, there is a built-in function to get week number but it is the week of the year.</p>\n\n<pre><code>Select DatePart(week, '2012/11/30') // **returns 48**\n</code></pre>\n\n<p>The returned value <strong>48</strong> is the week number of the year. </p>\n\n<p>Instead of <strong>48</strong>, I want to get <strong>1, 2, 3 or 4</strong> (week number of the month). I think the week number of the month can be achieved by modules with Month Number of this week. For e.g.</p>\n\n<pre><code>Select DATEPART(week, '2012/11/30')%MONTH('2012/11/30')\n</code></pre>\n\n<p>But I want to know is there other built-in functions to get WeekNumber of the month in MS SQL SERVER.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":47,"score":3,"question_id":13119350,"title":"using tsql to create a contigious time line set","body":"<p>Long time reader, first time poster. Hoping some SQL guru can lend me some processing power to solve a SQL problem elegantly and without cursors.</p>\n\n<p>I am trying to create a time line type result set from a data set with money and a Date, where the order in which they appear is important. See sample data and expectation below.</p>\n\n<pre><code>DECLARE @OrderData TABLE(\n      ID                      INT IDENTITY,\n      ProductId               INT,\n      WarehouseId             INT,\n      Cost MONEY,\n      SaleDate          DATETIME\n)\n</code></pre>\n\n<p></p>\n\n<pre><code>INSERT INTO @OrderData\nVALUES\n      (1, 1, 2.71, '2012-02-23 10:01')\n      ,(1, 2, 2.71, '2012-02-23 10:02')\n      ,(1, 1, 2.71, '2012-02-23 10:03')\n      ,(1, 1, 2.71, '2012-02-23 10:04')\n      ,(1, 1, 2.71, '2012-02-23 10:05')\n      ,(1, 1, 2.8, '2012-02-23 10:06')\n      ,(1, 1, 2.9, '2012-02-23 10:07')\n      ,(1, 1, 2.71, '2012-02-23 10:08')\n      ,(1, 1, 2.71, '2012-02-23 10:09')\n</code></pre>\n\n<p>The result I am looking for is a time line of sales with from and to dates for a product and warehouse combination within it own set of sales. As soon as the sale price changes in the dataset  this should spawn a new row in the result set.</p>\n\n<p>Result structure for sample data.</p>\n\n<pre><code>Product, warehouse, minsale date, Max sale date\n1,1,2.71, 2012-02-23 10.01, 2012-02-23 10.05\n1,1,2.80, 2012-02-23 10.06, 2012-02-23 10.06\n1,1,2.90, 2012-02-23 10.07, 2012-02-23 10.07\n1,1,2.71, 2012-02-23 10.08, 2012-02-23 10.09\n1,2,2.71, 2012-02-23 10.02, 2012-02-23 10.02\n</code></pre>\n\n<p>Cheers for any help available.</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":0,"favorite_count":1,"up_vote_count":0,"down_vote_count":3,"view_count":34,"score":-3,"question_id":13117898,"title":"need help in joining values of 2 sql queries","body":"<p>m want to add the below query result and have to show in grid after year change</p>\n\n<p>please tell me how to do</p>\n\n<pre><code>SELECT 15- sum(EL) as el, 1 - sum(CL) as cl, 14 - sum(ML) as ml FROM attendance\n//current value of this query\nSELECT 15- sum(EL) as el, 1 - sum(CL) as cl, 14 - sum(ML) as ml\n//new values of this query\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":5491,"score":0,"question_id":388497,"title":"How to switch sql-2005 Select Case When T-sql Naming?","body":"<pre><code>select \n(Case Remark01\nWhen 'l1' then type1\nwhen 'l2' then type2\nend) AS [?] --Remark .....want to switch name in here\nfrom mytable\n</code></pre>\n\n<p>Example ....</p>\n\n<pre><code>select \n(Case level\nWhen 'l1' then type1 ('l1' mean check constant string)\nwhen 'l2' then type2(('l2' mean check constant string))\nend) AS <b>(Case when 'l1' then [type01] Else [type02])</b>\nfrom mytable\n</pre>\n\n<pre>select level,type1,type2 from mytable\n</code></pre>\n\n<p>I using two program this mytable<br>\none program is want to show menu only type1 only<br>\none program is want to show menu only  type2 only<br>\nI using one view using two program..</p>\n"},{"tags":["sql-server","tsql"],"answer_count":12,"favorite_count":2,"up_vote_count":14,"down_vote_count":0,"view_count":50228,"score":14,"question_id":889629,"title":"How to get a date in YYYY-MM-DD format from a TSQL datetime field?","body":"<p>How do I retrieve a date from SQL Server in YYYY-MM-DD format? I need this to work with SQL Server 2000 and up. Is there a simple way to perform this in SQL Server or would it be easier to convert it programatically after I retrieve the result set?</p>\n\n<p>I've read the <a href=\"http://technet.microsoft.com/en-us/library/ms187928.aspx\">CAST and CONVERT</a> on Microsoft Technet, but the format I want isn't listed and changing the date format isn't an option. </p>\n"},{"tags":["tsql","stored-procedures","entity-framework-4","rownumber","complextype"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":690,"score":0,"question_id":4424925,"title":"EF4 SPROC Complex Type Mapping - Problem with ROW_NUMBER()","body":"<p>I've been working with EF4/Stored Procedures/Complex Types for a while now, but i haven't seen this issue before.</p>\n\n<p>I have a stored proc which returns a bunch of fields, mapped to a collection of complex types. Was all working fine until i introduced this extra field.</p>\n\n<p>It's using <code>ROW_NUMBER</code> from T-SQL (used in ranking results):</p>\n\n<pre><code>SELECT ... \n       ROW_NUMBER() OVER (ORDER BY [Field1], [Field2]) AS [SearchRank],\n       ...\nFROM   @ResultSet\n</code></pre>\n\n<p>In my complex type, i have this set as a <strong>non-nullable Int32</strong>, and i'm also using POCO's, so i have this as a regular <code>int</code> on the POCO.</p>\n\n<p>But when i try and execute the query, i get this error:</p>\n\n<blockquote>\n  <p>System.InvalidOperationException: The\n  'SearchRank' property on\n  'RankedLocationSearchResult' could not\n  be set to a 'Int64' value. You must\n  set this property to a non-null value\n  of type 'Int32'.</p>\n</blockquote>\n\n<p>I just don't get it. Nowhere have i said this property/field is Int64. And my property <em>is</em> a non-null value of type 'Int32'.</p>\n\n<p>Now, <strong>i am certain the problem is with ROW_NUMBER()</strong>.</p>\n\n<p>Because if i change that T-SQL to just <code>1 AS [SearchRank]</code> (hard code, for testing), it works fine.</p>\n\n<p>It's almost as like EF sees <code>ROW_NUMBER()</code> as returning Int64.</p>\n\n<p>Why? Do we have to cast this as a 32-bit integer or something?</p>\n\n<p>Anyone had this issue?</p>\n"},{"tags":["mysql","sql","sql-server","database","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":13117710,"title":"How to export all words from sql table or sql database","body":"<p>Let's say we have following table.</p>\n\n<pre>\nUserId | Message\n-------|-------------\n1      | Hi, have a nice day\n2      | Hi, I had a nice day\n\n</pre>\n\n<p>I need to have all { Hi,-have-a-nice-day-I-had } words separately.\nIs there any way to do that ? What if I want to export words from whole database tables ?</p>\n\n<p>Similar results would be also good.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":13117986,"title":"Cannot Add Value to Variable in Sql While Loop","body":"<p>In the following while loop, the variable <code>@total</code> is resulted as <code>NULL</code> when adding selected value from table. If not adding, the result is shown as selected value from table but only the last row's value. </p>\n\n<pre><code>SET @coundDate = '1/1/2012';\n\nWHILE ( Datepart(dd, @countDate) &lt; Datepart(dd, @endDate) )\n  BEGIN\n      SET @total = @total + (SELECT Cast([7am] AS INT) + \n                                    Cast([8am]AS INT) AS TotalHitCount\n                             FROM   Sale\n                             WHERE  TransactionDate = @countDate);\n      SET @countDate = Dateadd(d, 1, @countDate);\n  END;\n\nSELECT @total \n</code></pre>\n\n<p>I'm now confusing a lot. What's that error?</p>\n"},{"tags":["sql","sql-server","tsql","case"],"answer_count":13,"favorite_count":25,"up_vote_count":168,"down_vote_count":0,"view_count":411977,"score":168,"question_id":63447,"title":"How do you perform an IF...THEN in an SQL SELECT?","body":"<p>How do I perform an IF...THEN in an SQL SELECT statement?</p>\n\n<p>For example;</p>\n\n<pre><code>SELECT IF(Obsolete = 'N' or InStock = 'Y';1;0) as Salable, * FROM Product\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":67,"score":1,"question_id":13114627,"title":"SQL Server / T-SQL need to modify dynamic stored procedure?","body":"<p>I have a stored procedure that dynamically generates <code>MERGE</code> TSQL statements to handle SCD Type 1 updates between the given Dimension / Staging table dump.</p>\n\n<p>Here is the T-SQL code (modified from the original code by Alex Whittles):</p>\n\n<pre><code>USE [OPPY_DWUSD]\nGO\n\nALTER PROCEDURE [dbo].[GenerateMerge]\n/***************************************************************\n*                                                              *\n*   Script for use with blog post                              *\n*     \"Automating T-SQL Merge to load Dimensions (SCD)\"        *\n*     http://www.purplefrogsystems.com/blog/2012/04/automating-t-sql-merge-to-load-dimensions-scd\n*                                                              *   \n*   Posted: 6th April 2012                                     *\n*                                                              *\n*   By: Alex Whittles - Purple Frog Business Intelligence      *\n*       www.PurpleFrogSystems.com                              *\n*                                                              *\n*   All code samples are provided AS IS without warranty of  *\n*   any kind, either express or implied, including but not     *\n*   limited to the implied warranties of merchantability       *\n*   and/or fitness for a particular purpose.                   *\n*                                                              *\n***************************************************************/\n\n@Dimension  varchar(50),\n@Schema     varchar(50),\n@ETLTable   varchar(50),\n@ETLSchema  varchar(50),\n@Execute    bit=0  --Should the resulting merge be returned or executed\nAS\nBEGIN\nSET NOCOUNT ON;\n\n--Create Carriage return variable to format the resulting query\nDECLARE @crlf char(2)\nSET @crlf = CHAR(13)\n\n\n--Find out which Audit fields are used\nDECLARE @UseIsInferred bit\nDECLARE @UseFirstCreated bit\nDECLARE @UseValidTo bit\nDECLARE @UseIsRowCurrent bit\nDECLARE @UseLastUpdated bit\n\nSET @UseIsInferred = ISNULL((SELECT MAX(1) \nFROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nWHERE       s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name = 'IsInferred'\n),0)\n\nSET @UseFirstCreated= ISNULL((SELECT MAX(1) \nFROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nWHERE       s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name = 'FirstCreated'\n),0)\n\nSET @UseValidTo = ISNULL((SELECT MAX(1) \nFROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nWHERE       s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name = 'ValidTo'\n),0)\n\nSET @UseIsRowCurrent = ISNULL((SELECT MAX(1) \nFROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nWHERE       s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name = 'IsRowCurrent'\n),0)\n\nSET @UseLastUpdated = ISNULL((SELECT MAX(1) \nFROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\nWHERE       s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name = 'LastUpdated'\n),0)\n\n\n--Identify the business key column(s)\n--Also define what the null replacement should be\nDECLARE myCurBK Cursor FOR \nSELECT c.name\n    , CASE WHEN ty.name IN ('text', 'ntext', 'varchar', 'char', 'nvarchar', 'nchar') THEN ''''''\n        WHEN ty.name IN ('tinyint', 'smallint', 'int', 'real', 'money', 'float', 'bit', 'decimal', 'numeric','smallmoney','bigint') THEN '0'\n        WHEN ty.name IN ('date', 'datetime') THEN '''19000101'''\n        ELSE 'NULL' END AS NullRep\nFROM sys.columns c\n    INNER JOIN sys.tables t on c.object_id = t.object_id\n    INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\n    INNER JOIN sys.types ty ON c.user_type_id = ty.user_type_id\n    INNER JOIN sys.extended_properties ep \n         ON t.object_id=ep.major_id\n        AND c.column_id=ep.minor_id\n        AND ep.class=1\n        AND ep.name='SCD'\nWHERE s.name = @Schema\n    AND t.name = @Dimension\n    AND ep.value = 'BK'\nORDER BY c.column_id\n\n--Identify all fields to be merged (Exclude Type 0)\nDECLARE myCurType1 Cursor\nFOR SELECT c.name\n    , CASE WHEN ty.name IN ('text', 'ntext', 'varchar', 'char', 'nvarchar', 'nchar') THEN ''''''\n        WHEN ty.name IN ('tinyint', 'smallint', 'int', 'real', 'money', 'float', 'bit', 'decimal', 'numeric','smallmoney','bigint') THEN '0'\n        WHEN ty.name IN ('date', 'datetime') THEN '''19000101'''\n        ELSE 'NULL' END AS NullRep\n    FROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\n        INNER JOIN sys.types ty ON c.user_type_id = ty.user_type_id\n        LEFT JOIN sys.extended_properties ep \n             ON t.object_id=ep.major_id\n            AND c.column_id=ep.minor_id\n            AND ep.class=1\n            AND ep.name='SCD'\n    WHERE s.name = @Schema\n        AND t.name = @Dimension\n        AND c.is_identity=0\n        AND ISNULL(ep.value,'1') NOT IN ('0', 'Audit', 'BK')\n    ORDER BY c.column_id ASC\n\n--Identify all fields for insert\nDECLARE myCurAll Cursor\nFOR SELECT c.name\n    , CASE WHEN ty.name IN ('text', 'ntext', 'varchar', 'char', 'nvarchar', 'nchar') THEN ''''''\n        WHEN ty.name IN ('tinyint', 'smallint', 'int', 'real', 'money', 'float', 'bit', 'decimal', 'numeric','smallmoney','bigint') THEN '0'\n        WHEN ty.name IN ('date', 'datetime') THEN '''19000101'''\n        ELSE 'NULL' END AS NullRep\n    FROM sys.columns c\n        INNER JOIN sys.tables t on c.object_id = t.object_id\n        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id\n        INNER JOIN sys.types ty ON c.user_type_id = ty.user_type_id\n    WHERE s.name = @Schema\n        AND t.name = @Dimension\n        AND c.name NOT IN ('LastUpdated', 'IsInferred', 'FirstCreated', 'ValidTo', 'IsRowCurrent')\n        AND c.is_identity=0\n    ORDER BY c.column_id ASC\n\nDECLARE @Field varchar(255)\nDECLARE @NullRep varchar(20)\nDECLARE @SQL varchar(max)\nDECLARE @SQL2 varchar(max)\nDECLARE @SQL3 varchar(max)\n\n--Now start building up the dynamic SQL\n\nSET @SQL ='MERGE [' + @Schema + '].[' + @Dimension + '] AS Target'\nSET @SQL = @SQL + @crlf + 'USING [' + @ETLSchema + '].[' + @ETLTable + '] AS Source'\n\nOPEN myCurBK\nFETCH NEXT FROM myCurBK INTO @Field, @NullRep\nIF (@@FETCH_STATUS&gt;=0)\n    BEGIN\n        SET @SQL = @SQL + @crlf + '       ON Target.' + '[' + @Field + ']' +  ' = Source.' + '[' + @Field + ']'\n        FETCH NEXT FROM myCurBK INTO @Field, @NullRep\n    END\nWHILE (@@FETCH_STATUS&lt;&gt;-1)\nBEGIN\n    IF (@@FETCH_STATUS&lt;&gt;-2)\n        SET @SQL = @SQL + @crlf + '       AND Target.' + '[' + @Field + ']' +  ' = Source.' + '[' + @Field + ']'\n    FETCH NEXT FROM myCurBK INTO @Field, @NullRep\nEND\nCLOSE myCurBK\n\nIF @UseIsRowCurrent&gt;0   SET @SQL = @SQL + @crlf + '       AND Target.IsRowCurrent=1'\n\nSET @SQL = @SQL + @crlf + '    WHEN MATCHED'\n\nOPEN myCurType1\nFETCH NEXT FROM myCurType1 INTO @Field, @NullRep\n\nIF (@@FETCH_STATUS&gt;=0)\n    BEGIN\n        SET @SQL = @SQL + @crlf + '       AND (ISNULL(Target.' + '[' + @Field + ']' + ',' + @NullRep + ') &lt;&gt; ISNULL(Source.' + '[' + @Field + ']' + ',' + @NullRep + ')'\n        FETCH NEXT FROM myCurType1 INTO @Field, @NullRep\n    END\nWHILE (@@FETCH_STATUS&lt;&gt;-1)\nBEGIN\n    IF (@@FETCH_STATUS&lt;&gt;-2)\n        SET @SQL = @SQL + @crlf + '       OR ISNULL(Target.' + '[' + @Field + ']' + ',' + @NullRep + ') &lt;&gt; ISNULL(Source.' + '[' + @Field + ']' + ',' + @NullRep + ')'\n    FETCH NEXT FROM myCurType1 INTO @Field, @NullRep\nEND\nCLOSE myCurType1\n\nSET @SQL = @SQL + @crlf + '      )'\nSET @SQL2 = '    THEN UPDATE SET'\n\nOPEN myCurType1\nFETCH NEXT FROM myCurType1 INTO @Field, @NullRep\nIF (@@FETCH_STATUS&gt;=0)\n    BEGIN\n        SET @SQL2 = @SQL2 + @crlf + '       ' + '[' + @Field + ']' + ' = Source.' + '[' + @Field + ']'\n        FETCH NEXT FROM myCurType1 INTO @Field, @NullRep\n    END\nWHILE (@@FETCH_STATUS&lt;&gt;-1)\nBEGIN\n    IF (@@FETCH_STATUS&lt;&gt;-2)\n        SET @SQL2 = @SQL2 + @crlf + '      ,' + '[' + @Field + ']' + ' = Source.' + '[' + @Field + ']'\n    FETCH NEXT FROM myCurType1 INTO @Field, @NullRep\nEND\nCLOSE myCurType1\n\nIF @UseLastUpdated&gt;0   SET @SQL2 = @SQL2 + @crlf + '      ,LastUpdated = GetDate()'\n\nSET @SQL3 = '    WHEN NOT MATCHED THEN'\nSET @SQL3 = @SQL3 + @crlf + '         INSERT ('\n\nOPEN myCurAll\nFETCH NEXT FROM myCurAll INTO @Field, @NullRep\nIF (@@FETCH_STATUS&gt;=0)\n    BEGIN\n        SET @SQL3 = @SQL3 + @crlf + '           ' + '[' + @Field + ']'\n        FETCH NEXT FROM myCurAll INTO @Field, @NullRep\n    END\nWHILE (@@FETCH_STATUS&lt;&gt;-1)\nBEGIN\n    IF (@@FETCH_STATUS&lt;&gt;-2)\n        SET @SQL3 = @SQL3 + @crlf + '           ,' + '[' + @Field + ']'\n    FETCH NEXT FROM myCurAll INTO @Field, @NullRep\nEND\nCLOSE myCurAll\n\n\nIF @UseIsInferred&gt;0     SET @SQL3 = @SQL3 + @crlf + '           ,IsInferred'\nIF @UseFirstCreated&gt;0   SET @SQL3 = @SQL3 + @crlf + '           ,FirstCreated'\nIF @UseValidTo&gt;0        SET @SQL3 = @SQL3 + @crlf + '           ,ValidTo'\nIF @UseIsRowCurrent&gt;0   SET @SQL3 = @SQL3 + @crlf + '           ,IsRowCurrent'\nIF @UseLastUpdated&gt;0    SET @SQL3 = @SQL3 + @crlf + '           ,LastUpdated'\nSET @SQL3 = @SQL3 + @crlf + '         ) VALUES ('\n\nOPEN myCurAll\nFETCH NEXT FROM myCurAll INTO @Field, @NullRep\nIF (@@FETCH_STATUS&gt;=0)\n    BEGIN\n        SET @SQL3 = @SQL3 + @crlf + '            Source.' + '[' + @Field + ']'\n        FETCH NEXT FROM myCurAll INTO @Field, @NullRep\n    END\nWHILE (@@FETCH_STATUS&lt;&gt;-1)\nBEGIN\n    IF (@@FETCH_STATUS&lt;&gt;-2)\n        SET @SQL3 = @SQL3 + @crlf + '           ,Source.' + '[' + @Field + ']'\n    FETCH NEXT FROM myCurAll INTO @Field, @NullRep\nEND\nCLOSE myCurAll    \n\nIF @UseIsInferred&gt;0     SET @SQL3 = @SQL3 + @crlf + '           ,0'\nIF @UseFirstCreated&gt;0   SET @SQL3 = @SQL3 + @crlf + '           ,GetDate()'\nIF @UseValidTo&gt;0        SET @SQL3 = @SQL3 + @crlf + '           ,NULL'\nIF @UseIsRowCurrent&gt;0   SET @SQL3 = @SQL3 + @crlf + '           ,1'\nIF @UseLastUpdated&gt;0    SET @SQL3 = @SQL3 + @crlf + '           ,GetDate()'\nSET @SQL3 = @SQL3 + @crlf + '         );'\n\n--clean up\nDEALLOCATE myCurType1\nDEALLOCATE myCurAll\nDEALLOCATE myCurBK\n\nIF @Execute = 1\nBEGIN\n    EXEC(@SQL + @SQL2 + @SQL3)           \nEND\nELSE\nBEGIN    \n    PRINT @SQL\n    PRINT @SQL2\n    PRINT @SQL3\nEND\n\nEND\n</code></pre>\n\n<p>In the stored procedure above, when I pass in the variables, it produces this code:</p>\n\n<pre><code>MERGE [DIM].[COMPANY] AS Target\nUSING [DBO].[DWUSD_LIVE] AS Source\n    ON Target.[comp] = Source.[comp]\n WHEN MATCHED\n    AND (ISNULL(Target.[comp name],'') &lt;&gt; ISNULL(Source.[comp name],'')\n    OR ISNULL(Target.[comp description],'') &lt;&gt; ISNULL(Source.[comp description],'')\n   )\nTHEN UPDATE SET\n    [comp name] = Source.[comp name]\n   ,[comp description] = Source.[comp description]\n   ,LastUpdated = GetDate()\nWHEN NOT MATCHED THEN\n      INSERT (\n        [comp]\n        ,[comp name]\n        ,[comp description]\n        ,FirstCreated\n        ,LastUpdated\n      ) VALUES (\n         Source.[comp]\n        ,Source.[comp name]\n        ,Source.[comp description]\n        ,GetDate()\n        ,GetDate()\n      );\n</code></pre>\n\n<p>What I need to be able to do is add a <code>DISTINCT</code> <code>SELECT</code> subquery at the beginning...</p>\n\n<pre><code>MERGE [dim].[Company] AS Target\nUSING (\nSELECT DISTINCT \n[COMP NAME],\n[COMP DESCRIPTION],\n[COMP]\nFROM [dbo].[DWUSD_LIVE]\n) AS Source\n</code></pre>\n\n<p>So that when it looks at the source (staging table) it does a <code>SELECT DISTINCT</code> on the same columns found in the dimension but not including the audit columns (<code>FirstCreated</code> / <code>LastUpdated</code>).</p>\n\n<p>My staging table has duplicate records, thus I only need to <code>SELECT DISTINCT</code> otherwise I end up with multiple records in my dimension.</p>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":1,"favorite_count":1,"up_vote_count":3,"down_vote_count":2,"view_count":48,"score":1,"question_id":13116320,"title":"Summary Row in SQL","body":"<p>I have a stored procedure that returns a set of rows for each <code>ActivityUnitId</code>.</p>\n\n<p>What is needed is the Top 10 rows for each ActivityUnitId based on Hours. I have managed to achieve this, my query looks like</p>\n\n<pre><code>With Data AS\n(SELECT  \n   ProjectID,ActivityUnitID,Description,GroupID,\n   SUM(Hours) AS NoiseHours,\n   ROW_NUMBER() OVER(PARTITION BY ActivityUnitID ORDER BY SUM(Hours) DESC) as 'RowNum'\nFROM         \n   tbl_Sub \nINNER JOIN\n   tbl_AnalysisData ON tbl_Sub.SubActivityID = tbl_AnalysisData.SubActivityID \n     INNER JOIN\n       tbl_Analysis ON tbl_AnalysisData.LookupID = tbl_Analysis.LookupID\n         INNER JOIN\n           tbl_ActivityUnit ON tbl_ActivityUnit.ActivityUnitID = tbl_Sub.ActivityUnitID\n           tbl_Suby.ProjectID = @ProjectID \n         AND\n           tbl_Sub.ActivityUnitID = ISNULL(@ActivityUnitID,tbl_Sub.ActivityUnitID)\nGROUP BY \n  ActivityUnitID,ProjectID,  Description,AUGroupID\n) SELECT * from Data where RowNum&lt;=10\n</code></pre>\n\n<p>The 'RowNum' column contains Row number for each row, value of which has been assigned based to hours. So the First 10 rows contain the rows with top 10 hours.</p>\n\n<p>Now what I want is to add an Extra summary Row in the end for each ActivityUnitID. This will contain the sum of Hours for all the rows that have been left out i.e. summary Row for\nRowNum > 10</p>\n\n<p>So what I'll have in the end is Top 10 rows for each ActivityUnitID + an extra row that would sum up the hours for other rows for that ActivityUnitID </p>\n\n<p>For example lets say I have a table with 2 cols</p>\n\n<pre><code>ID  Hours     RowNum\n1A    30         1\n2B    20         2\n3C    10         3\n4D     5         4\n5E     4         5\n6F     3         6\n</code></pre>\n\n<p>How do I do a select on this so that I get Rows where RowNum &lt;=3 and another row With summation of others</p>\n\n<pre><code>ID  Hours  \n1A   30\n2B   20\n3C   10\nOth  12\n</code></pre>\n"},{"tags":["sql-server","tsql","dynamic-sql"],"answer_count":6,"favorite_count":0,"up_vote_count":8,"down_vote_count":0,"view_count":34635,"score":8,"question_id":662049,"title":"Dynamic SQL results into temp table in SQL Stored procedure","body":"<p>The code is as follows: </p>\n\n<pre><code>ALTER PROCEDURE dbo.pdpd_DynamicCall \n@SQLString varchar(4096) = null\n\nAS\n\nBegin\n\n    create TABLE #T1 ( column_1 varchar(10) , column_2 varchar(100) )\n\n    insert into #T1 \n        execute ('execute ' + @SQLString )\n\n    select * from #T1 \n\nEnd\n</code></pre>\n\n<p>The problem is that I want to call different procedures that can give back different columns.\nTherefore I would have to define the table #T1 generically.\nBut I don't know how.</p>\n\n<p>Can anyone help me on this problem?</p>\n"},{"tags":["sql-server-2008","tsql","geometry","geospatial","spatial"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":13114479,"title":"LineString to find Vehicle Passing through my 2 Line (4 Points)","body":"<p>I have got a task where in I have to Draw 2 lines on Google Map (4 Points) and on Submit event I need to display the Vehicle passing through that points. I am able to draw 2 lines on google map which gives me 4 points in Lat/Longitude format.</p>\n\n<p>Now the main questions is how can I query the database to get the Vehicle passing through two lines. I know I might have to use LineString function in T-SQL but how do i get all the vehicle passing through that lines? Any suggestions is welcome.</p>\n"},{"tags":["sql","tsql","syntax","data-warehouse"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":45,"score":3,"question_id":13105610,"title":"SQL Syntax help, MERGE GROUP BY for Datawarehouse Dimensions","body":"<p>I have a TSQL code that I want to use to update/insert my dimension (SCD Type 1) from a source table, below is the code:</p>\n\n<pre><code>MERGE [dim].[CompanyTest] AS Target\nUSING [dbo].[DWUSD_LIVE] AS Source\n    ON Target.Comp = Source.Comp\n WHEN MATCHED\n    AND (ISNULL(Target.[Comp Name],'') &lt;&gt; ISNULL(Source.[Comp Name],'')\n    OR ISNULL(Target.[Comp Description],'') &lt;&gt; ISNULL(Source.[Comp Description],'')\n   )\nTHEN UPDATE SET\n    [Comp Name] = Source.[Comp Name]\n   ,[Comp Description] = Source.[Comp Description]\n   ,LastUpdated = GetDate()\nWHEN NOT MATCHED THEN\n      INSERT (\n        Comp\n        ,[Comp Name]\n        ,[Comp Description]\n        ,LastUpdated\n      ) VALUES (\n         Source.Comp\n        ,Source.[Comp Name]\n        ,Source.[Comp Description]\n        ,GetDate()\n);\n</code></pre>\n\n<p>My source table has:</p>\n\n<pre><code>[COMP] [COMP NAME] [COMP DESCRIPTION]\n1,100,MyCompany,Service Provider\n1,100,MyCompany,Service Provider\n1,100,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n</code></pre>\n\n<p>When I run the above TSQL once, I get this in my dimension:</p>\n\n<pre><code>[COMP] [COMP NAME] [COMP DESCRIPTION]\n1,100,MyCompany,Service Provider\n1,100,MyCompany,Service Provider\n1,100,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n</code></pre>\n\n<p>The first issue is, when I try to re-run this I get:</p>\n\n<p><strong>Msg 8672, Level 16, State 1, Line 1\nThe MERGE statement attempted to UPDATE or DELETE the same row more than once. This happens when a target row matches more than one source row. A MERGE statement cannot UPDATE/DELETE the same row of the target table multiple times. Refine the ON clause to ensure a target row matches at most one source row, or use the GROUP BY clause to group the source rows.</strong></p>\n\n<p>I understand that I need to insert a \"GROUP BY\" into the statement, how can I do this so that I only get only the distinct rows back from the source table.</p>\n\n<p>Then my Dimension should only have:</p>\n\n<pre><code>[COMP] [COMP NAME] [COMP DESCRIPTION]\n1,100,MyCompany,Service Provider\n2,200,MyCompany,Service Provider\n</code></pre>\n"},{"tags":["tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":13111153,"title":"T-SQL Calculate Percentage","body":"<p>I have a SQL Server (2000) database with customers (health club).</p>\n\n<p>The customers join on a yearly basis. I want to be able to calculate the percentage of customers who renew there membership (over time and an the past current year).   The Active Status field indicates whether they are still a member.<br>\nThe JoinDate doesn't change.  When a member renews there is an ActiveDate and also a\nDueDate (when a customer is due to renew), the DueDate is 1 year ahead of the Active Date.  What I am looking to do is try to get some sense of the % percentage of the customers that renew, broken down by past years if possible or overall.  Any ideas. Thanks. \nThe fields in the customer table contain:</p>\n\n<pre><code>    CustomerID    JOIN Date    Cancel Date   ActiveStatus ActiveDate   DueDate\n\n     12345        10/01/2011   NULL          Yes         10/01/2012  10/01/2013\n\n     12346        1/1/2010     12/31/2011    No          1/1/2010     1/1/2011\n</code></pre>\n"},{"tags":["tsql","format","casting"],"answer_count":10,"favorite_count":2,"up_vote_count":8,"down_vote_count":0,"view_count":19634,"score":8,"question_id":1914682,"title":"T-SQL Format integer to 2-digit string","body":"<p>I can't find a simple way to do this in T-SQL.</p>\n\n<p>I have for example a column (SortExport_CSV) that returns an integer '2' thru 90.\nIf the stored number is a single digit, I need it to convert to a 2 digit string that begins with a 0.\nI have tried to use CAST but I get stuck on how to display the style in the preferred format (0#)</p>\n\n<p>Of course it is easy to do this on the front end (SSRS, MSAccess, Excel, etc) but in this instance I have no front end and must supply the raw dataset with the already formatted 2 digit string.</p>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":13103114,"title":"T:SQL: select values from rows as columns","body":"<p>I have a table for Profiles stores profile properties values in row style, ex:</p>\n\n<pre><code>[ProfileID]     [PropertyDefinitionID]      [PropertyValue]\n1               6                           Jone\n1               7                           Smith\n1               8                           Mr\n1               3                           50000\n</code></pre>\n\n<p>and another table for property definitions :</p>\n\n<pre><code>[PropertyDefinitionID]  [PropertyName]\n6                       FirstName\n7                       LastName\n8                       Prefix\n3                       Salary\n</code></pre>\n\n<p>How to use <code>PIVOT</code> or any other way to show it in this way:</p>\n\n<pre><code>[ProfileID] [FirstName] [LastName]  [Salary]\n1           Jone        Smith       5000\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":456,"score":0,"question_id":9788599,"title":"SQL: Join with substrings","body":"<p>I have a table <strong>A</strong> with the string-column <strong>a</strong> and a table <strong>B</strong> with the string-column <strong>b</strong>. a is a substring of b. Now I want to <strong>join</strong> the the to tables via <strong>a and b</strong>. Is this possible?</p>\n\n<p>I want something like this:</p>\n\n<p><strong><code>Select * from A,B where A.a *\"is substring of\"* B.b</code></strong></p>\n\n<p>How can I write this in <strong>SQL</strong> (Transact-SQL)?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":3,"view_count":58,"score":-1,"question_id":13099038,"title":"Get max of column using sum","body":"<p>I have one table with following data..</p>\n\n<pre><code>saleId amount date\n-------------------------\n  1     2000  10/10/2012\n  2     3000  12/10/2012\n  3     2000  11/12/2012\n  2     3000  12/10/2012\n  1     4000  11/10/2012\n  4     6000  10/10/2012\n</code></pre>\n\n<p>From my table I want result with max of sum amount between dates 10/10/2012 and 12/10/2012 which for the data above will be:</p>\n\n<pre><code>saleId  amount \n---------------\n1       6000\n2       6000\n4       6000\n</code></pre>\n\n<p>Here 6000 is the max of the sums (by saleId) so I want ids 1, 2 and 4.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":13104679,"title":"SQL alias gives \"invalide column name\" for Group By","body":"<p>I have a problem trying to make an alias for new column and using it in GROUP BY clause: </p>\n\n<pre><code>SELECT TOP 100 Percent\ncount(id) AS [items_by_day],    \n(SELECT DATEADD(dd, 0, DATEDIFF(dd, 0, [date]))) AS [date_part]\nFROM [MyDB].[dbo].[MyTable]\nGROUP BY DAY([date]), MONTH([date]), YEAR([date]), date_part\n</code></pre>\n\n<p>I get the following error:</p>\n\n<pre><code>Msg 207, Level 16, State 1, Line 5\nInvalid column name 'date_part'.\n</code></pre>\n\n<p>How is it possible to solve the problem?</p>\n"},{"tags":["tsql","date","duplicates","duplicate-removal"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":13094034,"title":"Removing duplicate date periods","body":"<p>I am working on script to get data from a database with millions of rows and have a problem with gaps in periods. We have decided that gaps less than 10 days should not be considered gaps at all. Thus, these gaps should be deleted (See example below. The bold dates form the real periods of interest)</p>\n\n<ul>\n<li>ID  InDate      OutDate </li>\n<li>1   <strong>2008-10-10</strong>  2009-02-05 </li>\n<li>1   2009-02-08  <strong>2009-05-13</strong></li>\n<li>1   2011-01-01  2011-05-20 </li>\n<li>2   2007-03-17  2008-10-19</li>\n<li>2   <strong>2009-05-30</strong>  2010-10-12 </li>\n<li>2   2010-10-14  <strong>2010-12-31</strong></li>\n</ul>\n\n<p>Thus, several problems arises. The first problem is to identify which Outdates and Indates are that close to each other for the period to be transformed into a single one. The next problem is to move the Outdate from the higher row number to the lower row number (that is up the table). The last problem is to identify and get rid of the rows which are now duplicates.</p>\n\n<p>I have tried to solve the question down below. The first two problems are solved in table #t4a. The strategy in table #t4aa is to get rid of the duplicates by marking the duplicate rows in question in a new (dummy) variable and get rid of all such values (1:s) in a later stage. However, it does not work! All rows are marked with a 0, even those which should be marked with an 1. Any suggestions?</p>\n\n<p>--This temp table measures gaps and creates a new variable OutDate2 which in the cases of a to small gap (less than 11 days) write the next Outdate on the row instead of the original value.</p>\n\n<pre><code>WITH C AS (SELECT Id, InDate, OutDate, ROW_NUMBER() OVER (PARTITION BY Id ORDER BY InDate) Rownum FROM #t4 t4)  \nSELECT cur.Rownum, cur.Id, cur.InDate CurInDate, cur.OutDate, nxt.InDate NxtInDate, DATEDIFF(day, cur.OutDate, nxt.InDate) Number_of_days,   \n  CASE WHEN DATEDIFF(day, cur.OutDate, nxt.InDate)&lt;11 AND DATEDIFF(day, cur.OutDate, nxt.InDate)&gt;0 THEN nxt.OutDate ELSE cur.OutDate END AS OutDate2  \nINTO #t4a  \nFROM C cur  \nLEFT OUTER JOIN C nxt ON (nxt.rownum=cur.rownum+1 AND nxt.Id=cur.Id)\n</code></pre>\n\n<p>--This temp table creates a dummy which identifies the OVERLAP of rows in order for these to be eliminated in a later temporary table. It is this table that does not work.</p>\n\n<pre><code>WITH C AS (SELECT Id, InDate, OutDate, ROW_NUMBER() OVER (PARTITION BY Id ORDER BY InDate) rownum FROM #t4a)  \nSELECT cur.Id, cur.InDate, nxt.OutDate2,   \n  CASE WHEN cur.OutDate2 &lt; nxt.InDate THEN 1.0 ELSE 0.0\n  END AS Overlap  \nINTO #t4aa  \nFROM C cur  \nLEFT OUTER JOIN C nxt on (cur.rownum=nxt.rownum+1 AND cur.Id=nxt.Id)\n</code></pre>\n"},{"tags":["tsql","sql-server-2005","ddl"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":13106647,"title":"TSQL DDL constraint error: \"Line 12: Incorrect syntax near '('.\"","body":"<p>I'm trying to create a table. Here's the creation DDL. I'm encountering an error when I run this on SQL Server 2005 MSDE. I have no idea why - it works fine on 2008/2012.</p>\n\n<pre><code>CREATE TABLE [dbo].[CuCompanyHolidays](\n    [HolidayID] [int] IDENTITY(1,1) NOT NULL,\n    [HolidayName] [varchar](255) NULL,\n    [HolidayDate] [datetime] NULL,\n    [PartOff] [float] NULL,\n    [CreateDate] [datetime] NULL,\n    [LastUpdate] [datetime] NULL,\n CONSTRAINT [PK_cuCompanyHolidays] PRIMARY KEY CLUSTERED \n(\n    [HolidayID] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n\nGO\n</code></pre>\n\n<blockquote>\n  <p>Msg 170, Level 15, State 1, Line 12\n  Line 12: Incorrect syntax near '('.</p>\n</blockquote>\n\n<p>Here's the line the error is highlighting:</p>\n\n<blockquote>\n  <p>)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON PRIMARY</p>\n</blockquote>\n\n<p>How can I resolve this?</p>\n"},{"tags":["sql-server","tsql","sql-server-2008","ssms2008"],"answer_count":3,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":693,"score":5,"question_id":7207779,"title":"Scripts all Sprocs at once with DROP and CREATE","body":"<p>SQL Server 2008</p>\n\n<p><strong>Goal:</strong> To generate scripts for creating sprocs that are already in the DB. Must be one script per file.</p>\n\n<p>I know I can simply right click the database and 'Tasks>Generate Scripts', but that doesn't script the sproc in the template I want.</p>\n\n<p>I need the sproc to be scripted in the same template you get when you right click the sproc from the object explorer and 'Script Stored Procedure As>DROP and CREATE'.</p>\n\n<p>It's true you get a similar version of this through 'Tasks>Generate Scripts' but the main difference is the 'Tasks>Generate Scripts' method creates the script via the <code>dbo.sp_executesql</code> command because you cannot nest a <code>CREATE PROCEDURE</code> inside of an <code>IF</code> block</p>\n\n<p>Tasks>Generate produces this:</p>\n\n<pre><code>USE someDB\nGO\n\nIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'somesproc') AND type in (N'P', N'PC'))\nDROP PROCEDURE someSproc\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nIF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'someSproc') AND type in (N'P', N'PC'))\nBEGIN\nEXEC dbo.sp_executesql @statement = N'-- =============================================\nCREATE PROCEDURE \nAS\nBEGIN\n\nEND\n' \nEND\nGO\n</code></pre>\n\n<p>But I require this (as found from right clicking the sproc):</p>\n\n<pre><code>USE someDB\nGO\n\nIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'someSproc') AND type in (N'P', N'PC'))\nDROP PROCEDURE someSproc\nGO\n\nUSE someDB\nGO\n\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROCEDURE someSproc\n\nAS\nBEGIN\n    SET NOCOUNT ON;\n\nEND\n\nGO\n</code></pre>\n\n<p>Any ideas?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":2441,"score":6,"question_id":2429434,"title":"TSQL: grouping customer orders by week","body":"<p>I have a table with a collection of orders. The fields are:</p>\n\n<ul>\n<li><code>customerName</code> (text) </li>\n<li><code>DateOfOrder</code> (datetime).</li>\n</ul>\n\n<p>I would like to show totals of orders per week per customer. I would like to have it arranged for the Friday of each week so that it looks like this:</p>\n\n<pre><code>all dates follow mm/dd/yyyy\n\n\"bobs pizza\", 3/5/2010, 10\n\"the phone co\",3/5/2010,5\n\"bobs pizza\", 3/12/2010, 3\n\"the phone co\",3/12/2010,11\n</code></pre>\n\n<p>Could somebody please show me how to do this?</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server-2008","tsql","ssis","data-warehouse"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":97,"score":2,"question_id":13061130,"title":"SQL SSIS using Derived Column Transform to deal with null data.. alternatives?","body":"<p>I have a source table that has 200+ columns, I am putting this into SSIS and using \"OLEDB  Source\" component to feed the data in then mapping the flow to a Derived Column Transformation to deal with null numeric/date/text data by replacing it with blank values.</p>\n\n<p>Currently, I am setting in my Derived Column the following expression:</p>\n\n<pre><code>ISNULL([EMPLOYEE ID]) ? \"\" : [EMPLOYEE ID]\n\nISNULL([EMPLOYEE FNAME]) ? \"\" : [EMPLOYEE FNAME]\n</code></pre>\n\n<p>etc...</p>\n\n<p>Since I have 200+ columns, I would have to do this 200 times in the Derived Transform, is there a better way of handling this using SSIS?</p>\n\n<p>Running SQL Server 2008 Standard on Windows 2008R2.</p>\n"},{"tags":["sql-server","tsql","indexing","reverse-engineering"],"answer_count":16,"favorite_count":27,"up_vote_count":45,"down_vote_count":0,"view_count":90233,"score":45,"question_id":765867,"title":"List of all index & index columns in SQL Server DB","body":"<p>How do I get a list of all index &amp; index columns in SQL Server 2005+? The closest I could get is:</p>\n\n<pre><code>select s.name, t.name, i.name, c.name\n from sys.tables t\ninner join sys.schemas s on t.schema_id = s.schema_id\ninner join sys.indexes i on i.object_id = t.object_id\ninner join sys.index_columns ic on ic.object_id = t.object_id\n\tinner join sys.columns c on c.object_id = t.object_id and\n\t\tic.column_id = c.column_id\n\nwhere i.index_id &gt; 0    \nand i.type in (1, 2) -- clustered &amp; nonclustered only\nand i.is_primary_key = 0 -- do not include PK indexes\nand i.is_unique_constraint = 0 -- do not include UQ\nand i.is_disabled = 0\nand i.is_hypothetical = 0\nand ic.key_ordinal &gt; 0\n\norder by ic.key_ordinal\n</code></pre>\n\n<p>which is not exactly what I want. What I want is to list all user-defined indexes (which means no indexes which support unique constraints &amp; primary keys) with all columns (ordered by how do they apper in index definition) plus as much metadata as possible.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","csv"],"answer_count":7,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":7821,"score":3,"question_id":5611715,"title":"Where value in column containing comma delimited values","body":"<p>Hi I am wondering how to write an SQL statement for SQL Server 2008 that Selects entry's where a column contains a value, now the value within the column is a comma delimited list (usually - there could only be one entry (and no leading comma)) so what In checking for is \"is this value contained somewhere within the list?\", for instance:</p>\n\n<pre><code>COLUMN = Cat, Dog, Sparrow, Trout, Cow, Seahorse\nDoes COLUMN contain Cat? YES\nDoes COLUMN contain horse? NO\nDoes COLUMN contain Sheep? NO\n</code></pre>\n\n<p>or</p>\n\n<pre><code>COLUMN = Mouse\nDoes COLUMN contain Hare? NO\nDoes COLUMN contain Mouse? YES\n</code></pre>\n\n<p>etc</p>\n\n<p>I was thinking I could use the 'IN' keyword as such</p>\n\n<pre><code>SELECT id_column FROM table_name WHERE 'Cat' IN COLUMN\n</code></pre>\n\n<p>but this does not work as it seems that you can only use that to check if a column contains one of a series of comma delimited values.</p>\n\n<p>I also cannot use CONTAINS() OR 'LIKE' as this, in the above example would return values for 'horse' as the whole string contains horse in 'Seahorse', and I can't search for the needle plus a comma (if I'm looking for 'horse' the search would be 'horse,') as what if the entry is at the end of a the list?  And I can't search for a comma plus a needle (if I'm looking for 'horse' the search would be ',horse')\nas what if the entry is the first in the list? And I can't use both as what if the entry is the only (single) entry?</p>\n\n<p>Thanks for any help anyone can give.</p>\n\n<p>Cheers.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","common-table-expression","nearest-neighbor"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":13103097,"title":"SQL Server : generating nearest neighbour routes","body":"<p>Having a little trouble with generating routes using a nearest neighbour methodology with SQL Server in T-SQL. </p>\n\n<p><strong>Note:</strong> Using SQL Server 2008, I do not have access to spatial extensions.</p>\n\n<p><strong>Background:</strong></p>\n\n<p>I have a query, which through a series of loops and loops within loops builds routes, however, this query can take in excess of 10 minutes to traverse over 100+ visits.</p>\n\n<p>I have a working system, but I would like to bring the execution time down. Trying to minimise loops as they seem to kill performance. I recently stumbled on CTEs and they have been wonderful for my optimisation so far.</p>\n\n<p>I have the following table populated with all the visits that I have over a given period:</p>\n\n<pre><code>DECLARE @Visits TABLE \n(\n    Unique_ID int identity(1,1), \n    Location_ID int, \n    Day_ID int, \n    Lat float, \n    Long float\n)\n</code></pre>\n\n<p>And I have built a legend of all possible paths per day using:</p>\n\n<pre><code>DECLARE @VisitLegend TABLE  \n(\n    Day_ID int, \n    locationFromId int, \n    locationToId int, \n    distance float\n)\n\nINSERT INTO @VisitLegend (dayId, locationFromId , locationToId , distance)\nSELECT \nv1.Day_ID,\nv1.Unique_ID, \nv2.Unique_ID, \n[dbo].[udf_Distance_Between] (v1.Lat, v1.Long, v2.Lat, v2.Long)\nFROM @Visits v1\nJOIN @Visits v2 on v1.Unique_ID &lt;&gt; v2.Unique_ID \n         AND v1.Current_Day_ID = v2.Current_Day_ID \n         AND NOT (v1.Unique_ID = v2.Unique_ID and v2.Unique_ID = v1.Unique_ID)\n</code></pre>\n\n<p><strong>Question:</strong></p>\n\n<p>Is there a way where I can step through each visit in the <code>@Visits</code> table, traverse the <code>@Visit</code> Legend table by the shortest distance without going to the same visit twice ?</p>\n\n<p>I did make a stab at using a CTE with recursion, however my problem is that I cannot prevent it from selecting a visit again further up the tree, nor can I limit the recursive subset to the smallest distance without trying to use an aggregate or a joined subquery which would only work with references to the parent query.</p>\n\n<p>My current attempt was:</p>\n\n<pre><code>;WITH pathBuilder(dayId, nodeId, distance) AS\n(\n    SELECT Day_ID, Unique_ID, CAST(0.0 as float)\n    FROM @Visits \n        UNION ALL\n    SELECT pb.dayId, vl.locationToId, vl.distance\n    FROM pathBuilder pb\n    JOIN @VisitLegend vl on vl.dayId = pb.dayId \n        and vl.locationFromId = pb.locationId \n)\nSELECT * FROM pathBuilder\n</code></pre>\n\n<p>However I cannot seem to get this to select the locations from the visits table, then step through each in the legend following the shortest and never going back to a <code>visitLocationId</code> that it has already visited.</p>\n\n<p><strong>Intended result:</strong></p>\n\n<p><code>@VisitLegend</code> has the following:</p>\n\n<pre><code>dayId       locationFromId locationToId distance\n----------- -------------- ------------ -----------\n1           1              2            5\n1           1              3            4\n1           2              1            5\n1           2              3            7\n1           3              1            4\n1           3              2            7\n</code></pre>\n\n<p>Which would produce the sequences: </p>\n\n<pre><code>1, 3, 2\n2, 1, 3\n3, 1, 2\n</code></pre>\n\n<p>Any ideas ? Been banging my head against the wall for quite some time on this.</p>\n\n<p>Otherwise is it a case of just using loops and bearing with the execution time?</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["tsql","sorting","rows","multiple-columns"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":13102182,"title":"T-SQL: how to sort table rows based on 2 columns","body":"<p>I'm quite stuck with this problem for sometime now..</p>\n\n<p>How do I sort column A depending on the contents of Column B?</p>\n\n<p>I have this sample:</p>\n\n<pre><code>ID  count   columnA     ColumnB\n-----------------------------------\n12  1      A         B\n13  2      C         D\n14  3      B         C\n</code></pre>\n\n<p>I want to sort it like this:</p>\n\n<pre><code>ID  count   ColumnA     ColumnB\n-----------------------------------\n12  1   A       B\n14  3   B       C\n13  2   C       D\n</code></pre>\n\n<p>so I need to sort the rows if the previous row of <code>ColumnB</code> = the next row of <code>ColumnA</code></p>\n\n<p>I'm thinking a loop? but can't quite imagine how it will work...</p>\n\n<p>I was thinking it will go like this (maybe)</p>\n\n<pre><code>SELECT \n    a.ID, a.ColumnA, a.ColumnB\nFROM \n    TableA WITH a (NOLOCK)\nLEFT JOIN \n    TableA b WITH (NOLOCK) ON a.ID = b.ID AND a.counts = b.counts\nWHERE\n    a.columnB = b.ColumnA\n</code></pre>\n\n<p>the above code isn't working though and I was thinking more on the lines of...</p>\n\n<pre><code>DECLARE @counts int = 1\nDECLARE @done int = 0\n\n--WHILE @done = 0\nBEGIN\n\nSELECT \n    a.ID, a.ColumnA, a.ColumnB\nFROM \n    TableA WITH a (NOLOCK)  \nLEFT JOIN \n    TableA b WITH (NOLOCK)  ON a.ID = b.ID AND a.counts = @counts\nWHERE \n    a.columnB = b.ColumnA\n\nset @count = @count +1\nEND\n</code></pre>\n\n<p>If this was a C code, would be easier for me but T-SQL's syntax is making it a bit harder for a noobie like me.</p>\n\n<p>Any help is greatly appreciated! </p>\n\n<p>Edit: sample code</p>\n\n<pre><code>drop table tablea\ncreate table TableA(\nid int,\ncolA varchar(10),\ncolb varchar(10),\ncounts int\n)\n\ninsert INTO TableA\n(id, cola, colb, counts)\nselect 12, 'Bad', 'Cat', 3\n\ninsert INTO TableA\n(id, cola, colb, counts)\nselect 13, 'Apple', 'Bad', 1\n\ninsert INTO TableA\n(id, cola, colb, counts)\nselect 14, 'Cat', 'Dog', 2\n\nselect * FROM TableA\n\nSELECT a.ID, a.ColA, a.ColB\nFROM TableA a WITH (NOLOCK) \nLEFT JOIN TableA b WITH (NOLOCK) \n     ON a.ID = b.ID\nWhere a.colB = b.ColA\nORDER BY a.ColA ASC\n</code></pre>\n"},{"tags":["sql-server","tsql","variables"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":29,"score":2,"question_id":13103264,"title":"TSQL: Find declared length of a variable","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/9686525/data-type-size-of-variable-in-sql\">Data type size of variable in sql</a>  </p>\n</blockquote>\n\n\n\n<p>Can you find the declared max length of a variable using <code>T-SQL</code>?</p>\n\n<p>For example: </p>\n\n<pre><code>DECLARE @myVar varchar(123) \n</code></pre>\n\n<p>-- How can I find the max length of <code>@myVar</code> would be 123?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":13102146,"title":"Find rows with 2 or more matching properties in another table","body":"<p>This one is stumping me, I will just go ahead and explain via SQL. Here is the data structure:</p>\n\n<p><strong>Property</strong></p>\n\n<pre><code>PropertyId     Name         \n1              Property one\n2              Property two\n</code></pre>\n\n<p><strong>Property Features</strong></p>\n\n<pre><code>PropertyFeatureId     FeatureId     PropertyId\n1                     1             1\n2                     2             1\n3                     1             2\n</code></pre>\n\n<p><strong>Feature</strong></p>\n\n<pre><code>FeatureId     Name\n1             Hot tub\n2             Wifi\n</code></pre>\n\n<p>How would I go about finding all properties that have a hot tub AND wifi? So in the example above I would want propery 1, but not 2. </p>\n\n<p>One way I suppose is inner-joining and filtering by the ones we want, but I want to generalize this so I can find all properties with feature A, B, C and so on.</p>\n"},{"tags":["tsql","reporting-services","ssis"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":375,"score":0,"question_id":5781149,"title":"How to get the number of elements in a SSRS multi-value paramter","body":"<p>I have a SQL Server Reporting Service form that is supposed to query and display metrics across a number of years.</p>\n\n<p>The form can optionally receive years it is supposed to display as a parameter. The problem I have is specifying \"if @year is not set then include everything, otherwise limit to the specified years.\"</p>\n\n<p>The query I have currently is:</p>\n\n<pre><code>SELECT name, collected_year, value, [order]\n  FROM rpt_competency_metric\n WHERE ( len( @year ) = 0 OR collected_year IN ( @year ) )\n   AND competency_id = @competency_id\n</code></pre>\n\n<p>Which works when @year is blank, but fails with the error <code>The len function requires 1 argument.</code> when passing in multiple values.</p>\n\n<p>I've tried <code>count( @year )</code> and <code>DataLength( @year )</code> without success.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","join"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":13098731,"title":"SQL Join Issue return DISTINCT Names","body":"<p>I have the following two tables with data like so:</p>\n\n<pre><code>Table Values\n var_label\n 1\n 2\n 2\n 1\n 3\n\nTable Codes\nvar_code\n1\n2\n4\n2\n</code></pre>\n\n<p>I need to join these tables and get the distinct result.  The var_label and var_code are equal pieces of data.  I want to have the joined output like so:</p>\n\n<pre><code> MyColumn\n1\n2\n3\n4\n</code></pre>\n\n<p>Wht's the best way to do this?</p>\n"},{"tags":["sql-server","tsql","sql-server-2012","common-table-expression","materialized"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":13090037,"title":"T-SQL CTE materializing techniques not working on SQL Server 2012","body":"<p>I have to use the following techniques to materialized my CTEs and increase the view performance:</p>\n\n<pre><code>WITH CTE AS(\n    SELECT TOP 100 PERCENT\n    ORDER BY ...\n)\n\nWITH CTE AS(\n    SELECT TOP 2147483647\n    ORDER BY ...\n)\n</code></pre>\n\n<p>Now, neither of this ways works. Has anyone face the same issue or know if in SQL Server 2012 this things are not valid?</p>\n"},{"tags":["sql","sql-server-2005","tsql","stored-procedures"],"answer_count":6,"favorite_count":1,"up_vote_count":7,"down_vote_count":0,"view_count":17798,"score":7,"question_id":200195,"title":"How can I determine the status of a job?","body":"<p>I have a Stored procedure which schedules a job. This Job takes a lot of time to get completed (approx 30 to 40 min). I need to get to know the status of this Job.\nBelow details would help me</p>\n\n<p>1) How to see the list of all jobs that have got scheduled for a future time and are yet to start</p>\n\n<p>2) How to see the the list of jobs running and the time span from when they are running</p>\n\n<p>3) How to see if the job has completed successfully or has stoped in between because of any error.</p>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":7794,"score":1,"question_id":275737,"title":"How do I compare two datetime fields in SQL Server 2005?","body":"<pre><code>DECLARE  @p_date DATETIME\nSET      @p_date = CONVERT( DATETIME, '14 AUG 2008 10:45:30',?)\n\nSELECT   *\nFROM     table1\nWHERE    column_datetime = @p_date\n</code></pre>\n\n<p>I need to compare date time like:</p>\n\n<pre><code>@p_date=14 AUG 2008 10:45:30\ncolumn_datetime=14 AUG 2008 10:45:30\n</code></pre>\n\n<p>How can I do this?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":13096707,"title":"Passing data into nested cursors in TSQL","body":"<p>I have a cursor that gets data and fetches it into @data_table.  Then in the while loop I want to pass that @data_table into another cursor (as the table name) to run some more processing. I keep getting a declare @data_table error. How do I fix this?</p>\n\n<pre><code>DECLARE @var_name varchar(50)\nDECLARE @data_table varchar(50)\nDECLARE @data_value varchar(50)\n\nDECLARE curDiscreteVars CURSOR LOCAL\n\nFOR SELECT DISTINCT v.var_name, v.data_table \n    FROM dbo.vars v\n    GROUP BY v.var_name, v.data_table\n\n-- Loop through cursor, translating variable values as needed, and generate counts for each val_code for a variable\nOPEN curDiscreteVars\nFETCH NEXT FROM curDiscreteVars \n    INTO @var_name, @data_table\n\nWHILE @@FETCH_STATUS  = 0\nBEGIN\n    --loop through all possible data values\n\n    DECLARE curValues CURSOR LOCAL\n\n    FOR SELECT DISTINCT @var_name  \n        FROM @data_table\n\n    OPEN curValues\n    FETCH NEXT FROM curValues \n        INTO @data_value\n\n    WHILE @@FETCH_STATUS  = 0\n    BEGIN\n        print @var_name\n\n\n\n        FETCH NEXT FROM curValues \n        INTO @data_value\n    END\n\n    CLOSE curValues\n    DEALLOCATE curValues\n\n    FETCH NEXT FROM curDiscreteVars \n    INTO @var_name, @data_table\nEND\n\nCLOSE curDiscreteVars\nDEALLOCATE curDiscreteVars\n</code></pre>\n"},{"tags":["sql","tsql","group-by","agreggate"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1059,"score":1,"question_id":6053840,"title":"How to include BIT type column in SELECT part with out including it on the GROUP BY in T-SQL?","body":"<p>Here is my T-SQL query</p>\n\n<pre><code>SELECT \n    ProductID,\n    VendorID,\n    ProductName= MAX(ProductName),\n    VendorName = MAX(VendorName),\n    IsActive = MAX(IsActive) # This brings error \nFROM ProductVendorAssoc \nGROUP BY  \n    ProductID,\n    VendorID\n</code></pre>\n\n<p>I want to apply <code>GROUP BY</code> only for the <code>ProductID and VendorID</code> fields, but need to populate the <code>ProductID, VendorID, ProductName, VendorName, IsActive</code> fields.</p>\n\n<p>Here I used the agreggate function <code>MAX(ProductName)</code> to avoid <code>ProductName</code> in the group by list. </p>\n\n<p>But the same trick is not working for <code>BIT</code> columns as operand data type bit is invalid for max operator.</p>\n\n<p>How can i include <code>BIT</code> type column in <code>SELEC</code>T part with out including it on the <code>GROUP BY</code>?</p>\n\n<p><strong>Update.</strong></p>\n\n<p>What should I need to do if i need to include an <code>INT</code> column like <code>UserID</code> in <code>SELECT</code> in the same way</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":5,"up_vote_count":13,"down_vote_count":0,"view_count":3367,"score":13,"question_id":2759756,"title":"is it possible to select EXISTS directly as a bit?","body":"<p>I was wondering if it's possible to do something like this (which doesn't work): </p>\n\n<p><code>select cast( (exists(select * from theTable where theColumn like 'theValue%') as bit)</code></p>\n\n<p>Seems like it should be doable, but lots of things that should work in SQL don't ;) I've seen workarounds for this (SELECT 1 where... Exists...) but it seems like I should be able to just cast the result of the exists function as a bit and be done with it.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":13095183,"title":"getting cumulative average per client_ID","body":"<p>I have a table called:</p>\n\n<p><strong>F_Accession_Daily</strong></p>\n\n<pre><code>test_id varchar\nreceived_date date\npatient_id varchar\nclient_id varchar\n</code></pre>\n\n<p>There can be multiple test_id's per patient. Every test_id has only one received_date. every client_id can have multiple patient_id's. </p>\n\n<p>right now I am returning the average test frequency of times tested (<strong>TestFreq</strong>) per <code>client_id</code>. I have a column that will return </p>\n\n<blockquote>\n  <p>[test frequency of patients that had 2 and only 2 tests], [test\n  frequency for patients that had 3 and only 3 tests], [test frequency\n  for patients that had 4 and only 4].....[12 and only 12]. (these are labeled below as testfreq1, testfreq2, testfreq3....testfreq12</p>\n</blockquote>\n\n<p>These are only a client_id basis. </p>\n\n<p>example of the returned data:</p>\n\n<pre><code>+-----------+----------------+---------------+-----------------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+---------+---------+------------+---------+---------+------------+---------+\n| client_id | MonthsCustomer | TotalPatients | Totalaccessions | count1 | TestFreq1 | stdv1 | count2 | TestFreq2 |  stdv2  | count3 | TestFreq3 |  stdv3  | count4 | TestFreq4 |  stdv4  | count5 | TestFreq5 |  stdv5  | count6 | TestFreq6 |  stdv6  | count7 | TestFreq7 |  stdv7  | count8 | TestFreq8 |  stdv8  | count9 | TestFreq9 |  stdv9  | count10 | TestFreq10 | stdv10  | count11 | TestFreq11 | stdv11  | count12 | TestFreq12 | stdv12  |\n+-----------+----------------+---------------+-----------------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+---------+---------+------------+---------+---------+------------+---------+\n|    100001 |             42 |          4289 |           15393 |   1976 |         0 |     0 |    719 |       152 | 202.793 |    385 |       140 | 136.356 |    262 |       130 | 99.5561 |    183 |       117 | 81.273  |    136 |       111 | 71.8437 |    112 |       104 | 62.8288 | 87     | 98        | 51.9194 |     75 |        89 | 49.9136 |      63 |         96 | 40.0267 |      57 |         94 | 37.497  | 45      | 102        | 32.6785 |\n|    100003 |             34 |          2098 |           16026 |    509 |         0 |     0 |    303 |        68 | 97.9581 |    190 |        62 | 55.5366 |    137 |        61 | 50.9664 |    101 |        61 | 48.5921 |     89 |        46 | 27.7256 |     62 |        55 | 38.2849 | 77     | 46        | 27.995  |     60 |        49 | 27.8421 |      51 |         47 | 22.2794 |      48 |         42 | 21.0575 | 40      | 46         | 19.9365 |\n|    100004 |             36 |          5841 |           10693 |   3712 |         0 |     0 |   1122 |       223 | 256.033 |    468 |       236 | 157.251 |    211 |       181 | 103.755 |    165 |       175 | 76.5761 |     86 |       161 | 67.6254 |     46 |       151 | 55.4122 | 13     | 121       | 31.1677 |     12 |       104 | 45.7847 |       2 |         88 | 7.77817 |       3 |         92 | 36.2261 | NULL    | NULL       | NULL    |\n|    100008 |             37 |           581 |            1276 |    249 |         0 |     0 |    174 |        96 | 63.7575 |     91 |        72 | 35.5402 |     38 |        60 | 19.4539 |      9 |        59 | 10.2402 |      5 |        25 | 12.6372 |      1 |        43 | NULL    | NULL   | NULL      | NULL    |      2 |        27 | 4.94975 |       3 |         17 | 12.2202 |       1 |         28 | NULL    | 3       | 21         | 4.04145 |\n+-----------+----------------+---------------+-----------------+--------+-----------+-------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+--------+-----------+---------+---------+------------+---------+---------+------------+---------+---------+------------+---------+\n</code></pre>\n\n<p>I need to add another column that gives the <code>TOTAL AVERAGE TEST FREQUENCY</code> per client_id. </p>\n\n<p>Another words, I would like to get the average of all the patients per client. </p>\n\n<p>the formula to get the average test frequency is:</p>\n\n<pre><code>(max(received_date) - min(received_date) )/ (count(distinct test_id)-1)\n</code></pre>\n\n<p>I need to get the average of above per patient per client, how do I do it?</p>\n\n<p>Thank you so much for your guidance.</p>\n\n<p>here's my current query that returned the above dataset:</p>\n\n<pre><code>with counted as(\n SELECT\n    client_id,\n    --case when COUNT(*)&gt;=12 then 12 else COUNT(*) end  TimesTested, \n    COUNT(*) as timestested,\n    case when count(*)&gt;1 then\n    (datediff(day,MIN(received_date),max(received_date)))\n  /(COUNT(*)-1) \n else\n 0\n end as testfreq\n  FROM f_accession_daily\n  GROUP BY\n    client_id,\n    patient_id    \n\n),counted2 as (\n  SELECT\n    client_id,\n   TimesTested,\n    CAST(COUNT(*) AS varchar(30)) AS count,\n    CAST(AVG(testfreq) as varchar(30)) as TestFreq,\n    CAST(STDEV(TestFreq) as varchar(30)) Stdv\n  FROM counted\n  GROUP BY\n    client_id,\n    TimesTested\n    )\n    ,\nunpivoted AS (\n  SELECT\n    client_id,\n    ColumnName + CAST(TimesTested AS varchar(10)) AS ColumnName,\n    ColumnValue\n  FROM counted2\n  UNPIVOT (\n    ColumnValue FOR ColumnName IN (count, TestFreq,stdv)\n  ) u\n),\npivoted AS (\n  SELECT\n    client_id clientid,\n    count1, TestFreq1,stdv1,\n    count2, TestFreq2,stdv2,\n    count3, TestFreq3,stdv3,\n    count4, TestFreq4,stdv4,\n    count5, TestFreq5,stdv5,\n    count6, TestFreq6,stdv6,\n    count7, TestFreq7,stdv7,\n    count8, TestFreq8,stdv8,\n    count9, TestFreq9,stdv9,\n    count10, TestFreq10,stdv10,\n    count11, TestFreq11,stdv11,\n    count12, TestFreq12,stdv12\n  FROM unpivoted\n  PIVOT (\n    MAX(ColumnValue) FOR ColumnName IN (\n      count1,TestFreq1,stdv1,\n      count2,TestFreq2,stdv2,\n      count3,TestFreq3,stdv3,\n      count4,TestFreq4,stdv4,\n      count5,TestFreq5,stdv5,\n      count6,TestFreq6,stdv6,\n      count7,TestFreq7,stdv7,\n    count8, TestFreq8,   stdv8,\n    count9, TestFreq9,   stdv9,\n    count10, TestFreq10,stdv10,\n    count11, TestFreq11,stdv11,\n    count12, TestFreq12,stdv12\n    )\n  ) p\n)\n,\nPatientStats as\n(\n select \n distinct\n f.client_id\n ,datediff(MM,c.mlis_date_established,GETDATE()) MonthsCustomer\n ,count(distinct patient_id) TotalPatients\n ,count(distinct accession_id) Totalaccessions\n from F_ACCESSION_DAILY f\n left join D_CLIENT c\n on f.CLIENT_ID=c.CLIENT_ID\n group by f.client_id,c.mlis_date_established\n)\n,\nOver12\nas\n(\nselect client_id,SUM(c) sumcount from\n(\nselect CLIENT_ID,COUNT(*) c\nfrom F_ACCESSION_DAILY\ngroup by CLIENT_ID,PATIENT_ID\nhaving count(*)&gt;12\n) a\ngroup by client_id\n)\n, final as (\nSELECT p.*,pivoted.*,Over12.sumcount SumofGreaterThan12\nFROM pivoted\nleft join PatientStats p\non p.CLIENT_ID=pivoted.CLIENTID\nleft join Over12\non over12.CLIENT_ID=p.CLIENT_ID\nwhere p.CLIENT_ID not in (select CLIENTid from SalesDWH..TestPractices)\n)\n/* Get the data into a temp table */\nSELECT * INTO #TempTable\nFROM final\n/* Drop the cloumns that are not needed */\nALTER TABLE #TempTable\nDROP COLUMN clientid\n/* Get results and drop temp table */\nSELECT * FROM #TempTable\norder by 1 \nDROP TABLE #TempTable\n</code></pre>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":1922,"score":2,"question_id":2561280,"title":"SQL left join with multiple rows into one row","body":"<p>Basically, I have two tables, Table A contains the actual items that I care to get out, and Table B is used for language translations.</p>\n\n<p>So, for example, Table A contains the actual content. Anytime text is used within the table, instead of storing actual varchar values, ids are stored that relate back to text stored in Table B. This allows me to by adding a languageID column to Table B, have multiple translations for the same row in the database.</p>\n\n<p>Example:</p>\n\n<h2>Table A</h2>\n\n<ul>\n<li>Title (int) </li>\n<li>Description (int)</li>\n<li>Other Data....</li>\n</ul>\n\n<h2>Table B</h2>\n\n<ul>\n<li>TextID (int) - This is the column\nwhose value is stored in other tables</li>\n<li>LanguageID (int)</li>\n<li>Text (varchar)</li>\n</ul>\n\n<p>My question is more a call for suggestions on how to best handle this. Ideally I want a query that I can use to select from the table, and get the text as opposed to the ids of the text out of the table. Currently when I have two text items in the table this is what I do:</p>\n\n<pre><code>SELECT C.ID, C.Title, D.Text AS Description\nFROM\n(SELECT A.ID, A.Description, B.Text AS Title\nFROM TableA A, TranslationsTable B\nWHERE A.Title = B.TextID AND B.LanguaugeID = 1) C\nLEFT JOIN TranslationsTable D\nON C.Description = D.TextID AND D.LanguaugeID = 1\n</code></pre>\n\n<p>This query gives me the row from Table A I am looking for (using where statements in the inner select statement) with the actual text based on the language ID used instead of the text ids.</p>\n\n<p>This works fine when I am only using one or two text items that need to be translated, but adding a third item or more, it starts to get really messy - essentially another left join on top of the example.</p>\n\n<p>Any suggestions on a better query, or at least a good way to handle 3 or more text items in a single row?</p>\n\n<p>Per suggestions, I've added an example of the two tables:</p>\n\n<pre><code>    Table A  \n    ---------------------------\n    ID    |Title    |Description  \n    ---------------------------  \n    1     |1        |2  \n    ---------------------------  \n    2     |3        |4  \n    --------------------------- \n\n    Table B (Translations Table) \n    ---------------------------\n    ID    |LanguaugeID|Text  \n    ---------------------------  \n    1     |1        |Here is title one\n    ---------------------------  \n    1     |2        |Here is a title one in espanol\n    ---------------------------\n    2     |1        |Here is description one\n    ---------------------------  \n    2     |2        |Here is description one in espanol\n    ---------------------------\n    3     |1        |Title 2\n    ---------------------------  \n    4     |1        |Description 2\n    ---------------------------   \n</code></pre>\n\n<p>What I want is to be able to pull a row out of table A that already has the text from table B, not just the ids - and to be able to do this for several columns that need translations.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","null"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":5,"view_count":74,"score":-4,"question_id":13092010,"title":"Alter every column in the database to disallow nulls in a SQL Server database","body":"<p>I've been struggling with the following problem;</p>\n\n<p>We have a large database with 2000+ columns and we have allowed nulls in the majority of them.\nNow I need a script that goes through all the columns and sets all the null values to a default value and alters the column to disallow nulls while setting the default.</p>\n\n<p>I need a script to do this for all the different datatypes (<code>nvarchar</code>, <code>int</code>, <code>smallint</code>, <code>datetime</code> etc).</p>\n\n<p>The reason I'm doing this is that I'm migrating the code to .net and it's a pain to handle all the null values that shouldn't be nulls.</p>\n\n<p>Also: <a href=\"http://www.bennadel.com/blog/85-Why-NULL-Values-Should-Not-Be-Used-in-a-Database-Unless-Required.htm\" rel=\"nofollow\">http://www.bennadel.com/blog/85-Why-NULL-Values-Should-Not-Be-Used-in-a-Database-Unless-Required.htm</a>\nand: <a href=\"http://msdn.microsoft.com/en-us/library/ms189265(v=sql.105).aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms189265(v=sql.105).aspx</a></p>\n\n<p>Thanks for your time. :)</p>\n"},{"tags":["tsql","escaping"],"answer_count":2,"favorite_count":3,"up_vote_count":10,"down_vote_count":0,"view_count":8476,"score":10,"question_id":863534,"title":"T-SQL : How to escape underscore character in PATINDEX pattern argument?","body":"<p>I've found a solution for finding the position of an underscore with PATINDEX :</p>\n\n<pre><code>DECLARE @a VARCHAR(10)  \nSET     @a = '37_21'\n\nPRINT PATINDEX('%_%', @a)                    -- return 1 (false)\nPRINT PATINDEX('%!%', REPLACE(@a, '_', '!')) -- return 3 (correct)\n</code></pre>\n\n<p>Have you other ideas ?<br />\nLike a way to escape the underscore character ?</p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server-2008","tsql","large-data-volumes"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":43,"score":2,"question_id":13092561,"title":"Inner join and Split on large volume of data","body":"<p>We are working on large volume data (row counts given below) :</p>\n\n<pre><code>Table 1 : 708408568 rows  -- 708 million\nTable 2 : 1416817136 rows -- 1.4 billion\n\nTable 1 Schema:\n----------------\nID -      Int PK\ncolumn2 - Int\n\nTable 2 Schema\n----------------\nTable1ID - Int FK\nSomeColumn - Int\nSomeColumn - Int\n</code></pre>\n\n<p>Table1 has PK1 which servers as FK for Table 2.</p>\n\n<h2>Index details :</h2>\n\n<pre><code>Table1 : \nPK Clustered Index on Id\nNon Clustered (Non Unique) on column2\n\nTable 2 :\nTable1ID (FK) Clustered Index\n</code></pre>\n\n<p>Below is the query which needs to be executed :</p>\n\n<pre><code>SELECT t1.[id]\n      ,t1.[column2]\nFROM  Table1 t1\ninner join Table2 t2\n    on s.id = cs.id\nWHERE t1.[column2] in (select [id] from ConvertCsvToTable('1,2,3,4,5.......10000')) -- 10,000 Comma seperated Ids\n</code></pre>\n\n<p>So to summarize, The inner join on ID should be handled by the clustered index on the same Ids on both PK and FK.\nand as for the \"huge\" Where condition on column2 we have a nonclustered index.</p>\n\n<p>However, the query is taking 4 minutes for a small subset of 100 Ids, we need to pass 10,000 ids.</p>\n\n<p>Is there a better way design wise that we can do this, or possibly does Table Partitioning help?</p>\n\n<p>Just wanted to get some ways of how to solve huge volume Select with Inner Join and Where IN.</p>\n\n<p>Note : ConvertCsvToTable is a Split function which has already been determined to perform optimally.</p>\n\n<p>Thanks !</p>\n"},{"tags":["sql-server","xml","tsql","xpath","xquery"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2039,"score":1,"question_id":711025,"title":"SQL Server XML Query Advice","body":"<p>I'm writing a user-defined function to extract values from an XML column in SQL Server which represents a simple dictionary of string key-value pairs.  The only way I've made it work so far seems overly complex.  Do you have any simplifying suggestions or tips for the <code>DictValue</code> function below?</p>\n\n<pre><code>IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DictValue]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))\nDROP FUNCTION [dbo].[DictValue]\ngo\n\nIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TableWithXmlColumn]') AND type in (N'U'))\nDROP TABLE [dbo].[TableWithXmlColumn]\ngo\n\ncreate table TableWithXmlColumn (\n\tId int identity primary key\n\t,Dict xml\n\t)\ngo\n\ncreate function DictValue(\n\t@id int\n\t,@key nvarchar(max)\n\t) returns nvarchar(max) as begin\n\n\tdeclare @d xml -- string Dictionary\n\tselect @d = Dict from TableWithXmlColumn where Id = @id\n\tdeclare @value xml\n\tselect \n\t\t\t@value = d.Pair.value('data(.)', 'nvarchar(max)')\n\t\tfrom \n\t\t\t@d.nodes('/StringDictionary/Pair') as d(Pair)\n\t\twhere \n\t\t\t@key = d.Pair.value('./@Key', 'nvarchar(max)')\n\n\treturn convert(nvarchar(max), @value)\n\tend\ngo\n\ndeclare @xmlId int\ninsert TableWithXmlColumn (Dict) values (\n\tN'&lt;?xml version=\"1.0\" encoding=\"utf-16\"?&gt;\n\t&lt;StringDictionary&gt;\n\t  &lt;Pair Key=\"color\"&gt;red&lt;/Pair&gt;\n\t  &lt;Pair Key=\"count\"&gt;123&lt;/Pair&gt;\n\t&lt;/StringDictionary&gt;')\nset @xmlId = scope_identity()\n\nselect \n\tdbo.DictValue(@xmlId, 'color') as color\n\t,dbo.DictValue(@xmlId, 'count') as [count]\n</code></pre>\n"},{"tags":["tsql","stored-procedures","table-variable"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":11,"score":0,"question_id":13093266,"title":"How to add subset of fields from stored procedure to table variable?","body":"<pre><code>Declare @tempTableVariable Table(\n    email varchar(50)\n)\n\nInsert INTO @tempTableVariable \nEXEC GetData\n\nselect email\nfrom @tempTableVariable\n</code></pre>\n\n<p>I get the following error:\n\"Column name or number of supplied values does not match table definition.\"</p>\n\n<p>Is there a simple way of getting a subset from GetData without explicitly declaring all the fields in the table variable declaration?  </p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":35,"score":-2,"question_id":13091822,"title":"insert new values without overwriting previous values sql","body":"<p>I have a table i need to add info to for 450 rows, i can identify each row with a unique order number and only need to update 4 of the rows on the table for each order number.</p>\n\n<pre><code>update ordercontacts\nset firstname = 'joe', lastname = 'smith', email = 'joesmith@smith.com', contacttypeid = 13\nwhere orderid = 1284480\n</code></pre>\n\n<p>this just replaced my values so i had to fix that </p>\n\n<p>i tried this as well    </p>\n\n<pre><code>insert into ordercontacts\n(firstname, lastname, email, contacttypeid)\nvalues\n('joe', 'smith', 'jowsmith@smith.com', 13)\nwhere orderid in (1284480)\n</code></pre>\n\n<p>but the syntax is not correct and im not sure what the correct syntax would be</p>\n\n<p>I had thought something like this would work but it doesnt obviously.  Can anyone help me out? Each of the order numbers already has a different contact attached to it, i basically want the end result to be like this:</p>\n\n<pre><code>order     firstname   lastname        email               contacttypeid\n1284480   joe        smith      joesmith@smith.com         13\n1284480   steve      andrews      steve@steve.com         11\n</code></pre>\n\n<p>Im looking to add a new contact on top of one that already exists for each order number.  The syntax for the update i have is only replacing the info that is already there.</p>\n"},{"tags":["sql","xml","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":75,"score":0,"question_id":13090043,"title":"Select XML nodes alongside table values","body":"<p>We have a table which contains XML describing a group of orders which is sent by a remote function. Each row also contains things like an ID, timestamp etc of when the list of orders arrived in our system.</p>\n\n<p>To illustrate:</p>\n\n<pre><code>id | date                     | XML \n1    2012-10-20 06:51:13.683   &lt;customer name=\"Bill\"&gt;&lt;order oId=\"1\"&gt;...&lt;/order&gt;&lt;order oId=\"2&gt;...&lt;/customer&gt;\n2    2012-10-20 07:30:32.833   &lt;customer name=\"Ben\"&gt;&lt;order oId=\"23\"&gt;...&lt;/order&gt;&lt;/customer&gt;\n</code></pre>\n\n<p>I want to select all the orders out, but I also want each order to be selected alongside it's id and date. Some hypothetical results:</p>\n\n<pre><code> id   |  date                  |  Customer | OrderId\n 1      2012-10-20 06:51:13.683    Bill       1\n 1      2012-10-20 06:51:13.683    Bill       2\n 2      2012-10-20 06:51:13.683    Ben        23\n</code></pre>\n\n<p>Looking around, I've found lots of answers like <a href=\"http://stackoverflow.com/questions/5796408/select-xml-nodes-using-tsql\">Select XML nodes using TSQL</a> but these only deal with selecting the first instance of a node. I want to select every order node along with the other table information it's associated with.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql","stored-procedures","sql-server-2008-r2"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":13071984,"title":"Using a variable for the table name in an INSERT statement","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/6877624/is-there-a-way-to-specify-table-name-as-a-string\">Is there a way to specify table name as a string?</a>  </p>\n</blockquote>\n\n\n\n<p>The following script will be executed without error:</p>\n\n<pre><code>DECLARE @SourceDB sysname, @SourceTable sysname, \n        @UserID NVARCHAR(500), @DMLType CHAR(1), @SourceIdent uniqueidentifier, @ChangedData XML,\n        @SQL as NVARCHAR(MAX)\n\n-- xml datatype and its capabilities rock\nSELECT  @SourceDB = T.c.query('/AuditMsg/SourceDb').value('.[1]', 'sysname'),\n        @SourceTable = T.c.query('/AuditMsg/SourceTable').value('.[1]', 'sysname'),\n        @SourceIdent = T.c.query('/AuditMsg/SourceIdent').value('.[1]', 'uniqueidentifier'),\n        @UserID = T.c.query('/AuditMsg/UserId').value('.[1]', 'NVARCHAR(50)'),\n        @DMLType = T.c.query('/AuditMsg/DMLType').value('.[1]', 'CHAR(1)'),\n        @ChangedData = T.c.query('*')\nFROM    @msgBody.nodes('/AuditMsg/ChangedData') T(c)\n\nINSERT INTO dbo.AVE_Stamm(SourceDB, SourceIdent, UserID, DMLType, ChangedData)\nSELECT @SourceDB, @SourceIdent, @UserID, @DMLType, @ChangedData\n</code></pre>\n\n<p>But when I change the <code>INSERT</code> statement to</p>\n\n<pre><code>SET @sql = 'INSERT INTO @SourceTable (SELECT @SourceDB, @SourceIdent, @DMLType, @ChangedData, @UserID)';\nEXEC (@sql);\n</code></pre>\n\n<p>it isn't working anymore. Can please someone help me, what's wrong here?</p>\n\n<p>I use this script in a stored procedure of a SQL Server 2008 R2.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":13088621,"title":"sql server updating new column based on another column from same table","body":"<p>I have a table with composite primary key based on three columns.</p>\n\n<p><code>(Unit, Account, service)</code></p>\n\n<p>I have another two columns: <code>DOB</code> (this holds date of birth) &amp; <code>Age</code> (this is a new int column which needs to be updated based on DOB and the result will be integer value of years)</p>\n\n<p>I know how to retrieve the reslt for Age</p>\n\n<pre><code>select datediff(Year,DOB,GETDATE()) as AGE\n</code></pre>\n\n<p>But not sure how to update entire table based on the rows DOB data.</p>\n\n<p>Columns are <code>Unit, Account, Service, DOB, Age</code></p>\n"},{"tags":["sql-server","tsql","hierarchyid"],"answer_count":1,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":1850,"score":3,"question_id":3564272,"title":"Cannot insert duplicate key in object (GetReparentedValue / hierarchyid)","body":"<p>Using examples I found on the web I have created a function which reparents children using the GetReparentedValue.</p>\n\n<p>However when I have ran the code I get the following error: Cannot insert duplicate key in object.</p>\n\n<p>I understand why (because I am trying to reparent the children and the new parent already has children so I need to know the MAX path (hierarchyid) of the child within the new parent structure, but I don't understand how I'm actually going to do that.</p>\n\n<p>path 0x58</p>\n\n<p>oldPath 0x</p>\n\n<p>new path 0x68</p>\n\n<pre><code>SqlCommand command = new SqlCommand(\"UPDATE Structure SET \" +\n                                    \"Path = \" + path + \".GetReparentedValue\" +\n                                    \"(\" +\n                                      oldPath + \", \" + newPath +\n                                    \")\" +\n                                    \"ParentID = @id \" +\n                                    \"WHERE Path = \" + path, _connection);\n</code></pre>\n\n<p>I have to do this when adding a child so I thought it would need to add this somewhere to the query above but I dont know where <code>path + \".GetDescendant(\" + lastChildPath + \", NULL)</code></p>\n\n<p><strong>Database Table</strong></p>\n\n<pre><code>StructureID   int                         Unchecked  \nPath          hierarchyid                 Unchecked  \nPathLevel     ([Path].[GetLevel]())       Checked  \nDescription   nvarchar(50)                Checked  \nParentID      int                         Checked  \nParentPath    ([Path].[GetAncestor]((1))) Checked  \n</code></pre>\n\n<p>Anyone have any suggestion?</p>\n\n<p>Thanks in advance for any help :-)</p>\n\n<p>Clare</p>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":75,"score":-1,"question_id":13076564,"title":"syntax error near \"Order By\"","body":"<p>I have been staring at this for too long and I can't seem to see where I went wrong\nI have a stored procedure that has to return a bunch of data where the \"ExtractedText\" matches the word the person is searching for</p>\n\n<pre><code>Select @Command = 'select DISTINCT CaseFileEvents.InvestigatorID,convert(nvarchar,EventDate,111) as ''EventDate'',EventTime,EventDesc,TaskID,Privileged,Private,Email,HasAttachments,FName,LName, FName + '' '' + LName as Name ,CaseFileEvents.FileID,CaseFiles.FileName,ItemEntryGradeID, EventDescPlainText\n                from CaseFileEvents\n                join ......\n\n                WHERE '+ @FilterField +' LIKE ''%' + @FilterQuery + '%'' ORDER BY ' + @SortName + ' ' + @SortOrder + ''; this area seems to bug out\n</code></pre>\n\n<p>@FilterField is a column in one of the tables, @FilterQuery is the word the user typed in that it is looking for. @SortName, is the name by wich it gets sorted.</p>\n\n<p>EDIT- command Examples :@FilterField = \"ExtractedText\", @FilterQuery=\"something\", @SortName=\"EventID\", @SortOrder=\"desc\"</p>\n\n<p>This is the error :<code>Msg 156, Level 15, State 1, Line 10\nIncorrect syntax near the keyword 'ORDER'.</code></p>\n\n<p>Full command :<code>WHERE ExtractedText LIKE '%add%' ORDER BY EventID desc;</code></p>\n"},{"tags":["sql-server","tsql","stored-procedures","management-studio"],"answer_count":7,"favorite_count":7,"up_vote_count":23,"down_vote_count":0,"view_count":57116,"score":23,"question_id":125457,"title":"What is the T-SQL syntax to connect to another SQL Server?","body":"<p>If I need to copy a stored procedure (SP) from one SQL Server to another I right click on the SP in SSMS and select Script Stored Procedure as > CREATE to > New Query Editor Window. I then change the connection by right clicking on that window and selecting Connection > Change Connection... and then selecting the new server and F5 to run the create on the new server.</p>\n\n<p>So my question is \"What is the T-SQL syntax to connect to another SQL Server?\" so that I can just paste that in the top of the create script and F5 to run it and it would switch to the new server and run the create script.</p>\n\n<p>While typing the question I realized that if I gave you the back ground to what I'm trying to do that you might come up with a faster and better way from me to accomplish this.</p>\n"},{"tags":["tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":10513,"score":6,"question_id":707610,"title":"Extract the first word of a string in a SQL Server query","body":"<p>What's the best way to extract the first word of a string in sql server query?</p>\n"},{"tags":["tsql","microsoft"],"answer_count":3,"favorite_count":3,"up_vote_count":18,"down_vote_count":0,"view_count":24425,"score":18,"question_id":709120,"title":"How to search for one value in any column of any table inside one MS-SQL database?","body":"<p>Is there a way to search for one value (in my case it is a UID of the type char(64)) inside any column of any table inside one MS-SQL database?</p>\n\n<p>I'm sitting in front of a huge database without any idea how the tables had to be linked together. To find that out I'd like to list all tables and there columns that contain a certain value in any row. Is that possible?</p>\n\n<p><em>One way could be to just dump the entire database into a text file and than use any text-editor to search for the value - but this would be pure pain if the database is too huge.</em></p>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":7,"favorite_count":3,"up_vote_count":19,"down_vote_count":0,"view_count":47176,"score":19,"question_id":1256915,"title":"Remove the last character in a string in T-SQL?","body":"<p>How do I remove the last character in a string in T-SQL?</p>\n\n<p>I.E. \n'TEST STRING'</p>\n\n<p>to return:</p>\n\n<p>'TEST STRIN'</p>\n\n<p>thanks\nDave</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":13087515,"title":"Query for dropping value from field","body":"<p>I have a query that looks at duty and vat information and does calculation based on the returned value.</p>\n\n<p>The column that tells me the duty rates is in the table formatted as either, for example 3.7% or 8% in both bases I need remove the % from my return value. Otherwise my SUM clasue fails.</p>\n\n<p>I have sorted the problem for the 3.7% example with the follwoing:</p>\n\n<pre><code>CASE WHEN CustomsTariff.CommodityCode.StandardDuty = 'Free' THEN '0.0' ELSE SUBSTRING(CustomsTariff.CommodityCode.StandardDuty, 1, 3) END AS DutyRate,\n</code></pre>\n\n<p>This drops the % for any returns where there is decimal palce but I need to add to the CASE to say if the StandardDuty value has no decimal places drop the % character as well without messing up the first statement that looks to the 1st 3 digits.</p>\n\n<p>Thanks.  </p>\n"},{"tags":["sql-server","tsql","sql-server-2005","count"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":28,"score":1,"question_id":13080925,"title":"Counting frequency of values assigned to different types","body":"<p>I apologize in advance for my poor description, I couldn't think of a way to word it better, but I'll try to explain it thoroughly.</p>\n\n<p>Let's say that I have a table setup in this manner:</p>\n\n<h2>Input Table</h2>\n\n<pre><code>Itm Type\nA   Apple\nB   Orange\nC   Apple\nB   Grape\nD   Peaches\nB   Apple\nC   Grapes\nE   Apple\nA   Apple\n</code></pre>\n\n<p>The goal is to produce a table showing each item (A, B, C, D, and E) with the total number of each type that was assigned to that item.</p>\n\n<h2>Goal Output Table</h2>\n\n<pre><code>Itm    Apple  Orange  Grape  Peaches    \nA       2       0       0       0   \nB       1       1       1       0\nC       1       0       1       0\nD       0       0       0       1\nE       1       0       0       0\n</code></pre>\n\n<p>The query I'm using now displays a table where it seems to be summing up all of the types for all of the items and placing that value on each row.</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":89,"score":1,"question_id":13061390,"title":"TSQL calculate percentage","body":"<p>I have a list of customers in a SQL Server database for a health club.\nThe customers are listed with the date they joined and the number of times they have renewed \nI want to be able to calculate the percentage rate of customers that renewed. Any ideas on how I can do this? Thanks.</p>\n"},{"tags":["sql","sql-server","tsql","date"],"answer_count":12,"favorite_count":30,"up_vote_count":90,"down_vote_count":0,"view_count":142209,"score":90,"question_id":113045,"title":"How to return the date part only from a SQL Server datetime datatype","body":"<pre><code>SELECT GETDATE()\n</code></pre>\n\n<p>Returns: <code>2008-09-22 15:24:13.790</code></p>\n\n<p>I want that date part without the time part: <code>2008-09-22 00:00:00.000</code></p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","sql-server-2008-r2"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":13082595,"title":"T-SQL: How to deny update on one column of a table via trigger?","body":"<p>Question: <br />\nIn our SQL-Server 2005 database, we have a table T_Groups.<br />\nT_Groups has, amongst other things, the fields ID (PK) and Name.</p>\n\n<p>Now some idiot in our company used the name as key in a mapping table...<br />\nWhich means now one may not alter a group name, because if one does, the mapping is gone...\n<br />\nNow, until this is resolved, I need to add a restriction to T_Groups, so one can't update the group's name. <br />\nNote that insert should still be possible, and an update that doesn't change the groupname should also be possible.<br /></p>\n\n<p>Also note that the user of the application &amp; the developers have both dbo and sysadmin rights, so REVOKE/DENY won't work.\n<br /><br />\nHow can I do this with a trigger ?</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":3263,"score":0,"question_id":2448714,"title":"Getting average from 3 columns in SQL Server","body":"<p>I have a table with 3 columns (<code>smallint</code>) in SQL Server 2005.</p>\n\n<pre><code>Table Ratings\nratin1 smallint,\nratin2 smallint\nratin3 smallint\n</code></pre>\n\n<p>These columns can have values from <code>0</code> to <code>5</code>.</p>\n\n<p>How can I select the average value of these fields, but only compare fields where the value is greater then <code>0</code>.</p>\n\n<p>So if the column values are <code>1</code>, <code>3</code> ,<code>5</code> - the average has to be <code>3</code>.\nif the values are <code>0</code>, <code>3</code>, <code>5</code> - The average has to be <code>4</code>.</p>\n"},{"tags":["performance","query","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":74,"score":3,"question_id":12854990,"title":"Why would ISNULL improve the performance of a query?","body":"<p>We're currently trying to speedup some queries and we've run into something which I (not a DBA just a .NET developer) cannot explain or comprehent. We're running this query on SQL Server 2005.</p>\n\n<p>We have the following query (made small and simple for the sake of argument);</p>\n\n<pre><code>SELECT    \n    *\nFROM    \n    RandomTable \nWHERE   \n    MoneyColumn &lt;&gt; 0\nGROUP BY\n    SomeColumn\n</code></pre>\n\n<p>This query run in around <strong>three</strong> seconds, then we randomly tried to following to speed it up (shot in the dark really)</p>\n\n<pre><code>SELECT    \n    *\nFROM    \n    RandomTable \nWHERE   \n    isnull(MoneyColumn,0) &lt;&gt; 0\nGROUP BY\n    SomeColumn\n</code></pre>\n\n<p>This reduces the query speed to around <strong>one</strong> second..</p>\n\n<p>This column has no NULL values (yet due to the database design beeing HORRIBLE) it is however NULLABLE...</p>\n\n<p>Is the fact that it's NULLABLE making SQL Server do something to account for this making it slow where the ISNULL isn't beeing mentioned? I simply have no idea why the ISNULL would make it perform faster (and by such a big margin). I'd think SQL would actually have more to do when there is a ISNULL statement in the query.</p>\n\n<p>Can anyone shed some light on this?</p>\n\n<p><strong>EDIT</strong> Execution plans added</p>\n\n<p><strong>With ISNULL</strong></p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"utf-16\"?&gt;\n&lt;ShowPlanXML xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" Version=\"1.0\" Build=\"9.00.5000.00\" xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\"&gt;\n  &lt;BatchSequence&gt;\n    &lt;Batch&gt;\n      &lt;Statements&gt;\n        &lt;StmtSimple StatementCompId=\"1\" StatementEstRows=\"9019.76\" StatementId=\"1\" StatementOptmLevel=\"FULL\" StatementSubTreeCost=\"1.48105\" StatementText=\"SELECT    debiteur_id, MIN(Faktuurdatum) AS OldestOpenInvoiceDate, ISNULL(SUM(Totaal_Open),0) AS TotalOpenAmount&amp;#xD;&amp;#xA;FROM    dbo.tbl_Faktuur &amp;#xD;&amp;#xA;WHERE   (Afgehandeld_NeeJa = 0 OR Afgehandeld_NeeJa IS NULL)&amp;#xD;&amp;#xA;AND        (ISNULL(Totaal_Open,0) &amp;lt;&amp;gt; 0) &amp;#xD;&amp;#xA;--AND        (Totaal_Open &amp;lt;&amp;gt; 0) &amp;#xD;&amp;#xA;GROUP BY debiteur_id\" StatementType=\"SELECT\"&gt;\n          &lt;StatementSetOptions ANSI_NULLS=\"false\" ANSI_PADDING=\"false\" ANSI_WARNINGS=\"false\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"false\" NUMERIC_ROUNDABORT=\"false\" QUOTED_IDENTIFIER=\"false\" /&gt;\n          &lt;QueryPlan DegreeOfParallelism=\"1\" MemoryGrant=\"1520\" CachedPlanSize=\"54\" CompileTime=\"11\" CompileCPU=\"11\" CompileMemory=\"704\"&gt;\n            &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.000901976\" EstimateIO=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"9019.76\" LogicalOp=\"Compute Scalar\" NodeId=\"0\" Parallel=\"false\" PhysicalOp=\"Compute Scalar\" EstimatedTotalSubtreeCost=\"1.48105\"&gt;\n              &lt;OutputList&gt;\n                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                &lt;ColumnReference Column=\"Expr1005\" /&gt;\n              &lt;/OutputList&gt;\n              &lt;ComputeScalar&gt;\n                &lt;DefinedValues&gt;\n                  &lt;DefinedValue&gt;\n                    &lt;ColumnReference Column=\"Expr1005\" /&gt;\n                    &lt;ScalarOperator ScalarString=\"isnull([Expr1004],($0.0000))\"&gt;\n                      &lt;Intrinsic FunctionName=\"isnull\"&gt;\n                        &lt;ScalarOperator&gt;\n                          &lt;Identifier&gt;\n                            &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                          &lt;/Identifier&gt;\n                        &lt;/ScalarOperator&gt;\n                        &lt;ScalarOperator&gt;\n                          &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                        &lt;/ScalarOperator&gt;\n                      &lt;/Intrinsic&gt;\n                    &lt;/ScalarOperator&gt;\n                  &lt;/DefinedValue&gt;\n                &lt;/DefinedValues&gt;\n                &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.291662\" EstimateIO=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"9019.76\" LogicalOp=\"Compute Scalar\" NodeId=\"1\" Parallel=\"false\" PhysicalOp=\"Compute Scalar\" EstimatedTotalSubtreeCost=\"1.48014\"&gt;\n                  &lt;OutputList&gt;\n                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                    &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                    &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                  &lt;/OutputList&gt;\n                  &lt;ComputeScalar&gt;\n                    &lt;DefinedValues&gt;\n                      &lt;DefinedValue&gt;\n                        &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                        &lt;ScalarOperator ScalarString=\"CASE WHEN [Expr1013]=(0) THEN NULL ELSE [Expr1014] END\"&gt;\n                          &lt;IF&gt;\n                            &lt;Condition&gt;\n                              &lt;ScalarOperator&gt;\n                                &lt;Compare CompareOp=\"EQ\"&gt;\n                                  &lt;ScalarOperator&gt;\n                                    &lt;Identifier&gt;\n                                      &lt;ColumnReference Column=\"Expr1013\" /&gt;\n                                    &lt;/Identifier&gt;\n                                  &lt;/ScalarOperator&gt;\n                                  &lt;ScalarOperator&gt;\n                                    &lt;Const ConstValue=\"(0)\" /&gt;\n                                  &lt;/ScalarOperator&gt;\n                                &lt;/Compare&gt;\n                              &lt;/ScalarOperator&gt;\n                            &lt;/Condition&gt;\n                            &lt;Then&gt;\n                              &lt;ScalarOperator&gt;\n                                &lt;Const ConstValue=\"NULL\" /&gt;\n                              &lt;/ScalarOperator&gt;\n                            &lt;/Then&gt;\n                            &lt;Else&gt;\n                              &lt;ScalarOperator&gt;\n                                &lt;Identifier&gt;\n                                  &lt;ColumnReference Column=\"Expr1014\" /&gt;\n                                &lt;/Identifier&gt;\n                              &lt;/ScalarOperator&gt;\n                            &lt;/Else&gt;\n                          &lt;/IF&gt;\n                        &lt;/ScalarOperator&gt;\n                      &lt;/DefinedValue&gt;\n                    &lt;/DefinedValues&gt;\n                    &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.291662\" EstimateIO=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"9019.76\" LogicalOp=\"Aggregate\" NodeId=\"2\" Parallel=\"false\" PhysicalOp=\"Hash Match\" EstimatedTotalSubtreeCost=\"1.48014\"&gt;\n                      &lt;OutputList&gt;\n                        &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                        &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                        &lt;ColumnReference Column=\"Expr1013\" /&gt;\n                        &lt;ColumnReference Column=\"Expr1014\" /&gt;\n                      &lt;/OutputList&gt;\n                      &lt;MemoryFractions Input=\"1\" Output=\"1\" /&gt;\n                      &lt;RunTimeInformation&gt;\n                        &lt;RunTimeCountersPerThread Thread=\"0\" ActualRows=\"156794\" ActualEndOfScans=\"1\" ActualExecutions=\"1\" /&gt;\n                      &lt;/RunTimeInformation&gt;\n                      &lt;Hash&gt;\n                        &lt;DefinedValues&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                            &lt;ScalarOperator ScalarString=\"MIN([directpay].[dbo].[tbl_Faktuur].[Faktuurdatum])\"&gt;\n                              &lt;Aggregate AggType=\"MIN\" Distinct=\"false\"&gt;\n                                &lt;ScalarOperator&gt;\n                                  &lt;Identifier&gt;\n                                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                                  &lt;/Identifier&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/Aggregate&gt;\n                            &lt;/ScalarOperator&gt;\n                          &lt;/DefinedValue&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Column=\"Expr1013\" /&gt;\n                            &lt;ScalarOperator ScalarString=\"COUNT_BIG([directpay].[dbo].[tbl_Faktuur].[Totaal_Open])\"&gt;\n                              &lt;Aggregate AggType=\"COUNT_BIG\" Distinct=\"false\"&gt;\n                                &lt;ScalarOperator&gt;\n                                  &lt;Identifier&gt;\n                                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                                  &lt;/Identifier&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/Aggregate&gt;\n                            &lt;/ScalarOperator&gt;\n                          &lt;/DefinedValue&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Column=\"Expr1014\" /&gt;\n                            &lt;ScalarOperator ScalarString=\"SUM([directpay].[dbo].[tbl_Faktuur].[Totaal_Open])\"&gt;\n                              &lt;Aggregate AggType=\"SUM\" Distinct=\"false\"&gt;\n                                &lt;ScalarOperator&gt;\n                                  &lt;Identifier&gt;\n                                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                                  &lt;/Identifier&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/Aggregate&gt;\n                            &lt;/ScalarOperator&gt;\n                          &lt;/DefinedValue&gt;\n                        &lt;/DefinedValues&gt;\n                        &lt;HashKeysBuild&gt;\n                          &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                        &lt;/HashKeysBuild&gt;\n                        &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.255\" EstimateIO=\"0.634196\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"27420\" LogicalOp=\"Index Seek\" NodeId=\"4\" Parallel=\"false\" PhysicalOp=\"Index Seek\" EstimatedTotalSubtreeCost=\"0.889196\"&gt;\n                          &lt;OutputList&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                          &lt;/OutputList&gt;\n                          &lt;RunTimeInformation&gt;\n                            &lt;RunTimeCountersPerThread Thread=\"0\" ActualRows=\"298726\" ActualEndOfScans=\"1\" ActualExecutions=\"1\" /&gt;\n                          &lt;/RunTimeInformation&gt;\n                          &lt;IndexScan Ordered=\"true\" ScanDirection=\"FORWARD\" ForcedIndex=\"false\" NoExpandHint=\"false\"&gt;\n                            &lt;DefinedValues&gt;\n                              &lt;DefinedValue&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                              &lt;/DefinedValue&gt;\n                              &lt;DefinedValue&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                              &lt;/DefinedValue&gt;\n                              &lt;DefinedValue&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                              &lt;/DefinedValue&gt;\n                            &lt;/DefinedValues&gt;\n                            &lt;Object Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Index=\"[_dta_index_tbl_Faktuur_5_583009158__K13_K9_K19_K2_5]\" /&gt;\n                            &lt;SeekPredicates&gt;\n                              &lt;SeekPredicate&gt;\n                                &lt;Prefix ScanType=\"EQ\"&gt;\n                                  &lt;RangeColumns&gt;\n                                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Afgehandeld_NeeJa\" /&gt;\n                                  &lt;/RangeColumns&gt;\n                                  &lt;RangeExpressions&gt;\n                                    &lt;ScalarOperator ScalarString=\"(0)\"&gt;\n                                      &lt;Const ConstValue=\"(0)\" /&gt;\n                                    &lt;/ScalarOperator&gt;\n                                  &lt;/RangeExpressions&gt;\n                                &lt;/Prefix&gt;\n                              &lt;/SeekPredicate&gt;\n                            &lt;/SeekPredicates&gt;\n                            &lt;Predicate&gt;\n                              &lt;ScalarOperator ScalarString=\"isnull([directpay].[dbo].[tbl_Faktuur].[Totaal_Open],($0.0000))&amp;lt;($0.0000) OR isnull([directpay].[dbo].[tbl_Faktuur].[Totaal_Open],($0.0000))&amp;gt;($0.0000)\"&gt;\n                                &lt;Logical Operation=\"OR\"&gt;\n                                  &lt;ScalarOperator&gt;\n                                    &lt;Compare CompareOp=\"LT\"&gt;\n                                      &lt;ScalarOperator&gt;\n                                        &lt;Intrinsic FunctionName=\"isnull\"&gt;\n                                          &lt;ScalarOperator&gt;\n                                            &lt;Identifier&gt;\n                                              &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                                            &lt;/Identifier&gt;\n                                          &lt;/ScalarOperator&gt;\n                                          &lt;ScalarOperator&gt;\n                                            &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                          &lt;/ScalarOperator&gt;\n                                        &lt;/Intrinsic&gt;\n                                      &lt;/ScalarOperator&gt;\n                                      &lt;ScalarOperator&gt;\n                                        &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                      &lt;/ScalarOperator&gt;\n                                    &lt;/Compare&gt;\n                                  &lt;/ScalarOperator&gt;\n                                  &lt;ScalarOperator&gt;\n                                    &lt;Compare CompareOp=\"GT\"&gt;\n                                      &lt;ScalarOperator&gt;\n                                        &lt;Intrinsic FunctionName=\"isnull\"&gt;\n                                          &lt;ScalarOperator&gt;\n                                            &lt;Identifier&gt;\n                                              &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                                            &lt;/Identifier&gt;\n                                          &lt;/ScalarOperator&gt;\n                                          &lt;ScalarOperator&gt;\n                                            &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                          &lt;/ScalarOperator&gt;\n                                        &lt;/Intrinsic&gt;\n                                      &lt;/ScalarOperator&gt;\n                                      &lt;ScalarOperator&gt;\n                                        &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                      &lt;/ScalarOperator&gt;\n                                    &lt;/Compare&gt;\n                                  &lt;/ScalarOperator&gt;\n                                &lt;/Logical&gt;\n                              &lt;/ScalarOperator&gt;\n                            &lt;/Predicate&gt;\n                          &lt;/IndexScan&gt;\n                        &lt;/RelOp&gt;\n                      &lt;/Hash&gt;\n                    &lt;/RelOp&gt;\n                  &lt;/ComputeScalar&gt;\n                &lt;/RelOp&gt;\n              &lt;/ComputeScalar&gt;\n            &lt;/RelOp&gt;\n          &lt;/QueryPlan&gt;\n        &lt;/StmtSimple&gt;\n      &lt;/Statements&gt;\n    &lt;/Batch&gt;\n  &lt;/BatchSequence&gt;\n&lt;/ShowPlanXML&gt;\n</code></pre>\n\n<p><strong>Without ISNULL</strong></p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"utf-16\"?&gt;\n&lt;ShowPlanXML xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" Version=\"1.0\" Build=\"9.00.5000.00\" xmlns=\"http://schemas.microsoft.com/sqlserver/2004/07/showplan\"&gt;\n  &lt;BatchSequence&gt;\n    &lt;Batch&gt;\n      &lt;Statements&gt;\n        &lt;StmtSimple StatementCompId=\"1\" StatementEstRows=\"1322.43\" StatementId=\"1\" StatementOptmLevel=\"FULL\" StatementOptmEarlyAbortReason=\"GoodEnoughPlanFound\" StatementSubTreeCost=\"0.274954\" StatementText=\"SELECT    debiteur_id, MIN(Faktuurdatum) AS OldestOpenInvoiceDate, ISNULL(SUM(Totaal_Open),0) AS TotalOpenAmount&amp;#xD;&amp;#xA;FROM    dbo.tbl_Faktuur &amp;#xD;&amp;#xA;WHERE   (Afgehandeld_NeeJa = 0 OR Afgehandeld_NeeJa IS NULL)&amp;#xD;&amp;#xA;--AND        (ISNULL(Totaal_Open,0) &amp;lt;&amp;gt; 0) &amp;#xD;&amp;#xA;AND        (Totaal_Open &amp;lt;&amp;gt; 0) &amp;#xD;&amp;#xA;GROUP BY debiteur_id\" StatementType=\"SELECT\"&gt;\n          &lt;StatementSetOptions ANSI_NULLS=\"false\" ANSI_PADDING=\"false\" ANSI_WARNINGS=\"false\" ARITHABORT=\"true\" CONCAT_NULL_YIELDS_NULL=\"false\" NUMERIC_ROUNDABORT=\"false\" QUOTED_IDENTIFIER=\"false\" /&gt;\n          &lt;QueryPlan CachedPlanSize=\"47\" CompileTime=\"9\" CompileCPU=\"9\" CompileMemory=\"528\"&gt;\n            &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.000132243\" EstimateIO=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"1322.43\" LogicalOp=\"Compute Scalar\" NodeId=\"0\" Parallel=\"false\" PhysicalOp=\"Compute Scalar\" EstimatedTotalSubtreeCost=\"0.274954\"&gt;\n              &lt;OutputList&gt;\n                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                &lt;ColumnReference Column=\"Expr1005\" /&gt;\n              &lt;/OutputList&gt;\n              &lt;ComputeScalar&gt;\n                &lt;DefinedValues&gt;\n                  &lt;DefinedValue&gt;\n                    &lt;ColumnReference Column=\"Expr1005\" /&gt;\n                    &lt;ScalarOperator ScalarString=\"isnull([Expr1004],($0.0000))\"&gt;\n                      &lt;Intrinsic FunctionName=\"isnull\"&gt;\n                        &lt;ScalarOperator&gt;\n                          &lt;Identifier&gt;\n                            &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                          &lt;/Identifier&gt;\n                        &lt;/ScalarOperator&gt;\n                        &lt;ScalarOperator&gt;\n                          &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                        &lt;/ScalarOperator&gt;\n                      &lt;/Intrinsic&gt;\n                    &lt;/ScalarOperator&gt;\n                  &lt;/DefinedValue&gt;\n                &lt;/DefinedValues&gt;\n                &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.167304\" EstimateIO=\"0\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"1322.43\" LogicalOp=\"Aggregate\" NodeId=\"1\" Parallel=\"false\" PhysicalOp=\"Hash Match\" EstimatedTotalSubtreeCost=\"0.274822\"&gt;\n                  &lt;OutputList&gt;\n                    &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                    &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                    &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                  &lt;/OutputList&gt;\n                  &lt;MemoryFractions Input=\"0\" Output=\"0\" /&gt;\n                  &lt;Hash&gt;\n                    &lt;DefinedValues&gt;\n                      &lt;DefinedValue&gt;\n                        &lt;ColumnReference Column=\"Expr1003\" /&gt;\n                        &lt;ScalarOperator ScalarString=\"MIN([directpay].[dbo].[tbl_Faktuur].[Faktuurdatum])\"&gt;\n                          &lt;Aggregate AggType=\"MIN\" Distinct=\"false\"&gt;\n                            &lt;ScalarOperator&gt;\n                              &lt;Identifier&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                              &lt;/Identifier&gt;\n                            &lt;/ScalarOperator&gt;\n                          &lt;/Aggregate&gt;\n                        &lt;/ScalarOperator&gt;\n                      &lt;/DefinedValue&gt;\n                      &lt;DefinedValue&gt;\n                        &lt;ColumnReference Column=\"Expr1004\" /&gt;\n                        &lt;ScalarOperator ScalarString=\"SUM([directpay].[dbo].[tbl_Faktuur].[Totaal_Open])\"&gt;\n                          &lt;Aggregate AggType=\"SUM\" Distinct=\"false\"&gt;\n                            &lt;ScalarOperator&gt;\n                              &lt;Identifier&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                              &lt;/Identifier&gt;\n                            &lt;/ScalarOperator&gt;\n                          &lt;/Aggregate&gt;\n                        &lt;/ScalarOperator&gt;\n                      &lt;/DefinedValue&gt;\n                    &lt;/DefinedValues&gt;\n                    &lt;HashKeysBuild&gt;\n                      &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                    &lt;/HashKeysBuild&gt;\n                    &lt;RelOp AvgRowSize=\"23\" EstimateCPU=\"0.030319\" EstimateIO=\"0.0771991\" EstimateRebinds=\"0\" EstimateRewinds=\"0\" EstimateRows=\"27420\" LogicalOp=\"Index Seek\" NodeId=\"2\" Parallel=\"false\" PhysicalOp=\"Index Seek\" EstimatedTotalSubtreeCost=\"0.107518\"&gt;\n                      &lt;OutputList&gt;\n                        &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                        &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                        &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                      &lt;/OutputList&gt;\n                      &lt;IndexScan Ordered=\"true\" ScanDirection=\"FORWARD\" ForcedIndex=\"false\" NoExpandHint=\"false\"&gt;\n                        &lt;DefinedValues&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Debiteur_ID\" /&gt;\n                          &lt;/DefinedValue&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Faktuurdatum\" /&gt;\n                          &lt;/DefinedValue&gt;\n                          &lt;DefinedValue&gt;\n                            &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                          &lt;/DefinedValue&gt;\n                        &lt;/DefinedValues&gt;\n                        &lt;Object Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Index=\"[_dta_index_tbl_Faktuur_5_583009158__K13_K9_K19_K2_5]\" /&gt;\n                        &lt;SeekPredicates&gt;\n                          &lt;SeekPredicate&gt;\n                            &lt;Prefix ScanType=\"EQ\"&gt;\n                              &lt;RangeColumns&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Afgehandeld_NeeJa\" /&gt;\n                              &lt;/RangeColumns&gt;\n                              &lt;RangeExpressions&gt;\n                                &lt;ScalarOperator ScalarString=\"(0)\"&gt;\n                                  &lt;Const ConstValue=\"(0)\" /&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/RangeExpressions&gt;\n                            &lt;/Prefix&gt;\n                            &lt;EndRange ScanType=\"LT\"&gt;\n                              &lt;RangeColumns&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                              &lt;/RangeColumns&gt;\n                              &lt;RangeExpressions&gt;\n                                &lt;ScalarOperator ScalarString=\"($0.0000)\"&gt;\n                                  &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/RangeExpressions&gt;\n                            &lt;/EndRange&gt;\n                          &lt;/SeekPredicate&gt;\n                          &lt;SeekPredicate&gt;\n                            &lt;Prefix ScanType=\"EQ\"&gt;\n                              &lt;RangeColumns&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Afgehandeld_NeeJa\" /&gt;\n                              &lt;/RangeColumns&gt;\n                              &lt;RangeExpressions&gt;\n                                &lt;ScalarOperator ScalarString=\"(0)\"&gt;\n                                  &lt;Const ConstValue=\"(0)\" /&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/RangeExpressions&gt;\n                            &lt;/Prefix&gt;\n                            &lt;StartRange ScanType=\"GT\"&gt;\n                              &lt;RangeColumns&gt;\n                                &lt;ColumnReference Database=\"[directpay]\" Schema=\"[dbo]\" Table=\"[tbl_Faktuur]\" Column=\"Totaal_Open\" /&gt;\n                              &lt;/RangeColumns&gt;\n                              &lt;RangeExpressions&gt;\n                                &lt;ScalarOperator ScalarString=\"($0.0000)\"&gt;\n                                  &lt;Const ConstValue=\"($0.0000)\" /&gt;\n                                &lt;/ScalarOperator&gt;\n                              &lt;/RangeExpressions&gt;\n                            &lt;/StartRange&gt;\n                          &lt;/SeekPredicate&gt;\n                        &lt;/SeekPredicates&gt;\n                      &lt;/IndexScan&gt;\n                    &lt;/RelOp&gt;\n                  &lt;/Hash&gt;\n                &lt;/RelOp&gt;\n              &lt;/ComputeScalar&gt;\n            &lt;/RelOp&gt;\n          &lt;/QueryPlan&gt;\n        &lt;/StmtSimple&gt;\n      &lt;/Statements&gt;\n    &lt;/Batch&gt;\n  &lt;/BatchSequence&gt;\n&lt;/ShowPlanXML&gt;\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":99,"score":0,"question_id":13073740,"title":"Need help on following sql query","body":"<p>This is my current SQL query. I need to modify this</p>\n\n<pre><code>SELECT \n    18 BrokerDealerID,\n    5 PortfolioID,\n    PeriodEndDate DATE,\n    SecurityIdentifier_All.SecurityId,\n    MAX(\n    (CASE \n        WHEN Securities.Quantity &lt; 0 THEN\n        100 + (100 - LocalPriceAmount)\n        ELSE\n        LocalPriceAmount\n     END\n        ) /100) Mark\nFROM\n    Fireball_Reporting..StateStreet_DailyPosition_Second StateStreet \nINNER JOIN\n    Fireball_Reporting..SecurityIdentifier_All ON StateStreet.CUSIP = SecurityIdentifier_All.Identifier\nINNER JOIN\n    Fireball..TradeBySecurityType Securities ON\n        Securities.PricingSecurityID = SecurityIdentifier_All.SecurityId AND Securities.Position = 1 AND\n(CASE WHEN StateStreet.SecurityName LIKE '% R V %' THEN StateStreet.SharesParValue * -1 ELSE StateStreet.SharesParValue END) = Securities.Quantity\nWHERE\n    CONVERT(DATETIME, StateStreet.PeriodEndDate) = '2012-10-23' --@PositionDate\nGROUP BY\n    PeriodEndDate,\n    SecurityIdentifier_All.SecurityId\n</code></pre>\n\n<p>I need to do change in 2nd condition i.e </p>\n\n<pre><code>(CASE WHEN StateStreet.SecurityName LIKE '% R V %' THEN StateStreet.SharesParValue * -1 ELSE StateStreet.SharesParValue END) = Securities.Quantity\n</code></pre>\n\n<p>I will give you an example.</p>\n\n<p>my select query giving me following output</p>\n\n<pre><code>securityname date       securityid portfolioid type mark               quantity\n------------ ---------- ---------- ----------- ---- ------------------ -------------\nR V DISH     10/23/2012 4879505    5           CDS  1.0487189900000000 -5000000.0000\nR V DISH      10/23/2012 4879505    5           CDS  1.0487189900000000 -2000000.0000\nR F DISH    10/23/2012 4879505    5           CDS  0.9512810100000000 3000000.0000\n</code></pre>\n\n<p>Here above it is giving me 3 records for same security id \nWhen I do MERGE using above result it is only taking 1st record directly if i don't check that 2nd condition which checks for <code>Quantity</code> but now i want to check only for \nWhen In StateStreet.SecurityName LIKE '% R V %' take the records from above result whose quantity is <code>-</code> if not then take the record whose quantity id <code>+</code> </p>\n\n<p>How could I change that case statement? or directly check for <code>% R V%</code> in select statement where i calculated mark  ?\nNeed technical help.\nI'm new to SQL.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":9,"favorite_count":4,"up_vote_count":6,"down_vote_count":0,"view_count":17887,"score":6,"question_id":878833,"title":"Passing a varchar full of comma delimited values to a SQL Server IN function","body":"<p><strong>Duplicate of</strong></p>\n\n<p><a href=\"http://stackoverflow.com/questions/517028/dynamic-sql-comma-delimited-value-query\">Dynamic SQL Comma Delimited Value Query</a><br>\n<a href=\"http://stackoverflow.com/questions/303149/parameterized-queries-with-like-and-in-conditions\">Parameterized Queries with Like and In</a> </p>\n\n<p>I have a SQL Server Stored procedure where I would like to pass a varchar full of comma delimited values to an in function. Example</p>\n\n<pre><code>Declare @Ids varchar(50)\n    Set @Ids = 1,2,3,5,4,6,7,98,234\n\nSelect * from sometable where tableid in(@Ids)\n</code></pre>\n\n<p>This does not work of course. I get the error:</p>\n\n<p>Conversion failed when converting the varchar value '1,2,3,5,4,6,7,98,234' to data type int.</p>\n\n<p>How can I accomplish this (or something relatively similar) without resorting to building dynamic sql?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":26,"score":1,"question_id":13082341,"title":"freetext search with full string in sql server","body":"<p>When I provide a two word string like <em>hello world</em> in freetext search, it fetching data with <strong>hello</strong> string and then with <strong>world</strong> but not with <em>hello world</em>.</p>\n\n<p>But i cant go for like operator.</p>\n\n<pre><code>DECLARE @var VARCHAR(50)\n    SET @var = 'hello world'\n select * from helloTable where freetext(ColumnName, @var)\n</code></pre>\n\n<p>Result:</p>\n\n<p>first set of rows are fetched on 'hello' and second set on 'world', <strong>but i need with full string</strong>.</p>\n"},{"tags":["tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":13082424,"title":"t sql division by zero error","body":"<p>Hi I'm getting a division by zero error when I try to caculate growth and I don't understand why.  It is evaluating the first part of the statement correctly (SalesLastYear IS NULL) but as soon as the 2nd part of the statement becomes true its giving me the division by zero error.</p>\n\n<pre><code>,case when SalesLastYear IS NULL then 100\nwhen SalesThisYear IS NULL then -100\nelse (SalesThisYear - SalesLastYear )*100 / SalesLastYear end as Growth\n</code></pre>\n\n<p>I'm pulling the data out of a temp table so it looks like this:</p>\n\n<pre><code>Customer   SalesLastYear  SalesThisYear \nABC        390            NULL\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":91,"score":1,"question_id":13075465,"title":"Is there any alternative of 'like' operators in sql - for searching data","body":"<p>I need some help here, I am fetching data dependent upon the conditions</p>\n\n<p>Here I am using like operators, where client may use search with any word thus I have the below logic but here retrieval time is too high (it's taking 4mins) to get the data which is too slow.</p>\n\n<p>I did all indexing to table but still can't optimize the query.</p>\n\n<p>select * from authors \nwhere (address like '% Walmart %' OR address like 'Walmart %' OR address like '% Walmart' OR address like '% Walmart.com %' OR address like 'Walmart.com %' OR address like '% Walmart.com' OR address like '% Walmarts %' OR address like 'Walmarts %' OR address like '% Walmarts' OR address like '% Walmarts.com %' OR address like 'Walmarts.com %' OR address like '% Walmarts.com') </p>\n\n<p>-- Result is 1 Rows </p>\n\n<p>if i follow this logic</p>\n\n<p>select * from authors \n    where address like '%Walmart%'</p>\n\n<p>-- Result is 44 rows - it is fetching all rows</p>\n\n<p>But I need to get only that one row</p>\n"},{"tags":["tsql","replacement"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":17753,"score":1,"question_id":1321946,"title":"T-SQL, Remove space in string","body":"<p>I have two strings in SQL and the REPLACE function only works on one of them, why is that?</p>\n\n<p>Example 1: </p>\n\n<pre><code>SELECT REPLACE('18286.74', ' ', '')\n</code></pre>\n\n<p>Example 2:</p>\n\n<pre><code>SELECT REPLACE('z z', ' ', '')\n</code></pre>\n\n<p>Example 1's output is still \"18 286.74\" whereas Example 2's output is \"zz\". Why does SQL not react the same way to both strings?</p>\n\n<p>UPDATE:</p>\n\n<p>When running <code>select replace('123 123.12', ' ', '')</code> that works fine, still not with '18 286.74'.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":4,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":2804,"score":3,"question_id":1500290,"title":"How to Script Automatically, the securables assigned to a SQL account","body":"<p>I want to generate script to assign an user account to some securables, e.g. Table:Select.</p>\n\n<p>How to do this?</p>\n"},{"tags":["sql","sql-server","tsql","datetime","date"],"answer_count":12,"favorite_count":43,"up_vote_count":84,"down_vote_count":1,"view_count":96539,"score":83,"question_id":1177449,"title":"Best approach to remove time part of datetime in SQL Server","body":"<p>Which method provides the best performance when removing the time portion from a datetime field in SQL Server?</p>\n\n<pre><code>a) select DATEADD(dd, DATEDIFF(dd, 0, getdate()), 0)\n</code></pre>\n\n<p>or</p>\n\n<pre><code>b) select cast(convert(char(11), getdate(), 113) as datetime)\n</code></pre>\n\n<p>The second method does send a few more bytes either way but that might not be as important as the speed of the conversion.</p>\n\n<p>Both also appear to be very fast, but there might be a difference in speed when dealing with hundreds-of-thousands or more rows?</p>\n\n<p>Also, is it possible that there are even better methods to get rid of the time portion of a datetime in SQL?</p>\n"},{"tags":["tsql","orm","resultset","for-xml-path"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":13073980,"title":"XML Path vs more connections","body":"<p>I have need of a grid which lists Orders, and associated data.  (Purely fictional example)</p>\n\n<p>For simplicity:</p>\n\n<pre><code>OrderID\nOrderName\nOrderDate\nCollection Parts\nCollection Destinations\nCollection SuppliersInvolved\n</code></pre>\n\n<p>The grid should display each order, but also the textual description from each collection,\neg:</p>\n\n<pre><code>OrderID  OrderName OrderDate  Parts  Destinations     SupplierInvolved\n   2        davo    21/5/12   A,B,C  London, Paris    SuppA,SuppB,SuppC \n</code></pre>\n\n<p>Now, this grid may have up to two hundred rows.</p>\n\n<p>This issue is, the bespoke ORM we use has some major slowness issues mapping multi-PK results sets into unique objects.</p>\n\n<p>eg.</p>\n\n<pre><code>OrderID  OrderName OrderDate  Part  Destination     Supplier\n   2        davo    21/5/12   A       London         SuppA\n   2        davo    21/5/12   B       London         SuppA\n   2        davo    21/5/12   A       London         SuppB\n   2        davo    21/5/12   B       London         SuppB\n</code></pre>\n\n<p>It has this issue even with 1 collection involved in the result set.  The query itself executes absolutely fine and fast, it's the mapping which is the issue.</p>\n\n<p>So, I am left with two options really (as far as I can see):</p>\n\n<ol>\n<li><p>Get Orders result set, For each order in resultset, fetch Parts, fetch Destination, fetch Supplier, etc.  This would in turn mean 601 calls to DB.</p></li>\n<li><p>Use <strong>FOR XML PATH</strong> to group each collection together.  Means more CPU intensive and read heavy initial query.</p></li>\n</ol>\n\n<p>I'm wondering, firstly, which of the above two approaches would seem the better, and, secondly, whether there are other better approaches I haven't thought of.  Issue is that both have to use rubbishy object mapper (can't create my own DAL mapping procedure just for this query's result set).</p>\n\n<p>Any ideas?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","tsql","foreign-keys"],"answer_count":5,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":1520,"score":2,"question_id":4452132,"title":"Add Foreign Key relationship between two Databases","body":"<p>I have two tables in two different databases. In table1(It is in database1) there is a column called column1 and it is a primary key. Now in table2(It is in databse2) there is a column called coulmn2 and I want to add it as a foreign key.</p>\n\n<p>I Tried to add it and it gave me the following error:</p>\n\n<blockquote>\n  <p>Msg 1763, Level 16, State 0, Line 1</p>\n  \n  <p>Cross-database foreign key references\n  are not supported.</p>\n  \n  <p>Foreign key Database2.table2.</p>\n  \n  <p>Msg 1750, Level 16, State 0, Line 1\n  Could not create constraint. See\n  previous errors.</p>\n</blockquote>\n\n<p>How do I do that Since The tables are in different databases.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":86,"score":2,"question_id":12954086,"title":"SQL FORCE SORT Columns generated from rows by values contained","body":"<p>I have a requirement to order the output of a dynamic query, that turns columns into rows, to ensure that only columns with values are generated before the rows with no values. How do I force order on the generation of the columns so the first columns are columns that contain values for particular fields while those with no values for the particular fields are generated at the end of my row? </p>\n\n<pre><code>             insert into #PriceSheet\n      select  ID, ProductID,SheetNumber ,SheetDesc ,MfgPriceCode,PriceZone\n\n  FROM  ProductPrice\n  left join UNITS On SUOM = UOMID\n\n  select @colsUnpivot = stuff((select ','+quotename(C.name)\n         from tempdb.sys.columns as C\n         where C.object_id = object_id('tempdb..#PricingSheet') and\n               C.name LIKE '%%' \n         for xml path('')), 1, 1, '')\n\n select @colsPivot = STUFF((SELECT  ',' \n                      + quotename(c.name \n                         + cast(t.rn as varchar(10)))\n                    from\n                    (\n                      select row_number() over(partition by ProductID \n                                               order by ProductID) rn\n                      from #PriceSheet\n                    ) t\n                     cross apply \n                      tempdb.sys.columns  as C\n                   where C.object_id = object_id('tempdb..#PricingSheet') \n                     and C.name Not in ('CreateDate', 'LastModifiedDate')\n                   group by c.name, t.rn\n                   order by t.rn\n            FOR XML PATH(''), TYPE\n            ).value('.', 'NVARCHAR(MAX)') \n        ,1,1,'')\n\n\n       set @query = 'select *\n      from\n      (\n        select ProductID, col + cast(rn as varchar(10)) new_col, val\n        from \n        (\n          select  \n       cast(ProductID              as varchar(50))ProductID\n      ,cast(SheetNumber              as varchar(50))SheetNumber\n      ,cast(SheetDesc              as varchar(50))SheetDesc\n      ,cast(MfgPriceCode              as varchar(50))MfgPriceCode\n      ,cast(PriceZone              as varchar(50))PriceZone \n       row_number() over(partition by productid order by productid) rn\n\n          from #PriceSheet\n        ) x\n        unpivot\n        (\n          val\n          for col in ('+ @colsunpivot +')\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ('+ @colspivot +')\n      ) p'\n</code></pre>\n\n<p>Say for instance, to generate the columns first for rows that have SheetNumber not equal to NULL and then the NULLS afterward. </p>\n"},{"tags":["sql-server","tsql","sql-server-2000"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":13076962,"title":"T-SQL SUM Total","body":"<p>Below I have a T-SQL query that brings back amount of purchased items, less discounts and the total - grouped by month/year of purchase.  How can I update the Query to return a Grand Total Row\nwhere I would can add up the amounts in the Total Column?\nIt would be good to be able to add up all the rows but my\nmain item is I need to be able to get a grand total. Thanks.</p>\n\n<pre><code>    Select DATENAME(month, [OrderDate]) + ' ' + CAST(YEAR(OrderDate) AS CHAR(4)) \n    AS [Month],\n    SUM(Amount) AS [Amount],\n    SUM(Discount1) AS [Discount 1],\n    SUM(Discount2) AS [Discount 2],\n    SUM(Amount - Discount1 - Discount2) AS [Total]\n    From \n    Orders\n    JOIN Customer on orders.cust_ky=customer.cust_ky\n    GROUP BY DATENAME(month, [OrderDate]) + ' ' + CAST(YEAR(OrderDate) AS CHAR(4))\n    ORDER BY MAX(OrderDate)\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","sa"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":94,"score":1,"question_id":8758976,"title":"Is there a T-SQL function to return the name of the 'sa' account?","body":"<p>(I know the question sounds ridiculous, but bear with me ...)</p>\n\n<p>Our DBA changes the 'sa' account name to something else for their own security purposes.  There are business needs to use the account name in script (e.g. sp_add_job), but this will break in this situation.  I'd like to be able to submit a script that doesn't need to be edited to use the new 'sa' username before running.</p>\n\n<p>Is there a function/property similar to @@SERVERNAME that will return the name of this account?</p>\n"},{"tags":["sql-server","tsql","date","weekend"],"answer_count":6,"favorite_count":4,"up_vote_count":13,"down_vote_count":0,"view_count":12760,"score":13,"question_id":1803987,"title":"How do I exclude Weekend days in a SQL Server query?","body":"<p>How do I exclude values in a <code>DateTime</code> column that are Saturdays or Sundays?</p>\n\n<p>For example, given the following data:</p>\n\n<pre><code>date_created\n'2009-11-26 09:00:00'  -- Thursday\n'2009-11-27 09:00:00'  -- Friday\n'2009-11-28 09:00:00'  -- Saturday\n'2009-11-29 09:00:00'  -- Sunday\n'2009-11-30 09:00:00'  -- Monday\n</code></pre>\n\n<p>this is the result I'm looking for:</p>\n\n<pre><code>date_created\n'2009-11-26 09:00:00'  -- Thursday\n'2009-11-27 09:00:00'  -- Friday\n'2009-11-30 09:00:00'  -- Monday\n</code></pre>\n\n<p>Thanks!</p>\n"},{"tags":["tsql","count","date"],"answer_count":10,"favorite_count":11,"up_vote_count":21,"down_vote_count":0,"view_count":55841,"score":21,"question_id":252519,"title":"Count work days between two dates in T-SQL","body":"<p>How can I calculate the number of work days between two dates in SQL Server? </p>\n\n<p>Monday to Friday and it must be T-SQL.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":13070519,"title":"Should I avoid using sp_getAppLock?","body":"<p>I have a stored procedure, and I want to ensure it cannot be executed concurrently.</p>\n\n<p>My (multi-threaded) application does all necessary work on the underlying table via this stored procedure.</p>\n\n<p>imo, locking the table itself is an unnecessarily drastic action to take, and so when I found out about <code>sp_GetAppLock</code>, which essentially enforces a critical section, this sounded ideal.</p>\n\n<p>My plan was to encase the stored procedure in a transaction and to set up <code>spGetAppLock</code> with transaction scope. The code was written and tested successfully.</p>\n\n<p>The code has now been put forward for review and I have been told that I should not call this function. However when asking the obvious question \"why not?\", the only reasons I am getting are highly subjective, to do with any form of locking being complicated.</p>\n\n<p>I don't necessarily buy this, but I was wondering whether anyone had any <em>objective</em> reasons why I should avoid this constuct. Like I say, given my circumstances a critical section sounds an ideal approach to me.</p>\n\n<p>TIA,\nPete</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":4,"down_vote_count":0,"view_count":4297,"score":4,"question_id":1426487,"title":"Format phone number","body":"<p>I have table in the db with phone number column the numbers look like this:</p>\n\n<blockquote>\n  <p>123456789</p>\n</blockquote>\n\n<p>I want to format that to:</p>\n\n<blockquote>\n  <p>123-456-789</p>\n</blockquote>\n\n<p>thanks!!!</p>\n"},{"tags":["sql-server-2008","tsql","ssis","ssms","osql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":13072607,"title":"Generating a .csv file by running a .sql script with osql.exe","body":"<p>I have a script file in a folder.I want to use TSQL to run this script without opening it in SSMS as I will be using SSIS to run this script to generate CSV.</p>\n\n<p>I have used OSQL to achieve this by using Execute Process Task but it is not giving me exact results I am looking for. It is generating spaces in the csv. A 17 mb file which I exported by rightclick as CSV option turned out to 1gb when I executed using OSQL code.The OSQL I used is:</p>\n\n<p><code>-E -S CCCMSDSQL20,1819 -d SHARE_SCRUB  -q  \"SET NOCOUNT ON\" -i \"C:\\Scripts\\.SQL\" -o \"C:\\Scripts\\.csv\" -n -h-1 -s\",\" -w 700</code></p>\n\n<p>I prefer a TSQL script which can achieve the same,so that I can use it in Execute SQL task and get the results.</p>\n\n<p>EDIT:\nI am working to generate multiple csv's from multiple .sql files in a folder .I am using a for each loop container and execute process task as of now.I want to change the execute process task to execute sql task and use this script to generate multiple files.</p>\n\n<p>If it is possible to write a TSQL code which can do the looping and generation of CSV files in one script I can use it without using the package.</p>\n\n<p>Thanks for your time and help.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","pivot"],"answer_count":2,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":76,"score":3,"question_id":13072744,"title":"SQL Server PIVOT with multiple X-axis columns","body":"<p>Take the following example data:</p>\n\n<pre><code>Payroll Forname Surname Month   Year    Amount\n0000001 James   Bond    3       2011    144.00\n0000001 James   Bond    6       2012    672.00\n0000001 James   Bond    7       2012    240.00\n0000001 James   Bond    8       2012    1744.50\n0000002 Elvis   Presley 3       2011    1491.00\n0000002 Elvis   Presley 6       2012    189.00\n0000002 Elvis   Presley 7       2012    1816.50\n0000002 Elvis   Presley 8       2012    1383.00\n</code></pre>\n\n<p>How would i PIVOT this on the Year + Month (eg: 201210) but preserve Payroll, Forename &amp; Surname as seperate columns, for example, the above would become:</p>\n\n<pre><code>Payroll Forename    Surname 201103  201206  201207  201208\n0000001 James       Bond    144.00  672.00  240.00  1744.50\n0000002 Elvis       Presley 1491.00 189.00  1816.50 1383.00\n</code></pre>\n\n<p>I'm assuming that because the Year + Month names can change then i will need to employ dynamic SQL + PIVOT - i had a go but couldnt even get the code to parse, nevermind run - any help would be most appreciated!</p>\n\n<p>Edit: What i have so far:</p>\n\n<pre><code>    INSERT  INTO #tbl_RawDateBuffer\n            ( PayrollNumber ,\n              Surname ,\n              Forename ,\n              [Month] ,\n              [Year] ,\n              AmountPayable\n            )\n            SELECT  PayrollNumber ,\n                    Surname ,\n                    Forename ,\n                    [Month] ,\n                    [Year] ,\n                    AmountPayable\n            FROM    RawData\n            WHERE   [Max] &gt; 1500\n\n\nDECLARE @Columns AS NVARCHAR(MAX)\nDECLARE @StrSQL AS NVARCHAR(MAX) \n\nSET @Columns = STUFF((SELECT DISTINCT\n                                ',' + QUOTENAME(CONVERT(VARCHAR(4), c.[Year]) + RIGHT('00' + CONVERT(VARCHAR(2), c.[Month]), 2))\n                      FROM      #tbl_RawDateBuffer c\n    FOR              XML PATH('') ,\n                         TYPE \n            ).value('.', 'NVARCHAR(MAX)'), 1, 1, '') \n\nSET @StrSQL = 'SELECT PayrollNumber, ' + @Columns + ' from \n            (\n                select PayrollNumber\n                    , CONVERT(VARCHAR(4), [Year]) + RIGHT(''00'' + CONVERT(VARCHAR(2), [Month]), 2) dt\n                from #tbl_RawDateBuffer\n           ) x\n            pivot \n            (\n                sum(AmountPayable)\n                for dt in (' + @Columns + ')\n            ) p '\n\n\nEXECUTE(@StrSQL)\n\nDROP TABLE #tbl_RawDateBuffer\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":13071566,"title":"Derived Tables vs. Correlated subquery in HAVING clause SQL Server 2008","body":"<p>In this example I've only got two tables with which I'm working.  I was checking to see which might run faster and the execution plans were identical.  The purpose of these queries is to find the minimum date associated with one record that's larger than the maximum date of another.  The first query is more concise (although it doesn't allow the <code>DATEDIFF</code> column the second one does).  I feel like writing a query the second way will, in the long run, be more costly performance wise, perhaps when I have many joins.  Are there any general rules about which method, or is it a case by case scenario and you let the optimizer work it out?  </p>\n\n<p>first</p>\n\n<pre><code>select c.patid,min(c.admitDate) as minDiabetesDate\n    from clm_extract as c\n    inner join icdClm as ic on ic.clmid=c.clmid\n    where ic.icd like '250%' \n    group by c.patid\n    having min(c.admitdate) &gt; \n    (\n        select MAX(c2.admitDate) as maxPreDiabetesDate\n            from clm_extract as c2\n            inner join icdClm as ic2 on ic2.clmid = c2.clmid\n            where ic2.icd ='79029' and c2.patid=c.patid\n            group by c2.patid\n    )\n</code></pre>\n\n<p>second </p>\n\n<pre><code>select distinct x.patid,x.minDiabetesDate,y.maxPreDiabetesDate \nfrom\n(   \n\nselect c.patid, min(c.admitdate) as minDiabetesDate\n    from clm_extract as c \n    inner join icdClm as ic on ic.clmid=c.clmid\n    where ic.icd like '250%'\n    group by c.patid\n)x\ninner join \n(\nselect c2.patid, MAX(c2.admitdate) as maxPreDiabetesDate\n    from clm_extract as c2\n    inner join icdClm as ic2 on ic2.clmid=c2.clmid\n    where ic2.icd ='79029'\n    group by c2.patid\n)y on x.patid=y.patid\ngroup by x.minDiabetesDate,y.maxPreDiabetesDate,x.patid\nhaving DATEDIFF(dd,y.MaxPreDiabetesDate,x.minDiabetesDate) &gt; 0\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","full-text-search"],"answer_count":2,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":246,"score":3,"question_id":8011044,"title":"Contains() function falters with strings of numbers?","body":"<p>For some background information, I'm creating an application that searches against a couple of indexed tables to retrieve some records. It isn't overtly complex to the point of say Google, but it's good enough for the purpose it serves, barring this strange issue. </p>\n\n<p>I'm using the <code>Contains()</code> function, and it's going very well, except when the search contains strings of numbers. Now, I'm only passing in a string -- nowhere numerical datatypes being passed in -- only characters. We're searching against a collection of emails, each appended with a custom ID when shot off from a workflow. So while testing, we decided to search via number strings. </p>\n\n<p>In our test, we isolated a number <code>0042600006</code>, which belongs to one and only one email subject. However, when using our query we are getting results for <code>0042600001</code>, <code>0042600002</code>, etc. The query is this as follows (with some generic columns standing in):</p>\n\n<p><code>SELECT description, subject FROM tableA WHERE CONTAINS((subject), '0042600006')</code></p>\n\n<p>We've tried every possible combination: <code>'0042600006*'</code>, <code>'\"0042600006\"'</code> and <code>'\"0042600006*\"'</code>. </p>\n\n<p>I think it's just a limitation of the function, but I thought this would probably be the best place for answers. Thanks in advance. </p>\n"},{"tags":["sql","tsql"],"answer_count":9,"favorite_count":5,"up_vote_count":7,"down_vote_count":0,"view_count":11421,"score":7,"question_id":758186,"title":"How to get N rows starting from row M from sorted table in T-SQL","body":"<p>There is a simple way to get top N rows from any table:</p>\n\n<pre><code>SELECT TOP 10 * FROM MyTable ORDER BY MyColumn\n</code></pre>\n\n<p>Is there any efficient way to query M rows starting from row N</p>\n\n<p>For example,</p>\n\n<pre><code>Id Value\n1    a\n2    b\n3    c\n4    d\n5    e\n6    f\n</code></pre>\n\n<p>And query like this</p>\n\n<pre><code>SELECT [3,2] * FROM MyTable ORDER BY MyColumn /* hypothetical syntax */\n</code></pre>\n\n<p>queries 2 rows starting from 3d row, i.e 3d and 4th rows are returned.</p>\n"},{"tags":["mysql","sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":13070981,"title":"GROUP BY members of a comma delimited list","body":"<p>I have a table of data as follows:</p>\n\n<pre><code>t1\n____________________________________________________\nresources          | companyName | Response | Score \nDavid, Matt        |  companyA   |  YES     |   5\nMatt               |  compqanyB  |  NO      |   8\nKyle, Kyle, David  |  companyC   |  YES     |   2\n</code></pre>\n\n<p>As you can see, <code>resources</code> is a comma delimited string. Also, not all members of <code>resources</code> have to be unique (See row 3).   </p>\n\n<p>I want to <code>GROUP BY</code> each <code>DISTINCT</code> member available in any list. All of the other columns will be aggregated. </p>\n\n<p>Intended Result:</p>\n\n<pre><code>query\n______________________________________________________________________________\nresources     |  companyName        |    Response         | Score\nDavid         | *agregated result*  | *agregated result*  | *agregated result*  \nMatt          | *agregated result*  | *agregated result*  | *agregated result*  \nKyle          | *agregated result*  | *agregated result*  | *agregated result*  \n</code></pre>\n\n<p><strong>EDIT:</strong></p>\n\n<p>Another Possibility:</p>\n\n<pre><code>query\n____________________________________________________\nresources          | companyName | Response | Score \nDavid              |  companyA   |  YES     |   5\nMatt               |  companyA   |  YES     |   5\nMatt               |  compqanyB  |  NO      |   8\nKyle               |  companyC   |  YES     |   2\nDavid              |  companyC   |  YES     |   2\n</code></pre>\n"},{"tags":["sql-server","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":44,"score":0,"question_id":13070809,"title":"TSQL Massive Join with multi rows","body":"<p>Is there a easy way to join like this? Table A and B have huge number of rows.</p>\n\n<p>Table A</p>\n\n<pre><code>Column 1    Column 2    \n1           AA  \n2           BB  \n3           CC  \n</code></pre>\n\n<p>Table B</p>\n\n<pre><code>Column 3        \nXXX     \nYYY     \nZZZ \n</code></pre>\n\n<p>Result      </p>\n\n<pre><code>Column 1    Column 2    Column 3\n1           AA          XXX\n1           AA          YYY\n1           AA          ZZZ\n2           BB          XXX\n2           BB          YYY\n2           BB          ZZZ\n3           CC          XXX\n3           CC          YYY\n3           CC          ZZZ\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":46,"score":2,"question_id":12415385,"title":"SQL Query, return Price for Max(DateField)","body":"<p>I have this sql table:</p>\n\n<pre><code>Niin char(9)\nEffectiveDate Date\nPrice  currency\n</code></pre>\n\n<p>The NIIN repeates itself with different EffectiveDate and Price values like so</p>\n\n<pre><code>**NIIN           EffectiveDate       Price**\n\n012345678        6/1/2011              89.00\n012345678        6/1/2012              99.00\n012345678        6/1/2012              99.00\n123456789        5/1/2011              77.00\n123456789        5/1/2012              80.00\n123456789        5/1/2012              80.00\netc....\n</code></pre>\n\n<p>What I need to do is return the NIIN, with the Price of the Max EffectiveDate, assuming that if there are duplicate EffectiveDate values, the Price will always be the same. </p>\n\n<p>Therfore from the example I supplied the query would return:</p>\n\n<pre><code>012345678       99.00\n123456789       80.00\n</code></pre>\n\n<p>Thanks for any help.</p>\n"},{"tags":["sql-server","tsql","string-concatenation"],"answer_count":6,"favorite_count":1,"up_vote_count":4,"down_vote_count":1,"view_count":1905,"score":3,"question_id":11351076,"title":"SQL: Concatenate column values in a single row into a string separated by comma","body":"<p>Let's say I have a table like this in SQL Server:</p>\n\n<pre><code>Id    City           Province             Country\n1     Vancouver      British Columbia     Canada\n2     New York       null                 null\n3     null           Adama                null\n4     null           null                 France\n5     Winnepeg       Manitoba             null\n6     null           Quebec               Canada\n7     Seattle        null                 USA \n</code></pre>\n\n<p>How can I get a query result so that the location is a concatenation of the City, Province, and Country separated by \", \", with nulls omitted.  I'd like to ensure that there aren't any trailing comma, preceding commas, or empty strings.  For example:</p>\n\n<pre><code>Id    Location\n1     Vancouver, British Columbia, Canada\n2     New York\n3     Adama\n4     France\n5     Winnepeg, Manitoba\n6     Quebec, Canada\n7     Seattle, USA\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":77,"score":2,"question_id":13069649,"title":"Select 50 random files per day","body":"<p>I am trying to select 50 random files per day since October 1st, 2012.\nFor example: </p>\n\n<ul>\n<li>October 1st = 50 files</li>\n<li>October 2nd = 50 files</li>\n<li>October 3rd = 50 files</li>\n<li>Etc.....today</li>\n</ul>\n\n<p>So far I can select 1 file per day, but I need 50. And I needed them to be random</p>\n\n<pre><code>DECLARE @DaysBack AS INT\nSET @DaysBack = -25\n\n\n    SET NOCOUNT ON;\n\n    SELECT FileDate, MAX(FileName)  FROM (\n    SELECT \n    CONVERT(VARCHAR(10),DATEADD(second,actiondate, CAST('1970-01-01 00:00:00' AS datetime)), 101) AS FileDate\n\n    ,'\\\\directory\\' + filename AS FileName\n    FROM   Tableq q\n    JOIN tablec c\n    on  q.projectid = c.projectid\n           AND actiondate &gt;= Datediff(s, '19700101 00:00:00:000',\n                             Dateadd(DAY, @DaysBack, Getutcdate()))\n\n\n    ) x\n\n    GROUP BY FileDate\n    ORDER  BY FileDate \n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":64,"score":4,"question_id":13031846,"title":"Manipulate results to display rows as columns","body":"<p>I have two tables. \nTable A contains a list of departments, there are 20 in total.</p>\n\n<p>See image</p>\n\n<p><img src=\"http://i.stack.imgur.com/XzyPp.png\" alt=\"enter image description here\"></p>\n\n<p>Table B contains at least 1 row per department found in Table A, with some containing a few.</p>\n\n<p>See image</p>\n\n<p><img src=\"http://i.stack.imgur.com/gOArm.png\" alt=\"enter image description here\"></p>\n\n<p>What I want is a 3rd table created from A &amp; B which basically lists every department and then the number of people who are full time and part time. If for example there is a department found in table b which only has a figure for either Full or Part time (an example of this is department D) then I want the table to display 0 (zero) instead of leaving this blank.</p>\n\n<p>See image</p>\n\n<p><img src=\"http://i.stack.imgur.com/45S0X.png\" alt=\"enter image description here\"></p>\n\n<p>Can anyone advise on this?</p>\n\n<p><strong>EDIT</strong>\nIf there is no for example 'Part time' for one of the Departments, that means that their part time staff count WILL be zero as a rule.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":13068001,"title":"update each row with different values in temp table","body":"<p>I have a column that I need to update with codes in a temp table.There is +/- 5 codes in the temp table. Each row in the table must be updated with one of the values in the temp table.</p>\n\n<pre><code>Example\nid  code\n1   200\n2   400\n3   600\n4   9000\n5   800\n6   200\n7   400\n8   600\n9   9000\n10  800\n</code></pre>\n"},{"tags":["tsql","nhibernate","nhibernate-criteria"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":13065909,"title":"Nhibernate Expression.In limit","body":"<p>I am querying the Nhibernate criteria query with more then 2100 values for In clause.\nI do something like      Session.CreateCriteria(typeof()).Add(Expression.In(\"fieldName\",arrayValue))\nWhere arrayValue contains more then 2100 values. I face error \nException occurred:\nUnknownError \nNHibernate.ADOException: could not execute query ..then the query with more then 3000 values in array.\nwith some google help we found out that IN clause in Sql supports only till 2100 values.\nDoes anyone has faced similar issue earlier? We do not want to change the query as it is written in some generic way and not customized one. </p>\n"},{"tags":["entity-framework","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":22,"score":0,"question_id":13054088,"title":"Entity Framework Function Import Trims Leading Zeros From String","body":"<p>I have a funny issue with Entity Framework function import. I am importing a stored procedure from MS SQL Server 2008 R2, and it returns just one string. However, it is too complex for EF to infer this return type, so when defining function import I had to manually specify that the function returns a collection of scalars (<code>ObjectResult&lt;global::System.String&gt;</code>, as was generated).</p>\n\n<p>Sometimes, the procedure returns a string containing only digits and starting with zero (e.g., <code>01234</code>). When I access this result in the code, it turns out to be without the starting zero (<code>1234</code>)!</p>\n\n<p>I know several workarounds, so it is not a question. I want to understand what's going on.</p>\n\n<p>My wild guess is that in my case - when SP is too complex to \"predict\" its result - EF first tries to \"guess\" the type of the returned data by the format of that data. I.e., it sees a number (<code>01234</code>), and converts it into integer type (<code>int</code>, <code>short</code> - whatever). Then it sees that I want a <code>string</code>, and converts this number back into <code>string</code>, but of course during these conversions starting zero is lost. Is that true, or is there a better explanation?</p>\n\n<p>UPDATE: This is a screenshot for function import:</p>\n\n<p><img src=\"http://i.stack.imgur.com/ZHdcm.png\" alt=\"Function Import\"></p>\n"},{"tags":["sql-server","tsql","search"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":242,"score":1,"question_id":11335879,"title":"Change stored procedure based on input parameters","body":"<p>I'm writing an 'advanced search' page for a web application. It basically has a form that goes:</p>\n\n<blockquote>\n  <p>Search for <strong>query</strong> in the forum <strong>forum name</strong> posted by\n  <strong>username</strong> in the last <strong>date</strong></p>\n</blockquote>\n\n<p>The idea is that users can leave fields blank if they wish and the search won't include it.</p>\n\n<p>I'd rather not write a stored procedure for searching based on every possible combination of leaving values blank. Is there a way I can write a stored procedure so that the search changes based on which parameters passed in are blank?</p>\n\n<p>Something like (pseudo code)</p>\n\n<pre><code>SELECT * FROM Table WHERE Message = @query\n\n(if @username isn't null)\nAND Username = @Username\n\n(if @forum isn't null)\nAND Forum = @forum\n</code></pre>\n\n<p>..and so on.</p>\n\n<p>Thanks for any help you can provide!</p>\n"},{"tags":["xml","sql-server-2008","tsql","xml-parsing"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":13065440,"title":"Extract keys and values from XML in a SQL Server stored procedure","body":"<p>I receive XML data like</p>\n\n<pre><code>&lt;t&gt;\n  &lt;ID&gt;8&lt;/ID&gt;\n  &lt;FirstName&gt;name 8&lt;/FirstName&gt;\n  &lt;LastName&gt;surname 8&lt;/LastName&gt;\n  &lt;DateOfBirth&gt;1963-05-23T00:00:00&lt;/DateOfBirth&gt;\n&lt;/t&gt;\n</code></pre>\n\n<p>In a SQL Server stored procedure. There are different xml data formats (the field numbers and field names can differ). Now, I should extract each field and it value and insert each field/value as a separate record in a table. </p>\n\n<p>Are there examples how I can do this with TSQL?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":21,"score":2,"question_id":13065264,"title":"sp_dropuser stored procedure vs drop user statement in tsql","body":"<p>As the title suggest, which choice is preferable (in what conditions if any) for removing a user from the database: <code>sp_dropuser</code> stored procedure or <code>DROP USER</code> command ?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","window-functions"],"answer_count":4,"favorite_count":0,"up_vote_count":3,"down_vote_count":1,"view_count":61,"score":2,"question_id":13061336,"title":"How to calculate the mode for each value in another column in TSQL","body":"<p>I have a table like this:</p>\n\n<pre><code>ID   Group  Gender\n------------------\n1    A      M\n2    A      M\n3    A      F\n4    A      M\n5    A      U\n6    B      F\n7    B      F\n8    B      M\n9    C      U\n10   C      F\n11   C      U\n</code></pre>\n\n<p>I am trying to calculate the <strong>mode group</strong> for each gender. In other words, for each gender, tell me which is the most popular group.  So the results I want would be as follows:</p>\n\n<pre><code>Gender  ModeGroup\n-----------------\nM       A          (because 3 males in group A, 1 in B and 0 in C)\nF       B          (because 2 females in group B, 1 in A and 1 in C)\nU       C          (because 2 unknown in group C, 0 in B and 1 in C)\n</code></pre>\n\n<p>In the case of a tie, I need a record returned for each of the tied groups.</p>\n\n<p>How can I do this elegantly in TSQL?  I think I need to use a window function, but I've  been struggling with how to go about it.</p>\n"},{"tags":["sql-server","tsql","stored-procedures","optional-parameters"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":96,"score":1,"question_id":13058891,"title":"SQL Server stored procedure with optional parameters updates wrong columns","body":"<p>I have a (legacy) VB6 program that needs some work. I have a stored procedure that updates a table of vendors. In this particular form, I don't need to update the entire row, just 10 or so columns out of the 20ish.</p>\n\n<p>Here is some pseudo code that works fine if I want to update the entire row:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[spUpdateVendor](\n    @pID INT,\n    @pVendorID varchar(254), \n    @pVendorName varchar(255),\n    @pContact varchar(255),\n    @pEmail varchar(255),\n    ...)\nAS\nBEGIN\nSET NOCOUNT ON;\nSET XACT_ABORT ON\n\nDECLARE @ErrorMessage nvarchar(4000);\n\nBEGIN TRY\n-- Start the transaction\n    BEGIN TRANSACTION\n        UPDATE tblVendor\n            SET\n                [Vendor ID] = @pVendorID,\n                [Vendor Name] = @pVendorName,\n                [Contact] = @pContact,\n                [email] = @pEmail\n                ...\n            WHERE\n                [ID] = @pID\n    COMMIT TRANSACTION;\nEND TRY\n</code></pre>\n\n<p>If I want to only update some of the columns with data here is the (pseudo) code I have been trying (attempt at using optional parameters):</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[spUpdateVendor2](\n    @pID INT,\n    @pVendorID varchar(254) = NULL, \n    @pVendorName varchar(255) = NULL,\n    @pContact varchar(255) = NULL,\n    @pEmail varchar(255) = NULL,\n    ...)\nAS\nBEGIN\nSET NOCOUNT ON;\nSET XACT_ABORT ON\n\nDECLARE @ErrorMessage nvarchar(4000);\n\nBEGIN TRY\n-- Start the transaction\n    BEGIN TRANSACTION\n        UPDATE tblVendor\n            SET\n                [Vendor ID] = ISNULL(@pVendorID,[Vendor ID]),\n                [Vendor Name] = ISNULL(@pVendorName,[Vendor Name]),\n                [Contact] = ISNULL(@pContact,[Contact]),\n                [Email] = ISNULL(@pEmail,[email]),\n                ...\n            WHERE\n                [ID] = @pID \n    COMMIT TRANSACTION;\nEND TRY\n</code></pre>\n\n<p>and it all runs w/o errors but it will update the wrong column if I update one optional column, skip a few, then update another optional column.</p>\n\n<p>Example of update using normal parameters:</p>\n\n<pre><code>tblVendor\nID: 2924\nVendor ID: Company1\nVendor Name: Company Name\nContact: Bob\nemail: bob@company.com\n</code></pre>\n\n<p>Example of updating via the optional parameters when I don't supply 'contact':</p>\n\n<pre><code>tblVendor\nID: 2924\nVendor ID: Company1\nVendor Name: Company Name\nContact: bob@company.com\nemail: bob@company.com\n</code></pre>\n\n<p>SO it updates the row, but it updates the wrong column. What am I doing incorrectly?</p>\n"}]}
{"total":16599,"page":5,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":83,"score":6,"question_id":13048856,"title":"Convert DD-Mon-YYYY to DD/MM/YYYY","body":"<p>I need to convert dt_of_birth <code>[varchar] (15)</code> which is in the format <code>DD-Mon-YYYY</code> to <code>DD/MM/YYYY</code>.</p>\n\n<p><code>dt_of _birth</code> is specified in different table and the conversion had to be done and stored in another table which has the same column name as <code>dt_of_birth</code>.</p>\n"},{"tags":["sql-server-2008","tsql","linked-server"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":13060294,"title":"Pragmatically check for existing login for a linked server","body":"<p>I'm writing an admin script I can use for creating linked servers. The script does a <code>IF EXISTS</code> check on the linked server before creating, this works fine.</p>\n\n<p>I have added the <code>sp_addlinkedsrvlogin</code> details to the script to generate the appropriate permissions to access the linked server.</p>\n\n<p>When I try to re-run thescript again it throws the error:</p>\n\n<blockquote>\n  <p>Msg 15190, Level 16, State 1, Procedure sp_dropserver, Line 56 There\n  are still remote logins or linked logins for the server\n  'LinkedServerName'.</p>\n</blockquote>\n\n<h2>So my question is:</h2>\n\n<p><strong>What is the specific code to check for existence of a login for a linked server?</strong></p>\n\n<p>This will allow me to conditionally <code>EXEC sp_droplinkedsrvlogin</code> before issuing the conditional <code>EXEC sp_dropserver</code></p>\n\n<p><br/></p>\n\n<hr>\n\n<p>Code as it stands now:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>-- Set to master\n    USE master\n    GO\n\n-- Set linked server vars\n    DECLARE\n        @ServerName         varchar(max)    =   'Server Name'       -- Name you wish to give to the Linked Server connection. To remove ambiguity you can name this the same as the Data Source you are connecting to.\n        ,@ProductName       nvarchar(128)   =   'Product Name'      -- Type of OLE DB product you are connecting too, i.e. Oracle or SQL Server, e.g. SQl Server = N'MSSQL'.\n        ,@ProviderName      nvarchar(128)   =   'Provider Name'     -- The OLE DB provider is expected to be registered with the specified PROGID in the registry, e.g. SQL Server = N'SQLNCLI'.\n        ,@DataSource        nvarchar(4000)  =   'Source Name'       -- Is the name of the data source as interpreted by the OLE DB provider, i.e. the actual server name if connecting to MS SQL Server.\n        ,@Location          nvarchar(4000)  =   'Location'          -- Not really worth using, listed for compelteness according to Reference 1 Location.           \n        ,@ProviderString    nvarchar(4000)\n        ,@CatalogName       nvarchar(4000)  =   'Database Name'     -- (Optional) Name of the database/catalog you will connect to. \n    SET\n        @ProviderString =   'PROVIDER=SQLOLEDB; SERVER=' + @ServerName\n\n-- Set linked server login vars\n    DECLARE\n        @Useself            varchar(8)      =   'Option'            -- 'TRUE' or 'FALSE' or NULL. Determines whether to connect to @rmtsrvname\\@ServerName by impersonating local logins or explicitly submitting a login and password.\n        ,@LocalLogin        varchar(100)    =   'Domain\\Login'      -- Domain account.\n        ,@User              varchar(50)     =   'SQL user'          -- Is the remote login used to connect to rmtsrvname when @useself\\@Useself is FALSE.\n        ,@Password          varchar(20)     =   'Password'          -- Is the password associated with @rmtuser\\@User.\n\n-- Drop linked server if already exists to prevent error when creating\n    IF  EXISTS\n        (\n            SELECT  *\n            FROM    sys.servers\n            WHERE   server_id   !=  0\n                    AND name    =   @ServerName\n        )  \n        EXEC    sp_dropserver\n                @ServerName\n\n-- Create linked server         \n    EXEC    sp_addlinkedserver  \n            @server         =   @ServerName\n            ,@srvproduct    =   @ProductName\n            ,@provider      =   @ProviderName\n            ,@datasrc       =   @DataSource\n            ,@location      =   @Location\n            ,@provstr       =   @ProviderString\n            ,@catalog       =   @CatalogName\n\n-- Add permissions for usage            \n    EXEC    sp_addlinkedsrvlogin \n            @rmtsrvname     =   @ServerName\n            ,@useself       =   @Useself\n            ,@locallogin    =   @LocalLogin\n            ,@rmtuser       =   @User\n            ,@rmtpassword   =   @Password\n</code></pre>\n\n<hr>\n\n<p>Answer accepted below. I also found that you can force logins to be dropped when dropping a linked server by passing the argument <code>,@droplogins = 'droplogins'</code> to the <code>EXEC sp_dropserver</code> proc:</p>\n\n<pre><code>IF  EXISTS\n    (\n        SELECT  1\n        FROM    sys.servers\n        WHERE   server_id   !=  0\n                AND name    =   @ServerName\n    )  \n    EXEC    sp_dropserver\n            @server         =   @ServerName\n            ,@droplogins    =   'droplogins'\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":40,"score":0,"question_id":13059789,"title":"T-SQL Child/Parent query","body":"<p>I have 4 tables, group, membership, person and attribute.</p>\n\n<p>Group</p>\n\n<pre><code>GroupID\nGroupName\nParentGroupID\n</code></pre>\n\n<p>Membership</p>\n\n<pre><code>PersonID\nGroupID\n</code></pre>\n\n<p>Person</p>\n\n<pre><code>PersonID\nName\n</code></pre>\n\n<p>Attribute</p>\n\n<pre><code>AttributeID\nGroupID\nValue\n</code></pre>\n\n<p>Attributes are assigned to groups, groups have people assigned via the membership table. </p>\n\n<p><strong>I would like to display all the attributes relating to a particular person.</strong></p>\n\n<p>I am having no troubles doing this for someone in a group with no parent, but some of the groups have nesting 2 or 3 levels deep. My attempts to use the CTE approach haven't yielded any results thus far.</p>\n\n<p>Example Result</p>\n\n<pre><code>Person.Name Membership.GroupID  Group.GroupID  Group.ParentGroupID  Attribute.Value\nFred        3                   1              NULL                 'Attribute for Top level group'\nFred        3                   2              1                    'Attribute for a sub group'\nFred        3                   3              2                    'Attribute for third sub group'\nFred        5                   4              1                    'Attribute for Top level group - this is a duplicate?'\nFred        5                   5              4                    'Attribute for second sub group'\n</code></pre>\n\n<p>Hope that is clear enough. Fred is a member of Group 3, whichhas a parent group of 2, which in turn has a parent group of 3 - then display each of attributes that match for each group (inner join on the Group.ID against Attribute.GroupID would achieve this)</p>\n\n<p><strong>edit - Just to add a note, each Person can be a member of multiple groups.</strong></p>\n"},{"tags":["sql","sql-server","tsql","distinct"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":13057630,"title":"Select data from a table where only the first two columns are distinct","body":"<p><strong>Background</strong></p>\n\n<p>I have a table which has six columns. The first three columns create the pk. I'm tasked with removing one of the pk columns.</p>\n\n<p>I selected (using distinct) the data into a temp table (excluding the third column), and tried inserting all of that data back into the original table with the third column being '11' for every row as this is what I was instructed to do. (this column is going to be removed by a DBA after I do this)</p>\n\n<p>However, when I went to insert this data back into the original table I get a pk constraint error. (shocking, I know)</p>\n\n<p>The other three columns are just date columns, so the distinct select didn't create a unique pk for each record. What I'm trying to achieve is just calling a distinct on the first two columns, and then just arbitrarily selecting the three other columns as it doesn't matter which dates I choose (at least not on dev). </p>\n\n<p><strong>What I've tried</strong></p>\n\n<p>I found the following post which seems to achieve what I want:</p>\n\n<p><a href=\"http://stackoverflow.com/questions/54418/how-do-i-or-can-i-select-distinct-on-multiple-columns-postgresql\">How do I (or can I) SELECT DISTINCT on multiple columns (postgresql)?</a></p>\n\n<p>I tried the answers from both Joel,and Erwin.</p>\n\n<p><strong>Attempt 1:</strong></p>\n\n<p>However, with Joels answer the set returned is too large - the inner join isn't doing what I thought it would do. Selecting distinct col1 and col2 there are 400 columns returned, however when I use his solution 600 rows are returned. I checked the data and in fact there were duplicate pk's. Here is my attempt at duplicating Joels answer:</p>\n\n<pre><code>select a.emp_no, \n        a.eec_planning_unit_cde, \n        '11' as area, create_dte, \n        create_by_emp_no, modify_dte,\n        modify_by_emp_no\nfrom tempdb.guest.temp_part_time_evaluator b\ninner join\n(\n    select emp_no, eec_planning_unit_cde\n    from tempdb.guest.temp_part_time_evaluator\n    group by emp_no, eec_planning_unit_cde\n) a\nON b.emp_no = a.emp_no AND b.eec_planning_unit_cde = a.eec_planning_unit_cde\n</code></pre>\n\n<p>Now, if I execute just the inner select statement 400 rows are returned. If I select the whole query 600 rows are returned? Isn't inner join supposed to only show the intersection of the two sets?</p>\n\n<p><strong>Attempt 2:</strong></p>\n\n<p>I also tried the answer from Erwin. This one has a syntax error and I'm having trouble googling the spec on the where clause (specifically, the trick he is using with <code>(emp_no, eec_planning_unit_cde)</code>)</p>\n\n<p>Here is the attempt:</p>\n\n<pre><code>select emp_no, \n    eec_planning_unit_cde, \n    '11' as area, create_dte, \n    create_by_emp_no, \n    modify_dte,\n    modify_by_emp_no\nwhere (emp_no, eec_planning_unit_cde) IN\n(\n    select emp_no, eec_planning_unit_cde\n    from tempdb.guest.temp_part_time_evaluator\n    group by emp_no, eec_planning_unit_cde\n)\n</code></pre>\n\n<p>Now, I realize that the post I referenced is for postgresql. Doesn't T-SQL have something similar? Trying to google parenthesis isn't working too well. </p>\n\n<p><strong>Overview of Questions:</strong></p>\n\n<ol>\n<li>Why doesn't inner join return an intersection of two sets? From googling this is what I thought it was supposed to do</li>\n<li>Is there another way to achieve the same method that I was trying in attempt 2 in t-sql?</li>\n<li>It doesn't matter to me which one of these I use, or if I use another solution... how should I go about this? </li>\n</ol>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":98,"score":1,"question_id":13056929,"title":"Bulk load data conversion error (type mismatch or invalid character for the specified codepage) for row 1, column 4 (Year)","body":"<p>I'm getting the conversion error when I try to import a text file to my database. Below is the error message I received:</p>\n\n<p>Bulk load data conversion error (type mismatch or invalid character for the specified codepage) for row 1, column 4 (Year).</p>\n\n<p>Here is my query code:</p>\n\n<pre><code>CREATE TABLE Students\n(\n    StudentNo    Integer NOT NULL Primary Key,\n    FirstName    VARCHAR(40) NOT NULL,\n    LastName     VARCHAR(40) NOT NULL,\n    Year         Integer,\n    GPA          Float NULL\n);\n</code></pre>\n\n<p>Here is the sample data from text file:</p>\n\n<pre><code>100,Christoph,Van Gerwen,2011\n101,Anar,Cooke,2011\n102,Douglis,Rudinow,2008\n</code></pre>\n\n<p>I think I know what the problem is..Below is my bulk insert code:</p>\n\n<pre><code>use xta9354\nbulk insert xta9354.dbo.Students\nfrom 'd:\\userdata\\xta9_Students.txt' \nwith (fieldterminator = ',',rowterminator = '\\n') \n</code></pre>\n\n<p>With the sample data, there is no ',' after the Year attribute even tho there is still another attribute Grade after the Year which is NULL</p>\n\n<p>Can someone please tell me how to fix this?</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","append"],"answer_count":4,"favorite_count":1,"up_vote_count":11,"down_vote_count":0,"view_count":11651,"score":11,"question_id":466323,"title":"How to append to a text field in t-sql SQL Server 2005","body":"<p>What is the best way to append to a text field using t-sql in Sql Server 2005?</p>\n\n<p>With a varchar I would do this.</p>\n\n<pre><code>update tablename set fieldname = fieldname + 'appended string'\n</code></pre>\n\n<p>But this doesn't work with a text field.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":27,"score":0,"question_id":13057281,"title":"Grouping and Total Issue","body":"<p>I have a table called Phone_Details and the data looks like:</p>\n\n<pre><code>Name            DeviceType  InvoiceDate TotalCharges\nAguilera, Alex  Smart Phone 8/3/2012    606.55\nAguilera, Alex  Data Card   8/3/2012    26.17\n</code></pre>\n\n<p>I want Output as:</p>\n\n<pre><code>Name            Total Spend    # of devices    Avg Spend    # of Bills &gt;300\nAguilera, Alex  632.72              2            316.36            1\n</code></pre>\n\n<p>I tried doing this:</p>\n\n<pre><code>Select Name,Sum(Totalcharges), Count(DeviceType),Sum(Totalcharges)/Count(DeviceType)\nfrom dbo.Phone_Details\ngroup by Name\n</code></pre>\n\n<p>But How can i get the last column this?</p>\n"},{"tags":["sql-server","tsql","view"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":13056899,"title":"Breaking down/reusing complex calculations in a Transact SQL view","body":"<p>In a SQL view, what is the best way to handle the problem of reusing previous calculations such that they do not become complex/unreadable. </p>\n\n<p>In a stored proc, we could store/output @variables and do the calcs using them as we went along, but my problem is that this must be done in a view. </p>\n\n<p>What's the best way to go about this? (bearing in mind there are a few thousand rows of data).</p>\n\n<pre><code>SELECT  \n        /* CALC 1 output to view row */\n        (SELECT Act.ValueInContractCurrency/dbo.[Contract].Value * \n            (SELECT ISNULL(SUM(dbo.Invoice.ValueInContractCurrency),0)\n             FROM dbo.Invoice \n             WHERE dbo.Invoice.StageId = Act.StageId)) AS InvoicedValueInContractCurrency, \n\n        /* CALC 2 wraps CALC1 inside it and outputs to view row */\n        (SELECT Act.ValueInContractCurrency - \n            (SELECT Act.ValueInContractCurrency/dbo.[Contract].Value * \n                (SELECT ISNULL(SUM(dbo.Invoice.ValueInContractCurrency),0)\n                 FROM dbo.Invoice \n                 WHERE dbo.Invoice.StageId = Act.StageId))) AS RemainingValueInContractCurrency,        \n\n        /* CALC 3 wraps CALC2 inside it (which in turn wraps CALC1) and outputs to view row */\n        (SELECT ConCurrency.CurrentExchangeRate / dbo.[Contract].CostedExchangeRate *\n            (SELECT Act.ValueInContractCurrency - \n                (SELECT Act.ValueInContractCurrency/dbo.[Contract].Value * \n                    (SELECT ISNULL(SUM(dbo.Invoice.ValueInContractCurrency),0)\n                     FROM dbo.Invoice \n                     WHERE dbo.Invoice.StageId = Act.StageId)))) AS RemainingValueInFacilityCurrency\n\n        /* etc... for 10 more calcs that get increasingly long and unreadable via wrapping */\n\n        FROM dbo.Activity AS Act\n        JOIN dbo.Stage ON Act.StageId = dbo.Stage.Id       \n        JOIN dbo.[Contract] ON dbo.Stage.ContractId = dbo.[Contract].Id\n        JOIN dbo.Facility  ON dbo.[Contract].FacilityId = Facility.Id\n        JOIN dbo.Currency AS FacCurrency ON dbo.Facility.CurrencyId = FacCurrency.Id\n        JOIN dbo.Currency AS ConCurrency ON dbo.[Contract].CurrencyId = ConCurrency.Id\n</code></pre>\n"},{"tags":["asp.net","tsql","linq-to-sql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":13015592,"title":"Get the most recent record for each user where value is 'K', action id is null or its state is 1","body":"<p>I have the following tables in SQL Server:</p>\n\n<pre><code>user_id,  value,  date,    action_id\n----------------------------------\n1          A   1/3/2012     null\n1          K   1/4/2012     null\n1          B   1/5/2012     null\n2          X   1/3/2012     null\n2          K   1/4/2012     1\n3          K   1/3/2012     null\n3          L   1/4/2012     2\n3          K   1/5/2012     3\n4          K   1/3/2012     null\n\n\naction_id, state\n----------------------------------\n1           0\n2           1\n3           1\n4           0\n5           1\n</code></pre>\n\n<p>I need to return the most recent record for each user where the value is 'K', the action id is either null or its state is set to 1. Here's the result set I want:</p>\n\n<pre><code>user_id,  value,  date,    action_id\n----------------------------------\n3          K   1/5/2012     3\n4          K   1/3/2012     null\n</code></pre>\n\n<p>For user_id 1, the most recent value is B and its action id is null, so I consider this the most recent record, but it's value is not K.</p>\n\n<p>For user_id 2, the most recent value is K, but action id 1 has state 0, so I fallback to X, but X is not K.</p>\n\n<p>user_id 3 and 4 are straightforward.</p>\n\n<p>I'm interested in Linq to SQL query in ASP.NET, but for now T-SQL is fine too.</p>\n"},{"tags":["sql-server","regex","tsql","like","union"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":13054871,"title":"Using Regular expression on SQL Server instead of of combining two LIKE statements","body":"<p>Is there a way I can use regular expression to avoid a UNION of two LIKE statements?\nfor eg: i have the following</p>\n\n<pre><code>SELECT NAME FROM EMPLOYEE WHERE NAME LIKE 'Adam%'\nUNION\nSELECT NAME FROM EMPLOYEE WHERE NAME LIKE 'Bob%' \n</code></pre>\n\n<p>I don't want to use a UNION and combine the two select statements into one using regular expression. Please help with regex solution or an alternate solution. thanks in advance</p>\n"},{"tags":["sql","sql-server","tsql","ddl"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":203,"score":1,"question_id":12535405,"title":"Invalid column name on sql server update after column create","body":"<p>Does anyone see what's wrong with this code for SQL Server?</p>\n\n<pre><code>IF NOT EXISTS(SELECT *\n              FROM   sys.columns\n              WHERE  Name = 'OPT_LOCK'\n                     AND object_ID = Object_id('REP_DSGN_SEC_GRP_LNK'))\n  BEGIN\n      ALTER TABLE REP_DSGN_SEC_GRP_LNK\n        ADD OPT_LOCK NUMERIC(10, 0)\n\n      UPDATE REP_DSGN_SEC_GRP_LNK\n      SET    OPT_LOCK = 0\n\n      ALTER TABLE REP_DSGN_SEC_GRP_LNK\n        ALTER COLUMN OPT_LOCK NUMERIC(10, 0) NOT NULL\n  END; \n</code></pre>\n\n<p>When I run this, I get:</p>\n\n<blockquote>\n  <p>Msg 207, Level 16, State 1, Line 3<br>\n  Invalid column name 'OPT_LOCK'.</p>\n</blockquote>\n\n<p>on the update command.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql","sql-server-2008","stored-procedures"],"answer_count":6,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":3526,"score":3,"question_id":3292531,"title":"t-sql stored procedure create scripts","body":"<p>I have a bunch of stored procedure names. I want to export the create script for each of the stored procedure. What is the best way to do it? </p>\n\n<p>Right now I am manually selecting the stored proc in SSMS and selecting <code>\"Script stored procedure as -&gt; Drop and Create to\"</code>. This seems tedious. I am hoping there is a better way to deal with this. Thanks.</p>\n"},{"tags":["sql-server","linq","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":43,"score":3,"question_id":13053321,"title":"Convert sql query with multiple inner joins to LINQ","body":"<p>I have this query which I retrieve from 6 tables which gets the dates, rated, rater, classname, scores, subject. </p>\n\n<pre><code>SELECT r.date, u1.username as rated, u2.username as rater, c.name as classname, s.ratings, sbj.name\nFROM Ratings r\n INNER JOIN Users u1 ON u1.userid = r.rated \n INNER JOIN Users u2 ON u2.userid = r.rater \n INNER JOIN ClassMembers cm ON u1.userid  = cm.userid\n INNER JOIN Class c ON cm.teamid = c.teamid\n INNER JOIN Scores s ON s.ratingsid = r.ratingsid \n INNER JOIN Subjects sbj ON sbj.subjectid = s.subjectid\n</code></pre>\n\n<p>this results in</p>\n\n<pre><code>date         | rated | rater | teamname | score |  subject\n10/12/2012    john     mike     teamA      9        Math\n10/09/2012    john     mike     teamA      9        Science\n10/09/2012    john     abra     teamA      5        Math\n10/09/2012    john     abra     teamA      5        Science\n</code></pre>\n\n<p>I have to convert this query to a LINQ expression.\nI'm having a hard time converting my sql query into LINQ. Any help would be appreciated.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":24,"score":0,"question_id":13052474,"title":"Compound conditions in SQL Server 2008 stored procedure","body":"<p>Can you please let me know if stored procedure allow to handle compound condition as below:</p>\n\n<pre><code>if(\n    ( (select Count(*) from dbo.Membership where EmailID=@emailID) &gt;0) \n                                  || \n    ((select Count(*) from dbo.Allocation where ResourceEmail=@emailID)&gt;0))\n)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":13051888,"title":"SQL query returns multiple rows when trying to find specific value","body":"<p>I have 2 tables. One is called \"Tasks\" and the other one is called \"TaskDescription\"\nin my \"Task\" the setup looks like this:\n\"taskID(primary)\",\"FileID\",\"TaskTypeID\" and a bunch of other columns irrelevant.</p>\n\n<p>Then in my \"TaskDescription\", the setup looks like:\n\"TaskTypeID\", \"TaskTypeDesc\"</p>\n\n<p>so for example if TaskTypeID is 1 , then the description would be\"admin\"\nor if TaskTypeID is 2, then TaskTypeDesc would be \"Employee\" etc.</p>\n\n<p>The two tables have a relationship on the primary/foreign key \"TaskTypeID\".</p>\n\n<p>What I am trying to do is get a task id, and the TaskDesc where the FileID matches the @fileID(which I pass in as a param). However in my query I get multiple rows returned instead of a single row when trying to obtain the description.</p>\n\n<p>this is my query:</p>\n\n<pre><code>SELECT taskid,\n       ( 'Task ID: '\n         + Cast(cf.taskid AS NVARCHAR(15)) + ' - '\n         + Cast((SELECT DISTINCT td.tasktypedesc FROM casefiletaskdescriptions\n         td JOIN\n         casefiletasks cft ON td.tasktypeid=cft.tasktypeid WHERE cft.taskid =\n         1841 )AS\n         NVARCHAR(100))\n         + ' - Investigator : ' + ( Cast(i.fname AS NVARCHAR(20)) + ' '\n                                    + Cast(i.lname AS NVARCHAR(20)) ) ) AS\n       'Display'\nFROM   casefiletasks [cf]\n       JOIN investigators i\n         ON CF.taskasgnto = i.investigatorid\nWHERE  cf.fileid = 2011630988\n       AND cf.concluded = 0\n       AND cf.progressflag != 'Conclude' \n</code></pre>\n\n<p>I am trying to get the output to look like \"Task ID: 1234 - Admin - Investigator : John Doe\". However I am having trouble on this part:</p>\n\n<pre><code>CAST((select DISTINCT td.TaskTypeDesc from CaseFileTaskDescriptions td \nJOIN CaseFileTasks cft ON td.TaskTypeID=cft.TaskTypeID \nwhere cft.TaskID =1841 )as nvarchar(100))\n</code></pre>\n\n<p>This seems to work but the problem is I have to hard code the value \"1841\" to make it work. Is there a way to assign a \"taskID\" variable with the values being returned from the TaskID select query, or will it not work since I think sql runs everything at once instead of line by line.</p>\n\n<p>EDIT-this is in Microsoft SQL Server Management Studio 2008</p>\n"},{"tags":["c#",".net","tsql","stored-procedures","insert"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":85,"score":1,"question_id":13034223,"title":"Sql Server run update storedprocedure after insert storedprocedure","body":"<p>I have two storedprocedures one is to <code>insert</code> a record to the table, the other is to <code>update</code> one column of this record.</p>\n\n<p>The <code>insert</code> one runs first, then I will run some other processes (including storedprocedures used for other tables.) and finally I will run the <code>update</code> storedprocedure to update the record as completed.</p>\n\n<p>However, sometimes the <code>update</code> one cannot find the match (the one just inserted, I use some variables (one of them is in type datetime) that I passed to the <code>insert</code> storedprocedure to find the record just inserted then to update. I have used a update trigger to find this reason.) </p>\n\n<p>How can I make sure the data is already in the table before I run the <code>update</code>? do I need a <code>while</code> loop here?</p>\n\n<p><strong>EDIT</strong>: I'm running these all in one <code>BackgroundWorker.DoWork</code> Eventhandler</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":90,"score":0,"question_id":13050961,"title":"Cannot use LIKE so what can I use instead","body":"<p>Here's the issue I am having.  I want to return rows that are similiar from my table in my database.\nConsider two rows with the following text:</p>\n\n<pre><code>'Cisco phones cannot dial out'\n'Phones are not working for outgoing calls'\n</code></pre>\n\n<p>These are two different rows...I tried to do something like this:</p>\n\n<pre><code>DECLARE @TheTest varchar(1000)\nDECLARE @TheResult varchar(1000)\n\nSET @TheTest = ('Cisco phones cannot dial out')\nSET @TheResult = ('Phones are not working for outgoing calls')\n\nCREATE TABLE #Test\n(\nMyCol varchar(1000)\n)\n\nINSERT INTO #Test(MyCol)\nSELECT @TheResult\n\nSELECT * FROM #Test WHERE LOWER(MyCol) LIKE '%' + LOWER(@TheTest) + '%'\n\nDROP TABLE #Test\n</code></pre>\n\n<p>But the result is 0 rows were returned, well I understand that because the string TheTest is not close enough to the string @TheResult...But I need a solution that would actually return this row because the word phones appear in both texts.</p>\n\n<p>Would I have to build something much more elaborate to seperate words and get rid of common words for something like this?  I'd like to mimic functionality that I see on a specific website:</p>\n\n<p><img src=\"http://i.stack.imgur.com/Hw8nn.png\" alt=\"enter image description here\"></p>\n"},{"tags":["linq","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":13051005,"title":"Convert datepart to LINQ from T-SQL","body":"<p>I'm trying to get the date range from last week and 2 weeks ago from Sunday to Saturday\nso today is 10/24/2012, date range is : 10/21/2012 - 10/27/2012</p>\n\n<p>I'm trying to get last week's date range which is: 10/14/2012 - 10/20/2012<br>\nAlso the 2 weeks ago's date range which is: 10/07/2012 - 10/13/2012</p>\n\n<p>I have the right SQL query which is</p>\n\n<pre><code>DECLARE @TodayDayOfWeek INT\nDECLARE @EndOfPrevWeek DateTime\nDECLARE @StartOfPrevWeek DateTime\nDECLARE @EndOf2WeeksAgo DateTime\nDECLARE @Start2WeeksAgo DateTime\n\n\nSET @TodayDayOfWeek = datepart(dw, GetDate())\n--get the last day of the previous week (last Sunday)\nSET @EndOfPrevWeek = DATEADD(dd, -@TodayDayOfWeek, GetDate())\n--get the first day of the previous week (the Monday before last)\nSET @StartOfPrevWeek = DATEADD(dd, -(@TodayDayOfWeek+6), GetDate())\nSET @EndOf2WeeksAgo = DATEADD(dd, -(@TodayDayOfWeek+7), GetDate())\nSET @Start2WeeksAgo = DATEADD(dd, -(@TodayDayOfWeek+13), GetDate())\n\nSelect  @StartOfPrevWeek as [Last week start date], @EndOfPrevWeek as [Last Week start date],\n@Start2WeeksAgo as [2 Weeks Ago Start], @EndOf2WeeksAgo as [2 Weeks Ago End]    \n</code></pre>\n\n<p>This results in</p>\n\n<pre><code>[Last week start date] [Last week start date]  [2 Weeks Ago Start] [2 Weeks Ago End] \n10/14/2012             10/20/2012              10/07/2012          10/13/2012\n</code></pre>\n\n<p>how to i convert this to Linq? I have a date column and need to display dates between these 2 date ranges like</p>\n\n<pre><code>last week date   2 weeks ago\n10/15/2012        10/08/2012\n10/18/2012        10/11/2012\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":8,"favorite_count":7,"up_vote_count":46,"down_vote_count":0,"view_count":42752,"score":46,"question_id":266924,"title":"Create a date with T-SQL","body":"<p>I am trying to convert a date with individual parts such as 12, 1, 2007 into a datetime in SQL Server 2005. I have tried the following:</p>\n\n<pre><code>CAST(DATEPART(year, DATE)+'-'+ DATEPART(month, DATE) +'-'+ DATEPART(day, DATE) AS DATETIME)\n</code></pre>\n\n<p>but this results in the wrong date. What is the correct way to turn the three date values into a proper datetime format.</p>\n"},{"tags":["php","xml","string","tsql","simplexml"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":13051356,"title":"From string to XML","body":"<p>I have the following query: </p>\n\n<pre><code>  SELECT CAST(CAST([xmlDoc] AS VARCHAR(8000)) AS TEXT) AS xmlDoc FROM MYTABLE\n</code></pre>\n\n<p>xmlDoc is an xml. If I don't do the casting as TEXT I'll get this error:</p>\n\n<p>Unicode data in a Unicode-only collation or ntext data cannot be sent to clients using DB-Library (such as ISQL) or ODBC version 3.7 or earlier.</p>\n\n<p>So, thanks to the casting as TEXT I don't have any problems and I go on with my application. </p>\n\n<p>But now I need to parse the xml contained in xmlDoc. It was an xml but now it's a string. </p>\n\n<p>How can I parse xmlDoc ? Can I return it to xml using any php function? What should I do?</p>\n\n<p>I've tried: </p>\n\n<pre><code>$xml= simplexml_load_string($result['xmlDoc']); \n</code></pre>\n\n<p>But I get a FALSE for $mxl</p>\n\n<p>Here's the string: </p>\n\n<pre><code>&lt;Sent&gt;&lt;Head&gt;&lt;Application&gt;T1&lt;/Application&gt;&lt;NumSent U=\"052\" yearg=\"2011\" counter=\"0032\"/&gt;&lt;Date&gt;2011-12-07&lt;/Date&gt;&lt;/Head&gt;&lt;Content&gt;&lt;/Content&gt;&lt;/Sent&gt;\n</code></pre>\n"},{"tags":["sql-server","tsql","dynamic-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":36,"score":0,"question_id":13051311,"title":"Is it possible to have dynamic sql based on a subquery without using variables?","body":"<p>I'd like to do the following in T-SQL:</p>\n\n<pre><code>EXEC('... ' + (SELECT ...))\n</code></pre>\n\n<p>A simple concrete example would be</p>\n\n<pre><code>EXEC('DROP TABLE ' + (SELECT name FROM sys.tables WHERE ...))\n</code></pre>\n\n<p>(Obviously, the WHERE clause is chosen such that the subquery always returns exactly one value.) When I try this, I get an error:</p>\n\n<pre><code>Msg 102, Level 15, State 1, Line 1\nIncorrect syntax near '('.\nMsg 102, Level 15, State 1, Line 1\nIncorrect syntax near ')'.\n</code></pre>\n\n<p>I know that I can work around this by using variables, e.g.:</p>\n\n<pre><code>DECLARE @sql varchar(MAX)\nSELECT @sql = 'DROP TABLE ' + name FROM sys.tables WHERE ...\nEXEC(@sql)\n</code></pre>\n\n<p>but for various reasons I'd like to have only one statement. Is that possible?</p>\n\n<hr>\n\n<p>PS: In case it's relevant, that's the dynamic SQL code I'm trying to squeeze into one statement:</p>\n\n<ul>\n<li><a href=\"http://stackoverflow.com/a/1433384/87698\">How to drop SQL default constraint without knowing its name?</a></li>\n</ul>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":13030257,"title":"SQL Server : getting \"invalid column name\"","body":"<p>I am working on writing a query but there are problems which I couldn't find. Here is my code</p>\n\n<pre><code>begin\n    declare @v_max int\n    declare @v_count int\n    declare @sessionID int\n    declare @sessionStart datetime\n    declare @sessionEnd datetime\n\n    declare my_cursor cursor local for\n        select * from Test;\n\n    open my_cursor\n    fetch next from my_cursor INTO @sessionID, @sessionStart, @sessionEnd\n\n    while @@FETCH_STATUS = 0\n    begin\n        select *  into **@v_count**\n        from [dbo].[Test]\n        WHERE **[dbo].[Test].[SessionStartTime]** &gt; @sessionStart\n        OR **[dbo].[Test].[SessionCloseTime]** &lt; @sessionEnd\n\n        if @v_count &gt; @v_max \n            set @v_max = @v_count\n\n\n        fetch next from my_cursor INTO @sessionID, @sessionStart, @sessionEnd\n    end\n\n    print @v_max;\n\n    close my_cursor\n    deallocate my_cursor\nend \n</code></pre>\n\n<p>Bolded areas have problems:</p>\n\n<blockquote>\n  <p>Msg 207, Level 16, State 1, Line 18<br>\n  Invalid column name 'SessionStartTime'.<br>\n  Msg 207, Level 16, State 1, Line 19<br>\n  Invalid column name 'SessionCloseTime'.<br>\n  Msg 102, Level 15, State 1, Line 16<br>\n  Incorrect syntax near '@v_count'.</p>\n</blockquote>\n\n<p>Here is my Table</p>\n\n<pre><code>CREATE TABLE [dbo].[Test]( \n    [ScenarioID] [bigint] NULL, \n    [SessionStartTime] [datetime] NOT NULL, \n    [SessionCloseTime] [datetime] NULL \n) ON [PRIMARY] \n</code></pre>\n\n<hr>\n\n<p>Here is my Table</p>\n\n<pre><code>CREATE TABLE [dbo].[Test](\n    [ScenarioID] [bigint] NULL,\n    [SessionStartTime] [datetime] NOT NULL,\n    [SessionCloseTime] [datetime] NULL\n) ON [PRIMARY]\n\nGO\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":13049903,"title":"T SQL use case when in parameter","body":"<p>I'm trying to set the variable value with a case statement to determine the financial year, depending on the month but I get a Null value returned for the financial year:</p>\n\n<pre><code>declare\n@Costcentre varchar(50)\n,@dt date\n,@dty int\n,@dtm int\n\nselect @Costcentre = 'CAM'\nSELECT @dt = '2012-09-30'\nselect @dtm = DATEPART(month,@dt)\nselect \n@dty = case when @dtm between 4 and 12 then DATEPART(year,@dt) + 1 end\n,@dty = case when @dtm between 1 and 3 then DATEPART(year,@dt) end\n\n\nselect @dty\n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures","sqlparameters"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":47,"score":0,"question_id":13048641,"title":"Dynamic parameters for sql query with \"IN\" operator","body":"<p>I have an ASP.NET website (c#) and in the code-behind I want to use the <code>IN</code> operator in SQL <a href=\"http://www.w3schools.com/sql/sql_in.asp\" rel=\"nofollow\">http://www.w3schools.com/sql/sql_in.asp</a> to get data from my database. </p>\n\n<p>The syntax is:</p>\n\n<pre><code>SELECT column_name(s)\nFROM table_name\nWHERE column_name IN (value1,value2,...)\n</code></pre>\n\n<p>I use a stored procedure to get data, inside this procedure I run, in the end, the select. </p>\n\n<p>My question is how to build dynamically the (<code>value1, value2, ...</code>) part of the query? How do I send as <code>SqlParameter</code>(s) the values that appear in the <code>IN</code> operator?</p>\n\n<p>The stored procedure is defined like this:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[GetAllUsers]\n    @ORGANIZATION_ID int = null\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    begin\n       SELECT * \n       from USERS\n       where ORGANIZATION_ID = @ORGANIZATION_ID\n    end\nEND\n</code></pre>\n\n<p>I'd like to replace the <code>WHERE</code> clause with something like: </p>\n\n<pre><code>WHERE ORGANIZATION in (xxxxxxxxxxxxx)\n</code></pre>\n\n<p>How to do this?</p>\n\n<p>Thank you.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","set-based"],"answer_count":2,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":84,"score":6,"question_id":13030723,"title":"Trying to avoid RBAR! How to correlate an insert on a related table as a set based operation?","body":"<p>Assume a schema that consists of the following tables:</p>\n\n<p><strong>Baz</strong></p>\n\n<pre><code>BazID (PK, Identity)\nDescription\n</code></pre>\n\n<p><strong>FooTemplate</strong> (A Baz may have zero to many FooTemplates)</p>\n\n<pre><code>FooTemplateID (PK, Identity)\nBazID (FK)\nDescription\nNextGenerationDate\n</code></pre>\n\n<p><strong>BarTemplate</strong> (A FooTemplate may have zero to many BarTemplates)</p>\n\n<pre><code>BarTemplateID (PK, Identity)\nFooTemplateID (FK)\nDescription\n</code></pre>\n\n<p><strong>Foo</strong> (A Baz may have zero to many Foos)</p>\n\n<pre><code>FooID (PK, Identity) \nBazID (FK)\nDescription\n</code></pre>\n\n<p><strong>Bar</strong> (A Foo may have zero to many Bars)</p>\n\n<pre><code>BarID (PK, Identity)\nFooID (FK)\nDescription\n</code></pre>\n\n<p>Each day a stored procedure will execute to generate <code>Foo</code> and <code>Bar</code> entities for an associated <code>Baz</code> entity which have passed their next generation date.</p>\n\n<p>The first part of this procedure looks a little like this:</p>\n\n<pre><code>DECLARE @GeneratedFooIDList TABLE (INT FooID);\nINSERT Foo (BazID, Description)\nOUTPUT inserted.FooID INTO @GeneratedFooIDList\nSELECT\n  BazID\n  Description\nFROM\n  FooTemplate\nWHERE\n  NextGenerationDate &lt; GETDATE()\n</code></pre>\n\n<p>My question is what statement can I now execute to generate the proper <code>Bar</code> entities and have them properly associated with the newly created <code>Foo</code> entities?</p>\n\n<p><strong>EDIT:</strong> The procedure will be executing on a server running SQL Server 2005.</p>\n\n<p><strong>EDIT2:</strong> Thanks to everybody for the help.  After considering the information carefully, I have opted for another solution.  I have changed the primary key in the Foo table to no longer be an automatically generated identity column, this way an intermediary insert into a temporary table could be executed to capture the relevant FooTemplateID along with the FooID</p>\n"},{"tags":["tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":13048356,"title":"T-SQL - If column exists, execute query involving column, else execute another query where column is not present","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/12535405/invalid-column-name-on-sql-server-update-after-column-create\">Invalid column name on sql server update after column create</a>  </p>\n</blockquote>\n\n\n\n<p>I am writing queries to extract data from tables in databases that are present on thousands of machines. The software that creates these databases has gone through plenty of changes hence the newer databases might have newer tables and/or newer columns so I was hoping to write a SQL query that would check for the existence of the column in the table and if present, execute a query that involves the column. If absent then execute a query which leaves out that column. Unfortunately all the posts so far I have come across that deal with missing columns are looking to add the column if it's not present. I am not trying to do that. I have read-only access to the databases and changing older databases is not a possibility.</p>\n\n<p>Here's one post I tried:\n<a href=\"http://stackoverflow.com/questions/133031/how-to-check-if-column-exists-in-sql-server-table\">How to check if column exists in SQL Server table</a></p>\n\n<p>Consider this simple query (this is not exactly what I'm trying to do but it should make things clear):</p>\n\n<pre><code>    IF COL_LENGTH('E_BU','SCID') IS NOT NULL\n      BEGIN\n        SELECT BUID, SCID\n        FROM E_BU\n      END\n    ELSE\n      BEGIN\n        SELECT BUID\n        FROM E_BU\n      END  \n</code></pre>\n\n<p>The above works just fine if executed against a newer database/table that has the SCID column, but when executed against a database/table which doesn't have that column, gives the following error:\nMsg 207, Level 16, State 1, Line 5\nInvalid column name 'SCID'.</p>\n\n<p>Is there anything that can be done in the query to get around such a situation or will I need to perform a check in the front end itself (maybe send an extra query to the database to determine if the column is present or absent and based on that execute the appropriate query)? A similar problem to this would be in the case of an entire table also. If the table is not present the query should not be executed at all.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":70,"score":1,"question_id":13036520,"title":"Why is cross apply making the query slow?","body":"<p>I have a query which is taking about 11 seconds to run for a single date. I want to run the same query for more multiple days. In other words, I want to be able to return snapshots for multiple days. Here is my original query:</p>\n\n<pre><code>SELECT \n    COUNT(*) AS 'Number of Cars',\n    d.ManufacturerName AS 'Make',\n    d.Name AS 'Model', \n    c.name AS 'Car Class'\nFROM CarRating a \n    INNER JOIN OwnedCar b ON a.OwnedCarID = b.OwnedCarID\n    INNER JOIN CarClass c ON a.CarClassID = c.CarClassID\n    INNER JOIN BaseCar d ON b.BaseCarID = d.BaseCarID\n\nWHERE \n    @myDate &lt; a.ExpiredWhen AND @myDate  &gt;= a.EffectiveWhen \nGROUP BY \n    d.Name, c.name,d.ManufacturerName\n</code></pre>\n\n<p>Like I mentioned the query about takes 11 sec. In order to run this query for multiple dates, I am using a date table and cross applying it to the above query:</p>\n\n<pre><code>SELECT [DATE], b.* FROM DimDate \nCROSS APPLY\n    (SELECT \n        COUNT(*) AS 'Number of Cars',\n        d.ManufacturerName AS 'Make',\n        d.Name AS 'Model', \n        c.name AS 'Car Class'\n    FROM CarRating a \n        INNER JOIN OwnedCar b ON a.OwnedCarID = b.OwnedCarID\n        INNER JOIN CarClass c ON a.CarClassID = c.CarClassID\n        INNER JOIN BaseCar d ON b.BaseCarID = d.BaseCarID\n\n    WHERE \n    dimDate.Date &lt; a.ExpiredWhen AND dimDate.Date &gt;= a.EffectiveWhen    \n    GROUP BY \n    d.Name, c.name,d.ManufacturerName) b\n\n WHERE DimDate.Date between @StartDate and @EndDate\n</code></pre>\n\n<p>This query takes 49 sec even for one day. Why is this slow? Is there a better way of doing this?</p>\n"},{"tags":["sql-server-2008","tsql","recursion"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2244,"score":1,"question_id":9004543,"title":"Recursive Child/Parent queries in T/SQL","body":"<p>I am using T/SQL in Microsoft SQL Server 2008</p>\n\n<p>I have a table</p>\n\n<pre><code>CREATE TABLE [TestTable](\n[CHILD] [int] NOT NULL,\n[PARENT] [int] NOT NULL\n) ON [PRIMARY]\n\nGO\n</code></pre>\n\n<p>These are some values which define a parent child hierarchial relationship</p>\n\n<pre><code>CHILD PARENT\n1       2\n2       0\n3       1\n4       2\n5       0\n</code></pre>\n\n<p>Visually, this table looks like this</p>\n\n<pre><code>0\n   2\n      1\n         3\n      4\n   5\n</code></pre>\n\n<p>I would ideally like the values to be shown as follows (where the right hand column indicates the generation)</p>\n\n<pre><code>CHILD    GENERATION\n 0          0\n 2          1\n 1          2\n 3          3\n 4          2\n 5          1\n</code></pre>\n\n<p>My T/SQL code looks like this</p>\n\n<pre><code>with n(CHILD, PARENT, GENERATION) as (\nselect CHILD, PARENT,1 as GENERATION from TestTable\nwhere PARENT=0 \nunion all\nselect nplus1.CHILD, nplus1.PARENT, GENERATION+1 from TestTable as nplus1, n\nwhere nplus1.PARENT=n.CHILD \n)\nselect CHILD,GENERATION from n\n</code></pre>\n\n<p>However it doesn't work!</p>\n\n<p>It returns</p>\n\n<pre><code>CHILD   GENERATION\n2        1\n5        1\n1        2\n4        2\n3        3\n</code></pre>\n\n<p>It has the right generation, but the wrong sort order!\nDoes anyone have any ideas how to solve this?</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":10,"favorite_count":2,"up_vote_count":11,"down_vote_count":0,"view_count":9316,"score":11,"question_id":916414,"title":"How can a LEFT OUTER JOIN return more records than exist in the left table?","body":"<p>I have a very basic LEFT OUTER JOIN to return all results from the left table and some additional information from a much bigger table. The left table contains 4935 records yet when I LEFT OUTER JOIN it to an additional table the record count is significatnly larger.</p>\n\n<p>As far as I'm aware it is absolute gospel that a LEFT OUTER JOIN will return all records from the left table with matched records from the right table and null values for any rows which cannot be matched, as such it's my understanding that it should be impossible to return more rows than exist in the left table, but it's happening all the same!</p>\n\n<p>SQL Query follows:</p>\n\n<pre><code>SELECT     SUSP.Susp_Visits.SuspReason, SUSP.Susp_Visits.SiteID\nFROM         SUSP.Susp_Visits LEFT OUTER JOIN\n                      DATA.Dim_Member ON SUSP.Susp_Visits.MemID = DATA.Dim_Member.MembershipNum\n</code></pre>\n\n<p>Perhaps I have made a mistake in the syntax or my understanding of LEFT OUTER JOIN is incomplete, whatever the reason I'm going mad here, hopefully someone can explain how this could be occuring?</p>\n\n<p>Postscript</p>\n\n<p>Thanks for the grea answers, my understanding of LEFT OUTER JOINS is now much better, could anyone however suggest a way this query could be modified so that I only get as many records returned as exist in the left table? </p>\n\n<p>This query is purely to generate a report and the duplicate matches simply confuse matters.</p>\n\n<p>/Postscript</p>\n"},{"tags":["sql-server-2008","tsql","datetime","date-range"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":13044565,"title":"How to calculate Maximum incoming Call Peaks?","body":"<p>Here is part of database:</p>\n\n<pre><code>SessionID    SessionStartTime              SessionCloseTime\n24       2012-10-16 01:00:06.000           2012-10-16 01:01:22.000\n24       2012-10-16 01:00:08.000           2012-10-16 01:01:10.000\n24       2012-10-16 01:00:16.000           2012-10-16 01:01:12.000\n24       2012-10-16 01:00:30.000           2012-10-16 01:01:48.000\n24       2012-10-16 01:00:41.000           2012-10-16 01:02:08.000\n24       2012-10-16 01:00:48.000           2012-10-16 01:01:34.000\n24       2012-10-16 01:00:56.000           2012-10-16 01:03:09.000\n24       2012-10-16 01:01:02.000           2012-10-16 01:02:13.000\n24       2012-10-16 01:01:05.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:09.000           2012-10-16 01:02:42.000\n24       2012-10-16 01:01:15.000           2012-10-16 01:02:48.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:14.000\n24       2012-10-16 01:01:18.000           2012-10-16 01:02:06.000\n24       2012-10-16 01:01:42.000           2012-10-16 01:03:16.000\n24       2012-10-16 01:01:45.000           2012-10-16 01:03:04.000\n</code></pre>\n\n<p>In this db, I want to calculate max callpeaks. In other words, maximum how much calls are happened at the same time. I am working at a call center and I will generate a report with these records.  SessionID = 24 represents incoming calls. Any Suggestions,clues or calculation methods will be useful for me.</p>\n"},{"tags":["sql-server","tsql","table","data"],"answer_count":11,"favorite_count":56,"up_vote_count":57,"down_vote_count":0,"view_count":48484,"score":57,"question_id":155246,"title":"How do you truncate all tables in a database using TSQL?","body":"<p>I have a test environment for a database that I want to reload with new data at the start of a testing cycle. I am not interested in rebuilding the entire database- just simply \"re-setting\" the data. </p>\n\n<p>What is the best way to remove all the data from all the tables using TSQL? Are there system stored procedures, views, etc. that can be used? I do not want to manually create and maintain truncate table statements for each table- I would prefer it to be dynamic.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":9,"favorite_count":4,"up_vote_count":8,"down_vote_count":0,"view_count":6695,"score":8,"question_id":95967,"title":"How do you list the primary key of a SQL Server table?","body":"<p>Simple question, how do you list the primary key of a table with T-SQL? I know how to get indexes on a table, but can't remember how to get the PK.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":125,"score":2,"question_id":13039931,"title":"Stored procedure not as defensive as it looks","body":"<p>I have several stored procedures structured like the following:</p>\n\n<pre><code>USE [WHouse]\nGO\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROCEDURE [dbo].[pr_Alert_Dly]\nAS\n    IF (SELECT LastRunDate FROM WHouse.dbo.AlertRunDates WHERE NameDescription = 'X' ) &lt; (SELECT CONVERT(DATE, GETDATE()))\n    BEGIN\n       --================\n       --need to comment the following out if trying to re-run\n       UPDATE x \n       SET  x.LastRunDate = CONVERT(DATE,GETDATE())\n       FROM WHouse.dbo.AlertRunDates x\n       WHERE [NameDescription] = 'X' \n       --================\n\n       --===============\n       --DO A LOAD OF STUFF IN HERE \n       --INCLUDING USING DB_SENDMAIL TO EMAIL 20 PEOPLE\n       --===============\n\n    END\n</code></pre>\n\n<p>My colleague has set up a reporting system (using procedures / SSIS) that loops every 10 minutes and as long as a stored procedure completes without an error then it is marked as complete in a control table.</p>\n\n<p>What I don't understand is even if the above throws an error why would it ever repeat the section between <code>BEGIN / END</code> more than once in the same batch ?</p>\n\n<p>If it is not defensive enough how do defend against my colleagues system causing the same emails to get distributed every 10 minutes?!</p>\n"},{"tags":["sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":13040002,"title":"add some data to sql server every month","body":"<p>I want automatic insertion of the data into table every month. </p>\n\n<p>For example there is a table <code>Cost</code>. If there wasn't new data this month(before for example some day of the month) then script should insert data from previous month. I mean</p>\n\n<pre><code> 1234 1.10.1992\n 1334 1.11.1992\n *no data 1.12 was added*\n 1334 1.12.1992\n</code></pre>\n\n<p>I decided to use sql server jobs. I've created a job</p>\n\n<pre><code>exec sp_add_job\n     @job_name = 'Add land cost automatic'\n</code></pre>\n\n<p>then I've created a schedule and attached it to the job</p>\n\n<pre><code>use msdb;\ngo\n\nexec sp_add_schedule\n    @schedule_name = 'Add',\n    @freq_type = 16,\n    @freq_interval = 2,\n    @freq_recurrence_factor = 1;\ngo\n\nexec sp_attach_schedule\n    @job_name = 'Add land cost automatic',\n    @schedule_name = 'Add';\ngo\n</code></pre>\n\n<p>But how to add job step and what to write as a command?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":180,"score":2,"question_id":11985328,"title":"Prevent the insertion of duplicate rows using SQL Server 2008","body":"<p>I am trying to insert some data from one table into another but I would like to prevent the insertion of duplicate rows.  I have currently the following query:</p>\n\n<pre><code>INSERT INTO Table1\n(\n    Table1Col1,\n    Table1Col2,\n    Table1Col3,\n    Table1Col4,\n    Table1Col5\n)\nSELECT\n    Table2Col1,\n    Table2Col2 = constant1,\n    Table2Col3 = constant2,\n    Table2Col4 = constant3,\n    Table2Col5 = constant4\nFROM Table2\nWHERE\n    Condition1 = constant5\nAND\n    Condition2 = constant6\nAND\n    Condition3 = constant7\nAND\n    Condition4 LIKE '%constant8%'\n</code></pre>\n\n<p>What I do not know is that the row I am trying to insert from Table2 into Table1 might already exist and I would like to prevent this possible duplication from happening and skip the insertion and just move onto inserting the next unique row.  </p>\n\n<p>I have seen that I can use a WHERE NOT EXISTS clause and use of the INTERSECT keyword but I did not fully understand how to apply it to my particular query as I only want to use some of the selected data from Table2 and then some constant values to insert into Table1.</p>\n\n<p>EDIT:</p>\n\n<p>I should add that the columns TableCol2 through to TableCol5 don't actually exist in the result set and I am just populating these columns alongside Table2Col1 that is returned.</p>\n"},{"tags":["sql","sql-server","tsql","date","datediff"],"answer_count":4,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":66,"score":7,"question_id":13038116,"title":"SQL DateDiff without enddate","body":"<p>I'm using SQL Server\nI need to know the number of days that a patient was receiving a treatment.\nThe problem is that I can only get a startDate but not an endDate\nWhen I run a query and order it by StartDate I get something like this:</p>\n\n<pre><code>StartDate\n2012-10-11 22:00:00.000\n2012-10-11 23:10:31.000\n2012-10-12 00:28:31.000\n2012-10-12 01:39:01.000\n2012-10-12 02:09:01.000\n2012-10-12 03:39:01.000\n2012-10-12 04:38:50.000\n2012-10-20 06:00:00.000\n2012-10-20 08:06:05.000\n2012-10-20 10:21:55.000\n2012-10-21 14:13:01.000\n2012-10-21 15:13:01.000\n</code></pre>\n\n<p>The answer I should get is 4 days (Days 11, 12, 20 and 21)\nThe treatment stopped on 2012-10-12 and a new treatment started on 2012-10-20\nHow can I sum up the days the patient was getting the treatment despite not having an endDate?</p>\n\n<p>Thank you,</p>\n\n<p>Loperam</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":53,"score":3,"question_id":13041675,"title":"Select value based on role","body":"<p>The following results from a temp table.<br> \nPlease Note : The data below is just a sample so I don't need a hardcoded query, I need a query which works for all kinds of data.</p>\n\n<p>Value = 1 means the User has the role and 0 means the user has no role.\nLike row one Testing 1 has Role A but not Role D.</p>\n\n<p>I need a query for the below cases.</p>\n\n<p>Case # 1  when <code>Role ID = ( A,B,C,D )</code> \nI only need the user/s which have atleast one role assigned.\nI should get back User Testing 1, Testing 2 and Testing 3. Testing 4 wont be coming as no role has been assigned to it.</p>\n\n<p>Case # 2 When <code>Role ID = ( A,B,C,D )</code> .\nI only need the user/s which have all the roles assigned to a it.\nI should get User Testing2 with 4 rows.</p>\n\n<blockquote>\n  <p>username  Value   Role ID<br>\n  Testing1    1 A<br>\n  Testing1    1 B<br>\n  Testing1    1 C<br>\n  Testing1    0 D<br>\n  Testing2    1     A<br>\n  Testing2    1 B<br>\n  Testing2    1 C<br>\n  Testing2    1 D<br>\n  Testing3    1 A<br>\n  Testing3    1 B<br>\n  Testing3    1 C<br>\n  Testing3    0 D<br>\n  Testing4    0 A<br>\n  Testing4    0 B<br>\n  Testing4    0 C<br>\n  Testing4    0 D</p>\n</blockquote>\n"},{"tags":["tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":85,"score":-2,"question_id":13038982,"title":"Invalid length parameter passed to the LEFT or SUBSTRING function","body":"<p>I have the following description: 'Sample Product Maker Product Name XYZ - Size' and I would like to only get the value 'Product Name XYZ' from this.  If this were just one row I'd have no issue just using SUBSTRING but I have thousands of records and although the initial value Sample Product Maker is the same for all products the Product Name could be different and I don't want anything after the hyphen.</p>\n\n<p>What I have so far has generated the error in the header of this question.</p>\n\n<pre><code>SELECT i.Itemid,\n       RTRIM(LTRIM(SUBSTRING(i.ShortDescription, 25, (SUBSTRING(i.ShortDescription, 25, CHARINDEX('-', i.ShortDescription, 25)))))) AS ProductDescriptionAbbrev,\n       CHARINDEX('-', i.ShortDescription, 0) - 25  as charindexpos\nFROM t_items i\n</code></pre>\n\n<p>I am getting 'Argument data type varchar is invalid for argument 3 of substring function'</p>\n\n<p>As you can see, I am getting the value for the last line the sql statement but when I try and plug that into the SUBSTRING function I get various issues.</p>\n"},{"tags":["sql-server","sql-server-2005","tsql","schema"],"answer_count":3,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":4230,"score":5,"question_id":3806245,"title":"SQL server schema and default schema","body":"<p>I have a schema define in my database. Except now everytime I do a sql statement I have to provide the schema ... \n<code>SELECT * FROM [myschema].table</code></p>\n\n<p>I set the default schema for my user using management studio and also ran the \n<code>ALTER USER myUser WITH DEFAULT_SCHEMA [myschema]</code> \nand I still get the invalid object 'table' when writing a query without the schema (SELECT * FROM table)</p>\n\n<p>Is there a way to write <code>SELECT * FROM table</code> without having to specify the schema name all the time?</p>\n\n<p>It's on SQL 2005 using SQL Management Studio.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":68,"score":3,"question_id":13038444,"title":"Dynamic Update a created temp table? basics?","body":"<p>I have <strong>Table-A</strong> that has \"x\" number of rows. (For this example there are 8 rows)</p>\n\n<p>I create <strong>Table-C</strong> with \"x\" number of columns via use of a cursor. (Making this dynamic; should more rows be added to <strong>Table-A</strong>, then more columns are created in <strong>Table-C</strong>)  </p>\n\n<pre>\nTable-C (x = 1 thru 8)\n   UserID  1     2     3     4     5     6     7     8\n</pre>\n\n<p>After creating <strong>Table-C</strong>, rows are inserted into <strong>Table-C</strong> based on userIDs passed back from the webpage input box. (this is done dynamic)</p>\n\n<pre>\nTable-C after inserts:\n   UserID  1     2     3     4     5     6     7     8  \n   57      null  null  null  null  null  null  null  null  \n   74      null  null  null  null  null  null  null  null  \n</pre>\n\n<p>Now I wish to perform an UPDATE<br>\n<strong>Table-B</strong> contains data where column \"x-column\" is associating a UserID to a column in the created <strong>Table-C</strong></p>\n\n<pre>\nTable-B:  \nUserID  x-column  \n34      2  \n34      3  \n57      2  \n57      3  \n57      8  \n74      2  \n74      4  \n74      5  \n74      7  \n74      8  \n93      2  \n93      4  \n</pre>\n\n<p>So end result is to dynamically UPDATE <strong>Table-C</strong> with a 1 where Table-B.UserID = Table-C.column_heading</p>\n\n<pre>\nTable-C after update should look like this:  \n   UserID  1     2     3     4     5     6     7     8  \n   57      null  1     1     null  null  null  null  1  \n   74      null  1     null  1     1     null  1     1  \n</pre>\n\n<p>I am hard pressed on figuring out the syntax for building an UPDATE loop that will take care of this.\nDo I need to use a cursor?  </p>\n\n<p>I am pretty sure this isn't rocket science, I'm still learning!</p>\n"},{"tags":["sql","tsql","sql-server-express","check-constraints"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":13038419,"title":"How to create a concise SQL 'Check Constraint' that disallows certain chars for all string fields?","body":"<p>I have a SQL (SQL Server Express 2008) Table that contains a handful of <code>VARCHAR</code> fields.</p>\n\n<p>I would like to create a <code>Check Constraint</code> which will make sure that none of the <code>VARCHAR</code> values contain certain characters. </p>\n\n<p><strong>Example:</strong> (Do not allow <strong>&lt;</strong>, <strong>></strong>, or <strong>?</strong> characters in the FirstName and LastName columns)</p>\n\n<pre><code>(NOT [FirstName] LIKE '%&lt;%' \nAND NOT [FirstName] LIKE '%&gt;%' \nAND NOT [FirstName] LIKE '%?%')\nAND \n(NOT [LastName] LIKE '%&lt;%' \nAND NOT [LastName] LIKE '%&gt;%' \nAND NOT [LastName] LIKE '%?%')\n</code></pre>\n\n<p>The SQL syntax above works fine, but it would be nice if there was shorthand way of doing the same thing. <em>Notice the redundancy in the example. This is cumbersome if I want to add more columns and/or invalid characters</em></p>\n\n<p>It would be nice if we could do something like this:</p>\n\n<pre><code>NOT FirstName,LastName LIKE IN ('&lt;','&gt;','?')\n</code></pre>\n\n<p>Is it possible for me to do something like this in a <code>Check Constraint</code> expression?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":77,"score":2,"question_id":13037575,"title":"T-SQL CASE / Subquery","body":"<p>I have a T-SQL query below that returns results based on date</p>\n\n<pre><code>SELECT\n    SUM(CASE WHEN date ='2012-10-31' then Amount ELSE 0 END) AS [Amount],\n    SUM(CASE WHEN date ='2012-10-31' then Discount1  ELSE 0 END) AS [Discount 1],\n    SUM(CASE WHEN date ='2012-10-31' then Discount2  ELSE 0 END) AS [Discount 2]\n    SUM(CASE WHEN date ='2012-10-31' then Amount - Discount1 - Discount2 ELSE 0 END) AS   \n[Total Amount]\nFROM\n    Orders\n</code></pre>\n\n<p>Current results:</p>\n\n<pre><code>Amount   Discount1   Discount2   Total\n--------------------------------------  \n100.00   5.00        5.00        90.00\n</code></pre>\n\n<p>I would like to have this run and display/group by month. Any ideas?</p>\n\n<pre><code>                         Amount    Discount1  Discount2   Total\n                       -------------------------------------------\n  October                100.00     5.00        5.00       90.00\n  November               100.00    10.00        5.00       85.00\n  December               200.00    20.00       10.00      170.00 \n</code></pre>\n"},{"tags":[".net","tsql","ado.net","sql-server-2008-r2","concurrent-collections"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":13033923,"title":"TSQL ADO.NET Incorrect Row Count Returned","body":"<p>In C# .NET 4.0 have a BlockingCollection that is taken from </p>\n\n<p><a href=\"http://msdn.microsoft.com/en-us/library/dd267312%28v=vs.100%29.aspx\" rel=\"nofollow\">BlockingCollection</a></p>\n\n<p>Sample BC_AddTakeCompleteAdding  </p>\n\n<p>My problem is that a SQLCommand.ExecuteNonQuery in .NET is returning the wrong row count.<br>\nThe update is on the primary key so should get one row.<br>\nSome times get the correct number.<br>\nOften getting a number greater than 1 (100-10000) in .NET.<br>\nAnd it is not always the same wrong number even when running the exact same TSQL  against the same PK.<br>\nCan copy paste the TSQL to SSMS and get the correct answer (1) every time.  </p>\n\n<pre><code>update [docSVsys]  set [FTSstatus] = '1', [FTSdate] = '10/23/2012 8:51:32 AM' , \ntextHash = '5b4d553360fbe733a66eebf36fa666f7', [textSize] = '39504' \nwhere [sID] = '1525850'\n</code></pre>\n\n<p>Declaring the variable on use and no other variable is named rowsRet5  </p>\n\n<pre><code>int rowsRet5 = sqlCmdUpate.ExecuteNonQuery();\n</code></pre>\n\n<p>Checked for that textHash value and only the one row was updated.<br>\nIt appears to perform the proper update but reports the wrong count.<br>\nGiven the count is wrong not willing to use this on production data.</p>\n\n<p>This command is at the end of the consumer side.<br>\nHave two .BeginExecuteNonQuery above this update.<br>\nThose updates are to different tables and do not reference docSVsys.<br>\nThose tables do have FK reference to docSVsys.<br>\nIn debug if I stop in callbacks (slow it down) then I don't get this error.<br>\nI am wondering if BeginExecuteNonQuery in a Task is not the problem.<br>\nThis wrong rowCount does not match either of asynch rowCounts but is in the same range.   </p>\n\n<p>This base code has processed millions of rows.<br>\nDid not change any of the TSQL.<br>\nIt went bad when converted to producer consumer.</p>\n\n<p>To mark a document as in progress use a very similar TSQL in the producer side and it has no problems.   That loop also has a BeginExecuteNonQuery.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":3,"up_vote_count":4,"down_vote_count":0,"view_count":2599,"score":4,"question_id":283764,"title":"Finding someone's age in SQL","body":"<p>In a SQL Server database, I record people's date of birth. Is there an straight-forward method of working out the person's age on a given date using SQL only? </p>\n\n<p>Using <strong>DATEDIFF(YEAR, DateOfBirth, GETDATE())</strong> does not work as this only looks at the year part of the date. For example <strong>DATEDIFF(YEAR, '31 December 2007', '01 January 2008')</strong> returns 1.</p>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":102,"score":1,"question_id":5826761,"title":"Get age from record in table: T-SQL","body":"<p>So each record on my table has a <code>datetime</code> timestamp column.</p>\n\n<p>How do I return the age (in hours), of these records in the database?</p>\n\n<p>Thank you!</p>\n"},{"tags":["mysql","sql","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":13034992,"title":"how to get this result in SQL","body":"<p>I have this table in excel. I want the following results from my query:</p>\n\n<p><img src=\"http://i.stack.imgur.com/BH4IF.png\" alt=\"drop_rate\"></p>\n\n<p>I tried the following but it doesn't seem to work:</p>\n\n<pre><code>  SELECT DISTINCT \n    bsc,\nCASE WHEN kpi = 'CALL_DROP_BSS_RATE'\n    THEN (SELECT COUNT(bsc) AS u FROM alertes_bss2 WHERE kpi = 'CALL_DROP_BSS_RATE' )ELSE 0\n    END AS CALL_DROP_BSS_RATE\n    ,\n    CASE WHEN kpi = 'CALL_DROP_RATE'\n    THEN (SELECT DISTINCT COUNT(bsc) FROM alertes_bss2 WHERE kpi = 'CALL_DROP_RATE' )\n    ELSE 0\n    END AS CALL_DROP_RATE,\n\n    CASE WHEN kpi = 'SDCCH_Assign_Congestion_Rate'\n    THEN (SELECT  COUNT(bsc) FROM alertes_bss2 WHERE kpi = 'SDCCH_Assign_Congestion_Rate' )\n    ELSE 0\n    END AS SDCCH_Assign_Congestion_Rate\n\n    FROM alertes_bss2\n    GROUP BY bsc\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":98,"score":2,"question_id":13034584,"title":"PATINDEX and CHARINDEX returning different answers SQL Server 2008","body":"<p>I have a single table for which I wish to find all the instances where <code>0</code> is the <strong>last</strong> character in a string field.  I tried this by using two methods and they each returned different results.  </p>\n\n<p>This first query seemed to actually return the correct answer</p>\n\n<pre><code>select * from icd\n    where CHARINDEX('0',icd,LEN(icd)) =LEN(icd) \n</code></pre>\n\n<p>this one does not catch all of the answers</p>\n\n<pre><code>select * from icd\n    where PATINDEX('%0%',icd) = LEN(icd)\n</code></pre>\n\n<p>using </p>\n\n<pre><code>select t.ICD as theCharIndex,x.ICD as thePatIndex from\n(\n\nselect * from icd\n    where CHARINDEX('0',icd,LEN(icd)) =LEN(icd) \n) t\nleft join\n(\nselect * from icd\n    where PATINDEX('%0%',icd) = LEN(icd)\n) x on x.ICD=t.ICD\nwhere x.ICD is null\n</code></pre>\n\n<p>I found the set of data that <code>CHARINDEX</code> picked up that <code>PATINDEX</code> did not. I even did</p>\n\n<pre><code>update icd\nset ICD=RTRIM(icd)\n</code></pre>\n\n<p>Why would <code>PATINDEX</code> indiscriminately leave out some rows?</p>\n"},{"tags":["visual-studio","tsql","reporting-services","mdx","business-intelligence"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":13031661,"title":"MDX Parameter - SSRS","body":"<pre><code>Parameter Value (Its Unique Name) = [Company].[Company Hierarchy].&amp;[10] \n\nParameter Label (Its Name) = HQ\n</code></pre>\n\n<p>I want to type in HQ and generate report for [Company].[Company Hierarchy].&amp;[10]</p>\n\n<p>So, basically, I want to TYPE in label text and transform that somehow so ssrs would generate report for its value that matches MDX format [dim].[hierarchy].&amp;[member]</p>\n\n<p>It's kind of hard to explain but how would I go about setting up the parameter and how would I use that parameter for datasets?</p>\n\n<p>Thank you</p>\n"},{"tags":["tsql","sql-server-2008-r2","linked-server"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":69,"score":1,"question_id":13022914,"title":"Nested view through a linked server gives select permission denied","body":"<p>I have come across a funny permissions issue with nested views that I don't think is caused by ownership chaining.  All servers mentioned are SQL Server 2008 R2.</p>\n\n<p>I have a linked server that is configured to use a specific login, say, Bill.  On my remote server I have a view, let's call it <code>ViewA</code>, which in turn selects from another view, let's call it <code>ViewB</code>.</p>\n\n<p>I can do a select through the linked server which works just fine:</p>\n\n<pre><code>SELECT * FROM [LINKEDSERVER].[DATABASE].[SCHEMA].[VIEWA]\n</code></pre>\n\n<p>This returns a happy result set, no problem.</p>\n\n<p>Now, I have a stored procedure which is attempting to query from the same view.  It is using the same linked server, remember, which is using the same login, Bill.  </p>\n\n<p>When I <code>EXECUTE</code> the stored procedure through management studio, which in turn queries <code>ViewA</code> through the linked server, I get:</p>\n\n<blockquote>\n  <p><em>SELECT permission denied on ViewB.</em></p>\n</blockquote>\n\n<p>The login that the linked server is using, Bill, is part of a role which has explicit access to <code>View A</code>. Both views are part of the same schema, and all objects are owned by dbo.  </p>\n\n<p>Notice it is not complaining about <code>ViewA</code>, which Bill has explicit rights to, but <code>ViewB</code>, which Bill should have rights to because of ownership chaining.</p>\n\n<p>I don't understand why I can query through the Bill Linked Server directly, but the stored procedure fails.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["tsql","select","join","sql-update","table-variable"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":13017245,"title":"sql server update many columns with a select from a join of a table variable and a db table","body":"<p>I have the classical person -> person attributes scheme. \nSo, like this: person(PK) &lt;- person_attribute(FK)</p>\n\n<p>What I need is a query to get one row where a person is joined with her attributes.\nFor example, to transform:</p>\n\n<pre><code>Person:\n{ ID = 123456, Name = 'John Smith', Age = 25 }\nAttributes:\n1) { PersonID = 123456, AttributeTypeID = 'Height', AttributeValue = '6'6'''}\n2) { PersonID = 123456, AttributeTypeID = 'Weight', AttributeValue = '220lbs'}\n3) { PersonID = 123456, AttributeTypeID = 'EyeColor', AttributeValue = 'Blue'}\n</code></pre>\n\n<p>To:</p>\n\n<pre><code>PersonWithAttributes\n{\n ID = 123456, Name = 'John Smith', Age = 25, Height = '6'6''', Weight = '220lbs', EyeColor = 'Blue'\n}\n</code></pre>\n\n<p>To make things worse my persons are in a table variable.</p>\n\n<p>So, I have (in a sp with a parameter of person_id):</p>\n\n<pre><code>--result table\ndeclare @people_info table\n(\nperson_id int,\nname nvarchar(max),\nage int,\nheight nvarchar(10) null,\nweight nvarchar(10) null,\neye_color nvarchar(16) null\n)\n\n\ninsert into @people_info\n select person_id, name, age, null, null, null\n  from dbo.HR.people where person_id = @person_id\n\nupdate pi\n set\n  pi.height = (select pa.attribute_value where pa.attribute_type_id = 'Height'),\n  pi.height = (select pa.attribute_value where pa.attribute_type_id = 'Weight'),\n  pi.eye_color = (select pa.attribute_value where pa.attribute_type_id = 'EyeColor')\n from\n  @people_info pi\n   inner join dbo.HR.person_attributes pa on pi.person_id = pa.person_id\n\nselect * from @people_info\n</code></pre>\n\n<p>Which of course does not work for some reason.\nIf I query the two joined tables and select \"pa.attribute_value where pa.attribute_type_id = 'someval'\" I get the correct value. But the update does not work.</p>\n\n<p>Of course, I can write this as three updates, but I am thinking that it will be faster to do one join and then to filter in the update clause.</p>\n\n<p>Also, please keep in mind that my attributes are spread over three tables, not just the attributes table. So, this is why I have the table variable.</p>\n\n<p>Any help is very welcome. Maybe I am going about this the wrong way. Performance matters. What is the most performant way to accomplish this?</p>\n\n<p>Thank you very much.</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":13028919,"title":"How i can run t-sql script with error exception","body":"<p>I have text column in table, where save date, date saved in 21.02.2012 and 2012-02-21 format, and i want convert all date to 2012-02-21<br>\nHow i run this script with error exception<br>\n<code>update AdvancedFieldsValues set value=(CONVERT(date, value, 104)) where field_id=801</code></p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","pivot"],"answer_count":3,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":92,"score":4,"question_id":13022718,"title":"Return Columns As Rows based on Number of Months","body":"<p>This seems like a simple thing to accomplish but I'm not sure if I am thinking about it correctly to get the desired results. I'm using a pivot but I think I need something else paired with it.</p>\n\n<p>I have an invoice table that contains monthly invoices for each client. At most, a client will have 12 invoices per year, 1 for each month.</p>\n\n<pre><code>+----------+-------+-------+--------------+--------------+--------------+\n| ClientID | Month | Year  | ColumnValue1 | ColumnValue2 | ColumnValue3 |\n+----------+-------+-------+--------------+--------------+--------------+\n|        1 |     1 |  2012 |           20 |           30 |           50 |\n|        1 |     2 |  2012 |           25 |           35 |           40 |\n|        2 |     1 |  2012 |           28 |           38 |           48 |\n+----------+-------+-------+--------------+--------------+--------------+\n</code></pre>\n\n<p>Now, I want to create a list like below based on each client. There would be a column for each month. So Client 1 would look like:</p>\n\n<pre><code>+--------------+----+----+---+---+---+---+---+---+---+----+----+----+-------+\n|  ColumnName  | 1  | 2  | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | Total |\n+--------------+----+----+---+---+---+---+---+---+---+----+----+----+-------+\n| ColumnValue1 | 20 | 25 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  0 |  0 |  0 |   45  |\n| ColumnValue2 | 30 | 35 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  0 |  0 |  0 |   65  |\n| ColumnValue3 | 50 | 40 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  0 |  0 |  0 |   90  |\n+--------------+----+----+---+---+---+---+---+---+---+----+----+----+-------+\n</code></pre>\n"},{"tags":["tsql","delete","sql-server-2012","cross-apply"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":51,"score":1,"question_id":13027482,"title":"T-SQL Using Cross-Apply with Delete Statement","body":"<p>I have the following tables:</p>\n\n<pre><code>RecordID\n101\n102\n103\n104\n105\n106\n\nTableOne\n101\n102\n103\n104\n\nTableTwo\n\n\nTableThree\n101\n102\n</code></pre>\n\n<p>and I need to delete the RecordsID rows, that are not included in the other tables. Please, note that sometimes the one of the tables TableOne,TableTwo,TableThree could be empty and no records should be deleted then.</p>\n\n<p>The result table should be:</p>\n\n<pre><code>RecordID\n101\n102\n</code></pre>\n\n<p>Because of the empty tables I am not able to use INNER JOIN. And because I am using these code in a function I am not able to make a dynamic SQL statement containing only tables with records and executed it.</p>\n\n<p>I could this with IF statements, but in my real situation I have many cases to check and many tables to join and a lot of code duplication is going as a result.</p>\n\n<p>That's why I started to wonder is there a way to do this cleverer and cleaner with CROSS APPLY?</p>\n"},{"tags":["c#","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":1890,"score":0,"question_id":2136459,"title":"how to query sql server database size","body":"<p>When writing C# code, if I can manage to get a SqlConnection, \nis there any way to perform a query to get the size of the Database?</p>\n\n<p>I searched the internet, seems \"sp_spaceused\" can be used,\nbut it is not a table, it is a procedure.</p>\n\n<p>Can I query a procedure?</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":13028462,"title":"TSQL return all records in-case of null inside IN","body":"<p>I want to filter by @campId if not null, or return all if null</p>\n\n<p>This compiles but does not work as intended:</p>\n\n<pre><code> declare @campId int\n select * \n from cli \n where \n    cu in (\n        CASE @campId \n          when null then (select id from [dbo].[camp]) \n          else @campId \n        end) \n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2","inner-join"],"answer_count":6,"favorite_count":4,"up_vote_count":25,"down_vote_count":0,"view_count":994,"score":25,"question_id":10297231,"title":"WHERE Clause vs ON when using JOIN","body":"<p>Assuming that I have the following T-SQL code:</p>\n\n<pre><code>SELECT * FROM Foo f\nINNER JOIN Bar b ON b.BarId = f.BarId;\nWHERE b.IsApproved = 1;\n</code></pre>\n\n<p>The following one also returns the same set of rows:</p>\n\n<pre><code>SELECT * FROM Foo f\nINNER JOIN Bar b ON (b.IsApproved = 1) AND (b.BarId = f.BarId);\n</code></pre>\n\n<p>This might not be the best case sample here but is there any performance difference between these two?</p>\n"},{"tags":["sql","tsql","math"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":190,"score":0,"question_id":13026675,"title":"Calculating distance between two points (Latitude, Longitude)","body":"<p><strong>Edit:</strong> MSSQL 2008</p>\n\n<p>I am trying to calculate the distance between two positions on a map.\nI have stored in my data: Longitude, Latitude, X POS, Y POS.</p>\n\n<p>I have been previously using the below snippet.</p>\n\n<pre><code>DECLARE @orig_lat DECIMAL\nDECLARE @orig_lng DECIMAL\nSET @orig_lat=53.381538 set @orig_lng=-1.463526\nSELECT *,\n    3956 * 2 * ASIN(\n          SQRT( POWER(SIN((@orig_lat - abs(dest.Latitude)) * pi()/180 / 2), 2) \n              + COS(@orig_lng * pi()/180 ) * COS(abs(dest.Latitude) * pi()/180)  \n              * POWER(SIN((@orig_lng - dest.Longitude) * pi()/180 / 2), 2) )) \n          AS distance\n--INTO #includeDistances\nFROM #orig dest\n</code></pre>\n\n<p>I don't however trust the data coming out of this, it seems to be giving slightly inaccurate results.</p>\n\n<p>Some sample data in case you need it </p>\n\n<pre><code>Latitude        Longitude     Distance \n53.429108       -2.500953     85.2981833133896\n</code></pre>\n\n<p>Could anybody help me out with my code, I don't mind if you want to fix what I already have if you have a new way of achieving this that would be great.</p>\n\n<p>Please state what unit of measurement your results are in.</p>\n\n<p>Many thanks,\nJames</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":25,"score":1,"question_id":13027217,"title":"SQL Server 2008 - Use IDENTITY field when inserting a row","body":"<p>My table has 3 columns <code>ID</code>, <code>ISOCode</code> and <code>CountryName</code>.</p>\n\n<p>Column <code>ID</code> is an IDENTITY column.</p>\n\n<p>When I insert new records into this table, I want to populate the <code>ISOCode</code> field - on occasion - with the same value as the <code>ID</code> field.</p>\n\n<p>I've tried SCOPE_IDENTITY(), @@IDENTITY and IDENT_CURRENT but none of these seems to work.</p>\n\n<p>Is there a way I can do this?</p>\n"},{"tags":["sql-server","tsql","datetime","stored-procedures","date-range"],"answer_count":1,"favorite_count":3,"up_vote_count":3,"down_vote_count":0,"view_count":68,"score":3,"question_id":13024909,"title":"Counting between two dates","body":"<p>I wrote a procedure which takes 3 parametes StartDate, EndDate and TimeRange. According to the TimeRange, my procedure splits dates and counting them seperately. Here is my procedure:</p>\n\n<pre><code>PROCEDURE [dbo].[Procedure1] \n\n    @Start datetime, \n    @Finish datetime,\n    @TimeRange time\nAS\nBEGIN\n\n    SET NOCOUNT ON;\n\n    declare @TimeRanges as TABLE (SessionStart datetime, SessionEnd datetime);\n\n     with TimeRanges as (\n  select @Start as StartTime, @Start + @TimeRange as EndTime\n  union all\n  select StartTime + @TimeRange, EndTime + @TimeRange\n    from TimeRanges\n    where EndTime  &lt; @Finish )\n  select StartTime, EndTime, Count( Test.ScenarioID ) as TotalInboundArrivals\n    from TimeRanges as TR left outer join\n      dbo.Test as Test on TR.StartTime &lt;= Test.SessionStartTime and Test.SessionCloseTime &lt; TR.EndTime\n    where Test.ScenarioID = 24  \n    group by TR.StartTime, TR.EndTime   \nEND\n</code></pre>\n\n<p>For Example,</p>\n\n<pre><code>Start Time: 11:00\nEnd Time: 12:00\nTimeRange : 05:00\n\nThis procudure splits them like\n     TimeRange    TotalCallPeaks\n    11:00 11:05      12\n    11:05 11:10      8\n    11:10 11:15      15 \n    etc..\n</code></pre>\n\n<p>Here is my question: I need maximum calls which happens at the same time. In other words, I need call peaks. Any suggestions or clue will be so useful for me. </p>\n\n<p><img src=\"http://i.stack.imgur.com/ZweIq.jpg\" alt=\"enter image description here\">\nThere are 6 calls happened in this time range but 4 of them are happened at the same time which I want to calculate. Max point shows the max call peaks. 5th and 6th calls are happened in this time range but has no effect on the max call peaks. </p>\n"},{"tags":["sql","sql-server","tsql","triggers","sqlclr"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":184,"score":1,"question_id":8139019,"title":"Feasibility of SQLCLR Trigger or Stored Procedure for Audit Trail?","body":"<p>Disclaimer: I am unable to implement this properly in the application, as the application I'm working on doesn't do data access in a consistent way, and refactoring effort would be too great for the scope of the project and coming deadline.</p>\n\n<p>How would I go with implementing a SQLCLR Trigger for Audit Trail? I would like it to be as simple as possible, <em>and as easy to remove and replace with proper implementation</em> later as possible.</p>\n\n<p>I'm planning to write my audit to a single table (the database is not very write heavy), having columns like:</p>\n\n<ul>\n<li>Timestamp (<code>datetime</code>) - when the change happened?</li>\n<li>Username (<code>varchar</code>) - who made the change?</li>\n<li>AffectedTableName (<code>varchar</code>) - which table has been affected?</li>\n<li>AffectedRowKey (<code>varchar</code>) - this will be either a simple or compound key like (<code>Id=42</code>, <code>A=4,B=2</code>)</li>\n<li>OperationType (<code>char(1)</code>) - either <code>I</code>, <code>U</code> or <code>D</code> for insert, update and delete respectively.</li>\n<li>InsertedXml (<code>xml</code>) - xml-serialized row (<code>SELECT * FROM INSERTED FOR XML AUTO</code>)</li>\n<li>DeletedXml(<code>xml</code>) - xml-serialized row (<code>SELECT * FROM DELETED FOR XML AUTO</code>)</li>\n</ul>\n\n<p>I'm planning to query and resolve this data to a user-readable form in the application. I'm planning to implement this as a database trigger, written using SQLCLR. I can see 2 possible approaches:</p>\n\n<ul>\n<li>Implement this entirely as SqlTrigger method:</li>\n<li>Implement this as a SqlProcedure method taking parameters:\n<ul>\n<li>schemaName</li>\n<li>tableName</li>\n<li>insertedXml</li>\n<li>deletedXml</li>\n</ul></li>\n</ul>\n\n<p>I will appreciate any constructive criticism and suggestions. My limitation is that I have to implement the audit at the database level using triggers, and I want it to be as maintainable (read: removable and replacable) as possible. Also ideally, I don't want to have hundreds of triggers with exactly the same body, in case I have to modify them.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":58,"score":2,"question_id":13024831,"title":"How to iterate through each row in sql server?","body":"<pre><code>select name from sys.tables where name like '%JPro_VP_Service%'\n</code></pre>\n\n<p>My above query returns 26 table names.</p>\n\n<p>Now I'm trying to write a query to check in every table return from above query.</p>\n\n<pre><code>select * from JPro_VP_Service --consider this is my first table like wise I want to search in 26 tables return from above query\nwhere row_id like '%1-101%' or row_id like '%1-102%'\n</code></pre>\n\n<p>I think I need to write for or cursor to accomplish this can anyone help me how to achieve this?</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":26,"score":0,"question_id":13014972,"title":"How to capture the newly inserted row's ID value from C#?","body":"<p>Here's my stored procedure</p>\n\n<pre><code>ALTER PROCEDURE dbo.spInsertNewTask\n@ModuleID               int, \n@Task                   varchar(50), \n@StartDate              date, \n@PlannedEndDate         date, \n@EstimatedEndDate       date, \n@Status                 int,\n@Comments               varchar(500),\n@Started                bit\nAS\nINSERT INTO DTasks (ModuleID, Task, StartDate, PlannedEndDate, EstimatedEndDate, Status, Comments, Started, LastUpdated)\nVALUES (@ModuleID, @Task, @StartDate, @PlannedEndDate, @EstimatedEndDate, @Status, @Comments, @Started, GETDATE())\n\nRETURN SCOPE_IDENTITY()\n</code></pre>\n\n<p>When I try to capture the newly created ID, all I'm getting is always 1. How to capture the New row's ID?</p>\n\n<pre><code>newID = cmd.ExecuteNonQuery();\n</code></pre>\n\n<p>In fact I need this new ID for further processing.</p>\n\n<p>Thanks for helping.</p>\n"},{"tags":["c#",".net","tsql","datetime","empty-string"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":141,"score":2,"question_id":13000257,"title":"Return NULL datetime value from T-SQL into C# DataTable ==> DataRow instead of empty string","body":"<p>This value (row[10]) is coming from a DataRow object, from a SQL result set in T-SQL.  I believe it has a type \"object\".  In my database, I have a value of NULL for this field for this particular record, but it's returning an empty string in my result set, not a null value.  I'd like to fix the root problem and have my result set return NULL instead of an empty string, but if that's not possible, making this code more efficient would be just fine--meaning the 1st snippet, since it works for all 3 cases.</p>\n\n<p><em><strong>This works when row[10].ToString() is equal to an empty string, null or a DateTime format, but I'd like to shorten it.  This is my workaround for now.</em></strong></p>\n\n<pre><code>        string temp0 = row[10].ToString();\n        DateTime? temp = null;\n        if (temp0 == \"\")\n        {\n            temp0 = null;\n        }\n        if (temp0 != null)\n        {\n            temp = DateTime.Parse(temp0);\n        }\n\n        d.date_migrate_prod = temp == null ? null : temp;\n</code></pre>\n\n<p><em><strong>This works for a null datetime value, an actual datetime value, but not when row[10] is equal to an empty string.</em></strong></p>\n\n<pre><code>        DateTime? temp = DateTime.Parse(row[10].ToString());\n        d.date_migrate_prod = temp == null ? null : temp;\n</code></pre>\n"},{"tags":["sql","sql-server","xml","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":4,"view_count":45,"score":-4,"question_id":13024510,"title":"XML document could not be created because server memory is low","body":"<p><code>\"XML document could not be created because server memory is low. Use sp_xml_removedocument to release XML documents.\"</code></p>\n\n<p>I am having this error while executing a query. The query is supposed to take data from a table column having xml as text, then extract the data and insert it to new tables.</p>\n"},{"tags":["php","mysql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":13015237,"title":"PHP: Query retrieving first and some empty rows","body":"<p>I have the following code: </p>\n\n<pre><code>while ($var1 == $var2)\n{\n    $sql = SELECT disabled FROM MYTABLE WHERE VAR2=$var2;\n    $r = mysql_query($sql);\n    while ($row = mysql_fetch_assoc($r)) \n    {\n        // do something\n    }\n}\n</code></pre>\n\n<p>My problem is that $sql retrieves ten rows: 4 of them have data, the rest are empty. </p>\n\n<p>As the first row is empty the second while is never entered.  </p>\n\n<p>But I need it to be entered, what do I have to do? </p>\n\n<p>In the example code I'm using MySQL but I can use TSQL.  </p>\n\n<p>Thanks a lot</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":13025060,"title":"Join on output result","body":"<p>How come this query fails to run?</p>\n\n<pre><code>select * \nfrom ass \njoin (\n    UPDATE [dsa]\n    SET col1='123'\n    OUTPUT inserted.*) as ds on ass.dsaid = ds.ID\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":13024512,"title":"How to return requested results?","body":"<p>For each region show the region and number of countries with populations of at least 10 million.</p>\n\n<p>The table is called bbc and has the following fields:  </p>\n\n<ul>\n<li>name   (refers to the names of the countries)  </li>\n<li>region  (refers to region of the world)  </li>\n<li>area     (area in miles) </li>\n<li>population  (how many peoples said country has)  </li>\n<li>gdp      (gross domestic product)  </li>\n</ul>\n\n<p>I was thinking I could do something like:  </p>\n\n<pre><code> SELECT region, COUNT(name) FROM bbc \n GROUP BY region \n HAVING population &gt; 10000000\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":13024006,"title":"Scalar-valued function doesn't return expected result","body":"<p>I have created a scalar-valued function in Microsoft SSMS, it is as follows:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[fGetCurrentBalFromName] \n(\n    @Name NVarchar,\n    @CliFl Bit\n)\nRETURNS Money\nAS\nBEGIN\n    DECLARE @CurrentBal Money\n\n    select @CurrentBal=SUM(tt.Debt) from  \n     (select case t.Clientfl when 1 then dbo.fGetClientNameFromId(t.AgentID) \n                    else dbo.fGetSupplierNameFromId(t.AgentID) \n             end as Cli,\n             t.Clientfl,\n         case t.Clientfl when 1 then \n            case t.Incomfl \n                when 1 then t.Amount \n                       else (-1)*t.Amount \n            end\n         else\n            case t.Incomfl\n                when 1 then (-1)*t.Amount\n                        else t.Amount\n            end\n         end as Debt              \n      from [Store].[dbo].[Money] t) tt where tt.Cli=@Name and tt.Clientfl=@CliFl\n      group by tt.Cli\n\n    RETURN @CurrentBal\n\nEND\n</code></pre>\n\n<p>When I execute </p>\n\n<pre><code>Select dbo.fGetCurrentBalFromName('',1)\n</code></pre>\n\n<p>I get no(NULL) result.</p>\n\n<p>But when I try to execute the query alone without parameters</p>\n\n<pre><code>select SUM(tt.Debt) from  \n         (select case t.Clientfl when 1 then dbo.fGetClientNameFromId(t.AgentID) \n                        else dbo.fGetSupplierNameFromId(t.AgentID) \n                 end as Cli,\n                 t.Clientfl,\n             case t.Clientfl when 1 then \n                case t.Incomfl \n                    when 1 then t.Amount \n                           else (-1)*t.Amount \n                end\n             else\n                case t.Incomfl\n                    when 1 then (-1)*t.Amount\n                            else t.Amount\n                end\n             end as Debt              \n          from [Store].[dbo].[Money] t) tt where tt.Cli='' and tt.Clientfl=1\n          group by tt.Cli\n</code></pre>\n\n<p>I get exactly what I want. \n So what is the mistake I had done creating the scalar-valued function. \n Any help will be appreciated!</p>\n"},{"tags":["c#","linq","tsql","recursion"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":13020838,"title":"How to know if the user has permission on a parent node of a tree?","body":"<p>I have a tree like representation of a company, it is stored in the database as the following table:</p>\n\n<pre><code>  ID       ParentID     Name\n ==================================\n   1        NULL        Company\n   2        1           Division one\n   3        1           Division two\n   4        1           Division three\n   5        2           Department 1.1\n   6        3           Department 2.1\n   7        3           Department 2.2\n   8        3           Department 2.3\n   9        4           Department 3.1\n  10        NULL        Company 2\n</code></pre>\n\n<p>Now, when I give permission to a user, I need to assign him for a group from the above table, if I assign him for a group he will automatically have permission on the child groups. I can easily check this if it's about one group. But for example if I give the user permission on (division 2) and then the user is making some transaction on (department 2.2) I need to find a way that automatically permits the transction because the user is already permitted on a parent group. I can only think of recursive method where I check the targeted group and if user has no permission on it and it has a parent group then I recall the same method to authenticate its parent and so on until I find a group which the user is permitted for or reach the root group and not authenticate the user. Remember the child can have another child within it and so on.</p>\n\n<p>Is there a way to do this in a better way? Either with Linq or plain old T-SQL?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":13020405,"title":"Flattening XML structure in T-SQL","body":"<p>I have the following XML structure</p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;DataItems&gt;\n    &lt;DataItem&gt;\n        &lt;ID&gt;ID1&lt;/ID&gt;\n        &lt;Metric1&gt;Metric11Value&lt;/Metric1&gt;\n        &lt;Metric2&gt;Metric12Value&lt;/Metric2&gt;\n        &lt;OptionalParameters&gt;\n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName1&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue1&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits1&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt; \n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName2&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue2&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits2&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt;\n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName3&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue3&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits3&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt;\n        &lt;/OptionalParamters&gt;\n    &lt;DataItem&gt;\n        &lt;ID&gt;ID2&lt;/ID&gt;\n        &lt;Metric1&gt;Metric21Value&lt;/Metric1&gt;\n        &lt;Metric2&gt;Metric22Value&lt;/Metric2&gt;\n        &lt;OptionalParameters&gt;\n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName1&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue1&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits1&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt; \n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName2&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue2&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits2&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt;\n           &lt;OptionalParameter&gt;\n              &lt;ParameterName&gt;ParamName3&lt;/ParameterName&gt;\n              &lt;ParameterValue&gt;ParamValue3&lt;/ParameterValue&gt;\n              &lt;ParameterUnits&gt;ParamUnits3&lt;/ParameterUnits&gt;\n           &lt;OptionalParamter&gt;\n        &lt;/OptionalParamters&gt;\n    &lt;DataItem&gt;\n&lt;/DataItems&gt;\n</code></pre>\n\n<p>I would like to flatten it in a fashion that will give me a table row like</p>\n\n<pre><code>(ID, Metric1, Metric2, ParamName, ParamValue, ParamUnits)\n</code></pre>\n\n<p>The problem is that I don't know how do peform the dynamic filtering I need in order to eliminate the invalid rows that result during the inner join or cross apply. So what I have essentially a total of (Number of Data Items)^2 of rows with all the permutations of parameters names, values, and units. I want to know how to filter out the invalid rows.</p>\n"},{"tags":["sql-server","tsql","time","formatting","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12960805,"title":"Substring Time Formatting","body":"<p>Currently I am using this script to pull a time out of a column:</p>\n\n<pre><code>    (RIGHT('0' + ltrim(RIGHT(convert(varchar,cast(SUBSTRING(A.DocSign, CHARINDEX('^', A.DocSign) +1, 19) as datetime), 100), 7)), 7))\n</code></pre>\n\n<p>What this returns is a time formatted like this 10:34AM - It is also converting military time to standard time in this code, and appends it to additional items I am pulling out of columns such as the date, last name, etc. I need the time to display as 10:54:00 AM</p>\n\n<p>So essentially I need to add :00 (always zeros) to the end of any of the times and add a space between the zeros and the AM or PM that is coming in. </p>\n\n<p>I am not very good at formatting, so I am having trouble with this one. Any suggestions?\n(I'm running SQL Server 2008 R2) </p>\n"},{"tags":["sql","tsql","sql-server-2005","stored-procedures","clrstoredprocedure"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":13008464,"title":"How to extract date fields from string/text field in sql server 2005","body":"<p>There is a text filed in a table called as description. I would like to extract two date fields from this string when there is an occurrence of '~' character using sql server 2005 stored procedure. Help me out in this case.</p>\n\n<p>Example: string: ';10/1/2012 ~ 10/31/2012'. At occurrence of ~ operator I would like to have from-date: 20121001 and to-date:20121031.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":35,"score":2,"question_id":13019358,"title":"How to both update and select in a same operation","body":"<p>How do I do this in TSQL? : <a href=\"http://stackoverflow.com/questions/2934369/how-update-and-select-at-the-same-time\">How UPDATE and SELECT at the same time</a></p>\n"},{"tags":["sql-server","tsql","datediff"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":55,"score":1,"question_id":13019233,"title":"DateDiff function SQL Server","body":"<p>How can I subtract 3 months from the <code>GETDATE()</code> function? </p>\n\n<p>What I am trying to do is get the last day of the month 3 months prior to the current month. So if today is 10.22.2012 how can I subtract 3 months from the current date and print the last day of that month, so I am looking to get this date: 07.31.2012?  </p>\n\n<p>Here is what I have so far but it only prints the last day of previous month:</p>\n\n<pre><code>DATEADD(MILLISECOND, -3,\nDATEADD(MONTH, DATEDIFF(MONTH, -4, GETDATE()), 0))\n</code></pre>\n\n<p>Not printing what I need. Any help is greatly appreciated.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":39,"score":2,"question_id":13019263,"title":"Getting a 1:1 match between three fields on two tables","body":"<p>Given two tables like this:</p>\n\n<pre><code>Date | Client | Category | Amount1 | x\nA      B        C          234\nX      Y        Z          456\n\nMonthDate | Client | Category | Amount2 | y\nB           C        D          567\nA           B        C          123\n</code></pre>\n\n<p>How can I find records where x.Month(Date) = y.MonthDate, x.Client = y.Client, and x.Category = y.Category?</p>\n\n<p>I need to be able to display Amount1 - Amount 2 = Net for certain clients.</p>\n"},{"tags":["c#","sql-server","tsql","stored-procedures","exception-handling"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":131,"score":1,"question_id":13013565,"title":"Specified cast is not valid when trying Convert.ToInt32(value)","body":"<p>I am trying to run a stored procedure and for some reason it keeps telling me <code>\"Specified cast is not valid\"</code>. the \"<code>hidSelectedExpenseIDs</code>\" is a hidden field that gets populated with a javascript array of id's. </p>\n\n<p>Example: the <code>\"hidSelectedExpenseIDs.Value\"</code> would look like \"123,124,125,126\". Hence why I have the <code>.Split(',')</code> in there.</p>\n\n<p>Here is my code:</p>\n\n<pre><code>public void hasExhistingExpenseInvoice()\n{\n    string[] Expenses = hidSelectedExpenseIDs.Value.Split(',');\n\n    //check if there is an existing invoice. Then report back to the user so the\n    //user knows if he/she has to check overwrite option.\n    bool invoiceExists = false;\n\n    foreach (var expense in Expenses)\n    {\n        var connection = new SqlConnection(ConfigurationManager.ConnectionStrings[\"OSCIDConnectionString\"].ToString());\n        var command = new SqlCommand(\"p_CaseFiles_Expenses_InvoiceExhists\", connection);\n        command.Parameters.Add(new SqlParameter(\"@ExpenseID\", SqlDbType.Int));\n        command.Parameters[\"@ExpenseID\"].Value = Convert.ToInt32(expense);\n        command.CommandType = CommandType.StoredProcedure;\n        try\n        {\n            connection.Open();\n            invoiceExists = (bool)command.ExecuteScalar();\n            if (invoiceExists)\n            {\n                //previous invoice exhists\n                Warning1.Visible = true;\n                Warning1.Text = \"There is an exhisting Invoice.\";\n            }\n        }\n        catch (SqlException sql)\n        {\n            lblStatus.Text = \"Couldn't connect to the Database - Error\";\n            lblStatus.ForeColor = System.Drawing.Color.Red;\n        }\n        catch (Exception ex)//catches exception here\n        {\n            lblStatus.Text = \"An error occured\";\n            lblStatus.ForeColor = System.Drawing.Color.Red;\n        }\n        finally\n        {\n            if (connection.State == ConnectionState.Open)\n                connection.Close();\n        }\n    }\n}\n</code></pre>\n\n<p>this is my stored procedure:</p>\n\n<pre><code>ALTER PROCEDURE dbo.[InvoiceExhists]\n@ExpenseID int\nAS\nBEGIN\n    SELECT InvNumber FROM dbo.Expenses from ExpID = @ExpenseID\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":1,"up_vote_count":13,"down_vote_count":0,"view_count":21215,"score":13,"question_id":600446,"title":"SQL Server: How do you return the column names from a table?","body":"<p>Please can someone show me how I would return the column names of a table using SQL server 2008?</p>\n\n<p>i.e. a table contains the columns id, name, address, country and I want to return these as data?</p>\n\n<p>Thank you</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":63,"score":2,"question_id":13014626,"title":"Compare two list items","body":"<p>I am trying to compare a database field which stores list items (comma separated) with unfortunately a variable which is also a list item.</p>\n\n<p><strong>Example:</strong></p>\n\n<p>In this case, a user can belong to multiple groups, and content access is also allocated to multiple groups.</p>\n\n<pre><code>contentid | group  \n (1)   (c,d)   \n (2)   (a,c)  \n (3)   (b)\n</code></pre>\n\n<p>So, I need to select all content where user is in group (a,c). In this case, contentid 1,2 should be returned.</p>\n"},{"tags":["tsql","index","sql-server-2008-express"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":13014887,"title":"SQL Server Timeout: Drop and Recreate Index Solves the Issue","body":"<p>After having sql timeout issues with one of our queries we added a few indices that then made the query run very quickly and got rid of any timeout out issues we were having.  The strange thing is after about a month of use, the query starts to timeout again.  If we drop the same set of indices and recreate them, the query starts running very quickly again.</p>\n\n<p>The indices are nothing fancy:</p>\n\n<pre><code>CREATE NONCLUSTERED INDEX [IX_Transaction_BillingAccountId] ON [dbo].[Transaction] \n(\n     [BillingAccountId] ASC\n)\nWITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n</code></pre>\n\n<p>Any ideas as to why this would happen? We are using SQL Server 2008 Express.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":137,"score":1,"question_id":13012200,"title":"How do I loop through a temp table in a stored procedure with no pk","body":"<p><strong>Problem:</strong></p>\n\n<p>I need to loop through the records in one table, pulling the employee number and comparing this employee number against another table to see if they're still active employees. If they are no longer active employees I need to pass the data from this row into another stored proc.</p>\n\n<p><strong>Research:</strong></p>\n\n<p>I've googled around quite a bit and realize that I shouldn't use cursors for this. I did however, find the following examples:</p>\n\n<ol>\n<li><a href=\"http://ask.sqlservercentral.com/questions/7969/loop-through-records-in-a-temporary-table.html\" rel=\"nofollow\">http://ask.sqlservercentral.com/questions/7969/loop-through-records-in-a-temporary-table.html</a></li>\n<li><a href=\"http://eedle.com/2010/11/11/looping-through-records-in-sql-server-stored-procedure/\" rel=\"nofollow\">http://eedle.com/2010/11/11/looping-through-records-in-sql-server-stored-procedure/</a></li>\n</ol>\n\n<p>However, it seems like they use a pk to loop through the records. Employee numbers can be the same for multiple recods in my scenario </p>\n\n<p><strong>Questions:</strong></p>\n\n<ol>\n<li>Is it possible to achieve what I'm attempting without cursors?</li>\n<li>If it is possible, how would I go about fetching each row with a non unique column?</li>\n</ol>\n"},{"tags":["sql","sql-server","database","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":7,"view_count":102,"score":-7,"question_id":13005484,"title":"Find missing number in table in SQL Server 2005","body":"<p>I have int datatype  column as No, and want to find those No number which are missing in table.</p>\n\n<p>For example: 1,2,3,7,8,9</p>\n\n<p>Ans = 4,5,6</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql-server","tsql","daterange"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":84,"score":1,"question_id":12962604,"title":"time range and date range in TSQL","body":"<p>I want to write a procedure in TSQL that calculates peak times between given date ranges that splitted to time given.</p>\n\n<pre><code>Start time: 10-02-2012 10:00\nEnd time  : 10-02 2012 11:00\ntime range: every 5 minutes\n</code></pre>\n\n<p>so it will be:</p>\n\n<pre><code>10:00 range 1  -&gt; 5 peak times\n10:05 range 2  -&gt; 11 peak times\n.\n.\n.\n11:00 range 11 -&gt; 7 peak times\n</code></pre>\n\n<p>when time range given 30 min then the code will calculate 2 ranges</p>\n\n<p>Should I use Interval? How can i solve this problem? Any Help?</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","query-optimization"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":13010328,"title":"TSQL Number of reads significantly different after query and stored procedure execution","body":"<p>After query optimization I got results that are ok and I wanted to alter stored procedure, but got much worst results after SP execution, than it was after query execution! </p>\n\n<p>Firstly, I think at number of reads. What can be reason for so different results? </p>\n\n<p>Query is identical like in SP, only difference is that in query I declared parameter, but in SP that was input parameter. Value that is set to parameter is also same. To avoid 'recorded data' first I recompiled SP and after that done DROP and CREATE, but results were also much different.</p>\n\n<p>Query is like this (table and column names are changed because of simplification, and number of columns is reduced):</p>\n\n<pre><code>DECLARE @Var1 varchar(20)    \nSET @Var1 = @Var1 + '%'       \n\nDECLARE @Var2 TIMESTAMP    \nSELECT @Var2 = CONVERT(TIMESTAMP, ID, 0)    \nFROM    \n X_TIMESTAMPS (NOLOCK)    \nWHERE    \n TABLE = 'T1'     \n\n\ndeclare @Var3 varbinary(8)    \nSELECT @Var3 = max(IdTimeStamps)    \nFROM    \n T1 (NOLOCK)     \n\nSELECT o.c1  \n  , o.c2   \n  , o.c3    \n  , v.c4    \n  , v.c5   \n  , p.c6    \n  , p.c7    \n  , va.c8    \n  , isnull(s.c9, '') AS c9    \n  , CASE o.c10    \n     WHEN 1 THEN    \n      0    \n     ELSE    \n      1    \n    END c10   \n  , o.c11    \nFROM    \n T1 o (NOLOCK)    \n JOIN T2 p (NOLOCK)    \n  ON o.c1 = p.c12    \n JOIN T3 i (NOLOCK)    \n  ON (o.c13 = i.c14)    \n JOIN T4 v (NOLOCK)    \n  ON (v.c4 = i.c15)    \n LEFT JOIN T5 s (NOLOCK)    \n  ON (o.c16 = s.c17)    \n JOIN T6 va (NOLOCK)    \n  ON o.c11 = va.c18    \nWHERE    \n o.c1 LIKE @Var1    \n AND o.c2 &gt; @Var2 \n</code></pre>\n\n<p>And procedure is like this:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[SP1] @Var1 varchar(20) ='' \nWITH RECOMPILE  \nAS        \nBEGIN\n\n    PREVIOUS QUERY WITHOUT DECLARATION FOR @Var1\n\nEND\n</code></pre>\n\n<p>TnX in advance!</p>\n\n<p>Nemanja</p>\n"},{"tags":["tsql","select","stored-procedures","like"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":13002656,"title":"Is it possible to use a parameter for LIKE / NOT LIKE","body":"<p>I am attempting to pass parameters for LIKE / NOT LIKE and the % signs to make a dynamic query that runs based on what is passed from the application.  I get an error though as TSQL is confused about the parameter for like/not like as its not Boolean.  Is it possible to do it this way or am I going to have to write multiple if statements to check to see what parameters are being passed.</p>\n\n<pre><code>@fullName varchar(100), @SrchCriteria1 varchar(15), @SrchCriteria2 varchar(15), \n@fullName1 varchar(100), @SrchCriteria3 varchar(15), @SrchCriteria4 varchar(15),\n@fullName2 varchar(100), @SrchCriteria5 varchar(15), @SrchCriteria6 varchar(15),\n@qualifer varchar(10), @qualifer1 varchar(10), @qualifer2 varchar(10)\n\nSELECT d.*\nFROM   defendants_ALL d, #tmpFullname t1, #tmpFullname1 t2, #tmpFullname2 t3\nWHERE  d.combined_name + @qualifer + @SrchCriteria1 + t1.Item + @SrchCriteria2\nand  d.combined_name + @qualifer + @SrchCriteria3 + t2.Item + @SrchCriteria4\nand  d.combined_name + @qualifer + @SrchCriteria5 + t3.Item + @SrchCriteria6\n\nEXEC uspJudgments @qualifier = 'LIKE', @qualifier1 = 'LIKE', @qualifier = 'NOT LIKE', @fullName = 'johns', @fullName1 = 'jim,j.', @SrchCriteria1 = '%', @SrchCriteria2 = '%',  @SrchCriteria3 = '%', @SrchCriteria4 = '%', @fullName2 = 'johnson', @SrchCriteria5 = '%', @SrchCriteria6 = '%'\n</code></pre>\n\n<p>So that should return all combinations of jim johns and j. johns but will not include jim johnson and j. johnson.  I know that is a rare combination but I couldn't think of a better one ATM that is more common. </p>\n\n<p>Dynamic SQL:</p>\n\n<pre><code>DECLARE @Query NVarChar(1024)\nSET @Query = 'SELECT d.* FROM defendants_ALL d, #tmpFullname t1, #tmpFullname1 t2, #tmpFullname2 t3'  +\n'WHERE d.combined_name' + @qualifier + @SrchCriteria1 + 't1.Item' + @SrchCriteria2 +\n' and d.combined_name' + @qualifier + @SrchCriteria3 + 't2.Item' + @SrchCriteria4 +\n' and d.combined_name' + @qualifier + @SrchCriteria5 + 't3.Item' + @SrchCriteria6\n</code></pre>\n"},{"tags":["xml","tsql","xpath"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":13007897,"title":"XPath to select value of XMLNS attribute in T-SQL","body":"<p>I have an XML document that looks like this. It may be that it's invalid (I didn't create it!)</p>\n\n<pre><code>&lt;ns:url xmlns:ns=\"http://www.urlone.com/\" xmlns:news=\"http://www.urltwo.com/\"&gt;\n.. node tree\n&lt;/ns:url&gt;\n</code></pre>\n\n<p>I need to build a T-SQL Query to extract the value of the xmlns:news attribute and update it. This requires XPath. But all the queries I've attempted so far fail with an error similar to:</p>\n\n<blockquote>\n  <p>XPath expression uses unbound namespace prefix xmlns</p>\n</blockquote>\n\n<p>Is is possible to select and update this node given the XML format? If so, how?</p>\n\n<p>Cheers,\nMatt</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","cursor"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":12999239,"title":"Quering current cursor row - without selecting into variables","body":"<p>I'm using a cursor to iterate through dynamic SQL query result set. I'm fully aware that both cursors and dynamic SQL are dubious methods which best be avoided. Please do not address this topics.</p>\n\n<p>I'm fetching entire row in each iteration (and not several columns into corresponding variables). Why? because later on I need to address a dynamically changing column names. But again - that is not the matter on hand.</p>\n\n<p>Is there a way to query the current row? I have failed to do so, so far. For example, this pseudo-code \"supposed\" to do the job (return the <code>ABCD</code> column value for the current row).</p>\n\n<pre><code>SELECT [ABCD] FROM Rows_CURSOR\n</code></pre>\n\n<p>I would appreciate any useful suggestions [just saying \"do not use cursors\" is not a useful comment ;) ].</p>\n\n<p>Thank you in advance.</p>\n"},{"tags":["tsql","multiple","sql-server-2012","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":13009414,"title":"Retrieve information dynamically from multiple CTE","body":"<p>I have multiple CTEs and I want to retrieve some information from a couple of them into next CTE.</p>\n\n<p>So, I have this information from one of the CTEs:</p>\n\n<pre><code>PeriodID  StarDate\n1         2006-01-01\n2         2007-04-25\n3         2008-08-16\n4         2009-12-08\n5         2011-04-017\n</code></pre>\n\n<p>and this from other:</p>\n\n<pre><code>RecordID  Date\n100       2007-04-15\n101       2008-05-21\n102       2008-06-06\n103       2008-07-01\n104       2009-11-12\n</code></pre>\n\n<p>And I need to show in next one:</p>\n\n<pre><code>RecordID  Date        PeriodID\n100       2007-04-15  1\n101       2008-05-21  2\n102       2008-06-06  2\n103       2008-07-01  2\n104       2009-11-12  3\n</code></pre>\n\n<p>I can use some case/when statement to define if date of record is in period 1,2,3,4 or 5 but it some situation I can have different numbers of periods return from the first CTE.</p>\n\n<p>Is there a way to do this in the above context?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":13006091,"title":"I need to combine multiple rows from a subquery into a string separated by a space","body":"<p>I'm creating an image gallery with albums. The gallery owner can first create one or more albums, and then create images to add to those albums. I'm having to use multiple view templates to pull this off. Regardless, here's what is hanging me up. Here is the core of my stored procedure:</p>\n\n<pre><code>DECLARE @MyString VARCHAR(MAX)\n\nSELECT @MyString = ISNULL(@MyString + ' ', ' ') + CAST(AlbumID AS VARCHAR(10)) + ' '\nFROM BD_AlbumGallery\nWHERE ImageID = PROBLEM HERE... Dont know what to do &lt;---\nORDER BY AlbumID\n\nSELECT a.[ImageID]\n      ,a.ImageFile\n      ,a.[ImageTitle]\n      ,a.[ImageCaption]\n      ,a.[Description]\n      ,a.[Active]\n      ,b.[AlbumID]\n      ,b.[ImageID]\n      ,c.[ListingID]\n      ,c.[Active]\n      ,c.[LevelID]\n      ,c.[Title]\n\n      ,@MyString AS AlbumClass\n\nFROM BD_Gallery A\nJOIN BD_AlbumGallery B\nON a.ImageID = b.ImageID\nJOIN BD_Listing C\nON a.ListingID = c.ListingID\nWHERE a.ListingID = @passedListingID\n  AND a.Active = 1\n  AND c.Active = 1\n  AND c.LevelID &gt; 5\n</code></pre>\n\n<p>So the problem is, the data is retrieved within a LI\nand one at a time of course... guess that's the obvious... to display properly in my gallery template.</p>\n\n<p>The only issue I'm having is I need the @MyString AS AlbumClass to be tied to a.ImageID, or b.ImageID, as they are the same.</p>\n\n<p>The reason is, the albums in the template are defined by a class.</p>\n\n<pre><code>&lt;li class=\"12 24 15 17\"&gt;Rest of my code for a single image result&lt;/li&gt;\n</code></pre>\n\n<p>So the AlbumID's being utilized as class names allows me to assign them to the jQuery dropdown category/album list that's in a template right before this one. I was thinking of a SubQuery. Ultimately, I need the results (for other reasons) to display in one result set.</p>\n\n<p>Please help.. Still trying to push my way through the learning curves.</p>\n\n<p>Thanks!</p>\n\n<ul>\n<li>Patrick</li>\n</ul>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":37,"score":-1,"question_id":12989275,"title":"How to refactor sql subquery field in sql?","body":"<p>i want to create a sql query which must select sum subquery also make Alacak-Borc process. But i can not.\nhow to make it (Alacak-Borc As BAKIYE) and how to REFACTOR BELOW CODE? thanks...</p>\n"},{"tags":["sql-server-2008","tsql","query-execution-plans","sql-execution-plan"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":1211,"score":4,"question_id":8460416,"title":"query optimizer operator choice - nested loops vs hash match (or merge)","body":"<p>One of my stored procedures was taking too long execute. Taking a look at query execution plan I was able to locate the operation taking too long. It was a nested loop physical operator that had outer table (65991 rows) and inner table (19223 rows). On the nested loop it showed estimated rows = 1,268,544,993 (multiplying 65991 by 19223) as below:</p>\n\n<p><img src=\"http://i.stack.imgur.com/MfaML.png\" alt=\"enter image description here\"></p>\n\n<p>I read a few articles on physical operators used for joins and got a bit confused whether nested loop or hash match would have been better for this case. From what i could gather:</p>\n\n<p>Hash Match - is used by optimizer when no useful indexes are available, one table is substantially smaller than the other, tables are not sorted on the join columns. Also hash match might indicate more efficient join method (nested loops or merge join) could be used.</p>\n\n<p><strong>Question:</strong> Would hash match be better than nested loops in this scenario?</p>\n\n<p>Thanks </p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":35,"score":2,"question_id":13002049,"title":"What is this TSQL \"..\"","body":"<p>I've googled and looked through the MSDN TSQL Reference but haven't been able to find a definition or explanation on what \"<strong>..</strong>\" means or does.</p>\n\n<p><em><strong>example</em></strong></p>\n\n<pre><code>if OBJECT_ID('tempdb..#temp') is not null\ndrop table #temp\n</code></pre>\n\n<p>Your help in explaining or a referential resource on what \"..\" and how it is used would be great!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":94,"score":1,"question_id":12998801,"title":"SQL Server : multiple rows with same column values except one","body":"<p>I have data like these:</p>\n\n<pre><code>name_text   ----------c_num---d_type-----unique_id----------------------v_text--r_ticket_id\n29311875_FAD_V100.doc 3560709 Contract 21DABDDF49BA41289F1905D1D6B79ABF 2,01    28600206\n29311875_FAD_V100.doc 3560709 Contract 21DABDDF49BA41289F1905D1D6B79ABF 2,01    28600240\nCopy.docx             3560715 Guide    9D06F8EFF4EC4A2D862F5A0DB3BA357B 2       28600219\n</code></pre>\n\n<p>I want to select just one row which has the bigger value of <code>r_ticket_id</code> column, if <code>name_text</code>, <code>c_num</code>, <code>d_type</code>, <code>unique_id</code>, <code>v_text</code> columns values are equal. </p>\n\n<p>In these case, with select statement just this columns should be fetched.</p>\n\n<pre><code>name_text   ----------c_num---d_type-----unique_id----------------------v_text--r_ticket_id\n29311875_FAD_V100.doc 3560709 Contract 21DABDDF49BA41289F1905D1D6B79ABF 2,01    28600240\nCopy.docx             3560715 Guide    9D06F8EFF4EC4A2D862F5A0DB3BA357B 2       28600219\n</code></pre>\n\n<p>What is the exact SQL query that will do this job?</p>\n"},{"tags":["tsql","sql-server-2008","sorting"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":343,"score":2,"question_id":5417735,"title":"Topological sorting in sql","body":"<p>I am resolving dependency between some objects in a table.\nI have to do something with objects in order their dependency.\nFor example, the first object doesn't depend on any object. The second and third ones depends on first one and so on. I have to use  <a href=\"http://en.wikipedia.org/wiki/Topological_sorting\" rel=\"nofollow\">topological sorting</a>.\nCould someone show the sample of implementation so sorting in t-sql.\nI have a table:</p>\n\n<pre><code>create table dependency\n(\n  DependencyId PK\n  ,ObjectId\n  ,ObjectName\n  ,DependsOnObjectId\n)\n</code></pre>\n\n<p>I want to get</p>\n\n<p>ObjectId\nObjectName\nSortOrder</p>\n\n<p>Thank you.</p>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":493,"score":0,"question_id":3627886,"title":"Can you give me Alternative to Group By sql server 2008","body":"<p>I have a situation where I have a Select with 6 fields but I only want to group by 3 fields.\nAs you know this looks not possible.\nWhat do you do in these situations?</p>\n\n<p>Thanks for any feedback</p>\n"},{"tags":["sql-server-2008","tsql","table-valued-parameters"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":295,"score":2,"question_id":8022682,"title":"How can I use a Table-Valued Parameter to insert multiple rows and then return their IDs?","body":"<p>In my application, I have a large of number (100+) of rows that I need to insert into the database.  Once they get inserted into the database, I need to insert their children, which have a foreign key reference back to the children.</p>\n\n<p>I'm wondering if there's a way to write a stored procedure that can insert all of those rows and return their IDs back to my application?</p>\n"},{"tags":["sql","tsql","sql-server-2008","combinatorics"],"answer_count":4,"favorite_count":5,"up_vote_count":8,"down_vote_count":0,"view_count":1919,"score":8,"question_id":3686062,"title":"Generate all combinations in SQL","body":"<p>I need to generate all combinations of size <code>@k</code> in a given set of size <code>@n</code>. Can someone please review the following SQL and determine first if the following logic is returning the expected results, and second if is there a better way?</p>\n\n<pre><code>/*CREATE FUNCTION dbo.Factorial ( @x int ) \nRETURNS int \nAS\nBEGIN\n    DECLARE @value int\n\n    IF @x &amp;lt;= 1\n        SET @value = 1\n    ELSE\n        SET @value = @x * dbo.Factorial( @x - 1 )\n\n    RETURN @value\nEND\nGO*/\nSET NOCOUNT ON;\nDECLARE @k int = 5, @n int;\nDECLARE @set table ( [value] varchar(24) );\nDECLARE @com table ( [index] int );\n\nINSERT @set VALUES ('1'),('2'),('3'),('4'),('5'),('6');\n\nSELECT @n = COUNT(*) FROM @set;\n\nDECLARE @combinations int = dbo.Factorial(@n) / (dbo.Factorial(@k) * dbo.Factorial(@n - @k));\n\nPRINT CAST(@combinations as varchar(max)) + ' combinations';\n\nDECLARE @index int = 1;\n\nWHILE @index &amp;lt;= @combinations\nBEGIN\n    INSERT @com VALUES (@index)\n    SET @index = @index + 1\nEND;\n\nWITH [set] as (\n    SELECT \n        [value], \n        ROW_NUMBER() OVER ( ORDER BY [value] ) as [index]\n    FROM @set\n)\nSELECT \n    [values].[value], \n    [index].[index] as [combination]\nFROM [set] [values]\nCROSS JOIN @com [index]\nWHERE ([index].[index] + [values].[index] - 1) % (@n) BETWEEN 1 AND @k\nORDER BY\n    [index].[index];\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":45,"score":0,"question_id":12994735,"title":"add series (row?) number to end of existing column data","body":"<p>I have a large table with a column that contains the same string data \"Dummy\".\nI need to add a sequential count to the end of that string to make it unique.  IE:</p>\n\n<pre><code>Dummy1\nDummy2\nDummy3 \n</code></pre>\n\n<p>For the life of me I cannot get this right.  I do not want a new column, and I do not want a new table.</p>\n"},{"tags":["sql","sql-server","database","tsql","exception-handling"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3387,"score":1,"question_id":2481273,"title":"how to rethrow same exception in sql server","body":"<p>I want to rethrow same exception in sql server that has been occured in my try block. \nI am able to throw same message but i want to throw same error.</p>\n\n<pre><code>BEGIN TRANSACTION\n    BEGIN TRY\n            INSERT INTO Tags.tblDomain \n            (DomainName, SubDomainId, DomainCode, Description)\n            VALUES(@DomainName, @SubDomainId, @DomainCode, @Description)\n            COMMIT TRANSACTION\n    END TRY\n\n    BEGIN CATCH\n            declare @severity int; \n            declare @state int;\n\n            select @severity=error_severity(), @state=error_state();\n\n            RAISERROR(@@Error,@ErrorSeverity,@state);\n            ROLLBACK TRANSACTION\n    END CATCH\n</code></pre>\n\n<blockquote>\n  <p><code>RAISERROR(@@Error, @ErrorSeverity, @state);</code></p>\n</blockquote>\n\n<p>This line will show error, but i want functionality something like that.\nThis raises error with error number 50000, but i want erron number to be thrown that i am passing <code>@@error</code>, </p>\n\n<p>I want to capture this error no at frontend</p>\n\n<p>i.e. </p>\n\n<pre><code>catch (SqlException ex)\n{\nif ex.number==2627\nMessageBox.show(\"Duplicate value cannot be inserted\");\n}\n</code></pre>\n\n<p>I want this functionality. which can't be achieved using raiseerror. I dont want to give custom error message at back end.</p>\n\n<p>RAISEERROR should return below mentioned error when i pass ErrorNo to be thrown in catch</p>\n\n<blockquote>\n<pre><code>Msg 2627, Level 14, State 1, Procedure spOTest_DomainInsert,\n</code></pre>\n  \n  <p>Line 14\n      Violation of UNIQUE KEY constraint 'UK_DomainCode'. Cannot insert\n  duplicate key in object\n  'Tags.tblDomain'.\n      The statement has been terminated.</p>\n</blockquote>\n\n<p><strong>EDIT:</strong></p>\n\n<p>What can be the drawback of not using try catch block if i want exception to be handled at frontend considering stored procedure contains multiple queries that need to be executed</p>\n"},{"tags":["sql-server","tsql","transactions","rollback"],"answer_count":4,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":2210,"score":4,"question_id":3997271,"title":"SQL Server 2008 Transaction, rollback required?","body":"<p>I have a stored procedure that has a <code>BEGIN TRANSACTION</code> and <code>COMMIT TRANSACTION</code> statement. Within the transaction is a select query <code>WITH(XLOCK, ROWLOCK)</code>. </p>\n\n<p>The transaction can potentially fail due to some calculations that cause an arithmetic overflow error if out of bounds values are supplied. This error would happen before any insert/update statements.</p>\n\n<p>My question is, should I wrap the transaction in a TRY/CATCH and rollback or is this not really required and all locks would be released automatically if the transaction fails? My only concern here is that SQL would not release all locks of the transaction in case the transaction fails.</p>\n\n<p>Thanks,</p>\n\n<p>Tom</p>\n"},{"tags":["sql","sql-server","tsql","case"],"answer_count":5,"favorite_count":0,"up_vote_count":13,"down_vote_count":0,"view_count":36923,"score":13,"question_id":5487892,"title":"SQL Server: CASE WHEN OR THEN ELSE END => the OR is not supported","body":"<p>The OR in the WHEN part of a CASE statement is not supported, how to solve?</p>\n\n<pre><code>CASE ebv.db_no \n  WHEN 22978 OR 23218 OR 23219 THEN 'WECS 9500' \n  ELSE 'WECS 9520' \nEND as wecs_system \n</code></pre>\n"}]}
{"total":16599,"page":6,"pagesize":100,"questions":[{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12992373,"title":"Change the value of one column based on the value of another column","body":"<p>Lets say i have a table like so...</p>\n\n<pre><code>ITEM#     ItemType     SIZE\n1         Car          5.20\n2         Watch        2.00\n3         Watch        7.50\n4         Watch        6.40\n5         Car          5.00\n6         Car          4.30\n</code></pre>\n\n<p>I would like to select all rows but whenever the ItemType = 'Car' I would like the value for SIZE to be returned as null.</p>\n\n<p>I have tried using</p>\n\n<pre><code>CASE When ItemType = 'Car'\nThen SIZE = null\nEND\n</code></pre>\n\n<p>but this does not work.</p>\n\n<p>Many thanks!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12990727,"title":"SQL Server same query, same data, copy of same database but different behaviour","body":"<p>I am puzzled and would appreciate some help fixing this issue. I have a local install of SQL Server 2008 Standard and an install of SQL Server 2008 Express on another machine. Both machines are Windows 7 machines and I believe 64bit. </p>\n\n<p>Weird thing I have noticed is that my queries don't seem to work the very same way on both machines. One one machine, a particular script could display 10 lines of data for output but the other database (on another machine) would display as much as 20 rows for the same script, same data, and same database tables/objects. </p>\n\n<p>How to explain this and what to do to ensure consistency across machines please? </p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":286,"score":2,"question_id":3343756,"title":"UPDATE column from another column two tables away","body":"<p>Not that good with SQL yet but I'm learning.</p>\n\n<p>So I have 3 tables:</p>\n\n<p>tblOne(Id, Type)\ntblTemp1(Name, Type)\ntblTemp2(Id, Name)</p>\n\n<p>Basically, I want to update tblOne where the where it's 'Id' matches from tblTemp2, but than that also goes and grabs its 'Type' from tblTemp1 where the 'Name' matches.</p>\n\n<p>Can anyone help?</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","calculated-columns"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":78,"score":1,"question_id":12982418,"title":"How can I roll up rate-of-return into net asset value in SQL?","body":"<p>Given the starting value <code>@pStartingValue</code> and a table which contains <code>rorDate</code> and <code>ror</code> what is the most efficient way to get the NAV at each date using just TSQL?</p>\n\n<p>This mathematically trivial, and simple in code. I have a naive SQL implementation currently that relies on cursors.</p>\n\n<p>On the first date, the NAV is @pStartingValue * ror<br>\nOn every subsequent date, it's the previously calculated nav * ror <strong>or</strong> it's @pStartingValue * every previous ror</p>\n\n<p>How would you efficiently do this only in MSSQL2005+?</p>\n\n<pre><code>DECLARE @rorDate DATE\nDECLARE @getDate CURSOR\nDECLARE @lastNAV as DECIMAL(19,7)\nDECLARE @datedRoR as float\nDECLARE @NAVTotals TABLE\n(\n  NAV DECIMAL(19,7),\n  navDate DATE\n)\n\n\nSET @lastNAV = 100\n\nSET @getDate = CURSOR FOR\n    SELECT \n        p.[DATE]\n    FROM \n        performance p \n    ORDER BY \n        p.[DATE]\n\nOPEN @getDate\nFETCH NEXT\nFROM @getDate INTO @rorDate\nWHILE @@FETCH_STATUS = 0\nBEGIN\n\nSELECT \n    @datedRoR = b.finalNetReturn \nFROM \n    performance b \nWHERE \n    b.date = @rorDate\n\nINSERT INTO @NAVTotals (NAV, navDate)\n  VALUES (@lastNAV * (1 + @datedRoR), @rorDate)\n\nSELECT \n    @lastNAV = c.NAV \nFROM \n    @NAVTotals c \nWHERE \n    c.navDate = @rorDate  \n\n\nFETCH NEXT\nFROM @getDate INTO @rorDate\nEND\nCLOSE @getDate\nDEALLOCATE @getDate\n\nselect * from @NAVTotals\n</code></pre>\n"},{"tags":["c#","sql-server","entity-framework","tsql","linq-to-entities"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":69,"score":0,"question_id":12990538,"title":"How to convert this SQL query to LINQ to Entities query?","body":"<p>I need help to convert a SQL query to entity query in my C# code.\nThe query combines 4 different tables together which is as follows:</p>\n\n<pre><code>SELECT a.email,\n       a.status,\n       a.createdat,\n       b.unitprice,\n       c.name,\n       d.name,\n       e.name \nFROM Orders a, \n     Orderdetails b, \n     ServiceOptions c, \n     services d, \n     merchants e \nWHERE a.id=b.orderid AND c.id=b.serviceoptionid\n      AND c.serviceid=d.id AND d.merchantid=e.id\n</code></pre>\n"},{"tags":["sql-server","tsql","vbscript","ssms","adodb"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12979025,"title":"SSMS is fast than Provider=SQLNCLI.1","body":"<p>I am using SQL native client in VB script to execute a query.<br>\nConnection string is   </p>\n\n<pre><code>ConCI.Open(\"Provider=SQLNCLI.1;Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=\" &amp; CIDBName &amp; \";Data Source=\" &amp; CIServerName)\n</code></pre>\n\n<p>Query is   </p>\n\n<pre><code>SELECT COUNT(*) \nFROM statementheader WITH (nolock)\nWHERE statementdate &gt;=\n(\n    SELECT procdayend-1 \n    FROM\n    ARSystemAccounts\n) \nAND currentbalance &lt;= 0 \nAND dateoftotaldue IS NOT NULL\nAND systemstatus &lt;&gt; 14\n</code></pre>\n\n<p>SSMS takes 50 to 60 seconds to execute this query but VB script takes ages.<br>\nWhy is it so  and what should I do ?</p>\n"},{"tags":["sql","tsql","ssis","business-intelligence"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":4498,"score":1,"question_id":844029,"title":"How do I strip the date off of a datetime string in SQL SSIS?","body":"<p>I'm working on a data warehouse project and would like to know how to (preferably in a Derived Column component in a Data flow) strip the date piece off of a SQL datetime record.</p>\n\n<p>Once I have the datetime converted to just a time I am going to do a lookup on the time to find the related time record in a time dimension table.</p>\n\n<p>Can someone give me a simple function to accomplish this inside a derived column transform?</p>\n\n<p>Example: Transform a datetime such as \"12/02/2008 11:32:21 AM\" into simply \"11:32:21 AM\".</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":3006,"score":3,"question_id":1445125,"title":"How to create Linked Server with non-default port","body":"<p>I want to create a Linked Server in MS SQL Server 2000 to a MS SQL 2005 Server which runs on port x (not the default port 1433). But it doesn't work, as I can't specify the port anywhere!?</p>\n\n<p>Using sqlcmd (specifying port x), I can connect to the server without problems - but I can't set it up as a Linked Server.</p>\n\n<p>How can this be done?</p>\n"},{"tags":["sql","sql-server-2005","tsql","bulkinsert"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":871,"score":1,"question_id":4436021,"title":"Additional characters are coming during bulk insert","body":"<p>I am trying to bulk insert the first row from a csv file into a table with only one column.\nBut I am getting some extra characters('n++') in the begining like this:</p>\n\n<pre><code>n++First Column;Second Column;Third Column;Fourth Column;Fifth Columnm;Sixth Column\n</code></pre>\n\n<p>CSV file contents are like:</p>\n\n<pre><code>First Column;Second Column;Third Column;Fourth Column;Fifth Columnm;Sixth Column\n</code></pre>\n\n<p>You can find the test.csv file <a href=\"http://www.filefactory.com/file/b4ah0h3/n/test.csv/\" rel=\"nofollow\" title=\"here\">here</a></p>\n\n<p>And this is the code I am using to get the first row data in a table</p>\n\n<pre><code>declare @importSQL nvarchar(2000)\ndeclare @tempstr varchar(max)\ndeclare @path varchar(100)  \n\nSET @path = 'D:\\test.csv'    \n\nCREATE TABLE #tbl (line VARCHAR(max))\n\nSET @importSQL = \n'BULK INSERT #tbl \nFROM ''' + @path + ''' \nWITH ( \nLASTROW = 1,\nFIELDTERMINATOR = ''\\n'',\nROWTERMINATOR = ''\\n''\n)' \n\nEXEC sp_executesql @stmt=@importSQL \n\nSET @tempstr = (SELECT TOP 1 RTRIM(REPLACE(Line, CHAR(9), ';')) FROM #tbl)\n\nprint @tempstr\ndrop table #tbl\n</code></pre>\n\n<p>Any idea where this extra 'n++' is coming from?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":32,"score":1,"question_id":12985524,"title":"Merge two database table partitions by their partition number","body":"<p>I have created four partitions in SQL Server using the following functions.</p>\n\n<pre><code>CREATE PARTITION FUNCTION fnYearsRT(DateTime)\nAS RANGE RIGHT FOR VALUES\n('01/01/2005', '01/01/2006', '01/01/2007', '01/01/2008');\n\nCREATE PARTITION SCHEME date_partscheme\n AS PARTITION fnYearsRT\n TO (Filegroup1, Filegroup2, Filegroup3, Filegroup4,Filegroup5)\n\nCREATE TABLE Sales.ReturnsArchive\n  (\n     ReturnID  int  IDENTITY NOT NULL, \n     ProductID  int  NOT NULL, \n     CustomerID  int  NOT NULL, \n     ReturnDate  datetime  NOT NULL,  \n     ReturnReason  char(20)  NULL  \n  ) \n ON date_partscheme (ReturnDate)\n</code></pre>\n\n<p>After inserting data I have the following stats</p>\n\n<pre><code>Partition   COUNT\n2       5151\n3       19353\n4       51237\n5       45576\n</code></pre>\n\n<p>I want to merge partition 2 and 3 but I am unable to decide which range I should give in merge function. </p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","like-keyword"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":23635,"score":3,"question_id":4855754,"title":"How to use like condition with multiple values in sql server 2005?","body":"<p>I need to filter out records based on some text matching in nvarchar(1000) column.\nTable has more than 400 thousands records and growing. For now, I am using Like condition:-</p>\n\n<pre><code>SELECT \n    *\nFROM\n    table_01\nWHERE\n    Text like '%A1%'\n    OR Text like '%B1%'\n    OR Text like '%C1%'\n    OR Text like '%D1%'\n</code></pre>\n\n<p>Is there any preferred work around? </p>\n"},{"tags":["sql","sql-server","xml","query","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":1,"view_count":83,"score":0,"question_id":12985491,"title":"SQL Server Query for getting column names of all tables as XML","body":"<p>In my database, I intend to get the - [TableName] as the first column and all columns of that table in a \", \" (comma followed by space - delimiter...as the second column--for all tables in the DB.</p>\n\n<pre><code>Table A | ColumnA1, ColumnA2, ColumnA3  \nTable B | ColumnB1, ColumnB2, ColumnB3\n......................................\n</code></pre>\n\n<p>And retrieve it as an XML</p>\n\n<pre><code>&lt;TableList&gt;  \n&lt;TableName&gt;TableA&lt;/TableName&gt; &lt;Columns&gt; ColumnA1, ColumnA2, ColumnA3&lt;/Columns&gt;  \n&lt;TableName&gt;TableB&lt;/TableName&gt; &lt;Columns&gt; ColumnB1, ColumnB2, ColumnB3&lt;/Columns&gt;  \n&lt;/TableList&gt;\n</code></pre>\n\n<p>How should the SQL Query be written?</p>\n"},{"tags":["sql","sql-server","tsql","foreign-keys"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":69,"score":2,"question_id":12981768,"title":"how to update table with foreign key","body":"<p>Actually I have two databases, one is for staging one is in production.\none table, for example called Class(class_id,descr,faculty_id) and the faculty_id reference to another table called Faculty(faculty_id, name,comment).</p>\n\n<p>my story is that i do so much updates on the staging database, Faculty table, change lots of faculty comment and name without changing Class table. I want to copy the staging Faculty table to Production. My original way is to generate script from staging and delete the data table, Faculty in production and run the script in order to copy the staging data table Faculty to production. However i found i cannot delete the Faculty table because the foreign key. but i do not want to write down hundreds of update statement, and also cannot delete the Class data in production, how can i do if i want to copy  the Faculty table to production?</p>\n"},{"tags":["sql","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":663,"score":1,"question_id":4805264,"title":"Like clause and sql injection","body":"<p>I am having a doubt about this situation.</p>\n\n<p>I've a query like this within a Stored Procedure:</p>\n\n<pre><code>SELECT column1, column2\nFROM table1\nWHERE column1 like '%' + @column1 + '%'\n</code></pre>\n\n<p>My question is, this is vulnerable to SQL Injection? Do I need to change this to something like this: (?)</p>\n\n<pre><code>declare @column1Like nvarchar(200);\n\n@column1Like = '%' + @column1 + '%'\n\nSELECT column1, column2\nFROM table1\nWHERE column1 like @column1Like\n</code></pre>\n\n<p>Regards</p>\n"},{"tags":["tsql","select","like-operator"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":12981945,"title":"Step through 2 temp tables compare to table","body":"<p>I have a SP that is supposed to compare 2 temp tables generated from a function to another table.  My issue is that instead of stepping through each temp table it goes through both at the same time.  I am not sure how to write the code to step through each table one at a time to get the desired results.</p>\n\n<pre><code>    DROP PROCEDURE uspJudgments;\nGO\nCREATE PROCEDURE uspJudgments \n@fullName varchar(100), @fullName1 varchar(100)\nAS\nBEGIN\n\nSELECT *\nINTO #tmpFullname\nFROM dbo.DelimitedSplit8K(@fullName, ',')\n\nSELECT *\nINTO #tmpFullname1\nFROM dbo.DelimitedSplit8K(@fullName1, ',')\n\nSELECT *\nFROM #tmpFullName\n\nSELECT *\nFROM #tmpFullName1\n\nDECLARE @MaxRownum int\nSET @MaxRownum = (SELECT MAX(ItemNumber) FROM #tmpFullname)\n\nDECLARE @Iter int\nSET @Iter = (SELECT MIN(ItemNumber) FROM #tmpFullname)\n\nDECLARE @MaxRownum1 int\nSET @MaxRownum1 = (SELECT MAX(ItemNumber) FROM #tmpFullname1)\n\nDECLARE @Iter1 int\nSET @Iter1 = (SELECT MIN(ItemNumber) FROM #tmpFullname1)\n\nDECLARE @Name varchar(25)\nDECLARE @Name1 varchar(25)\n\n\nWHILE @Iter &lt;= @MaxRownum AND @iter1 &lt;= @Maxrownum1\n\nBEGIN\n\n    SET @Name = (SELECT Item FROM #tmpFullname WHERE ItemNumber = @Iter)   \n    SET @Name1 = (SELECT Item FROM #tmpFullname1 WHERE ItemNumber = @Iter1)   \n    SELECT *\n    --INTO #tmpDefSelect\n    FROM defendants_ALL \n    WHERE combined_name LIKE '%' + @Name + '%' AND combined_name LIKE '%' + @Name1 + '%';\n\n    SET @Iter = @Iter + 1\n    SET @Iter1 = @Iter1 + 1\nEND\n\nEND\n\n\nDROP TABLE #tmpFullname\nDROP TABLE #tmpFullname1\n\nEXEC uspJudgments @fullName = 'grein,smit', @fullName1 = 'joh,jon,j.'\n</code></pre>\n\n<p>I need to get ALL results for grein -- joh, jon, j. AND smit, joh, jon, j.</p>\n\n<p>Currently the above code only returns grein joh AND smit, jon..  In our database that returns no results for the first combination and 38 results for jonathon smith and jon smith.  How do I properly step through each temp table to get the desired results?</p>\n"},{"tags":["sql","sql-server-2005","tsql","duplicate-removal"],"answer_count":13,"favorite_count":8,"up_vote_count":9,"down_vote_count":0,"view_count":25043,"score":9,"question_id":985384,"title":"Delete duplicate records from a SQL table without a primary key","body":"<p>I have the below table with the below records in it</p>\n\n<pre><code>create table employee\n(\n EmpId number,\n EmpName varchar2(10),\n EmpSSN varchar2(11)\n);\n\ninsert into employee values(1, 'Jack', '555-55-5555');\ninsert into employee values (2, 'Joe', '555-56-5555');\ninsert into employee values (3, 'Fred', '555-57-5555');\ninsert into employee values (4, 'Mike', '555-58-5555');\ninsert into employee values (5, 'Cathy', '555-59-5555');\ninsert into employee values (6, 'Lisa', '555-70-5555');\ninsert into employee values (1, 'Jack', '555-55-5555');\ninsert into employee values (4, 'Mike', '555-58-5555');\ninsert into employee values (5, 'Cathy', '555-59-5555');\ninsert into employee values (6 ,'Lisa', '555-70-5555');\ninsert into employee values (5, 'Cathy', '555-59-5555');\ninsert into employee values (6, 'Lisa', '555-70-5555');\n</code></pre>\n\n<p>I dont have any primary key in this table .But i have the above records in my table already.\nI want to remove the duplicate records which has the same value in EmpId and EmpSSN fields.</p>\n\n<p>Ex : Emp id 5 </p>\n\n<p>Can any one help me to frame a query to delete those duplicate records</p>\n\n<p>Thanks in advance</p>\n"},{"tags":["sql","tsql","query","sql-server-2000"],"answer_count":14,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":24301,"score":7,"question_id":982932,"title":"SQL query to return one single record for each unique value in a column","body":"<p>I have a table in SQL Server 2000 that I am trying to query in a specific way.  The best way to show this is with example data.</p>\n\n<p>Behold, <code>[Addresses]</code>:</p>\n\n<pre><code>Name         Street                 City          State\n--------------------------------------------------------\nBob          123 Fake Street        Peoria        IL\nBob          234 Other Street       Fargo         ND\nJim          345 Main Street        St Louis      MO\n</code></pre>\n\n<p>This is actually a simplified example of the structure of the actual table.  The structure of the table is completely beyond my control.  I need a query that will return a single address per name.  It doesn't matter which address, just that there is only one.  The result could be this:</p>\n\n<pre><code>Name         Street                 City          State\n--------------------------------------------------------\nBob          123 Fake Street        Peoria        IL\nJim          345 Main Street        St Louis      MO\n</code></pre>\n\n<p>I found a similar question <a href=\"http://stackoverflow.com/questions/715804/query-to-return-1-instance-of-a-record-with-duplicates\">here</a>, but none of the solutions given work in my case because I do not have access to <code>CROSS APPLY</code>, and calling <code>MIN()</code> on each column will mix different addresses together, and although I don't care which record is returned, it must be one intact row, not a mix of different rows.</p>\n\n<p>Recommendations to change the table structure will not help me.  I agree that this table is terrible, (it's worse than shown here) but this is part of a major ERP database that I can not change.</p>\n\n<p>There are about 3000 records in this table.  There is no primary key.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["tsql","group"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":12983394,"title":"Make a column values header for rest of columns using TSQL","body":"<p>I have following table</p>\n\n<pre><code>ID | Group      | Type         | Product\n1    Dairy         Milk           Fresh Milk\n2    Dairy         Butter         Butter Cream\n3    Beverage      Coke           Coca cola\n4    Beverage      Diet           Dew\n5    Beverage      Juice          Fresh Juice\n</code></pre>\n\n<p>I need following output/query result:</p>\n\n<pre><code>ID | Group      | Type         | Product\n1    Dairy             \n1                 Milk           Fresh Milk\n2                 Butter         Butter Cream\n2    Beverage      \n1                Coke            Coca cola\n2                Diet            Dew\n3                Juice           Fresh Juice\n</code></pre>\n\n<p>For above sample a hard coded script can do the job but I look for a dynamic script for any number of groups. I do not have any idea how it can be done so, I do not have a sample query yet. I need ideas, examples that at least give me an idea. PIVOT looks a close option but does not looks to be fully fit for this case.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","sql-server-2008"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":896,"score":2,"question_id":7475845,"title":"Getting Number of weeks in a Month from a Datetime Column","body":"<p>I have a table called FcData and the data looks like:</p>\n\n<pre><code>Op_Date\n\n2011-02-14 11:53:40.000\n2011-02-17 16:02:19.000\n2010-02-14 12:53:40.000\n2010-02-17 14:02:19.000\n</code></pre>\n\n<p>I am looking to get the Number of weeks in That Month from Op_Date. So I am looking for output like:</p>\n\n<pre><code> Op_Date                       Number of Weeks\n\n    2011-02-14 11:53:40.000       5   \n    2011-02-17 16:02:19.000       5\n    2010-02-14 12:53:40.000       5\n    2010-02-17 14:02:19.000       5\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":85,"score":6,"question_id":12979095,"title":"joining a pivot with another complex table","body":"<p>my pivot query generates:</p>\n\n<pre><code>+-----------+----+----+---+---+---+---+---+\n| client_id | 1  | 2  | 3 | 4 | 5 | 6 | 7 |\n+-----------+----+----+---+---+---+---+---+\n|    216436 |  9 |  0 | 0 | 0 | 0 | 0 | 0 |\n|    110522 | 76 |  3 | 0 | 0 | 0 | 0 | 0 |\n|    214981 |  0 |  1 | 0 | 0 | 0 | 0 | 0 |\n|    216360 | 52 |  1 | 0 | 0 | 0 | 0 | 0 |\n|    102574 |  1 |  0 | 0 | 0 | 0 | 0 | 0 |\n|    211754 | 97 | 14 | 2 | 0 | 0 | 0 | 0 |\n|    210734 |  8 |  4 | 0 | 0 | 0 | 0 | 0 |\n|    100123 |  1 |  0 | 0 | 0 | 0 | 0 | 0 |\n|    101840 |  2 |  0 | 0 | 0 | 0 | 0 | 0 |\n+-----------+----+----+---+---+---+---+---+\n</code></pre>\n\n<p>here's the query:</p>\n\n<pre><code>   select client_id,\n   [1],[2],[3],[4],[5],[6],[7] -- these are timestested (the amount of times tested)\n   from\n   (   SELECT DISTINCT CLIENT_ID\n   , PATIENT_ID\n   , count(*) over (partition by client_id, patient_id) AS patientcount\n\n   from f_accession_daily) as SourceTable\n   PIVOT\n   (\n   count(patient_id)\n   for patientcount in ([1],[2],[3],[4],[5],[6],[7])\n   ) as pivottable\n</code></pre>\n\n<p><strong>I need to bring the max/min dates for every time tested, (for [1], [2], [3], etc)</strong> from this table:</p>\n\n<pre><code>+-----------+-------------+-------+------------+------------+\n| client_id | TimesTested | count | maxRecDate | minRecDate |\n+-----------+-------------+-------+------------+------------+\n|    100034 |           2 |     1 | 6/25/2008  | 6/23/2008  |\n|    100034 |           1 |    20 | 6/30/2008  | 6/19/2008  |\n|    100038 |           3 |     1 | 7/25/2008  | 7/23/2008  |\n|    100038 |           1 |     4 | 7/25/2008  | 7/1/2008   |\n|    100050 |           1 |    15 | 8/11/2008  | 7/14/2008  |\n|    100060 |           1 |     2 | 8/12/2008  | 7/29/2008  |\n|    100070 |           1 |     3 | 8/15/2008  | 8/15/2008  |\n|    100049 |           1 |     3 | 8/22/2008  | 7/11/2008  |\n|    100029 |           3 |     2 | 8/25/2008  | 6/18/2008  |\n+-----------+-------------+-------+------------+------------+\n</code></pre>\n\n<p>the above table is generated by:</p>\n\n<pre><code>SELECT a.client_id AS client_id\n,a.patientcount TimesTested\n   , count(a.patientcount)/a.patientcount AS count\n   , max(f.received_date) AS maxRecDate\n   , min(f.received_date) AS minRecDate\nFROM\n(\n   SELECT DISTINCT CLIENT_ID\n   , PATIENT_ID\n   , count(*) over (partition by client_id, patient_id) AS patientcount\n\n   from f_accession_daily\n\n) AS a\nJOIN F_ACCESSION_DAILY AS f ON a.CLIENT_ID = f.CLIENT_ID\n   AND a.PATIENT_ID = f.PATIENT_ID\n\nGROUP BY a.CLIENT_ID, a.patientcount\n</code></pre>\n\n<p><strong>the resulting table that i need to get:</strong></p>\n\n<pre><code>+-----------+----+----------+-----------+----+----------+-----------+---+----------+-----------+---+----------+-----------+-----+\n| client_id | 1  | maxdate1 | mindate1  | 2  | maxdate2 | mindate2  | 3 | maxdate3 | mindate3  | 4 | maxdate4 | mindate4  |  5  |\n+-----------+----+----------+-----------+----+----------+-----------+---+----------+-----------+---+----------+-----------+-----+\n|    216436 |  9 | 1/1/2011 | 1/23/1985 |  0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 | etc |\n|    110522 | 76 | 1/1/2011 | 1/23/1984 |  3 | 1/1/2011 | 1/23/1984 | 0 | 1/1/2011 | 1/23/1984 | 0 | 2/1/2011 | 1/23/1984 |     |\n|    214981 |  0 | 1/1/2013 | 1/23/1985 |  1 | 1/1/2013 | 1/23/1985 | 0 | 1/1/2013 | 1/23/1985 | 0 | 1/1/2013 | 1/23/1985 |     |\n|    216360 | 52 | 1/1/2011 | 1/23/1985 |  1 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 |     |\n|    102574 |  1 | 1/1/2011 | 1/23/1985 |  0 | 1/1/2014 | 1/23/1980 | 0 | 2/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 |     |\n|    211754 | 97 | 1/1/2012 | 1/23/1985 | 14 | 1/1/2012 | 1/23/1985 | 2 | 1/1/2012 | 1/23/1985 | 0 | 1/1/2012 | 1/23/1985 |     |\n|    210734 |  8 | 1/1/2011 | 1/23/1984 |  4 | 1/1/2011 | 1/23/1984 | 0 | 1/1/2011 | 1/23/1984 | 0 | 1/1/2011 | 1/23/1984 |     |\n|    100123 |  1 | 1/1/2011 | 1/23/1985 |  0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1987 |     |\n|    101840 |  2 | 1/1/2011 | 1/23/1985 |  0 | 1/1/2011 | 1/23/1980 | 0 | 1/1/2011 | 1/23/1985 | 0 | 1/1/2011 | 1/23/1985 |     |\n+-----------+----+----------+-----------+----+----------+-----------+---+----------+-----------+---+----------+-----------+-----+\n</code></pre>\n\n<p><strong>how do i join the two tables? the speed does not matter! thank you very much for your kind help.</strong></p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","sql-server-2008"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":217,"score":0,"question_id":7711336,"title":"SQL Server Rounding Issue","body":"<p>I'm using SQL Server 2005. And I'm using ROUND T-SQL function to round a decimal column value. But it seems that the rounded value is incorrect.</p>\n\n<pre><code>    PRINT ROUND(1890.124854, 2) =&gt; 1890.120000\n</code></pre>\n\n<p>As shown the ROUND function is returning 1890.12 where as it should be 1890.13. Does anyone encountered this and what should be the correct way of rounding so that I get the expected value 1890.13..?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12982277,"title":"condensing a dataset on nulls","body":"<p>My query returns a table that looks like this (please note that I am posting a very simplified version of the output):</p>\n\n<pre><code>+-------+------+------+------+------+\n|       |  1   |  2   |  3   |  4   |\n+-------+------+------+------+------+\n| 14234 | 3    | null | null | null |\n| 14234 | null | null | 32   | null |\n| 33334 | 4    | null | null | 5    |\n| 33334 | null | 3    | null | null |\n+-------+------+------+------+------+\n</code></pre>\n\n<p>and i would like to reformat it to look like this:</p>\n\n<pre><code>+-------+---+------+------+------+\n|       | 1 |  2   |  3   |  4   |\n+-------+---+------+------+------+\n| 14234 | 3 | null | 32   | null |\n| 33334 | 4 | 3    | null | 5    |\n+-------+---+------+------+------+\n</code></pre>\n\n<p>as you can see the rows have been put together (condensed), i don't know what the right terminology would be. </p>\n\n<p>is there a quick way to do this with sql server?</p>\n\n<p>here's the original query:</p>\n\n<pre><code>;WITH \nPivotQuery as (\n    select client_id,\n       [1],[2],[3],[4],[5],[6],[7]\n       from\n       (   SELECT DISTINCT CLIENT_ID\n       , PATIENT_ID\n       , count(*) over (partition by client_id, patient_id) AS patientcount\n\n       from f_accession_daily) as SourceTable\n       PIVOT\n       (\n       count(patient_id)\n       for patientcount in ([1],[2],[3],[4],[5],[6],[7])\n       ) as pivottable),\n\nMinMaxTimes as (\n    SELECT a.client_id AS client_id\n    ,a.patientcount TimesTested\n       , count(a.patientcount)/a.patientcount AS count\n       , max(f.received_date) AS maxRecDate\n       , min(f.received_date) AS minRecDate\n    FROM\n    (\n       SELECT DISTINCT CLIENT_ID\n       , PATIENT_ID\n       , count(*) over (partition by client_id, patient_id) AS patientcount\n\n       from f_accession_daily\n\n    ) AS a\n    JOIN F_ACCESSION_DAILY AS f ON a.CLIENT_ID = f.CLIENT_ID\n       AND a.PATIENT_ID = f.PATIENT_ID\n\n    GROUP BY a.CLIENT_ID, a.patientcount),\n\nmaxDates as (\nSELECT client_id, [1] maxdate1, [2] maxdate2, [3] maxdate3, [4] maxdate4, [5] maxdate5, [6] maxdate6, [7] maxdate7\nFROM MinMaxTimes t\nPIVOT (max(maxRecDate)\nfor TimesTested IN ([1], [2], [3], [4], [5], [6], [7])\n) as p),\n\nminDates as (\nSELECT client_id, [1] mindate1, [2] mindate2, [3] mindate3, [4] mindate4, [5] mindate5, [6] mindate6, [7] mindate7\nFROM MinMaxTimes t\nPIVOT (max(minRecDate)\nfor TimesTested IN ([1], [2], [3], [4], [5], [6], [7])\n) as p)\n\nSELECT i.client_id, \n    p.[1], maxdate1, mindate1, \n    p.[2], maxdate2, mindate2, \n    p.[3], maxdate3, mindate3, \n    p.[4], maxdate4, mindate4, \n    p.[5], maxdate5, mindate5, \n    p.[6], maxdate6, mindate6, \n    p.[7], maxdate7, mindate7   \nFROM PivotQuery p\nLEFT OUTER JOIN maxDates a ON p.client_id = a.client_id\nLEFT OUTER JOIN mindates i ON a.client_id = i.client_id\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":67,"score":0,"question_id":12981816,"title":"What does a select statement inside a select statement mean?","body":"<p>What does a Transact SQL statement <code>Select</code> statement inside a <code>from</code> mean? </p>\n\n<p>I mean something like this </p>\n\n<pre><code> .. from ( \n    select .. \n )\n</code></pre>\n\n<p>Also, I need to know if the statement is bad for performance.  Can you provide me a link to the official documentation about this topic in Transact SQL?</p>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":67,"score":3,"question_id":12982045,"title":"are there loops in t-sql ? is using them a good idea?","body":"<p>Pardon me if I'm asking this, but I'm not a SQL Server nor SQL developer.</p>\n\n<p>i have a CSV that i import into a table let's call it T that i create on the fly in SQL Server 2005.</p>\n\n<p>what i would like to do is to run some queries against other tables based on the data imported into the table T i created.\nexample :</p>\n\n<pre><code>select * \nfrom TableX \nwhere customerID = [this should contain the customerID from the table T]\n</code></pre>\n\n<p>and then if i find it, i need to update the same table T, if not i move along... until the last record in that csv file. Any idea will be appreciated.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":12982104,"title":"Silent type conversions in SQL Server 2008","body":"<p>I just recently discovered that SQL Server will return equivalent answers for the following two queries</p>\n\n<pre><code>select * from myTable\n    where column1 in('034','023')\n\nselect * from myTable\n    where column1 in (34,23)\n</code></pre>\n\n<p>The data type in the varchar.  Does anyone have a link or knowledge of other 'silent' datatype conversions in SQL Server (or T-SQL, specifically perhaps)</p>\n"},{"tags":["sql-server","tsql","pivot","unpivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":12980980,"title":"SQL Pivoting a column","body":"<p>suppose I have a temp table created and the structure/data looks like this</p>\n\n<pre><code>  Type        Lang    N_cnt        Pcnt      T1      T2       T3      T4\n============================================================================\nClassroomA      1      165897      1232     6439    1135     4516     1756\nClassroomA      2      175127      1254     6439    1135     1285     1953\nClassroomB      1      179515      1284     6439    1762     3945     1957\nClassroomB      2      159683      2041     6439    1575     4745     1955\n</code></pre>\n\n<p>I wanna pivot the <code>T1</code>, <code>T2</code>, <code>T3</code>, <code>T4</code> columns such that I get this result</p>\n\n<pre><code>   Type       SubType   Lang      N_cnt            P_cnt   \n==============================================================\nClassroomA      NULL     1       165897          1232  \nNULL            \"T1\"     1   6439/165897     6439/1232       \nNULL            \"T2\"     1       *calculation*   *calculation*\nNULL            \"T3\"     1       *calculation*   *calculation*\nNULL            \"T4\"     1       *calculation*   *calculation*\nClassroomA      NULL     2       175127          1254  \nNULL            \"T1\"     2       6439/175127     6439/1254       \nNULL            \"T2\"     2       *calculation*   *calculation*\nNULL            \"T3\"     2       *calculation*   *calculation*\nNULL            \"T4\"     2       *calculation*   *calculation*\n</code></pre>\n\n<p>Note that where it says <code>calculation</code> thats where I will be taking the value of <code>T{x}</code> and doing some calucation with it (I do an example for the first <code>T1</code>). I would also like to add that in reality I have about ten over these <code>T</code> variables.</p>\n\n<p>Any ideas how to pivot the columns?</p>\n"},{"tags":["sql","oracle","tsql","plsql"],"answer_count":11,"favorite_count":3,"up_vote_count":10,"down_vote_count":0,"view_count":14285,"score":10,"question_id":41781,"title":"Microsoft T-SQL to Oracle PL/SQL translation","body":"<p>I've worked with T-SQL for years but i've just moved to an organisation that is going to require writing some Oracle stuff, probably just simple CRUD operations at least until I find my feet. I'm not going to be migrating databases from one to the other simply interacting with existing Oracle databases from an Application Development perspective. Is there are tool or utility available to easily translate T-SQL into PL/SQL, a keyword mapper is the sort of thing I'm looking for.</p>\n\n<p>P.S. I'm too lazy to RTFM, besides it's not going to be a big part of my role so I just want something to get me up to speed a little faster.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":41,"score":2,"question_id":12978308,"title":"SQl Server Query against Server Group","body":"<p>So I am using the tsql  code to run through a bunch of servers, and look in each database for the users. My issue that on a specific server, there are databases I do not have access to and do not need to use. When the query runs on them it stops on the entire server and moves to the next one. I have been trying to find a way to exclude certain databses from the search.</p>\n\n<p>What I am trying to do is </p>\n\n<p>for example on server A excluded these databses B,C,D, and so on . I have tried where &lt;> and != and does not work or I have the wrong syntax</p>\n\n<pre><code>USE MASTER\n\nIf OBJECT_ID('#TDB', 'U') &gt; 0\nDrop Table #TDB\n\nDECLARE @dbname varchar(200),\n        @sql varchar(max)\n\nCREATE TABLE #TDB (\nDataBaseName nvarchar(200), \nUserName nvarchar(200)\n)\n\nDECLARE db_cursor CURSOR FOR\nSELECT name\nFROM master.dbo.sysdatabases WHERE DBID&gt;4\nOPEN db_cursor\nFETCH NEXT FROM db_cursor INTO @dbname\nWHILE @@FETCH_STATUS = 0\n\nBEGIN\n\nSET @sql='insert into #TDb(DataBaseName,UserName)\nselect '''+@dbname+''' DataBaseName,[user_name] UserName FROM '+@dbname+'.[dbo].[USERS] where'+@dbname+'&lt;&gt;[APSSWATCH]' \n\nEXEC(@sql)\n\nFETCH NEXT FROM db_cursor INTO @dbname\n\nEND\n\nCLOSE db_cursor\nDEALLOCATE db_cursor\n\nSELECT * FROM #TDB ORDER BY DataBaseName,UserName\nDROP TABLE #TDB\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":70,"score":2,"question_id":12979798,"title":"Weird SQL Server comparison is always false","body":"<pre><code>declare @test int\ndeclare @test2 int = 3\n\nselect case when @test != @test2 then 1 else 0 end\nselect case when @test = @test2 then 1 else 0 end\n</code></pre>\n\n<p>The result is always 0. Can someone explain this?</p>\n"},{"tags":["sql","sql-server","database","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":83,"score":1,"question_id":12976131,"title":"Dynamic use of T-SQL schemas","body":"<p>Is there a way which I can omit the schema of objects used in a stored procedure and these objects aren't bound to the schema of stored procedure but the schema of logged used in manner that the same stored procedure produce different results for user in different schemas?</p>\n\n<p>For better understanding what I'm trying to do, below I'll try to explain better.</p>\n\n<p>Supposing the following database:</p>\n\n<pre><code>CREATE TABLE [dbo].[SampleTable01] (...)\n\nCREATE TABLE [dbo].[SampleTable02] (...)\n\nCREATE TABLE [dbo].[SampleTable03] (...)\n\nCREATE TABLE [dbo].[SampleTable04] (...)\n</code></pre>\n\n<p>In this database, the number following the name of the table represents the owner of the table (it is a legacy system and I can't change that).</p>\n\n<p>To integrate that into .net Entity Framework, I come with a solution of creating synonyms in different schemas, so changing the connections string I can change the objects used without changing my database context or my programming logic. </p>\n\n<p>Like this.</p>\n\n<pre><code>CREATE SCHEMA [s01]\nCREATE SYNONYM [s01].[SampleTable] FOR [dbo].[SampleTable01]\n\n...\n\nCREATE SCHEMA [s04]\nCREATE SYNONYM [s04].[SampleTable] FOR [dbo].[SampleTable04]\n</code></pre>\n\n<p>This solutions is working pretty well, but I need to duplicate all the stored procedures used, because the stored procedures are bound to a specific object.</p>\n\n<p>When I create the following stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[usp_SampleProc] AS\nSELECT * FROM [SampleTable]\n</code></pre>\n\n<p>The stored procedure will produce an error, because the <code>[SampleTable]</code> doesn't exists in the schema <code>[dbo]</code>.</p>\n\n<p>What I'm doing is duplicating the stored procedures to match the schema from the logged user. </p>\n\n<p>So I'm doing this:</p>\n\n<pre><code>CREATE PROCEDURE [s01].[usp_SampleProc] AS\nSELECT * FROM [s01].[SampleTable]\n\n...\n\nCREATE PROCEDURE [s04].[usp_SampleProc] AS\nSELECT * FROM [s04].[SampleTable]\n</code></pre>\n\n<p>A user in <code>[s01]</code> schema will get values from <code>[s01].[SampleTable]</code> and a user in <code>[s04]</code> schema will get values from <code>[s04].[SampleTable]</code>, when executing <code>[usp_SampleProc]</code> without specifying the schema, which is my expected result.</p>\n\n<p>So far so good, this isn't productive in my real scenario. I have thousand of tables, hundreds of procedures and dozen of schemas (I know this is ugly, but I integrating a legacy system with .net, and so far, it is the best solution which I come).</p>\n\n<p>So, the question again:</p>\n\n<p>Is there a way which I can omit the schema of objects used in the stored procedure and these objects aren't bound to the schema of the stored procedure but the schema of the logged in user in manner that the same stored procedure produces different results for users in different schemas?</p>\n"},{"tags":["tsql","sql-server-2012"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":12978005,"title":"Why conversion numeric to VARCHAR does not give overflow message?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/9124055/why-cast-convert-from-int-returns-an-asterisk\">Why cast/convert from int returns an asterisk</a>  </p>\n</blockquote>\n\n\n\n<p>I have found something very strange - when I am converting number to varchar variable, and there is overflow (the number is too big to be included in the varchar variable) there is no message about this.</p>\n\n<p>For example, this code using NVARCHAR type will inform that something is wrong:</p>\n\n<pre><code>DECLARE @ParemOne INT=12345\nDECLARE @ParamTWo INT=56789\n\nSELECT CAST(@ParemOne AS NVARCHAR(4))+'|'+CAST(@ParamTWo AS NVARCHAR(4))\n</code></pre>\n\n<p>in this way:</p>\n\n<blockquote>\n  <p><em>Msg 8115, Level 16, State 2, Line 6</em><br>\n  <em>Arithmetic overflow error converting expression to data type nvarchar.</em></p>\n</blockquote>\n\n<p>But when I do:</p>\n\n<pre><code>DECLARE @ParemOne INT=12345\nDECLARE @ParamTWo INT=56789\n\nSELECT CAST(@ParemOne AS VARCHAR(4))+'|'+CAST(@ParamTWo AS VARCHAR(4))\n</code></pre>\n\n<p>The result is:</p>\n\n<pre><code>*|*\n</code></pre>\n\n<p>Why this thing happens?Is it result of some options that is on/off?If not, I have found this very strange and unpracticed. </p>\n"},{"tags":["tsql","escaping","character","star"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":12977348,"title":"T-SQL How to escape star (*) character","body":"<p>I want to search about this string </p>\n\n<pre><code>*|*\n</code></pre>\n\n<p>or more specific </p>\n\n<pre><code>LIKE '%*|*%'\n</code></pre>\n\n<p>but the </p>\n\n<pre><code>*\n</code></pre>\n\n<p>means the symbol itself. How to escape it?</p>\n\n<p>EDIT: Actually, I was mislead because of other <a href=\"http://stackoverflow.com/questions/12978005/why-conversion-numeric-to-varchar-does-not-give-overflow-message\">issue </a> in my code. Anyway, you are completely right that in LIKE statement there is no special meaning for the * character.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12958838,"title":"sql server 2008 filter on big list passed in","body":"<p>I am having a performance issue.  I am trying to select from a table based on a very long list of parameters</p>\n\n<p>Currently am using this stored proc</p>\n\n<pre><code>CREATE PROC [dbo].[GetFileContentsFromTitles]\n@MyTitles varchar(max)\nAS\nSELECT [Title], [Sequence] From [dbo].[MasterSequence]\nWHERE charindex(',' + Title + ',', ',' + @MyTitles + ',') &gt; 0;\n</code></pre>\n\n<p>Where @MyTitles can be a very big number (currently doing a string with 4000 entries seperated by commas).  Any suggestions?  Thanks  </p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":796,"score":2,"question_id":9946833,"title":"SQL charindex throwing Invalid length parameter passed to the LEFT or SUBSTRING function because of period?","body":"<p>I've got the lines below in the where clause of my query, but I keep getting this error:</p>\n\n<pre><code>Msg 537, Level 16, State 3, Line 3\nInvalid length parameter passed to the LEFT or SUBSTRING function.\n\n    SUBSTRING(\n        [email], \n        1, \n        CHARINDEX('@',[email])-1\n    ) =\n    SUBSTRING(\n        [email], \n        CHARINDEX('@',[email])+1,\n        CHARINDEX('.', [email])\n    )\n</code></pre>\n\n<p>The error is originating from <code>CHARINDEX('.', [email])</code></p>\n\n<p>If I change the period to a letter, I don't get the error.  Every record has a period in it, and even if one didn't, the charindex function would return 0, which wouldn't cause this error to throw.  I must be missing something simple. Please help!</p>\n\n<p>EDIT.</p>\n\n<p>I tried throwing it inside an isnull,  <code>isnull(CHARINDEX('.', [email]), 1)</code> just in case it was returning null for some reason, but that didn't work either.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":787,"score":1,"question_id":2548594,"title":"DBCC SHRINKFILE 1 sproc for multiple databases","body":"<p>I have a need to execute DBCC SHRINKFILE for multiple db's within the same sproc.\nI <em>could</em> create multiple sprocs so it runs within the given context, but I was curious if there were alternatives?</p>\n"},{"tags":["sql","sql-server-2008","tsql","function","build"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":70,"score":2,"question_id":12969806,"title":"Get sum/average value of records defining equal time periods","body":"<p>I have the following information (return by view):</p>\n\n<pre><code>DateTime   ItemID  UserTyp Seconds\n\n2012-01-01 10      S       12      \n\n2012-01-01 10      S       18  \n\n2012-01-01 11      S       22  \n\n2012-01-02 11      M       52  \n\n2012-01-02 10      S       120  \n\n2012-01-02 11      S       NULL  \n\n2012-01-03 15      M       112  \n\n2012-01-03 12      S       182  \n\n2012-01-04 10      M       NULL  \n</code></pre>\n\n<p>What I need to done is to calculated the sum of all seconds by user types, but for five periods.</p>\n\n<p>The periods are set in the following way:</p>\n\n<ol>\n<li>Get the first and the last date</li>\n<li>Divided all days on five</li>\n<li>The result of the division is the days that one period includes</li>\n</ol>\n\n<p>Then for each period, depending on the DateTime and the UserType of the records, I should come up with this records:</p>\n\n<pre><code>Periods  UserTypeS_SUM(Seconds) UserTypeM_SUM(Seconds)\n1        \n2        \n3\n4\n5\n</code></pre>\n\n<p>Also, I should check if there is at least 5 records, before the division is make - if I have 4 for example, only one period will be used.</p>\n\n<p>I know it does not look so different, I have started to make a solution using function, but it looks kinda ineffective to me. Are there some build-in functions that could do this easy?</p>\n\n<p>EDIT: I am really sorry but  I have forget to mention that the I should this in view or table-valued function. No store procedures are allowed in this case.</p>\n"},{"tags":["sql","tsql","sql-azure"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":42,"score":-1,"question_id":12968470,"title":"How to create a backup database in sql azure using as copy of option and setting edition with max size at the same time","body":"<p>I've been using the code below:</p>\n\n<pre><code>CREATE DATABASE [NSFKIPRODDB01_BKBK] AS COPY OF [NSFKIPRODDB01] (EDITION='BUSINESS', MAXSIZE = 10GB)\n</code></pre>\n\n<p>But it keeps on throwing me the error below:</p>\n\n<pre><code>Msg 102, Level 15, State 1, Line 1\nIncorrect syntax near 'AS'.\n</code></pre>\n"},{"tags":["tsql","date","common-table-expression","overlapping"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":115,"score":0,"question_id":12428873,"title":"Avoiding gaps in datetime intervals with CTE and start and end datetimes","body":"<p>For some reason I am seeing gaps in my time intervals using this query. I have gotten it to work when just using basic data. However, when joining my tables and specifying a WHERE clause, I see gaps in my time interval. I also need to incorporate the S.SessionEndTime in my intervals to find a count of records where there is overlap with a given 1 minute interval between the ResponseTime and SessionEndTime. </p>\n\n<p>Here is the query I am using. By using a derived table, I get a MAX per hour based on the COUNT for 1 minute intervals.</p>\n"},{"tags":["sql","sql-server","xml","tsql","xsd"],"answer_count":0,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":79,"score":3,"question_id":12973696,"title":"TSQL Modify xml with namespaces","body":"<p>I'm trying to modify predefined xml (xsd to be more specific) in TSQL.\nI want to insert enumeration restriction to one of the xsd elements.</p>\n\n<p>The task is to fill xsd restrictions based on a query\nexample:</p>\n\n<pre><code>create table #list(value nvarchar(100))\ninsert into #list values('item 1')\ninsert into #list values('item 2')\ninsert into #list values('item 3')\ninsert into #list values('item 4')\ninsert into #list values('item 5')\ninsert into #list values('item 6')\n\ndeclare @enumeration as xml\n;with xmlnamespaces('http://www.w3.org/2001/XMLSchema' as xs)\nselect @enumeration = (\n    select value as '@value'\n    from #list for xml path('xs:enumeration')\n)\n\ndeclare @schema xml\nset @schema =\n'&lt;xs:schema xmlns=\"\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:msdata=\"urn:schemas-microsoft-com:xml-msdata\" id=\"test\"&gt;\n    &lt;xs:element name=\"test\" msdata:IsDataSet=\"true\" msdata:MainDataTable=\"Example\" msdata:UseCurrentLocale=\"true\"&gt;\n        &lt;xs:complexType&gt;\n            &lt;xs:choice maxOccurs=\"unbounded\"&gt;\n                &lt;xs:element name=\"Example\"&gt;\n                    &lt;xs:complexType&gt;\n                        &lt;xs:sequence&gt;\n                            &lt;xs:element name=\"myList\" minOccurs=\"1\" nillable=\"false\"&gt;\n                                &lt;xs:simpleType&gt;\n                                    &lt;xs:restriction base=\"xs:string\"&gt;\n                                        &lt;xs:maxLength value=\"50\" /&gt;\n                                    &lt;/xs:restriction&gt;\n                                &lt;/xs:simpleType&gt;\n                            &lt;/xs:element&gt;\n                        &lt;/xs:sequence&gt;\n                    &lt;/xs:complexType&gt;\n                &lt;/xs:element&gt;\n            &lt;/xs:choice&gt;\n        &lt;/xs:complexType&gt;\n    &lt;/xs:element&gt;\n&lt;/xs:schema&gt;'\n\nset @schema.modify\n    ('insert sql:variable(\"@enumeration\")\n    into (//xs:element[@name=''myList'']/xs:simpleType/xs:restriction)[1]')\n\nselect @schema\n</code></pre>\n\n<p>The problem is that code outputs unnecessary xmlns attribute</p>\n\n<pre><code>&lt;xs:enumeration xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" value=\"item 1\" /&gt;\n</code></pre>\n\n<p>Can anyone help ?</p>\n"},{"tags":["sql-server","tsql","date-range"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12972635,"title":"Date range advanced count calculation in TSQL","body":"<p>I am working on call center project and I have to calculate the call arrivals at the same time between specific time ranges.\nI have to write a procedure which has parameters StartTime, EndTime and Interval</p>\n\n<p>For Example:</p>\n\n<pre><code>Start Time: 11:00\nEnd Time: 12:00\nInterval: 20 minutes\n</code></pre>\n\n<p>so program should divide the 1-hour time range into 3 parts and each part should count the arrivals which started and finished in this range OR arrivals which started and haven't finished yet</p>\n\n<p>Should be like this:</p>\n\n<pre><code>11:00 - 11:20 15 calls at the same time(TimePeaks)\n11:20 - 11:40 21 calls ...\n11:40 - 12:00  8 calls ...\n</code></pre>\n\n<p>Any suggestions how to calculate them? </p>\n"},{"tags":["tsql","stored-procedures","select","sybase"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":6075,"score":2,"question_id":1443203,"title":"How do I select from a stored procedure in Sybase?","body":"<p>My DBA has constructed me a stored procedure in a Sybase database, for which I don't have the definition.\nIf I run it, it returns a resultset with a set of columns and values. I would like to SELECT further to reduce the rows in the result set. Is this possible?</p>\n\n<p>From <a href=\"http://stackoverflow.com/questions/728898/can-you-do-a-select-on-the-results-of-a-stored-procedure-in-t-sql\">this question</a> it seems like I could insert the results into a temporary table, but I'm not sure I've got permissions to do this.</p>\n\n<p>Is there any way I can SELECT certain rows, or if not, can someone give me example code for simulating with a temporary table?</p>\n"},{"tags":["sql","tsql","pivot","dynamic-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12972027,"title":"Dynamic SQL Pivot - removing nulls","body":"<p>this is my first attempt at dynamic pivoting in SQL and I have become a bit stuck!</p>\n\n<p>I have two tables that I am joining on, one holds stock items and the other holds different prices for stock items for different websites(sources). As there is the possibility of having different sites, the query needs to be dynamic. </p>\n\n<p>The problem is that I cannot remove nulls from the results and I was hoping that someone could help. </p>\n\n<p>results look like this currently:</p>\n\n<pre><code>ID    site-site1   site-site2    site-site3\n1      null          1.99          2.99\n2      12.99         null          10.00\n3      1.50          null          2.00\n</code></pre>\n\n<p>The query is as follows:</p>\n\n<pre><code>DECLARE @sources nvarchar(max)\n\nSELECT @sources = \nSTUFF(( SELECT DISTINCT ',[' + \nCASE \nWHEN ip.[Source] is null or ip.[Source] = '' THEN 'Default'\nELSE ip.[Source] \nEND \n+ ' - ' +  \nCASE \nWHEN ip.secondSource is null or ip.secondSource = '' THEN  'Default'\nELSE ip.secondSource \nEND  \n+ ']'\n    FROM itemprice ip\n    for XML PATH('')\n  ), 1, 1, '')\n\nDECLARE @SQL nvarchar(MAX)\nSELECT @SQL = N'\nSELECT *\nFROM \n(\nSELECT \ns.id, \n[Source] = CASE \n               WHEN ip.[Source] is null or ip.[Source] = '''' THEN  ''Default'' \n       ELSE ip.[Source] \n       END + '' - '' +  \nCASE WHEN ip.secondSource is null or ip.secondSource = '''' THEN ''Default''\nELSE ip.secondSource \nEND, \n    SalePrice = isnull(ip.SalePrice, 0)  \n    FROM stock s \n    LEFT OUTER JOIN itemprice ip on ip.id = s.id\n) data \nPIVOT \n( \n  MAX(SalePrice) for [Source] IN (' + @sources + ')\n) as PivotTable\nORDER BY PivotTable.id'\nexec sp_executesql @sql\n</code></pre>\n\n<p>Any help would be greatly appreciated, it appears as though it is not as simple as wrapping each @sources item in an ISNULL. </p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":12970907,"title":"Backup SQL Server db in a format to open in Microsoft Access","body":"<p>Is there a way to do a backup for SQL Server db in a format that opens in Microsoft Access or Excel for instance?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":99,"score":0,"question_id":12966848,"title":"getting the minimum and maximum date in the same query","body":"<p>I have a working query that gives me the maxdate:</p>\n\n<pre><code>SELECT a.client_id AS client_id\n   , a.patientcount AS patientcount\n   , received_date AS maxRecDate\nFROM\n(\n   SELECT DISTINCT CLIENT_ID\n   , PATIENT_ID\n   , count(*) over (partition by client_id, patient_id) AS patientcount\n   from f_accession_daily\n) AS a\nJOIN F_ACCESSION_DAILY AS f ON a.CLIENT_ID = f.CLIENT_ID\n   AND a.PATIENT_ID = f.PATIENT_ID\nGROUP BY f.RECEIVED_DATE, a.CLIENT_ID, a.patientcount\nHAVING f.RECEIVED_DATE = MAX(f.received_date)\n</code></pre>\n\n<p>In the same query I would also like to return min(f.received_date).</p>\n\n<p>Is there a way to do this? perhaps with the subquery?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":12966509,"title":"converting normal query into fancy or partition/over query","body":"<p>My query:</p>\n\n<pre><code>with cte as (\n        select client_id,COUNT(patient_id) PatientCount from\n        (\n            select client_id,patient_id\n            from F_ACCESSION_DAILY\n            group by CLIENT_ID,PATIENT_ID\n            having COUNT(ACCESSION_ID)=2\n        ) a\n        group by CLIENT_ID\n)\n</code></pre>\n\n<p>works, but is not so useful to me. because although i can JOIN easily on this query, I will actually need to repeat this <code>WITH</code> statement many times because i need to be able to differentiate between:</p>\n\n<pre><code>having count(Accession_id)=2\n</code></pre>\n\n<p>and</p>\n\n<pre><code>having count(Accession_id)=3\n</code></pre>\n\n<p>and</p>\n\n<pre><code>having count(accession_id)=4\n</code></pre>\n\n<p>and so on until around 100</p>\n\n<p>i was thinking to do something more like this:</p>\n\n<pre><code>select distinct client_id, patient_id, count(*) over (partition by client_id, patient_id,accession_id) patientcount\n    from f_accession_daily\n</code></pre>\n\n<p>but i am stuck!</p>\n\n<p>i was wondering if you can point me into the right direction on how to convert the initial query into something <strong>more useable when having count(Accession)=many different values</strong>?</p>\n\n<p>thanks so much for your guidance.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12967911,"title":"ORDER BY items must appear in the select list if the statement contains a UNION, INTERSECT or EXCEPT operator","body":"<p>Below is my stored procedure, but upon executing it the following error occured:</p>\n\n<blockquote>\n  <p>Msg 104, Level 16, State 1, Procedure ACEsp_AuditInvoice, Line 84\n  ORDER BY items must appear in the select list if the statement\n  contains a UNION, INTERSECT or EXCEPT operator.</p>\n</blockquote>\n\n<p>Please review my stored procedure, and tell me how I will avoid the error above.\nThanks in advance </p>\n\n<pre><code>USE [FAC]\nGO\n/****** Object:  StoredProcedure [dbo].[ACEsp_AuditInvoice]    Script Date: 10/18/2012 09:26:49 ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\n-- =============================================\n-- Author:      Ryan\n-- Create date: 18 Oct 2012\n\n-- version: 12.10\n-- Description: Originated from ACEsp_InvVsListPrice, modified for invoice auditing \n-- parameter by date, month and year\n-- Additional 10 columns for invoice auditing\n-- =============================================\n\n--[dbo].[ACEsp_AuditInvoice] '2012-09-17','2012-09-17','SEPTEMBER','2012'\n\nALTER PROCEDURE [dbo].[ACEsp_AuditInvoice] \n    -- Add the parameters for the stored procedure here\n    @dtfrom datetime,\n    @dtto datetime,\n    @MNTH varchar(12),\n    @YR INT\n    --@prcMakro varchar(15)\nWITH RECOMPILE\n\nAS\n\ncreate table #brand (\n    [CODE] [char](15) COLLATE SQL_Latin1_General_CP1_CI_AS ,\n    [IVBRAND] [char](255) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL \n)\n\ncreate table #SubCat (\n    [CODE] [char](15) COLLATE SQL_Latin1_General_CP1_CI_AS ,\n    [IVSUBCAT] [char](255) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL    \n)\n\nBEGIN\n    -- SET NOCOUNT ON added to prevent extra result sets from\n    -- interfering with SELECT statements.\n    SET NOCOUNT ON;\n    DECLARE @SDFROM VARCHAR(20)\n    DECLARE @SDTO VARCHAR(20)\n\n    SET @SDFROM = CONVERT(VARCHAR(10), @DTFROM, 101) + ' 00:00:00'\n    SET @DTFROM = CAST(@SDFROM AS DATETIME)\n\n    SET @SDTO = CONVERT(VARCHAR(10), @DTTO, 101) + ' 23:59:59'\n    SET @DTTO = CAST(@SDTO AS DATETIME)\n\n\n    insert into #brand\n    select USCATVAL, Image_URL\n    from IV40600\n    where USCATNUM = 2\n\n    insert into #SubCat\n    select USCATVAL, Image_URL\n    from IV40600\n    where USCATNUM = 4\n\n    -- Insert statements for procedure here\n    select 'posted' as Trx, d.quantity, d.qtytoinv, d.qtycance, (d.qtytoinv - d.qtyfulfi) 'qtyfulfivar', \n        (u.equomqty * d.qtyfulfi) 'qtybaseuom', \n        (d.XTNDPRCE - \n        (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )) 'variance',\n\n        CASE(d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )\n            WHEN 0 THEN 0\n            ELSE\n            (d.XTNDPRCE /  \n            ((d.qtyfulfi*u.equomqty) *      \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )))-1\n            end as 'percentvar',\n\n        p.PRCSHID, h.docdate, h.bachnumb, h.ReqShipDate,\n        d.lnitmseq, d.locncode,  d.UNITPRCE, \n        p.psitmval as [LIST PRICE], i.stndcost, d.qtybsuom, c.slprsnid, sp.slprsnfn, \n        sp.sprsnsln, c.salsterr, st.slterdsc, h.custnmbr, h.custname, \n        c.shrtname as 'CUSTOGROUP', c.custclas as 'CUSTOCLAS', c2.ZIP as 'CHANSEG',\n        h.sopnumbe, d.itemnmbr, d.itemdesc, \n        case i.itemtype\n            WHEN 1 THEN 'SALES INVENTORY'\n            WHEN 2 THEN 'DISCONTINUED'\n            WHEN 3 THEN 'KITS'\n        end as 'ITEMTYPE',\n        d.qtyfulfi, d.uofm, d.XTNDPRCE, u.equivuom 'BASEUOM', u.equomqty 'PACKING', \n        d.qtyfulfi*u.equomqty 'bqty',\n\n        isnull( (SELECT TOP 1 LISTPRICE FROM tbl_disco_historical_baseuom HH  WHERE HH.ITEMNMBR = D.ITEMNMBR AND HH.BASEUOM = U2.BASEUOFM AND HH.LEFFECTDATE &gt;= H.DOCDATE ORDER BY HH.LEFFECTDATE DESC),\n            isnull(p.psitmval, \n                    ISNULL((SELECT psitmval from iv10402 \n                            WHERE prcShid = 'BASE PRICE' \n                            AND itemnmbr = d.itemnmbr \n                            AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                        WHERE prcShid = 'BASE PRICE' \n                                                        AND itemnmbr = d.itemnmbr \n                                                        AND UOFM = D.UOFM))\n                    )) as 'BASE PRICE  LIST PRICE PER BUOM',\n\n        isnull(p.psitmval*d.qtyfulfi*u.equomqty,\n                    ISNULL((SELECT psitmval from iv10402 \n                         WHERE prcShid = 'BASE PRICE' \n                         AND itemnmbr = d.itemnmbr \n                         AND UOFM = U.EQUIVUOM ), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                * d.qtyfulfi*u.equomqty\n               )\n                AS 'EXTND PRICE by BASE PRICE-BUOM',    \n        p1.psitmval as 'MAKRO PRICE  LIST PRICE', \n        p1.psitmval*d.qtyfulfi as 'EXTND PRICE BY MAKRO',\n        d.qtyfulfi*u.equomqty AS 'QTYBASEUOM', \n        ISNULL(\n        (SELECT TOP 1 LISTPRICE FROM tbl_disco_historical_baseuom HH  WHERE HH.ITEMNMBR = D.ITEMNMBR AND HH.BASEUOM = U2.BASEUOFM AND HH.LEFFECTDATE &gt;= H.DOCDATE ORDER BY HH.LEFFECTDATE DESC),\n        isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                ))\n                as 'BaseUomListPrice',\n\n            (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )           \n                as 'BaseUomTotalListPrice', \n\n        (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                ) - D.XTNDPRCE AS 'TOTAL DISCOUNT',\n            a.IVBRAND as 'BRAND', b.IVSUBCAT as 'SubCat',\n            dbo.ACEfunc_CUSTOTYPE2(c.CUSTCLAS,c.SALSTERR) AS 'CUSTTYPE', D.MRKDNAMT*d.qtyfulfi AS 'MARKDOWN',\n            cast(i.uscatvls_6 as float) as 'ITEM REPORT SEQUENCE',\n            rtrim(ltrim(cast(uscatvls_1 as varchar(4)))) + '-' + bh.image_url as 'BRAND HANDLER',\n            I.ITMCLSCD 'ITEM CLASS', d.qtyfulfi*u.equomqty/uu.equomqty AS 'CASEQTY',\n            ii.inet1 as 'ABC CAT',\n            ISNULL(APL.PCPRICE,isnull(p.psitmval, \n                    ISNULL((SELECT psitmval from iv10402 \n                            WHERE prcShid = 'BASE PRICE' \n                            AND itemnmbr = d.itemnmbr \n                            AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                        WHERE prcShid = 'BASE PRICE' \n                                                        AND itemnmbr = d.itemnmbr \n                                                        AND UOFM = D.UOFM))\n                    )) as 'APL(SAG) Piece Price', h.docid as 'SOP TYPE ID'\n\n    from sop30200 h\n        inner join sop30300 d on (h.sopnumbe = d.sopnumbe)\n        inner join IV00101 i on (d.itemnmbr = i.itemnmbr)\n        inner join RM00101 c on (h.custnmbr = c.custnmbr)\n        left join RM00102 c2 on (c.custnmbr = c2.custnmbr and c2.adrscode = 'MAIN')\n        left join RM00301 sp on (sp.slprsnid = c.slprsnid)\n        left join RM00303 st on (st.salsterr = c.salsterr)\n        LEFT JOIN iv40202 u on (i.uomschdl = u.uomschdl and d.uofm = u.uofm and u.qtybsuom &lt;&gt; 0)\n        LEFT JOIN iv40201 u2 on (i.uomschdl = u2.uomschdl)\n        left join iv10402 p1 on (d.itemnmbr = p1.itemnmbr and p1.PRCSHID = 'PLMAKRO'\n            and d.uofm = p1.uofm)\n        left join iv10402 p on (d.itemnmbr = p.itemnmbr and p.PRCSHID = 'BASE PRICE'\n            and U.EQUIVUOM = p.uofm)\n        left join #brand a on (i.uscatvls_2 = a.code)\n        left join #SubCat b on (i.uscatvls_4 = b.code)\n        left join iv40600 bh on (i.uscatvls_1 = bh.uscatval AND bh.uscatnum = 1)\n        left join iv40202 uu on (i.uomschdl = uu.uomschdl and i.selnguom = uu.uofm and uu.qtybsuom &lt;&gt; 0)\n        LEFT join sy01200 as ii on (ii.master_id = d.itemnmbr and ii.master_type = 'ITM') \n        LEFT JOIN T0_APL APL ON (D.ITEMNMBR=APL.ITEMNMBR AND APL.MNTH = @MNTH AND APL.YR = @YR)\n\nUNION ALL\n\n    select 'unposted' as Trx, d.quantity, d.qtytoinv, d.qtycance, (d.qtytoinv - d.qtyfulfi) 'qtyfulfivar', \n        (u.equomqty * d.qtyfulfi) 'qtybaseuom', \n        (d.XTNDPRCE - \n        (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )) 'variance',\n\n        CASE(d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )\n            WHEN 0 THEN 0\n            ELSE\n            (d.XTNDPRCE /  \n            ((d.qtyfulfi*u.equomqty) *      \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )))-1\n            end as 'percentvar',\n\n        p.PRCSHID, h.docdate, h.bachnumb, h.ReqShipDate,\n        d.lnitmseq, d.locncode,  d.UNITPRCE, \n        p.psitmval as [LIST PRICE], i.stndcost, d.qtybsuom, c.slprsnid, sp.slprsnfn, \n        sp.sprsnsln, c.salsterr, st.slterdsc, h.custnmbr, h.custname, \n        c.shrtname as 'CUSTOGROUP', c.custclas as 'CUSTOCLAS', c2.ZIP as 'CHANSEG',\n        h.sopnumbe, d.itemnmbr, d.itemdesc, \n        case i.itemtype\n            WHEN 1 THEN 'SALES INVENTORY'\n            WHEN 2 THEN 'DISCONTINUED'\n            WHEN 3 THEN 'KITS'\n        end as 'ITEMTYPE',\n        d.qtyfulfi, d.uofm, d.XTNDPRCE, u.equivuom 'BASEUOM', u.equomqty 'PACKING', \n        d.qtyfulfi*u.equomqty 'bqty',\n\n        isnull( (SELECT TOP 1 LISTPRICE FROM tbl_disco_historical_baseuom HH  WHERE HH.ITEMNMBR = D.ITEMNMBR AND HH.BASEUOM = U2.BASEUOFM AND HH.LEFFECTDATE &gt;= H.DOCDATE ORDER BY HH.LEFFECTDATE DESC),\n            isnull(p.psitmval, \n                    ISNULL((SELECT psitmval from iv10402 \n                            WHERE prcShid = 'BASE PRICE' \n                            AND itemnmbr = d.itemnmbr \n                            AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                        WHERE prcShid = 'BASE PRICE' \n                                                        AND itemnmbr = d.itemnmbr \n                                                        AND UOFM = D.UOFM))\n                    )) as 'BASE PRICE  LIST PRICE PER BUOM',\n\n        isnull(p.psitmval*d.qtyfulfi*u.equomqty,\n                    ISNULL((SELECT psitmval from iv10402 \n                         WHERE prcShid = 'BASE PRICE' \n                         AND itemnmbr = d.itemnmbr \n                         AND UOFM = U.EQUIVUOM ), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                * d.qtyfulfi*u.equomqty\n               )\n                AS 'EXTND PRICE by BASE PRICE-BUOM',    \n        p1.psitmval as 'MAKRO PRICE  LIST PRICE', \n        p1.psitmval*d.qtyfulfi as 'EXTND PRICE BY MAKRO',\n        d.qtyfulfi*u.equomqty AS 'QTYBASEUOM', \n        ISNULL(\n        (SELECT TOP 1 LISTPRICE FROM tbl_disco_historical_baseuom HH  WHERE HH.ITEMNMBR = D.ITEMNMBR AND HH.BASEUOM = U2.BASEUOFM AND HH.LEFFECTDATE &gt;= H.DOCDATE ORDER BY HH.LEFFECTDATE DESC),\n        isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                ))\n                as 'BaseUomListPrice',\n\n            (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                )           \n                as 'BaseUomTotalListPrice', \n\n        (d.qtyfulfi*u.equomqty) *       \n            isnull(p.psitmval, \n                ISNULL((SELECT psitmval from iv10402 \n                        WHERE prcShid = 'BASE PRICE' \n                        AND itemnmbr = d.itemnmbr \n                        AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                    WHERE prcShid = 'BASE PRICE' \n                                                    AND itemnmbr = d.itemnmbr \n                                                    AND UOFM = D.UOFM))\n                ) - D.XTNDPRCE AS 'TOTAL DISCOUNT',\n            a.IVBRAND as 'BRAND', b.IVSUBCAT as 'SubCat',\n            dbo.ACEfunc_CUSTOTYPE2(c.CUSTCLAS,c.SALSTERR) AS 'CUSTTYPE', D.MRKDNAMT*d.qtyfulfi AS 'MARKDOWN',\n            cast(i.uscatvls_6 as float) as 'ITEM REPORT SEQUENCE',\n            rtrim(ltrim(cast(uscatvls_1 as varchar(4)))) + '-' + bh.image_url as 'BRAND HANDLER',\n            I.ITMCLSCD 'ITEM CLASS', d.qtyfulfi*u.equomqty/uu.equomqty AS 'CASEQTY',\n            ii.inet1 as 'ABC CAT',\n            ISNULL(APL.PCPRICE,isnull(p.psitmval, \n                    ISNULL((SELECT psitmval from iv10402 \n                            WHERE prcShid = 'BASE PRICE' \n                            AND itemnmbr = d.itemnmbr \n                            AND UOFM = U.EQUIVUOM), (SELECT psitmval from iv10402 \n                                                        WHERE prcShid = 'BASE PRICE' \n                                                        AND itemnmbr = d.itemnmbr \n                                                        AND UOFM = D.UOFM))\n                    )) as 'APL(SAG) Piece Price', h.docid as 'SOP TYPE ID'\n\n    from sop10100 h\n        inner join sop10200 d on (h.sopnumbe = d.sopnumbe)\n        inner join IV00101 i on (d.itemnmbr = i.itemnmbr)\n        inner join RM00101 c on (h.custnmbr = c.custnmbr)\n        left join RM00102 c2 on (c.custnmbr = c2.custnmbr and c2.adrscode = 'MAIN')\n        left join RM00301 sp on (sp.slprsnid = c.slprsnid)\n        left join RM00303 st on (st.salsterr = c.salsterr)\n        LEFT JOIN iv40202 u on (i.uomschdl = u.uomschdl and d.uofm = u.uofm and u.qtybsuom &lt;&gt; 0)\n        LEFT JOIN iv40201 u2 on (i.uomschdl = u2.uomschdl)\n        left join iv10402 p1 on (d.itemnmbr = p1.itemnmbr and p1.PRCSHID = 'PLMAKRO'\n            and d.uofm = p1.uofm)\n        left join iv10402 p on (d.itemnmbr = p.itemnmbr and p.PRCSHID = 'BASE PRICE'\n            and U.EQUIVUOM = p.uofm)\n        left join #brand a on (i.uscatvls_2 = a.code)\n        left join #SubCat b on (i.uscatvls_4 = b.code)\n        left join iv40600 bh on (i.uscatvls_1 = bh.uscatval AND bh.uscatnum = 1)\n        left join iv40202 uu on (i.uomschdl = uu.uomschdl and i.selnguom = uu.uofm and uu.qtybsuom &lt;&gt; 0)\n        LEFT join sy01200 as ii on (ii.master_id = d.itemnmbr and ii.master_type = 'ITM') \n        LEFT JOIN T0_APL APL ON (D.ITEMNMBR=APL.ITEMNMBR AND APL.MNTH = @MNTH AND APL.YR = @YR)     \n\n    where\n        h.soptype = 3 and d.CMPNTSEQ = 0 and h.voidstts = 0 and h.pstgstus = 2\n        and h.docdate &gt;= @DTFROM and h.docdate &lt;= @DTTO\n    --order by percentvar, h.custname, d.sopnumbe, d.itemnmbr\n\nEND\n</code></pre>\n"},{"tags":["tsql","list","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":101,"score":0,"question_id":12957891,"title":"TSQL split comma delimited string","body":"<p>I am trying to create a stored procedure that will split 3 text boxes on a webpage that have user input that all have comma delimited strings in it.  We have a field called 'combined_name' in our table that we have to search for first and last name and any known errors or nicknames etc. such as @p1: 'grei,grie' @p2: 'joh,jon,j..' p3: is empty.  </p>\n\n<p>The reason for the third box is after I get the basics set up we will have does not contain, starts with, ends with and IS to narrow our results further.</p>\n\n<p>So I am looking to get all records that CONTAINS any combination of those.  I originally wrote this in LINQ but it didn't work as you cannot query a list and a dataset.  The dataset is too large (1.3 million records) to be put into a list so I have to use a stored procedure which is likely better anyway.  </p>\n\n<p>Will I have to use 2 SP, one to split each field and one for the select query or can this be done with one?  What function do I use for contains in tsql?  I tried using IN win a query but cannot figure out how it works with multiple parameters.</p>\n\n<p>Please note that this will be an internal site that has limited access so worrying about sql injection is not a priority.  </p>\n\n<p>I did attempt dynamic SQL but am not getting the correct results back:</p>\n\n<pre><code>    CREATE PROCEDURE uspJudgments @fullName nvarchar(100) AS\n   EXEC('SELECT *\n         FROM   new_judgment_system.dbo.defendants_ALL \n         WHERE  combined_name IN (' + @fullName + ')')\nGO\n\nEXEC uspJudgments @fullName = '''grein'', ''grien'''\n</code></pre>\n\n<p>Even if this did retrieve the correct results how would this be done with 3 parameters? </p>\n"},{"tags":["sql-server","tsql","stored-procedures","dynamic-sql","temporary-tables"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":2561,"score":0,"question_id":2917728,"title":"T-SQL Dynamic SQL and Temp Tables","body":"<p>It looks like #temptables created using dynamic SQL via the EXECUTE string method have a different scope and can't be referenced by \"fixed\" SQLs in the same stored procedure.\nHowever, I can reference a temp table created by a dynamic SQL statement in a subsequence dynamic SQL but it seems that a stored procedure does not return a query result to a calling client unless the SQL is fixed.</p>\n\n<p>A simple 2 table scenario:\nI have 2 tables. Let's call them Orders and Items. Order has a Primary key of OrderId and Items has a Primary Key of ItemId. Items.OrderId  is the foreign key to identify the parent Order. An Order can have 1 to n Items.</p>\n\n<p>I want to be able to provide a very flexible \"query builder\" type interface to the user to allow the user to select what Items he want to see. The filter criteria can be based on fields from the Items table and/or from the parent Order table. If an Item meets the filter condition including and condition on the parent Order if one exists, the Item should be return in the query as well as the parent Order.</p>\n\n<p>Usually, I suppose, most people would construct a join between the Item table and the parent Order tables.  I would like to perform 2 separate queries instead. One to return all of the qualifying Items and the other to return all of the distinct parent Orders. The reason is two fold and you may or may not agree.</p>\n\n<p>The first reason is that I need to query all of the columns in the parent Order table and if I did a single query to join the Orders table to the Items table, I would be repoeating the Order information multiple times. Since there are typically a large number of items per Order, I'd like to avoid this because it would result in much more data being transfered to a fat client. Instead, as mentioned, I would like to return the two tables individually in a dataset and use the two tables within to populate a custom Order and child Items client objects. (I don't know enough about LINQ or Entity Framework yet. I build my objects by hand). The second reason I would like to return two tables instead of one is because I already have another procedure that returns all of the Items for a given OrderId along with the parent Order and I would like to use the same 2-table approach so that I could reuse the client code to populate my custom Order and Client objects from the 2 datatables returned.</p>\n\n<p>What I was hoping to do was this:</p>\n\n<p>Construct a dynamic SQL string on the Client which joins the orders table to the Items table and filters appropriate on each table as specified by the custom filter created on the Winform fat-client app. The SQL build on the client would have looked something like this:</p>\n\n<p>TempSQL = \"</p>\n\n<pre><code>INSERT INTO #ItemsToQuery\n   OrderId, ItemsId\nFROM\n   Orders, Items \nWHERE\n   Orders.OrderID = Items.OrderId AND\n   /* Some unpredictable Order filters go here */\n  AND\n   /* Some unpredictable Items filters go here */\n\"\n</code></pre>\n\n<p>Then, I would call a stored procedure, </p>\n\n<pre><code>CREATE PROCEDURE GetItemsAndOrders(@tempSql as text)\n   Execute (@tempSQL) --to create the #ItemsToQuery table\n\nSELECT * FROM Items WHERE Items.ItemId IN (SELECT ItemId FROM #ItemsToQuery)\n\nSELECT * FROM Orders WHERE Orders.OrderId IN (SELECT DISTINCT OrderId FROM #ItemsToQuery)\n</code></pre>\n\n<p>The problem with this approach is that #ItemsToQuery table, since it was created by dynamic SQL, is inaccessible from the following 2 static SQLs and if I change the static SQLs to dynamic, no results are passed back to the fat client.</p>\n\n<p>3 around come to mind but I'm look for a better one:</p>\n\n<p>1) The first SQL could be performed by executing the dynamically constructed SQL from the client. The results could then be passed as a table to a modified version of the above stored procedure. I am familiar with passing table data as XML. If I did this, the stored proc could then insert the data into a temporary table using a static SQL that, because it was created by dynamic SQL, could then be queried without issue. (I could also investigate into passing the new Table type param instead of XML.) However, I would like to avoid passing up potentially large lists to a stored procedure.</p>\n\n<p>2) I could perform all the queries from the client. </p>\n\n<p>The first would be something like this:</p>\n\n<p>SELECT Items.* FROM Orders, Items WHERE Order.OrderId = Items.OrderId AND (dynamic filter)\nSELECT Orders.* FROM Orders, Items WHERE Order.OrderId = Items.OrderId AND (dynamic filter)</p>\n\n<p>This still provides me with the ability to reuse my client sided object-population code because the Orders and Items continue to be returned in two different tables.</p>\n\n<p>I have a feeling to, that I might have some options using a Table data type within my stored proc, but that is also new to me and I would appreciate a little bit of spoon feeding on that one.</p>\n\n<p>If you even scanned this far in what I wrote, I am surprised, but if so, I woul dappreciate any of your thoughts on how to accomplish this best.</p>\n"},{"tags":["sql-server","tsql","full-text-search","temporary-tables"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":660,"score":0,"question_id":4847057,"title":"TSQL - Optimizing Full Text Search query with temp table","body":"<p>To make it short I have a full text search query that does a company search on a single table.  Once the search is complete I pull extra stats from the result such as Top 5 titles, top 5 locations etc...</p>\n\n<p>How can this query be optimized it currently takes about 5 seconds to execute on &lt; 25,000 rows and based on the execution plan its mostly on the last 3 select statements.</p>\n\n<p>SQL SERVER: 2005.  I can upgrade to 2008 but I've heard there are more performance issues with SQL 2008.  </p>\n\n<p>Help is greatly appreciated.</p>\n\n<hr>\n\n<pre><code>CREATE PROCEDURE [usp_Company_Search]\n\n\n @KeywordNear as varchar(250),\n @LocationNear as varchar(250) = null,\n @PageIndex as int,\n @Pagesize as int\n\nAS\n\nBEGIN\n\nDECLARE @tbl TABLE\n(\n row int,\n [Rank] int,\n CompanyID int,\n CompanyDesc  text,\n Title nvarchar(150),\n Company nvarchar(150),\n Category nvarchar(50),\n Source nvarchar(50),\n URI nvarchar(250),\n Location varchar(60),\n DateCreated nvarchar(50)\n)\n\n IF (@LocationNear is not null) BEGIN\n\n  WITH CompanySearch as \n   (\n    SELECT ROW_NUMBER() OVER (ORDER BY rs.rank desc) as row,\n      rs.Rank as [Rank], \n      J.CompanyID,\n      J.CompanyDesc, \n      J.Title, \n      J.Company, \n      J.Category, \n      J.Source, \n      J.URI, \n      J.Location,\n      J.DateCreated\n    FROM Company J\n     INNER JOIN\n      CONTAINSTABLE (Company,RawStripped, @KeywordNear) rs\n      ON J.Companyid = rs.[KEY] AND\n      CONTAINS (Location, @LocationNear) \n   )\n\n    insert into @tbl select * from CompanySearch\n\n       SELECT\n     CompanySearch.[Rank], \n     CompanySearch.CompanyID,\n     CompanySearch.CompanyDesc, \n     CompanySearch.Title, \n     CompanySearch.Company, \n     CompanySearch.Category, \n     CompanySearch.Source, \n     CompanySearch.URI, \n     CompanySearch.Location,\n     CompanySearch.DateCreated\n    FROM @tbl as CompanySearch\n    WHERE CompanySearch.row between (@PageIndex - 1) * @PageSize + 1 and @PageIndex*@PageSize\n  END\n ELSE \n  BEGIN\n  WITH CompanySearch as \n    (\n     SELECT ROW_NUMBER() OVER (ORDER BY rs.rank desc) as row,\n       rs.Rank, \n       J.CompanyID,\n       J.CompanyDesc, \n       J.Title, \n       J.Company, \n       J.Category, \n       J.Source, \n       J.URI, \n       J.Location,\n       J.DateCreated\n     FROM Company J\n      INNER JOIN\n       CONTAINSTABLE (Company,RawStripped, @KeywordNear) rs\n       ON J.Companyid = rs.[KEY] \n    )\n\n    insert into @tbl select * from CompanySearch\n\n        SELECT\n      CompanySearch.Rank, \n      CompanySearch.CompanyID,\n      CompanySearch.CompanyDesc, \n      CompanySearch.Title, \n      CompanySearch.Company, \n      CompanySearch.Category, \n      CompanySearch.Source, \n      CompanySearch.URI, \n      CompanySearch.Location,\n      CompanySearch.DateCreated\n     FROM @tbl as CompanySearch\n     WHERE CompanySearch.row between (@PageIndex - 1) * @PageSize + 1 and @PageIndex*@PageSize\n\n END\n\n   SELECT Max(row) as RecordCount from @tbl\n   select top 5 title, count(title) as cnt from @tbl group by title order by cnt desc\n   SELECT top 5 Location, count(location) as cnt from @tbl group by location order by cnt desc\n   SELECT top 5 Company, count(company) as cnt from @tbl group by company order by cnt desc\n\n\nEND\n</code></pre>\n"},{"tags":["sql","tsql","cursor"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12946273,"title":"How to use a SQL cursor to eliminate empty rows in a table","body":"<p>I am new to using cursors and I am a little confused. Can someone help me out or possibly provide an example for the following scenario?</p>\n\n<p>I have a table containing about 10 fields. Some of the fields will be optional. So all 10 fields will not always be filled. I want to write some code that makes the empty spaces go away if they are not populated and leave me with just the populated fields.\nCan anyone help me with this? </p>\n"},{"tags":["sql","sql-server","tsql","temporary-tables"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":64,"score":-1,"question_id":12966555,"title":"Couldn't create temp table from select query if result empty","body":"<p>I want to crate a temp table from select query (My table has many columns, therefore I don't want to create the temp table manually)\nI use the following query:</p>\n\n<pre><code>SELECT * INTO #TempTable\nFROM MyTable\nWHERE ...\n</code></pre>\n\n<p>If this query return empty rows, it won't create <code>#TempTable</code>. Hence, I cannot use this <code>#TempTable</code> for the next queries.</p>\n\n<p>Is there a way to resolve this?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12702524,"title":"unable to drop and create database in sql server","body":"<p>I'm working with SQL Server 2008 and I can't seem to do drop and create a database.</p>\n\n<p>I've tried a few different ways but I always end up failing to drop or trying to \"use\" before it seems to be created.</p>\n\n<p>My current attempt looks like this.</p>\n\n<pre><code>use master;\nGO\nIF EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = N'test')\nBEGIN\nDROP DATABASE [test];\nEND\nGO\nCREATE DATABASE [test];\nGO\nuse [test];\nGO\n</code></pre>\n\n<p>The <code>GO</code> were suggested on a MS forum as a way to stop some issues that occur when selecting databases.</p>\n\n<p>With this I currently get the output (with a ore existing database of the same name) of:</p>\n\n<blockquote>\n  <p>Msg 3702, Level 16, State 4, Line 3<br>\n  Cannot drop database \"test\" because it is currently in use.<br>\n  Msg 1801, Level 16, State 3, Line 1<br>\n  Database 'test' already exists. Choose a different database name.<br>\n  Msg 2714, Level 16, State 6, Line 2<br>\n  There is already an object named 'staff_type' in the database.</p>\n</blockquote>\n\n<p>With the last 2 lines repeated for every table in my database.</p>\n\n<p>I'm sure its a simple issues as its only 3 quick lines in MySQL so it cant be that hard in TSQL.</p>\n\n<p>As always, any help or suggestions would be amazing.</p>\n"},{"tags":["sql-server","tsql","sql-server-2005","declarative"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12965114,"title":"How can I do this without a cursor or loop?","body":"<p>I hear to use Declarative programming but I have no idea how to do something like this in sql server 2005\n(I typed this up really fast so I'm not sure if all the syntax is correct but I think you'll understand what I'm looking for)</p>\n\n<pre><code>declare curs cursor for\nselect @Name, @Description, @Id FROM TableA\nopen curs\nwhile(1=1) \nbegin\n    fetch next from curs into\n        @Name,\n        @Description,\n        @Id\n    if(@@fetch_status&lt;&gt;0) break\n\n    set @recordCount = (SELECT COUNT(*) As RecordCount FROM Class1 WHERE          \n            Class1Id = @Id)\n    if(@recordCount &gt; 0)\n    begin\n\n        if(@Name = 'BAD NAME') CONTINUE\n        UPDATE Class1 SET \n            Name = @Name\n            , Description = @Description\n            WHERE Class1Id = @Id\n    end\n    else\n    begin\n        INSERT INTO Class1 (Class1Id, Name, Description)\n        VALUES (@Id, @Name, @Description)\n    end\n\nend\nclose curs\ndeallocate curs\n</code></pre>\n"},{"tags":["tsql","join","aggregate","monthcalendar"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":42,"score":2,"question_id":12944473,"title":"Join and aggregate on two columns - for every month even months with no data?","body":"<p>Using SQL Server 2005.</p>\n\n<p>I have a table with calendar months</p>\n\n<pre><code>Month,  fiscalorder\njune,1\njuly,2\n..\nmay,12\n</code></pre>\n\n<p>And another table with employees and a repeating monthly amount</p>\n\n<pre><code>employee, month, amount\njohn, july, 10\njohn, july, 3\njohn, august,2\nmary, june, 2\nmary, feb, 5\n</code></pre>\n\n<p>I need to join and aggregate these by month, but every month (even months without data) to report for every employe, but employee then fiscal order.</p>\n\n<p>Output:</p>\n\n<pre><code>june, john, 0\njuly, john, 13\naugust,john,2\nsept, john, 0\n..\njune,mary,2\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":12964932,"title":"Odd SQL Results","body":"<p>So i have the following query</p>\n\n<pre><code>Select id, [First], [Last] , [Business] as contactbusiness, (Case When ([Business] != '' or [Business] is not null) \n        Then [Business] Else 'No Phone Number' END) from contacts\n</code></pre>\n\n<p>The results look like</p>\n\n<pre><code>id  First   Last    contactbusiness (No column name)\n2   John    Smith       \n3   Sarah   Jane    0411 111 222    0411 111 222\n6   John    Smith   0411 111 111    0411 111 111\n8                   NULL            No Phone Number\n11  Ryan    B       08 9999 9999    08 9999 9999\n14  David   F       NULL            No Phone Number\n</code></pre>\n\n<p>I'd expect record 2 to also show No Phone Number</p>\n\n<p>If i change the \"[Business] is not null\" to [Business] != null then i get the correct results </p>\n\n<pre><code>id  First   Last    contactbusiness (No column name)\n2   John    Smith                   No Phone Number\n3   Sarah   Jane    0411 111 222    0411 111 222\n6   John    Smith   0411 111 111    0411 111 111\n8                   NULL            No Phone Number\n11  Ryan    B       08 9999 9999    08 9999 9999\n14  David   F       NULL            No Phone Number\n</code></pre>\n\n<p>Normally you need to use is not null rather than != null. whats going on here?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12963698,"title":"How to round a SQL time variable?","body":"<p>I have declared a time variable with value 23:59:59. So, I need to round it to 24:00. Have you any idea?</p>\n\n<pre><code>declare @t1 time = '23:59:59'\n</code></pre>\n\n<p>This is necessary only in the select statement. I know that time cannot be inserted as 24:00.</p>\n\n<p><a href=\"http://msdn.microsoft.com/en-us/library/bb677243(v=sql.105).aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/bb677243(v=sql.105).aspx</a></p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12964650,"title":"can you join on a stored procedure?","body":"<p>I have a bunch of <code>WITH</code> statements:</p>\n\n<pre><code>;with OneAccession as (\n        select client_id,COUNT(patient_id) PatientCount from\n        (\n            select client_id,patient_id\n            from F_ACCESSION_DAILY\n            group by CLIENT_ID,PATIENT_ID\n            having COUNT(ACCESSION_ID)=1\n        ) a\n        group by CLIENT_ID\n    )\n    ,\n\n    TwoAccessions as (\n    select client_id,COUNT(patient_id) PatientCount from\n        (\n            select client_id,patient_id\n            from F_ACCESSION_DAILY\n            group by CLIENT_ID,PATIENT_ID\n            having COUNT(ACCESSION_ID)=2\n        ) a\n    group by client_id\n    )\n\n    ,\n\n    ThreeAccessions as (\n    select client_id,COUNT(patient_id) PatientCount from\n    (\n        select client_id,patient_id\n        from F_ACCESSION_DAILY\n        group by CLIENT_ID,PATIENT_ID\n        having COUNT(ACCESSION_ID)=3\n    ) a\n    group by client_id\n    )\netc\n</code></pre>\n\n<p>And I join these statements on </p>\n\n<pre><code>select * from myTable\njoin OneAccession\non...\njoin TwoACcessions\non...\njoin ThreeAccessions\n</code></pre>\n\n<p>Instead of having all those <code>with</code> statements, can i just create a stored proc? I would just pass the value of <code>having count(accession_id)=**@myParam**</code> and do this:</p>\n\n<pre><code>select * from myTable\njoin storedproc(1)\non...\njoin storedproc(2)\non...\netc...\n</code></pre>\n\n<p><strong>Is there an issue on joining on a stored Proc?</strong> Is my methodology OK?</p>\n"},{"tags":["tsql","date","group","ranges"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":66,"score":4,"question_id":12938904,"title":"Grouping on a column which has multiple Groups of Duplicate data","body":"<p>I need to group some data based on dates at locations including identifying when a range of dates has no location.  I'm some of the way there in that I have managed to produce a list of ALL the dates in the range and the location.</p>\n\n<ul>\n<li>date1   location1</li>\n<li>date2   location1</li>\n<li>date3   location1</li>\n<li>date4   Unknown</li>\n<li>date5   Unknown</li>\n<li>date6   Unknown</li>\n<li>date7   Location2</li>\n<li>date8   Location2</li>\n<li>date9   Location2</li>\n<li>date10  Location2</li>\n<li>date11  location1</li>\n<li>date12  location1</li>\n<li>date13  location1</li>\n</ul>\n\n<p>using a normal group by (showing min(date) and max(date) I would get something like:</p>\n\n<ul>\n<li>Location1,date1,date13</li>\n<li>Location2,date7,date10</li>\n<li>Unknown,  date4,date6</li>\n</ul>\n\n<p>But I want this:</p>\n\n<ul>\n<li>Location1,date1,date3</li>\n<li>Unknown,date4,date6</li>\n<li>Location2,date7,date9</li>\n<li>Location1,date11,date13</li>\n</ul>\n\n<p>I also need to filter out short ranges of Unknown but that's secondary.</p>\n\n<p>I hope this makes sense, it looks like something that should be really easy.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":346,"score":0,"question_id":1705086,"title":"Set below query into asc or desc order?","body":"<pre><code>SELECT * FROM (SELECT ROW_NUMBER()\nover\n     (\n        ORDER BY\n          CASE WHEN @SortExpression ='Country_id' THEN Country_id END,\n          CASE WHEN @SortExpression ='Country_name' THEN Country_name END,\n          CASE WHEN @SortExpression ='Country_region' THEN Country_region END,\n          CASE WHEN @SortExpression ='Country_area' THEN Country_area END,\n          CASE WHEN @SortExpression ='Country_Population' THEN Country_Population END,\n        CASE WHEN @SortExpression ='Country_gdp' THEN Country_gdp END\n     )as num ,* From Country_Profile123 ) as tbl\n      WHERE num BETWEEN @column AND @column1\n</code></pre>\n\n<p>I solved half of the problem (that is the paging and sorting), what I'm trying to do now is the sorting order.</p>\n"},{"tags":["tsql","sql-server-2005","distinct","max"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":1,"view_count":53,"score":2,"question_id":12962473,"title":"How do I display all columns from a table while using SELECT DISTINCT & MAX(ID) to remove duplicates?","body":"<p>I have a table that, in some instances, has more than one entry for the same employee.</p>\n\n<p>I only want the employee record with the highest ID.</p>\n\n<p>Example of table structure &amp; data</p>\n\n<pre><code>ID  FirstName   LastName    Initials    AreaID  SupervisorID    Forms   JobClass    JobTitle\n----------------------------------------------------------------------------------------    \n805/    Trey/   W/  TW/ 93/ 404/    99/NA/  Temporary/ R1_Temp\n752/    Trey/   W/  TW/ 93/ 404/    99/NA/  Temporary/ R1_Temp \n399/    Ron/    V/  RV/ 144/    NULL/   99/NULL/    NULL/   NULL\n374/    Ron/    V/  RV/ 94/ NULL/   99/NULL/    NULL/   NULL\n379/    Ron/    V/  NULL/   0/  NULL/   99/NULL/    NULL/   NULL\n378/    Dax/    T/  NULL/   0/  NULL/   40/NULL/    NULL/   NULL\n373/    Dax/    T/  DT/ 94/ NULL/   40/NULL/    NULL/   NULL\n398/    Dax/    T/  DT/ 94/ 276/    99/NULL/    NULL/   NULL\n</code></pre>\n\n<p>As you can see, there are three entries for Ron V.  </p>\n\n<p>There are currently ~1000 entries (including duplicates).  The query below returns ~700 (excluding duplicates), which is correct.</p>\n\n<pre><code>SELECT DISTINCT LastName, MAX(ID) as ID\nFROM Employees GROUP BY LastName \norder by LastName DESC\n</code></pre>\n\n<p>This only returns the ID and LastName.  We need to return all the values in the table above.  How do I do it in a single query?</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":5,"down_vote_count":0,"view_count":94,"score":5,"question_id":12958536,"title":"T-SQL ORDER BY according to a condition","body":"<p>I am writing some sort of resources management system.</p>\n\n<p>A resource is an instance of a definition. A definition is the  metadata, basically it contains the properties.</p>\n\n<p>This is in general my DB:</p>\n\n<pre><code>TypeDefinition\nid    name\n===============\n1     CPU\n\n\nPropertyDefinition\nid    name       typeDefinitionId   valueType\n================================================\n1     frequency  1                  int\n2     status     1                  string\n\n\nTypeInstance\nid    name     typeDefinitionId\n=================================\n1     CPU#1    1  \n2     CPU#2    1\n\n\nPropertyInstanceValue\nid   propertyDefinitionId  typeInstanceId   valueType   intValue  StringValue FloatValue\n========================================================================================\n1    1                     1                int         10\n2    2                     1                string                Pending\n3    1                     2                int         20\n4    2                     2                string                Approved\n</code></pre>\n\n<p><em><strong>REQUIREMENT:</em></strong></p>\n\n<p>order all resources according to a <strong>specific property value</strong>.</p>\n\n<p>For example:  order all resources according to their <strong>status</strong> --> Meaning CPU#2 will appear before CPU#1 because Approved is before Pending.</p>\n\n<p>If we were to order according to <strong>frequency</strong>, CPU#1 will appear before CPU#2 because 10 is before 20.</p>\n\n<p>So I need to sort each time according to a different column (intValue / stringValue/ FloatValue / etc), depending on the property's valueType.</p>\n\n<p>Any suggestion?</p>\n\n<p><em><strong>LIMITATION:</em></strong></p>\n\n<p>PIVOT is currently the only option we've thought of, but it's not really possible since the DB is huge and I need the query to be as fast as possible.</p>\n\n<p>Thanks a lot in advance,</p>\n\n<p>Michal.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12962057,"title":"SQL Query relationship coding","body":"<p>Need some help making this work please.  Some help please to ensure I always return just one row per <strong>ProductID</strong>. My Product Table contains base information on Products which can be properties in this case.  It links to the Properties table via a ProductCode. </p>\n\n<p>What I would like is to have the query return just the one row which it really should. Essentially, the row should display the PropertyLabel whether or not there are values in the PropertyProductValues table for that particular propertyLabel. The code below returns a bunch of rows which really it shouldn't, or I don't want it to. And I would appreciate help fine tuning this please. thanks in Advance. </p>\n\n<pre><code>Create Table Product \n{\n    ProductID uniqueidentifier, \n    ProductName Varchar(50),\n    ProductCode Varchar(50)\n\n}\n\nCreate Table Properties\n{\n     PropertyID uniqueidentifier, \n     PropertyProductcode Varchar(50)\n\n}\n\nCreate Table PropertyProductValues\n{\n    ID uniqueidentifier,\n    PropertyID  uniqueidentifier,\n    ProductID    uniqueidentifier,\n    PropertyLabel Varchar(50),\n    UnitID uniqueidentifier\n\n}\n\nCreate Table unit\n{\n    UnitID uniqueidentifier,\n    Unit Varchar(50)\n}\n\n   Select productid , PropertyLabel\nPropertyValue\nPropertyUnit \nfrom Product \ninner join Properties on ProductCode =  PropertyProductCode\nleft join PropertyProductValues on Properties.PropertyID = ProductProductValues.PropertyID \nleft join Unit on PropertyValues.UnitID = Unit.UnitID\n    Where ltrim(rtrim(lower(PropertyLabel))) = lower('Special')\n</code></pre>\n\n<h2>Sample Data</h2>\n\n<pre><code>Product Table \nb0359c76-8622-4006-82f2-1b4c91a8f6b3   Brown Building   YSHJT\naba475c4-5a5c-483a-9faa-67f67ff9672d   Sket Building       GTJHD54\n8f645348-8871-4fad-8c85-9fc6a1169b33    HOUSE 9           DGFS345\n\n\nProperties Table\n\n27c6485b-f7a5-4243-9304-71939230964d     DGFS345\n88e911e5-bf40-4f14-89cc-4ed2984c342e     GTJHD54\nd217cc14-6fcb-4251-a6d7-8fd1b3398a32      YSHJT\n689cfd9d-bc87-4e23-afb3-d6cbf1e961f6       FFFSRW\nbf7ae151-2e3f-4e0a-bf8b-d44ef30cf276        WYSJD\n\nPropertyProductValues Table\n\n6cf47434-c834-455d-a606-3d10cb9f7ab3       b0359c76-8622-4006-82f2-1b4c91a8f6b3    b0359c76-8622-4006-82f2-1b4c91a8f6b3       Storey           \n82ee0f80-afe4-45c2-877c-e79ce286170f         27c6485b-f7a5-4243-9304-71939230964d   b0359c76-8622-4006-82f2-1b4c91a8f6b3       Bedrooms     \n5ff7f809-6b1f-4d6c-a125-29ce67f097d7         27c6485b-f7a5-4243-9304-71939230964d    8f645348-8871-4fad-8c85-9fc6a1169b33        Bathrooms\n7f634b81-1212-4223-af42-29b4dc2bafcc         27c6485b-f7a5-4243-9304-71939230964d     aba475c4-5a5c-483a-9faa-67f67ff9672d        Material\ncae10884-edf0-4340-bde6-5207e28a07cc         689cfd9d-bc87-4e23-afb3-d6cbf1e961f6         b0359c76-8622-4006-82f2-1b4c91a8f6b3      Basement\n83943759-39d7-406e-92ea-4202a9b1d716        bf7ae151-2e3f-4e0a-bf8b-d44ef30cf276         b0359c76-8622-4006-82f2-1b4c91a8f6b3      Storey\nc045d0ff-34db-4427-9fb7-fd41fc92f310          bf7ae151-2e3f-4e0a-bf8b-d44ef30cf276         aba475c4-5a5c-483a-9faa-67f67ff9672d         balcony\n\nUnit Table \n\nUNITID                                       UNIT\n3a4a5216-0704-495e-b0a7-560787e0847a         kg\n6b4493f6-c2e4-4682-b71d-93cb1893eb73          m\n2f2b4fee-9e69-4a71-a098-36e2da71471e          l\n55c8e5bf-edde-4977-ab7b-8827e337a31e          oz\n19528647-bd9f-48e0-ba86-b722d5b8ab0e          cm\ncee5cd46-1ae4-4b49-8b1c-9b3e0bd5270f          mm\n</code></pre>\n"},{"tags":["sql-server","performance","sql-server-2008","tsql","insert"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":120,"score":1,"question_id":12956286,"title":"Optimal insert/update batch for SQL Server","body":"<p>I'm making frequent inserts and updates in large batches from c# code and I need to do it as fast as possible, please help me find all ways to speed up this process.</p>\n\n<ol>\n<li>Build command text using <code>StringBuilder</code>, separate statements with <code>;</code> </li>\n<li>Don't use <code>String.Format</code> or <code>StringBuilder.AppendFormat</code>, it's slower then multiple <code>StringBuilder.Append</code> calls</li>\n<li>Reuse <code>SqlCommand</code> and <code>SqlConnection</code></li>\n<li>Don't use <code>SqlParameter</code>s (limits batch size)</li>\n<li>Use <code>insert into table values(..),values(..),values(..)</code> syntax (1000 rows per statement)</li>\n<li>Use as few indexes and constraints as possible</li>\n<li>Use simple recovery model if possible</li>\n<li>?</li>\n</ol>\n\n<p>Here are questions to help update the list above</p>\n\n<ol>\n<li>What is optimal number of statements per command (per one <code>ExecuteNonQuery()</code> call)?</li>\n<li>Is it good to have inserts and updates in the same batch, or it is better to execute them separately?</li>\n</ol>\n\n<p>My data is being received by tcp, so please don't suggest any Bulk Insert commands that involve reading data from file or external table. </p>\n\n<p>Insert/Update statements rate is about 10/3.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":49,"score":2,"question_id":10179127,"title":"Non-dynamic approach to do a series of union statements on table value function tvf","body":"<p>I have a table valued function that returns some details about a specific account.  Something like this.  Far more complex but you get the idea.  It's a multi line TVF if that makes a difference (not an inline statement)</p>\n\n<pre><code>select * from dbo.TBFDetailsByAccountKey(1234)\n\n-----------------------------------------------\ndate       |    amount    |     detail        |\n-----------------------------------------------\n4/1/2012   |    10.23     |  payment stuff    |\n4/2/2012   |    12.40     |  other stuff      |\n4/2/2012   |    14.23     |  second pmt today |\n</code></pre>\n\n<p>I now have need to call this same TVF repeatedly in a series of UNION ALL statements in order to return the details for all the account key's contained within a set of deposits.  Is there a way to do this without resorting to dynamic sql?</p>\n\n<p>My current approach is this... but it uses dynamic sql and I keep thinking there should be a better \"non dynamic\" way.</p>\n\n<pre><code>DECLARE @pResult varchar(max)\n\nSELECT @pResult = COALESCE(@pResult + ' UNION ALL ', '') + \n        'SELECT * FROM dbo.TBFDetailsByAccountKey(' + \n        Cast(AccountKey AS VarChar(25)) + ')'\n    FROM Account WHERE DepositKey = @pDepositKey\n\nEXEC(@pResult)  /* execute dynamic sql created above */\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":3,"view_count":64,"score":-3,"question_id":12960299,"title":"How can one use T-SQL to select only those rows that have column B Value not greater than the next greater values in column A?","body":"<pre><code>A     B\n1     2\n1     1\n1     3\n1     4\n3     3\n3     4\n4     5\n</code></pre>\n\n<p>How can one use T-SQL to select only those rows that have column B value not greater than the next greater values in column A?</p>\n\n<p>For example, if above table is the input, the output should be as follows;</p>\n\n<pre><code>A     B\n1     2\n1     1\n3     3\n4     5\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":58,"score":0,"question_id":12945306,"title":"How to return a sql result based on values in a boolean column","body":"<p>Here's the scenario. I have a single SQL Server 2008 table - Products - with 2 columns: id  and IsNotValid. The data would look something like this:</p>\n\n<pre><code>id     IsNotValid\n1        0\n1        0\n1        1\n2        0\n2        0\n3        1\n3        1\n</code></pre>\n\n<p>I would like a SQL statement that would return a result set that would return all the records (2) for the id=2 - in this case all the IsNotValid values for id=2 is 0. id=1 should not be returned as one of its IsNotValid records is 1. Similar for id=3. The data types are: id (int), IsNotValid (bit).</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":1886,"score":1,"question_id":3241801,"title":"How to create duplicate table with new name in SQL Server 2008","body":"<p>How do I create a duplicate table with only the structure duplicated with a new name in SQL server 2008?</p>\n\n<p>I have table with 45 fields so I want to create new with same structure but new name.</p>\n"},{"tags":["sql-server","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":88,"score":1,"question_id":12959281,"title":"SQL Server partitioning monthly data by weeks and calculating weekly weighted average based on month days of that week belong to","body":"<p>I have a table like this:</p>\n\n<pre><code>Month          Value\n2012-08-01      0.345\n2012-09-01      0.543\n2012-10-01      0.321\n2012-11-01      0.234\n2012-12-01      0.234\n</code></pre>\n\n<p>User inputs week range from '2012-09-29' to '2012-10-13'\nOutput should show results for all weeks in requested range and average values for each week with the following logic:\n - if all weekdays are entirely in one month, just use monthly value for that month\n - if weekdays are spread out over two months, calculate weekly value as average between those two months giving preference to the month that contains the most days of that week.</p>\n\n<p>If someone can give me an idea how to do something like this in T-SQL that would be highly appreciated.</p>\n"},{"tags":["c#","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12954872,"title":"T-SQL Select statement returns zero rows when using IN","body":"<p>I'm having some trouble with a t-sql select query in C#. The query is as follows:</p>\n\n<pre><code>@\"SELECT * FROM \n (SELECT *, ROW_NUMBER() OVER (ORDER BY id) as row_number\n FROM [mytable]) t0\n WHERE row_number BETWEEN @skip and @take\n AND\n uploadDate IN (@years) \n AND NOT photoId IN (@shownPhotos) \n ORDER BY NEWID()\";\n\ncmd.Parameters.Add(\"@skip\", SqlDbType.Int).Value = skip;\ncmd.Parameters.Add(\"@take\", SqlDbType.Int).Value = take;\ncmd.Parameters.Add(\"@shownPhotos\", SqlDbType.VarChar).Value = shownPhotos;\ncmd.Parameters.Add(\"@years\", SqlDbType.VarChar).Value = years;\n</code></pre>\n\n<p>The method takes four parameters: skip count, take count, shownPhotos (commaseparated string which contains photo ids), years (comma separated string which contains the years to show the photos from)</p>\n\n<p>So basically I want it to return photos from my database which matches any of the years from the commaseparated string and which are not already shown.</p>\n\n<p>The problem (I think) is that my parameters are strings, so they are intepreted as '1234,567,890' and '2011,2012'. When running the query in the SQL server management tool without the 's it works fine.</p>\n\n<p>Anyone got a workaround for this? :-)</p>\n\n<p>Thanks a lot in advance!</p>\n\n<p><strong>Updated code:</strong></p>\n\n<pre><code>// Create datatables\n            DataTable yearsTable = new DataTable();\n            yearsTable.Columns.Add(\"YearID\", typeof(string));\n            yearsTable.Columns.Add(\"Year\", typeof(string));\n\n            foreach(string year in years.Split(','))\n                yearsTable.Rows.Add(new object[] { year, year });\n\n            using (var conn = new SqlConnection(GlobalSettings.DbDSN))\n            {\n                conn.Open();\n                using (var cmd = conn.CreateCommand())\n                {\n                    cmd.CommandType = CommandType.Text;\n                    cmd.CommandText =\n                        @\"SELECT * FROM \n                          (SELECT *, ROW_NUMBER() OVER (ORDER BY id) as row_number\n                          FROM [mytable]) t0\n                          WHERE row_number BETWEEN @skip and @take\n                          AND\n                          uploadedDate IN (@years)                               \n                          ORDER BY NEWID()\";\n\n                    SqlParameter skipParam = cmd.Parameters.AddWithValue(\"@skip\", skip);\n                    skipParam.SqlDbType = SqlDbType.Int;\n\n                    SqlParameter takeParam = cmd.Parameters.AddWithValue(\"@take\", take);\n                    takeParam.SqlDbType = SqlDbType.Int;\n\n                    SqlParameter yearsParam = cmd.Parameters.AddWithValue(\"@years\", yearsTable);\n                    yearsParam.SqlDbType = SqlDbType.Structured;\n                    yearsParam.TypeName = \"dbo.MyTableType\";\n\n\n                    var reader = cmd.ExecuteReader();                        \n                }\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","optimization","where"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":86,"score":1,"question_id":12955547,"title":"TSQL Optimization - WHERE clause without LIKE","body":"<p>What is the most optimized solution for this situation:</p>\n\n<p>WHERE clause of my query is like this:</p>\n\n<pre><code>WHERE columnX LIKE @Account + '%'\n</code></pre>\n\n<p>I use '%' because @Account could be ' ' and in that case I want to get all values. In all other cases I could use equals (=).</p>\n\n<p>This solution is not optimized because I have index on columnX and I would like to use equals (=) because of that.  Also, solution with OR is not acceptable because of performance. </p>\n\n<p>Do you have some other recommendation? I tried with CASE in WHERE clause, but didn't find good solution that is optimized. Our compatibility level is 80, so cannot use newer syntax. (don't ask why :-) )</p>\n\n<p>TnX in advance! </p>\n\n<p>Nemanja</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":68,"score":3,"question_id":12955823,"title":"How to get user from transaction log file In SQL Server (.ldf file) without app like ApexSqlLog","body":"<p>How I can get the user from transaction log file in SQL Server?</p>\n\n<p>I tried this query but it isn't giving me the right user</p>\n\n<pre><code>SELECT \nCASE \n  WHEN (SELECT NAME \n          FROM SYS.SERVER_PRINCIPALS lgn \n         WHERE Rtrim(lgn.SID) = Rtrim(log2.[TRANSACTION SID])) IS NOT \n       NULL THEN \n  'login: ' \n+ Upper((SELECT NAME FROM SYS.SERVER_PRINCIPALS lgn WHERE Rtrim(lgn.SID) \n  = Rtrim \n(log2.[TRANSACTION SID]))) \n  ELSE 'db user: ' \n       + Upper((SELECT NAME FROM SYS.SERVER_PRINCIPALS lgn WHERE Rtrim( \n       lgn.SID) \n       = Rtrim(log2.[TRANSACTION SID] ))) \nEND \nAS 'Login_or_User', \nlog1.*, \nCASE log1.__$OPERATION \n  WHEN 1 THEN 'DELETE' \n  WHEN 2 THEN 'INSERT' \n  WHEN 4 THEN 'UPDATED VALUE' \n  WHEN 3 THEN 'PREVIOUS UPDATED VALUE' \n  ELSE NULL \nEND \nAS operation, \nCONVERT(VARCHAR(19), log2.[BEGIN TIME])                                                                                                                 AS 'Begin Time',\nLEFT(log.ALLOCUNITNAME, Charindex('.', log.ALLOCUNITNAME) - 1) \nAS 'Schema', \nLEFT(RIGHT(log.ALLOCUNITNAME, Len(log.ALLOCUNITNAME) - \n                                   Charindex('.', log.ALLOCUNITNAME)), \nCharindex('.', RIGHT(log.ALLOCUNITNAME, \nLen(log.ALLOCUNITNAME) \n- \n                                                                                                               Charindex('.', log.ALLOCUNITNAME))) - 1) AS 'Object',\nSYS.Fn_cdc_hexstrtobin(Substring(log.[CURRENT LSN], 1, 8) \n                       + Substring(log.[CURRENT LSN], 10, 8) \n                       + \nSubstring(log.[CURRENT LSN], 19, 4))                                                                                           currentlsn\n  FROM DBO.TEMPTABLE log1 \n       LEFT JOIN ::FN_DBLOG(NULL, NULL) log \n              ON log1.__$SEQVAL = SYS.Fn_cdc_hexstrtobin( \n                                  Substring(log.[CURRENT LSN], 1, 8) \n                                  + Substring(log.[CURRENT LSN], 10, 8) \n                                  + Substring(log.[CURRENT LSN], 19, 4)) \n       LEFT JOIN ::FN_DBLOG(NULL, NULL)log2 \n              ON log.[TRANSACTION ID] = log2.[TRANSACTION ID] \n       LEFT JOIN SYS.ALLOCATION_UNITS au \n              ON log.ALLOCUNITID = au.ALLOCATION_UNIT_ID \n       LEFT JOIN SYS.PARTITIONS p \n              ON p.PARTITION_ID = au.CONTAINER_ID \n       LEFT JOIN SYS.OBJECTS so \n              ON so.OBJECT_ID = p.OBJECT_ID \n       LEFT JOIN SYS.SERVER_PRINCIPALS spa \n              ON spa.SID = log2.[TRANSACTION ID] \n</code></pre>\n\n<p>This Code For Checking Database That Has CDC(CHange Data Capture) Enabled Then Choose Specific Table To Get The Changes On it </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":9,"favorite_count":11,"up_vote_count":20,"down_vote_count":0,"view_count":16123,"score":20,"question_id":483193,"title":"How can I list all foreign keys referencing a given table in SQL Server 2005?","body":"<p>I need to remove a highly referenced table in a SQL Server database.  How can I get a list of all the foreign key constraints I will need to remove in order to drop the table?</p>\n\n<p>(SQL answers preferable over clicking about in the GUI of the management studio.)</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":29,"score":1,"question_id":12955560,"title":"Explicitly constraint drop not using the name","body":"<pre><code>CREATE TABLE [dbo].[tmp_rg_xx_LBJ]\n(\n[ROWVERSION] [bigint] NULL,\n[ROWDATE] [datetime] NULL,\n[SAPNO] [int] NOT NULL DEFAULT 1)\n\n\nIF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF__tmp_rg_xx__SAPNO__1B0907CE]') AND type = 'D')\nBEGIN\nALTER TABLE [dbo].[LBJ] DROP CONSTRAINT [DF__tmp_rg_xx__SAPNO__1B0907CE]\nEND\n\nGO\n</code></pre>\n\n<p>I have a script that creates a table with a default in, but I want to drop the constraint. No problem manually as I know the name, except I want drop the constraint after recreating the table. So I can just re run the drop constraint script. How do you do this without explicitly using the name?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":4,"down_vote_count":0,"view_count":58,"score":4,"question_id":12954232,"title":"TSQL Split single row across rows","body":"<p>Given a Promotion table with rows and data such as</p>\n\n<pre><code>PromotionId    Codes\n1              a,b\n2              c\n3              d,e,f\n</code></pre>\n\n<p>How could I write a query to return it like</p>\n\n<pre><code>PromotionId    Codes\n1              a\n1              b\n2              c\n3              d\n3              e\n3              f\n</code></pre>\n\n<p>Basically I want to string split the Code over multiple rows.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":104,"score":0,"question_id":12954082,"title":"Invalid column name: SQL Server 2008 R2","body":"<p>I have a stored procedure I use to extract binary data from SQL tables to create physical files. I have used it a couple of times on tables with the same structure restored from SQL backups, and it works OK. </p>\n\n<p>Today I wanted to extract some binary data from a new table inside a restored backup. I opened the stored procedure I have been using and set about altering the code. Once I was happy with the changes I tried to execute the 'ALTER' statement. Unfortunetly, both of the column names I have used are 'invalid' despite existing on the the 'Document' table.</p>\n\n<p>I have read a number of other threads regarding 'invalid column name' errors, but the majority of these seem to be typing errors. I've checked my column names numurous times (intelli sense even lets me put in 'Document.Document_ID' and 'Document.Document_Filename' but they still fail).</p>\n\n<p>Any ideas where I am going wrong?</p>\n\n<p>Source:</p>\n\n<pre><code>USE [Example Live]\nGO\n/****** Object:  StoredProcedure [dbo].[FileExport]    Script Date: 10/18/2012 11:42:14 ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n-- =============================================\n-- Author:      Chris Murray\n-- Create date: 18/10/2012\n-- Description: Exports binary file data\n-- =============================================\nALTER PROCEDURE [dbo].[FileExport] \n-- Add the parameters for the stored procedure here\n@OutputFilePath VARCHAR(500) = 'C:\\Conv\\Example\\In\\Afiles\\'\nAS\nBEGIN\n\n   DECLARE @totrow int\n   DECLARE @currow int\n   DECLARE @result int\n   DECLARE @nsql nvarchar(4000)\n\n   DECLARE @sqlStatements table (ID int IDENTITY(1, 1),  SqlStatement varchar(max))   \n\n   INSERT\n   INTO @sqlStatements\n   SELECT 'BCP \"SELECT Document_Data FROM [Example Live].[dbo].[Document] WHERE Document_ID = '''\n  + CAST(Document_ID AS VARCHAR(500)) + '''\" queryout ' + @OutputFilePath \n  + CAST(Document_Filename AS VARCHAR(500)) + ' -S localhost\\SQLEXPRESS2008 -T -f C:\\Conv\\Example\\In\\AFiles\\Images.fmt'\n   FROM dbo.Photograph  \n\n   SET @totrow = @@ROWCOUNT\n   SET @currow = 1\n   WHILE @totrow &gt; 0 and @currow &lt;= @totrow\n   BEGIN\n      SELECT @nsql = SqlStatement\n      FROM @sqlStatements\n      WHERE ID = @currow\n      EXEC @result = xp_cmdshell @nsql\n      SET @currow = @currow + 1\n   END\nEND\n</code></pre>\n"},{"tags":["asp.net","sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":75,"score":1,"question_id":11501063,"title":"ASP.NET connections with READ UNCOMMITTED","body":"<p>I have a web application and all of its queries begin with</p>\n\n<pre><code>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED\n</code></pre>\n\n<p>Is there any way to create all connections with this isolation level? Can I implement this to connection pool in web.config or somewehere else?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12946257,"title":"T-SQL - Scripting variable not defined","body":"<p>I'm new to <code>T-SQL</code> and I'm trying to backup my databases (using SQL Server 2008).</p>\n\n<p>When I try to run the script via <code>sqlcmd -i inputfile</code> I got this error messages:\n<code>'DATE' Scripting variable not defined</code>.</p>\n\n<p>The problem is I have a line like this:\n...<code>TO DISK = \"FileName_$(ESCAPE_NONE(DATE)).BAK\"</code> ...\nWith a date in a filename, it will prevent it from replacing my old backups.</p>\n\n<p>If I run it in management studio, it works, but if I run it in command line with the <code>sqlcmd -i</code> command, then it doesn't work.</p>\n\n<p><strong>EDIT:</strong>\n\n\n<p>I looked at the job history and I saw this error message:</p>\n\n<blockquote>\n  <blockquote>\n    <p>\"For SQL Server 2005 SP1 or later, you must use the appropriate ESCAPE_xxx\n    macro to update job steps containing tokens before the job can run\"</p>\n  </blockquote>\n</blockquote>\n\n<p>I don't quite understand what that means. I've already used <code>$ESCAPE_NONE(DATE)</code>, what's wrong?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12954302,"title":"How to select max Id from nested select?","body":"<p>I want to select max Id from nested select.</p>\n\n<p>Here is the my query:</p>\n\n<pre><code>select max(Id) from (SELECT TOP 100 Id FROM [MyTable]) t\n</code></pre>\n\n<p>This <em>select</em> should return 100, but it actually returns max id of <em>MyTable</em>.</p>\n\n<p>P.S. <em>MyTable</em> contains 100 000 records, so query returns 100 000. </p>\n\n<p><strong>Here is an Example:</strong></p>\n\n<p><em>returns 100 (It's ok)</em></p>\n\n<pre><code>SELECT TOP 100 Id FROM [MyTable]\n</code></pre>\n\n<p><em>returns 100 000, but I want to select max id of \"SELECT TOP 100 Id FROM [MyTable]\"</em></p>\n\n<pre><code>select max(Id) from (SELECT TOP 100 Id FROM [MyTable]) t\n</code></pre>\n\n<p><em>returns 100 000, but I want to select max id of \"SELECT TOP 100 Id FROM [MyTable] where Id > 100\"</em></p>\n\n<pre><code>select max(Id) from (SELECT TOP 100 Id FROM [MyTable] where Id &gt; 100) t\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","cursor"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12953321,"title":"Inconsistent results from TSQL cursor","body":"<p>I've got a query that uses a cursor to insert data into my database. The weird thing is that the query runs the 1st time ( SSMS > Execute ), but if I run it a second time, the part with the cursor does not execute. </p>\n\n<p>However - If i then hit 'debug' I can debug and the whole query executes just fine. Right after that it works just fine once more and then, again, only the first insert script executes.</p>\n\n<p>I tried the FAST_FORWARD as mentioned <a href=\"http://stackoverflow.com/questions/4048147/inconsistent-cursor-results-when-looping-over-databases\">here</a> but that doesn't seem to solve the problem. Any suggestions?</p>\n\n<pre><code>/** Declarations **************************************************/\nDECLARE @TemplateFileName varchar(200)\nDECLARE @TemplatePreviewFileName varchar(200)\nDECLARE @TemplateId int\nDECLARE @CompanyId int\nDECLARE CompanyCursor cursor FAST_FORWARD FOR SELECT [CmpId] from SetCompany\n/******************************************************************/\n\n/** Set template name here ****************************************/\nSET @TemplateFileName           = 'Template_2'\nSET @TemplatePreviewFileName    = 'Template_2'\n/******************************************************************/\n\n/******************************************************************/\nINSERT INTO ... etc\nSET @TemplateId = @@IDENTITY;\nOpen CompanyCursor\n\nWHILE @@FETCH_STATUS = 0\n    BEGIN       \n        IF(@CompanyId IS NOT NULL)\n        BEGIN\n            PRINT 'Adding template ' + @TemplateFileName + ' with id ' + convert(varchar, @TemplateId) + ' to company ' + convert(varchar, @CompanyId);\n            INSERT INTO .... etc\n            PRINT 'OK';\n        END\n        Fetch NEXT FROM CompanyCursor INTO @CompanyId\nEND\nCLOSE CompanyCursor;\nDEALLOCATE CompanyCursor;\n</code></pre>\n\n<p>Running the 'first' time, I get:</p>\n\n<pre><code>(1 row(s) affected)\nAdding template Template_2.frx with id 2272 to company 10\n\n(1 row(s) affected)\nOK\nAdding template Template_2.frx with id 2272 to company 11\n\n(1 row(s) affected)\nOK\nAdding template Template_2.frx with id 2272 to company 12\n\n(1 row(s) affected)\nOK\nAdding template Template_2.frx with id 2272 to company 13\n\n(1 row(s) affected)\nOK\nAdding template Template_2.frx with id 2272 to company 14\n\n(1 row(s) affected)\nOK\n</code></pre>\n\n<p>Second time, only this:</p>\n\n<pre><code>(1 row(s) affected)\n</code></pre>\n\n<p>And indeed, the insert inside the cursor did not run.</p>\n"},{"tags":["tsql","excel-2007","oledb","openrowset","isam"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":4224,"score":3,"question_id":8797978,"title":"How to resolve \"Could not find installable ISAM.\" error for OLE DB provider \"Microsoft.ACE.OLEDB.12.0\"","body":"<p>I am trying to import data from Excel 2007 (.xlsx) files into SQL Server 2008 using a T-SQL OpenRowset() command with the \"Microsoft.ACE.OLEDB.12.0\" OLE DB provider, and I'm getting a persistent \"Could not find installable ISAM\" error.  All hardware is 32-bit.</p>\n\n<p><em>[Revised 1/10/12 to try to focus more sharply on the anomalies]</em></p>\n\n<p>The following T-SQL statement produces the error:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT * FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0',\n    'Data Source=C:\\work\\TestData.xlsx;Extended Properties=\"Excel 12.0 XML;HDR=YES\"',\n    'SELECT * FROM [Sheet1$]'\n)\n</code></pre>\n\n<p>If I save the Excel file in the \"Excel 97-2003\" format (.xls) and use the older Microsoft.Jet.OLEDB.4.0 provider to import the data, it works just fine.  This makes me think it is not a security or other environmental issue.</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT * FROM OPENROWSET('Microsoft.Jet.OLEDB.4.0', \n    'Excel 8.0;Database=C:\\work\\TestData.xls;HDR=YES', \n    'SELECT * FROM [Sheet1$]'\n)\n</code></pre>\n\n<p>However, when I try the *.xls file with Microsoft.ACE.OLEDB.12.0 provider, which should be backward compatible with the *.xls format, it again fails with the same error:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT * FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0',\n    'Data Source=C:\\work\\TestData.xls;Extended Properties=\"Excel 8.0;HDR=YES\";', \n    'SELECT * FROM [Sheet1$]'\n)\n</code></pre>\n\n<p>Also, interestingly, when I use the SSMS \"Import Data...\" wizard, it works fine.  I saved the Import Data wizard output as an SSIS package and looked in the SSIS file to try to figure out how it works, and it IS successfully using the Microsoft.ACE.OLEDB.12.0 provider.  This is the connection string from the SSIS package:</p>\n\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;DTS:Property DTS:Name=\"ConnectionString\"&gt;\nProvider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\\work\\TestData.xlsx;Extended Properties=\"Excel 12.0 XML;HDR=YES\";\n&lt;/DTS:Property&gt;\n</code></pre>\n\n<p>I've also done the relevant SQL Server configuration to allow the OPENROWSET distributed query:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>sp_configure 'show advanced options', 1\nreconfigure\nGO\nsp_configure 'Ad Hoc Distributed Queries', 1\nreconfigure\nGO\n</code></pre>\n\n<p>If I also set the following *sp_MSset_oledb_prop* values (which I found in a post somewhere)...</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>USE [master] \nGO \nEXEC master.dbo.sp_MSset_oledb_prop N'Microsoft.ACE.OLEDB.12.0', N'AllowInProcess', 1\nGO \nEXEC master.dbo.sp_MSset_oledb_prop N'Microsoft.ACE.OLEDB.12.0', N'DynamicParameters', 1 \nGO \n</code></pre>\n\n<p>...then the error changes to \"Unspecified error\":</p>\n\n<pre><code>OLE DB provider \"Microsoft.ACE.OLEDB.12.0\" for linked server \"(null)\" returned message \"Unspecified error\".\nMsg 7303, Level 16, State 1, Line 1\nCannot initialize the data source object of OLE DB provider \"Microsoft.ACE.OLEDB.12.0\" for linked server \"(null)\".\n</code></pre>\n\n<p>However, I am not sure if this an upstream or downstream error.  (Is it now finding the \"installable ISAM\" but failing subsequently?) </p>\n\n<p>I have tried this with multiple Excel files on two different machines/OSes (Windows Server 2003, Windows XP SP3).  Both machines are 32-bit.</p>\n\n<p>I've also tried re-installing both the Office 2007 and Office 2010 versions of AccessDatabaseEngine.exe (<a href=\"http://www.microsoft.com/download/en/details.aspx?id=23734\" rel=\"nofollow\">http://www.microsoft.com/download/en/details.aspx?id=23734</a> and <a href=\"http://www.microsoft.com/download/en/details.aspx?id=13255\" rel=\"nofollow\">http://www.microsoft.com/download/en/details.aspx?id=13255</a>, respectively), to no avail.</p>\n\n<p>To summarize:</p>\n\n<ul>\n<li>\"Microsoft.Jet.OLEDB.4.0\" provider works using T-SQL, but \"Microsoft.ACE.OLEDB.12.0\" does not.</li>\n<li>\"Microsoft.ACE.OLEDB.12.0\" works using the \"Import Data...\" wizard (as far as I can tell from the saved SSIS job file).</li>\n<li>Setting the \"AllowInProcess\" and \"DynamicParameters\" properties to \"1\" changes the error to \"Unspecified error\".  (Is that a step forward?!)</li>\n</ul>\n\n<p>Any thoughts?</p>\n"},{"tags":["c#","tsql","linq-to-entities"],"answer_count":1,"favorite_count":2,"up_vote_count":5,"down_vote_count":1,"view_count":112,"score":4,"question_id":12892191,"title":"how can i use N' ' in Linq to Entity for Non Unicode characters?","body":"<p>how can i use N'' in Linq to Entity for example in T-SQL we had this code :</p>\n\n<pre><code>select *from students where name=N' '\n</code></pre>\n\n<p>i have this code :</p>\n\n<pre><code> var query = from p in dbContext.Students\n                            where p.Name == \" \"\n                            select p;\n</code></pre>\n\n<p>how can i do this with Linq to Entity?</p>\n\n<p>i found <a href=\"http://msdn.microsoft.com/en-us/library/system.data.objects.entityfunctions.asnonunicode.aspx\" rel=\"nofollow\">this</a>  :</p>\n\n<pre><code> var query = (from p in dbContext.Students\n                             where p.Name == EntityFunctions.AsNonUnicode(\" \")\n                            select p);\n</code></pre>\n\n<p>but it's not working.</p>\n\n<p>thanks. </p>\n"},{"tags":["sql-server","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":113,"score":1,"question_id":10169773,"title":"\"DROP USER\" taking up to 30 seconds","body":"<p>We're having an issue where doing a <code>DROP USER</code> in a single database (SQL Server 2008 R2) takes a very long time. It seems to fluctuate, but takes anywhere from 15 to 30 seconds. There aren't any DDL triggers acting on user-related events.</p>\n\n<p>To make matters stranger, this only happens in a single database on the server, on the other databases (larger, with identical DDL triggers), the <code>DROP USER</code> command is instantaneous.</p>\n\n<p>Have anyone else encountered something similar, and if you did, were you able to track down the cause?</p>\n"},{"tags":["sql-server","visual-studio-2010","tsql","ssrs-2008","ssms-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":12948222,"title":"Combining Case Statements in SSMS","body":"<p>I need to create a report that a user can toggle through data going from Region > District> Committee> Events.  I work with set data views that I cannot change.  I need to define a District and a Region, as they are not correctly defined in the database and then relate them to each other.  I have come close, as I was able to assign the 17 different \"DistrictCodes\"- Yeah they have the Code, but not the correct descriptions- using a CASE statement to make up the Regions:</p>\n\n<pre><code>CASE WHEN DistrictCode LIKE 'DST10%' THEN 4\nWHEN DistrictCode LIKE 'DST13%' THEN 2\nWHEN DistrictCode LIKE 'DST1%' THEN 2\nWHEN DistrictCode LIKE 'DST2%' THEN 2\nWHEN DistrictCode LIKE 'DST3%' THEN 3\nWHEN DistrictCode LIKE 'DST5%' THEN 3\nWHEN DistrictCode LIKE 'DST7%' THEN 2\nWHEN DistrictCode LIKE 'DST8%' THEN 1\nWHEN DistrictCode LIKE 'DSTC4%' THEN 3\nWHEN DistrictCode LIKE 'DSTC6%' THEN 2\nWHEN DistrictCode LIKE 'DSTC9%' THEN 1\nWHEN DistrictCode LIKE 'DT11%' THEN 4\nWHEN DistrictCode LIKE 'DT12%' THEN 4\nWHEN DistrictCode LIKE 'DT15%' THEN 4\nWHEN DistrictCode LIKE 'DT16%' THEN 4\nWHEN DistrictCode LIKE 'DT17%' THEN 4\nWHEN DistrictCode LIKE 'UP17%' THEN 4\nWHEN DistrictCode LIKE 'UPL11%' THEN 4\nELSE 5\nEND AS Region\n</code></pre>\n\n<p>Using the \"District Descriptions\" data I could create the District:</p>\n\n<pre><code>CASE WHEN DistrictDesc IN ('1' , '1A' , '1B') THEN 'District 1' \n    WHEN DistrictDesc IN ('2' , '2A' , '2B' , '2C') THEN 'District 2'\n    WHEN DistrictDesc IN ('3' , '3A' , '3B') THEN 'District 3'\n    WHEN DistrictDesc IN ('4' , '4A' , '4B' , '4C' , '4D' , '4E' , '4F') THEN 'District 4'\n    WHEN DistrictDesc IN ('5' , '5A' , '5B' , '5C') THEN 'District 5'\n    WHEN DistrictDesc IN ('6' , '6A') THEN 'District 6'\n    WHEN DistrictDesc IN ('7' , '7A' , '7B') THEN 'District 7'\n    WHEN DistrictDesc IN ('8' , '8A' , '8B' , '8C') THEN 'District 8'\n    WHEN DistrictDesc IN ('9' , '9A') THEN 'District 9'\n    WHEN DistrictDesc IN ('10' , '10A' , '10B' , '10C') THEN 'District 10'\n    WHEN DistrictDesc IN ('11' , '11A' , '11B' , '11C') THEN 'District 11'\n    WHEN DistrictDesc IN ('12' , '12A' , '12B' , '12C') THEN 'District 12'\n    WHEN DistrictDesc IN ('13' , '13A') THEN 'District 13'\n    WHEN DistrictDesc IN ('14' , '14A' , '14B' , '14C' , '14D') THEN 'District 14'\n    WHEN DistrictDesc IN ('15' , '15A' , '15B' , '15C' , '15D') THEN 'District 15'\n    WHEN DistrictDesc IN ('16' , '16A' , '16B' , '16C') THEN 'District 16'\n    WHEN DistrictDesc IN ('17' , '17A' , '17B') THEN 'District 17'\n    ELSE ISNULL (DistrictDesc,'No District')\n    END AS District\n</code></pre>\n\n<p>This works in SSMS for returning a query, however when I preview the report in VS Report Builder I need to set Region as a Parameter for the report.  Whether I set the values for region or have it retrieve the values from a query, I get multiples of 1, 2, 3, 4, and 5 (my regions)  for my drop down in the preview for regions.</p>\n\n<p>How can I get it to return only Once for 1,2,3,4,or 5?  is there a way that I Can combine these.  If I use Distinct then I would be missing some of the data wouldn't I?  I have tried using IN and listing each districtcode, but returned the same issue.</p>\n"},{"tags":["c#",".net","sql","sql-server","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":332,"score":2,"question_id":8589819,"title":"What is better to return single value from stored procedure to .Net: OUTPUT parameter or ExecuteScalar?","body":"<p>I need to create a stored procedure that needs to return a count of some records. I'm using .Net to read the result. </p>\n\n<p>I can use an <code>OUTPUT</code> parameter to return the value <em>or</em> I could do a <code>select count(*)</code> in the stored procedure and use a <a href=\"http://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlcommand.executescalar.aspx\" rel=\"nofollow\">SqlCommand.ExecuteScalar</a> to read it.</p>\n\n<p>What is better and why?</p>\n"},{"tags":["tsql","sql-server-2008-r2","where","isnull"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12947344,"title":"SQL check if the value of some column is null inside a where statement and if so set it to some value","body":"<p>I have this SQL query</p>\n\n<pre><code>SELECT * \nFROM   ##tempt \nWHERE  ( minstock &lt;= 0 \n         AND numitems - backorder - cstock &gt;= 1 ) \n        OR ( minstock &gt;= 1 \n             AND numitems - backorder + minstock - cstock &gt;= 1 ) \n</code></pre>\n\n<p>How would I check if the value of <code>minstock</code> is null and if its null then set it to some number?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":44,"score":3,"question_id":12943686,"title":"SQL Server Row based grouping","body":"<p>Given the following setup:</p>\n\n<pre><code>DECLARE @TemplateInfo table (Name varchar(10), aRow int, aCol int, Value  int)\n\ninsert INTO @TemplateInfo (Name, aRow, aCol, Value)\nVALUES ('A', 0,0,1),('B', 0,0,2),('A',1,0,2),('B',1,0,1),('C',0,0,1),('C',1,0,1)\n</code></pre>\n\n<p>How can I select the unique Name name values that have (aRow=0, aCol=0, Value=1) AND (aRow=1, aCol=0, Value=1). </p>\n\n<p>I tried a query like this:</p>\n\n<pre><code>select  Name\nfrom    @TemplateInfo info\nwhere   (info.aRow = 0 and info.aCol = 0 AND Value = 1) \n        or (info.aRow = 1 and info.aCol = 0 AND Value = 1)\nGROUP BY Name\n</code></pre>\n\n<p>But that returns A, B and C.  How can I check to make sure there are matches across rows (only return C)</p>\n"},{"tags":["xml","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":12938871,"title":"Conditional update XML with T-SQL based on attribute values","body":"<p>I have the following:</p>\n\n<pre><code>declare @xml XML\n\nSET @xml = '&lt;record priref=\"2\" creation=\"2009-12-14T10:39:04\"&gt;\n      &lt;field tag=\"aa\" occ=\"1\" lang=\"nl-NL\"&gt;somedata&lt;/field&gt;\n      &lt;field tag=\"bb\" occ=\"1\" lang=\"en-US\"&gt;somedata&lt;/field&gt;\n      &lt;field tag=\"bb\" occ=\"2\" lang=\"en-US\"&gt;somedata&lt;/field&gt;\n      &lt;field tag=\"cc\" occ=\"1\"&gt;testdata&lt;/field&gt;\n      &lt;field tag=\"dd\" occ=\"1\"&gt;testdata&lt;/field&gt;\n      &lt;field tag=\"ee\" occ=\"1\" lang=\"nl-NL\"&gt;somedata&lt;/field&gt;\n      &lt;field tag=\"ee\" occ=\"1\" lang=\"en-US\"&gt;somedata&lt;/field&gt;\n    &lt;/record&gt;' \n\nDECLARE @nodeCount int\nDECLARE @i int\n\nSET @i = 1\n\nSELECT @nodeCount = @xml.value('count(/record/field/@lang)','varchar(5)') \n\nWHILE (@i &lt;= @nodeCount)\nBEGIN\nSet @xml.modify('replace value of (/record/field/@lang)[.=\"en-US\"][1] with \"nl-NL\"')\n\nSET @i = @i + 1\nEND\n\nSELECT @xml\n</code></pre>\n\n<p>and I would like to update the attribute @lang conditionally. </p>\n\n<p>If there is a node with the same attribute value combination for 'tag' and 'occ' (like tag=ee) the attribute value for @lang has to stay unchanged.</p>\n\n<p>In other cases it has to change like the above query is already doing: change 'en-US' into 'nl-NL'.</p>\n\n<p>Anyone has an idea how to do this? Thanks in advance!</p>\n"},{"tags":["tsql","merge"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":875,"score":2,"question_id":10218101,"title":"T SQL merge example needed to help comprehension","body":"<p>The following:</p>\n\n<pre><code>MERGE dbo.commissions_history AS target\nUSING (SELECT @amount, @requestID) AS source (amount, request)\nON (target.request = source.request)\nWHEN MATCHED THEN\n    UPDATE SET amount = source.amount\nWHEN NOT MATCHED THEN\n    INSERT (request, amount)\n    VALUES (source.request, source.amount);\n</code></pre>\n\n<p>from <a href=\"http://stackoverflow.com/a/2967983/857994\">http://stackoverflow.com/a/2967983/857994</a> is a pretty nifty way to do insert/update (and delete with some added work).  I'm finding it hard to follow though even after some googling.</p>\n\n<p>Can someone please:</p>\n\n<ul>\n<li>explain this a little in simple terms - the MSDN documentation mutilated my brain in this case.</li>\n<li>show me how it could be modified so the user can type in values for amount &amp; request instead of having them selected from another database location?</li>\n</ul>\n\n<p>Basically, I'd like to use this to insert/update from a C# app with information taken from XML files I'm getting.  So, I need to understand how I can formulate a query manually to get my parsed data into the database with this mechanism.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":22,"score":0,"question_id":12944094,"title":"pivot to total per week","body":"<p>I have a query that i am trying to write to return the amount of times and instance occurs in a database and group by week and product as defined by the database. below is my query:</p>\n\n<pre><code>SELECT WeekCompleted, Product, COUNT(OrderNumber) as CorrectionCount FROM(\nSELECT \np.Abbreviation as Product\n,CAST(oi.OrderID as VARCHAR(MAX))+'.'+CAST(oi.OrderItemID as VARCHAR(MAX)) AS OrderNumber\n,CASE\n    WHEN o.ClientID IN (56156, 56394) \n        THEN DATEADD(week, datepart(ww, dbo.GetLatestMilestoneDate(oi.OrderID, oi.OrderItemID, 80)) \n            - 1, DATEADD(DAY, @@datefirst - DATEPART(weekday, CAST(YEAR(GETDATE()) AS VARCHAR)\n            + '-01-01') - 6, CAST(YEAR(GETDATE()) AS VARCHAR) + '-01-01'))\n    ELSE DATEADD(week, datepart(ww, dbo.GetLatestMilestoneDate(oi.OrderID, oi.OrderItemID, 130)) \n    - 1, DATEADD(DAY, @@datefirst - DATEPART(weekday, CAST(YEAR(GETDATE()) AS VARCHAR)\n    + '-01-01') - 6, CAST(YEAR(GETDATE()) AS VARCHAR) + '-01-01')) \n    END AS WeekCompleted\n,CASE   \n    WHEN o.ClientID IN (56156,56394) THEN dbo.GetLatestMilestoneDate(oi.OrderID, oi.OrderItemID, 80)\n    ELSE dbo.GetLatestMilestoneDate(oi.OrderID, oi.OrderItemID, 130) END AS LastCompleted\nFROM\nOrderItems oi\nLEFT JOIN OrderItemMilestones oim on oim.OrderID = oi.OrderID and oim.OrderItemID = oi.OrderItemID\nJOIN Products p on p.ProductID = oi.ProductID\nJOIN Orders o on o.OrderID = oi.OrderID\nWHERE\noim.MilestoneID = 90\nand QueueID = 0\n) src\nWHERE LastCompleted &gt;= '2012-10-01'\nGROUP BY WeekCompleted, Product\n</code></pre>\n\n<p>here is more info needed</p>\n\n<pre><code> dbo.getlatestmilestonedate() returns a datetime date in this format: mm:dd:yyyy hh:mm:ss\n</code></pre>\n\n<p>and a sample table of data i currently have:</p>\n\n<pre><code>WeekCompleted           Product    CorrectionCount\n2012-09-30 00:00:00.000 Product1    5\n2012-10-07 00:00:00.000 Product1    7\n2012-10-14 00:00:00.000 Product1    7\n2012-09-30 00:00:00.000 Product2    18\n2012-10-07 00:00:00.000 Product2    28\n2012-10-14 00:00:00.000 Product2    16\n</code></pre>\n\n<p>This data is returning exactly how i want it to so no change is needed to the original data unless needed to accomplish final goal, which is this:</p>\n\n<pre><code>WeekCompleted               Product1        Product2\n2012-09-30 00:00:00.000      5                18\n2012-10-07 00:00:00.000      7                28 \n2012-10-14 00:00:00.000      7                16\n</code></pre>\n\n<p>I think i need to pivot this, but every time i try i only run into syntax errors and dont quite yet understand the pivot syntax.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12944163,"title":"How do I select the max date from a union of two tables?","body":"<pre><code>SELECT TOP 1 * FROM \n(\n    select max(updatedtimestamp) from db1.dbo.policyrepresentationcache with(nolock)\n    UNION\n    select max(updatedtimestamp) from db2.dbo.policyrepresentationcache with(nolock)\n    ) \nORDER BY updatedtimestamp\n</code></pre>\n\n<p>I'm running into syntax errors here and im not sure how to set it up.</p>\n"},{"tags":["sql","sql-server","tsql","dynamic-sql","in-operator"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12943788,"title":"Using \"IN\" operator in a dynamic query","body":"<p>i've been searching SO for a while and found nothing related to this.</p>\n\n<p>We use heavily the dynamic approach for most of our queries like this:</p>\n\n<pre><code>Declare @ContactId VarChar(8000)\n\nSelect @ContactId = '1'\n\nSelect * \nFrom Person.Contact\nWhere 1 = 1 And \nCase When Len(Ltrim(Rtrim(@ContactId))) = 0 Then 1 Else ContactID End =\nCase When Len(Ltrim(Rtrim(@ContactId))) = 0 Then 1 Else @ContactId End\n</code></pre>\n\n<p>This way the query gets filtered dynamically if there's a value on the parameter</p>\n\n<p>But the problem comes when trying the same stuff with several IDs like so:</p>\n\n<pre><code>Declare @ContactId VarChar(8000)\n\nSelect @ContactId = '1,2,3'\n\nSelect * \nFrom Person.Contact\nWhere 1 = 1 And \nCase When Len(Ltrim(Rtrim(@ContactId))) = 0 Then 1 Else ContactID End In (\nSelect Case When Len(Ltrim(Rtrim(@ContactId))) = 0 Then 1 Else ( Select id From dbo.SplitString(@ContactId,',') ) End )\n</code></pre>\n\n<p>Sql throws an error \"Subquery returned more than 1 value. This is not permitted when the subquery follows =, !=, &lt;, &lt;= , >, >= or when the subquery is used as an expression.\"</p>\n\n<p>that's totally normal and expected, my question is:</p>\n\n<p>Is there a way to dynamically do this kind of filtering ?</p>\n\n<p>The solution we use is this:</p>\n\n<pre><code>Declare @Table Table(\n    Col1    Int,\n    Col2    Int,\n    Col3    Int\n)\n\nInsert @Table\nSelect Col1, Col2, Col3\nFrom Person.Contact\nWhere [many filters except the in clause filters]\n\nIf Len(Ltrim(RTrim(@ContactId))) &gt; 0\n    Select * \n    From @Table\n    Where ContactId In ( Select Id From dbo.SplitString(@ContactId, ',') )\nElse \nSelect *\nFrom @Table\n</code></pre>\n\n<p>But it's not an option when the query is massive and feeding a table variable is overkill for this. Hope i made my point and someone is kind enough to help me find a solution to this.</p>\n\n<p>PS: Using <code>sp_ExecuteSql</code> is not an option in this scenario either, sorry.</p>\n"},{"tags":["sql","sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12927861,"title":"Calculating time frames between status using SQL 2008/2012","body":"<p>Calculating time frames between status using SQL 2008/2012</p>\n\n<p>I've the following table who store the status of a student</p>\n\n<pre><code>+----+-----------+------------------+---------+---------+\n| ID | PERSON_ID |    TIMESTAMP     | IN_HOME | STUDYNG |\n+----+-----------+------------------+---------+---------+\n|  1 |         1 | 17/10/2012 19:00 |       0 |       0 |\n|  2 |         1 | 17/10/2012 19:02 |       1 |       0 |\n|  3 |         1 | 17/10/2012 19:03 |       1 |       1 |\n|  4 |         1 | 17/10/2012 19:04 |       1 |       1 |\n|  5 |         1 | 17/10/2012 19:05 |       1 |       0 |\n|  6 |         1 | 17/10/2012 19:10 |       0 |       0 |\n|  7 |         1 | 17/10/2012 19:12 |       0 |       0 |\n|  8 |         1 | 17/10/2012 19:20 |       1 |       0 |\n|  9 |         1 | 17/10/2012 19:25 |       1 |       0 |\n| 10 |         1 | 17/10/2012 19:26 |       1 |       1 |\n| 11 |         1 | 17/10/2012 19:30 |       1 |       0 |\n+----+-----------+------------------+---------+---------+\n</code></pre>\n\n<p>And i would like to produce results in 2 ways to make some reports:</p>\n\n<p>I:</p>\n\n<pre><code>+-----------+------------------+------------------+---------+---------+\n| PERSON_ID |      START       |       END        | IN_HOME | STUDYNG |\n+-----------+------------------+------------------+---------+---------+\n|         1 | 17/10/2012 19:00 | 17/10/2012 19:02 |       0 |       0 |\n|         1 | 17/10/2012 19:02 | 17/10/2012 19:03 |       1 |       0 |\n|         1 | 17/10/2012 19:03 | 17/10/2012 19:05 |       1 |       1 |\n|         1 | 17/10/2012 19:05 | 17/10/2012 19:10 |       1 |       0 |\n|         1 | 17/10/2012 19:10 | 17/10/2012 19:20 |       0 |       0 |\n|         1 | 17/10/2012 19:20 | 17/10/2012 19:26 |       1 |       0 |\n|         1 | 17/10/2012 19:26 | 17/10/2012 19:30 |       1 |       1 |\n+-----------+------------------+------------------+---------+---------+\n</code></pre>\n\n<p>II:</p>\n\n<pre><code>+-----+------------------+------------------+--------+---------+----------+----------+\n| PID |      START       |       END        | InHOME | TotTIME | FreeTIME | StudTIME |\n+-----+------------------+------------------+--------+---------+----------+----------+\n|   1 | 17/10/2012 19:00 | 17/10/2012 19:02 |      0 | 2min    | 2min     | 0min     |\n|   1 | 17/10/2012 19:02 | 17/10/2012 19:10 |      1 | 8min    | 6min     | 2min     |\n|   1 | 17/10/2012 19:10 | 17/10/2012 19:20 |      0 | 10min   | 10min    | 0min     |\n|   1 | 17/10/2012 19:20 | 17/10/2012 19:26 |      1 | 6min    | 6min     | 0min     |\n+-----+------------------+------------------+--------+---------+----------+----------+\n</code></pre>\n\n<p>What's the best solution to solve this problems? </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":12943061,"title":"How to write more that one statement in the same SPROC","body":"<p>Since i don't have the <strong>ModuleID</strong>, I'd like to get from the Modules table first using the <strong>ModuleName</strong>. </p>\n\n<pre><code>ALTER PROCEDURE dbo.spEditTask\n@ID                     int,\n@ModuleName             varchar(50), \n@Task                   varchar(50), \n@ListOfDevelopers       varchar(50),\n@StartDate              date, \n@PlannedEndDate         date, \n@EstimatedEndDate       date, \n@Status                 varchar(50),\n@Comments               varchar(500),\n@LastAction             varchar(50),\n@Started                 bit\nAS\nBEGIN \n\n  DECLARE @ModuleID int; \n  SET @ModuleID = \n  (SELECT ModuleID \n  FROM Modules\n  WHERE ModuleName = @ModuleName); \n  GO\n\n  UPDATE DTasks\nSET ModuleID = @ModuleID, \n    Task = @Task, \n    ListOfDevelopers = @ListOfDevelopers, \n    StartDate = @StartDate, \n    PlannedEndDate = @PlannedEndDate, \n    EstimatedEndDate = @EstimatedEndDate, \n    Status = @Status, \n    Comments = @Comments, \n    LastAction = @LastAction,\n    Started  = @Started,\n    LastUpdated = GETDATE() \nWHERE ID  = @ID\nGO\nEND\n</code></pre>\n\n<p>Thanks for helping</p>\n"},{"tags":["tsql","join"],"answer_count":6,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":5742,"score":5,"question_id":1849944,"title":"T-SQL - How to write a conditional join","body":"<p>I have a stored procedure with a number of parameters. I would like to write my query so that it joins with certain tables but only if a particular parameter has a value.  Take the following example:  I have a Person table.  There is also an Address table which holds Person Addresses and a Groups table that holds Person Groups.  Both are one to many relationships with the Person table.  My stored procedure has an @AddressID parameter and a @GroupID parameter.</p>\n\n<p>The query always just returns fields from the Person table.  If neither parameter has a value then the query should return all records from the Person table.  If the @AddressID parameter is supplied then it should return only records that have a matching record in the Address table and ignore the Groups table.  If the @GroupID parameter is supplied then it should return only records that have a matching record in the Groups table and ignore the Addresses table.  If both parameters are supplied then it should only show records that have a matching record in both tables.  Make sense?</p>\n\n<p>Is there a simple way to do this that I am missing?</p>\n\n<p>Thanks,\nCorey</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":42,"score":0,"question_id":12938285,"title":"t-sql multiplying 2 tables plus join between 2 dates which comes from asp.net","body":"<p>I have below 2 tables</p>\n\n<p>Table1</p>\n\n<pre><code> Plant      \n -----\n TRP1\n DEP1\n</code></pre>\n\n<p>Table2</p>\n\n<pre><code>Config\n------\n84ROC20\n100ROC20\n</code></pre>\n\n<p>and 2 textboxes</p>\n\n<p>1.Start date(datetime) : 2012-08-01 00:00:00.000 </p>\n\n<p>2.Enddate(datetime):2012-10-01 00:00:00.000</p>\n\n<p>I want to have below table as a result with 3 columns</p>\n\n<pre><code>Plant  Config    Time\n-----  ------   -------\nTRP1   84ROC20   2012-08-01 00:00:00.000 \nTRP1   84ROC20   2012-09-01 00:00:00.000 \nTRP1   84ROC20   2012-10-01 00:00:00.000\nDEP1   84ROC20   2012-08-01 00:00:00.000 \nDEP1   84ROC20   2012-09-01 00:00:00.000\nDEP1   84ROC20   2012-10-01 00:00:00.000\nTRP1   100ROC20  2012-08-01 00:00:00.000\nTRP1   100ROC20  2012-09-01 00:00:00.000 \nTRP1   100ROC20  2012-10-01 00:00:00.000\nDEP1   100ROC20  2012-08-01 00:00:00.000 \nDEP1   100ROC20  2012-09-01 00:00:00.000\nDEP1   100ROC20  2012-10-01 00:00:00.000\n</code></pre>\n\n<p>Can you please help to have this table</p>\n"},{"tags":["tsql","duplicates","sybase","duplicate-removal"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":79,"score":1,"question_id":12939893,"title":"TSQL query to delete all duplicate records but one","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/3317433/delete-duplicate-records-in-sql-server\">delete duplicate records in SQL Server</a>  </p>\n</blockquote>\n\n\n\n<p>I have a table in which unique records are denoted by a composite key, such as (<code>COL_A</code>, <code>COL_B</code>).</p>\n\n<p>I have checked and confirmed that I have duplicate rows in my table by using the following query:</p>\n\n<pre><code>select COL_A, COL_B, COUNT(*)\nfrom MY_TABLE\ngroup by COL_A, COL_B\nhaving count(*) &gt; 1\norder by count(*) desc\n</code></pre>\n\n<p>Now, I would like to remove all duplicate records but keep only one.</p>\n\n<p>Could someone please shed some light on how to achieve this with 2 columns?</p>\n\n<p><strong>EDIT:</strong> \nAssume the table only has <code>COL_A</code> and <code>COL_B</code></p>\n"},{"tags":["c#","linq","entity-framework","tsql","group-by"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":60,"score":2,"question_id":11474469,"title":"How do I get a lambda query that is like this tsql query?","body":"<p>Having a T-SQL query:</p>\n\n<pre><code>select [ProductNumber] ,max([ProductRevNumber])\nfrom Products  \ngroup by [ProductNumber]\n</code></pre>\n\n<p>Attempted LINQ query:</p>\n\n<pre><code>ProductsDBContext.Products.GroupBy(x =&gt; x.ProductRevNumber)\n                          .Select(group =&gt; ProductNumber, \n                                           ProductRevNumber = group.Max(x =&gt; x.ProductRevNumber));\n</code></pre>\n\n<p>The lambda query doesn't work.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12461892,"title":"views not refreshing /sp_refreshview taking time for certain views even though there is no data in the view","body":"<p>I have got 2 client's databases(client1 and client 2).As a part of testing, I have restore those 2 databases in my local server.</p>\n\n<p>Views are created in a database called configDB(same server) and are pointing to  tables in a database  called CurrentsourceDB(data of client1).Now I have \nrenamed the CurrentsourceDB to CurrentsourceDB_old and \nsource2db(data of client2) to CurrentsourceDB\n(client1's data db and client2's data db both have same objects, same structure. The only difference is with data ).\nNow when I query the view it has to show data based on source2db(client2's data) But it still shows data based on source1(client1's data).</p>\n\n<p>So I have to either refresh all the view or just alter all the views then I can see the view's data based on present source database,source2db\nWhy does it happen, and is there any way to resolve the problem apart from refreshing?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12935664,"title":"Get size of a database that is hosted on a linked server?","body":"<p>Does anyone know how to get the size of a dabase that is hosted on a different server? I basicly want to monitor the size of that DB in a Job on my server.\nI tried something like:</p>\n\n<pre><code>select db_name(dbid), str(convert(dec(15),sum(size))* 8192/ 1048576,10) \nfrom [LINKEDSERVER].master.sys.sysaltfiles \ngroup by dbid order by 2 desc\n</code></pre>\n\n<p>For some reason this gives me the data on my current server instead of the remote server.\nAlso, I've read on a forum that the sysaltfiles is only updated at server restarts? This would make it unusable for monitoring, so do you have a better option instead?</p>\n"},{"tags":["sql","tsql"],"answer_count":0,"favorite_count":1,"up_vote_count":1,"down_vote_count":1,"view_count":76,"score":0,"question_id":12941074,"title":"T-SQL double MOD operation","body":"<p>I have two variables such as <code>x</code>, <code>y</code>.</p>\n\n<p><code>x</code> is period and <code>y</code> is the length of the period.\nLets say <code>x</code> = 3 and <code>y</code> = 2, assume that each <code>y</code> refers to another value and for this example that is: <strong>1</strong></p>\n\n<p>Then </p>\n\n<pre><code>Process | Value | Total\n1       | 1     | 1\n2       | 1     | 1\n3       | 0     | 0\n1       | 1     | 1\n2       | 1     | 1\n3       | 0     | 0\n</code></pre>\n\n<p>In another scenario that I couldn't come up with a solution:</p>\n\n<p>x: 3 y: 4 i.e. x &lt; y</p>\n\n<pre><code>Process | Value | Total\n1       | 1     | 1\n2       | 1     | 1\n3       | 1     | 1\n1       | 1+ 1  | 2\n2       | 1     | 1\n3       | 1     | 1 \n1       | 1 + 1 | 2\n2       | 1     | 1\n3       | 1     | 1\n1       | 1 + 1 | 2 \n</code></pre>\n\n<p>Please note that I did solve with two loops however I do prefer to do it with \"update  set \" query.</p>\n\n<p>Thanks</p>\n"}]}
{"total":16599,"page":7,"pagesize":100,"questions":[{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12940511,"title":"tsql coalesce with float and varchar","body":"<p>I have a float field which shows data as such:</p>\n\n<pre><code>1\n1.00\n3.12\n3.00\n</code></pre>\n\n<p>I also have a varchar field that shows as such:</p>\n\n<pre><code>NA\nND \nI\n</code></pre>\n\n<p>Data is as such: Fld_N is a float and Fld_S is varchar</p>\n\n<pre><code>Fld_N   Fld_S\n-----   ------\n1 \n        ND\n1.00    \n3.12\n3\n       NA\n       I\n</code></pre>\n\n<p>Notice that a row can have a value for either the Fld_N or the Fld_S but not both.</p>\n\n<p>What I am doing is using the coalesce as such:</p>\n\n<pre><code>    COALESCE(STR(Fld_N,9,2), Fld_S)  Fld\n</code></pre>\n\n<p>This doesn't quite work well as I have the decimal points always be upto 2 decimal points whereas I need it to support showing 1 as well as 1.00. Is there a way to not specify the decimal points and still accomomdate for showing 1 and 1.00 in my example? </p>\n"},{"tags":["sql-server","tsql","coldfusion"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":64,"score":4,"question_id":12935181,"title":"How can I retrieve a t-sql variable from cfquery?","body":"<p>I am running this inside of my <code>cfquery</code>.</p>\n\n<pre><code>SET @rID = ( SELECT TOP 1 roleid\n             FROM Roles\n             WHERE RoleName = @rName AND appid = @appID\n             ORDER BY Created DESC);\n</code></pre>\n\n<p>Is it possible to retrieve <code>@rID</code> without having to run the <code>SELECT</code> query a second time?\nAs in:</p>\n\n<pre><code>&lt;cfset varName = queryName.rID&gt;\n</code></pre>\n\n<p>The above doesn't work obviously, but is there anyother way to return the variable from the query?</p>\n"},{"tags":["sql","sql-server-2008","tsql","pivot","transpose"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":52,"score":0,"question_id":12926901,"title":"Transposing Table","body":"<p>I've looking everywhere and have not finding anything useful.</p>\n\n<p>I have a table the captures assistance for employees.</p>\n\n<p>The  table that looks like this:</p>\n\n<pre><code>ID   | DATE     | ATTENDANCE\n________________\n2524 | 20121001 | ASISTANCE\n2525 | 20121001 | ABSCENCE\n2526 | 20121001 | ASISTANCE\n2527 | 20121001 | ASISTANCE\n2524 | 20121002 | ASISTANCE\n2525 | 20121002 | ABSCENCE\n2526 | 20121002 | ASISTANCE\n2527 | 20121002 | ASISTANCE\n2524 | 20121003 | ASISTANCE\n2525 | 20121003 | DAY OFF\n2526 | 20121003 | DAY OFF\n2527 | 20121003 | ASISTANCE\n</code></pre>\n\n<p>And I want a query that returns a table that will look like this:</p>\n\n<pre><code>ID   | 20121001  | 20121002  | 20121003\n________________\n2524 | ASISTANCE | ASISTANCE | ASISTANCE\n2525 | ABSCENCE  | ABSCENCE  | DAY OFF\n2526 | ASISTANCE | ASISTANCE | ASISTANCE\n2527 | ASISTANCE | ASISTANCE | DAY OFF\n</code></pre>\n\n<p>I tried individual querys and joining them, but since they are to many dates it takes too much to do so.</p>\n\n<p>How can I do it that is efficient and can be stored into a view or function??</p>\n"},{"tags":["sql","tsql","datetime","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":35,"score":2,"question_id":12938880,"title":"SQL - select most 'active' time from db","body":"<p>Very closely related to <a href=\"http://stackoverflow.com/questions/12938302/sql-select-most-active-timespan-fromdb\">SQL - Select most &#39;active&#39; timespan fromdb</a> but different question.</p>\n\n<p>\"I have a table of transactions. In this table I store the transaction datetime in UTC. I have a few months of data, about 20,000 transactions a day.\"</p>\n\n<p>How would change</p>\n\n<pre><code>  select datepart(hour, the_column) as [hour], count(*) as total \n  from t \n  group by datepart(hour, the_column) \n  order by total desc\n</code></pre>\n\n<p>so that I can select the specific year, month, day, hour, minute, and second that was the most 'active'.</p>\n\n<p>To clarify, I'm not looking for which hour or minute of the day was most active.  Rather, which moment in time was the most active.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12938273,"title":"SQL Server - Most recent date and sale amount columns","body":"<p>I'm using SQL Server 2008 R2 to complete a query. I have a sale table that contains a unique sale id, a customer id, a sale date, and a sale amount. I'm trying to create a table that has the most recent sale for each customer and the amount for that sale. </p>\n\n<pre><code>| customer_id | most recent sale date | sale amount |\n|     1       |2012-06-11 00:00:00.000|     150     |\n|     2       |2012-01-07 00:00:00.000|     55      |\n|     3       |2012-02-18 00:00:00.000|     117     |\n|     4       |2012-09-02 00:00:00.000|     25      |\n</code></pre>\n\n<p>I have the first two columns with this query:</p>\n\n<pre><code>SELECT DISTINCT customer_id, MAX(sale_date)\nFROM sale\nGROUP BY customer_id\n</code></pre>\n\n<p>When I try to add the amount of the sale, everything I try includes every sale for that customer, not just the most recent one. Is there a way to do this? Keep in mind there is a unique sale id on this table that might be of some use. Thank you for your time.</p>\n"},{"tags":["sql","tsql","datetime","stored-procedures"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12938302,"title":"SQL - Select most 'active' timespan fromdb","body":"<p>I have a table of transactions.  In this table I store the transaction datetime in UTC.  I have a few months of data, about 20,000 transactions a day.</p>\n\n<p>How would I write a stored procedure to:</p>\n\n<p>A:  Count of the most active/busiest hour</p>\n\n<p>B:  Return which hour was the most active/busiest</p>\n"},{"tags":[".net","sql","query","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":92,"score":0,"question_id":12924154,"title":"Difficult T-SQL Join/Pivot","body":"<p>The original way I worded this question would be unhelpful to most, so I've reworked it significantly.</p>\n\n<p>I have a legacy database, whose schema <strong>I have no control over</strong> (nor ever have). The db schema was designed agnostic of the provider for consumption by unmanaged C++, so there are no FK constraints, etc. I come along and need to consume this from .NET, and also need to present the data much differently than it was originally intended.</p>\n\n<p>Here is the schema of the relevant tables (I've bolded/asteriskifed what amount to the keys for this question):</p>\n\n<pre><code>CREATE TABLE [dbo].[Formats](\n[GroupName] [varchar](255) NOT NULL,\n**[BatchID] [bigint] NOT NULL,**\n[SeriesNumber] [bigint] NOT NULL,\n**[SequenceID] [bigint] NOT NULL,**\n[SeqNum] [int] NOT NULL,\n[FormatName] [varchar](50) NOT NULL\n\nCREATE TABLE [dbo].[Fields](\n[GroupName] [varchar](255) NOT NULL,\n**[BatchID] [bigint] NOT NULL,**\n**[SequenceID] [bigint] NOT NULL,**\n[SeqNum] [int] NOT NULL,\n**[FieldName] [varchar](50) NOT NULL,**\n[FieldDisplayName] [varchar](50) NOT NULL,\n[FieldValue] [ntext] NULL\n</code></pre>\n\n<p>There is a 1:Many relationship between Formats:Fields.</p>\n\n<p>I need to query for a list of format rows. The challenges are several:\n   + There is a compound foreign key.\n   + I need to filter the formats to a subset that contains related Fields.\n   + The related fields must match an arbitrary number of filter criteria before being inner-joined to the formats.</p>\n\n<p>So to walk through this:\nThe Stored Proc receives the following table valued parameter:</p>\n\n<pre><code>_FieldDisplayName_  Field_Value\n Field 1             001\n Field 2             002\n</code></pre>\n\n<p>It then needs to filter the Fields table by those values.</p>\n\n<p>Since I needed to use ALL of the criteria and not just one of them, I did not know how work with this to retrieve something useful to join with, when I didn't know how many values I'd have, or what the FieldDisplayName values would be.</p>\n\n<p>@Joe Phillips was smart enough to see through the chaos and suggest that I needed to pivot the table. That's this:</p>\n\n<p><strong>Edit:</strong>\nThe following is working to pivot the data, but I am not sure it is ideal. Still waiting on other ideas before supplying an answer.</p>\n\n<p>Instead of using a TVP, I'm using a temp table and dynamic SQL (and yes, I see the injection vulnerability):</p>\n\n<pre><code>IF OBJECT_ID('[tempdb].[dbo].[#FilterFields]') is not null\nDrop Table dbo.#FilterFields\n\nCREATE Table #FilterFields (FieldDisplayName varchar(50), FieldValue nvarchar(max))\n/* Just some example data */\nINSERT INTO #FilterFields (FieldDisplayName, FieldValue) VALUES ('PTNUM', '011')\nINSERT INTO #FilterFields (FieldDisplayName, FieldValue) VALUES('SITENUM', '001')\n\nDeclare @column_names varchar(max)\nDeclare @dynamic_pivot_query as varchar(max)\n\nSELECT @column_names = Stuff((SELECT DISTINCT ',[' + FieldDisplayName + ']'\n                FROM #FilterFields FOR xml path('')),1,1,'')\n\nPRINT(@column_names)    \n\nSET @dynamic_pivot_query =\n'select * ' +\n'from tempdb.dbo.#FilterFields ' +\n'Pivot\n(\nMIN(\n    FieldValue\n    )\nFOR FieldDisplayName IN (' + @column_names + ')\n) as P'\n\nPRINT(@dynamic_pivot_query)\nEXEC(@dynamic_pivot_query)\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","math","arithmetic-expressions"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":52,"score":3,"question_id":12925148,"title":"In T-SQL how can I get a column of 2-decimal points(or percentages)?","body":"<p>In SQL Server 2008, I am running a report where I need to divide two columns (called <code>Completes</code> and <code>Prescreens</code>, whole integers), and then I go to Excel and get the <code>Prescreens</code> divided by the <code>Completes</code>, and turn that into a number with 2 decimal places, then convert that to a percentage. i.e. -> 0.34, then becomes 34%.</p>\n\n<p>In SQL in know I probably can't get the output as \"34%\" but at least I'd like it as 0.34 .  So far I have:</p>\n\n<pre><code>cast((sq.Completes/sq.Screens ) as float ) as 'conv'\n</code></pre>\n\n<p>Completes are the smaller of numbers(usually 27, 38, etc), and Screens are bigger numbers(124, 276, etc.)</p>\n\n<p>But this is outputting my column as all <code>0s</code> . How do I make it show 0.34 , 0.84, etc</p>\n"},{"tags":["sql","sql-server","database","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":95,"score":1,"question_id":12933504,"title":"Ideas on how automatically to delete credit card details from a database T-SQL backup","body":"<p>I've been working on a new database which is used by call-centre agents to make sales on various products. During the day, these agents will accept credit card details and store them temporarily before processing. At night, the database is backed up, but we can't backup the credit card details for obvious security reasons. At first I thought just to UPDATE the credit card fields to NULL before backing up using the standard BACKUP procedure, but it turns out that the details need to be kept in the original database, in case they haven't been processed that day. All the sensitive credit card details are contained in one column of one table. This should be straightforward, but I'm a newcomer (this week) to both databases and T-SQL -- any hints or directions much appreciated.</p>\n\n<p><strong>EDIT: additional requirement</strong></p>\n\n<p>A requirement of any solution is that it not modify the structure of the primary database. This means that changing credit card ids in the customer details table to a creditcardid keyed to a credit card table, which could then be excluded from the backup, is unfortunately not an option.</p>\n"},{"tags":["sql","tsql","varchar"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":2788,"score":2,"question_id":6825550,"title":"String or binary data would be truncated SQL Error","body":"<p>I have a SQL stored procedure that accepts a parameter of type VARCHAR(MAX).\nAs far as I know and according to all I read about, the max size for such strings is 2GB:\n<a href=\"http://msdn.microsoft.com/en-us/library/ms176089.aspx\" rel=\"nofollow\">MSDN</a></p>\n\n<p>For some reason when passing a string larger than 8KB I get:</p>\n\n<blockquote>\n  <p>String or binary data would be truncated.</p>\n</blockquote>\n\n<p>Why do I get this error message, and how can I resolve it?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12930586,"title":"Updating first record of a group of records t-sql","body":"<p>I have a table like this </p>\n\n<pre><code>CREATE TABLE [dbo].[tblUserLink](\n    [IDUserLink] [int] IDENTITY(1,1) NOT NULL,\n    [IDUser] [int] NOT NULL,\n    [IDRegie] [varchar](50) NOT NULL,\n    [DefaultAgency] [bit] NULL\n)\n</code></pre>\n\n<p>I'm looking for a query /script to update the field DefaultAgency. I'd like to set it to 1 for the first record that comes for each group of record with a same IDUser. </p>\n\n<p>example : </p>\n\n<pre><code>IDUserLink IDUser IDRegie DefaultAgency (Goal)\n1          1      1       null           DefaultAgency to be set to 1\n2          1      2       null\n3          1      3       null\n4          2      2       null           DefaultAgency to be set to 1\n5          2      1       null     \n6          3      1       null           DefaultAgency to be set to 1\n ...etc \n</code></pre>\n\n<p>Can I achieve this using a simple sql query or should I script it ?</p>\n"},{"tags":["sql","sql-server","tsql","floating-point"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":2769,"score":4,"question_id":2699975,"title":"Getting maximum value of float in SQL programatically","body":"<p>Is there an method for programatically <em>(in T-SQL)</em> retrieving the maximum (and minimum) value of a datatype? That it would act like <em>float.MaxValue</em> in C#.</p>\n\n<p>I would like to use it in some selection when the parameter does not equal any actual values in the database, so I would use something like</p>\n\n<pre><code>declare @min float\ndeclare @max float\n--fill @min and @max, can be null if undefined\nselect * from foo \n  where bar between isnull(@min,0 ) and isnull(@max,max(float)/*magic*/)\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["tsql","pivot","unpivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12935311,"title":"Unpivot T-sql Query","body":"<p>following is the result of my query</p>\n\n<pre><code>Year_Month.........cat1_per......cat2_per........cat3_per......cat4_per\n2004_06...............0.892..........0.778............0.467..........0.871\n2005_10...............0.790..........0.629............0.581..........0.978\n</code></pre>\n\n<p>but i want output of my query to be</p>\n\n<pre><code>Category...........2004_06..............2005_10\ncat1_per.............0.892..................0.790\ncat2_per.............0.778..................0.629\ncat3_per.............0.467..................0.581\ncat4_per.............0.871..................0.978\n</code></pre>\n\n<p>what is the best way to do it? any help is appreciated.\nI tried Unpivot but was not able to get desired result.</p>\n"},{"tags":["sql","sql-server","tsql","ssis"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":254,"score":2,"question_id":6944483,"title":"How to create a Primary Key on quasi-unique data keys?","body":"<p>I have a nightly SSIS process that exports a TON of data from an AS400 database system.  Due to bugs in the AS400 DB software, ocassional duplicate keys are inserted into data tables.  Every time a new duplicate is added to an AS400 table, it kills my nightly export process.  This issue has moved from being a nuisance to a problem.  </p>\n\n<p>What I need is to have an option to insert only unique data.  If there are duplicates, select the first encountered row of the duplicate rows.  Is there SQL Syntax available that could help me do this?  I know of the <strong>DISTINCT ROW</strong> clause but that doesn't work in my case because for most of the offending records, the entirety of the data is non-unique except for the fields which comprise the PK.</p>\n\n<p>In my case, it is more important for my primary keys to remain unique in my SQL Server DB cache, rather than having a full snapshot of data.  Is there something I can do to force this constraint on the export in SSIS/SQL Server with out crashing the process?</p>\n\n<p><strong>EDIT</strong></p>\n\n<p>Let me further clarify my request.  What I need is to assure that the data in my exported SQL Server tables maintains the same keys that are maintained the AS400 data tables.  In other words, creating a unique Row Count identifier wouldn't work, nor would inserting all of the data without a primary key.</p>\n\n<p>If a bug in the AS400 software allows for mistaken, duplicate PKs, I want to either ignore those rows or, preferably, just select one of the rows with the duplicate key but not both of them.</p>\n\n<p>This SELECT statement should probably happen from the SELECT statement in my SSIS project which connects to the mainframe through an ODBC connection.</p>\n\n<p>I suspect that there may not be a \"simple\" solution to my problem.  I'm hoping, however, that I'm wrong.</p>\n"},{"tags":["sql","tsql","join","sql-server-2008-r2","nvarchar"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":2,"view_count":97,"score":-2,"question_id":12934713,"title":"Update Query with NVARCHAR(max) in SQL Server","body":"<p>Have an issue with SQL Server performance and wanted to see if anyone can give some tips about improving the performance of an update query. </p>\n\n<p>What I'm doing is updating one table with data from another table. Here's some of the basics:</p>\n\n<ul>\n<li>SQL Server 2008 R2</li>\n<li>Data is pumped to <code>WO</code> table originally from other system (pumped in using datareader and sqlbulkcopy in ADO.NET)</li>\n<li>Additional data is pumped to <code>TEMP_REMARKS</code> (pumped in using datareader and sqlbulkcopy in ADO.NET)</li>\n<li>Unfortunately, combining the <code>WO</code> and <code>REMARKS</code> in the originating system (via the reader query) is not possible (mainly performance reasons)</li>\n<li>Update to <code>WO</code> occurs using value from <code>TEMP_REMARKS</code> where two columns are updated</li>\n<li>Note that the column being transferred from <code>TEMP_REMARKS</code> to <code>REMARKS</code> is a <code>nvarchar(max)</code> and is being placed into another <code>nvarchar(max)</code> column (actually two - see query)</li>\n<li><code>WO</code> has 4m+ records</li>\n<li><code>TEMP_REMARKS</code> has 7m+ records</li>\n</ul>\n\n<p>For the join between the two, the following is what is being used: </p>\n\n<pre><code>/* === UPDATE THE DESCRIPTION  */     \nUPDATE WO\nSET WO_DESCRIPTION = TEMP_REMARKS.REMARKS\nFROM WO \nINNER JOIN TEMP_REMARKS ON WO.WO_DESCRIPTION_ID = TEMP_REMARKS.REMARKS_ID;\n\n/* === UPDATE THE FINDINGS  */\nUPDATE WO\nSET FINDINGS = TEMP_REMARKS.REMARKS\nFROM WO \nINNER JOIN TEMP_REMARKS ON WO.FINDINGS_ID = TEMP_REMARKS.REMARKS_ID;\n</code></pre>\n\n<p>The problem at this point is that the update to the <code>WO</code> table is taking over two hours to complete. I've tried using the <code>MERGE</code> statement with no success. I've got other more completed procedures in the db that don't take nearly as long, so I'm convinced that it is not the configuration of the SQL Server itself. </p>\n\n<p>Is there something that should be done when updating <code>nvarchar(max)</code> columns?  </p>\n\n<p>What can be done to improve the performance of this query?  </p>\n\n<p>Here are the table definitions:</p>\n\n<pre><code>CREATE TABLE [dbo].[WO](\n    [DOCUMENT_ID] [decimal](18, 0) NOT NULL,\n    [WO_DESCRIPTION_ID] [decimal](18, 0) NULL,\n    [WO_DESCRIPTION] [nvarchar](max) NULL,\n    [FINDINGS_ID] [decimal](18, 0) NULL,\n    [FINDINGS] [nvarchar](max) NULL,\n.... bunch of other fields\n CONSTRAINT [PK_WO] PRIMARY KEY CLUSTERED \n(\n    [DOCUMENT_ID] ASC\n)\n</code></pre>\n\n<p>This is the table definition for the <code>TEMP_REMARKS</code>:</p>\n\n<pre><code>CREATE TABLE [dbo].[TEMP_REMARKS](\n    [REMARKS_ID] [decimal](18, 0) NOT NULL,\n    [REMARKS] [nvarchar](max) NULL\n) ON [PRIMARY]\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":12933108,"title":"Retrieving data by date ranges with breaks in SQL Server","body":"<p>I need to retrieve data by selected dates. There is one major detail: user can select two days one after another, and then it can skip some days, and then select another ones.</p>\n\n<p>What is the best way to pass selected dates into a stored procedure and organize filter by such date ranges?</p>\n\n<p>For example, I have the table with the following structure:</p>\n\n<pre><code>CREATE TABLE [dbo].[Events](\n    [ID] [int] IDENTITY(1,1) NOT NULL,\n    [EventDate] [datetime] NOT NULL,\n    [Amount] [float] NOT NULL,\n CONSTRAINT [PK_Events] PRIMARY KEY CLUSTERED \n(\n    [ID] ASC\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n\n<p>With the following data:</p>\n\n<pre><code>INSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-01-01 10:00', 12)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-01-01 11:00', 154)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-01-01 12:00', 4)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-02-01 10:00', 132)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-02-01 11:00', 212)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-03-01 10:00', 712)\nINSERT [dbo].[Events] ([EventDate], [Amount]) VALUES ('2012-03-01 20:00', 892)\n</code></pre>\n\n<p>User wants to retrieve data with Event Date from 2012-01-01 10:00 and 2012-01-01 11:00,\nfrom 2012-03-01 09:00 to 2012-03-01 19:00, etc.</p>\n\n<p>User can select different count of intervals.</p>\n"},{"tags":["sql-server","tsql","in-clause"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":115,"score":1,"question_id":9623178,"title":"SQL Server and Efficiency of Large Range of Values within an IN Clause","body":"<p>I have a case similar to <a href=\"http://stackoverflow.com/questions/1532366/mysql-number-of-items-within-in-clause\">this MySQL question</a> regarding the <code>IN</code> clause, but for SQL Server.</p>\n\n<p>Specifically, I am building an executable SQL string, and within it is the potential for a VERY long list of enumerated items for use within an <code>IN</code> clause (I.E. 1000+).</p>\n\n<p>Is this an efficient way of constructing m filter from a dynamic list of criteria, or should I insert the criteria data into a temp table and then <code>JOIN</code> it to my export table for the filtering operation?</p>\n\n<p>Pros and Cons of each approach would be appreciated if the answer isn't quite straight forward.</p>\n\n<p>I apologize if this question has been asked.  The linked MySQL question is rather old.  I'd imagine that this is a duplicate for SQL Server, but I can't find it.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2145,"score":1,"question_id":5025388,"title":"SQL problem with error \"Invalid data type\"","body":"<p>Using SQL 2008</p>\n\n<p>So I created a User Defined type:</p>\n\n<pre><code>CREATE TYPE dbo.ServiceType AS TABLE (\n[TO_ZONE] varchar(30) NOT NULL,\n[FROM_ZONE] varchar(30) NOT NULL,\n[RATE] decimal(14,2) NOT NULL,\n[SERVICE_TYPE] varchar(255) NOT NULL\n);\n</code></pre>\n\n<p>And when I try to use it I get the error \"parameter or variable @variableName has an invalid data type\"</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[ImportServiceTypeRates]\n\n(@ServiceTypes dbo.ServiceType)  --I have tried it without the \"dbo.\" as well\n</code></pre>\n\n<p><strong>Update</strong></p>\n\n<p>So I added \"READONLY\" to my variable declaration</p>\n\n<pre><code>@ServiceTypes dbo.ServiceType READONLY\n</code></pre>\n\n<p>And I now get the error \"The parameter @Servicetype cannot be declared READONLY because it is not a table-valued parameter\"  ?WHAT?  </p>\n\n<p>I thought the \"CREATE TYPE ServiceType as TABLE\" was what declared it such???</p>\n\n<p>I also have showing in Types\\User-Defined Table Types\\dbo.ServiceType</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":12931630,"title":"Check before inserting values in the table","body":"<p>I have created two tables: Account and Loan</p>\n\n<ul>\n<li>In Account table I have <code>Acc_id</code> as primary key.</li>\n<li>In Loan table I have <code>Loan_id</code> as primary key and <code>Acc_id</code> as foreign key referencing the <code>Acc_id</code> in the Account table.</li>\n</ul>\n\n<p>Now I have inserted 5 records in Account table..</p>\n\n<pre><code>101 YEARLY                  BEN                             21.12.2012\n102 YEARLY                  PARKER                          31.07.2013\n103 HALFYEARLY              MARY                            26.04.2013\n104 TWOYEARS                OSBORN                          01.01.2014\n105 TWOYEARS                HARRY                           04.06.2015\n106 YEARLY                  PENNY                           25.12.2013\n</code></pre>\n\n<p>Now I have to insert values in loan table.</p>\n\n<p>eg: <code>insert into loan values((203,'PARKER','500$',103(Ac_id),'25.11.2014');</code></p>\n\n<p>Now in the above query I have given Ben's <code>Acc_no</code> incorrectly. I have entered the <code>acc_no</code> of Mary, but it will be inserted successfully. </p>\n\n<p>I need a procedure to prevent this from happening, can anyone tell me if this is possible?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":62,"score":2,"question_id":12931421,"title":"Find the closest number based on the weight of combination for two pairs","body":"<p>This is a continuation of my previous question <a href=\"http://stackoverflow.com/questions/12928718/what-is-the-efficient-way-to-generate-combination-of-items-in-sql-server\">What is the efficient way to generate combination of items in SQL Server?</a> Let me explain the real scenario as what I am looking for and why....</p>\n\n<p>Suppose I have a table as under</p>\n\n<pre><code>Declare @t table(Number Int)\nInsert Into @t Values(10),(20),(30),(40),(18)\n\nNumber\n10\n20\n30\n40\n18\n</code></pre>\n\n<p>and I need to look for a number say 35 (or closest).</p>\n\n<pre><code>Declare @NumberToLookfor = 35\n</code></pre>\n\n<p>Now the search will happen based on the weight of combination for two pairs. Let me explain.</p>\n\n<pre><code>10+20 = 30\n\n10+30 = 40\n\n10+40 = 50\n\n10+18 = 28\n\n20 + 30 = 50\n\n20 + 40 = 60\n\n20 + 18 = 38\n\n30 + 40 = 70\n\n30 + 18 = 48\n\n40 + 18 = 58\n</code></pre>\n\n<p>so we can figure out that the weight of any two numbers are teh candidates here e.g. (10,20), (10,30)...(40,18)</p>\n\n<p>Once we get that, the first 3 closest pairs will be (20,18), (10,20) , (10,30) in this case. Because teh dirtance between 35 and 38 (20+18) is 3 whichle it is 5 for the other pairs  (10,20) , (10,30).</p>\n\n<p>I think that the explanation is clear to understand what I am looking for.(If not please let me know)</p>\n\n<p>What is the most efficient way of doing so?</p>\n\n<p>My attempt</p>\n\n<pre><code>Declare @t table(Number Int)\nInsert Into @t Values(10),(20),(30),(40),(18)\n\n;WITH Cte1 (Number,Ids,TotalWeight) AS \n( \n    SELECT  Number           \n            , ',' + CAST(Number AS VARCHAR(MAX)) \n            ,CAST(Number AS INT) \n    FROM @t \n    UNION ALL \n    SELECT  p.Number \n            ,c.Ids + ',' +  CAST(p.Number AS VARCHAR(MAX)) \n            ,CAST(c.TotalWeight + p.Number AS INT)            \n    FROM @t AS p JOIN Cte1 c ON p.Number &lt; c.Number\n),Cte2 AS( \n    SELECT          \n        *\n        ,DENSE_RANK() OVER(ORDER BY ABS(TotalWeight - 35)) [rank] \n    FROM Cte1 \n    WHERE (LEN(Ids) - LEN(REPLACE(Ids, ',', '')))/LEN(',') = 2 \n)\n\nselect *\nfrom Cte2 where [rank] &lt;= 2\n</code></pre>\n\n<p>It works.</p>\n\n<p><img src=\"http://i.stack.imgur.com/SIrU6.png\" alt=\"enter image description here\"></p>\n\n<p>But if the values grows very big say more than 50 or so, then it becomes very very in efficient. Because in the first CTE , I am finding out the full permutation and in the second Cte choosing those values where only two elements participated.</p>\n\n<p>so when the value grows big, the first Cte behaves very very slowly.</p>\n\n<p>Is there any other way of doing so even for big tables.</p>\n\n<p>DDL provided</p>\n\n<pre><code>Declare @t table(Number Int)\nInsert Into @t Values  \n(1),(2),(3),(4),(5),(6),(7),(8),(9),(10),(11),(12),(13),(14),(15),(16),(17),(18),(19),(20), \n(21),(22),(23),(24),(25),(26),(27),(28),(29),(30),(31),(32),(33),(34),(35),(36),(37),(38),(39),(40), \n(41),(42),(43),(44),(45),(46),(47),(48),(49),(50),(51),(52),(53),(54),(55),(56),(57),(58),(59),(60), \n(61),(62),(63),(64),(65),(66),(67),(68),(69),(70),(71),(72),(73),(74),(75),(76),(77),(78),(79),(80), \n(81),(82),(83),(84),(85),(86),(87),(88),(89),(90),(91),(92),(93),(94),(95),(96),(97),(98),(99),(100) \n</code></pre>\n\n<p>Many thanks in advance</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","cursor"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12929083,"title":"How do I use a simple query to search a list of data from a table and return non-duplicate results in a table?","body":"<p>I am trying to loop through the data in a table, and using the data to search to return the results in another table. </p>\n\n<p>How do I prevent duplicates from adding to the table? Note that the order of the query results adding are very important. So if the results are alr added, I don't want them to be added again. Note that the original ranking done by the full search category is misleading, I don't want to use that.</p>\n\n<p>I am using cursor, but I was told it can be solved using simple query, how do I do that? </p>\n\n<p>Below is the code.</p>\n\n<pre><code> ...\n\n    DECLARE @subQ NVARCHAR(200)\n    SET @subQ = ''\n\n    DECLARE cur1 CURSOR FOR\n    SELECT combination FROM @Subqueries\n\n    OPEN cur1\n    FETCH NEXT FROM cur1 INTO @subQ\n\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        INSERT INTO @Results (app_id, rank, importance)\n        SELECT app_id, rank, 1\n        FROM CONTAINSTABLE(dbo.Applications, display_name, @subQ) KEY_TBL\n        INNER JOIN Applications App\n        ON KEY_TBL.[KEY] = App.app_id\n\n        FETCH NEXT FROM cur1 INTO @subQ   \n    END   \n\n    CLOSE cur1\n    DEALLOCATE cur1\n\n    ...\n</code></pre>\n"},{"tags":["sql-server","tsql","sql-server-2008-r2"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":58,"score":0,"question_id":12928718,"title":"What is the efficient way to generate combination of items in SQL Server?","body":"<p>This is what I have</p>\n\n<pre><code>Use [tempdb]\nCREATE TABLE #t(Id Int Identity, InputValues INT) \nINSERT INTO #t VALUES\n(1),(2),(3),(4)\n\n;WITH Cte (Id,CombinedIds) AS   \n(   \n    SELECT  Id         \n            , ',' + CAST(Id AS VARCHAR(MAX))\n    FROM #t  \n    UNION ALL   \n    SELECT p.Id    \n            ,c.CombinedIds + ',' +  CAST(p.Id AS VARCHAR(MAX)) \n    FROM #t AS p JOIN Cte c ON p.Id &lt; c.Id\n)\n\nselect * from Cte\nOPTION (MAXRECURSION 0)\nDROP TABLE #t\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/KsU0t.png\" alt=\"enter image description here\"></p>\n\n<p>For a small dataset this works fine. But when the data increase to say 100 or more it is very inefficient. It takes more than half an hour and still runs.</p>\n\n<p>What is the most efficient way of generating the same?</p>\n\n<p><strong>DDL</strong></p>\n\n<pre><code>INSERT INTO #t VALUES\n(1),(2),(3),(4),(5),(6),(7),(8),(9),(10),(11),(12),(13),(14),(15),(16),(17),(18),(19),(20),\n(21),(22),(23),(24),(25),(26),(27),(28),(29),(30),(31),(32),(33),(34),(35),(36),(37),(38),(39),(40),\n(41),(42),(43),(44),(45),(46),(47),(48),(49),(50),(51),(52),(53),(54),(55),(56),(57),(58),(59),(60),\n(61),(62),(63),(64),(65),(66),(67),(68),(69),(70),(71),(72),(73),(74),(75),(76),(77),(78),(79),(80),\n(81),(82),(83),(84),(85),(86),(87),(88),(89),(90),(91),(92),(93),(94),(95),(96),(97),(98),(99),(100)\n</code></pre>\n\n<p>Thanks in advance</p>\n"},{"tags":["tsql","ssis","sql-server-2000","rownumber"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12923117,"title":"Modify SQL query with Row_Number() and partition functions for SQL Server 2000","body":"<p>This is my current SQL query:</p>\n\n<pre><code>SELECT \n   ROW_NUMBER() OVER(PARTITION BY [Machine_ID] ORDER BY Version DESC) AS ROW, \n   MachineList.*\nFROM  \n   MachineList\n</code></pre>\n\n<p>Basically, I want to get distinct machine information. If several machines have the same <code>ID</code>, then choose the one with latest version.</p>\n\n<p>However, SQL Server 2000 does not support the <code>ROW_Number</code> function. Is there any alternative for the SQL above?</p>\n\n<p>P.S. most solutions I found on line are using temp table. But I could not use temp table because this query will be used in SSIS. </p>\n"},{"tags":["sql","tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":71,"score":0,"question_id":12913024,"title":"how to substract two sums based on different field values in one table (view)","body":"<p>example: i need the numbers of which the sum of the amount where id = 1 is not equal of the sum of the amount where id &lt;> 1, together with the id's and difference.<br>\nThe table (view in this case) may look like this:</p>\n\n<pre><code>NUMBER   AMOUNT   ID\n\n0001     500       1\n0001     500       2\n0002     400       3\n0003     299       1\n0003     300       3\n0003     300       3\n</code></pre>\n\n<p>Many thanks for your help on this one.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","index"],"answer_count":3,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":959,"score":7,"question_id":2292662,"title":"How important is the order of columns in indexes?","body":"<p>I've heard that you should put columns that will be the most selective at the beginning of the index declaration.  Example:</p>\n\n<pre><code>CREATE NONCLUSTERED INDEX MyINDX on Table1\n(\n   MostSelective,\n   SecondMost,\n   Least\n)\n</code></pre>\n\n<p>First off, is what I'm saying correct?  If so, am i likely to see large differences in performance by rearranging the order of the columns in my index or is it more of a \"nice to do\" practice?</p>\n\n<p>The reason I'm asking is because after putting a query through the DTA it recommended that I create an index that had almost all of the same columns in it as an existing index, just in a different order.  I was considering just adding the missing columns to the existing index and calling it good.  Thoughts?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12921984,"title":"database engine tuning wizard \"apply recommendations\" is disabled","body":"<p>I just forced the database engine tuning wizard in ssms 2008 to analyze a 5mb trace.</p>\n\n<p>I got a list of recommendations returned to me, in terms of indexes to implement; however, I am unable to apply the recommendations because it is greyed out:</p>\n\n<p><img src=\"http://i.stack.imgur.com/7ukPl.png\" alt=\"enter image description here\"></p>\n\n<p>Does anyone know whether this is a bug? How would I manually implement the changes?</p>\n\n<p>Thank you so much for your guidance.</p>\n"},{"tags":["sql","tsql","data"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":105,"score":2,"question_id":12922326,"title":"SQL Flattening data","body":"<p>I'm by no means a SQL expert and just about know my way around it.</p>\n\n<p>I need to flatten some data in order to produce it for SQL Reporting purposes.</p>\n\n<p>Herewith my query which I dont think is optimal since it's slow and I'm sure there are 10 better way to do this:</p>\n\n<p>The core column here is InspectionID which is the primary key on Inspections table</p>\n\n<p>Any advice. Tx</p>\n\n<pre><code>SELECT      \n    INSP.HouseSiteNo,\n    (SELECT TOP 1 WORKFLOWSTATES.Name FROM INSPECTIONWORKFLOWITEM WFITEM \n        INNER JOIN WORKFLOWSTATES ON WFITEM.WorkflowStateID = WORKFLOWSTATES.WorkflowStateID\n        WHERE WFITEM.InspectionID = INSP.InspectionID AND WORKFLOWSTATES.StateNumber = 1) as StateName\n    FROM INSPECTIONS INSP       \nORDER BY HouseSiteNo\n</code></pre>\n\n<p>The table structures as follow:</p>\n\n<p>INSPECTIONS:</p>\n\n<pre><code>HouseSiteNo     HouseType    ProjectID                              InspectionID\n1                A           543C6381-8704-4129-B484-05B02927F690   E061F76F-8998-450B-B08C-DA2817B310A4\n2                A           543C6381-8704-4129-B484-05B02927F690   E0D1F3DB-51D4-465A-A0B4-ACFFF181DC56\n</code></pre>\n\n<p>INSPECTIONWORKFLOWITEM</p>\n\n<pre><code>InspectionID                            WorkflowStateID                         DateStarted               StateCompleted    ID\nFAA4E366-1D57-4699-982C-001FF351D717    AB2B7DA0-A90A-46FB-8F4B-8E662191E380    2012-09-09 00:00:00.000 0   D77332CB-D026-409A-814D-5632C109850A\nFAA4E366-1D57-4699-982C-001FF351D717    E2AC895A-0986-4A03-B104-A727D41405E3    2012-09-09 00:00:00.000 0   F118FD02-20C4-4B45-8539-6F8BDC6B3868\nFAA4E366-1D57-4699-982C-001FF351D717    F0469593-1B6B-4F98-92AE-DF50E76B9ED8    2012-09-09 00:00:00.000 0   8FBEE61B-D7B3-4D13-9FC8-730EB0FE7C95\nFAA4E366-1D57-4699-982C-001FF351D717    5929D0CA-E8B0-42EE-9CF4-E3FBC9973AA6    2012-09-09 00:00:00.000 0   02646FE5-B338-4D6F-B5F5-7984B0EF7BF5\nFAA4E366-1D57-4699-982C-001FF351D717    ECDDB790-88A4-4654-889D-BCA577C35CA8    2012-09-09 00:00:00.000 0   0B9C26FA-8D9D-4552-A3FE-84D4D21F5791\nFAA4E366-1D57-4699-982C-001FF351D717    099D66A4-16F2-4E72-A42A-06B4D6DC0102    2012-09-09 00:00:00.000 0   3B90F113-5194-4ED2-B920-8DA004C9EA5C\nFAA4E366-1D57-4699-982C-001FF351D717    66132F53-0A0E-431A-AD84-ADE77656CDF0    2012-09-09 00:00:00.000 0   05223484-8BB3-43A8-A9A8-C8FBC6270186\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    F0469593-1B6B-4F98-92AE-DF50E76B9ED8    2012-09-09 00:00:00.000 0   A1471AF4-B733-488C-86B4-FB29970E536E\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    ECDDB790-88A4-4654-889D-BCA577C35CA8    2012-09-09 00:00:00.000 0   30F3A1F9-6E51-4504-A9FD-B32FD2B35B39\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    5929D0CA-E8B0-42EE-9CF4-E3FBC9973AA6    2012-09-09 00:00:00.000 0   760D4907-ED6C-4D84-AED9-775FBBAE5123\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    AB2B7DA0-A90A-46FB-8F4B-8E662191E380    2012-09-09 00:00:00.000 0   49D632C7-31D0-4818-AC36-564F157D1959\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    66132F53-0A0E-431A-AD84-ADE77656CDF0    2012-09-09 00:00:00.000 0   C6771081-198D-475B-BA09-14BB696567DA\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    099D66A4-16F2-4E72-A42A-06B4D6DC0102    2012-09-09 00:00:00.000 0   F265B140-25C5-46CA-B060-2A27CD9F9D00\n9AC52A0A-BC2D-4BBD-9585-0028C07ACC27    E2AC895A-0986-4A03-B104-A727D41405E3    2012-09-09 00:00:00.000 0   E56AEC15-4BA1-4089-B1A7-3BF054568929\n</code></pre>\n\n<p>WORKFLOWSTATES</p>\n\n<pre><code>WorkflowStateID                         Name          StateNumber\n099D66A4-16F2-4E72-A42A-06B4D6DC0102    State 3     3\nAB2B7DA0-A90A-46FB-8F4B-8E662191E380    State 6     6\nE2AC895A-0986-4A03-B104-A727D41405E3    State 1     1\n66132F53-0A0E-431A-AD84-ADE77656CDF0    State 2     2\nECDDB790-88A4-4654-889D-BCA577C35CA8    State 5     5\nF0469593-1B6B-4F98-92AE-DF50E76B9ED8    State 7     7\n5929D0CA-E8B0-42EE-9CF4-E3FBC9973AA6    State 4     4\n</code></pre>\n"},{"tags":["tsql","datediff"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":9842,"score":3,"question_id":870204,"title":"Using DATEDIFF in T-SQL","body":"<p>I am using DATEDIFF in an SQL statement.  I am selecting it, and I need to use it in WHERE clause as well.  This statement does not work...</p>\n\n<pre><code>SELECT DATEDIFF(ss, BegTime, EndTime) AS InitialSave\nFROM MyTable\nWHERE InitialSave &lt;= 10\n</code></pre>\n\n<p>It gives the message: <em>Invalid column name \"InitialSave\"</em></p>\n\n<p>But this  statement works fine...</p>\n\n<pre><code>SELECT DATEDIFF(ss, BegTime, EndTime) AS InitialSave\nFROM MyTable\nWHERE DATEDIFF(ss, BegTime, EndTime) &lt;= 10\n</code></pre>\n\n<p>The programmer in me says that this is inefficient (seems like I am calling the function twice).  </p>\n\n<p>So two questions.  Why doesn't the first statement work?  Is it inefficient to do it using the second statement?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12924034,"title":"tsql dynamic sql best approach","body":"<p>The dynamica query I have below works but wondering if what I have below can be optimized or if there is a better way of doing it.</p>\n\n<p>I have a web form where the user enters a location and Date Collected. For the date collected, I have a From Date Collected and To Date Collected. The user an leave the To date collected blank in which case it will do anything greater than the From Date Collected.  </p>\n\n<p>Note how I am doing the IS NOT NULL and 1=1 below.  Also wondering if a dynamic SQL is the best approach or if there is a simpler way of doing this.</p>\n\n<pre><code>    DECLARE @sql varchar(max);\n\n    SET @sql = 'SELECT * from tblProgram WHERE 1=1' \n\n    IF (@Location IS NOT  NULL)\n    BEGIN\n      SET @sql = @sql + ' AND Location = ' +  @Location\n    END      \n\n    IF (@FromDateCollected IS NOT  NULL AND @ToDateCollected IS NOT NULL)\n    BEGIN\n         SET @sql = @sql + ' AND pw.DateCollected &gt;= ' +  QUOTENAME(convert(varchar, @FromDateCollected,101),'''') \n         + ' AND pw.DateCollected &lt;= ' + QUOTENAME(convert(varchar, @ToDateCollected,101),'''')\n\n    END\n    ELSE IF (@FromDateCollected IS NOT  NULL AND @ToDateCollected IS  NULL)\n    BEGIN\n      SET @sql = @sql + ' AND pw.DateCollected &gt;= ' +  QUOTENAME(convert(varchar, @FromDateCollected,101),'''') \n\n    END \n\n   exec(@sql)\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","date","datetime"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":119,"score":0,"question_id":12921808,"title":"Convert to MM/YYYY format","body":"<p>I have some bad data in the database for a varchar field.\nData includes: </p>\n\n<pre><code>10/2012\nMay, 2010\nAugust., 2010\n05/10/2009\n</code></pre>\n\n<p>But now I need to clean up these data &amp; update the column with MM/YYYY format. Anyone has any suggestions for doing this easier?</p>\n"},{"tags":["tsql","sybase"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12828271,"title":"How to skip insertion of a duplicate record and continue in Sybase T-SQL?","body":"<p>I am inserting several million rows using the following simple <code>insert</code> clause:</p>\n\n<pre><code>insert into DEST_TABLE\nselect *\nfrom SRC_TABLE\n</code></pre>\n\n<p>However, there may be duplicates while inserting, which will throw an error and the entire operation will end.</p>\n\n<p>Is there a way to perform the insertion operation from start to finish and not break from duplicate insertion errors aka. ignore duplicate insertion errors and do not insert them?</p>\n"},{"tags":["sql","tsql","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":139,"score":0,"question_id":11306572,"title":"Pivoting on two comma delimited columns","body":"<p>I am struggling with this one, I have two fields in a table one contains the header names, the other contains the results</p>\n\n<p>eg,</p>\n\n<pre><code>ResultID  TestID   MemberID    HeaderDefinition             ResultDefinition\n1         1        1           Minutes Exercised|KJ Burnt   60|900\n2         2        1           Height|Weight|BMI            142|94|35\n3         1        2           Minutes Exercised|KJ Burnt   70|1000\n4         2        3           Height|Weight|BMI            150|60|20\n</code></pre>\n\n<p>What I would like to do is pass in a TestID and see it Pivoted on the header</p>\n\n<p>eg. Test 1</p>\n\n<pre><code>MemberID     Minutes Exercised    KJ Burnt\n1            60                   900\n2            70                   1000\n</code></pre>\n\n<p>eg. Test 2</p>\n\n<pre><code>MemberID     Height     Weight    BMI\n1            142        94        35\n3            150        60        20\n</code></pre>\n\n<p>I have looked at all the standard Pivoting examples and dynamic data but it works on using the same field, I need one field to define the headers and another to define the results and not sure how to marry them up into the examples above, any help would be appreciated.</p>\n\n<p>I can't alter the structure of the data by the way.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12908486,"title":"How can I get the average difference between the max and min dates?","body":"<p>I am trying to get the <strong>average</strong> number of months difference between two dates:</p>\n\n<pre><code>select client_id, \n        avg(12*(year(MAX(received_date))-year(min(received_date))) \n        + MONTH(MAX(received_date))-MONTH(min(received_date)))\n        from tmpTwoAccessions\n        group by CLIENT_ID,PATIENT_ID\n</code></pre>\n\n<p>I am getting this message:</p>\n\n<pre><code>Cannot perform an aggregate function on an expression containing an aggregate or a subquery.\n</code></pre>\n\n<p>Can you please advise me on what am I doing incorrectly here?\nThanks so much for your guidance.</p>\n"},{"tags":["sql-server-2008","tsql","table","collation","temp"],"answer_count":1,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":726,"score":3,"question_id":9648987,"title":"T-SQL Default Collation of temporary table","body":"<p>How can I check which is the collation of a temporary table?</p>\n\n<p>I want to do this, because I what to check what happens if I have database with a specific collation, different from the SQL Server instance and create a temporary table.</p>\n\n<p>Let's say we have this scenario:</p>\n\n<p>SQL Server 2008 - Latin1_General_CS_AS</p>\n\n<p>Test Database - Estonian_CS_AS</p>\n\n<p>Then create table #Test without specifying the collation. Which will be the collation of the table?</p>\n\n<p>I think Estonian_CS_AS, but in the test I am doing is said Latin1_General_CS_AS. That's why I need to find a SQL statement to check this.</p>\n\n<p>Note: from what I have read, I think that the collation of a temporary objects is defined by the tempdb collation. But if this is true, what difines its kind?</p>\n"},{"tags":["sql","sql-server","oracle","tsql","sql-server-2008"],"answer_count":3,"favorite_count":10,"up_vote_count":20,"down_vote_count":0,"view_count":9522,"score":20,"question_id":2046037,"title":"SQL Server: Can I Comma Delimit Multiple Rows Into One Column?","body":"<h1>Creating Comma Separated Lists In SQL</h1>\n\n<p><br/>\nHi All,</p>\n\n<p>I am attempting to merge something like this in my SQL Server database:</p>\n\n<pre>[TicketID], [Person]\n T0001       Alice\n T0001       Bob\n T0002       Catherine\n T0002       Doug\n T0003       Elaine</pre>\n\n<p>Into this:</p>\n\n<pre>[TicketID], [People]\n T0001       Alice, Bob\n T0002       Catherine, Doug\n T0003       Elaine</pre>\n\n<p>I need to do this in both SQL Server and Oracle.</p>\n\n<p>I have found the function <code>GROUP_CONCAT</code> for MySQL that does exactly what I need here, but MySQL is not an option here.</p>\n\n<p><strong>EDIT:</strong> Test bench:</p>\n\n<pre><code>DECLARE @Tickets TABLE (\n    [TicketID] char(5) NOT NULL,\n    [Person] nvarchar(15) NOT NULL\n)\n\nINSERT INTO @Tickets\nSELECT 'T0001', 'Alice' UNION ALL\nSELECT 'T0001', 'Bob' UNION ALL\nSELECT 'T0002', 'Catherine' UNION ALL\nSELECT 'T0002', 'Doug' UNION ALL\nSELECT 'T0003', 'Elaine'\n\nSELECT * FROM @Tickets\n</code></pre>\n"},{"tags":["tsql","sql-server-2000","union"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":57,"score":-1,"question_id":12921123,"title":"T-SQL CASE (SQL Server 2000)","body":"<p>I have a T-SQL query that I need to total out the counts for the <code>CASE</code> statements. </p>\n\n<p>I tried to add a UNION but I am getting an error:</p>\n\n<blockquote>\n  <p><em>All queries in an SQL statement containing a UNION operator must have\n  an equal number of expressions in their target lists.</em></p>\n</blockquote>\n\n<p>Any ideas?  Thanks. </p>\n\n<p>Query:</p>\n\n<pre><code>SELECT \n   CustomerID, Name, DueDate, \n   CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) &gt;= 1 \n            THEN PaymentAmount ELSE 0 \n   END AS [Early],\n   CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) &gt;=0 \n            THEN PaymentAmount ELSE 0 \n   END AS [On Time],\n   CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) = -1 \n            THEN PaymentAmount ELSE 0 \n   END AS [Late]\nFROM \n    Customers \nWHERE \n    DATEDIFF(MONTH, PaymentDate,DueDate), GetDate()) = 1\n    AND PaymentAmount= DuesAmount\n\nUNION\n\nSELECT \n    '-Total', '', CustomerID, Name, DueDate,\n    SUM(CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) &gt;= 1 \n               THEN PaymentAmount ELSE 0 END) AS [Early],\n    SUM(CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) &gt;= 0 \n               THEN PaymentAmount ELSE 0 END) AS [On Time],\n    SUM(CASE WHEN DATEDIFF(Month, PaymentDate, DueDate) = -1 \n               THEN PaymentAmount ELSE 0 END) AS [Late]\nFROM \n    Customers\nWHERE \n    DATEDIFF(MONTH, PaymentDate,DueDate), GetDate()) = 1\n    AND PaymentAmount = DuesAmount \n</code></pre>\n"},{"tags":["sql-server-2008","tsql","csv","aggregation"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":103,"score":0,"question_id":12920013,"title":"T-SQL: split and aggregate comma-separated values","body":"<p>I have the following table with each row having comma-separated values:</p>\n\n<pre><code>ID\n-----------------------------------------------------------------------------\n10031,10042\n10064,10023,10060,10065,10003,10011,10009,10012,10027,10004,10037,10039\n10009\n20011,10027,10032,10063,10023,10033,20060,10012,10020,10031,10011,20036,10041\n</code></pre>\n\n<p>I need to get a count for each <code>ID</code> (a groupby).</p>\n\n<p>I am just trying to avoid cursor implementation and stumped on how to do this without cursors.</p>\n\n<p>Any Help would be appreciated !</p>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":3,"favorite_count":7,"up_vote_count":52,"down_vote_count":1,"view_count":12825,"score":51,"question_id":707335,"title":"T-SQL Cast versus Convert","body":"<p>What is the general guidance on when you should use <code>CAST</code> versus <code>CONVERT</code>? Is there any performance issues related to choosing one versus the other? Is one closer to ANSI-SQL?</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":562,"score":7,"question_id":8004322,"title":"When should I not use a semicolon?","body":"<p>Or: <em>What is not a T-SQL statement?</em></p>\n\n<p>Except to resolve ambiguity, T-SQL syntax does not require a semicolon to terminate a statement. Despite this, <a href=\"http://www.sqlmag.com/blog/puzzled-by-t-sql-blog-15/tsql/semicolon-140706\" rel=\"nofollow\">Itzik Ben-Gan</a> recommends using a semicolon to terminate a T-SQL statement because it makes code cleaner, more readable, easier to maintain, and more portable.</p>\n\n<p>I don't know a precise definition of what a valid T-SQL statement is, so I might be confused here. But as far as I know, a BEGIN...END block is a T-SQL statement, so should be terminated by a semicolon. For example:</p>\n\n<pre><code>IF OBJECT_ID('tempdb.dbo.#TempTable') IS NOT NULL\nBEGIN\n  DROP TABLE #TempTable;\nEND;\n</code></pre>\n\n<p>The code example in Microsoft's <a href=\"http://msdn.microsoft.com/en-us/library/ms190487.aspx\" rel=\"nofollow\">BEGIN...END documentation</a> supports this conjecture:</p>\n\n<pre><code>USE AdventureWorks2008R2;\nGO\nBEGIN TRANSACTION;\nGO\nIF @@TRANCOUNT = 0\nBEGIN\n    SELECT FirstName, MiddleName \n    FROM Person.Person WHERE LastName = 'Adams';\n    ROLLBACK TRANSACTION;\n    PRINT N'Rolling back the transaction two times would cause an error.';\nEND;\nROLLBACK TRANSACTION;\nPRINT N'Rolled back the transaction.';\nGO\n/*\nRolled back the tranaction.\n*/\n</code></pre>\n\n<p>Itzik Ben-Gan contradicts this in the code example of Excercise 1-1 of <a href=\"http://www.sql.co.il/books/tsqlfund2008/9780735626010_MSSQLServer08T-SQLFundamentals_ch03.pdf\" rel=\"nofollow\">T-SQL Fundamentals</a>:</p>\n\n<pre><code>SET NOCOUNT ON;\nUSE TSQLFundamentals2008;\nIF OBJECT_ID('dbo.Nums', 'U') IS NOT NULL DROP TABLE dbo.Nums;\nCREATE TABLE dbo.Nums(n INT NOT NULL PRIMARY KEY);\n\nDECLARE @i AS INT = 1;\nBEGIN TRAN\n  WHILE @i &lt;= 100000\n  BEGIN\n    INSERT INTO dbo.Nums VALUES(@i);\n    SET @i = @i + 1;\n  END\nCOMMIT TRAN\nSET NOCOUNT OFF;\n</code></pre>\n\n<p>Microsoft's <a href=\"http://msdn.microsoft.com/en-us/library/ms177563.aspx\" rel=\"nofollow\">Transact-SQL Syntax Conventions</a> document states that the semicolon \"will be required in a future version\" of T-SQL.</p>\n\n<p>Commenting on Microsoft's intention to require the semicolon in a future version of T-SQL, Itzik notes some exceptions that aren't supposed to be terminated:</p>\n\n<blockquote>\n  <p>So far it was a requirement to use a semicolon only in specific cases. Now it looks like the plan is to make it a required terminator for all* T-SQL statements in some future version of SQL Server. </p>\n  \n  <p>(*) Naturally there are cases that arent supposed to be terminated with a semicolon; those include (but are not limited to):</p>\n  \n  <ul>\n  <li><p>BEGIN</p></li>\n  <li><p>BEGIN TRAN</p></li>\n  <li><p>IF</p></li>\n  <li><p>ELSE</p></li>\n  <li><p>WHILE</p></li>\n  <li><p>BEGIN TRY</p></li>\n  <li><p>END TRY</p></li>\n  <li><p>BEGIN CATCH</p></li>\n  </ul>\n</blockquote>\n\n<p>Itzik seems to be consistent with himself, but Microsoft itself does not follow his recommendations. Compare Microsoft's <code>BEGIN TRANSACTION;</code> and Itzik's <code>BEGIN TRAN</code> in the previous examples.</p>\n\n<p>In the code I maintain, I have seen even the <code>BEGIN</code> keyword terminated by semicolon:</p>\n\n<pre><code>IF @HasWidget = 0x1\nBEGIN;\n  SELECT WidgetID\n  FROM tbWidgets;\nEND;\n</code></pre>\n\n<p>I believe a T-SQL parser may consider the semicolon following the <code>BEGIN</code> keyword to terminate an empty statement rather than terminate the <code>BEGIN</code> keyword itself; I don't believe that <code>BEGIN</code> itself is a valid T-SQL statement.</p>\n\n<p>This conjecture is supported by the fact that SQL Server 2008 successfully parses and executes the following query:</p>\n\n<pre><code>SELECT 0;;\n</code></pre>\n\n<p>It's so confusing because there is no widely available specification of the T-SQL language, like the <a href=\"http://java.sun.com/docs/books/jls/\" rel=\"nofollow\">Java Language Specification</a> for Java, so nowhere is there a formal definition of a T-SQL statement.</p>\n\n<p>Am I wrong? Does such a specification exist for T-SQL, and is it publicly available?</p>\n\n<p>Otherwise, should just I believe what Itzik says?</p>\n"},{"tags":["tsql","index","sql-server-2008-r2"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12919339,"title":"SQL Non Clustered Index Design","body":"<p>Have a large table T</p>\n\n<ul>\n<li><code>sID Int PK</code>  </li>\n<li><code>pos Int PK</code>   </li>\n<li><code>wID Int PK</code>    </li>\n</ul>\n\n<p>Self joins</p>\n\n<ul>\n<li><code>T2.sID = T1.sID</code>   </li>\n<li><code>T2.pos = T1.pos + 1</code>  </li>\n<li><code>T1.wID = 'alpha'</code>  </li>\n<li><code>T2.wID = 'beta'</code>  </li>\n</ul>\n\n<p>Added an index on <code>(wID, sID)</code> and sure enough it helped (a lot) </p>\n\n<p>In the execution plan noticed the output was sID, pos  </p>\n\n<p>So changed the index to <code>(wID, sID, pos)</code>.</p>\n\n<p>What surprised me is the query plan stayed the same and no improvement in execution time   </p>\n\n<p>So changed the index to <code>(wID)</code></p>\n\n<p>Same query plan and same execution time  </p>\n\n<p>Clearly will go with the smaller index for the same performance  </p>\n\n<p>My question is why is the smaller index as effective?  </p>\n\n<p>Is it because that extra data is the PK?  </p>\n"},{"tags":["sql","tsql","index","sql-update","insert-update"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12904479,"title":"Charindex update statement issue","body":"<p>Thank you in advance! I am working in SQL Server 2008 R2. </p>\n\n<p>What I am trying to do is I have a text type column that has a first and last name and then shows a ^, what I want to do is capture that text leading up to the ^ (so essnetially the first and last name) and append it to the very bottom of another column (not replace) within the same table. </p>\n\n<p>I have tried using charindex but I just receieve the index number and I can't seem to get it to capture the text before the ^ appears, I just get the position of the ^ and also I am having a hard time appending this\ntext chunk to another text type column within the same table. For this I have been trying the updatetext function but it doesn't seem to work. I have scrapped what I have tried thus far because I have gotten anywhere without errors. </p>\n\n<p>So in summary: </p>\n\n<p>I need to capture text at the beginning of a text data type column until it reaches a ^ symbol</p>\n\n<p>Save that text to some sort of variable.</p>\n\n<p>Place (append), along with slight additions, into another text data type column.</p>\n\n<p>It seems like it should be simple but I am having a difficult time, Please make recommendations if possible.\nThank you. </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","select"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":103,"score":0,"question_id":12918061,"title":"Combine 2 SQL SELECT statements","body":"<p>** Evidently some people think my question is not worthy of their time. I whole heartedly appologise for this. However, rather than down voting why not use that time to do something positive and at least tell me what info you would require to make this not be a cr@p question in your eyes. **</p>\n\n<p>I have a list of staff in table <code>tblMembers</code> and a list of clients in table <code>tblClients</code>.</p>\n\n<p>One person may have several client.</p>\n\n<p>The staff member associated with a client is identified by <code>staffId</code> against the client record.</p>\n\n<p>Each staff member has a category Id for the type of clients they have <code>catId</code>.</p>\n\n<p><em><strong>I need to find all of the staff for a given client type and then sort them by the number of clients they have. Staff members without any clients should show a result of 0 rather than not showing.</em></strong></p>\n\n<p>A simplified table structure would be:</p>\n\n<p><code>tblMembers</code>:</p>\n\n<pre><code>Id | catId\n</code></pre>\n\n<p><code>tblClients</code>:</p>\n\n<pre><code>Id | staffId \n</code></pre>\n\n<p>Any help would be greatly appreciated.</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12917555,"title":"Convert Comma Delimited String to bigint in SQL Server","body":"<p>I have a varchar string of delimited numbers separated by commas that I want to use in my SQL script but I need to compare with a bigint field in the database.  Need to know to convert it:</p>\n\n<pre><code>DECLARE @RegionID varchar(200) = null\nSET @RegionID = '853,834,16,467,841,460,495,44,859,457,437,836,864,434,86,838,458,472,832,433,142,154,159,839,831,469,442,275,840,299,446,220,300,225,227,447,301,450,230,837,441,835,302,477,855,411,395,279,303'\n\nSELECT a.ClassAdID,    -- 1\n        a.AdURL,        -- 2\n        a.AdTitle,      -- 3\n        a.ClassAdCatID, -- 4\n        b.ClassAdCat,   -- 5\n        a.Img1,         -- 6\n        a.AdText,       -- 7\n        a.MemberID,     -- 9\n        a.Viewed,       -- 10\n        c.Domain,       -- 11\n        a.CreateDate    -- 12\n        FROM ClassAd a  \n        INNER JOIN ClassAdCat b ON b.ClassAdCAtID = a.ClassAdCAtID\n        INNER JOIN Region c ON c.RegionID = a.RegionID\n        AND a.PostType = 'CPN'\n        AND DATEDIFF(d, GETDATE(), ExpirationDate) &gt;= 0\n        AND a.RegionID IN (@RegionID)\n        AND Viewable = 'Y'\n</code></pre>\n\n<p>This fails with the following error: </p>\n\n<pre><code>Error converting data type varchar to bigint.\n</code></pre>\n\n<p>RegionID In the database is a bigint field.. need to convert the varchar to bigint.. any ideas..?</p>\n\n<p>Many thanks in advance,</p>\n\n<p>neojakey</p>\n"},{"tags":["php","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12897974,"title":"TSQL: passing ids from select clause to stored procedure","body":"<p>I have a procedure called SELECT_DESCRIPTION that receives an id and returns a Description field I need to show in my page. </p>\n\n<p>Now I want to create a new procedure that having a number of ids coming from a select clause like this: </p>\n\n<pre><code>SELECT id FROM MYTABLE \n</code></pre>\n\n<p>Can pass it to the SELECT_DESCRIPTION procedure so I can have the same number of descriptions </p>\n\n<p>If I was using php I would be doing something like this: </p>\n\n<pre><code>$sql=SELECT id FROM MYTABLE;\n$result = mysql_query($sql) //using mysql to make the example faster but TSQL is what I use\nor die(mysql_error());  \n\nwhile($row = mysql_fetch_array( $result )) {\n    $newSql = \"EXEC SELECT_DESCRIPTION @id = '$row[id]'\"; \n//do whatever with $newSql\n\n}\n</code></pre>\n\n<p>But I need to use a procedure. Is is possible to do it? How can I do it? </p>\n\n<p>Thanks a ton! </p>\n"},{"tags":["sql","sql-server","tsql","identity-insert"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":164,"score":1,"question_id":5203432,"title":"batch insertion returns disorder identity fields","body":"<p>I have (tableA) with one identity field (ID), I need to insert multiple rows at once with one insertion operation, so I use table structure as a passing parameter to my stored procedure</p>\n\n<p>I need the inserted id with the order of insertion so i'm running the following query in my SP\n(tableB has the same structure as tableA):</p>\n\n<pre><code>CREATE PROCEDURE ssp_Test\n(\n    tableA tableAType\n)\nAS\nBEGIN\n\nINSERT INTO tableB(field1, field2, ...)\nOUTPUT INSERTED.ID\nSELECT field1, field2, ... from tableA\n\nEND\n</code></pre>\n\n<p>If I run the above procedure with 100 records it returns the newly identity field with the order it inserted to the tableB, but when I run it with 500 records all of the inserted id returns with no reasonable order why this happens?</p>\n\n<p>I don't need another temp table to put it there and sort that and return, i just want to know why its happening and is there any solution without using extra temp table for sorting ?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":601,"score":5,"question_id":6744367,"title":"Most efficient way to calculate the first day of the current Financial Year?","body":"<p>What's the most efficient way to calculate the first day of the current (Australian) Financial Year?</p>\n\n<p>The Australian FY begins on 01-July.</p>\n\n<p>E.g.</p>\n\n<p><code>SELECT dbo.FinancialYearStart('30-Jun-2011')</code> returns 01-Jul-2010.</p>\n\n<p><code>SELECT dbo.FinancialYearStart('01-Jul-2011')</code> returns 01-Jul-2011.</p>\n\n<p><code>SELECT dbo.FinancialYearStart('02-Jul-2011')</code> returns 01-Jul-2011.</p>\n"},{"tags":["sql","sql-server","tsql","updates"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":72,"score":0,"question_id":12913971,"title":"how to update table1 with records from table2 using t-sql","body":"<p>I have two tables:</p>\n\n<p><code>Table1</code>:</p>\n\n<pre><code>RulesVectorID(nullable, primary),Weight,IsDeleted\n</code></pre>\n\n<p><code>Table2</code>:</p>\n\n<pre><code>RulesVectorID(forigen) , Weight,IsDeleted, NumberOfOffers, other fields...\n</code></pre>\n\n<p>I want to do tow things:</p>\n\n<ol>\n<li><p>assign <code>Id</code> to all rows in table1 <code>where RulesVectorID ==null</code></p>\n\n<p>I tried this:</p>\n\n<pre><code>UPDATE myTable1\nSET RulesVectorID = SELECT MAX(RulesVectorID) + 1 FROM myTable1,\nWHERE RulesVectorID IS NULL\n</code></pre></li>\n<li><p>To rows added in step (1) I want to copy their <code>Weight, IsDeleted</code> columns and add 1 to their <code>NumberOfOffers</code></p>\n\n<p>I tried this:</p>\n\n<pre><code>INSERT INTO myTable2 (Weight, IsDeleted, NumberOfOffers, RulesVectorID) \nVALUES (\n  SELECT Weight, IsDeleted, 1, RulesVectorID \n  FROM myTable1 \n  WHERE myTable1.RulesVectorID NOT IN (SELECT RulesVectorID FROM myTable2))\n</code></pre></li>\n</ol>\n\n<p>Is there any cleaner way to do it?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12915993,"title":"Join on to table with multiple matches but only bring back specified match","body":"<p>I have 3 tables.<br>\nTable A contains the data that my query is going to be based on. It contains id1.\nTable B is my connecting table, it contains 2 columns that I'm concerned with: id1 &amp; id2.  </p>\n\n<p>Table C is my lookup table, it contains id2 and ReasonName. I need the column ReasonName and all the data from table A.</p>\n\n<p>If I do the following SQL:</p>\n\n<pre><code> SELECT NAME, \n       STARTDATE, \n       ENDDATE, \n       REASON, \n       ID1 \nFROM   TABLEA \n       LEFT JOIN TABLEB \n              ON TABLEA.ID1 = TABLEB.ID1\n</code></pre>\n\n<p>I am then able to do a second join on to TableC, however this is where the problem lies.\nThere are multiple matches in TableC so therefore my totalrows increases. I need to avoid this.\nSee image for what TableC looks like:</p>\n\n<p><img src=\"http://i.stack.imgur.com/Ymazn.png\" alt=\"enter image description here\"></p>\n\n<p>If my SQL statement now looks like this:</p>\n\n<pre><code> SELECT TABLEA.NAME, \n       TABLEA.STARTDATE, \n       TABLEA.ENDDATE, \n       TABLEA.REASON, \n       TABLEA.ID1, \n       TABLEC.REASONNAME \nFROM   TABLEA \n       LEFT JOIN TABLEB \n              ON TABLEA.ID1 = TABLEB.ID1 \n       LEFT JOIN TABLEC \n              ON TABLEB.ID2 = TABLEC.ID2 \n</code></pre>\n\n<p>Then my rows increase by around 1000. This is because it is quite possible that TableA.id1 matches multiple id2s found in TableC. It then duplicates rows apart from the different TableC.ReasonName.</p>\n\n<p>In TableC there is one ReasonName that I am concerned with. For this example I will say it is reasonf.</p>\n\n<p>What I need is to bring through ReasonName from TableC, BUT only the ones that contain reasonf, the rest I want to say NULL or to do a COALESCE with No Reason.\nI have tried putting a WHERE clause into the statement. See SQL:</p>\n\n<pre><code> SELECT TABLEA.NAME, \n       TABLEA.STARTDATE, \n       TABLEA.ENDDATE, \n       TABLEA.REASON, \n       TABLEA.ID1, \n       TABLEC.REASONNAME \nFROM   TABLEA \n       LEFT JOIN TABLEB \n              ON TABLEA.ID1 = TABLEB.ID1 \n       LEFT JOIN TABLEC \n              ON TABLEB.ID2 = TABLEC.ID2 \nWHERE  TABLEC.ID2 = 'asd1f5as98a4' \n</code></pre>\n\n<p>But then it will only bring though those records where there is a match with reasonf, I want it to display reasonf people and ignore the rest (leave as null or something) so I have no duplicates but my full result set.</p>\n\n<p>I'm thinking I may need to change to a right join or possibly change the WHERE but I'm not entirely sure.</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":41,"score":-1,"question_id":12915339,"title":"t-sql multiplying two tables","body":"<p>I have 2 tables</p>\n\n<pre><code>Plant            config         \n------         --------\n\nTRZ1            KS\n\nMAS1            MT\n</code></pre>\n\n<p>I would like to have below table with 2 columns</p>\n\n<pre><code>RESULT\n------\nTRZ1  KS\n\nTRZ1  MT\n\nMAS1  KS\n\nMAS1   MT\n</code></pre>\n\n<p>Thanks for the help</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12915497,"title":"SQL Server Cross-Database, Cross-Server Relationships","body":"<p>In SQL Server are these things possible</p>\n\n<ol>\n<li>Writing a select query which references tables from different databases on the same server?</li>\n<li>Writing a select query which references tables from different databases on different servers?</li>\n<li>Having a primary key, foreign key relationship between tables in different databases on the same server?</li>\n<li>Having a primary key, foreign key relationship between tables in different databases on different servers?</li>\n</ol>\n\n<p>THanks,</p>\n\n<p>Sachin</p>\n"},{"tags":["sql","tsql","insert"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":290,"score":1,"question_id":8668511,"title":"How can I SELECT top 500 rows from table1 and INSERT them to table2?","body":"<p>I have completely same defined 2 tables : t2 and t1.</p>\n\n<p>t2 has 1000 rows and t1 is totally empty.</p>\n\n<p>How can I SELECT top 500 rows from t2 and INSERT them to t1?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":85,"score":1,"question_id":9213375,"title":"T-SQL COUNT of 'A', 'B', and 'A or B'","body":"<p>Conceptually, I have a table with a list of fruit items.  I want, in a single query, to see counts of how many apples, oranges, 'apples or oranges', and 'other fruit' there are.</p>\n\n<p>How can I achieve this in T-SQL?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":80,"score":1,"question_id":12906776,"title":"how to combat horrific performance when joining on WITH(s)","body":"<p>I do not have permissions to set up indexes on these tables unfortunately. </p>\n\n<p>The first two <code>WITH's</code> are causing this query to run for hours:</p>\n\n<pre><code>;with OneAccession as (\nselect client_id,COUNT(patient_id) PatientCount from\n(\nselect client_id,patient_id\nfrom F_ACCESSION_DAILY\ngroup by CLIENT_ID,PATIENT_ID\nhaving COUNT(ACCESSION_ID)=1\n) a\ngroup by CLIENT_ID\n)\n,\n\nTwoAccessions as (\nselect client_id,COUNT(patient_id) PatientCount from\n(\nselect client_id,patient_id\nfrom F_ACCESSION_DAILY\ngroup by CLIENT_ID,PATIENT_ID\nhaving COUNT(ACCESSION_ID)=2\n) a\ngroup by client_id\n)\n\n\n\nselect\nf.client_id\n, 12*(year(getdate())-year(min(f.received_date))) + MONTH(GETDATE())-MONTH(min(f.received_date))\n, COUNT(distinct f.patient_id) TotalPatients\n, COUNT(f.ACCESSION_ID) TotalSpecimens\n, o.PatientCount  TotalPatientsWOneSpec\n, t.PatientCount TotalPatientsWTwoSpec\nfrom F_ACCESSION_DAILY f\njoin\nOneAccession o\non o.CLIENT_ID=f.CLIENT_ID\njoin\nTwoAccessions t\non t.client_id=f.CLIENT_ID\nwhere f.CLIENT_ID not in (select clientid from SalesDWH..TestPractices)\nand f.SPECIMEN_SOURCE in ('Oral Fluid','Urine')\ngroup by f.CLIENT_ID,o.PatientCount,t.PatientCount\n</code></pre>\n\n<p>If I remove <code>OneAccession</code> and <code>TwoAccessions</code>, I can get results in just a few minutes!</p>\n\n<p>I would be very grateful for any guidance on improving my query syntax in order to speed this up!</p>\n\n<p>Thanks so much.</p>\n"},{"tags":["sql-server-2008","tsql","full-text-search"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":11738511,"title":"name search with Full Text search","body":"<p>Table: User</p>\n\n<pre><code>...|Name                  |...|..\n__________________________________\n...|george walker          |...|..\n...|...                   |...|..\n</code></pre>\n\n<p>Now I want to write a query to get the above record for the following inputs:\n<code>george</code>\n<code>george walker</code> \n<code>george walker bush</code> etc.</p>\n\n<p>ie., alteast half of the words in search string should match but not any word match</p>\n\n<p>How can I write a query for this?</p>\n\n<p>Note: I would like to use <code>Full Text Search</code> feature because this table has few millions of records. <br>\nI doubt if I could use <code>SOUNDEX</code> with <code>Full Text</code></p>\n"},{"tags":["sql-server","sql-server-2005","tsql","sql-server-2008","insert"],"answer_count":11,"favorite_count":3,"up_vote_count":17,"down_vote_count":0,"view_count":24839,"score":17,"question_id":2624713,"title":"How do I insert multiple rows WITHOUT repeating the \"INSERT INTO dbo.Blah\" part of the statement?","body":"<p>I know I've done this before years ago, but I can't remember the syntax, and I can't find it anywhere due to pulling up tons of help docs and articles about \"bulk imports\".</p>\n\n<p>Here's what I want to do, but the syntax is not exactly right... please, someone who has done this before, help me out :)</p>\n\n<pre><code>INSERT INTO dbo.MyTable (ID, Name)\nVALUES (123, 'Timmy'),\n    (124, 'Jonny'),\n    (125, 'Sally')\n</code></pre>\n\n<p>I know that this is <em>close</em> to the right syntax. I might need the word \"BULK\" in there, or something, I can't remember. Any idea?</p>\n\n<p>EDIT: Particularly, I need this for a SQL Server 2005 database. I've tried this code, to no avail:</p>\n\n<pre><code>DECLARE @blah TABLE\n(\n    ID INT NOT NULL PRIMARY KEY,\n    Name VARCHAR(100) NOT NULL\n)\n\nINSERT INTO @blah (ID, Name)\n    VALUES (123, 'Timmy')\n    VALUES (124, 'Jonny')\n    VALUES (125, 'Sally')\n\nSELECT * FROM @blah\n</code></pre>\n\n<p>I'm getting <code>Incorrect syntax near the keyword 'VALUES'.</code></p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":39,"score":1,"question_id":12913245,"title":"distributed system: sql server broker implementation","body":"<p>I have a distributed application consisting of 8 servers, all running .NET windows services. Each service polls the database for work packages that are available.</p>\n\n<p>The polling mechanism is important for other reasons (too boring for right now).</p>\n\n<p>I'm thinking that this polling mechanism would be best implemented in a queue as the .NET services will all be polling the database regularly and when under load I don't want deadlocks. </p>\n\n<p>I'm thinking I would want each .NET service to put a message into an input queue. The database server would pop each message of the input queue one at a time, process it, and put a reply message on another queue.</p>\n\n<p>The issue I am having is that most examples of SQL Server Broker (SSB) are between database services and not initiated from a .NET client. I'm wondering if SQL Server Broker is just the wrong tool for this job. I see that the broker T-SQL DML is available from .NET but the way I think this should work doesn't seem to fit with SSB.</p>\n\n<p>I think that I would need a single SSB service with 2 queues (in and out) and a single activation stored procedure.</p>\n\n<p>This doesn't seem to be the way SSB works, am I missing something ?</p>\n"},{"tags":["xml","tsql","xquery"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":12913724,"title":"SQL Server query xml attribute for an element value","body":"<p>Sorry if this is somewhere else, I have found a lot of similar examples but I have been unable to get it working with my data. 2 days later and I need an answer :(</p>\n\n<p>Basically have a SQL Server table with a column containing XML data. This data contains values I need to extract.</p>\n\n<p>Here is my XML.</p>\n\n<pre><code>  &lt;CustomFields xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns=\"http://www.kaseya.com/vsa/2007/12/ServiceDeskDefinition.xsd\"&gt;\n    &lt;Field fieldName=\"AutoCategory\"&gt;Event Log&lt;/Field&gt;\n    &lt;Field fieldName=\"SType\"&gt;Event Log&lt;/Field&gt;\n    &lt;Field fieldName=\"STag1\"&gt;AgentGuid&lt;/Field&gt;\n    &lt;Field fieldName=\"STag2\"&gt;AlertRegistrationId&lt;/Field&gt;\n    &lt;Field fieldName=\"STag3\"&gt;LogType&lt;/Field&gt;\n    &lt;Field fieldName=\"SValue1\"&gt;619764177412541&lt;/Field&gt;\n    &lt;Field fieldName=\"SValue2\"&gt;104&lt;/Field&gt;\n    &lt;Field fieldName=\"SValue3\"&gt;1380569194&lt;/Field&gt;\n    &lt;Field fieldName=\"SdTicketId\"&gt;RPSv1006330&lt;/Field&gt;\n    &lt;Field fieldName=\"AgentName\"&gt;bla bla&lt;/Field&gt;\n    &lt;Field fieldName=\"MachineGroupGuid\"&gt;86115414719112271316891312&lt;/Field&gt;\n    &lt;Field fieldName=\"OrgFk\"&gt;59165166782128125214185317&lt;/Field&gt;\n    &lt;Field fieldName=\"GuidAgent\"&gt;619764177412541&lt;/Field&gt;\n    &lt;Field fieldName=\"AlertCount\"&gt;0&lt;/Field&gt;\n    &lt;Field fieldName=\"TicketTitle\"&gt;bla bla&lt;/Field&gt;\n    &lt;Field fieldName=\"LegacyId\"&gt;152262&lt;/Field&gt;\n    &lt;Field fieldName=\"LegacyRef\"&gt;152262&lt;/Field&gt;\n    &lt;Field fieldName=\"CwStatus\"&gt;2&lt;/Field&gt;\n    &lt;Field fieldName=\"CwTicketId\"&gt;89495&lt;/Field&gt;\n&lt;/CustomFields&gt;\n</code></pre>\n\n<p>I need to be able to pull out the value associated to the <code>CwTicketId</code> field name.</p>\n\n<p>So in essence, I want to look through the XML to find the node with <code>fieldName = \"CwTicketId\"</code> and to return <code>89495</code> or equivalent value.</p>\n\n<p>Below is the code I have come up with myself, which pulls values out, but the problem is sometimes the XML is ordered differently, so the values are not always on the line that I have specified, hence it returns in accurate data.</p>\n\n<pre><code>;WITH XMLNAMESPACES(DEFAULT N'http://www.kaseya.com/vsa/2007/12/ServiceDeskDefinition.xsd')\nSELECT \n    ref as ServiceDeskID, \n    sdSummary as ServiceDeskSummary,\n    customFields.value('(/CustomFields/Field/node())[17]', 'varchar(100)') as LegacyIDTicketing,\n    customFields.value('(/CustomFields/Field/node())[19]', 'varchar(100)') as CWIDTicketing\nFROM \n    [ksubscribers].[kasadmin].[SDIncident]\n</code></pre>\n\n<p>The second value I also need, but if i can figure out how to pull one value out, I can duplicate for the other.</p>\n\n<p>Hope someone can help as I have started ripping my hair out!</p>\n\n<p>Thanks for the help!!</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","insert"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":322,"score":0,"question_id":1908825,"title":"Query regarding SQL Insert in SQL Server?","body":"<p>I am using SQL Server 2008 and developing a project which is in maintenance phase. </p>\n\n<p>I want to insert record in a table whose primary key is an Integer but not an identity. e.g. table name is <code>tblFiles</code> and fields are <code>ID, FileName, FileContent</code>. </p>\n\n<p>Actually that table is in use so I dont want to make any schema change in it. And I want the key after row insertion because I have to put that in another table. Existing values in the Id column are different integer, means not in sequence. </p>\n\n<p>So I want the query that also returns me the Id value. So I want to insert only <code>FileName</code> and <code>FileContent</code> and some sort of sql to whom I can embed in my insert query which insert a unique Id and also send me that id </p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":65,"score":1,"question_id":12909683,"title":"accessing parent nodes in same level in T-SQL","body":"<p>Let's say I have a database schema like this:</p>\n\n<pre><code>RowId   ParentId   Name\n------ ---------- ------\n1       NULL      Level1\n2       NULL      Level2\n3       1         Leaf1\n4       1         Leaf2\n5       2         Leaf1\n6       3         LeafX\n</code></pre>\n\n<p>Basically, the tree would look as such:</p>\n\n<pre><code>Level1\n       Leaf1\n             LeafX\n       Leaf2\nLevel2\n       Leaf1\n</code></pre>\n\n<p>I need to extract all ancestor LEVEL of LeafX in the most efficient and dynamic way.</p>\n\n<p>So it will output: Leaf1, Leaf2, and Leaf1 (of Level2)</p>\n\n<p>How do I do this in T-SQL? Thanks</p>\n"},{"tags":["c#",".net","tsql","smo","dbcc"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":34,"score":1,"question_id":12911168,"title":"Execute DBCC CHECKCONSTRAINTS with Smo?","body":"<p>Is there an Smo method that executes TSQLs <code>DBCC CHECKCONSTRAINTS</code> on a database and returns  the occuring messages as <code>IEnumerable&lt;String&gt;</code>?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12899793,"title":"SQL string manipulation [Get all text left of '(']","body":"<p>I have some data which looks like so:</p>\n\n<pre><code>SourceOfBooking\n----------------\nCompany1 (Foo)\nCompany2 (Bar)\nCompany3 (Foo1)\nCompany4 (Foo2)\n</code></pre>\n\n<p>I am looking to transform this, so my data only displays:</p>\n\n<pre><code>SourceOfBooking\n----------------\nCompany1\nCompany2\nCompany3\nCompany4\n</code></pre>\n\n<p>I have tried:</p>\n\n<pre><code>LEFT(SourceOfBooking, CHARINDEX(';', SourceOfBooking) )\n</code></pre>\n\n<p>with no luck.</p>\n\n<p>I'm sure I'm missing something incredibly simple... Anyone care to enlighten?</p>\n\n<p>KR, James.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":70,"score":0,"question_id":12907276,"title":"Query Runs Slower The Second Time","body":"<p>I have this massive query that I can typically run in under 2 minutes. However, when I run it a second time about a minute after, it goes on infinitely... so I kill the process and my SSMS session. I don't have any other jobs running in the background. </p>\n\n<p>Is something else being retained on the server? I think I'm missing something as far as how SQL Server works.</p>\n\n<p>Thanks.</p>\n\n<p>EDIT: Here's the SQL (had to do a little obfuscation)</p>\n\n<pre><code>SELECT  pl.OrangeLocationID ,\n    e.EventID ,\n    cr.Title AS [Event Type] ,\n    su.LastName + ', ' + su.FirstName AS FMR ,\n    CONVERT(VARCHAR(20), pl.Report_Date, 101) AS [Report Entry Date] ,\n    l.Name ,\n    l.Number ,\n    ll.SodaPopLocationID AS [SodaPop Location ID] ,\n    l.Zip ,\n    c.Channel ,\n    pl.DT AS [ReportedDate] ,\n    RIGHT(pl.DT_start, 8) AS [ReportedStartTime] ,\n    RIGHT(pl.DT_end, 8) AS [ReportedEndTime] ,\n    [CMS].dbo.dDateDiff(pl.DT_start, pl.DT_end) AS [ReportedDuration] ,\n    pl.scheduled_date AS [ScheduledDate] ,\n    RIGHT(pl.scheduled_start, 8) AS [ScheduledStartTime] ,\n    RIGHT(pl.scheduled_end, 8) AS [ScheduledEndTime] ,\n    [CMS].dbo.dDateDiff(pl.scheduled_start, pl.DT_end) AS [ScheduledDuration] ,\n    e.HoursPaid AS [Rep Hours Worked] ,\n    ISNULL(PP.[RepCount], 0) AS [RepCount] ,\n    CASE WHEN [CMS].dbo.dDateDiff(pl.DT_start, pl.DT_end) = ( e.HoursPaid / ISNULL(PP.[RepCount], 1) )\n         THEN [CMS].dbo.oa_HourDateDiff(pl.DT_start, pl.DT_end)\n         WHEN [CMS].dbo.dDateDiff(pl.scheduled_start, pl.DT_end) = ( e.HoursPaid / ISNULL(PP.[RepCount], 1) )\n         THEN [CMS].dbo.oa_HourDateDiff(pl.scheduled_start, pl.DT_end)\n         ELSE ( e.HoursPaid / ISNULL(PP.[RepCount], 1) )\n    END AS [FinalDuration] ,\n    g.[Description] AS [OA Market] ,\n    g.SodaPop_Region AS [SodaPop Region] ,\n    g.SodaPop_Area AS [SodaPop Area] ,\n    coup4 ,\n    coupo ,\n    coupo_e ,\n    card_num ,\n    promo ,\n    promo_no ,\n    promo_no_o ,\n    highlight1 ,\n    highlight2 ,\n    highlight3 ,\n    mgmt_reaction ,\n    mgmt_reaction_e ,\n    comm_p ,\n    comm_n ,\n    r.comments ,\n    s_fname ,\n    s_lname ,\n    v_title ,\n    ll.KeyAccountCorp AS [Key Account Corp.] ,\n    interact_new + interact_rep AS [interact_total] ,\n    samp_new + samp_rep AS [samp_total] ,\n    purch_new + purch_rep AS [purch_total] ,\n    23 / ( NULLIF(( interact_new + interact_rep ), 0) * 1.0 ) AS [Int_Crate] ,\n    CASE WHEN sampletype = 11 THEN ( purch_new + purch_rep ) / ( NULLIF(( samp_new + samp_rep ), 0) * 1.0 )\n         ELSE NULL\n    END AS [Samp_Crate] ,\n    coup1 + coup2 AS [coup_total] ,\n    CASE WHEN coup1 + coupo &gt; 0 THEN 1\n         ELSE 0\n    END AS [CoupDist] ,\n    DATEPART(month, pl.DT) AS [Visit_Month] ,\n    DATEPART(quarter, pl.DT) AS [Quarter] ,\n    DATEPART(weekday, pl.DT) AS [Weekday] ,\n    CASE DATEPART(weekday, pl.DT)\n      WHEN 6 THEN 'Fri'\n      WHEN 7 THEN 'Sat'\n      WHEN 1 THEN 'Sun'\n      ELSE 'Mon-Thurs'\n    END AS [Weekday_Grouped] ,\n    CASE WHEN dbo.Exception(pl.OrangeLocationID, 12) = 1\n              OR dbo.Exception(pl.OrangeLocationID, 13) = 1\n              OR dbo.Exception(pl.OrangeLocationID, 14) = 1 THEN 1\n         ELSE 0\n    END AS [EVolume] ,\n    CASE WHEN dbo.DoesHaveException(pl.OrangeLocationID, 18) = 1 THEN 1\n         ELSE 0\n    END AS [CVolume] ,\n    CASE WHEN dbo.eException(pl.OrangeLocationID, 9) = 1\n              OR dbo.eException(pl.OrangeLocationID, 22) = 1 THEN 1\n         ELSE 0\n    END AS [Volumes] ,\n    CASE WHEN dbo.eException(pl.OrangeLocationID, 8) = 1\n              OR dbo.eException(pl.OrangeLocationID, 21) = 1 THEN 1\n         ELSE 0\n    END AS [Sales Price] ,\n    CASE WHEN dbo.eException(pl.OrangeLocationID, 11) = 1 THEN 1\n         ELSE 0\n    END AS [Sample Volume] ,\n    ISNULL(i.[NormalizedSold], 0) AS [EQBottlesSold] ,\n    CASE WHEN ISNULL(purch_new, 0) = 0 THEN 0\n         ELSE ISNULL(i.[NormalizedSold], 0) / ( purch_new + purch_rep )\n    END AS [EQBottlesSoldPerPurch] ,\n    ac.AvgSales ,\n    ac.STDEVSales ,\n    ( ISNULL(i.[NormalizedSold], 0) - ac.AvgSales ) / ac.STDEVSales AS [sl] ,\n    ac.AvgPurchasers ,\n    ac.STDEVPurchasers ,\n    ( ISNULL(r.purch_new, 0) - ac.AvgPurchasers ) / ac.STrchasers AS [ZScore_Purchasers] ,  \n\n    ac.AvgConversions ,\n    ac.STDEVConversions ,\n    ( ISNULL(( purch_new + purch_rep ) / ( NULLIF(( interact_new ), 0) ), 0) - ac.AvgConversions )\n    / ac.STDEVConversions AS [ZScore_Conversions] ,\n    ac.[AvgSalesPerPurchaser] ,\n    ac.[STDEVSalesPerPurchaser] ,\n    ( ISNULL(( CASE WHEN ISNULL(purch_new, 0) = 0 THEN 0\n                    ELSE ISNULL(i.[NormalizedSold], 0) / ( purch_new + purch_rep )\n               END ), 0) - ac.[AvgSalesPerPurchaser] ) / ac.[STDEVSalesPerPurchaser] AS [SalesPerPurchaser] ,\n    ( ( ( ISNULL(i.[NormalizedSold], 0) - ac.AvgSales ) / ac.STDEVSales )\n      + ( (ISNULL(( CASE WHEN ISNULL(purch_new + purch_rep, 0) = 0 THEN 0\n                         ELSE ISNULL(i.[NormalizedSold], 0) / ( purch_new + purch_rep )\n                    END ), 0) - ac.[AvgSalesPerPurchaser]) ) ) / 4 AS [core] ,\n    ( ( (( ISNULL(i.[NormalizedSold], 0) - ac.AvgSales ) / ac.STDEVSales) ) / 4 ) + 3 AS [core] ,\n    su.aaUserID ,\n    l.LsocationID \nFROM [CMS_SodaPop].dbo.Schedule pl WITH ( NOLOCK )\n    INNER JOIN [CMS_SodaPop].dbo.Report r WITH ( NOLOCK ) ON r.OrangeLocationID = pl.OrangeLocationID\n    INNER JOIN [CMS].dbo.Users su WITH ( NOLOCK ) ON su.UserID = pl.Rep_FMR\n    INNER JOIN [CMS].dbo.Locations l WITH ( NOLOCK ) ON l.LocationID = pl.LocationID\n    INNER JOIN [CMS].dbo.OrangeReports cr WITH ( NOLOCK ) ON cr.RedID = pl.RedID                                                                 \n    INNER JOIN [CMS_SodaPop].dbo.Events e WITH ( NOLOCK ) ON e.OrangeLocationID = pl.OrangeLocationID\n    INNER JOIN [CMS_SodaPop].dbo.MarketList g WITH ( NOLOCK ) ON g.GroupID = pl.GroupID\n    INNER JOIN [CMS_SodaPop].dbo.Locations ll WITH ( NOLOCK ) ON ll.LocationID = pl.LocationID\n    LEFT JOIN [CMS_SodaPop].dbo.Channels c WITH ( NOLOCK ) ON ll.ChannelID = c.ChannelID\n    LEFT JOIN ( SELECT  PLocationID ,\n                        COUNT(DISTINCT UserID) AS [RepCount]\n                FROM    [CMS_roll].dbo.rollItems WITH ( NOLOCK )\n                WHERE   RedID = 154\n                GROUP BY OrangeLocationID\n              ) PP ON PP.OrangeLocationID = pl.OrangeLocationID\n    LEFT JOIN ( SELECT  OrangeLocationID ,\n                        SUM(NormalizedSold) AS [NormalizedSold]\n                FROM    [Analysis].dbo.[vSodaPop_Retail_Inventory] WITH ( NOLOCK )\n                GROUP BY OrangeLocationID\n              ) i ON i.OrangeLocationID = pl.OrangeLocationID\n    LEFT JOIN [Analysis].dbo.[vSodaPop_Calculations] ac WITH ( NOLOCK ) ON ac.[Quarter] = CASE WHEN DATEPART(MM,\n                                                                                                    [DT]) IN ( 10,\n                                                                                                    11, 12 ) THEN 4\n                                                                                          END\n                                                                           AND ac.[Year] = DATEPART(YY, pl.DT)\nWHERE   pl.Activity = 1\n    AND pl.RedID = 154\n    AND pl.GroupID &lt;&gt; 444\n    AND pl.[DT] &lt; GETDATE()\n    AND DATEPART(YY, [DT]) &gt;= 2010\n    AND ISNULL(i.NormalizedSold, 0) &gt;= 0\n    AND DATEPART(year, GETDATE()) = DATEPART(year, r.Insert_Date)\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","triggers"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":908,"score":3,"question_id":8136937,"title":"SQL Server: check whether a Trigger is Enabled or Disabled?","body":"<p>How we can see which Trigger is Enabled or Disabled in SQL Server 2008?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":72,"score":0,"question_id":12905508,"title":"SQL Understanding Table Unique Constraints","body":"<p>I spent the day trying to debug an issue only now I see what the problem has been all along. I have a unique constraint on my table that forces only unique values as Catalog number. I, however do not seem to have a good understanding of what would constitute unique in this case. I have two product numbers <strong>MP1156</strong> and <strong>MP1156ZF</strong>. </p>\n\n<pre><code>Insert into IDWProductCodes( PRCEAN, PRCGTIN, PRCatalogNumber, PRCIsActive, PRIsReplaced, PrIsREPlacement,PRProductID)\n   Select \n      '11232', '23223', 'MP115BP', 1, 0, 0, '267F104C-6BA4-4C7E-A0C1-6615CBB9DA4C'\n\nInsert into IDWProductCodes( PRCEAN, PRCGTIN, PRCatalogNumber, PRCIsActive, PRIsReplaced, PrIsREPlacement,PRProductID)\n   Select \n      '11232', '23223', 'MP115', 1, 0, 1, '267F104C-6BA4-4C7E-A0C1-6615CBB9DA4C'\n\nInsert into IDWProductCodes( PRCEAN, PRCGTIN, PRCatalogNumber, PRCIsActive, PRIsReplaced, PrIsREPlacement,PRProductID)\n   Select\n      '11232', '23223', 'MP15', 1, 1, 1, '267F104C-6BA4-4C7E-A0C1-6615CBB9DA4C'\n</code></pre>\n\n<p>I get an error:</p>\n\n<blockquote>\n  <p>Msg 2627, Level 14, State 1, Line 5<br>\n  Violation of UNIQUE KEY constraint 'UK_CNUMUNIQUE'. Cannot insert duplicate key in object\n  'dbo.IDWProductCodes'. The duplicate key value is (MP115).</p>\n</blockquote>\n\n<p>What has been happening is each time I insert the first key and then try to insert the second key, SQL assumes they are the same and overwrites the first with the second, an effect I don't want at all. </p>\n\n<p>What I really want is the ability to enter different strings(no duplicates) in the table. I had thought a unique constraint was all it would take but now i am not sure. What is the better or best approach to solving this problem please? </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12905699,"title":"SQL Server - Query to return groups with multiple distinct records","body":"<p>My table:</p>\n\n<pre><code>Col1    Col2\n1       xyz\n1       abc\n2       abc\n3       yyy\n4       zzz\n4       zzz\n</code></pre>\n\n<p>I have a table with two columns. I want to query for records where col1 has more than one DISTINCT col2 values. In the example table given above, the query should return records for col1 with value \"1\".</p>\n\n<p>Expected query result: </p>\n\n<pre><code>Col1    Col2 \n1       xyz \n1       abc\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","pivot"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":614,"score":1,"question_id":8912813,"title":"SQL Server 2008 Pivot Query","body":"<p>I have data in a SQL Server 2008 table that looks like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/bh7TV.png\" alt=\"enter image description here\"></p>\n\n<p>I want to pivot it to look like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/85Tl2.png\" alt=\"enter image description here\"></p>\n\n<p>Basically I want to group on ReadTime and Coater and then pivot on the DataType column. Could someone help me with the T-SQL to do this?</p>\n"},{"tags":["sql","tsql","merge"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12903446,"title":"Using a join in a merge statement","body":"<p><strong>Problem</strong></p>\n\n<p>Table 1:</p>\n\n<pre><code>| KeyColumn | DataColumn1 | DataColumn2|  \n   01         0.1          0.2\n   02         0.13         0.41\n</code></pre>\n\n<p>Table 2:</p>\n\n<pre><code>| anotherKey | DataColumn1 | DataColumn2|      \n   A1          .15          1.2\n   A2          .25          23.1\n</code></pre>\n\n<p>Table 3:</p>\n\n<pre><code>|KeyColumn| anotherKey |       \n  01        A1\n  02        A1\n</code></pre>\n\n<p>Given a key (A1, or A2) I need to update the DataColumn1 and DataColumn2 columns in table 1 with the corresponding values in table 2.</p>\n\n<p>So table1 can have x number of rows updated, as shown in the above data. If I want to update A1, both 01 and 02 rows should be updated </p>\n\n<p>(so the values in table1 would be  0.15 for datacolumn1 and 1.2 for datacolumn2 on both keys 01 and 02)</p>\n\n<p><strong>What I have tried so far:</strong></p>\n\n<pre><code>MERGE table1\nUSING (SELECT *\n       FROM table2\n       LEFT OUTER JOIN table3\n           on table2.anotherKey = table3.anotherKey\n       WHERE table2.anotherKey = 'A1') tmpTable\nON \n   table1.keyColumn = tmpTable.keyColumn\nWHEN MATCHED THEN\n       UPDATE\n       SET table1.DataColumn1 = tmpTable.DataColumn1\n            ,table1.DataColumn2 = tmpTable.DataColumn2;\n</code></pre>\n\n<p><strong>Questions:</strong></p>\n\n<ol>\n<li>Is this allowed? To use the select in the using statement? I'm getting a syntax error on line 1</li>\n<li>Is there a better way to go about this? Am I making this more complicated than it has to be?</li>\n<li>What am I doing wrong?</li>\n</ol>\n\n<p>and the error: </p>\n\n<p>Msg 102, Level 15, State 1, Line 1\nIncorrect syntax near 'a'.\nMsg 102, Level 15, State 1, Line 12\nIncorrect syntax near 'd'.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":64,"score":2,"question_id":12902852,"title":"Does Count (*) skew desired results when performing additional join?","body":"<p>My query works fine; however, I need to join another dataset to my query, and I expect that the <code>count(f.*)</code> will break.</p>\n\n<p>Here's the query I start with:</p>\n\n<pre><code>SELECT\n       MIN(received_date) AS FirstVisit\n     , patient_id         AS PatientID\nINTO #LookupTable\nFROM F_ACCESSION_DAILY\n\nSELECT \n       f.doctor           AS Doctor\n     , COUNT(f.*)         AS CountNewPatients\n     , MONTH(firstvisit)  AS Month\n     , YEAR(firstvisit)   AS Year\nFROM F_ACCESSION_DAILY f \nINNER JOIN #LookupTable l ON f.received_date = l.FirstVisit \n                         AND f.patient_id = l.PatientID\nGROUP BY f.doctor\n       , MONTH(firstvisit)\n       , YEAR(firstvisit)\n\nDROP TABLE #LookupTable\n</code></pre>\n\n<p>I would like to Join the above query on another table. </p>\n\n<p>The question is <strong>*<em>will my <code>count(f.*)</code> stay the same or will it change because I've added a new dataset?</em>*</strong></p>\n\n<p>*<strong>*How do I make sure that the <code>count(f.*)</code> will remain the same?</strong></p>\n\n<p>Thank you so much for your guidance.</p>\n"},{"tags":["tsql","asp-classic","ado"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1460,"score":1,"question_id":4028395,"title":"What does the \"Cannot change the ActiveConnection property of a Recordset object which has a Command object as its source\" error mean?","body":"<p>I've gotten the \"Cannot change the ActiveConnection property of a Recordset object which has a Command object as its source\" error in my classic asp page a couple of times, usually after I've just changed a stored procedure.</p>\n\n<p>In the past, uninstalling and reinstalling the COM+ applications and a reset of IIS has seemed to fix this problem.  I'd assumed that the old ActiveConnection property was somehow being held in memory and the workaround was flushing it out.  Today, no such luck.</p>\n\n<p>So my first question is, \"What does this error actually mean?\"  The second question is, \"How do I fix it?\"</p>\n\n<p>I've tried consulting the following links, but as a COM+ novice this is currently over my head.</p>\n\n<p><a href=\"http://www.experts-exchange.com/Web_Development/Web_Languages-Standards/ASP/Q_20626178.html\" rel=\"nofollow\">http://www.experts-exchange.com/Web_Development/Web_Languages-Standards/ASP/Q_20626178.html</a></p>\n\n<p><a href=\"http://msdn.microsoft.com/en-us/library/ee275490(BTS.10).aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ee275490(BTS.10).aspx</a></p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":83,"score":0,"question_id":12900320,"title":"SQL When a simple Join Fails","body":"<p>I have a requirement to display product data, including product url information (page where the product can be found) in a document. On my development machine, I have a script that does this fairly successfully. The problem I am having is that when i move the same script fine on local, to a production machine, the code runs but only some products have their Url infomation displayed. The join is as simple as </p>\n\n<pre><code>Select \n    A.ID, A.Case, B.Val, B.Unit, B.Url\nfrom A  \nleft join B on A.onID = B.UID\n</code></pre>\n\n<p>Any suggestions please on what the possible issue could be?</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":12899827,"title":"Indenting records with space in a T-SQL stored procedure","body":"<p>I have a stored procedure that returns records based on a <code>Department ID</code>:  </p>\n\n<pre><code>Employee Name                ManagerID         SupervisorID                ID  \n    John Smith                  1                     1                      1  \n    Tom Jones                   1                     2                      2  \n    Robert Thompson             1                     2                      3\n    Jennifer Stevens            1                     4                      4  \n</code></pre>\n\n<p>I want to indent the records that are returned as follows:  </p>\n\n<ul>\n<li>If ManagerID = ID (no indentation)  </li>\n<li>If SupervisorID = ID (2 spaces indented)  </li>\n<li>Else (4 spaces indented)*</li>\n</ul>\n\n<p>Something like:</p>\n\n<pre><code>John Smith  \n   Tom Jones  \n       Robert Thompson  \n   Jennifer Stevens\n</code></pre>\n\n<p>How would I accomplish that?</p>\n"},{"tags":["sql","sql-server","tsql","select"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":84,"score":2,"question_id":12900439,"title":"Combine without Aggregate?","body":"<p>Long story short I'm reasonably new to T-SQL, and I'm working on querying some info out of JD Edwards for our scheduling department. We're a manufacturing plant, and the table that contains our Part info and the components that go into making each part uses a single column for all components with multiple rows for each so we can have a single part with twenty rows, I have two problems with this query that have me a little stumped, the first is that I'd like to see one row per work order, that contains all of the part info, from the WO table I use our Finished part number in the following query:</p>\n\n<p>Raw data from necessary columns for this WO &amp; Finished Product:</p>\n\n<pre><code>WALITM                      IXLITM                      WADOCO\nTF2-10426IA                 CF-S1094P-UL                800059\nTF2-10426IA                 CF-S1094P-UL                800059\nTF2-10426IA                 CF-S1094P-UL                800059\nTF2-10426IA                 CF-S1094P-UL                800059\nTF2-10426IA                 TE2-06718                   800059\nTF2-10426IA                 TE2-06718                   800059\nTF2-10426IA                 TE2-06718                   800059\nTF2-10426IA                 TE2-06718                   800059\nTF2-10426IA                 RP-TR23                     800059\nTF2-10426IA                 RP-TR23                     800059\nTF2-10426IA                 RP-TR23                     800059\nTF2-10426IA                 RP-TR23                     800059\nTF2-10426IA                 RP-BX35                     800059\nTF2-10426IA                 RP-BX35                     800059\nTF2-10426IA                 RP-BX35                     800059\nTF2-10426IA                 RP-BX35                     800059\n</code></pre>\n\n<p>(Sorry apparently a complete n00b today, aside from creating an HTML table, couldn't figure out how to get this to format into a table)</p>\n\n<pre><code>    SELECT WO, TF, TE, CAP, LABEL\n    FROM (SELECT DISTINCT Sched.dbo.TBS.WADOCO AS WO,\n    Sched.dbo.TBS.WALITM AS TF,\n    CASE WHEN Part.IXLITM LIKE 'TE%' THEN Part.IXLITM END AS TE,\n    CASE WHEN Part.IXLITM LIKE 'CF%' THEN Part.IXLITM END AS CAP,\n    CASE WHEN Part.IXLITM LIKE 'LBL%' THEN Part.IXLITM END AS LABEL\n    FROM WB.dbo.Part\n    INNER JOIN Sched.dbo.TBS ON TBS.WAAITM=Part.IXKITA) AS T2\n    WHERE WO=800059\n</code></pre>\n\n<p>Which Yields:</p>\n\n<pre><code>WO          TF            TE          CAP            LABEL\n800059      TF2-10426IA   NULL        NULL           NULL\n800059      TF2-10426IA   NULL        CF-S1094P-UL   NULL\n800059      TF2-10426IA   TE2-06718   NULL           NULL\n</code></pre>\n\n<p>I've made a couple of other attempts at getting everything combined in one line but haven't had any luck yet I think something similar to 'Group By' would be ideal...</p>\n\n<p>The second part of this query that also has me a little stumped, although admittedly I've worked on the above more, is that I need to pull even more data out of the IXLITM column <code>Where IXKITA=[The TE2***] for the TF2*** Number</code>.</p>\n\n<p>I think between the two issues I may look for a solution outside of T-SQL, but figured I'd ask for some insight from all you experts first.</p>\n\n<p>Thanks in advance and any help is greatly appreciated!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":4,"up_vote_count":4,"down_vote_count":0,"view_count":305,"score":4,"question_id":12890967,"title":"SHOW ALL Dates data between two dates; if no row exists for particular date then show zero in all columns","body":"<p>I want to show all dates between two dates when there is  any date data missing then its should show zero in val column . </p>\n\n<pre><code>declare @temp table (\nid int identity(1,1) not null,\nCDate smalldatetime ,\nval int\n)\n</code></pre>\n\n<p>INSERT STATEMENT FOR DATA TO CHECK </p>\n\n<pre><code>insert into @temp select '10/2/2012',1\ninsert into @temp select '10/3/2012',1\ninsert into @temp select '10/5/2012',1\ninsert into @temp select '10/7/2012',2\ninsert into @temp select '10/9/2012',2\ninsert into @temp select '10/10/2012',2\ninsert into @temp select '10/13/2012',2\ninsert into @temp select '10/15/2012',2\n</code></pre>\n\n<p>Retrieve records between first day of month and today </p>\n\n<pre><code>select * from @temp where CDate between '10/01/2012' AND '10/15/2012'\n</code></pre>\n\n<p>As i run this query its show me all data between these two dates but i want to also include missing dates with <code>val=0</code> </p>\n\n<p><a href=\"http://www.sqlfiddle.com/#!3/268dc/1\" rel=\"nofollow\">SQL FIDDLE WITH SAMPLE DATA </a></p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","sql-function"],"answer_count":11,"favorite_count":35,"up_vote_count":76,"down_vote_count":0,"view_count":67751,"score":76,"question_id":1179758,"title":"Function vs. Stored Procedure in SQL Server","body":"<p>I've been learning Functions and Stored Procedure for quite a while but I don't know why and when exactly I should use functions or stored procedure instead of one another. They look same to me maybe because I am kinda newbie about that.</p>\n\n<p>Can some one tell me why ?</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql-server-2008","tsql","tags"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12899619,"title":"GUID vs Identity for use with tags","body":"<p>I know this subject has been discussed at length (I have read lots of posts here and all over the web) and I don't like to flog a dead horse but I have a question about a more specific aspect of Integer ID vs GUID:</p>\n\n<p>I am writing out a schema which is going to have a tagging ability similar in use to the stackoverflow tags but it will have the same tags used against 5+ different tables.</p>\n\n<p>The basic tables I will be linking are as follows:</p>\n\n<p><strong>Tag Table</strong></p>\n\n<pre><code>Tag ID    Tag Name      Tag Description\n-------------------------------------------------------------\n     1    Hats          Tag for hats\n     2    Coats         Tag for coats\n     3    Gloves        Gloves tag\n     4    Ladies        Ladies item\n</code></pre>\n\n<p><strong>Items Table 1</strong></p>\n\n<pre><code>Item ID    Item Name    Cost\n------------------------------------------------------------\n      1    Deerstalker  20.00\n      2    Fedora       50.00\n      3    Scarf        15.00\n</code></pre>\n\n<p>The bit I'm having trouble with is the <code>tag_item</code> table.</p>\n\n<p>I will have 5 tables with completely different structures that I want the users to be able to apply tags to so I think I'll need to do one of the following:</p>\n\n<ul>\n<li>Store <code>table name</code>/<code>table number</code> as well as the integer key of the row the tag relates to</li>\n<li>Store a <code>GUID</code> of the row, this will work independent of the table and make it much easier to get all tags for a certain row.</li>\n</ul>\n\n<p>What I'm unsure of is how this will affect performance for:</p>\n\n<ul>\n<li>Searching for all items over 5 tables with a certain tag/tags</li>\n<li>editing the tags for an item</li>\n<li>joins</li>\n</ul>\n\n<p>Is there any clearly better option in this case or anywhere I could read up on the advantages in this particular scenario?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":62,"score":1,"question_id":12898412,"title":"SQL query -- need to be sure I have this logic right","body":"<p>I have code below and I would appreciate some help making sure this is correct. (slow day)</p>\n\n<pre><code>Select \n    A.Label, A.Name, C.UID, D.Unit \nFrom \n    A \ninner join \n    B on A.UID = B.FUID \nleft join \n   C on B.UID = C.UID\nleft join \n   D on C.unitID = D.ID\nWhere \n   C.LName = 'Gas'\n</code></pre>\n\n<p>The code above reads -- get all Labels, and corresponding Name, in <code>Table A</code> that are linked to a record in <code>Table B</code> which may or may not have a record linked to it in C, and which may or may not have record linked to it in D, and <code>C.LName = 'gas'</code>. </p>\n\n<p>Is this correct please? What I need is to pull data from A that exist in B regardless of whether record exists in C or D. </p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":11265868,"title":"How to Order By Column when Column isn't of the same type?","body":"<p>I have fields in the column that look like so:</p>\n\n<pre><code>2/8B, 3, 3/8B, 4/8B, 2, 6, 4/9, 9, 8/9, 8, 7, 1, 5/9, 10, 3/9, 2/9, 7/9, 6/8B, 6/9, 1/9, 5, 8B, 5/8B, 4\n</code></pre>\n\n<p>I need to sort this list in a manner like: </p>\n\n<pre><code>1, 1/9, 2, 2/8B, 2/9, 3, 3/8B, 3/9, 4, 4/8B, 4/9, 5, 5/8B, 5/9, 6, 6/8B, 6/9, 7, 7/9, 8, 8/9, 8B, 9, 10\n</code></pre>\n\n<p>How do I Order By to create this output?</p>\n\n<p>To clear up any confusion (1/2) is not a fraction. the \"/\" is just a separator. </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":57,"score":2,"question_id":12898285,"title":"Getting sp value from another sp","body":"<p>Although I have looked around a little bit but no luck yet </p>\n\n<p>I am using SQL Server. Here is the whole scenario.</p>\n\n<p>I have an old legacy sp (which I cannot change due to lot of dependencies and other issue) which doesn't return any value nor it accepts any output parameter, It just select a value as</p>\n\n<pre><code>Create sp myoldsp (@paramentes)\nas\n...\nselect scope_identity() as autoID\n...\n</code></pre>\n\n<p>Now I am writing another sp where i need this autoID values, i have tried</p>\n\n<pre><code>exec myoldsp @parameters\nselect scope_identity()\n</code></pre>\n\n<p>and also tried</p>\n\n<pre><code>Declare @autoid int\nexec @autoid=myoldsp @parametes\n</code></pre>\n\n<p>but unable to get that returned value. Thanks in advance for help</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":84,"score":0,"question_id":12855774,"title":"Calculated balance of purchased lots","body":"<p>I have a list of purchases by date.  EG:</p>\n\n<p>ItemCode, Purchase Date, Purchase Qty</p>\n\n<ul>\n<li>XXX, 01 Jan 2012, 10</li>\n<li>XXX, 10 Jan 2012, 5</li>\n</ul>\n\n<p>For the item I have a corresponding Sales transactions:</p>\n\n<p>Item, Sales Date, Sales Qty</p>\n\n<ul>\n<li>XXX, 02 Jan 2012, -5</li>\n<li>XXX, 09 Jan 2012, -3</li>\n<li>XXX, 11 JAN 2012, -3</li>\n</ul>\n\n<p>I am looking to get a SQL query (Without a cursor), to get the balance on each purchase order quantity.  I.e Run each purchase (First in first out) to 0. (For the purposes of aging inventory )</p>\n\n<p>How can you join the Purchases to the Sales to get this balance remaining each purchased Inventory Lot?  Is this possible without a cursor?</p>\n"},{"tags":["c#",".net","sql","sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":5,"view_count":83,"score":-4,"question_id":12896879,"title":"How to parse nested for into sql query?","body":"<p>i want to use 2 table to fill another table. my aim that: GetMinVal(tabl1.Val,tabl2.Val) and than match another. But my source is tabl2, TAKE tabl1'Val compare tabl2.Val an then i++ (tabl1) run...\n<img src=\"http://i.stack.imgur.com/G7dIl.png\" alt=\"enter image description here\"></p>\n\n<p>Matching: (it is C# code nested loop)</p>\n\n<pre><code>\nfor(int i=0;i&#60;billcount, i++)\n{\n    for(int j=0; j&#60;moneyCount; j++)\n    {\n        Match m  = new Match();\n        var val = Math.Min(bill.Value,money.Value);\n        m.Val=val;      \n\n    }\n\n}\n\n</code></pre>\n\n<p>How to implement sql query??? thanks...</p>\n"},{"tags":["asp.net","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":64,"score":-1,"question_id":12896800,"title":"Sorting by date in SQL Server","body":"<p>I want to sort a table by date in ascending order. The table also contains null values. </p>\n\n<p>I want to display data in Gridview. I want to display the data like first all rows which contains date field and then date as blank field.</p>\n\n<p>I used below query :</p>\n\n<pre><code>select * from TempTable order by convert(datetime, Date,101) asc\n</code></pre>\n\n<p>Please help me.</p>\n\n<p>Thanks in Advance.</p>\n"},{"tags":["sql","sql-server","tsql","dynamic-sql"],"answer_count":7,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":135,"score":0,"question_id":12884850,"title":"SQL How to effectively use dynamic sql query when output COLUMN order is important","body":"<p>My question is really how to ensure that the ORDER of the OUTPUT is maintained when using dynamic query to get data out. I have a couple of dynamic queries that I am utilizing and I notice that when I run the same query on different machines, I get output in different orders. Currently, I store the data outputted into a temp table which assume the order of the output to be the same as that on my local machine but on production, it is all switched up.  How do I get more control of this so that <strong>every time</strong> the query is run, the order of the output is maintained? </p>\n\n<p>When I go to use an Order BY in my dynamic query I get the error </p>\n\n<p><strong>Msg 1033, Level 15, State 1, Line 18\nThe ORDER BY clause is invalid in views, inline functions, derived tables, subqueries, and common table expressions, unless TOP, OFFSET or FOR XML is also specified.</strong></p>\n\n<pre><code> DECLARE @colsUnpivot AS NVARCHAR(MAX),\n    @query  AS NVARCHAR(MAX),\n    @colsPivot as  NVARCHAR(MAX)\n\n           IF EXISTS\n                (\n                            SELECT *\n                            FROM tempdb.dbo.sysobjects\n                            WHERE ID = OBJECT_ID(N'tempdb..#ibutes')\n                )\n                BEGIN\n                            DROP TABLE #ibutes\n                END\n    Create table #ibutes\n    (\n                ProductID uniqueIdentifier,\n            PAID uniqueidentifier, \n            Label nvarchar(50),\n            Val nvarchar(3072),\n            unit nvarchar(50) \n    )\n    ;With Number\nAs\n(\n Select 1 as rownum union all  Select 2 union all Select 3 union all Select 4 union all Select 5 union all Select 6 union all Select 7 union all Select 8 union all Select 9 union all Select 10 union all Select 11 union all Select 12 union all Select 13 union all Select 14 union all Select 15 union all Select 16 union all Select 17 union all Select 18 union all Select 19 union all Select 20 union all Select 21 \n),\nProductDetail \nas \n(\n   select P.ProdID, N.rownum from IDWProduct P cross join Number N\n)\nInsert into #ibutes\nSelect ProdID ,  PAVibuteID, COALESCE(PANAme,''), COALESCE(PAVValue,''), COALESCE(unitLabel,'') \n from ProductDetail P\nLeft join \n(select Pr.*, PAName, row_number() over (partition by PAVProductID order by PAVID) as Rn from IDWProductibuteValues Pr  \ninner join IDWibutes  on PAID = PAVibuteID Where PAIscustom = 0 AND PAIsManufacturerSpecific =0 AND PANAME NOT IN \n('Brand Name', 'Standard', 'Application', 'Sub Brand', 'Type', 'Special Features')) \nPr ON rownum = Pr.Rn And PAVProductID = ProdID  \nleft join IDWUnitofMeasures on Pr.PAVunit = unitID \n\n--Select * from #ibutes\n\n   select @colsUnpivot = stuff((select ','+quotename(C.name)\n         from tempdb.sys.columns as C  \n         where C.object_id = object_id('tempdb..#ibutes')  AND  C.name Not in ('ProductID')\n         for xml path('')), 1, 1, '')\n\n --select @colsUnpivot\n\n select @colsPivot = STUFF((SELECT  ','  + quotename(c.name   + cast(t.rn as varchar(10)))\n                    from\n                    (\n                      select row_number() over(partition by ProductID   order by ProductID) rn  from #ibutes\n                    ) t\n                     cross apply \n                      tempdb.sys.columns  as C\n                   where C.object_id = object_id('tempdb..#ibutes')   AND  C.name Not in ('ProductID')\n                   group by c.name, t.rn\n                   order by t.rn\n            FOR XML PATH(''), TYPE\n            ).value('.', 'NVARCHAR(MAX)') \n        ,1,1,'')\n\n  --select @colsPivot\n  set @query = 'select *\n      from\n      (\n        select ProductID,\n            col + cast(rn as varchar(10)) new_col,\n            val\n        from \n        (\n          select   \n           Cast (PAID as NVarchar(3072)) PAID\n           ,Cast (ProductID as NVarchar(3072)) ProductID\n           ,Cast (Label  as NVarchar(3072)) Label\n           ,Cast (Val as NVarchar(3072)) Val\n           ,Cast (unit as NVarchar(3072))  unit  \n            ,row_number() over(partition by ProductID order by ProductID) rn\n          from #ibutes\n\n     ) x\n        unpivot\n        (\n          val\n          for col in ('+ @colsunpivot +')\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ('+ @colspivot +')\n      ) p'\n\nexec(@query)    \n</code></pre>\n\n<p>The results of running the query </p>\n\n<p>ON MY LOCAL/DEV MACHINE</p>\n\n<p>========================</p>\n\n<pre><code>select *\n      from\n      (\n        select ProductID,\n            col + cast(rn as varchar(10)) new_col,\n            val\n        from \n        (\n          select   \n       Cast (PAID as NVarchar(3072)) PAID\n       ,Cast (ProductID as NVarchar(3072)) ProductID\n           ,Cast (Label  as NVarchar(3072)) Label\n           ,Cast (Val as NVarchar(3072)) Val\n           ,Cast (unit as NVarchar(3072))  unit  \n            ,row_number() over(partition by ProductID order by ProductID) rn\n          from #ibutes\n     ) x\n        unpivot\n        (\n          val\n          for col in ([Label],[unit],[Val],[PAID])\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ([Label1],[unit1],[Val1],[PAID1],[Label2],[unit2],[Val2],[PAID2],[Label3],[unit3],[Val3],[PAID3],[Label4],[unit4],[Val4],[PAID4],[Label5],[unit5],[Val5],[PAID5],[Label6],[unit6],[Val6],[PAID6],[Label7],[unit7],[Val7],[PAID7],[Label8],[unit8],[Val8],[PAID8],[Label9],[unit9],[Val9],[PAID9],[Label10],[unit10],[Val10],[PAID10],[Label11],[unit11],[Val11],[PAID11],[Label12],[unit12],[Val12],[PAID12],[Label13],[unit13],[Val13],[PAID13],[Label14],[unit14],[Val14],[PAID14],[Label15],[unit15],[Val15],[PAID15],[Label16],[unit16],[Val16],[PAID16],[Label17],[unit17],[Val17],[PAID17],[Label18],[unit18],[Val18],[PAID18],[Label19],[unit19],[Val19],[PAID19],[Label20],[unit20],[Val20],[PAID20],[Label21],[unit21],[Val21],[PAID21])\n      ) p \n</code></pre>\n\n<h2>ON PRODUCTION MACHINE HOWEVER IT IS DIFFERENT. PLEASE NOTICE THE CHANGE IN ORDER OF THE</h2>\n\n<p>COLUMNS</p>\n\n<pre><code>select *\n      from\n      (\n        select ProductID,\n            col + cast(rn as varchar(10)) new_col,\n            val\n        from \n        (\n          select   \n       Cast (PAID as NVarchar(3072)) PAID\n       ,Cast (ProductID as NVarchar(3072)) ProductID\n           ,Cast (Label  as NVarchar(3072)) Label\n           ,Cast (Val as NVarchar(3072)) Val\n           ,Cast (Unit as NVarchar(3072))  Unit  \n            ,row_number() over(partition by ProductID order by ProductID) rn\n          from #ibutes\n     ) x\n        unpivot\n        (\n          val\n          for col in ([PAID],[Label],[Val],[Unit])\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ([PAID1],[Label1],[Val1],[Unit1],[PAID2],[Label2],[Val2],[Unit2],[PAID3],[Label3],[Val3],[Unit3],[PAID4],[Label4],[Val4],[Unit4],[PAID5],[Label5],[Val5],[Unit5],[PAID6],[Label6],[Val6],[Unit6],[PAID7],[Label7],[Val7],[Unit7],[PAID8],[Label8],[Val8],[Unit8],[PAID9],[Label9],[Val9],[Unit9],[PAID10],[Label10],[Val10],[Unit10],[PAID11],[Label11],[Val11],[Unit11],[PAID12],[Label12],[Val12],[Unit12],[PAID13],[Label13],[Val13],[Unit13],[PAID14],[Label14],[Val14],[Unit14],[PAID15],[Label15],[Val15],[Unit15],[PAID16],[Label16],[Val16],[Unit16],[PAID17],[Label17],[Val17],[Unit17],[PAID18],[Label18],[Val18],[Unit18],[PAID19],[Label19],[Val19],[Unit19],[PAID20],[Label20],[Val20],[Unit20],[PAID21],[Label21],[Val21],[Unit21])\n      ) p\n</code></pre>\n\n<p>Please note the difference btw local machine where the order seems alphabetical </p>\n\n<p><strong>[Label1],[unit1],[Val1],[PAID1],[Label2],[unit2].</strong>\n . . . </p>\n\n<p>while on Production machine, it is not</p>\n\n<p><strong>[PAID1],[Label1],[Val1],[Unit1],[PAID2],[Label2],[Val2],[Unit2], .. .  .  .</strong></p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":7,"up_vote_count":27,"down_vote_count":0,"view_count":69148,"score":27,"question_id":48772,"title":"How do I create a foreign key in SQL Server?","body":"<p>I have never \"hand-coded\" object creation code for SQL Server and foreign key decleration is seemingly different between SQL Server and Postgres. Here is my sql so far:</p>\n\n<pre><code>drop table exams;\ndrop table question_bank;\ndrop table anwser_bank;\n\ncreate table exams\n(\n    exam_id uniqueidentifier primary key,\n    exam_name varchar(50),\n);\ncreate table question_bank\n(\n    question_id uniqueidentifier primary key,\n    question_exam_id uniqueidentifier not null,\n    question_text varchar(1024) not null,\n    question_point_value decimal,\n    constraint question_exam_id foreign key references exams(exam_id)\n);\ncreate table anwser_bank\n(\n    anwser_id           uniqueidentifier primary key,\n    anwser_question_id  uniqueidentifier,\n    anwser_text         varchar(1024),\n    anwser_is_correct   bit\n);\n</code></pre>\n\n<p>When I run the query I get this error:</p>\n\n<blockquote>\n  <p>Msg 8139, Level 16, State 0, Line 9\n  Number of referencing columns in\n  foreign key differs from number of\n  referenced columns, table\n  'question_bank'.</p>\n</blockquote>\n\n<p>Can you spot the error?</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":96,"score":3,"question_id":12887988,"title":"Select data by date and sum data - SQL Server 2005","body":"<p>I'm coming from MySQL and trying to code T-SQL on SQL Server 2005, and I'm finding it completely different.</p>\n\n<p>Here's what I want to do (using MySQL)</p>\n\n<pre><code>select sum(datapoint) as sum, date(mytimestamp) as date\nfrom datalog\nwhere datapoint = '27'\ngroup by date\n</code></pre>\n\n<p>i.e. get a list of data summed and grouped by date.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12888721,"title":"I don't understand this SQL Server MIN() resultset","body":"<p>I have this <code>SQL Server</code> query which I wrote to <em>find the Movie title that has the least amount of records in the <code>RENTAL</code> table</em>. </p>\n\n<p>When run, it returns a resultset that is identical to the resultset I get from executing the sub-query by itself.</p>\n\n<p>In other words, rather returning the single movie with the minimum RentalCount, it returns all movie titles and their corresponding RentalCount.</p>\n\n<pre><code>SELECT B.Title, MIN(B.RentalCount) AS RentalCount\nFROM (\n    SELECT Movie.Title, Count(*) AS RentalCount\n    FROM Rental\n    JOIN Dvd ON Rental.RentalID=Dvd.DvdID\n    JOIN Movie ON Dvd.Movieid=movie.MovieID\n    GROUP BY Movie.Title\n    ) B\nGROUP BY B.Title\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":3,"favorite_count":1,"up_vote_count":10,"down_vote_count":0,"view_count":2712,"score":10,"question_id":6054144,"title":"How can I group by date time column without taking time into consideration","body":"<p>I have a bunch of product orders and I'm trying to group by the date and sum the quantity for that date. How can I group by the month/day/year without taking the time part into consideration?</p>\n\n<p><code>3/8/2010 7:42:00</code> should be grouped with <code>3/8/2010 4:15:00</code></p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":77,"score":-3,"question_id":12887181,"title":"CTE variables, Exec procedure and order by EmployeeLevel","body":"<pre><code>ALTER PROCEDURE [dbo].[p_ReturnEmployeeOrg]\n( @BusinessEntityID int = 21 ) **-- NOT WORKING**\nAS\nSELECT * FROM HumanResources.Employee\n;WITH cte_Emp (EmployeeID,ManagerID,Title,EmployeeName,ManagerName,EmployeeLevel)\nAS\n-- Anchor member definition\n(SELECT e.BusinessEntityID,e.MaritalStatus,e.JobTitle,\n        CAST(c.LastName + ',' + c.FirstName AS VARCHAR(200)),\n        CAST ('N/A' AS VARCHAR(200)),\n        CAST (0 AS INT)\n    FROM HumanResources.Employee e \n    INNER JOIN Person.Person c\n        ON e.BusinessEntityID = c.BusinessEntityID\n        WHERE e.BusinessEntityID = @BusinessEntityID\n\n UNION ALL\n-- Recursive member definition \nSELECT  e.BusinessEntityID,e.MaritalStatus,e.JobTitle, \n                CAST(c.LastName + ',' + c.FirstName AS VARCHAR(200)),\n                CAST ('N/A' AS VARCHAR(200)),\n                CAST (0 AS INT)\n        FROM HumanResources.Employee e\n        INNER JOIN Person.Person c\n        ON e.BusinessEntityID = c.BusinessEntityID)\n        ORDER BY EmployeeLevel - **NOT WORKING**\n\n       EXEC p_ReturnEmployeeOrg 21) \n</code></pre>\n\n<p>-- exec is <strong>NOT WORKING, the results are raw data instead of BusinessEntityID = 21</strong> </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":76,"score":0,"question_id":12886216,"title":"An expression of non-boolean type specified in a context where a condition is expected, near ')'","body":"<p>I have a script in trigger to insert the audit table if any update happens on T_Referral table and i am using a Decrypt function to Decrypt the data in one of the column. My code in trigger is :</p>\n\n<pre><code>DECLARE @Sql_Insert nvarchar(max)\nSET @Sql_Insert = ''\nSET @Sql_Insert='INSERT INTO [Logg].AuditLogData(TableName, ColumnName, OldValue, OldValue_Decode, NewValue, NewValue_Decode, AuditSubCategoryID,[GuID])\nselect TableName, ColumnName, OldValue_Decode, case when ColumnName = ''BookingUserReferenceValue'' then utl.sfDecrypt(NewValue,0) Else NewValue end, NewValue_Decode, AuditSubCategoryID,[GuID] from #AuditLogData\nwhere ISNULL(OldValue,'') != ISNULL([NewValue],'')'\n\nexec utl.uspOpenOrCloseEncryptionKey 'open'\nexec(@Sql_Insert )\nexec utl.uspOpenOrCloseEncryptionKey 'close'\n</code></pre>\n\n<hr>\n\n<p>My update script is </p>\n\n<pre><code>Update RTS.T_Referral   \nset BookingUserReferenceValue =  cast ('John Wayne' as varbinary(256))\nwhere ReferralId = 20\n</code></pre>\n\n<p>I am Updating the record to <code>John Wayne</code> as varbinary in <code>T_Referral</code> table(record looks like <code>0x4A6F686E205761796E65</code>) and when update trigger is called it would load that record as John Wayne in Audit table. When the record is inserted in BookingUserReferenceValue it will be encrypted. The datatype of column BookingUserReferenceValue is Varbinary(256). when i try to update the record in that column i get error :</p>\n\n<blockquote>\n  <p>An expression of non-boolean type specified in a context where a\n  condition is expected, near ')'.</p>\n</blockquote>\n\n<p>Any Idea whats wrong?\nThanks</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":4,"favorite_count":5,"up_vote_count":9,"down_vote_count":0,"view_count":6870,"score":9,"question_id":1427469,"title":"Compare dates in T-SQL, ignoring the time part","body":"<p>I'm using MS SQL 2005, and I want to check two dates for equality, but ignoring the time part.</p>\n\n<p>I know I can make use of <a href=\"http://msdn.microsoft.com/en-us/library/ms189794.aspx\">DATEDIFF</a>, but am concerned that it may be slow - this SP gets used in the DB a lot!</p>\n\n<p>Any suggestions?</p>\n\n<p><b>Edit:</b> David Andres' comment: <blockquote>'\"comparison\" includes much more than equality' </blockquote> made me realise that I didn't make my question clear enough - I am actually just checking for equality, that is all.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":98,"score":1,"question_id":12874451,"title":"SQL Server turn off ANSI_WARNING ON A stored procedure","body":"<p>I need to know how to turn off ANSI warnings on my stored procedure please. I keep getting the error </p>\n\n<blockquote>\n  <p><em>String or binary data would be truncated.</em></p>\n</blockquote>\n\n<p>However, I would rather this be turned off so as I expect this and would rather allow it. </p>\n\n<p>I added the statement </p>\n\n<pre><code>SET ANSI_WARNINGS OFF \nGO\n</code></pre>\n\n<p>right before the stored procedure however, doing this does not seem to suppress the error at all. </p>\n\n<p>For the reason why I have this truncate error to begin with, well one of my stored procs executes dynamic Sql to retrieve values(<a href=\"http://sqlfiddle.com/#!3/10876/1\" rel=\"nofollow\">SQLFIddle showing the code</a> ). And I had to set the length on all of my fields to the length of the max (NVarchar(3072)). When my query is executed however, I need them back to the right size when printing them to the client. </p>\n\n<p>Would appreciate info on how to best deal with this please. Thanks in advance. </p>\n"},{"tags":["tsql","random"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":35,"score":1,"question_id":12885412,"title":"TSql random sets of values across loops","body":"<p>I know how to get random numbers in rows inserted into a table with a single select. But how can I do that such that the result of each select in an iteration of a while loop is different from each other?</p>\n\n<p>The code I'm using looks like this. The values I get in each row in a set are different, but the sets of values are the same for every iteration.</p>\n\n<pre><code>WHILE some condition is true\n  BEGIN    \n    DECLARE @GamesRandomlySorted TABLE\n    (\n      RandomSortId INT,\n      GameId INT\n    )\n\n    INSERT INTO @GamesRandomlySorted (RandomSortId, GameId)\n    SELECT Checksum(NewId()), GameId\n    FROM Games\n\n    SELECT * \n    FROM @GamesRandomlySorted\n    ORDER BY RandomSortId\n  END\n</code></pre>\n"},{"tags":["sql","sql-server","query","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":84,"score":2,"question_id":12863074,"title":"t-sql query with deep joining","body":"<p>I'm having a little trouble of getting a fast sql-query on this. I've managed to get a query to return the result I want but it takes about 2 sek to run even with the right indexes.</p>\n\n<p>I have these tables:</p>\n\n<pre><code>[Login]\nloginID\nloginTime\nuserID\n\n[user]\nuserID \nuserName\n\n[companyParticipant]\nuserID\ncompanyID\n\n[company]\ncompanyID\norganisationID\nCompanyName\n</code></pre>\n\n<p>What I want to show is all the top 10 latest logins persons with loginTime. Where the user is in a company that I am a participant or a company within the organisations where I am member of a company of that organisation</p>\n\n<p>To get my organisations:</p>\n\n<pre><code>SELECT organisationID \nFROM companys \nWHERE companyID IN (\n    SELECT companyID \n    FROM companyParticipant \n    WHERE userID = @userID) \nGROUP BY organisationID \n</code></pre>\n\n<p>So what i want i a query like this:</p>\n\n<pre><code>SELECT TOP 10 userName, LoginTime \nFROM ....\nORDER BY loginID\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","ado.net","concurrency"],"answer_count":10,"favorite_count":32,"up_vote_count":75,"down_vote_count":0,"view_count":13071,"score":75,"question_id":1483732,"title":"SET NOCOUNT ON usage","body":"<p>Inspired by <a href=\"http://stackoverflow.com/questions/1483383/is-this-stored-procedure-thread-safe-or-whatever-the-equiv-is-on-sql-server\">this question</a> where there are differing views on SET NOCOUNT...</p>\n\n<blockquote>\n  <p>Should we use SET NOCOUNT ON for SQL Server? If not, why not?</p>\n</blockquote>\n\n<p><strong>What it does</strong> Edit 6, on 22 Jul 2011</p>\n\n<p>It suppresses the \"xx rows affected\" message after any DML. This is a resultset and when sent, the client must process it. It's tiny, but measurable (see answers below)</p>\n\n<p>For triggers etc, the client will receive multiple \"xx rows affected\" and this causes all manner of errors for some ORMs, MS Access, JPA etc (see edits below)</p>\n\n<p><strong>Background:</strong></p>\n\n<p>General accepted best practice (I thought until this question) is to use <code>SET NOCOUNT ON</code> in triggers and stored procedures in SQL Server. We use it everywhere and a quick google shows plenty of SQL Server MVPs agreeing too.</p>\n\n<p>MSDN says this can break a <a href=\"http://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx\" rel=\"nofollow\">.net SQLDataAdapter</a>.</p>\n\n<p>Now, this means to me that the SQLDataAdapter is limited to utterly simply CRUD processing because it expects the \"n rows affected\" message to match. So, I can't use:</p>\n\n<ul>\n<li>IF EXISTS to avoid duplicates (no rows affected message) <em>Note: use with caution</em></li>\n<li>WHERE NOT EXISTS (less rows then expected</li>\n<li>Filter out trivial updates (eg no data actually changes)</li>\n<li>Do any table access before (such as logging)</li>\n<li>Hide complexity or denormlisation</li>\n<li>etc</li>\n</ul>\n\n<p>In the question marc_s (who knows his SQL stuff) says do not use it. This differs to what I think (and I regard myself as somewhat competent at SQL too).</p>\n\n<p>It's possible I'm missing something (feel free to point out the obvious), but what do you folks out there think?</p>\n\n<p>Note: it's been years since I saw this error because I don't use SQLDataAdapter nowadays.</p>\n\n<p><strong>Edits after comments and questions:</strong></p>\n\n<p>Edit: More thoughts...</p>\n\n<p>We have multiple clients: one may use a C# SQLDataAdaptor, another may use nHibernate from Java. These can be affected in different ways with <code>SET NOCOUNT ON</code>.</p>\n\n<p>If you regard stored procs as methods, then it's bad form (anti-pattern) to assume some internal processing works a certain way for your own purposes.</p>\n\n<p>Edit 2: a <a href=\"http://stackoverflow.com/questions/1354362\">trigger breaking nHibernate question</a>, where <code>SET NOCOUNT ON</code> can not be set</p>\n\n<p>(and no, it's not a duplicate of <a href=\"http://stackoverflow.com/questions/995589/set-nocount-off-or-return-rowcount\">this</a>)</p>\n\n<p>Edit 3: Yet more info, thanks to my MVP colleague</p>\n\n<ul>\n<li><a href=\"http://support.microsoft.com/?scid=kb%3Ben-us%3B240882&amp;x=4&amp;y=9\" rel=\"nofollow\">KB 240882</a>, issue causing disconnects on SQL 2000 and earlier</li>\n<li><a href=\"http://www.sqlmag.com/Articles/Index.cfm?ArticleID=22093&amp;DisplayTab=Article\" rel=\"nofollow\">Demo of performance gain</a> </li>\n</ul>\n\n<p>Edit 4: 13 May 2011</p>\n\n<p><a href=\"http://stackoverflow.com/q/5880413/27535\">Breaks Linq 2 SQL too when not specified?</a></p>\n\n<p>Edit 5: 14 Jun 2011</p>\n\n<p>Breaks JPA, stored proc with table variables: <a href=\"http://stackoverflow.com/q/6344631/27535\">Does JPA 2.0 support SQL Server table variables?</a></p>\n\n<p>Edit 6: 15 Aug 2011</p>\n\n<p>The SSMS \"Edit rows\" data grid requires SET NOCOUNT ON: <a href=\"http://stackoverflow.com/q/7067329/27535\">Update trigger with GROUP BY</a></p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":64,"score":2,"question_id":12879253,"title":"How to make multiple occurences of the same item have a different value from the first occurence?","body":"<p>I have a database that looks like this:</p>\n\n<pre><code>label_id, scan_type, scan_cost\n</code></pre>\n\n<p>And some rows that look like this:</p>\n\n<pre><code>001, A40, 70\n001, A40, 70\n002, A40, 85\n003, A40, 85\n003, A40, 85\n</code></pre>\n\n<p>I need to produce a result set that looks like this:</p>\n\n<pre><code>001, A40, 70\n001, A40, 0\n002, A40, 85\n003, A40, 85\n003, A40, 0\n</code></pre>\n\n<p>That is, any multiple occurrence of the same <code>label_id</code> then the <code>scan_cost</code> column needs to be set to 0, but the first occurrence of each <code>label_id</code> the value needs to remain untouched.</p>\n\n<p>The <code>label_id</code> are not sequential if that changes anything.</p>\n\n<p>Is it possible to achieve this behaviour in SQL? Note the SQL dialect is T-SQL, Microsoft SQL Server 2008</p>\n"},{"tags":["sql","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":60,"score":-2,"question_id":12880922,"title":"Use where condition with unjoined table","body":"<p>I have the following problem: I am trying to retreive a sum value based on one condition. Problem is that I can't join the conditional value since my tables aren't joined. Here is my syntax:</p>\n\n<pre><code>SELECT SUM(value)\nFROM value v\n  join day d on v.day_id = d.day_id\n  join budget b on d.budget_id = b.budget_id\n  join unit u on v.unit_id = u.unit_id\n  where #output.class = (SELECT distinct s.class FROM sale s where s.id = #output.sale_id)\n  AND u.unit_name in ('electronics')\n</code></pre>\n\n<p>With this sybtax I get no error but neither values.</p>\n\n<p>Can you please tell me where I do wrong?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":66,"score":-2,"question_id":12877237,"title":"SQL Query some assistance needed in fixing query so it returns a row per Unique ID","body":"<p>I am in need of help fixing a query so it returns the right number of rows. I have the table below with 12 rows per ProductID in it. What I would like is to turn these 12 rows to 1 row with 12 set columns for each Product ID. </p>\n\n<p>the generated dynamic code only creates 1 row </p>\n\n<pre><code>--Table this belongs to \n\n   Create table #Attributes\n    (\n            ProductID uniqueIdentifier,\n            PAID Varchar(48), \n            Label nvarchar(50),\n            AttrValue nvarchar(3072),\n            unit nvarchar(50) \n    )\n . . . . . . .\n\nselect *\n      from\n      (\n        select col + cast(rn as varchar(10)) new_col, val\n        from \n        (\n          select \n          Cast(PAID as NVarchar(3072)) PAID\n          ,Cast (ProductID as NVarchar(3072)) ProductID\n           ,Cast (Label  as NVarchar(3072)) Label\n           ,Cast (Value as NVarchar(3072)) Value\n           ,Cast (unit as NVarchar(3072))  unit  \n            ,row_number() over(partition by ProductID order by ProductID) rn\n          from #Attributes\n        ) x\n        unpivot\n        (\n          val\n          for col in ([ProductID],[PAID],[Label],[Value],[unit])\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ([ProductID1],[PAID1],[Label1],[Value1],[unit1],[ProductID2],[PAID2],[Label2],[Value2],[unit2],[ProductID3],[PAID3],[Label3],[Value3],[unit3],[ProductID4],[PAID4],[Label4],[Value4],[unit4],[ProductID5],[PAID5],[Label5],[Value5],[unit5],[ProductID6],[PAID6],[Label6],[Value6],[unit6],[ProductID7],[PAID7],[Label7],[Value7],[unit7],[ProductID8],[PAID8],[Label8],[Value8],[unit8],[ProductID9],[PAID9],[Label9],[Value9],[unit9],[ProductID10],[PAID10],[Label10],[Value10],[unit10],[ProductID11],[PAID11],[Label11],[Value11],[unit11],[ProductID12],[PAID12],[Label12],[Value12],[unit12],[ProductID13],[PAID13],[Label13],[Value13],[unit13],[ProductID14],[PAID14],[Label14],[Value14],[unit14],[ProductID15],[PAID15],[Label15],[Value15],[unit15],[ProductID16],[PAID16],[Label16],[Value16],[unit16],[ProductID17],[PAID17],[Label17],[Value17],[unit17],[ProductID18],[PAID18],[Label18],[Value18],[unit18],[ProductID19],[PAID19],[Label19],[Value19],[unit19],[ProductID20],[PAID20],[Label20],[Value20],[unit20],[ProductID21],[PAID21],[Label21],[Value21],[unit21])\n      ) p\n</code></pre>\n\n<p>The current code, only generates 1 row of data and ignores other ProductID's in my table. I would appreciate some help to fix this issue. Thanks. </p>\n\n<p>BELOW here is a table(think Excel without the column dividing lines. The Product ID field has values but there are no values in the PAID, LABEL, VALUE and UNIT columns. That is why they appear blank in the table. </p>\n\n<pre><code>PRODUCTID                                  PAID       LABEL         VALUE        UNIT\n--------------------------------------------------------------------------------------\nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nF4D58DCE-8EED-40E3-BF4C-07349BEC0A3E                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \nACF57CF7-7206-46F5-A341-16E1B9828DBC                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \n95CF8634-DF1C-4E12-9584-56D726F9D3FD                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nC4196FB0-AAE1-4BC4-A6E3-630B90D249C1                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \nA5A24B87-E4E7-4282-8BB1-7413198A7D1A                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n7EECE72B-26C5-4306-9706-85E344243122                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n60B1AB86-E0EB-41AE-858C-AAD4744FD49C                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n44CDDEC6-4889-491B-A896-B719C5B9F3E4                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \n3866BBA2-624A-43B7-A04D-DE8ADF5DF739                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \nAA0A3639-2A36-4731-BF3F-F278D54A99C8                          \n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":118,"score":2,"question_id":12875485,"title":"SQL Server 2012 OUT OF MEMORY error messages","body":"<p>I am trying to trying to run some insert code(about 40,000 of them) using SSMS but I keep running up against SQL out of memory errors among others. I would appreciate any help to fix this problem please. </p>\n\n<p><img src=\"http://i.stack.imgur.com/DnWKY.png\" alt=\"**Error message that shows up when I try to run my query**\"></p>\n\n<p><img src=\"http://i.stack.imgur.com/ubi9p.png\" alt=\"**Another SQL Error message that showed up as well**\">\n<img src=\"http://i.stack.imgur.com/EjIHD.png\" alt=\"Database Property\"></p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":60,"score":-2,"question_id":12876626,"title":"Simple compare of datetime in SQL Server 2008","body":"<p>I have a <code>datetime</code> column storing the time of change including date and time parts.</p>\n\n<p>I am trying to return all of the changed rows using my stored procedure, which has one <code>datetime</code> parameter being passing it into </p>\n\n<pre><code>SELECT * FROM TABLE WHERE Changed &gt; @param\n</code></pre>\n\n<p>Surprisingly it returns <strong>no rows</strong>.</p>\n\n<p>I tried to use <code>BETWEEN</code>, time ranges, <code>DATEPART</code>, <code>DATEDIFF</code> but without success. Playing with this issue I found that if I do not compare seconds everything works.</p>\n\n<p>Any ideas, please?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":12875396,"title":"How to use use derived table column in sql query?","body":"<p>I have one table mytrade like following</p>\n\n<pre><code>tradeid securityid quantity\n\n111    899    12000\n112    899    1000\n113    788    15000\n114    566    -15000\n115    566    -1000\n</code></pre>\n\n<p>so to gather total quantity for security id i write following query (I tried this into #temptable also create temptable and then select below )</p>\n\n<pre><code>select\ntradeid,\nsecurityid,\nsum(quantity) OVER(Partition by securityid) as total\nfrom mytrade\n</code></pre>\n\n<p>which gives me output like below</p>\n\n<pre><code>tradeid securityid total\n\n114    566    -16000\n115    566    -16000\n113    788    15000\n111    899    13000\n112    899    13000\n</code></pre>\n\n<p>now i want to insert values into secondtable based on \"total\" quantity.</p>\n\n<pre><code>insert secondTable (securityid,quantity,price)\n(\nselect securityid,quantity,101.1 from mydata..mytrade\nwhere #temptable.total = 13000 and securityid = 899\n)\n</code></pre>\n\n<p>but getting error:</p>\n\n<p>The multi-part identifier \"#temptable.total\" could not be bound.</p>\n\n<p>if i put this whole statement into#temptable and then assign as above then also getting this error how should i bound \"total\" column please guide me?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":792,"score":2,"question_id":888493,"title":"How to use the identity as a column value during an insert","body":"<p>I have a stored proc containing an SQL statement which is something like:</p>\n\n<pre><code>CREATE PROCEDURE SaveUser\n@UserName nvarchar(10),\n@FirstName nvarchar(150),\n@LastName nvarchar(150)\n\nAS\nBEGIN\n\n    INSERT INTO Users (UserName, FirstName, LastName)\n    VALUES (@UserName, @FirstName, @LastName)\n\n    SELECT SCOPE_IDENTITY()\n\nEND\n</code></pre>\n\n<p>Some users cannot log into the system and do not have a username; however, the UserName field has a unique index on it so I would like to be able to insert the users ID #, which is an auto increment field, as the UserName.</p>\n\n<p>Does anyone know of an MS SQL Server method or variable which would allow me to do something like?</p>\n\n<pre><code>INSERT INTO Users (UserName, FirstName, LastName)\nVALUES (ISNULL(@UserName, SCOPE_IDENTITY()),@FirstName,@LastName)\n</code></pre>\n\n<p><b>Edit</b> My intention right now is to use something like the following</p>\n\n<pre><code>DECLARE @NextID int\nSET @NextID = IDENT_CURRENT(Users) + IDENT_INCR(Users)\n\n\nINSERT INTO Users (UserName, FirstName, LastName)\nVALUES (ISNULL(@UserName, @NextID), @FirstName, @LastName)\n</code></pre>\n\n<p>I would just like to know if there is a built in method which could guarantee that this would be consistent. </p>\n"}]}
{"total":16599,"page":8,"pagesize":100,"questions":[{"tags":["tsql","ssrs-2008","bids"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12751778,"title":"SSRS 2008: Why does a declared query variable show in the \"Define Query Parameters\" window?","body":"<p>I'm having trouble creating a dataset in Reporting Services 2008. Here's the query I want to use (generic-ized for public consumption):</p>\n\n<pre><code>Declare @PersonID as int\nset @PersonID = (select top 1 personID from People where name = @PersonName)\n\nselect (some columns)\nfrom [otherTable]\nwhere personID = @PersonID\n</code></pre>\n\n<p>I only have one input parameter: <code>@PersonName</code>. However, Studio 2008 seems to think <code>@PersonID</code> <em>also</em> needs a value in the \"Define Query Parameters\" window. So when I try to only enter a value for <code>@PersonName</code>, it gives me the \"This variable has already been defined\". </p>\n\n<p>I'm passing <code>@PersonName</code> because I need to display a human-readable list of the people to select from a dropdown as the only user-facing parameter to the report. I realize I could do a subquery and forget the variable in the above example, but my real query is much larger/uglier, and I can't exactly add indices to the data tables, so I'd like to limit the table scans.</p>\n"},{"tags":["sql","tsql","ssrs-2008","sql-server-2008-r2","ssrs-reports"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":297,"score":1,"question_id":10399386,"title":"Complex Iterating Query in SSRS 2008","body":"<p>After originally composing several reports by hand as part of an MVC 3 (EF4) project for a customer, I have decided it is far easier to compose reports in Microsoft reporting services (SSRS 2008 on SQL server 2008). For most of my reports this has proven to be a breeze, not even having to write SQL procs for most of my reports (semantic query in BIDS based on model).</p>\n\n<p>However one report remains daunting due to the nature of its input parameters and originally being computed in a function returning a list, not a LINQ query. The goal is to return all people in the people table who are less than x percent busy on any day in the range between date a and date b (variables input by report requester). This busy level information only exists in the Job table which has information on which person it is assigned to, the start and end dates of the job, and its task level. As a result, my original C# function does pretty much the following (psuedo-code):</p>\n\n<pre><code>given startDateRange a, stopDateRange b, busyLevel x\n{\nfor each person in people:\n   List returnPeople = new List()\n   create array consisting of days from a to b\n   for each job in jobs:\n      for each intersecting date of DateRange and job dateRange:\n         add task level of job to array\n   for each day in array:\n      if array[day] &lt; x\n         returnPeople.Add(person)\n         break;\nreturn returnPeople\n}\n</code></pre>\n\n<p>Table structure for relevant pieces:</p>\n\n<pre><code>People Table:\n-PersonID (PK)\n-other stuff...\n\nJobs Table:\n-JobID (PK)\n-StartDate\n-StopDate\n-Allocation\n-AssignedPersonID (FK to People Table)\n</code></pre>\n\n<p>As you can see, a job is on someones schedule if that job's AssignedPersonID is = that someone</p>\n\n<p>So... since I'm now working in SSRS 2008, I am looking for guidance on how to get these same results in SSRS from the same input parameters. Some trick to semantic queries that I am currently unaware of? SQL stored proc with temp table or table variable? Some sort of data processing extension? Any information on what the best approach to this type of problem is would be much appreciated.</p>\n\n<p>Let me know if additional information/code is required.</p>\n\n<p>EDIT: Currently working on a solution using cursors and temp tables that pretty much copies the structure of my original function. This is DEFINITELY not ideal however due to the complexity and inefficient nature of cursors, so advice/alternatives would be helpful.</p>\n\n<p>EDIT: Found a solution, definitely not the most efficient. Will change accepted answer if someone has a significantly faster method.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":59,"score":3,"question_id":12875480,"title":"How can I pass @VAR + magic numbers to a stored procedure parameter in a sql script?","body":"<p>Lets say I have a stored proc call <code>MyStoredProc</code> which recieved an int <code>(@MyParam INT)</code> datatype.</p>\n\n<p>Let's say I have an int declared in a script like this...</p>\n\n<pre><code>DECLARE @MyVar INT ;\nSET @MyVar = 101 ;\n</code></pre>\n\n<p>I just wrote a long sql script where I do a LOT of this...</p>\n\n<pre><code>EXEC MyStoredProc @MyVar + 1  ;\n</code></pre>\n\n<p>I am shocked that this is causing a syntax error warning.</p>\n\n<p>I can do this...  </p>\n\n<pre><code>EXEC MyStoredProc @MyVar ;\n</code></pre>\n\n<p>and I can do this...   </p>\n\n<pre><code>EXEC MyStoredProc 101 ;\n</code></pre>\n\n<p>but I can't do this...   </p>\n\n<pre><code>EXEC MyStoredProc @MyVar + 1  ;\n</code></pre>\n\n<p>This is going to make my script a LOT harder to write unless I am missing something.  This is for SQL 2005.</p>\n"},{"tags":["mysql","sql","tsql","select","casting"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":12876151,"title":"SQL cast int to datetime","body":"<p>Why does this SQL statement:</p>\n\n<pre><code>Select cast(convert(1231231231,103) AS datetime)\n</code></pre>\n\n<p>cause an error:</p>\n\n<blockquote>\n  <p><em>#1064 - You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to\n  use near '103) AS datetime)' at line 1</em></p>\n</blockquote>\n\n<p>I need to convert <code>INT</code> to <code>DATETIME</code>, how to make it work?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":90,"score":0,"question_id":12874143,"title":"SQL Server 2012 A severe error occurred on the current command. The results, if any, should be discarded","body":"<p>For the past couple of days, I have been getting quite a bit of the messages below with no clue how to fix them. I use temp tables in many of my procedures for processing, and I am </p>\n\n<p><strong>Msg 0, Level 11, State 0, Line 0.\nA severe error occurred on the current command.  The results, if any, should be discarded</strong></p>\n\n<p>All my stored procedures have NO COUNT set to ON. I don't use a whole lot of CTEs and I drop all temp tables after use.</p>\n\n<p>I checked the log files C:\\Program Files\\Microsoft SQL Server\\MSSQL11.WORKBOX\\MSSQL\\Log but found nothing that I believe explains what is happening to me. I would appreciate any help tackling this issue please. </p>\n"},{"tags":["c#",".net","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12850818,"title":"Failed to convert parameter value from SqlParameter to String","body":"<p>I get the error: </p>\n\n<blockquote>\n  <p><em>Failed to convert parameter value from SqlParameter to String.</em></p>\n</blockquote>\n\n<p>I pass in: </p>\n\n<pre><code>TestUsername,\nTestPassword,\nTestFirstName,\nTestLastName,\nTestEmail@Email.Com\n</code></pre>\n\n<p>Code:</p>\n\n<pre><code>        try\n        {\n\n            Console.WriteLine(\"Inputs: Username, Password, First Name, Last Name, Email\");\n            Console.WriteLine(\"Username: \");\n            string usernameInput = Console.ReadLine();\n            Console.WriteLine(\"Password: \");\n            string passwordInput = Console.ReadLine();\n            Console.WriteLine(\"First Name: \");\n            string firstNameInput = Console.ReadLine();\n            Console.WriteLine(\"Last Name: \");\n            string lastNameInput = Console.ReadLine();\n            Console.WriteLine(\"Email: \");\n            string emailInput = Console.ReadLine();\n\n            SqlCommand createLogin = new SqlCommand(\"INSERT INTO [dbo].[Users] VALUES ('@username', '@password', '@firstname', '@lastname', '@email')\", myConnection.SqlConnection);\n            SqlParameter usernameParam = createLogin.Parameters.Add(\"@username\", SqlDbType.VarChar, 40);\n            SqlParameter passwordParam = createLogin.Parameters.Add(\"@password\", SqlDbType.VarChar, 50);\n            SqlParameter firstNameParam = createLogin.Parameters.Add(\"@firstname\", SqlDbType.VarChar, 40);\n            SqlParameter lastNameParam = createLogin.Parameters.Add(\"@lastname\", SqlDbType.VarChar, 40);\n            SqlParameter emailParam = createLogin.Parameters.Add(\"@email\", SqlDbType.VarChar, 40);\n\n            usernameParam.Value = usernameInput;\n            passwordParam.Value = passwordInput;\n            firstNameParam.Value = firstNameInput;\n            lastNameParam.Value = lastNameInput;\n            emailParam.Value = emailParam;\n\n\n            createLogin.ExecuteNonQuery();\n            Console.WriteLine(\"Username: {0} with Password: {1} created.\", usernameInput, EncDec.Decrypt(passwordInput, \"testEncryption\"));\n        }\n        catch (Exception CreateLoginException)\n        {\n            Console.WriteLine(CreateLoginException);\n        }\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":55,"score":4,"question_id":12867644,"title":"How to retrieve DISTINCT values from this table?","body":"<p>Here goes my table values. ( 7 Records )</p>\n\n<pre><code>SELECT * FROM tbl1\n</code></pre>\n\n<p>I can't post the image as my rep is low. So i am linking it here \n<a href=\"http://i.stack.imgur.com/CFl0u.png\" rel=\"nofollow\">http://i.stack.imgur.com/CFl0u.png</a></p>\n\n<p>I wrote a query to avoid the last record, but i am still getting the last record. (ALL I NEED IS DISTINCT EMAILS)</p>\n\n<pre><code>SELECT DISTINCT CandEmail,CandName,EmployerId,ContNum,IsDeleted,CandPortalId FROM tbl1\nWHERE EmployerId = 7 AND IsDeleted = 0\n</code></pre>\n\n<p>The above query still retrieves the same 7 records with last duplicate email record.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":146,"score":1,"question_id":11847584,"title":"Transposing Rows in to colums in SQL Server 2005","body":"<p>I have an sql query \"Select * from tablename\" whose output is </p>\n\n<pre><code>col1   col2       \n  A     1 \n  B     2 \n  C     3\n</code></pre>\n\n<p>I want to modify the above output to below as following</p>\n\n<pre><code>A      B      C\n1      2      3 \n</code></pre>\n\n<p>Please let me know how could I achieve this</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12869707,"title":"SQL Server: Execute nvarchar SQL statement and parametrize results without OUTPUT parameters","body":"<p>Is there a way to execute a SQL statement stored in nvarchar or ntext and parameterize the results of the executed SQL statement without using sp_executesql? E.g.</p>\n\n<pre><code>@SQL = 'SELECT name FROM db.dbo.employees WHERE income &gt; 50000'\n</code></pre>\n\n<p>In this case, in a stored procedure, could I extract name without having to modify the query so I can use sp_executesql with an OUTPUT parameter defined for name?</p>\n"},{"tags":["sql-server","sql-server-2005","tsql","insert"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":248,"score":2,"question_id":3004282,"title":"In SQL Server, how can I insert data into a table that has just one column which is of identity type?","body":"<p>In SQL Server, how can I insert data into a table that has just one column which is of identity type?\nSuch as insert into the following table <strong>t</strong>.\nHow can I write the insert statement?</p>\n\n<pre><code>CREATE TABLE t\n(\n    id INT IDENTITY(1, 1) PRIMARY KEY\n)\n</code></pre>\n\n<p>Great thanks.</p>\n"},{"tags":["tsql","sql-server-2008-r2","set","maximum","column"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":48,"score":-1,"question_id":12868213,"title":"Is that somehow possible to set a maximum value for a column at sql server 2008 r2","body":"<p>My question is pretty simple but i wonder is that possible.</p>\n\n<p>For example i have a table and it contains the column below</p>\n\n<pre><code>PokemonHappiness    smallint\n</code></pre>\n\n<p>Alright now my question is that possible to set a maximum value for that column. Like set it maximum 10000 so if i send a query like this</p>\n\n<p>assume that PokemonHappiness is equal to 9990</p>\n\n<pre><code>update mytable set PokemonHappiness=PokemonHappiness+50 \n</code></pre>\n\n<p>it should become 10000 instead of 10040</p>\n\n<p>is that possible ? thank you</p>\n\n<p>sql server 2008 r2</p>\n"},{"tags":["sql","tsql","datetime","datediff"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":12867813,"title":"Alternate Method to convert datetime to DD:HH SQL","body":"<p>I have a conversion method to accomplish converting a datediff() to dd:hh but i am also trying to add some additional calculations into it which is causing an arithmetic overflow error converting numeric to varchar.</p>\n\n<p>im not looking for anyone to solve my arithmetic issue, just looking for alternate conversion methods that i can try out and test for myself, if this is pointless please tell me as well, not sure if a different method will change anything.</p>\n\n<p>here is the current method:</p>\n\n<pre><code>-- resulting in Days\nconvert(varchar(10), (datediff(second, startdate, enddate)/86400)+':'+ \n-- resulting in hours\nconvert(varhcar(10), (datediff(second, startdate, enddate)%86400/3600)) as 'DD:HH'\n</code></pre>\n\n<p>does anyone have anything else that will accomplish the same goal?</p>\n\n<p>maybe a better way to ask is there a way to  limit the arithmetic performed in this to return a shorter integer so that i can work towards avoiding the overflow error?</p>\n"},{"tags":["sql","sql-server","tsql","cursor"],"answer_count":9,"favorite_count":3,"up_vote_count":16,"down_vote_count":0,"view_count":4503,"score":16,"question_id":1479680,"title":"MS SQL Server - When is a CURSOR good?","body":"<p>Many times when I've written stored procedures, etc.  I use a CURSOR at first and later find some performance issue with my procedure.</p>\n\n<p>Every thing I read says CURSORS are awful, cause unnecessary locking, etc. and performance testing proves the same.</p>\n\n<p>My question is when do you use a CURSOR and in what situations are they useful or good?</p>\n\n<p>If there is no use, why would they make such a bad control structure/type for SQL?</p>\n"},{"tags":["sql","sql-server-2008","tsql","pivot"],"answer_count":1,"favorite_count":2,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12865206,"title":"SQL rotate rows to columns...dynamic number of rows","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/10404348/sql-server-dynamic-pivot-query\">SQL Server dynamic PIVOT query?</a>  </p>\n</blockquote>\n\n\n\n<p>I have a dataset that has the below structure.</p>\n\n<pre><code>CREATE TABLE #TempTable\n  (\n     Measure_ID  INT,\n     measurement DECIMAL(18, 4)\n  )\n\nINSERT INTO #TempTable\nVALUES\n(1,2.3)\n,(1,3.4)\n,(1,3.3)\n,(2,3)\n,(2,2.3)\n,(2,4.0)\n,(2,4.5)\n</code></pre>\n\n<p>I need to produce output that will look like this.</p>\n\n<pre><code>1,2.3,3.4,3.3\n2,3,2.3,4.0,4.5\n</code></pre>\n\n<p>Basically its a pivot on Measure_ID.  Unfortunately, there can be an unlimited number of measure_id's.  So Pivot is out.</p>\n\n<p>I'm hoping to avoid CURSORS, but will if that turns out to be the best approach.</p>\n"},{"tags":["sql","sql-server","tsql","cursor"],"answer_count":5,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":1498,"score":1,"question_id":6256599,"title":"Is there a way to use parameters in a SQL Server cursor?","body":"<p>I have a parent-child relationship in the database. What I need to do is loop through the parent's query, and using the parent's primary key, got get its children. The issue I am having is that I need to use a parameterized cursor (pass in the key) to do this.</p>\n\n<p>Is there such a thing in SQL Server or a trick to mimic this? I tried doing this, but it didn't work:</p>\n\n<pre><code>DECLARE @value   VARCHAR(20);\nDECLARE @someKey NUMERIC(19,0);\n\nDECLARE main_curs \nCURSOR FOR SELECT value FROM someTable where key = @someKey;\n\nSET @someKey = 12345;\n\nOPEN main_curs\nFETCH NEXT FROM main_curs INTO @value;\nCLOSE main_curs\nDEALLOCATE main_curs\n</code></pre>\n\n<p>But it seems that it doesn't pick up me setting the @someKey. </p>\n\n<p>Any help on this would be greatly appreciated. Thanks!</p>\n\n<p><strong>UPDATE</strong></p>\n\n<p>I should include more information as I made the example seem too simple. I have multiple @someKey values that I need to use. As mentioned before, I have a parent-child relationship and I can have up to 6 children. So I am getting a list of parents and it's respective columns and iterating through it. While in the WHILE-LOOP, I wanted to get the primary key from the parent and call another cursor to get the child information (different columns returned). So I would do multiple calls to the child cursor with different @someKey values set. Hope that makes sense.</p>\n"},{"tags":["mysql","sql-server","tsql"],"answer_count":15,"favorite_count":9,"up_vote_count":23,"down_vote_count":0,"view_count":23697,"score":23,"question_id":10616,"title":"Differences Between MySql and MS SQL","body":"<p>I'm an ASP.NET developer who has used Microsoft SQL Server for all my database needs (both at work and for personal projects). I considering trying out the LAMP stack for some of my personal projects. What are some of the main differences between MySQL and MS SQL? Are using Stored Procedures a common practice in MySQL? Any advice or resources you'd recommend to help me with the switch? To those who have experience with both, are there any missing features from MySQL?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":66,"score":1,"question_id":12865449,"title":"how do i join these two tables?","body":"<p>I have 2 tables in SQL Server:</p>\n\n<p><img src=\"http://i.stack.imgur.com/vGx63.jpg\" alt=\"enter image description here\"></p>\n\n<p>Now I want to write a select statement to join these 2 tables to get <code>MatchId</code>, <code>Host name</code> and <code>Guest name</code>.</p>\n\n<p>What I tried:</p>\n\n<pre><code>select Match.Id, Team.Name, Team.Name \nfrom Match \njoin Team on Match.HostId = Team.Id\n</code></pre>\n\n<p>and I got host name and guest name are the same.</p>\n\n<pre><code>select Match.Id, Team.Name, Team.Name \nfrom Match \njoin Team on Match.HostId = Team.Id \njoin Team on Match.GuestId = Team.Id\n</code></pre>\n\n<p>I got error.</p>\n\n<p>Please help!</p>\n"},{"tags":["tsql","reporting-services"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12863252,"title":"use a parameter to determine a date range in ssrs report query","body":"<p>I am writing an SSRS report and need to provide the user with an option to select a different value (ex: paiddate or shipdate), and then use that value as part of the query criteria.  After selecting this option, the user would select a start and an end date.</p>\n\n<p>paiddate and shipdate are two columns in my table.  So, my query would be based on one of two sets of criteria, for example:</p>\n\n<pre><code>select * from table1 where table1.paiddate between @startdate and @enddate \n</code></pre>\n\n<p>OR </p>\n\n<pre><code>select * from table1 where table1.shipdate between @startdate and @enddate\n</code></pre>\n\n<p>How do I get the paiddate or shipdate into my query in this manner?  Thank you for your assistance!</p>\n\n<p>Maybe this will help:\n<img src=\"http://i.stack.imgur.com/YYmcR.png\" alt=\"enter image description here\">\n<img src=\"http://i.stack.imgur.com/lJxN8.png\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","database","tsql","stored-procedures"],"answer_count":10,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":10898,"score":4,"question_id":738133,"title":"Comma separated values in a database field","body":"<p>I have a products table.  Each row in that table corresponds to a single product and it's identified by a unique Id. Now each product can have multiple \"codes\" associated with that product.  For example:</p>\n\n<pre>\nId     |    Code\n----------------------\n0001   |   IN,ON,ME,OH\n0002   |   ON,VI,AC,ZO\n0003   |   QA,PS,OO,ME\n</pre>\n\n<p>What I'm trying to do is create a stored procedure so that I can pass in a codes like \"ON,ME\" and have it return every product that contains the \"ON\" or \"ME\" code.  Since the codes are comma separated, I don't know how I can split those and search them.  Is this possible using only TSQL?</p>\n\n<p>Edit: It's a mission critical table.  I don't have the authority to change it.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","database-design"],"answer_count":4,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":401,"score":4,"question_id":6418214,"title":"Table Normalization (Parse comma separated fields into individual records)","body":"<p>I have a table like this:</p>\n\n<p><strong>Device</strong></p>\n\n<pre><code>DeviceId   Parts\n\n1          Part1, Part2, Part3\n2          Part2, Part3, Part4\n3          Part1\n</code></pre>\n\n<p>I would like to create a table 'Parts', export data from Parts column to the new table. I will drop the Parts column after that</p>\n\n<p>Expected result</p>\n\n<p><strong>Parts</strong></p>\n\n<pre><code>PartId PartName\n\n  1      Part1\n  2      Part2\n  3      Part3\n  4      Part4\n</code></pre>\n\n<p><strong>DevicePart</strong></p>\n\n<pre><code>DeviceId PartId\n\n  1      1\n  1      2\n  1      3\n  2      2\n  2      3\n  2      4\n  3      1\n</code></pre>\n\n<p>Can I do this in SQL Server 2008 without using cursors?</p>\n"},{"tags":["sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12864058,"title":"SQL Server 2005 PIVOT Syntax Error","body":"<p>I receive the following error</p>\n\n<p>Msg 156, Level 15, State 1, Line 10\nIncorrect syntax near the keyword 'SELECT'.\nMsg 102, Level 15, State 1, Line 10\nIncorrect syntax near ')'.</p>\n\n<p>When I run the following query</p>\n\n<pre><code> SELECT TOP 100 *\nFROM\n(\nSELECT [TimeStamp],[MeterID],[Value]\nFROM access_AMIData) AS source\nPIVOT\n(\nSUM(Value)\nFOR MeterID IN (SELECT MeterNumber FROM access_tblFcppPvMeterList)\n) as pvt\nORDER BY TimeStamp\n</code></pre>\n\n<p>The error comes with this line:</p>\n\n<pre><code>FOR MeterID IN (SELECT MeterNumber FROM access_tblFcppPvMeterList)\n</code></pre>\n\n<p>If I change this line to:</p>\n\n<pre><code>FOR MeterID IN (1,2,3,4)\n</code></pre>\n\n<p>It works perfectly...how can I specify a select Query inside the IN?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":12863900,"title":"SQL server 2008: Conversion of varchar to datetime failed","body":"<p>I have problems with the following code:</p>\n\n<pre><code>USE [PCIPNY];\n\ninsert into [dbo].[test_Drug_Medication_1]\n(\n       [MedicationID] ,[ClinicID] ,[PatientID] ,[MyDrugID] ,[NDC] ,[DoctorID] ,[DrugID] ,[DrugFullDesc] ,[Generic_Name]\n      ,[Print_Name] ,[Manufacture] ,[Inactive_Date] ,[Strength] ,[Units] ,[Pkg_Size] ,[Pkg_Type] ,[Route] ,[Take]\n      ,[Frequency] ,[Duration] ,[Qualifier] ,[Quantity] ,[Refill] ,[Note] ,[DAW] ,[CreateDate] ,[CreateBy]\n      ,[ModifyBy],[IsControl] ,[UserDefine] ,[scheduleLevel] ,[BeginDate] ,[EndDate] ,[Active] ,[sente]\n      ,[OnCologyCheckStatus] ,[OnCologyCheckStatus1] ,[OnCologyCheckStatus2] ,[SIG] ,[Printed] ,[ICDCode] ,[SendeFaxed] ,[DosageForm] ,[GPI]\n      ,[IsBrand] ,[IsGeneric] ,[GenericAndBrand] ,[SigUnit] ,[IsDrug] ,[Status]\n)\n\nSELECT\n      [MedicationID] ,[ClinicID] ,[PatientID] ,[MyDrugID] ,[NDC] ,[DoctorID] ,[DrugID] ,[DrugFullDesc] ,[Generic_Name]\n      ,[Print_Name] ,[Manufacture] ,[Inactive_Date] ,[Strength] ,[Units] ,[Pkg_Size] ,[Pkg_Type] ,[Route] ,[Take]\n      ,[Frequency] ,[Duration] ,[Qualifier] ,[Quantity] ,[Refill] ,[Note] ,[DAW] ,[CreateDate] ,[CreateBy]\n      ,[ModifyBy] ,[IsControl] ,[UserDefine] ,[scheduleLevel] ,[BeginDate] ,[EndDate] ,[Active] ,[sente]\n      ,[OnCologyCheckStatus] ,[OnCologyCheckStatus1] ,[OnCologyCheckStatus2] ,[SIG] ,[Printed] ,[ICDCode] ,[SendeFaxed] ,[DosageForm] ,[GPI]\n      ,[IsBrand] ,[IsGeneric] ,[GenericAndBrand] ,[SigUnit] ,[IsDrug] ,[Status]\n\n  FROM [ec14].[dbo].[Drug_Medication]\n    where 1=1\n      and clinicid in (select clinicid from [dbo].[clinic] where org_db = 'ec14' and ClinicID=1234);\n</code></pre>\n\n<p>I got this error:</p>\n\n<blockquote>\n  <blockquote>\n    <p>Msg 241, Level 16, State 1, Line 3<br>\n    Conversion failed when converting date and/or time from character string.</p>\n  </blockquote>\n</blockquote>\n\n<p>I found out that the error is in the column <code>begindate</code>. </p>\n\n<p>The column <code>begindate</code> in ec04(origin location) is <code>charvar(16)</code> datatype.<br>\nThe column <code>begindate</code> in PCIPNY(destination location) is <code>datetime</code> datatype.</p>\n\n<p>Is there any solution to make this work?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":99,"score":1,"question_id":12863422,"title":"Insert multiple rows of default values into a table","body":"<p>I have a table with a single column, which is an auto-generated identity</p>\n\n<pre><code>create table SingleIdTable (\n   id int identity(1,1) not null\n)\n</code></pre>\n\n<p>I can insert a single row with an auto-generated id with:</p>\n\n<pre><code>insert into SingleIdTable default values\n</code></pre>\n\n<p>I want to insert many rows and use the output syntax to get their ids, something like:</p>\n\n<pre><code>insert into SingleIdTable\noutput inserted.Id into @TableOfIds\n    select (default values) from SomeOtherTable where Attribute is null\n</code></pre>\n\n<p>Where the intention is to insert a row into <code>SingleIdTable</code> for each row in <code>SomeOtherTable</code> where <code>Attribute</code> is null using an auto-generated id. The above doesn't work, but how could I do it. I note that if my table had more than just a single column I could do it, but I can't select empty rows which is what I really want to do.</p>\n\n<p>I can't change the definition of <code>SomeOtherTable</code>.</p>\n"},{"tags":["sql","sql-server","tsql","sql-update","case"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12862588,"title":"case expression for various SQL updates","body":"<p>I'm struggling with a case expression to determine which update statement to make. Is the below even possible or should i make separate update stored procedures for each update?</p>\n\n<pre><code> IF (SELECT pick FROM warehouse WHERE order_no = @order_no and pick = @pick) is null\n    CASE @pick \n    when 1 then\n            UPDATE warehouse\n            SET pick = @pick, startpickdate=@dchar, startpicktime=@tchar\n            where order_no=@order_no\n    when 2 then\n            UPDATE warehouse\n            SET pick = @pick, endpickdate=@dchar, endpicktime=@tchar\n            where order_no=@order_no\n    when 0 then\n            UPDATE warehouse\n            SET pick = @pick, endpickdate='', endpicktime='',startpickdate='', startpicktime=''\n            where order_no=@order_no\nEND\nGO\n</code></pre>\n"},{"tags":["tsql","datetime","varchar"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":84,"score":1,"question_id":12862003,"title":"how convert string variable to datetime variable in sql-server?","body":"<p>I'm relatively new to sql-server; I'm trying to have a start-date and end-date pulled from a form-variable as string then convert it into datetime (yyyy-mm-dd) format and I can't seem to find anything that works. Attempted code and resulting error is below. Any advice would be appreciated.</p>\n\n<pre><code>declare @startdate as varchar\ndeclare @enddate as varchar\nset @startdate=cast(@startdate as datetime)\nset @enddate=cast(@enddate as datetime)\n\nSELECT order_date, inv_no \nfrom invoices \nwhere order_date between @startdate and @enddate\n</code></pre>\n\n<p>The error I keep getting is:</p>\n\n<blockquote>\n  <p>Conversion failed when converting datetime from character string.</p>\n</blockquote>\n\n<p>How do I fix this?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","pivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":71,"score":-2,"question_id":12862916,"title":"SQL Server 2005 Rows to Columns","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/10652921/t-sql-group-rows-into-columns\">T-SQL Group Rows Into Columns</a>  </p>\n</blockquote>\n\n\n\n<p>I have a table _data that is formatted like this</p>\n\n<pre><code>TimeStamp                        MeterID      Value\n2012-04-15 13:00:00.000          CK1992       152.64\n2012-04-15 12:45:00.000          CK1992       151.695\n2012-07-06 12:45:00.000          CK1992       150.84\n2012-09-04 12:00:00.000          CK1992       150.66\n2012-04-15 12:15:00.000          CK1992       150.57\n</code></pre>\n\n<p>I need to be able to format that table as something like this</p>\n\n<pre><code>Timestamp     MeterID1     MeterID2     MeterID3\nstamphere     value        value        value\n</code></pre>\n\n<p>I have a lot of different MeterIDs so it needs extract it accordingly.</p>\n\n<p>Here is my existing select statement:</p>\n\n<pre><code>SELECT [TimeStamp]\n  ,[MeterID]\n  ,[Value]\nFROM [dbo].[_Data]\n</code></pre>\n\n<p>How can I make this work? Thanks for your help!</p>\n"},{"tags":["sql-server","tsql","pivot"],"answer_count":9,"favorite_count":28,"up_vote_count":50,"down_vote_count":0,"view_count":79970,"score":50,"question_id":24470,"title":"SQL Server PIVOT examples?","body":"<p>Trying to find some simple SQL Server PIVOT examples.  Most of the examples that I have found involve counting or summing up numbers.  I just want to pivot some string data.  For example, I have a query returning the following.</p>\n\n<pre><code>Action1 VIEW  \nAction1 EDIT  \nAction2 VIEW  \nAction3 VIEW  \nAction3 EDIT  \n</code></pre>\n\n<p>I would like to use PIVOT (if even possible) to make the results like so:</p>\n\n<pre><code>Action1 VIEW EDIT  \nAction2 VIEW NULL  \nAction3 VIEW EDIT  \n</code></pre>\n\n<p>Is this even possible with the PIVOT functionality?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12836195,"title":"how to drop foreign key constraint","body":"<p>I want to delete a Foreign Key Constraint from a table, but not sure which table is that. I just have this information. Please check the screenshot\n<img src=\"http://i.stack.imgur.com/X45Co.png\" alt=\"enter image description here\"></p>\n\n<p>I want to drop a table but its not allowing me to drop due to some FK constraints. Table I want to delete is 'ZIP_Codes'</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12856651,"title":"using OR in sql join is slow","body":"<p>i have a scenario as below.</p>\n\n<p>Employee table</p>\n\n<pre><code>EmpId X_Id  Flag\n--------------------------------\n1      123     0\n</code></pre>\n\n<p>Dept table</p>\n\n<pre><code>DeptId D.Name X_Id  Flag\n----------------------------------------------\n1        a     123    0\n2        b     123    1\n</code></pre>\n\n<p>i need to write a query that fetches the rows based on the flag. ie., if flag is 0 in EmpTable, then get only rows which have flag as 0 and if flag is set to 1 in EmpTable, get all rows (with flag as 0 and 1). To achieve this, i have written the below query</p>\n\n<pre><code>SELECT E.EmpId, E.X_Id, D.Did, D.Dname\nFROM EmpTable E INNER JOIN DeptTable D\nON E.X_Id = D.X_Id\nAND (D.Flag = 0 or D.Flag = E.Flag)\n</code></pre>\n\n<p>the above query returns correct rows, but as I see it, using OR is not a good idea. the query is slow.\nAny alternatives to achieve the same with optimal performance??</p>\n"},{"tags":["c#","sql-server","tsql","ado.net","dataset"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":94,"score":0,"question_id":12845530,"title":"Field name not in DataSet","body":"<p>Edit: 1) Name != name, this isn't the problem. The code works 99.9999% of the time and only fails in production occassionally (Never under lab conditions >_&lt;) We are deploying debugging code which should explain what is going on, but until we can do that, just looking for if anyone has seen anything similar.</p>\n\n<p>Edit: 2) Just for information. To test, I've run the following code</p>\n\n<pre><code>...\nvar name = row[\"Name\"].ToString().ToLower();\nvar name2 = row[\"name\"].ToString().ToLower();\n...\n</code></pre>\n\n<p>And this actually works fine, suggesting, in framework 4 at least, row[xx] is not case sensitive. Either way, it's not the problem I'm seeing unfortunately. Wish it was :)</p>\n\n<p>Here's a simple snippet of code which is causing us problems. It isn't just this bit of code, it's actually any code that looks like this. The common part is row[\"name\"] throwing an exception claiming that \"name\" is not a column of table Table.</p>\n\n<pre><code>var command = new SqlCommand(\"SELECT Name FROM Table1\");\nDataSet result = helper.ExecuteQuery(command); \nif (result == null || result.Tables.Count != 1)\n{\n    return;\n}\nforeach (DataRow row in result.Tables[0].Rows)\n{\n    var name = row[\"Name\"].ToString().ToLower();                \n}\n</code></pre>\n\n<p>helper.ExecuteQuery returns a DataSet, </p>\n\n<p>As you can see we know the result is a dataset, i.e. it's not null and it contains one table.</p>\n\n<p>We know it has rows because we're in the foreach loop. We know Name exists as a column because the sql statement that is run is always pretty much hard coded into there with no ambiguity or cleverness going on.</p>\n\n<p>Any thoughts (related to the problem?) There are some work arounds, using the int indexer, most of these queries return one or two columns only. Check for the columns first, all this sort of thing, but I have never encountered this problem in more years than I can remember.</p>\n"},{"tags":["sql","sql-server-2008","tsql","ssms","sqlcmd"],"answer_count":3,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":3290,"score":2,"question_id":9889334,"title":"Windows authenticated SQL Server - need admin privileges","body":"<p>I've managed to install SQL Server 2008 R2, but I fail when trying to create a new database because of rights (or lack of) (\"CREATE DATABASE PERMISSION DENIED\"). So I tried to assign the admin privileges to my current login - \"User does not have permission to perform this action.\" I also tried to create a new login that would have admin privileges but with no luck, obviously.</p>\n\n<p>Can anyone point me in the right direction to granting myself admin rights so that I can create a database? It's a local server. And I can install again if I really need to (takes a while on this machine so it's preferable to somehow make changes to this schema if possible).</p>\n"},{"tags":["sql-server-2005","tsql","aggregate-functions"],"answer_count":8,"favorite_count":3,"up_vote_count":6,"down_vote_count":0,"view_count":10499,"score":6,"question_id":773417,"title":"Aggregate SQL Function to grab only the first from each group","body":"<p>I have 2 tables - an Account table and a Users table.  Each account can have multiple users.  I have a scenario where I want to execute a single query/join against these two tables, but I want all the Account data (Account.*) and only the <em>first</em> set of user data (specifically their name).</p>\n\n<p>Instead of doing a \"min\" or \"max\" on my aggregated group, I wanted to do a \"first\".  But, apparently, there is no \"First\" aggregate function in TSQL.</p>\n\n<p>Any suggestions on how to go about getting this query?  Obviously, it is easy to get the cartesian product of Account x Users:</p>\n\n<pre><code> SELECT User.Name, Account.* FROM Account, User\n WHERE Account.ID = User.Account_ID\n</code></pre>\n\n<p>But how might I got about only getting the first user from the product based on the order of their User.ID ?</p>\n"},{"tags":["sql","sql-server-2008","tsql","datetime"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":99,"score":3,"question_id":12858311,"title":"TSQL - get last second of current hour","body":"<p>I need to use a query to get the last second of an hour based on a field in a table.</p>\n\n<p>I have worked this query, which appears to work (SQL Server 2008)</p>\n\n<blockquote>\n  <p>SELECT DATEADD(S, -1, DATEADD(hh, 1, dateadd(minute, datediff(minute,0,GETDATE()) / 60 * 60, 0)))</p>\n</blockquote>\n\n<p>Is this the best way to go about this or are there cleaner (more readable) and faster ways. I am considering speed as this will run on a table with a lot of string processing and am trying to optimize where I can.</p>\n\n<p>EDIT: I originally posted the text and subject of this question to read 'last minute of current hour' This was intended to read 'last second'. My mind has obviously shut down for the day. Apologies for my mistake</p>\n"},{"tags":["sql","sql-server","tsql","xml-parsing","identifier"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":105,"score":2,"question_id":12849790,"title":"T-SQL: cross apply; too many iterations on line items","body":"<p>I've almost got what I want after shredding up some serious Xml--but after looking at the results, I see that in one section of the parsing, I can't easily resolve this pattern of iterating through all of the line details for each of the subheaders-- so instead of writing out a total of let's say 3 records for all of the line items, I'm writing out three line items for each of the subs--of which let's say I have two. I wind up with a total of 6! :-( I've distilled the pattern as a generic header/subheader/detail relationship model in the code that follows. </p>\n\n<pre><code>    DECLARE @MetroXML xml\n    SET @MetroXML =\n    '&lt;Header&gt;\n       &lt;col1&gt;Conoco&lt;/col1&gt;\n       &lt;col2&gt;ORD-1111&lt;/col2&gt;\n       &lt;SubHeaders&gt;\n         &lt;SubHeader&gt;\n          &lt;col1&gt;Dallas&lt;/col1&gt;\n          &lt;col2&gt;BOL-2213&lt;/col2&gt;\n         &lt;Details&gt;\n          &lt;Detail&gt;\n            &lt;col1&gt;Diesel&lt;/col1&gt;\n            &lt;col2&gt;7600.00&lt;/col2&gt;\n          &lt;/Detail&gt;\n         &lt;/Details&gt;\n        &lt;/SubHeader&gt;\n        &lt;/SubHeaders&gt;\n        &lt;SubHeaders&gt;\n         &lt;SubHeader&gt;\n          &lt;col1&gt;Fort Worth&lt;/col1&gt;\n          &lt;col2&gt;BOL-2216&lt;/col2&gt;\n         &lt;Details&gt;\n          &lt;Detail&gt;\n            &lt;col1&gt;Ethanol&lt;/col1&gt;\n            &lt;col2&gt;1852.00&lt;/col2&gt;\n          &lt;/Detail&gt;\n          &lt;Detail&gt;\n            &lt;col1&gt;Unleaded&lt;/col1&gt;\n            &lt;col2&gt;900.00&lt;/col2&gt;\n          &lt;/Detail&gt;\n         &lt;/Details&gt;\n       &lt;/SubHeader&gt;\n      &lt;/SubHeaders&gt;\n     &lt;/Header&gt;';\n\n\n    INSERT INTO [scratch].GenericHeader\n     SELECT T.c.value('col1[1]','varchar(10)') AS 'col1',\n            T.c.value('col2[1]','varchar(10)') AS 'col2'\n       FROM @MetroXML.nodes('/Header') T(c);\n\n\n    INSERT [scratch].GenericSubHeader\n     (id,col1,col2)\n    SELECT \n      h.id,\n      n.x.value('col1[1]','varchar(10)') AS 'col1',\n      n.x.value('col2[1]','varchar(10)') AS 'col2'\n     FROM [scratch].GenericHeader h\n      CROSS APPLY @MetroXML.nodes('/Header/SubHeaders/SubHeader') n(x);\n\n\n     INSERT [scratch].GenericDetail\n     (id,subid,col1,col2)\n      SELECT \n       s.id,\n       s.subid,\n       n.x.value('col1[1]','varchar(10)') AS 'col1',\n       n.x.value('col2[1]','varchar(10)') AS 'col2'\n     FROM [scratch].GenericSubHeader s\n      CROSS APPLY @MetroXML.nodes('/Header/SubHeaders/SubHeader/Details/Detail') as n(x);\n\n\n     select * from [scratch].GenericHeader\n      where id = 24;\n\n     select * from [scratch].GenericSubHeader\n      where id = 24;\n\n     select * from [scratch].GenericDetail\n      where id = 24;\n</code></pre>\n\n<p>NOTE: id,subid,detid are defined as  INT IDENTITY(1,1) \nResults</p>\n\n<p>What I get:</p>\n\n<pre><code>id|subid|detid|col1     |col2\n--------------------------------\n24|44   |22   |Diesel   |7600.00\n24|44   |23   |Ethanol  |1852.00\n24|44   |24   |Unleaded |900.00\n24|48   |25   |Diesel   |7600.00\n24|48   |26   |Ethanol  |1852.00\n24|48   |27   |Unleaded |900.00\n</code></pre>\n\n<p>What I want to get:</p>\n\n<pre><code>id|subid|detid|col1     |col2\n--------------------------------\n24|44   |22   |Diesel   |7600.00\n24|48   |23   |Ethanol  |1852.00\n24|48   |24   |Unleaded |900.00\n</code></pre>\n"},{"tags":["sql-server","tsql","sql-server-2008"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":7269,"score":4,"question_id":3525997,"title":"Generate MD5 hash string with T-SQL","body":"<p>Is there a way to generate MD5 Hash string of type varchar(32) without using fn_varbintohexstr</p>\n\n<pre><code>SUBSTRING(master.dbo.fn_varbintohexstr(HashBytes('MD5', 'email@dot.com')), 3, 32)\n</code></pre>\n\n<p>So it could be used inside a view with SCHEMABINDING</p>\n"},{"tags":["sql","tsql","date","rate"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":73,"score":0,"question_id":12836756,"title":"SQL Accrual Challenge","body":"<p>I've got this TSQL view with a join that produces a this select with all Absent days this fiscal:</p>\n\n<p>Name, HireDate, StartingVacationDays, StartingSickDays, AbsentType, AbsentStartDate, AbsentDays</p>\n\n<pre><code>John, 01/01/2010, 5.2, 10.5, V, 07/04/2012, 4\nJohn, 01/01/2010, 5.2, 10.5, S, 08/04/2012, 1\nJohn, 01/01/2010, 5.2, 10.5, S, 09/04/2012, 3\nMary, 09/05/2012, 0, 0, S, 10/04/2012, 1\n</code></pre>\n\n<p>Where Starting Vacation and Sick are days available at the begin of Fiscal (starts Prior June 1st).  Absent type is Sick or Vacation, Absent start date is the day they were first out and Days is the number of days out.</p>\n\n<p>I have this accrual rule:</p>\n\n<pre><code>0.8 per Month for Vacation if (1-3 years of serivice)\n1.2 per Month for Vacation if (4+ years of service)\n0.5  per month for Sick days.\n</code></pre>\n\n<p>I need to produce two reports (one for Vacation and one for Sick)  with a balance  for every month June to May. 30 days in a month, 20 work days a month. Current month prorates the accrual.</p>\n\n<p>I'm inclinded to build 24 formulas in a report, but suspect there might be a much more elegant way to do this in SQL. Maybe somebody has tackled something like this before?</p>\n\n<p>Ideally output would look like this:</p>\n\n<p>Name, HireDate, Month, begvacationBalance, begSickBalance, Vacationtaken, Sicktaken</p>\n\n<pre><code>John, 01/01/2010, June, 5.2, 10.5,0,0\nJohn, 01/01/2010, August, 2.0, 10.5,4,0  (2.0 = 5.2 + 0.8 - 4) (0.8 because has not reached 4 yrs svc)\n</code></pre>\n\n<p>Trying to wrap my mind around the problem. Thanks for any help or direction!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":108,"score":3,"question_id":12853286,"title":"SQL Concatenating row values on primary key","body":"<p>I have a requirement to concatenate values in different rows of my query based on Item ID. </p>\n\n<p>For instance, I have the following rows of data. </p>\n\n<pre><code>GroupID LABEL   VALUE   UNIT\n    1   Name    Henry   \n    1   Guest   Manny   Guest\n    1   Room    12  \n    1   Milk    10      Quart\n    1   Eggs    3       dozen\n    2   Name    Mark    Supervisor\n    2   Water   13      Litre\n    2   Milk    3       Gallons\n    2   Soap    12      bars\n</code></pre>\n\n<p>And as output, I want to get the following </p>\n\n<pre><code>ItemID     VALUE \n\n1          Name: Henry; Guest:Manny Guest; Room:12; Milk:10 Quart; Eggs: 3 dozen;\n\n2          Name: Mark supervisor; Water: 13 litre; Milk: 3 Gallons; Soap: 12 bars;\n</code></pre>\n\n<p>How do I accomplish this please? </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":70,"score":1,"question_id":12854180,"title":"How to weekly aggregate data in sql and include skipped weeks too","body":"<p>I am working in SQL Server 2008. I am writing a stored procedure which aggregates data on a weekly basis.</p>\n\n<p>Code for aggregation is </p>\n\n<pre><code>ALTER PROCEDURE [dbo].[ups_URLBatchStats] \n   (@startDate datetime, @endDate datetime,@source varchar(8))\nAS BEGIN\n    SELECT \n       DATEADD(wk, DATEDIFF(wk, 0, ScheduleDate), 6) AS [Week Commencing], \n       SUM(Unresolved) AS Unresolved,\n       SUM(Resolved) AS Resolved,\n       SUM(TurkSpend) AS TurkSpend\n    FROM \n       dbo.V_URLBatchStats \n    WHERE\n       ScheduleDate BETWEEN @startDate AND @endDate \n       AND Source = ISNULL(@source, Source)\n    GROUP BY\n       DATEADD(wk, DATEDIFF(wk, 0, ScheduleDate), 6)\n    ORDER BY \n       DATEADD(wk, DATEDIFF(wk, 0, ScheduleDate), 6)\nEND\n</code></pre>\n\n<p>Show it gives me correct result, but if there are no data for any week I have to show it with values of '0' in the columns.</p>\n\n<p>So how can I handled these skipped weekly rows?</p>\n\n<p>Thanks in advance.  </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":84,"score":0,"question_id":12850330,"title":"Error 8120 in T-SQL (nested select command)","body":"<p>What is my mistake in this statement?</p>\n\n<pre><code>Select Max (TBLvirtual.c2) as MOF --&gt; Most ordered food (MOF)--//\n      ,TBLvirtual.c1\nfrom\n    (select a.OrdItems as c1, count(a.OrdID) as c2\n     from Orderrouter a \n     group by a.OrdItems) as TBLvirtual\n</code></pre>\n\n<p>I received this error:</p>\n\n<blockquote>\n  <p>Msg 8120, Level 16, State 1, Line 3 Column 'TBLvirtual.c1' is invalid in the select list because it is not contained in either an aggregate function or the GROUP BY clause.</p>\n</blockquote>\n"},{"tags":["sql-server","tsql","stored-procedures","use"],"answer_count":4,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":649,"score":7,"question_id":8166608,"title":"Use database inside a stored procedure","body":"<p>I need to make a stored procedure which creates a user in more than one table. Something like this:</p>\n\n<pre><code>USE [database1]\n\nCREATE USER [userLogin] FOR LOGIN [userLogin]\n\nUSE [database2]\n\nCREATE USER [userLogin] FOR LOGIN [userLogin]\n</code></pre>\n\n<p>Since the <code>CREATE USER</code> statement does his job in the current database I need to use the <code>USE</code> statement to change between databases, but it can't be used inside stored procedures.</p>\n\n<p>How can I do this?</p>\n\n<p>thanks!</p>\n"},{"tags":["c#","linq","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":108,"score":1,"question_id":12849697,"title":"How do I translate this SQL to LINQ","body":"<p>I'm trying to convert the following SQL into Linq but getting confused when I try to apply the min.  Basically I have a table which contains Beams and their allowed loads.  I then query the database and Find the smallest beam by type, which has the required strength.  The following t-SQL</p>\n\n<pre><code>select\n    sed.SEDetailID\nfrom\n    dbo.StructuralElementDetail sed\n    inner join (select StructuralElementID, min(Ix) as MinIX from dbo.StructuralElementDetail where Ix &gt;= @iRequired group by StructuralElementID) o\n        on sed.StructuralElementID = o.StructuralElementID\n            and sed.Ix = o.MinIX\norder by\n    StructuralElementID,\n    Sequence;\n</code></pre>\n\n<p>returns the smallest beam by type where they have the required strength.</p>\n\n<p>I already have the beams loaded into a Dictionary keyed by their IDs, so thought I should be able to query that object rather than make another call to the database.</p>\n\n<p>My dictionary is </p>\n\n<pre><code>Dictionary&lt;int, Beam&gt;;\n</code></pre>\n\n<p>I'm trying something like this but getting confused how I get just the smallest beam by each Type.</p>\n\n<pre><code>            var Beams = db.Values.Where(specificBeam =&gt; specificBeam.Ix &gt;= iRequired)\n                .GroupBy(specificBeam =&gt; specificBeam.ElementType)\n                    .Select(sb =&gt; new { sb.Key, MinIActual = sb.Min(specificBeam =&gt; specificBeam.Ix) });\n</code></pre>\n\n<p>Any pointers?  Can I nest a First combined with</p>\n"},{"tags":["sql","tsql","datetime"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12849970,"title":"determine if date range falls between another date range - sql","body":"<p>I am trying to find out if there is a way in sql (t-sql preferred) to identify if a date range falls between another date range.</p>\n\n<p>for purposes of my example:\ndaterange1 = i have a defined date range, dates are  1/1/2012 - 1/5/2012\ndaterange2 = i have two other dates to work with, lets say 1/3/2012 and 1/4/2012</p>\n\n<p>i am trying to have this to use in a CASE statement for something like this</p>\n\n<pre><code>CASE \n    WHEN daterange1 = 0 then result1\n    WHEN daterange2 falls within daterange1 then result2 \n    END as datestuff \n</code></pre>\n\n<p>is this possible in SQL? I'm really stumped on this one, i know how to figure out if a single date falls between a range, but how can it be done with a date range? the answer doesnt necessarily need to be in a CASE statement but it is preferred.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12849421,"title":"Select column based on whether a specific row in another table exists","body":"<p>Question is similar to this one <a href=\"http://stackoverflow.com/questions/9134558/how-to-write-a-mysql-query-that-returns-a-temporary-column-containing-flags-for\">How to write a MySQL query that returns a temporary column containing flags for whether or not an item related to that row exists in another table</a> </p>\n\n<p>Except that I need to be more specific about which rows exists</p>\n\n<p>I have two tables: 'competitions' and 'competition_entries'</p>\n\n<p>Competitions:</p>\n\n<pre><code>ID    | NAME      | TYPE\n--------------------------------\n1     | Example   | example type\n2     | Another   | example type\n</code></pre>\n\n<p>Competition Entries</p>\n\n<pre><code>ID    | USERID    | COMPETITIONID\n---------------------------------\n1     | 100       | 1\n2     | 110       | 1\n3     | 110       | 2\n4     | 120       | 1\n</code></pre>\n\n<p>I want to select the competitions but add an additional column which specifies whether the user has entered the competition or not. This is my current SELECT statement</p>\n\n<pre><code>SELECT\n    c.[ID],\n    c.[NAME],\n    c.[TYPE],\n    (CASE \n        WHEN e.ID IS NOT NULL AND e.USERID = @userid THEN 1 \n        ELSE 0 \n        END\n    ) AS 'ENTERED'      \n\nFROM competitions AS c\nLEFT OUTER JOIN competition_entries AS e\nON e.COMPETITIONID = c.ID\n</code></pre>\n\n<p>My desired result set from setting the <code>@userid</code> parameter to <code>110</code> is this</p>\n\n<pre><code>ID    | NAME    | TYPE         | ENTERED\n-------------------------------------\n1     | Example | example type | 1\n2     | Another | example type | 1\n</code></pre>\n\n<p>But instead I get this</p>\n\n<pre><code>ID    | NAME    | TYPE         | ENTERED\n-------------------------------------\n1     | Example | example type | 0\n1     | Example | example type | 1\n1     | Example | example type | 0\n2     | Another | example type | 1  \n</code></pre>\n\n<p>Because it's counting the entries for all user ids</p>\n"},{"tags":["python","tsql","sqlite","sqlite3"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":12848560,"title":"Python: T-SQL EQuivalent for Sqlite3?","body":"<p>I have the following MS-SQL based query which I need to convert into Sqlite3 based database</p>\n\n<pre><code>DECLARE @status int, @nextPriority int\nSELECT @status = status FROM status WHERE nameStatus = '234'\n</code></pre>\n\n<p>I then have to use that variable in an INSERT query.</p>\n\n<p>One way I think is to execute query and bind variables but I am willing to execute all queries in a Go. Is it possible?</p>\n\n<p>I am using Python 2.6</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":12848270,"title":"T-SQL - Returning a different value than what is stored in the database for several columns","body":"<p>I have a query that returns 16 columns. 12 of them have similar data (they return values 0, 1 or 2). I want to replace these numbers with letters - 0 with L, 1 with M, and 2 with H.</p>\n\n<p>I can write 12 case statements but that would be overkill and I definitely don't want to do that. I'd much rather convert these values in the front end instead. Is there any way to use something like a function (within the query itself only) which returns the appropriate value?</p>\n\n<p>Please note that I have read only access to the database and there are thousands of databases like these already out there so creating a udf is not possible. </p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","contiguous"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":63,"score":-1,"question_id":12848024,"title":"Trying to consolidate employer records who are continuously work for same department","body":"<p>Trying to consolidate employer who worked same department where TO_DATE and Preceding From date is less than days ..</p>\n\n<p>DATA :</p>\n\n<pre><code>EMP_ID | DEPT_ID |EMP_EFF_FROM_DATE |EMP_EFF_TO_DATE\n10 | 10001 |2008-08-01 | 2009-10-31\n10 |10001 |2009-11-01 | 2010-02-25\n10 | 10001 | 2010-02-26 | 2011-05-01\n10 | 10001 | 2011-08-01 | 2011-10-30\n10 | 10001 | 2011-12-01 | 2012-10-31\n10 | 10003 | 2007-07-01 | 2007-10-31\n10 | 10004 | 2004-09-27 | 2006-06-08\n10 | 10004 | 2006-06-30 | 2007-06-29\n10 | 10007 | 2006-06-25 | 2007-06-20\n10 | 10007 | 2007-08-25 | 2008-05-25 \n</code></pre>\n\n<p>Desired Output:</p>\n\n<pre><code>EMP_ID| DEPT_ID | EMP_EFF_FROM_DATE | EMP_EFF_TO_DATE\n10 | 10001 | 2008-08-01 | 2011-05-01\n10 | 10001 | 2011-08-01 | 2012-10-31\n10 | 10003 | 2007-07-01 | 2007-10-31\n10 | 10004 | 2004-09-27 | 2007-06-29\n10 | 10007 | 2006-06-25 | 2007-06-20\n10 | 10007 | 2007-08-25 | 2007-06-29\n</code></pre>\n"},{"tags":["tsql","random","common-table-expression"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":53,"score":3,"question_id":12847336,"title":"How can I generate random formatted string in TSQL","body":"<p>Based on <a href=\"http://stackoverflow.com/users/73226/martin-smith\">Martin Smith's</a> answer <a href=\"http://stackoverflow.com/a/4558578/604648\">here</a>, I've been trying to use a very similar technique to creating 10000 random strings that start with two characters(A-Z), then two numbers(0-9) and then two characters(A-Z). Anybody know how to do this using the same technique or is it not possible, Thanks in advance\nPaul</p>\n"},{"tags":["tsql","cursors","sql-management-studio"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":296,"score":1,"question_id":6158200,"title":"Management Studio doesn't show results from cursor","body":"<p>Ok, this might be an easy one, but I can't find a solution.\nI'm beginning to work with cursors in T-SQL and am playing around with them.</p>\n\n<p>However I don't get my results back if I execute them in Management Studio via the Execute-Button. All I get is \"Command executed successfully\".</p>\n\n<p>If I debug it I get the results and the next time I click on execute I also get the results...</p>\n\n<p>Is there some kind of cache? Or am I doing it wrong?</p>\n\n<p>Script looks like this:</p>\n\n<pre><code>    declare @po varchar(20), @prod varchar(50), @qty integer, @type varchar(20)\n\n    declare db_cursor cursor for\n    select product, po, qty, space(1) as btype from header\n    for read only\n\n    open db_cursor\n\n    while @@FETCH_STATUS=0\n    begin\n      fetch db_cursor into @po, @prod, @qty, @type\n      if @qty&lt;1000\n    set @type = 'small'\n    else \n    set @type = 'large'\n       print @type\n    end\n\nclose db_cursor\ndeallocate db_cursor\n</code></pre>\n\n<p>PS: naturally I used select before print, same issue.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":74,"score":2,"question_id":12828465,"title":"String or binary data would be truncated. -- even though length shorter than field length","body":"<p>Trying to prefix a string field on a table by using the UPDATE command. For some reason I'm getting the </p>\n\n<blockquote>\n  <p>String or binary data would be truncated.</p>\n</blockquote>\n\n<p>exception, even though the length of my data would easily fit in the field.</p>\n\n<p>Using SQL Server 2008 R2 Standard Edition and SSMS 2008 R2.</p>\n\n<p><strike>Template: Learner is a nvarchar(60)</strike></p>\n\n<p><strong>Template: Learner is a nvarchar(30) using 60 bytes as shown in sp_help</strong></p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>select LEN('Aaaaaaaa' + LEFT(learner, 52)) myLen from Template order by myLen desc\n&gt;&gt;&gt; max len = 31\n\nupdate Template set learner = 'Aaaaaaaa' + LEFT(learner, 52)\n&gt;&gt;&gt; String or binary data would be truncated.\n\nupdate Template set learner = 'Aaaaaaaa' + LEFT(learner, 52)\n&gt;&gt;&gt; String or binary data would be truncated.\n\nupdate Template set learner = CAST('Aaaaaaaa' + LEFT(learner, 52) AS NVARCHAR(60))\n&gt;&gt;&gt; String or binary data would be truncated.\n</code></pre>\n\n<p>Whereas the following works:</p>\n\n<pre><code>SELECT CAST('Aaaaaaaa' + LEFT(learner, 52) AS NVARCHAR(60)) FROM Template\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12844138,"title":"T-Sql: How to write a SP that executes several similar insert statement?","body":"<p>I have this table called <strong>DevProject</strong> which keeps track of developers who are affected to a particular project.</p>\n\n<pre><code>ID           int PK\nDevID        int NOT NULL FK\nProjectID    int NOT NULL FK  \n</code></pre>\n\n<p>ID is the PK column for DevProject table. DevID and ProjectID are respectively PK in the Developers and Project tables. When A new project starts, a group of developers are affected to that project. Some of the developers might still be working on other projects. So, After the manager has decide whose going to work on a particular new project, the <strong>DevProject</strong> table should be populate with the ID of the new project and the ID of the developer. </p>\n\n<p>Thanks for helping.</p>\n"},{"tags":["sql-server","tsql","table","xml-schema"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":80,"score":0,"question_id":12846252,"title":"How to show table relationships in xml schema derived from tsql query?","body":"<p>I found this tsql query that shows the xml schema of a table and it works very well.</p>\n\n<pre><code>SELECT * FROM TableA\nFOR XML AUTO, XMLSCHEMA\n</code></pre>\n\n<p>I am now attempting to show the relationship between tables via this query.  I am not sure if this is possible.  I have mocked up several test tables and I have not had any luck.  Basically, I am creating a one to many relationship between tableA and tableB, then in the xml schema it would show tableA as a parent and tableB would be a child within the schema.</p>\n\n<p>This is what I have been running. :</p>\n\n<pre><code>SELECT * FROM TableA,\ndbo.TableB \nFOR XML AUTO, XMLSCHEMA\n</code></pre>\n\n<p>Here is an example xml schema file that I am getting from the above query. </p>\n\n<pre><code>&lt;xsd:schema targetNamespace=\"urn:schemas-microsoft-com:sql:SqlRowSet7\" xmlns:schema=\"urn:schemas-microsoft-com:sql:SqlRowSet7\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:sqltypes=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" elementFormDefault=\"qualified\"&gt;\n  &lt;xsd:import namespace=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes\" schemaLocation=\"http://schemas.microsoft.com/sqlserver/2004/sqltypes/sqltypes.xsd\" /&gt;\n  &lt;xsd:element name=\"TableA\"&gt;\n    &lt;xsd:complexType&gt;\n      &lt;xsd:sequence&gt;\n        &lt;xsd:element name=\"columnA\" type=\"sqltypes:int\" /&gt;\n        &lt;xsd:element name=\"columnB\"&gt;\n          &lt;xsd:simpleType&gt;\n            &lt;xsd:restriction base=\"sqltypes:varchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"BinarySort\"&gt;\n              &lt;xsd:maxLength value=\"50\" /&gt;\n            &lt;/xsd:restriction&gt;\n          &lt;/xsd:simpleType&gt;\n        &lt;/xsd:element&gt;\n        &lt;xsd:element ref=\"schema:dbo.tylersTestTable2\" minOccurs=\"0\" maxOccurs=\"unbounded\" /&gt;\n      &lt;/xsd:sequence&gt;\n    &lt;/xsd:complexType&gt;\n  &lt;/xsd:element&gt;\n  &lt;xsd:element name=\"TableB\"&gt;\n    &lt;xsd:complexType&gt;\n      &lt;xsd:sequence&gt;\n        &lt;xsd:element name=\"columnA\" type=\"sqltypes:int\" /&gt;\n        &lt;xsd:element name=\"columnB\"&gt;\n          &lt;xsd:simpleType&gt;\n            &lt;xsd:restriction base=\"sqltypes:varchar\" sqltypes:localeId=\"1033\" sqltypes:sqlCompareOptions=\"BinarySort\"&gt;\n              &lt;xsd:maxLength value=\"50\" /&gt;\n            &lt;/xsd:restriction&gt;\n          &lt;/xsd:simpleType&gt;\n        &lt;/xsd:element&gt;\n        &lt;xsd:element name=\"fkToTableA\" type=\"sqltypes:int\" /&gt;\n      &lt;/xsd:sequence&gt;\n    &lt;/xsd:complexType&gt;\n  &lt;/xsd:element&gt;\n&lt;/xsd:schema&gt;\n</code></pre>\n\n<p>As you can see it is displaying the tables as equal levels within the schema and not really displaying a parent child relationship.\nI am kind of at a loss here as I am no dba, but I have to do this for a ton of tables and I don't want to have to write them all by hand.</p>\n\n<p>Any ideas on this one?</p>\n"},{"tags":["c#","sql","tsql","sql-server-ce"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12763661,"title":"Reformatting of SQL Query, possible Pivot","body":"<p><img src=\"http://i.stack.imgur.com/ZvKl7.png\" alt=\"Query\"></p>\n\n<p>The image shows my query with two tables and the output.  Instead of the output being in the format in the image I need it as follows.</p>\n\n<pre><code>Date Time   |   Load Cell 0   |   Load Cell 1\n----------------------------------------------\n03/06/2016         12                14\n08/07/2016          4                7\n</code></pre>\n\n<p>I believe I may need to use a Pivot ????  but i am just stuck with how to do that.</p>\n\n<p>I am doing this in Visual Studio for a C# Windows Forms App and the data is to be shown in a datagrid and used for a graph/chart.  The db used is a MS SQL CE file.</p>\n\n<p>If anyone could help.  Thanks in advance.</p>\n"},{"tags":["sql","tsql","sql-server-2000"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":81,"score":2,"question_id":12808358,"title":"SQL Limit on \"WHERE X IN (...)\"","body":"<p>I've got some data I'd like to pull off our SQL server.</p>\n\n<p>This old database does not have any primary keys associated with it, so pulling data is like querying an Excel spreadsheet (what it actually originated as years ago).</p>\n\n<p>I need to run reports on this data, though.</p>\n\n<p>Currently, I get a list of distinct serial numbers for a given time period, then pull all of the records for a given serial number. For a 1-month time frame, this can be 1500 to 3000 serial numbers. The serial number field is formatted as <code>char(20)</code>, even though the serial numbers are only 15 characters long.</p>\n\n<p><strong>BEGIN UPDATE</strong></p>\n\n<ul>\n<li>There are typically 5 to 15 entries in this table per <code>Serial_Number</code>.</li>\n<li>There are at most 10 machines writing data to this table, so identical <code>Date_Time</code> values are possible</li>\n</ul>\n\n<p><strong>END UPDATE</strong></p>\n\n<p>This process takes a while, but between different serial numbers in the list, I am able to update the Windows Form with a Progress Bar so management knows something is happening and about how much longer to expect.</p>\n\n<p>I am always trying to make this query run faster.</p>\n\n<p>Now, I am thinking about pulling the data I need using a <code>WHERE</code> clause such as:</p>\n\n<pre><code>SELECT Col1, Col2, Col3\nFROM Table1\nWHERE Serial_Number IN (\n  SELECT DISTINCT Serial_Number\n  FROM Table1\n  WHERE Date_Time Between @startDate AND @endDate\n)\n</code></pre>\n\n<p>My question is: Are there any issues I could run into with this, particularly because we have so many distinct serial numbers during a given time frame.</p>\n\n<p>And, of course, you know someone in Management is going to try running a year's worth of data when they are bored! Then, they are going to try running data since Jesus was born, just because they've got nothing better to do.</p>\n\n<p><strong>Restate Question:</strong> Is there a limit to the <code>WHERE</code> clause's <code>IN</code> method that limits the number of items I can pass in?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2012","distinct-values"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":58,"score":2,"question_id":12844796,"title":"Ignore identical values in a specific column","body":"<p>I have this query that works as it should. However, I am having a problem with the query returning identical int values under the [id2] column. I need help in only grabbing one instance of the value and ignoring the other. Basically grab a unique [id2]. Any help would be greatly appreciated. Also, if you need clarification let me know.</p>\n\n<pre><code>SELECT [id],[id1]\n ,[id2]\n ,[name]\n ,[date]\n ,[user]     \nFROM [MyDatabase.table]\nWhere [date]&gt;= dateadd(day,datediff(day,0,getdate()),-5)\nORDER BY [cid]\n</code></pre>\n\n<p><strong>Edit 1:</strong></p>\n\n<pre><code>id1       id2    name        time                user\n6466    171477  item1 2012-10-10 07:08:48.000   user1\n6469    171477  item1 2012-10-10 07:11:01.000   user1\n6468    171477  item1 2012-10-10 07:10:37.000   user1\n6465    171477  item1 2012-10-10 07:07:43.000   user1\n6464    171477  item1 2012-10-10 07:06:58.000   user1\n6467    171477  item1 2012-10-10 07:09:35.000   user1\n6474    173026  item2 2012-10-10 10:20:21.000   user2\n6478    173297  item3 2012-10-10 11:31:55.000   user3\n6472    175445  item4 2012-10-10 07:18:17.000   user1\n6460    175977  item5 2012-10-08 07:42:39.000   user4\n6473    176253  item6 2012-10-10 10:18:21.000   user2\n6471    176253  item6 2012-10-10 10:15:03.000   user2\n6470    176253  item6 2012-10-10 10:14:34.000   user2\n</code></pre>\n\n<p>Should be:</p>\n\n<pre><code>id1     id2    name        time                user\n6466    171477  item1 2012-10-10 07:08:48.000   user1\n6474    173026  item2 2012-10-10 10:20:21.000   user2\n6478    173297  item3 2012-10-10 11:31:55.000   user3\n6472    175445  item4 2012-10-10 07:18:17.000   user1\n6460    175977  item5 2012-10-08 07:42:39.000   user4\n6473    176253  item6 2012-10-10 10:18:21.000   user2\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","correlated-subquery"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":55,"score":4,"question_id":12845281,"title":"SQL Delete clears the table instead of erroring","body":"<p>I have a piece of SQL which (you would think) wouldn't compile, but which instead deletes all rows from the target table.</p>\n\n<p>Consider this setup:</p>\n\n<pre><code>create table TableA (ColumnA varchar(200));\ncreate table TableB (ColumnB varchar(200));\n\ninsert TableA values ('A'),('B'),('C');\ninsert TableB values ('A');\n</code></pre>\n\n<p>Then the following sql:</p>\n\n<pre><code>--Returns all rows from TableA\nselect * from TableA;\n\n--Does not error (ColumnA does not exist on TableB)\ndelete TableA where ColumnA in (select ColumnA from TableB)\n\n--No Rows are returned\nselect * from TableA;\n</code></pre>\n\n<p>The delete statement above causes all rows to be removed from <code>TableA</code>, rather than erroring that <code>ColumnA</code> doesn't exist in <code>TableB</code></p>\n\n<p>There's a SQL Fiddle demontrating this here: <a href=\"http://www.sqlfiddle.com/#!3/9d883/6\" rel=\"nofollow\">http://www.sqlfiddle.com/#!3/9d883/6</a></p>\n\n<p>It seems that the <code>ColumnA</code> from <code>TableA</code> is being picked up, but expected it to be \"out of scope\". </p>\n\n<p>Why is this?</p>\n"},{"tags":["sql","xml","tsql","timestamp"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":1048,"score":0,"question_id":4736194,"title":"sp_xml_preparedocument go with error \"Only one top level element is allowed in an XML document\"","body":"<p>I'am trying to execute sp_xml_preparedocument and geting error \"Only one top level element is allowed in an XML document\"</p>\n\n<p>my T-SQL commands:</p>\n\n<pre><code>DECLARE @aa XML\nDECLARE @idoc int\nSET @aa =(select * from db_name for xml auto, xmldata) \n</code></pre>\n\n<hr>\n\n<p>@aa now is</p>\n\n<pre><code>&lt;Schema xmlns=\"urn:schemas-microsoft-com:xml-data\" xmlns:dt=\"urn:schemas-microsoft-com:datatypes\" name=\"Schema7\"&gt;\n&lt;ElementType name=\"Person\" content=\"empty\" model=\"closed\"&gt;\n  &lt;AttributeType name=\"preson_id\" dt:type=\"i4\" /&gt;\n  &lt;AttributeType name=\"Name\" dt:type=\"string\" /&gt;\n  &lt;AttributeType name=\"Surname\" dt:type=\"string\" /&gt;\n  &lt;AttributeType name=\"guid\" dt:type=\"uuid\" /&gt;\n  &lt;AttributeType name=\"version\" dt:type=\"bin.base64\" /&gt;\n  &lt;attribute type=\"preson_id\" /&gt;\n  &lt;attribute type=\"Name\" /&gt;\n  &lt;attribute type=\"Surname\" /&gt;\n  &lt;attribute type=\"guid\" /&gt;\n  &lt;attribute type=\"version\" /&gt;\n &lt;/ElementType&gt;\n&lt;/Schema&gt;\n  &lt;Person xmlns=\"x-schema:#Schema7\" preson_id=\"1\" Name=\"\" Surname=\"\" guid=\"2E739E87-3CA4-4ED8-ADD0-8B59957668B8\" version=\"AAAAAAAAB9E=\" /&gt;\n  &lt;Person xmlns=\"x-schema:#Schema7\" preson_id=\"2\" Name=\"\" Surname=\"\" guid=\"BDC41C59-D70F-4B70-954E-4918B9516AF8\" version=\"AAAAAAAAB9I=\" /&gt;\n  &lt;Person xmlns=\"x-schema:#Schema7\" preson_id=\"3\" Name=\"\" Surname=\"\" guid=\"740E57F3-56BA-48B8-92AF-978D7B1D2712\" version=\"AAAAAAAAB9M=\" /&gt;\n</code></pre>\n\n<hr>\n\n<pre><code>EXEC sp_xml_preparedocument @idoc OUTPUT, @aa\n</code></pre>\n\n<hr>\n\n<pre><code>The XML parse error 0xc00ce555 occurred on line number 1, near the XML text \"\"\nMsg 6602, Level 16, State 2, Procedure sp_xml_preparedocument, Line 1\nThe error description is 'Only one top level element is allowed in an XML document\n</code></pre>\n\n<hr>\n\n<p>I'am new in this, and i need help)))\nAn one more question - How parse timestamp type?</p>\n\n<p>if i use </p>\n\n<pre><code>SET @aa =(select * from db_name for xml elements, root('root'), type) \n</code></pre>\n\n<p>sp_xml_preparedocument works fine, OPENXML returns all values of my db_table, but timestamp values looks not the same as were..</p>\n\n<p>Sorry for my bad English </p>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":140,"score":0,"question_id":11884939,"title":"Multiple row fetch with a cursor in T-SQL on Sybase","body":"<p>I am trying to fetch blocks of rows from my Sybase DB (ie. fetch 100 rows at a time per transaction).</p>\n\n<p>However, I have read <a href=\"http://msdn.microsoft.com/en-us/library/aa172595%28v=sql.80%29.aspx\" rel=\"nofollow\">here</a> and <a href=\"http://msdn.microsoft.com/en-us/library/ms187881%28v=sql.105%29.aspx\" rel=\"nofollow\">here</a> that T-SQL simply does not support this.</p>\n\n<p>Is there any work around for this?</p>\n\n<p>Also, if it is possible to fetch multiple rows at a time, how could I modify the following code to do so:</p>\n\n<pre><code>DECLARE my_cursor CURSOR FOR\n    SELECT\n        COL1,\n        COL2,\n        ...\n        COLN\n    FROM\n        MY_DB\n    WHERE\n        SOME_CONDITION_SATISFIED\nGO\n\nDECLARE\n  VAR1 TYPE,\n  VAR2 TYPE,\n  ...\n  VARN TYPE\n\n    SET NO COUNT ON\n\n    OPEN my_cursor\n    WHILE @@SQLSTATUS = 0\n    BEGIN\n        FETCH my_cursor into\n            @VAR1,\n            @VAR2,\n            ...\n            @VARN\n    END\n\nCLOSE my_cursor\nDEALLOCATE CURSOR my_cursor\n</code></pre>\n\n<p>Any help would be appreciated.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":8,"favorite_count":3,"up_vote_count":17,"down_vote_count":0,"view_count":5526,"score":17,"question_id":233919,"title":"INSERT vs INSERT INTO","body":"<p>I have been working with T-SQL in MS SQL for some time now and somehow whenever I have to insert data into a table I tend to use syntax:</p>\n\n<pre><code>INSERT INTO myTable &lt;something here&gt;\n</code></pre>\n\n<p>I understand that keyword <code>INTO</code> is optional here and I do not have to use it but somehow it grew into habit in my case.</p>\n\n<p>My question is: </p>\n\n<ul>\n<li>Are there any implications of using <code>INSERT</code> syntax versus <code>INSERT INTO</code>?</li>\n<li>Which one complies fully with the standard?</li>\n<li>Are they both valid in other implementations of SQL standard?</li>\n</ul>\n"},{"tags":["asp.net","sql","sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":71,"score":0,"question_id":12843728,"title":"How to check for return value from stored procedure","body":"<p>I have a stored procedure that returns a list of numbers in the case that the input id matches the table id. My question is, how do I check to see if the result being returned from the stored procedure isn't null? I just need to know if the returned value is 0(failed) or if the returned values are the numbers. Since I have a boolean variable that I want to set if there is valid data returned(not 0).</p>\n\n<p>Here is my stored procedure:</p>\n\n<pre><code>      @InvestigatorID int\nas\nselect DeleteTasks\nfrom InvestigatorPermissionsTasks\nwhere InvestigatorID = @InvestigatorID\n</code></pre>\n\n<p>Valid data returned looks like \ncolumn name \"exhibitID\" value \"123\"/   column name \"number\" value \"1-2-3-2\"</p>\n"},{"tags":["tsql","visual-studio-2008","reporting-services","aggregate-functions"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12823506,"title":"Aggregates in Visual Studio Reports not showing","body":"<p>I'm trying to create a report that UNIONs two datasets. It takes (1) a bunch of orders for a specific customer within a date range, and UNIONs it with (headers and) (2) the method of shipping following by the average of the time interval between the order being placed and the order being sent.</p>\n\n<p>The screenshot below shows that, in SQL Server, the query works perfectly. However, when I run this exact same query in Visual Studio 2008 to create a report for this, the actual value of the average turnaround time<img src=\"http://i.stack.imgur.com/0TjSR.png\" alt=\"enter image description here\"> is empty.</p>\n\n<p>As far as I can tell, in SQL Server the query works perfectly for whatever parameters I give it. I just can't figure out why in the report the average turnaround time is always blank.</p>\n\n<p>The query I'm running is:</p>\n\n<pre><code>DECLARE @turnaroundInfo TABLE\n(\n    [Owner Reference] VARCHAR(48),\n    [Project] VARCHAR(48),\n    [Carrier Type] VARCHAR(48),\n    [Created Date] DATETIME,\n    [Shipped Date] DATETIME,\n    [Turnaround Time (hours)] INT\n)\nINSERT INTO @turnaroundInfo\nSELECT orders.ownerReference AS [Owner Reference], p.name AS [Project], types.name AS [Carrier Type], orders.createdSysDateTime AS [Created Date], shipments.shippedDate AS [Shipped Date],  DATEDIFF(HOUR,             orders.createdSysDateTime, shipments.shippedDate) AS [Turnaround Time (hours)]\nFROM datex_footprint.Orders orders\n    INNER JOIN datex_footprint.Projects p ON orders.projectId = p.id\n    INNER JOIN datex_footprint.CarrierServiceTypes types ON orders.preferredCarrierServiceTypeId = types.id\n    INNER JOIN datex_footprint.OrderLines lines ON orders.id = lines.orderId\n    INNER JOIN datex_footprint.Shipments shipments ON lines.shipmentId = shipments.id\nWHERE p.name IN (@project)  AND types.name IN(@carrier)\n\n-- Get only the type and date-ranged turnaround info we want\nDECLARE @orders TABLE\n(\n    [Owner Reference] VARCHAR(48),\n    [Project] VARCHAR(48),\n    [Carrier Type] VARCHAR(48),\n    [Created Date] DATETIME,\n    [Shipped Date] DATETIME,\n    [Turnaround Time (hours)] INT\n)\nINSERT INTO @orders\nSELECT  *\nFROM @turnaroundInfo\nWHERE [Turnaround Time (hours)] &gt;= 0 AND [Created Date] BETWEEN @startDate AND @endDate\nORDER BY [Turnaround Time (hours)], [Carrier Type] ;\n\n\n-- UNION the relevant turnaround infor with headers\nSELECT * FROM @orders o /*  All the orders in the date range for this project and the selected carrier(s) */\nUNION ALL\nSELECT 'Carrier' AS [Carrier Type], 'Avg Turnaround Time' AS [Average Turnaround], NULL AS Column3, NULL AS Column4, NULL AS Colummn5, NULL AS Column6\nUNION ALL\nSELECT o.[Carrier Type], CAST(AVG(o.[Turnaround Time (hours)]) AS NVARCHAR(24)) AS [Average Turnaround], NULL AS Column3, NULL AS Column4, NULL AS Colummn5, NULL AS Column6\nFROM @orders o\nGROUP BY o.[Carrier Type];\n</code></pre>\n\n<p>Does anybody know or see what I might be missing?\nAny help would be appreciated!</p>\n"},{"tags":["tsql","sybase"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":12842465,"title":"Return rows from RIGHT JOIN that do not have matches","body":"<p>In a simple <code>RIGHT JOIN</code> statement:</p>\n\n<pre><code>select *\nfrom SRC_TABLE\nright join DEST_TABLE\non SRC_TABLE.COL = DEST_TABLE.COL\n</code></pre>\n\n<p>How do I only return rows from the DEST_TABLE that DID NOT have a match from the <code>RIGHT JOIN</code> clause?</p>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":124,"score":1,"question_id":12837628,"title":"SQL Query to pull n rows and turn them to columns","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/3924641/poor-mans-sql-pivot-list-questions-as-columns-and-answers-per-user-in-one-row\">Poor Mans SQL Pivot. List Questions as Columns and Answers per User in one row</a>  </p>\n</blockquote>\n\n\n\n<p>I have the following query to first pull 12 records for each of my foreign keys(null values in the case of missing records), and then turn all 12 records per foreign key into a column. The code below however, generates the 12 rows but fails to turn all the rows into columns. Instead it does the transform for just one of my foreign key IDS and then stops.  </p>\n\n<p>Please help me pivot this properly so that for each ProductID, I get a row.  Thanks in advance.</p>\n\n<pre><code>  DECLARE @colsUnpivot AS NVARCHAR(MAX),\n    @query  AS NVARCHAR(MAX),\n    @colsPivot as  NVARCHAR(MAX)\n\n    --BEGIN TRY\n           IF EXISTS\n                (\n                            SELECT *\n                            FROM tempdb.dbo.sysobjects\n                            WHERE ID = OBJECT_ID(N'tempdb..#ManufacturerAttributes')\n                )\n                BEGIN\n                            DROP TABLE #ManufacturerAttributes\n                END\n    Create table #ManufacturerAttributes\n    ( \n            ProductID uniqueIdentifier,\n             PAID uniqueidentifier,\n            MfgAttrLabel varchar(50),\n            MfgAttrVal varchar(3072),\n            MfgAttrUOM varchar(50), \n            rowindex int\n    )\n    ;With Number\nAs\n(\n Select 1 as rownum union all  Select 2 union all Select 3 union all Select 4 union all Select 5 union all Select 6 union all Select 7 union all Select 8 union all Select 9 union all Select 10 union all Select 11 union all Select 12   \n),\nProductDetail \nas \n(\n   select P.ProdID, N.rownum from IDWProduct P cross join Number N\n)\nInsert into #ManufacturerAttributes\nSelect  ProdID  , PAVAttributeID,PANAme, PAVValue, UOMLabel, P.rownum\n from ProductDetail P\nLeft join (select Pr.*, row_number() over (partition by PAVProductID order by PAVID) as Rn from IDWProductAttributeValues Pr ) Pr ON rownum = Pr.Rn And PAVProductID = ProdID  \nleft join IDWUnitofMeasures on Pr.PAVUOM = UOMID \nleft join IDWAttributes  A on Pr.PAVAttributeID = A.PAID  AND A.PAIsManufacturerSpecific = 1\n\n Select * from #ManufacturerAttributes\n\n  select @colsUnpivot = stuff((select ','+quotename(C.name)\n         from tempdb.sys.columns as C\n         where C.object_id = object_id('tempdb..#ManufacturerAttributes')  \n         for xml path('')), 1, 1, '')\n\n-- select @colsUnpivot\n\n select @colsPivot = STUFF((SELECT  ','  + quotename(c.name   + cast(t.rn as varchar(10)))\n                    from\n                    (\n                      select row_number() over(partition by ProductID   order by ProductID) rn  from #ManufacturerAttributes\n                    ) t\n                     cross apply \n                      tempdb.sys.columns  as C\n                   where C.object_id = object_id('tempdb..#ManufacturerAttributes')   \n                   group by c.name, t.rn\n                   order by t.rn\n            FOR XML PATH(''), TYPE\n            ).value('.', 'NVARCHAR(MAX)') \n        ,1,1,'')\n\n --select @colsPivot\n   set @query \n  ='select *\n      from\n      (\n        select ProductID, PAID, RowIndex,\n            col + cast(rn as varchar(10)) new_col,\n            val \n         from \n        (\n          select  \n          Cast (ProductID as NVarchar(3072)) ProductID\n          ,Cast(PAID as NVarchar(3072)) PAID\n           ,Cast (MfgAttrLabel  as NVarchar(3072)) MfgAttrLabel\n           ,Cast (MfgAttrVal as NVarchar(3072)) MfgAttrVal\n           ,Cast (MfgAttrUOM as NVarchar(3072))  MfgAttrUOM  \n           ,Cast(rowindex as NVarchar(3072)) rowindex\n            ,row_number() over(partition by ProductID order by ProductID) rn\n          from  #ManufacturerAttributes\n\n        ) x\n        unpivot\n        (\n          val\n          for col in ('+ @colsunpivot +')\n        ) u\n      ) x1\n      pivot\n      (\n        max(val)\n        for new_col in\n          ('+ @colspivot +')\n      ) p'\n\n\n    --  Print @query\n\nexec(@query)    \n</code></pre>\n\n<p><strong><a href=\"http://sqlfiddle.com/#!3/10876/1\" rel=\"nofollow\">SQLFiddle complete with Script</a></strong>  </p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12842052,"title":"sp_send_dbmail error","body":"<p>How can i pass multiple query in a <code>@query parameter</code> in <code>sp_send_dbmail</code>?</p>\n\n<p>For example:</p>\n\n<pre><code>select count(*) from TableA\nIF count(*)/ @@rowcount = 0  \nExec sp_send_dbmail @profile_name = xx, @recipients = 'xx@abc.com',@subject = 'Test', @body= ' No rows';\nIF count(*)/ @@rowcount &gt; 0\nExec sp_send_dbmail @profile_name = xx, @recipients = 'xx@abc.com',@subject = 'Test', \n@body= ' xx rows';\n</code></pre>\n\n<p>I am not getting any error message, but it stops after the first select statement.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":68,"score":4,"question_id":12841331,"title":"TSQL CHECKSUM conundrum","body":"<pre><code>SELECT BINARY_CHECKSUM('Clifton House, Thornaby Place, Teesdale South, Stockton-On-Tees, Cleveland, TS17 6SD')\nSELECT BINARY_CHECKSUM('Clifton House, Teesdale South, Thornaby Place, Stockton-On-Tees, Cleveland, TS17 6SD')\n\nSELECT BINARY_CHECKSUM('Glenfield Hospital, Groby Road, , Leicester, Leicestershire, LE3 9DZ')\nSELECT BINARY_CHECKSUM('Glenfield Hospital, Groby Road, , Leicester, Leicestershire, LE3 9EJ')\n</code></pre>\n\n<p>Have a look at the above. The 2 pairs of addresses will generate the same checksum value even though there are differences in the text.  It is my understanding that, whilst you cannot guarantee that CHECKSUM and BINARY_CHECKSUM will be different for any random content that they should be good for determining relatively small changes in a given row.</p>\n\n<p>Interestingly these pairs of values demonstrate precisely the opposite. They are generating equal checksum values for very similar data values. These are in fact the only duplicate checksum values in a largish (680,000 record) table of addresses.</p>\n\n<p>I am a little concerned that I have misunderstood the value of checksum in generating UPDATEs? Do I have to resort to a brute force field by field comparison to be absolutely certain of picking up a change in a row of data?</p>\n\n<p>The original data for these examples was in 6 separate columns. I have reduced the code sample to a minimal state for clarity.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":2,"up_vote_count":10,"down_vote_count":0,"view_count":9089,"score":10,"question_id":5924777,"title":"How to get last day of last week in sql?","body":"<p>How to get last date of the lastweek in sql? I mean last sunday date using query? </p>\n"},{"tags":["sql-server-2008","tsql","query-hints"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12826949,"title":"Combine Table Hints INDEX and FORCESEEK with Two Joins Not On PK","body":"<p>See first query below.<br>\nCan NOT combine table hint Index and forceseek with two joins and the joins are not on the PK.<br>\nHow to make the first query compile?</p>\n\n<p>Interesting<br>\n-  if just one join or the other then can combine index and forceseek hints<br>\n-  if the index is the PK then can combine 2 joins and have both hints </p>\n\n<pre><code>-- compiler fails \n-- Query processor could not produce a query plan because of the hints defined in this query. Resubmit the query without specifying any hints and without using SET FORCEPLAN.  \nSelect Count(Distinct([docSVsys].[sID])) \nFrom [docSVsys] with (nolock) \nLeft Join [docSVtext] with (nolock, Index(IX_docSVtext_value_sID), forceseek ) \n       On [docSVtext].[sID] = [docSVsys].[sID]\nLeft Join [docMVtext] with (nolock, Index(ix_docMVtext_value_sID), forceseek) \n       On [docMVtext].[sID] = [docSVsys].[sID]\nwhere [docSVtext].[value] = 'doug'  or\n      [docMVtext].[value] = 'doug' \n\n--  can do one join\nSelect Count(Distinct([docSVsys].[sID])) \nFrom [docSVsys] with (nolock) \nLeft Join [docSVtext] with (nolock, Index(IX_docSVtext_value_sID), forceseek ) \n       On [docSVtext].[sID] = [docSVsys].[sID]\nwhere [docSVtext].[value] = 'doug'\n\n--  can do the other join\nSelect Count(Distinct([docSVsys].[sID])) \nFrom [docSVsys] with (nolock) \nLeft Join [docSVtext] with (nolock, Index(IX_docSVtext_value_sID), forceseek ) \n       On [docSVtext].[sID] = [docSVsys].[sID]\nwhere [docSVtext].[value] = 'doug'\n\n\n-- if on the PK then can do forceseek on two join   \nSelect Count(Distinct([docSVsys].[sID])) \nFrom [docSVsys] with (nolock, INDEX(PK_docSVsys)) \nLeft Join [docSVtext] with (nolock, Index(PK_docSVtext), forceseek ) \n    On [docSVtext].[sID] = [docSVsys].[sID]\nLeft Join [docMVtext]  with (nolock, Index(PK_docMVtext), forceseek) \n    On [docMVtext].[sID] = [docSVsys].[sID]\nwhere [docSVtext].[value] = 'doug'\n   or [docMVtext].[value] = 'doug'\n</code></pre>\n\n<p>This does what I want and runs 100 times faster.<br>\nThis has almost an identical query plan to the answer from ypercube.<br>\nBut I cannot combine this with some other conditions I need. </p>\n\n<pre><code>Select count(distinct([docSVsys].[sID]))\nFrom [docSVsys] with (nolock) \nLEFT HASH JOIN [docSVtext] with (nolock) \n  on [docSVtext].[sID] = [docSVsys].[sID] \n and [docSVtext].[value] = 'doug'\nLEFT HASH JOIN [docMVtext] with (nolock)\n  on [docMVtext].[sID] = [docSVsys].[sID] \n and [docMVtext].[value] = 'doug'\nwhere [docSVtext].[sID] is not null \n   or [docMVtext].[sID] is not null \n</code></pre>\n\n<p>This also uses the proper indexes and is the fastest.<br>\nFor now I don't have the option to rewrite the format.<br>\nThe program builds up queries to other tables.<br>\nWe incorrectly wanted the same format for where as an order by and that got us where we are.  </p>\n\n<pre><code>SELECT  count(distinct(c.sID))  \nfrom                \n(   SELECT sv.[sID] \n    FROM [docSVtext] AS sv\n    WHERE sv.[value] = 'doug'\n    UNION ALL \n    SELECT mv.[sID] \n    FROM [docMVtext] AS mv\n    WHERE mv.[value] = 'doug'\n) as c\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","table-valued-parameters"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":89,"score":-1,"question_id":12427121,"title":"Need help optimizing TSQL table valued function","body":"<p>Here is the function:</p>\n\n<pre><code>CREATE FUNCTION dbo.agedItemResult(@ILC VARCHAR(30))\n    RETURNS @AgedTable TABLE (\nItemID INT,\nItemLookupCode VARCHAR(30),\n[Month] INT,\n[Year] INT,\nAged INT,\nDebug01 VARCHAR(MAX),\nDebug02 VARCHAR(MAX),\nDebug03 VARCHAR(MAX),\nDebug04 VARCHAR(MAX),\nDebug05 VARCHAR(MAX)\n) \nAS\nBEGIN\n\nDECLARE @TotalSold INT\nDECLARE @AdjustmentQty INT\nDECLARE @FirstRcvdStart DATETIME\nDECLARE @FirstRcvdEnd DATETIME\n--DECLARE @ILC VARCHAR(MAX)\n--DECLARE @ItemID INT\nDECLARE @MovingQty INT\nDECLARE @MovingMonthStart DATETIME\nDECLARE @MovingMonthEnd DATETIME\nDECLARE @CurrentMonthStart DATETIME\nDECLARE @CurrentMonthEnd DATETIME\nDECLARE @CurrentRcvd INT\nDECLARE @NumMonths INT\nDECLARE @AgeReached INT\n/*DECLARE @AgedTable TABLE (    ItemID INT,\n                            ItemLookupCode VARCHAR(MAX),\n                            [Month] INT,\n                            [Year] INT,\n                            Aged INT,\n                            Debug01 VARCHAR(MAX),\n                            Debug02 VARCHAR(MAX),\n                            Debug03 VARCHAR(MAX),\n                            Debug04 VARCHAR(MAX),\n                            Debug05 VARCHAR(MAX)\n                            )*/\n\n--SET @ILC = '21208641'\nSET @TotalSold          = (SELECT SUM(Sold) FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC)\nSET @AdjustmentQty      = (SELECT SUM(HQAdjustment) FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC)\nSET @FirstRcvdStart     = (SELECT TOP 1 FirstTransferred FROM JSInventorySnapShot ORDER BY FirstTransferred ASC)\nSET @FirstRcvdEnd       = (SELECT DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, @FirstRcvdStart)+1,0)))\nSET @CurrentMonthStart  = (SELECT DATEADD(s,0,DATEADD(mm, DATEDIFF(m,0, GETDATE()),0))) \nSET @CurrentMonthEnd    = (SELECT DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, GETDATE())+1,0))) \nSET @NumMonths          = (SELECT CASE \n                            WHEN DATEPART(DAY, @FirstRcvdStart) &gt; DATEPART(DAY, @CurrentMonthEnd) \n                                THEN DATEDIFF(MONTH, @FirstRcvdStart, @CurrentMonthEnd) - 1 \n                                ELSE DATEDIFF(MONTH, @FirstRcvdStart, @CurrentMonthEnd) \n                            END) + 1\nSET @MovingQty          = @TotalSold\nSET @CurrentRcvd        = ISNULL((SELECT SUM(Rcvd) FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC AND [Month] = Month(@FirstRcvdStart)), 0) + @AdjustmentQty\nSET @MovingMonthStart   = @FirstRcvdStart\nSET @MovingMonthEnd     = @FirstRcvdEnd\nSET @MovingQty          = @MovingQty - @CurrentRcvd\nSET @AgeReached         = 0\n\nWHILE(@NumMonths &gt; 0)\nBEGIN\n    IF (@CurrentRcvd = 0)\n    BEGIN\n        INSERT INTO @AgedTable (ItemID, ItemLookupCode, [Month], [Year], Aged, Debug01) \n            SELECT (SELECT TOP 1 ItemID FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC),\n                        @ILC, \n                        MONTH(@MovingMonthStart),\n                        YEAR(@MovingMonthStart),\n                        0,\n                        @AdjustmentQty\n    END\n    ELSE\n    BEGIN\n        IF(@MovingQty &gt; 0)\n        BEGIN\n            INSERT INTO @AgedTable (ItemID, ItemLookupCode, [Month], [Year], Aged, Debug01) \n                SELECT (SELECT TOP 1 ItemID FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC),\n                            @ILC, \n                            MONTH(@MovingMonthStart),\n                            YEAR(@MovingMonthStart),\n                            0,\n                            @AdjustmentQty\n        END\n        ELSE\n        BEGIN\n            IF (@AgeReached = 1)\n            BEGIN\n                INSERT INTO @AgedTable (ItemID, ItemLookupCode, [Month], [Year], Aged) \n                    SELECT (SELECT TOP 1 ItemID FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC),\n                                @ILC, \n                                MONTH(@MovingMonthStart),\n                                YEAR(@MovingMonthStart),\n                                @CurrentRcvd\n            END\n            ELSE\n            BEGIN\n                INSERT INTO @AgedTable (ItemID, ItemLookupCode, [Month], [Year], Aged) \n                    SELECT (SELECT TOP 1 ItemID FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC),\n                                @ILC, \n                                MONTH(@MovingMonthStart),\n                                YEAR(@MovingMonthStart),\n                                (-1 * @MovingQty)\n                    SET @AgeReached = 1\n            END\n        END\n    END\n    SET @NumMonths          = @NumMonths - 1\n    SET @MovingMonthStart   = (SELECT DATEADD(s,0,DATEADD(mm, DATEDIFF(m,0, @MovingMonthStart)+1,0))) \n    SET @MovingMonthEnd     = (SELECT DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0, @MovingMonthEnd)+2,0)))\n    SET @CurrentRcvd        = ISNULL((SELECT SUM(Rcvd) FROM JSInventorySnapShot WHERE ItemLookupCode = @ILC AND [Month] = Month(@MovingMonthStart)), 0)\n    SET @MovingQty          = @MovingQty - @CurrentRcvd\n    END\n    RETURN\nEND\n</code></pre>\n\n<p>Here's what it does in a nutshell:</p>\n\n<p>First we find the first item ever received or moved and use the date as the starting date. Then we find the total sales for the that item, and begin subtracting the receiving amount from sales. The remainder is considered aged (not sold) and is evaluated against the next month. We then move to the next month and repeat the process until we hit a negative number or 0. If we hit a negative number then that means we have hit a month that we ordered more than sold to date, and that amount is considered aged (not sold). If there are more months to evaluate then any FURTHER received amount is considered aged by default as it clearly as not been sold.</p>\n\n<p>Here is sample data from the table used for evaluation: </p>\n\n<pre><code>ID      ItemID  ItemLookupCode  HQAdjustment    FirstTransferred        Rcvd    RcvdDateEarly           RcvdDateLate            Sold    SoldDateEarly           SoldDateLate            Sales   Month   Year    StartOfMonthQty EndOfMonthQty\n17350   188993  21208641        0               2012-04-05 13:29:14.000 48      2012-04-27 11:00:40.100 2012-04-27 11:00:40.100 40      2012-04-05 13:29:14.000 2012-04-30 12:50:13.000 75.20   4       2012    0               8\n34427   188993  21208641        0               2012-04-05 13:29:14.000 120     2012-05-22 10:14:40.213 2012-05-22 10:14:40.213 24      2012-05-04 17:42:12.000 2012-05-29 10:22:10.000 44.72   5       2012    8               104\n48437   188993  21208641        0               2012-04-05 13:29:14.000 0       NULL                    NULL                    12      2012-06-02 16:24:45.000 2012-06-21 11:15:05.000 22.36   6       2012    104             92\n62369   188993  21208641        0               2012-04-05 13:29:14.000 60      2012-07-16 12:57:33.330 2012-07-16 12:57:33.330 9       2012-07-11 14:42:01.000 2012-07-25 14:58:41.000 16.22   7       2012    92              143\n75781   188993  21208641        0               2012-04-05 13:29:14.000 0       NULL                    NULL                    2       2012-08-01 12:56:10.000 2012-08-14 19:01:00.000 4.01    8       2012    143             141\n</code></pre>\n\n<p>Here is the result of my function for the above data:</p>\n\n<pre><code>ItemLookupCode  Month   Rcvd    Sold    Aged\n21208641        4       48      40      0\n21208641        5       120     24      81\n21208641        6       0       12      0\n21208641        7       60      9       60\n21208641        8       0       2       0\n</code></pre>\n\n<p>This tells me that we sold everything received in April. Ordered again in May, sold some but still have left over inventory (aged). Then without selling the inventory out in July we ordered more again, and therefore that inventory is automatically considered to be aged.</p>\n\n<p>The purpose of this function is stop what happened above. Which is ordering items that have aged (unsold) inventory. It's also used for evaluating how much of a department is aged and if we should consider starting a sale to get rid of aged items.</p>\n\n<p>The problem is that we have no less then 40,000 items to evaluate. This function works great for single items, however it takes 30 seconds for 100 items. I'm hoping someone can come a long and look at my function and realize I'm going about it the completely wrong way. If I could accomplish inline calculations and carry over the remainder that would be great.</p>\n\n<p>I basically need this in simplified pseudo-code:</p>\n\n<pre><code>Foreach (Month2Date)\nIf AllInventoryAged = 1 Then //This says we've reached our sales:rcved thresh-hold and all received inventory is aged from here on out.\n   ThisMonthAged = RcvedForMonth\nElse\n   TotalSales - RcvedForMonth = Aged\n    If Aged &lt; 0 Then\n        ThisMonthAged = Aged * -1 //We received more than sold so it's negative and we have hit our sales:rcved thresh-hold.\n        AllInventoryAged = 1 //Anything received from this point on is aged.\n    Else    \n        ThisMonthAged = 0  //We received less this month then sold. A good thing.\n        TotalSales = Aged //We carry on the remainder for further evaluation\n</code></pre>\n\n<p>I hope I have been thorough in explaining myself this time. Sorry it's so long. I just really wanted to cover all questions I had in my last post.</p>\n"},{"tags":["sql-server","tsql","triggers","null","sql-server-2008-r2"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12696167,"title":"Handling nulls in an audit/history update trigger","body":"<p>Say I have two tables, a \"live\" table and a history table.  The live table looks like this:</p>\n\n<pre><code>CREATE TABLE dbo.LiveTable (\n    LiveTableId INT IDENTITY(1,1) NOT NULL PRIMARY KEY,\n    SomeVarChar VARCHAR(20) NOT NULL DEFAULT '',\n    SomeForeignId INT NULL,\n    OtherForeingId INT NULL,\n    ChangeBy VARCHAR(128) NOT NULL,\n    ChangeTime DATETIME NOT NULL DEFAULT GETDATE()\n)\n</code></pre>\n\n<p>The history table looks the same, except it has its own primary key and an <code>IsDelete</code> column used elsewhere.  When a user updates a row in <code>LiveTable</code>, I want to log the row's prior values in the history table.  This is simple enough with an <code>UPDATE</code> trigger, of course.  But I've just determined that some of my updates aren't firing the history table insert, and I believe this is due to fields that allow nulls.  My trigger looks something like this:</p>\n\n<pre><code>CREATE TRIGGER dbo.trgLiveTableUpdate ON dbo.LiveTable FOR UPDATE\nAS\nINSERT INTO dbo.LiveTableHistory (\n    LiveTableId,\n    SomeVarChar,\n    SomeForeignId,\n    OtherForeignId,\n    ChangeBy,\n    ChangeTime\n)\nSELECT \n    d.LiveTableId,\n    d.SomeVarChar,\n    d.SomeForeignId,\n    d.OtherForeignId,\n    d.ChangeBy,\n    d.ChangeTime\nFROM DELETED d\nJOIN INSERTED i ON d.LiveTableId = i.LiveTableId\nWHERE d.SomeVarChar &lt;&gt; i.SomeVarChar\nOR d.SomeForeignId &lt;&gt; i.SomeForeignId   //&lt;--- I don't think this works\nOR d.OtherForeignId &lt;&gt; i.OtherForeignId //&lt;--- this either\n</code></pre>\n\n<p>Is it possible that my <code>WHERE</code> condition isn't hitting on situations where the change is to <code>SomeForeignId</code> or <code>OtherForeignId</code> because those columns both allow nulls?  If so, how would I write a condition that would take nulls into account when checking those columns for inequality?</p>\n"},{"tags":["sql-server","tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12838334,"title":"Need help to optimize this query","body":"<p>Can you help me to optimize this query of mine? I've ran out of ways to optimize this. The data retrieval time here is 6 mins and I want to lessen it. Hope you can help me.</p>\n\n<pre><code>-- Main query\nDECLARE @ProdClass VARCHAR(10)\n,@ModelID VARCHAR(10)\n,@ServiceStartDate DATETIME\n,@ServiceEndDate DATETIME\n,@SvcID VARCHAR(10)\n,@StateID VARCHAR(10)\n,@AreaID VARCHAR(10)\n\n SET @ProdClass = 'WPS'\n SET @ModelID = 'BM'\n SET @ServiceStartDate = convert(datetime, '10/1/2007')\n SET @ServiceEndDate = CONVERT(DATETIME, '11/1/2007')\n SET @SvcID = '358'\n SET @StateID = 'JB'\n SET @AreaID = ''\n\nSELECT DISTINCT cus.MCUS_CUSID\n    ,cus.MCUS_ENAME\n    ,mod.MMOD_ENAME\n    ,rou.MROU_SERNO\n    ,svc.MSVC_SVCID AS SVC_NAME\n    ,ar.MARE_ENAME\n    ,dbo.ufn_GetLastXApptDate(rou.MROU_ROUID) AS MROU_APTDT\n    ,rou.MROU_LSVDT\n    ,(\n        CASE MROU_FRSVE\n        WHEN 'Y'\n            THEN 'FREE'\n        WHEN 'N'\n            THEN 'NORMAL'\n        END\n    ) AS SERVICE_DUE_TYPE\nFROM dbo.MROU_FIL AS rou\nINNER JOIN dbo.MCUS_FIL AS cus ON rou.MROU_CUSID = cus.MCUS_CUSID\nINNER JOIN dbo.MMOD_FIL AS mod ON rou.MROU_MODID = mod.MMOD_MODID\nINNER JOIN dbo.MSVC_FIL AS svc ON rou.MROU_SVCID = svc.MSVC_SVCID\nINNER JOIN dbo.MADR_FIL AS adr ON cus.MCUS_CUSID = adr.MADR_CUSID\nINNER JOIN dbo.MSTA_FIL AS st ON adr.MADR_STAID = st.MSTA_STAID\nINNER JOIN dbo.MARE_FIL AS ar ON adr.MADR_AREID = ar.MARE_AREID\nINNER JOIN dbo.FAPT_FIL AS apt ON rou.MROU_ROUID = apt.FAPT_ROUID\nWHERE rou.MROU_STAT = 'ACTIVE'\nAND rou.MROU_CUSPF = 'MY'\nAND apt.FAPT_APTTY in ('mf','m1','m2','m3','m4','m5','m6', 'mm')\nAND ((@ProdClass = '') OR (@ProdClass &lt;&gt; '' AND rou.MROU_CLSID = @ProdClass))\nAND ((@ModelID = '') OR (@ModelID &lt;&gt; '' AND rou.MROU_MODID = @ModelID))\nAND (\n    ((@ServiceStartDate = '') OR (@ServiceStartDate &lt;&gt; '' AND rou.MROU_LSVDT &gt;= @ServiceStartDate))\n    AND\n    ((@ServiceEndDate = '') OR (@ServiceEndDate &lt;&gt; '' AND rou.MROU_LSVDT &lt;= @ServiceEndDate))\n)\nAND ((@SvcID = '') OR (@SvcID &lt;&gt; '' AND svc.MSVC_SVCID = @SvcID))\nAND ((@StateID = '') OR (@StateID &lt;&gt; '' AND adr.MADR_STAID = @StateID))\nAND ((@AreaID = '') OR (@AreaID &lt;&gt; '' AND adr.MADR_AREID = @AreaID))\nORDER BY rou.MROU_LSVDT\n\n\n-- function -- \nALTER FUNCTION [dbo].[ufn_GetLastXApptDate] \n(\n@rouid numeric(18,0)\n)\nRETURNS datetime\nAS\nBEGIN\n    DECLARE @ApptDate datetime\n\n    SELECT @ApptDate = MAX(FAPT_APTDT)\n    FROM dbo.FAPT_FIL\n    WHERE FAPT_ROUID = @rouid\n        AND FAPT_STAT= 'X'\n        AND FAPT_APTTY in ('mf','m1','m2','m3','m4','m5','m6', 'mm')\n\n    RETURN @ApptDate\n\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sqlplus"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":595,"score":1,"question_id":4021656,"title":"No way to execute SQL script from SQL Server Query Manager like @{file.sql} oracle sqlplus syntax?","body":"<p>Like the title says, in oracle you can issue the following command in SQL*Plus:</p>\n\n<pre><code>SQL&gt; select something from anothertable; #sql\nSQL&gt; @{/home/me/somescript.sql};         #load sql from file and execute it\nSQL&gt; do something else in script;        #other sql\n</code></pre>\n\n<p>Without having to file->open the sql script to load it to the UI.</p>\n\n<p>Is there an equivalent in SQL Server Query Manager? I've stumbled upon many situation where i could have used it but i couldn't be able to find a way to accomplish it.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":13,"favorite_count":7,"up_vote_count":25,"down_vote_count":0,"view_count":159480,"score":25,"question_id":185520,"title":"Convert Month Number to Month Name Function in SQL","body":"<p>I have months stored in SQL Server as 1,2,3,4,...12. I would like to display them as January,February etc. Is there a function in SQL Server like MonthName(1) = January? I am trying to avoid a CASE statement, if possible.</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":9,"favorite_count":11,"up_vote_count":11,"down_vote_count":0,"view_count":11133,"score":11,"question_id":303417,"title":"What are the best practices in writing a sql stored procedure","body":"<p>I found that SQL stored procedures are very interesting and useful. I have written stored procedures but i want to write well crafted, good performance tuned and concise SPs for any sort of requirement and also would love to learn about any tricks or good practices for stored procedures. How do i move from the beginner to the advanced stage in writing stored procedures?</p>\n\n<p><em>Update: Found from comments that my question should be more specific.\nEveryone has some tricks upon their sleeves and I was expecting such tricks and practices for SPs which they use in their code which differentiates them from others and more importantly spruce up the productivity in writing and working with stored procedures.</em></p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":436,"score":2,"question_id":685419,"title":"How to get the two best students of each professor in SQL?","body":"<p>I have a table with 3 fields like this:</p>\n\n<pre><code>ProfessorID    StudentID    Mark\nP1             S1              9\nP1             S2              8\nP1             S3             10\nP2             S1              7\nP2             S2              2\nP2             S3              4\nP3             S4              5\nP4             S1              6\n</code></pre>\n\n<p>A professor can teach many students, and vice versa, a student can learn from many professor. When a student learns from a professor, he gets his mark.</p>\n\n<p>My problem is showing list of professors who teach at least 2 students, and 2 students who get best marks from those professors. In example, the query result of this table is:</p>\n\n<pre><code>ProfessorID    StudentID    Mark\nP1             S1              9\nP1             S3             10\nP2             S1              7\nP2             S3              4\n</code></pre>\n\n<p>I've tried some solutions but they don't work <strong>right</strong>.</p>\n\n<p>How can I do this correctly?</p>\n"},{"tags":["tsql","namespaces","for-xml-path"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":99,"score":2,"question_id":12823556,"title":"How to avoid namespace in child nodes using FOR XML PATH?","body":"<p>I want to create a sitemap xml file (including images) directly from the database without another process (like transformation or another trick).</p>\n\n<p>My query is:</p>\n\n<pre><code>;WITH XMLNAMESPACES(\n    DEFAULT 'http://www.sitemaps.org/schemas/sitemap/0.9',\n    'http://www.google.com/schemas/sitemap-image/1.1' as  [image] )  \nSELECT  \n    (SELECT             \n        'mysite'    as [loc],\n        (select   \n            'anotherloc'\n            as [image:loc]\n        for XML path('image:image'), type\n        )\n    for xml path('url'), type\n)\nfor xml path('urlset'), type\n</code></pre>\n\n<p>Returns:</p>\n\n<pre><code>&lt;urlset xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"&gt;\n  &lt;url xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"&gt;\n    &lt;loc&gt;mysite&lt;/loc&gt;\n    &lt;image:image xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"&gt;\n      &lt;image:loc&gt;anotherloc&lt;/image:loc&gt;\n    &lt;/image:image&gt;\n  &lt;/url&gt;\n&lt;/urlset&gt;\n</code></pre>\n\n<p>But I need this output, without repeated namespace declaration:</p>\n\n<pre><code>&lt;urlset xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"&gt;\n  &lt;url&gt;\n    &lt;loc&gt;mysite&lt;/loc&gt;\n    &lt;image:image&gt;\n      &lt;image:loc&gt;anotherloc&lt;/image:loc&gt;\n    &lt;/image:image&gt;\n  &lt;/url&gt;\n&lt;/urlset&gt;\n</code></pre>\n"},{"tags":["tsql","variables","user-defined-functions"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":786,"score":0,"question_id":3161155,"title":"SQL Scalar UDF to get number of days in Year","body":"<p>I writing code to determine how many days in a year. I am trying to keep it really simple. \nI found code that I think is very clean to determine a leap year. I am passing the inputted date using DATEPART(Y,@Year) to the leap year program and some how am not getting the correct results so I has to be in my SQL code to process the input date as the correct bit is returned. </p>\n\n<p>Here is the code for the Leap Year:</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nALTER FUNCTION [dbo].[FN_Is_Leap_Year]\n(\n -- the parameters for the function here\n\n        @year int\n)\n\nRETURNS BIT\nAS\nBEGIN\nRETURN (select case datepart(mm, dateadd(dd, 1, cast((cast(@year as varchar(4)) + '0228') as datetime)))\nWHEN 2 THEN 1\nELSE 0  END)\n\nEND\n</code></pre>\n\n<p>Here is the code I wrote to process the input date &amp; get the # days in a year:</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nALTER FUNCTION [dbo].[FN_Get_Days_In_Year]\n(\n    @InputDT    varchar(10)\n)\n\nRETURNS int\nAS\nBEGIN\n\nDECLARE  @Result  int,\n         @Year    int   \n\n\nSet @Result = \n CASE\n    WHEN dbo.FN_Is_Leap_Year(Datepart(yyyy,@Year)) = 0 Then 365\n    WHEN dbo.FN_Is_Leap_Year(Datepart(yyyy,@Year)) = 1 Then 366\n END\n\n\n        RETURN @Result\n    END\n</code></pre>\n"},{"tags":["tsql","group-by","sql-server-2008-r2","bug"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":73,"score":4,"question_id":12834488,"title":"SQL Server discarding SPACE during GROUP BY","body":"<p>Looks like SQL Server (tried on 2008 R2) is doing an <code>RTRIM</code> on columns in <code>GROUP BY</code> clause. Did anyone notice this? Am I missing something here?</p>\n\n<p>The two selects are returning the same result set in the query below, which should not be the case I believe.</p>\n\n<pre><code>declare @t table(Name varchar(100), Age int)\ninsert into @t values ('A', 20)\ninsert into @t values ('B', 30)\ninsert into @t values ('C', 40)\ninsert into @t values ('D', 25)\ninsert into @t values (' A', 21)\ninsert into @t values ('A ', 32)\ninsert into @t values (' A ', 28)\n\nselect\n    Name,\n    count(*) Count\nfrom @t\ngroup by Name\n\nselect\n    rtrim(Name) RtrimmedName,\n    count(*) Count\nfrom @t\ngroup by rtrim(Name)\n</code></pre>\n\n<p>Please let me know your thoughts...</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12832738,"title":"Modify a stored procedure to display the latest role for an employee","body":"<p>I have a stored procedure which returns the 3 months' data for an employee. I have to modify the procedure in such a way that while displaying the role of the employee is his role in the latest month.</p>\n\n<p>If for the latest month, the data does not exist, then the previous month's role is displayed.\nThe table has an identity column (PK), <code>EMP_ID</code>, <code>Role</code> and various other columns. But for answering this question, this much data is sufficient, I hope.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","common-table-expression"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":124,"score":3,"question_id":12827236,"title":"TSQL - Recursive CTE inefficient - Need an alternative","body":"<p>Here is a table with sample data:</p>\n\n<pre><code>DECLARE @TestTable TABLE (\n    ItemID INT,\n    A INT,\n    B INT,\n    Month INT)\n\nINSERT INTO @TestTable VALUES (1234, 5, 9, 1)\nINSERT INTO @TestTable VALUES (1234, 6, 9, 2)\nINSERT INTO @TestTable VALUES (4321, 5, 11, 1)\nINSERT INTO @TestTable VALUES (4321, 12, 11, 2)\nINSERT INTO @TestTable VALUES (1324, 14, 6, 1)\nINSERT INTO @TestTable VALUES (1324, 5, 6, 2)\nINSERT INTO @TestTable VALUES (1234, 1, 9, 3)\nINSERT INTO @TestTable VALUES (1324, 9, 6, 3)\n</code></pre>\n\n<p>Something to note is that the B column is always the same as it's only used once in this calculation, but is needed for the initial calculation.</p>\n\n<p>I am attempting to subtract B from A on the first row, then on subsequent rows subtract the previous rows difference from A. Effectively, <code>B - A = C</code> on the first then <code>C - A</code> on all subsequent rows FOR THE RELATED ItemID.</p>\n\n<p>Here are the results I'm expecting:</p>\n\n<pre><code>ItemID  A   B   C   Month   RowNumber\n1234    5   9   4   1       1\n1234    6   9   -2  2       2\n1234    1   9   -3  3       3\n1324    14  6   -8  1       1\n1324    5   6   -13 2       2\n1324    9   6   -22 3       3\n4321    5   11  6   1       1\n4321    12  11  -6  2       2\n</code></pre>\n\n<p>Here is how I am accomplishing this.</p>\n\n<pre><code>;WITH CTE_TestValue AS (\n    SELECT \n        Main.ItemID,\n        Main.A,\n        Main.B,\n        Main.Month,\n        ROW_NUMBER() OVER (Partition BY Main.ItemID ORDER BY Main.Month) AS RowNumber\n    FROM @TestTable AS Main\n),\nCTE_TestColumnC AS (\n    SELECT \n        MainA.ItemID,\n        MainA.A,\n        MainA.B,\n        (MainA.B - MainA.A) AS C,\n        MainA.Month,\n        MainA.RowNumber\n    FROM CTE_TestValue AS MainA\n        WHERE MainA.Rownumber = 1\n\n    UNION ALL\n\n    SELECT \n        MainB.ItemID,\n        MainB.A,\n        MainB.B,\n        (Sub.C - MainB.A) AS C,\n        MainB.Month,\n        MainB.RowNumber\n    FROM CTE_TestValue AS MainB\n        INNER JOIN CTE_TestColumnC AS Sub\n            ON MainB.RowNumber - 1 = Sub.RowNumber\n            AND MainB.ItemID = Sub.ItemID\n--      CROSS JOIN CTE_TestColumnC AS Sub\n--          WHERE Sub.RowNumber + 1 = MainB.RowNumber\n--          AND MainB.ItemID = Sub.ItemID \n)\nSELECT \n    Main.ItemID,\n    Main.A,\n    Main.B,\n    Main.C,\n    Main.Month,\n    Main.RowNumber\nFROM CTE_TestColumnC AS Main\nORDER BY ItemID, Month, RowNumber\n</code></pre>\n\n<p>This works fine on a small data-sample, but I'm dealing with about 20,000 ItemId's each repeating 10 times. It finishes all the first row calculations instantly, as expected, and then the calculation times go up DRASTICALLY.</p>\n\n<p>As you can see I've tried both an <code>INNER JOIN</code> and a <code>CROSS JOIN</code>. I believe they have the same execution plan with the parameters that I've given the <code>CROSS JOIN</code>.</p>\n\n<p>Is there a more effective/efficient way to accomplish this?</p>\n\n<p>I allowed this to run for 5 hours yesterday to see if it ever ended.. it did not.</p>\n\n<p>Another note: When I'm using this on the test data I <code>SELECT</code> WITHOUT using <code>ORDER</code> to hopefully help speed things along. The <code>ORDER</code> is just for my convenience when I'm fact checking.</p>\n"},{"tags":["tsql","sql-server-2008"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":726,"score":1,"question_id":6953417,"title":"How to execute Table valued function","body":"<p>I have following function which returns Table .</p>\n\n<pre><code>create Function FN(@Str varchar(30))\n  returns\n  @Names table(name varchar(25))\n  as \n  begin \n\n      while (charindex(',', @str) &gt; 0)\n      begin\n      insert into @Names values(substring(@str, 1, charindex(',', @str) - 1))\n     set  @str = substring(@str, charindex(',', @str) + 1, 100)  \n      end\n      insert into @Names values(@str)  \n\n      return\n  end\n</code></pre>\n\n<p>Could any one please explain me how to run this function.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":80,"score":1,"question_id":12809838,"title":"SQL Server 2008 R2 Merge is deleteing the wrong set of data","body":"<p>I have the table <code>tblCollectionGameList</code></p>\n\n<pre><code>CREATE TABLE dbo.tblCollectionGameList\n(\n    ListID smallint IDENTITY(0,1) NOT NULL,\n    CollectionID smallint NOT NULL,\n    IncludedSectionID smallint NOT NULL,\n    CONSTRAINT PK_CollectionGameList_ListID PRIMARY KEY CLUSTERED (ListID ASC),\n    CONSTRAINT FK_CollectionGameList_SectionInfo FOREIGN KEY (CollectionID) REFERENCES dbo.tblSectionInfo (SectionID),\n    CONSTRAINT FK_CollectionGameList_SectionInfo2 FOREIGN KEY (IncludedSectionID) REFERENCES dbo.tblSectionInfo (SectionID)\n)\n</code></pre>\n\n<p>which I run the following <code>MERGE</code> command on after passing an XML set of values to from my website</p>\n\n<pre><code>SELECT \n   CAST(colx.query('data(CollectionID) ') AS varchar) AS CollectionID,\n   CAST(colx.query('data(IncludedSectionID) ') AS varchar) AS IncludedSectionID\nINTO #TEMPtblCollectionGameList\nFROM @XMLTable.nodes('DocumentElement/XMLTable') AS Tabx(Colx)\n\nMERGE dbo.tblCollectionGameList AS t\nUSING #TEMPtblCollectionGameList AS s\nON (t.CollectionID = s.CollectionID AND t.IncludedSectionID= s.IncludedSectionID)\nWHEN NOT MATCHED BY TARGET\n    THEN\n        INSERT (CollectionID, IncludedSectionID)\n        VALUES (s.CollectionID, s.IncludedSectionID)\nWHEN NOT MATCHED BY SOURCE\n    THEN\n        DELETE\n;\n</code></pre>\n\n<p>which is not working right. If I have an existing set of data in my table:</p>\n\n<pre><code>ListID  CollectionID    IncludedSectionID\n34      86              0\n35      86              1\n</code></pre>\n\n<p>and I try to place new data from my web page for a collection with a different <code>CollecitonID</code> it is removing the old data and placing the new data in:</p>\n\n<pre><code>ListID  CollectionID    IncludedSectionID\n38      92              10\n39      92              11\n</code></pre>\n\n<p>what is wrong with my <code>MERGE</code> code that is making it affect items outside the <code>CollectionID</code> that the webpage is passing for an update?</p>\n"},{"tags":["sql-server","tsql","stored-procedures","linked-server"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":69,"score":1,"question_id":12830432,"title":"Stored procedure to get the status of a linked server","body":"<p>I'm trying to create a stored procedure to get the status of a linked server to prevent errors when trying to execute anything on it. I saw some examples online, but I'm not having any success with those.</p>\n\n<p>Here is my code:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[checkLinkedServer] \n    @servername ntext\nAS\nBEGIN\n    SET NOCOUNT ON;\n    DECLARE @retval int = 0;\n    BEGIN TRY\n        EXEC @retval = sys.sp_testlinkedserver @servername;\n        SELECT 1;\n    END TRY\n    BEGIN CATCH\n        SELECT 0;\n    END CATCH;      \nEND\n</code></pre>\n\n<p>I'm always getting a return value of 0 - no matter if the linked server exists or not.</p>\n\n<p>Any ideas what I'm doing wrong here?</p>\n"},{"tags":["sql","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":74,"score":3,"question_id":12829405,"title":"Insert Statement","body":"<p>I want to insert the values ('testu', 'testp', 'testname', 'testsur', 'testemail') into [dbo].[users]</p>\n\n<p>I'm using Microsoft SQL Server 2012 and anytime i try to query something like</p>\n\n<pre><code>INSERT INTO [dbo].[users]\nVALUES ('testu', 'testp', 'testname', 'testsur', 'testemail')\n</code></pre>\n\n<p>I get an Error on the \"INSERT\" statement saying: This statement is not recognized in the context. What does this mean? How can i fix it?</p>\n\n<pre><code>CREATE TABLE [dbo].[users] (\n    [username] VARCHAR (40) NOT NULL,\n    [password] VARCHAR (40) NOT NULL,\n    [name]     VARCHAR (40)  NOT NULL,\n    [surname]  VARCHAR (40) NOT NULL,\n    [email]    VARCHAR (40) NOT NULL,\nPRIMARY KEY CLUSTERED ([username] ASC)\n);\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":12828032,"title":"How to perform bitwise operation on comma delimited column?","body":"<p>I have a table which has 2 columns:</p>\n\n<pre><code>ID (INT) (PK)  NumList (VARCHAR)\n1              2,4,25\n2              2,12,25,33\n3              3,10\n</code></pre>\n\n<p>How would I let's say add a column to this table and apply the OR (|) operator on the numbers in the list?</p>\n\n<pre><code>ID   NewCol\n1    31\n2    63\n3    11\n</code></pre>\n"},{"tags":["sql","tsql","pagination","sql-server-2008-r2","row-number"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":37,"score":1,"question_id":12829270,"title":"How to modify this query for pagination fetching?","body":"<p>This is a pretty complex query so i am having difficulties here. If you help me i appreciate it.</p>\n\n<pre><code>select AvgLevel,TotalCount,tblPokedex.PokemonId,Name,Type1,Type2,Hp,tblPokedex.Attack,tblPokedex.Defense,tblPokedex.SpAttack,tblPokedex.SpDefense,tblPokedex.Speed,(Hp+tblPokedex.Attack+tblPokedex.Defense+tblPokedex.SpAttack+tblPokedex.SpDefense+tblPokedex.Speed) as TotalStats \nfrom tblPokemonStats,tblAvailablePokemons,tblPokedex \nleft join tblUsersPokemons on tblPokedex.PokemonId=tblUsersPokemons.PokemonId \nwhere tblPokemonStats.PokemonId=tblPokedex.PokemonId \ngroup by tblPokedex.PokemonId,tblPokedex.Name,tblPokedex.Type1,tblPokedex.Type2,tblPokedex.Hp,tblPokedex.Attack,tblPokedex.Defense,tblPokedex.SpAttack,tblPokedex.SpDefense,tblPokedex.Speed,tblPokemonStats.AvgLevel,tblPokemonStats.TotalCount  \norder by PokemonId asc\n</code></pre>\n\n<p>Alright so what i want to do is for example select between top 100 and 150</p>\n\n<p>How can i do that ?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","stored-procedures"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12826465,"title":"Stored proceedure call 2nd SP with Trans Commit","body":"<p>I have one store procedure that will need to call a second stored procedure passing over one input parameter. Due to the nature of both stored procs I'd like to be able to use transactions and commit to ensure all elements are carried out before being committed.</p>\n\n<p>If the relevant contents of the first stored proc are within the transaction aswell as the call to the 2nd stored proc, will this suffice or is it the case that the events of the 2nd sp would be commited seperately???</p>\n\n<p>I hope that makes sense, &amp; thanks for in advance for the help.</p>\n"},{"tags":["sql-server","xml","tsql","xquery","xquery-sql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":522,"score":1,"question_id":3854308,"title":"XQuary adding or replacing attribute in single SQL update command","body":"<p>I have a Table with an XML column,\nI want to update the xml to insert attribute or to change the attribute value if the attribute already exists.</p>\n\n<p>Let's say the starting xml is: &lt; d /></p>\n\n<p><em>Inserting:</em></p>\n\n<pre><code>UPDATE Table \nset XmlCol.modify('insert attribute att {\"1\"} into /d[1]')\n</code></pre>\n\n<p><em>Changing:</em></p>\n\n<pre><code>UPDATE Table\nset XmlCol.modify('replace value of /d[1]/@att with \"1\"')\n</code></pre>\n\n<p>insert will fail if the attribute already exists, replace will fail if the attribute doesn't exists. \nI have tried to use 'if' but I don't think it can work, there error I get: \"XQuery [modify()]: Syntax error near 'attribute', expected 'else'.\"</p>\n\n<p><em>IF attempt</em></p>\n\n<pre><code>UPDATE Table \nset XmlCol.modify('if empty(/d[1]/@att) \n                   then insert attribute att {\"1\"} into /d[1]\n                   else replace value of /d[1]/@att with \"1\"')\n</code></pre>\n\n<p>Currently I select the xml into a variable and then modify it using T-SQL and then updating the column with new xml, this requires me to lock the row in a transaction and is probably more expensive for the DB.</p>\n"},{"tags":["sql","sql-server","tsql","dynamic-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":76,"score":0,"question_id":12824577,"title":"How to search all text fields in a DB for some substring with T-SQL","body":"<p>I have a huge schema, with several hundreds of tables and several thousands of columns.  I'd know that a specific IP address is stored in this database in several places, but I'm not sure what table(s) or column(s) it is stored in.  Basically, I'm trying to find everywhere that this IP address is stored in the DB so I can update it to a new value in all those places.</p>\n\n<p>Here's my first crack at a T-SQL statement to print out the table and column name, and the value, for every text column in the database that has the substring 10.15.13 in it.</p>\n\n<p>Now, this works, sort of.  The problem is, when I execute it in Management Studio, the call to sp_executesql will actually return all the empty results from every query that returns nothing (i.e. the column doesn't have any records with that substring), and it fills the result window to its max, and then I don't actually see if anything was printed.</p>\n\n<p>Is there a better way to write this query?  Or can I run it in some different way so that it only shows me the Tables and Columns where this substring exists?</p>\n\n<pre><code>DECLARE\n    @SchemaName VARCHAR(50),\n    @TableName VARCHAR(50),\n    @ColumnName VARCHAR(50);\nBEGIN\n    DECLARE textColumns CURSOR FOR\n    SELECT s.Name, tab.Name, c.Name\n    FROM Sys.Columns c, Sys.Types t, Sys.Tables tab, Sys.Schemas s\n    WHERE s.schema_id = tab.schema_id AND tab.object_id = c.object_id AND c.user_type_id = t.user_type_id\n    AND t.Name in ('TEXT','NTEXT','VARCHAR','CHAR','NVARCHAR','NCHAR');\n\n    OPEN textColumns\n\n    FETCH NEXT FROM textColumns\n    INTO @SchemaName, @TableName, @ColumnName\n\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        DECLARE @sql NVARCHAR(MAX),\n                @ParamDef NVARCHAR(MAX),\n                @result NVARCHAR(MAX);              \n        SET @sql = N'SELECT ' + @ColumnName + ' FROM ' + @SchemaName + '.' + @TableName + ' WHERE ' + @ColumnName + ' LIKE ''%10.15.13%''';\n        SET @ParamDef = N'@resultOut NVARCHAR(MAX) OUTPUT';\n\n        EXEC sp_executesql @sql, @ParamDef, @resultOut = @result OUTPUT;\n\n        PRINT 'Column = ' + @TableName + '.' + @ColumnName + ', Value = ' + @result;\n        FETCH NEXT FROM textColumns\n        INTO @SchemaName, @TableName, @ColumnName       \n    END\n    CLOSE textColumns;\n    DEALLOCATE textColumns;\nEND\n</code></pre>\n\n<p>I'd like to see results something like this where it shows the table/column that the substring was found in, and the full value in that column...</p>\n\n<pre><code>Column = SomeTable.SomeTextColumn, Value = 'https://10.15.13.210/foo'\nColumn = SomeTable.SomeOtherColumn, Value = '10.15.13.210'\n</code></pre>\n\n<p>etc.</p>\n"},{"tags":["sql","sql-server","performance","tsql","triggers"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":71,"score":2,"question_id":12825727,"title":"Modify SQL trigger to work when inserted table contains more than one row","body":"<p>I've got a SQL trigger written for a table in SQL Server 2008. It works well when there is only one row in the 'inserted' table. How can I modify this trigger to work correctly when there are multiple rows? Performance is key here, so I'd like to stay away from cursors, temp tables, etc. (if possible).</p>\n\n<p>Essentially the trigger checks to see if either the 'ClientID' or 'TemplateID' fields were changed. If they were, and the OriginalClientID or OriginalTemplateID fields are null, it populates them (thus setting the OriginalXXX fields once and only once so I can always see what the first values were).</p>\n\n<pre><code>CREATE TRIGGER [dbo].[trigSetOriginalValues]\n   ON  [dbo].[Review]\n   FOR INSERT, UPDATE\nAS \nBEGIN\n    IF (NOT UPDATE(TemplateID) AND NOT UPDATE(ClientID)) return\n\n    DECLARE @TemplateID int\n    DECLARE @OriginalTemplateID int\n    DECLARE @ClientID int\n    DECLARE @OriginalClientID int   \n    DECLARE @ReviewID int\n\n    SET @ReviewID = (SELECT ReviewID FROM inserted)\n    SET @ClientID = (SELECT ClientID FROM inserted)\n    SET @TemplateID = (SELECT TemplateID FROM inserted)\n    SET @OriginalTemplateID = (SELECT OriginalTemplateID FROM inserted);\n    SET @OriginalClientID = (SELECT OriginalClientID FROM inserted);\n\n    IF (@OriginalTemplateID IS NULL AND @TemplateID IS NOT NULL) \n    BEGIN\n        UPDATE [dbo].[Review] SET OriginalTemplateID = @TemplateID WHERE ReviewID=@ReviewID\n    END\n\n    IF (@OriginalClientID IS NULL AND @ClientID IS NOT NULL) \n    BEGIN\n        UPDATE [dbo].[Review] SET OriginalClientID = @ClientID WHERE ReviewID=@ReviewID\n    END \nEND\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":70,"score":1,"question_id":12824547,"title":"Stored procedure dealing with multiple records","body":"<p>I have the following SQL which works great at this stage:</p>\n\n<pre><code>  INSERT INTO recEntrantStatus (entrantId, roundId, judgeId, notified, voted, enterNextRound)\n  SELECT entrantId, (@round + 1), judgeId, 0, 0, 0\n  FROM recEntrantStatus\n  WHERE roundId = @round\n  AND voted = 1\n  AND enterNextround = 1\n</code></pre>\n\n<p>This code checks for all rows where <code>enterNextRound</code> is true, and then creates a new row for each of them.</p>\n\n<p><strong>However, I now need to expand this so that:</strong></p>\n\n<ol>\n<li><p>Check a second table (<code>tblJudges</code>) for all judges and get an array of all the judges Id's (Id)</p></li>\n<li><p>Do the same as in the above example except now creating each of the above rows for each of the judges / judges Id's obtained from step 1. </p></li>\n</ol>\n\n<p>Any help / suggestions would as always be greatly appreciated.</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12822433,"title":"T-SQL: Check temperature over 24 hour period","body":"<p>I have a SQL Server database with two values I'm interested in:</p>\n\n<pre><code>dtime - datetime\ntemperature - varchar\n</code></pre>\n\n<p>The table is fed by an external process that takes a building's temperature every 30 minutes. I'm interested in triggering an alert if the temperature exceeds 80 degrees for 48 periods (24 hours).</p>\n\n<p>I think this needs to be an external process that scans the table and sends an alert when this condition is met. I'm struggling with writing the SQL to do this.</p>\n\n<p><strong>EDIT</strong></p>\n\n<p>The data I'm pulling in comes in on a weekly basis. During this week I need to see if at any time in a 24-hour period the temperature has exceeded 80 degrees. The air conditioning could fail at any time and span two days or more, so I need to potentially check this across multiple days. The temperature is taken every half hour, so during the week I need to check if there are 48+ instances where the temperature exceeded 80 degrees.</p>\n\n<p>Sample data:</p>\n\n<pre><code>10/1/2012 12:00:00 AM | 70 | {ok}\n10/1/2012 12:30:00 AM | 70 | {ok}\n10/1/2012 1:00:00 AM | 70 | {ok}\n10/1/2012 1:30:00 AM | 75 | {ok}\n10/1/2012 2:00:00 AM | 75 | {ok}\n10/1/2012 2:30:00 AM | 80 | {ok}\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","datetime","dynamic-sql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":170,"score":2,"question_id":12805269,"title":"Convert datetime stored procedure parameter to a filter (in WHERE clause) in a dynamic T-SQL query","body":"<p>Below I have a snippet of code from a stored procedure I'm trying to make dynamic.  Meaning I want to run the <code>EXEC('select * from table_name WHERE filter=something')</code> to return a result set to my web service.  The week_start_date field in my table that I'm querying is a datetime field, not a date field.  How do I properly append the datetime parameter to the dynamic SQL so it interprets it correctly in the query?  Also, if you have suggestions on how to make the code cleaner, I'll take advice.</p>\n\n<p><strong>When I look at the data, I have values that look like this:</strong></p>\n\n<pre><code>2012-08-10 00:00:00.000\n</code></pre>\n\n<p><strong>T-SQL code that is not working:</strong></p>\n\n<pre><code>ALTER PROCEDURE [dbo].[logged_time_by_week]\n    @week_start_date_filter datetime = null\nAS\nBEGIN\n</code></pre>\n\n<p>....</p>\n\n<pre><code>    DECLARE @select_clause nvarchar(4000);\n    DECLARE @from_clause nvarchar(4000);\n    DECLARE @where_clause nvarchar(4000);\n    DECLARE @order_clause nvarchar(4000);\n\n    SET @select_clause = \n        ' SELECT '\n        + ' [sunday_hours],'\n        + ' [monday_hours],'\n        + ' [tuesday_hours],'\n        + ' [wednesday_hours],'\n        + ' [thursday_hours],'\n        + ' [friday_hours],'\n        + ' [saturday_hours]'\n\n    SET @from_clause =\n        ' FROM '\n        + ' [timesheet_row] '\n\n    SET @where_clause = ''\n\n    IF @week_start_date_filter IS NOT NULL AND @week_start_date_filter != ''\n    BEGIN \n        IF @where_clause != ''\n        BEGIN\n            SET @where_clause = @where_clause + ' AND ' \n        END\n        SET @where_clause = @where_clause + ' [week_start_date] = ' + CONVERT(nvarchar, @week_start_date_filter)\n    END\n\n    IF @where_clause != '' \n    BEGIN\n        SET @where_clause = ' WHERE ' + @where_clause\n    END\n\n    SET @order_clause = ' ORDER BY [' + @sort_column + '] ' + @sort_direction\n\n    EXEC(@select_clause + @from_clause + @where_clause + @order_clause)\n</code></pre>\n"},{"tags":["tsql","filter","subquery"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":63,"score":-1,"question_id":12824839,"title":"Filtering sub-query results from main query T-SQL","body":"<p>I have tried </p>\n\n<pre><code>select title\nfrom BOOKS B, AUTHOR A, LOANS U\nwhere a.author_id = b.author_id\nand not B.book_id = U.book_id\norder by A.name\n</code></pre>\n\n<p>and </p>\n\n<pre><code>select title\nfrom BOOKS B, AUTHOR A, LOANS U\nwhere b.author_id = a.author_id\nand not b.book_id in (select u.book_id from LOANS)\norder by A.name, b.title\n</code></pre>\n\n<p>All I need would be results from my sub-query <code>select u.book_id from LOANS</code></p>\n\n<p>Basically the table LOANS contains a list of book_id 's which have been loaned from a library.</p>\n\n<p>I need the book_id 's which haven't been loaned yet. Then need to have them sorted alphabetically by the author's name (thus the <code>order by A.name</code>)</p>\n\n<p>Note: the table containing the books only contains the author_id. To get the author's name I need to compare that author_id to the id's in the table AUTHOR.</p>\n\n<p>Anyone that can tell me what I'm doing wrong or - if I'm using a wrong method - what method to use instead?</p>\n"},{"tags":["sql-server-2008","tsql","sql-management-studio"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":83,"score":2,"question_id":12661644,"title":"How to Connect to SQL from Management Console using T-SQL","body":"<p>I have a group of SQL servers spread out in 25 locations that all have the same database.  I can connect to all of them manually using the Management Console.  In the server management console under \"New Query\", I would like to learn how to wrap a query or a group of t-sql statements with a loop that will first make the connection to one of the servers, specify the database, and then run the query/statement.  This way if I need to run a common query on all of the databases, such as updating the databases, I don't have to manually connect to each one, expand the console, click on the database, and then click \"New Query.\"</p>\n\n<p>The servers are all named wsrv01, wsrv02, wsrv03, etc., so I could loop through the names easily; I just don't know how to do the loop or make the connection.</p>\n\n<p>This is kind of a unique environment...I've used RedGate in the past on other projects and love it; but this is a different situation.</p>\n\n<p>Basically, I want to avoid having to do this and drill into each server to run a query:</p>\n\n<p><img src=\"http://i.stack.imgur.com/9uSKm.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":90,"score":0,"question_id":12803916,"title":"Select to retrieve multiple rows then loop results for Insert statement","body":"<p>I need to create a stored procedure to do the following;</p>\n\n<pre><code>    SELECT * FROM TABLE1\n</code></pre>\n\n<p>Then for each row returned;</p>\n\n<pre><code>    INSERT INTO TABLE2 (column1, column2, column3,...) \n    VALUES (value1, value2, value3,...)\n</code></pre>\n\n<p>How would I go about doing this?</p>\n\n<p><em><strong></em></strong> UPDATE <strong>**</strong></p>\n\n<p>So based on responses so far I've got the following sql;</p>\n\n<pre><code>INSERT INTO recEntrantStatus (entrantId, roundId, judgeId)\nSELECT entrantId, judgeId\nFROM recEntrantStatus\nWHERE roundId = 0\nAND voted = true\nAND enterNextround = true\n</code></pre>\n\n<p>But I need to add a fixed value eg an input @round into the newly created records in the column roundId.</p>\n\n<p>How do I go about doing that?</p>\n\n<p>Thanks.</p>\n\n<p>------------------------------------- UPDATE 2 -------------------------------------------</p>\n\n<p>So thanks to some significant help from you guys, I've now got the following SQL which works great at this stage:</p>\n\n<pre><code>  INSERT INTO recEntrantStatus (entrantId, roundId, judgeId, notified, voted, enterNextRound)\n  SELECT entrantId, (@round + 1), judgeId, 0, 0, 0\n  FROM recEntrantStatus\n  WHERE roundId = @round\n  AND voted = 1\n  AND enterNextround = 1\n</code></pre>\n\n<p>This code checks for all records where 'enterNextRound' is true, and then creates a new record for each of them.</p>\n\n<p>However, I now need to expand this so that:</p>\n\n<p>A) Check a second table(tblJudges) for all judges and get an array of all the judges Id's (Id)</p>\n\n<p>B) Do the same as in the above example except now creating each of the above records for each of the judges / judges Id's obtained from step A. </p>\n\n<p>Any help / suggestions would as always be greatly appreciated.</p>\n\n<p>Thanks!</p>\n\n<p>CLOSED - Question posted as a new question due to additional requirements. Thanks!</p>\n"},{"tags":["sql-server-2008","tsql","for-xml","for-xml-explicit"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12735615,"title":"SQL Server EXPLICIT mode with FOR XML","body":"<p>I am using SQL Server 2008 and I'm trying to produce a custom xml using <code>EXPLICIT</code> mode with <code>FOR XML</code>.</p>\n\n<p>I have the one to many relation having following query</p>\n\n<pre><code>select  \n    p.personid, p.firstname, a.P_City \nfrom \n    tblPeople p with (nolock) \nleft outer join \n    tblAddresses a with (nolock) on p.personid = a.personid \nwhere \n    p.personid = 120773\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/hQOEk.png\" alt=\"enter image description here\"></p>\n\n<p>I want person as parent and address as child may be multiple because people to address having one to many relation.</p>\n\n<p>I wrote the following query</p>\n\n<pre><code> select 1 as TAG,\n        null as parent, \n        p.personid as [person!1!personid],\n        p.FirstName as [person!1!firstname],\n\n        null as [addr!2!] \n        from tblPeople p with (nolock) where p.PersonID in (120773,117396)\n\n        union all \n\nselect 2,1, \n        p.PersonID, p.FirstName, a.P_City from tblAddresses a with(nolock), tblPeople p \n        where p.PersonID=a.PersonID and p.PersonID in (120773,117396)\n\n        for xml explicit\n</code></pre>\n\n<p>Output as follows, it is broken xml with person nested there is some thing wrong with my code for sure.</p>\n\n<pre><code>&lt;person personid=\"117396\" firstname=\"David\"/&gt;\n    &lt;person personid=\"120773\" firstname=\"Doyle\"&gt;\n        &lt;addr&gt;Mount Rainier&lt;/addr&gt;\n        &lt;addr&gt;Annapolis&lt;/addr&gt;\n&lt;/person&gt;\n</code></pre>\n\n<p>Can some one please help me out !!!</p>\n"},{"tags":["tsql","sql-server-2008","sql-server-2008-r2"],"answer_count":2,"favorite_count":2,"up_vote_count":1,"down_vote_count":0,"view_count":111,"score":1,"question_id":7485667,"title":"T-SQL compilation issue for simple query involving DMV","body":"<p>For some reason, the following query which uses the <code>sys.dm_exec_requests</code> DMV and the <code>sys.dm_exec_sql_text</code> DMV fails to compile:</p>\n\n<pre><code>SELECT er.session_id, es.[text]\nFROM sys.dm_exec_requests AS er \n  CROSS APPLY sys.dm_exec_sql_text(er.[sql_handle]) AS es \n</code></pre>\n\n<p>The query excerpt above is part of a much larger (and more complex) query which fails, because this smaller query will not execute, giving me the syntax error:</p>\n\n<blockquote>\n  <p>Msg 102, Level 15, State 1, Line 3 Incorrect syntax near '.'.</p>\n</blockquote>\n\n<p>The query seems simple enough, yet it looks like the T-SQL parser is balking at the <code>er.sql_handle</code>. I thought this might be an escaping issue and tried <code>er.[sql_handle]</code>, but sadly got the same error.</p>\n"},{"tags":["sql","sql-server","tsql","optimization","ssms"],"answer_count":3,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":118,"score":5,"question_id":12821816,"title":"Why does order of T-SQL where statements matter?","body":"<p>Why, when opening a query like the following:</p>\n\n<p><code>WHERE     (statement1) AND ((statement2) OR (statement3))</code></p>\n\n<p>does SSMS query designer refactor it into the following syntax:</p>\n\n<p><code>WHERE     (statement1) AND (statement2) OR\n                   (statement1) AND (statement3)</code></p>\n\n<p>I assume it has something to do with how SQL server parses the query, running ands before ors?</p>\n\n<p>Is there a general rule of how to the best order of statements for ultimate optimisation?</p>\n\n<p>Having run my own tests, the 2nd query knocks 0.5ms off the processing time. Its small, I know, but would increase with the complexity of the query (still makes almost no difference) and I have a general interest in how SQL server works.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":484,"score":3,"question_id":1126015,"title":"Filtering SELECT statement by row with most populated columns","body":"<p>I have a statement that SELECTs distinct rows from a table with a two value index</p>\n\n<pre><code>SELECT distinct Reference, Value1, Value2, Value3, Value4 FROM [tblHistory]\n</code></pre>\n\n<p>Where Reference is an index with another field \"Project\". For a particular system this data is inserted into another table using only Reference as the index because Value1 through Value4 SHOULD always be the same for the same Reference - however in about 1/500 it is not.</p>\n\n<p>In the case where there is a duplicate Reference AND differences in one or more of the Value1-Value4 fields I need to pick the row with the most completed Value1-Value4 fields as they are often NULL. If all instances have the same number of populated columnsI can return the first row found.</p>\n\n<p>Other than using temporary tables and code like</p>\n\n<pre><code>case when Value1 is null then 1 else 0 end \n+ case when Value2 is null then 1 else 0 end \n+ case when Value3 is null then 1 else 0 end\n+ case when Value4 is null then 1 else 0 end\nas CountOfNulls\n</code></pre>\n\n<p>Is there a way to filter the data so I only get the most populated row?</p>\n\n<p>I'm running MS SQL Server 2000.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":78,"score":0,"question_id":12821729,"title":"Can I use `If` in a select statement?","body":"<p>Can you even put an if statement in a select like this or must you use Case statements for what I'm trying to do here?  I get syntax errors currently:</p>\n\n<pre><code>Select \n    field1,\n    field2,\n    If( @CurrentDate = @lastDate and @CurrentWeek = @lastWeek) \n              select @CurrentWeek,\n    .... rest of select statement\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":195,"score":2,"question_id":12813563,"title":"Writing a stored procedure with an insert statement with unlimited parameters","body":"<p>I'm having a bit of trouble with a question given to me in an assignment. My lecturer isn't the greatest at explaining things in a way I can understand, so I'm hoping I can get some help here.</p>\n\n<p>This is the question we were given:</p>\n\n<blockquote>\n  <p>Construct a stored procedure to insert data into the keyword table. The format of the input string should be (Topic_name, K1,W1,K2,W2,K3,W3Kn, Wn). Ks are keywords and Ws are weights. If the Topic name cannot be found in the Topic table then you need to insert the new topic name into the Topic table first and subsequently insert other data into the keyword table. Your stored procedure should always check the string pattern to ensure it is correctly formatted and the correct data types are used. Provide a feedback message to the user if the string pattern is invalid.</p>\n</blockquote>\n\n<p>This is my keyword table:</p>\n\n<pre><code>CREATE TABLE Keyword(\n    Topic_Name  VARCHAR(30) NOT NULL,\n    Keyword VARCHAR(30) NOT NULL,\n    K_weight    INT     NOT NULL,\n    PRIMARY KEY(Topic_Name, Keyword),\n    FOREIGN KEY(Topic_Name) REFERENCES Topic);\n</code></pre>\n\n<p>The main issue I'm having is with the parameters. I have no idea how to get the SP to count how many parameters the user has included. Any help I could get would be greatly appreciated. If you need any additional information, just let me know. Cheers.</p>\n"}]}
{"total":16599,"page":9,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql","optimization"],"answer_count":10,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":8203,"score":6,"question_id":7417415,"title":"How to get second-highest salary employees in a table","body":"<p>It's a interview question I got this afternoon:</p>\n\n<p>There a table contains ID, Name, and Salary of Employees, get names of the second-highest salary employees, in SQL Server</p>\n\n<p>Here's my answer, I just wrote it in paper and not sure that it's perfectly valid, but it seems to work: </p>\n\n<pre><code>SELECT Name FROM Employees WHERE Salary = \n( SELECT DISTINCT TOP (1) Salary FROM Employees WHERE Salary NOT IN\n (SELECT DISTINCT TOP (1) Salary FROM Employees ORDER BY Salary DESCENDING)\nORDER BY Salary DESCENDING)\n</code></pre>\n\n<p>I confessed to interviewers that it's ugly. It's the only solution come to my mind in the interview, but right now, when I'm at home, I still can't not find a better, more elegant solution.</p>\n\n<p>Can you suggest me a better query?</p>\n\n<p>Thank you very much.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12817935,"title":"order query results by specific where condition (complex)","body":"<p>The think is to get search result by phrase (search over several columns), and sort priority have to depend on which column there is matching (including exact matching case).</p>\n\n<p>My example works fine, but I still think there is a better way to do it:</p>\n\n<pre><code>WITH    products\n  AS ( SELECT\n        -- .. some columns\n        --------- For Sorting -------------\n        [sortOrder] = CASE \n            WHEN [partNumber] = @searchPhrase                                                                       \n             OR [manPartNumber]= @searchPhrase\n            THEN 1                                                                \n            WHEN  FormatSiteNameForSearch( [siteName] ) \n                  LIKE '%' + @searchPhrase + '%'\n            THEN 2                                                                        \n            WHEN [partNumber] LIKE '%' + @searchPhrase + '%'\n                 OR [manPartNumber] LIKE '%' + @searchPhrase + '%'\n            THEN 3\n            ELSE 100\n            END\n        --------- End For Sorting -------------\n        FROM [dbo].[PRODUCTS_Products]           \n        WHERE                                                                                                                            \n            [partNumber] LIKE '%' + @searchPhrase + '%'\n            OR [manPartNumber] LIKE '%'+ @searchPhrase + '%'\n            OR FormatSiteNameForSearch([siteName]) LIKE '%'+@searchPhrase+'%'                                                              \n            OR [name] LIKE '%'+ @searchPhrase+ '%'                                                                                                                      \n    )\n    SELECT TOP(10) *\n    FROM    products\n    ORDER BY sortOrder\n</code></pre>\n\n<p>Thank You.</p>\n"},{"tags":["sql","sql-server","tsql","duplicate-removal"],"answer_count":14,"favorite_count":116,"up_vote_count":172,"down_vote_count":1,"view_count":62863,"score":171,"question_id":18932,"title":"How can I remove duplicate rows?","body":"<p>What is the best way to remove duplicate rows from a fairly large table (i.e. 300,000+ rows)?</p>\n\n<p>The rows of course will not be perfect duplicates because of the existence of the RowID identity field.</p>\n\n<pre><code>MyTable\n-----------\nRowID int not null identity(1,1) primary key,\nCol1 varchar(20) not null,\nCol2 varchar(2048) not null,\nCol3 tinyint not null\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12817037,"title":"T-SQL solution for GYM trainers TimeTable and session booking","body":"<p>I have four  tables\n<strong>tblEmployees</strong></p>\n\n<pre>\nEmployeeID  Name    \n1   Zahiz\n2   Nigon\n3   Jimian\n4   Ash\n5   Dani\n</pre>\n\n<p><strong>tblMembers</strong>\n<Pre>\nMemberNo    FirstName\n1   Saleem\n2   Jamil\n3   Jazi\n4   funa\n5   Jhon\n6   Moum\n</pre>\n<strong>RefSessions</strong></p>\n\n<pre>\nSessionID   StartTime   EndTime\n1   0701    0730\n2   0731    0800\n3   0801    0830\n4   0831    0900\n5   0901    0930\n6   0931    1000\n7   1001    1030\n8   1031    1100\n9   1101    1130\n10  1131    1200\n11  1201    1230\n12  1231    1300\n13  1301    1330\n14  1331    1400\n15  1401    1430\n16  1431    1500\n17  1501    1530\n18  1531    1600\n19  1601    1630\n20  1631    1700\n21  1701    1730\n22  1731    1800\n23  1801    1830\n24  1831    1900\n25  1901    1930\n26  1931    2000\n27  2001    2030\n28  2031    2100\n</pre>\n\n<p><strong>tblBookSession</strong></p>\n\n<pre>\nBookingID   SessionID   EmployeeID  MemberNo    SessionDate\n1   15  2   3   2012-09-30 \n2   16  2   3   2012-09-30 \n3   1   3   4   2012-10-03\n4   2   3   4   2012-10-03\n5   3   3   4   2012-10-03\n6   4   3   4   2012-10-03\n</pre>\n\n<p><a href=\"http://i.stack.imgur.com/jHOZP.png\" rel=\"nofollow\">I am looking for a t-sql query resulting in said  form  against a specific date</a></p>\n\n<p>Its actually booking of time slot of trainers in a gym and displaying In the  form of date wise report</p>\n"},{"tags":["sql-server","excel","tsql","excel-vba","excel-formula"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":4,"view_count":92,"score":-4,"question_id":12809311,"title":"Excel vlookup formulae to SQL","body":"<p>IF I consider 'PREVMNTPV' is one table and 'CURR' is other table and 'CURR' table consists of field1,field2,fied3 and field4. How do I get the below excel formaules to MS SQL. Please help me out. I just need simple select statement something like this.</p>\n\n<pre><code>col1=select field1 = case when C.T ='inactive' then 0\nwhen C.BL=1 AND P.B IS NULL then 1\nwhen P.B IS NULL then 0 -- vlookup... 2,false\nwhen C.BL=1 AND P.E ='inactive' and C.T = 'active') then 1 -- vlookup... 5, false\nwhen P.B is null then 0 -- ?? repeat\nwhen P.BL=1 AND P.F = 0 then 1\nelse 0 end\nfrom CURR C\nLEFT JOIN PREVMNTPV P ON C.A=P.A\n\ncol1/field1=IF(T2=\"Inactive\",0,IF(AND(ISNA(VLOOKUP($A2,'PREVMNTPV'!A:B,2,FALSE)),BL2=1),1,IF(ISNA(VLOOKUP($A2,'PREVMNTPV'!A:B,2,FALSE)),0,IF(AND(BL2=1,VLOOKUP($A2,'PREVMNTPV'!A:E,5,FALSE)=\"Inactive\",T2=\"Active\"),1,IF(ISNA(VLOOKUP($A2,'PREVMNTPV'!A:B,2,FALSE)),0,IF(AND(BL2=1,VLOOKUP($A2,'PREVMNTPV'!A:F,6,FALSE)=0),1,0))))))\n\ncol2/field2=IF(ISNA(VLOOKUP($A2,'PREVMNTPV'!A:B,2,FALSE)),0,IF(AND(T2=\"Inactive\",VLOOKUP($A2,'PREVMNTPV'!A:K,6,FALSE)=1,VLOOKUP($A2,'PREVMNTPV'!A:E,5,FALSE)=\"Active\"),-1,IF(AND(VLOOKUP($A2,'PREVMNTPV'!A:K,6,FALSE)=1,BL2=0,VLOOKUP($A2,'PREVMNTPV'!A:E,5,FALSE)=\"Inactive\"),0,IF(AND(BL2=0,VLOOKUP($A2,'PREVMNTPV'!A:K,6,FALSE)=1),-1,0))))\n\ncol3/field3=IF(OR(T2=\"Inactive\",DI2&lt;0),0,IF(DG2=-1,0,IF(DF2=1,BT2,IF(ISNA(VLOOKUP(A2,'PREVMNTPV'!A:K,8,FALSE)),BT2,IF(AND(BL2=1,(VLOOKUP(A2,'PREVMNTPV'!A:K,8,FALSE)&lt;BT2)),BT2-(VLOOKUP(A2,'PREVMNTPV'!A:K,8,FALSE)),0)))))\n\ncol4/field4=IF(ISNA(VLOOKUP($A2,'PREVMNTPV'!A:E,3,FALSE)),0,IF(AND($T2=\"Inactive\",VLOOKUP($A2,'PREVMNTPV'!A:E,5,FALSE)=\"Inactive\"),0,IF(DG2=-1,-1*(VLOOKUP($A2,'PREVMNTPV'!A:K,8,FALSE)),IF(AND(BT2&lt;VLOOKUP($A2,'PREVMNTPV'!A:K,8,FALSE),T2=\"Active\"),BT2-(VLOOKUP($A2,'PREVMNTPV'!A:K,8,FALSE)),IF(BT2-(VLOOKUP($A2,'PREVMNTPV'!A:K,8,FALSE)&gt;0),0,BT2-(VLOOKUP($A2,'PREVMNTPV'!A:K,8,FALSE)))))))\n</code></pre>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":34,"score":2,"question_id":12814943,"title":"Drop all unique keys from a table - T-SQL","body":"<p>Is there a way that I can drop all unique keys from a table apart from the primary key?</p>\n\n<p>My key names are generated by an ORM and I cannot guarantee their names.</p>\n"},{"tags":["c#",".net","algorithm","tsql","linq-to-sql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12597414,"title":"How to correctly extract records from this table?","body":"<p>I have an associative table with a <strong>DATE</strong> field:</p>\n\n<pre><code>|       DATE          |  USER_ID  | GROUP_ID   |\n| 2012-09-20 00:00:00 |     7     |     1      |\n| 2012-09-20 00:00:00 |     6     |     1      |\n| 2012-09-13 00:00:00 |     5     |     1      |\n| 2012-09-10 00:00:00 |     1     |     1      |\n| 2012-09-02 00:00:00 |     5     |     3      |\n| 2012-08-02 00:00:00 |     5     |     2      |\n| 2012-07-01 00:00:00 |     5     |     1      |\n| 2012-07-01 00:00:00 |     3     |     1      |\n</code></pre>\n\n<p>Each record represents an association between a user and a group.\nEach association is valid from the date indicated in the table and remains constant until a new association is inserted in the table.</p>\n\n<p>To know user-group association for a certain date is pretty easy: just select the maximum date &lt;= than indicated date.</p>\n\n<p>But now <strong>I need to extract all users associated with a certain group in a range of dates</strong>.\nThe provided parameters are: <strong>group_id</strong>, <strong>date_from</strong>, <strong>date_to</strong>.</p>\n\n<p>I have to implement this with Linq, but I'm trying to test the procedure using T-SQL.</p>\n\n<p>That's what I've tried:</p>\n\n<pre><code>SELECT *\nFROM user_group\nwhere group_id = 1\nand '2012-09-11' &lt;= date\nand date &lt;= '2012-09-20'\nUNION\nSELECT TOP 1 *\nFROM user_group\nwhere group_id = 1\nand date &lt;= '2012-09-11'\norder by date desc\n</code></pre>\n\n<p>but obviously it doesn't work...</p>\n\n<p><strong>NOTE:</strong></p>\n\n<p>the main difficulty is to get associations created before the <strong>from_date</strong> but still valid. For clarity, I need to get this result:</p>\n\n<pre><code>|       DATE          |  USER_ID  | GROUP_ID   |\n| 2012-09-20 00:00:00 |     7     |     1      |\n| 2012-09-20 00:00:00 |     6     |     1      |\n| 2012-09-13 00:00:00 |     5     |     1      |\n| 2012-09-10 00:00:00 |     1     |     1      |\n| 2012-07-01 00:00:00 |     3     |     1      |\n</code></pre>\n"},{"tags":["tsql","moving-average","set-based"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":33,"score":1,"question_id":12797901,"title":"Is subselecting column values inside the table you're updating not Allowed?","body":"<p>I'm making a stored procedure that\ncomputes the Moving Average Cost (MAC)\nof Each Spare parts in the Transactions Table. it is some sort \nof automatic checking and fixing of MAC of each row.\nI'm using Set-Based Approach because i'm avoiding cursor.</p>\n\n<p>my transaction table has the following Columns:</p>\n\n<p>Transaction No  -- a record of the row's transaction Number\nTransacType -- transaction type value will be BEG (Beginning Balance), ISS (for Issuance) ,and RR (for Received Stocks)</p>\n\n<p>Stock No -- Product Number</p>\n\n<p>Cost -- the Cost per unit of the Stock Number</p>\n\n<p>Quantity -- Quantity of the Transaction</p>\n\n<p>MAC -- Moving Average Cost</p>\n\n<p>Rules:\n    - If the transaction is RR, the Sproc will compute the MAC.\n    - the cost of all ISS transactions that will follow will be equal to the MAC of latest RR.</p>\n\n<p>Sample Table </p>\n\n<pre><code>-----------------------------------------------------------------------\nTransacNo     TransacType   StockNo Cost    Qty MAC \n-----------------------------------------------------------------------\n0               BEG     AE1 450.00  10  450.00  \n1               RR      AE1 460.00  05  453.33\n2               ISS     AE1 453.33  01  ------\n3               RR      AE1 460.00  05  455.09\n4               ISS     AE1 455.09  01  ------\n5               BEG     AE2 450.00  10  450.00\n6               RR      AE2 460.00  05  453.33\n7               ISS     AE2 453.33  01  ------\n8               RR      AE2 460.00  05  455.09\n9               ISS     AE2 455.09  01      ------\n------------------------------------------------------------------------\n</code></pre>\n\n<p>My Formula for Moving Average Cost:</p>\n\n<pre><code>Moving Average Cost = ((Latest MAC * Current OnHand Qty) + (RR Cost * RR Qty))\n            ---------------------------------------------------------------\n                    (Current OnHand Qty + RR Qty)\n</code></pre>\n\n<p>My MAC Fixing Code:</p>\n\n<pre><code>Declare @LatestMAC decimal(18,2);\nset @LatestMAC = 0.00\n\nDeclare @CurrentOnHand int;\nSet @CurrentOnHand = 0\n\n\nDeclare @TotalISS int;\nDeclare @TotalRR int;\n\nUpdate TransacTable\nSet\n\n@TotalISS =  \n            ISNULL((\n            Select SUM(Qty) \n            from \n                TransacTable TT \n            where \n                TT.TransacType = 'ISS' and\n                TT.StockNo = StockNo and\n                TT.TransacNo &lt; TransacNo),0),   \n@TotalRR =  \n            ISNULL((\n            Select SUM(Qty) \n            from \n                TransacTable TT \n            where \n                TT.TransacType = 'RR' and\n                TT.StockNo = StockNo and\n                TT.TransacNo &lt; TransacNo),0),   \n\n@LatestMAC = (Select top(1) ISNULL(MAC,0) \n            from \n                TransacTable TT \n            where \n                TT.TransacType = 'RR' and \n                TT.StockNo = StockNo and \n                TT.TransacNo &lt; TransacNo \n            Order by \n                TT.TransacNo desc),\n\n@CurrentOnHand = @TotalRR - @TotalISS,\n\nMAC = \nCase\n    WHEN TransacType = 'BEG'\n        THEN MAC\n    WHEN TransacType = 'RR'\n        THEN ((@LatestMAC * @CurrentOnHand) + (Cost * Quantity) / (@CurrentOnHand * Quantity))\n    else NULL\nEnd,\n\nCost = \nCase\n    When TransacType = 'ISS'\n        THEN @LatestMAC\n    else Cost\nend\n</code></pre>\n\n<p>My Problem is The Required Varibles (TotalISS, TotalRR, CurrentMAC) to the MAC equation returns NULL.</p>\n\n<p>Is selecting column values inside the table you're updating not Allowed?\nor there is an error in my solution itself?\ni derived my solution based on this example - <a href=\"http://www.intersoftdevelopment.com/IDI-ASPNET/Free-Source-Code.aspx?CodeID=30&amp;Code=SQL%20Server%20Set-Based%20Moving%20Averages%20no%20Cursor%202\" rel=\"nofollow\">Here.</a>\ni don't want to use cursor so i used this approach.</p>\n\n<p>Please Help me.</p>\n"},{"tags":["sql","sql-server-2008","tsql","sqlgeography"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":47,"score":2,"question_id":12810624,"title":"sql server union on geography columns","body":"<p>I'm using sql server 2008 R2, and I have two tables, Regions and Facilities.  Both have a column containing a geography element.</p>\n\n<p>I want to calculate the union on the intersection of the geograpy elements, like this:</p>\n\n<pre><code>SELECT * from Regions join Facilities on [Regions].[geography].STIntersects([Facilities].[geography])\n</code></pre>\n\n<p>which of course doesn't work.  The regions are large polygons, and the facilities are points each of which is contained in only one polygon.</p>\n\n<p>I can write some kind of (pseudocode)</p>\n\n<pre><code>for each r in Regions:\n    for each f in Facilities:\n        if f.[geography].STIntersects(r.[geography]):\n            print r, f\n</code></pre>\n\n<p>but the whole point of using a database is to operate on the set not the elements, surely?</p>\n\n<p>So, is there a better way to do this?</p>\n\n<p>thanks\nMelanie</p>\n"},{"tags":["sql-server","tsql","pivot"],"answer_count":3,"favorite_count":0,"up_vote_count":8,"down_vote_count":0,"view_count":73,"score":8,"question_id":12809638,"title":"Find count occurrences ","body":"<p>I have a table with 2 columns (db: sql server 2008):</p>\n\n<pre><code>id         name\n-----      ------\n1          Bob\n2          Mike\n3          Mary\n4          Mike\n5          Barry\n6          Benson\n7          Burrows\n</code></pre>\n\n<p>I want to get a count of names that start with B and start with M (in one row)?</p>\n\n<p>Like:</p>\n\n<pre><code>Count of B        Count of M\n-----------      ------------\n4                  3\n</code></pre>\n\n<p>The only thing that comes up for me is a union. Any ideas to do it cleaner in a single query (no union)?</p>\n"},{"tags":["sql","sql-server","tsql","windows-security"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":24,"score":1,"question_id":12808794,"title":"Determining local security policy with xp_regread","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1501234/reading-local-group-policy-active-directory-settings\">Reading Local Group Policy / Active Directory Settings</a>  </p>\n</blockquote>\n\n\n\n<p>I'm trying to write an audit script for sql server 2005+.</p>\n\n<p>One of the items I'd like to see in the script output is a list of the actual settings being verified by the 'Enforce Password Policy' flag.  I know that the actual settings referred to are inherited from the OS, so I was hoping that I could use xp_regread (or xp_instance_regread) to read the relevant registry keys, but I don't know which ones they are.</p>\n\n<p>All my searches keep pointing me to the secpol.msc snap-in, which shows the info I want, but I was hoping to get that info added into my sql script.</p>\n\n<p>Bottom line:</p>\n\n<p>Which registry keys can I look for with xp_regread to get info on the local security policy?  If I can't do it that way, how else can I get the info into the results of a sql statement?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":102,"score":-1,"question_id":12806453,"title":"Error : cannot insert duplicate key value","body":"<p>I'm getting the following error:</p>\n\n<blockquote>\n  <p>Message: Violation of PRIMARY KEY constraint 'PK_primKey'. Cannot insert duplicate key in object 'dbo.table'.</p>\n</blockquote>\n\n<p>Insertions in my database use a stored procedure <code>usp_GetKeyResequencingSeed</code> to generate a seed to generate the offset for the newly inserted record. </p>\n\n<p>The stored procedure is designed so that the minimum value is generated so that when the value is added to source table ID column, resulting ID values does not overlap any ID values in target table. </p>\n\n<p>However, the rule assumes that the insertion always occurs within same table therefore is not guaranteed to work for insertion across different tables. </p>\n\n<p>Since some insertions occur across different tables within database, the insertion may result in failure.</p>\n\n<p>Any ideas on how I might go about fixing this? I'm working for a company so I'm hesitant to put any code up.</p>\n"},{"tags":["excel","tsql","excel-formula"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":1,"view_count":75,"score":1,"question_id":11311241,"title":"How to show a customer's order frequency over specific bands of time.","body":"<p>I have a list of E-mail addresses and order dates. I am trying to figure out how to display the number of customers that order every week, twice a month, once a month, once every 2 months, once every 3 months, once every 4 months, and once every 5 months or more.</p>\n\n<p>What is the best way to accomplish this is? I have 400K records. </p>\n"},{"tags":["sql-server","tsql","exists"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":41,"score":2,"question_id":12807347,"title":"T-SQL use EXISTS as Column","body":"<p>I'm wondering whether I can use EXISTS (or something similar) in column like this:</p>\n\n<pre><code>SELECT Column1,\n       Column2,\n       EXISTS (SELECT 1 FROM Table2 T2 WHERE T2.Column = T1.Column) AS IsFlag\nFROM Table1\n</code></pre>\n\n<p>I know I can do something similar with Count()</p>\n\n<pre><code>SELECT Column1,\n       Column2,\n       (SELECT Count(*) FROM Table2 T2 WHERE T2.Column = T1.Column) AS IsFlag\nFROM Table1\n</code></pre>\n\n<p>But that might not be very efficient when Table2 is large </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":35,"score":0,"question_id":12805342,"title":"How to select records from table1 which doesnt have records in table 2 between certain dates","body":"<p>I have customers table and a another one for the sales activities associated to them (phone calls, emails ecc). \nWhat I need is to know is which of those customers havent been contacted (without activities) over the last 30 days for example.</p>\n\n<p>Here is what Im trying to do:</p>\n\n<pre><code>SELECT crm_customers.id, crm_ customers.companyname\nFROM crm_ customers \nLEFT JOIN crm_activities on crm_customers.id = crm_ activities. Customerid\nWHERE crm_ activities.createddate &lt; (getDate()  30)\n</code></pre>\n\n<p>The problem is that it returns the customers with activities older than 30 days even if they have more recent activities. I need to get only the customers without any sales activities in the last 30 days\nThanks for your help</p>\n"},{"tags":["sql","sql-server","query","tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12790921,"title":"Query count with multiple table group by month return zero if month is null","body":"<p>I need some help one getting the project count per month for all of the projectTypes per region. I've tried the following statement but it didn't return what I need. \nThe problem with the statement below is that it only returns the projectType only if there a count for that month. I need to return zero if the month doesn't have a count. \nAny help is much appreciated.</p>\n\n<pre><code>SELECT r.region, pt.projectType, count(p.id) as totalCount, p.postedOn as monthCount\nFROM region r cross join ProjectTypes pt left join projects p on p.regionID = r.id and pt.id = p.TypeID \nWHERE year(p.postedOn) = '2012' \ngroup by r.region, pt.projectType, p.postedOn \norder by r.region\n</code></pre>\n\n<p>Please the sample here: <a href=\"http://sqlfiddle.com/#!3/6680f/18\" rel=\"nofollow\">http://sqlfiddle.com/#!3/6680f/18</a></p>\n\n<pre>\nregions:\n-------------------------\nid  | region    |\n-------------------------\n1   | East      |\n-------------------------\n2   | MidWest   |\n-------------------------\n3   | West      |\n-------------------------\n\n\nProject Type:\n-------------------------\nid  | projectType   | \n-------------------------\n1   | Web Desgin    |\n-------------------------\n2   | Database  |\n-------------------------\n3   | Development   |\n-------------------------\n\n\nProjects:\n-------------------------------------------------------------------------\nid  | projectName   | regionID  | projectTypeID | postedOn  |\n-------------------------------------------------------------------------\n1   | Project 1 | 1     | 2     | 2012-09-02    |\n-------------------------------------------------------------------------\n2   | Project 2 | 2     | 2     | 2012-09-02    |\n-------------------------------------------------------------------------\n3   | Project 3 | 1     | 1     | 2012-09-02    |\n-------------------------------------------------------------------------\n4   | Project 4 | 3     | 2     | 2012-09-02    |\n-------------------------------------------------------------------------\n5   | Project 5 | 3     | 1     | 2012-10-02    |\n-------------------------------------------------------------------------\n6   | Project 6 | 3     | 2     | 2012-10-02    |\n-------------------------------------------------------------------------\n7   | Project 7 | 3     | 3     | 2012-10-02    |\n-------------------------------------------------------------------------\n8   | Project 8 | 2     | 3     | 2012-10-02    |\n-------------------------------------------------------------------------\n9   | Project 9 | 1     | 2     | 2012-10-02    |\n-------------------------------------------------------------------------\n10  | Project 10    | 1     | 2     | 2012-10-02    |\n-------------------------------------------------------------------------\n\n\nDesired Results:\n---------------------------------------------------------\nRegion  | project Type  | totalCount    | monthCount    |\n---------------------------------------------------------\nEast    | Web Desgin    | 1     | September |\n---------------------------------------------------------\nEast    | Database  | 1     | September |\n---------------------------------------------------------\nEast    | Development   | 0     | September |\n---------------------------------------------------------\nMidwest | Web Desgin    | 0     | September |\n---------------------------------------------------------\nMidwest | Database  | 1     | September |\n---------------------------------------------------------\nMidwest | Development   | 0     | September |\n---------------------------------------------------------\nWest    | Web Desgin    | 0     | September |\n---------------------------------------------------------\nWest    | Database  | 1     | September |\n---------------------------------------------------------\nWest    | Development   | 0     | September |\n---------------------------------------------------------\nEast    | Web Desgin    | 0     | October   |\n---------------------------------------------------------\nEast    | Database  | 2     | October   |\n---------------------------------------------------------\nEast    | Development   | 0     | October   |\n---------------------------------------------------------\nMidwest | Web Desgin    | 0     | October   |\n---------------------------------------------------------\nMidwest | Database  | 0     | October   |\n---------------------------------------------------------\nMidwest | Development   | 1     | October   |\n---------------------------------------------------------\nWest    | Web Desgin    | 1     | October   |\n---------------------------------------------------------\nWest    | Database  | 1     | October   |\n---------------------------------------------------------\nWest    | Development   | 1     | October   |\n---------------------------------------------------------\n</pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":511,"score":2,"question_id":1672179,"title":"SQL Server: How to extract comments from stored procedures for deployment","body":"<p>We have lots of stored procedures which all contain a lot of comments.<br />\nIs there a way to extract the comments from the stored procedures for deployment so the users can't see them when they modify a stored procedure with SQL Server Management Studio?</p>\n\n<p>Note: We're using SQL Server 2008.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":301,"score":0,"question_id":11531136,"title":"How to convert database table structure to XML file in sql server?","body":"<p>How will I convert table Schema to XML format? Format is given below.</p>\n\n<pre><code>&lt;Tables&gt;\n  &lt;Table&gt;\n    &lt;Name&gt;courses&lt;/Name&gt;\n    &lt;Schema&gt;dbo&lt;/Schema&gt;\n    &lt;Columns&gt;\n      &lt;Column&gt;\n        &lt;Name&gt;id&lt;/Name&gt;\n        &lt;DataType&gt;int&lt;/DataType&gt;\n     &lt;/Column&gt;\n     &lt;Column&gt;\n       &lt;Name&gt;page_name&lt;/Name&gt;\n       &lt;DataType&gt;nvarchar&lt;/DataType&gt;\n       &lt;Length&gt;50&lt;/Length&gt;\n     &lt;/Column&gt;\n    &lt;/Columns&gt;\n  &lt;/Table&gt;\n  &lt;Table&gt;\n    &lt;Name&gt;course_details&lt;/Name&gt;\n    &lt;Schema&gt;dbo&lt;/Schema&gt;\n    .....\n    .....\n  &lt;/Table&gt;\n&lt;/Tables&gt;\n</code></pre>\n\n<p>I am able to generate the structure for columns and tables separately. But I want to consolidated both. How is it possible?\nMy SQL scripts</p>\n\n<p><strong>For Tables:</strong></p>\n\n<pre><code>SELECT\nDistinct\nTABLE_NAME as Name,\nTABLE_SCHEMA as [Schema]\nFROM INFORMATION_SCHEMA.TABLES\nWHERE TABLE_SCHEMA='dbo'\nORDER BY TABLE_NAME ASC\nFor XML PATH ('Table'),\nRoot('Tables')\n</code></pre>\n\n<p><strong>For Columns:</strong></p>\n\n<pre><code>SELECT\nColumn_Name as Name,\nDATA_TYPE as DataType,\nCHARACTER_MAXIMUM_LENGTH as [Length]\nFROM INFORMATION_SCHEMA.COLUMNS\nFor XML PATH ('Column'),\nRoot('Columns')\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":8,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":783,"score":2,"question_id":79856,"title":"What is the most efficient way to count the results of a stored procedure, from another stored procedure?","body":"<p>In a stored procedure, I need to get the count of the results of another stored procedure. Specifically, I need to know if it returns any results, or an empty set.</p>\n\n<p>I could create a temp table/table variable, exec the stored procedure into it, and then run a select count on that data.  But I really don't care about the data itself, all I need is the count (or presence/absence of data). I was wondering if there is a more efficient way of getting just that information.</p>\n\n<p>I don't want to just copy the contents of the other stored procedure and rewrite it as a select count. The stored procedure changes too frequently for that to be workable.</p>\n"},{"tags":["sql","query","tsql","query-optimization","query-execution-plans"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":81,"score":0,"question_id":12801011,"title":"sql using different execution plans when running a query and when running that query inside a stored procedure?","body":"<p>I have this query,</p>\n\n<pre><code>Declare @Prcocessrate float\ndeclare @item varchar(20)\ndeclare @process varchar(20)\ndeclare @branch varchar(20)\nset @item = 'shirt'\nset @process = 'kt'\nset @branch = '1'\nselect @Prcocessrate =  ProcessPrice from itemwiseprocessrate where itemname=@Item and Process=@process and branchid=@branch\n</code></pre>\n\n<p>when I run it single handed, the execution plan only shows <strong>3 steps</strong>, see for youself..</p>\n\n<p><img src=\"http://i.stack.imgur.com/GI1cY.png\" alt=\"enter image description here\"></p>\n\n<p>but I have this <code>procedure</code> <code>sp_newBooking</code> as </p>\n\n<pre><code>ALTER PROC sp_newbooking\n-- other arguements--\nAS\nBEGIN\n\n--OTHER FLAGS--\n\nELSE IF (@Flag = 32)\n        BEGIN\n\n            declare @ItemId varchar(max),@ProcessRate float\n            --set @BranchId='1'\n            select @ProcessCode = DefaultProcessCode from mstconfigsettings where branchid=@BranchId\n            select @ItemId= DefaultItemId from mstconfigsettings where branchid=@BranchId\n            select @ItemName=  ItemName from itemmaster where itemid=@ItemId and branchid=@BranchId\n            select @ProcessRate =  ProcessPrice from itemwiseprocessrate where itemname=@ItemName and ProcessCode=@ProcessCode and branchid=@BranchId\n            if(@ProcessRate is not null)\n            select @ItemName as ItemName,@ProcessCode as ProcessCode,@ProcessRate as ProcessRate\n            else\n            select @ItemName as ItemName,@ProcessCode as ProcessCode,'0' as ProcessRate\n        END\n\n-- OTHER FLAGS --\n\n\nEND\n</code></pre>\n\n<p>Now!, when I run this</p>\n\n<pre><code>exec sp_newbooking\n@flag = 32,\n@Branchid = 1\n</code></pre>\n\n<p>The execution plan is showing <strong>6 steps!</strong> Here's the picture..!<br>\nSee the <strong>query 4</strong><img src=\"http://i.stack.imgur.com/at1Vf.png\" alt=\"\"></p>\n\n<p><strong>Why is it taking 6 steps to perform the same query</strong> when executing from the procedure, while its taking 3 steps when executing alone? Wtf is this?</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":48,"score":1,"question_id":12803823,"title":"Calculating number of holidays between two dates in table using SQL","body":"<p>I have a table that has two date fields (Date 1 and Date 3 in example below). I also have a Holiday table that lists all of the holidays. I would like to find an approach in a SQL query to be able to count the number of holidays between the two date values. Any ideas?</p>\n\n<p><strong>Example table:</strong></p>\n\n<pre>Date 1          Date 2\n5/1/2012        5/4/2012\n8/31/2012       9/25/2012\n12/23/2011      12/27/2011</pre>\n\n<p><strong>Example of Date Dimension table:</strong></p>\n\n<pre>Holiday Date\n\n12/25/2011\n1/1/2012\n7/4/2012\n9/3/2012 </pre>\n\n<p><strong>Ideal output:</strong></p>\n\n<pre>Date 1          Date 2           Holidays\n5/1/2012        5/4/2012         0\n8/31/2012       9/25/2012        1\n12/23/2011      1/10/2012        2</pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":12803894,"title":"SQL: Error while calculating two subselect columns","body":"<p>I know this is going to be another easy question for the SQL gurus since I'm sure I'm doing something wrong that is obvious. <strong>This is all for SQL Server 2000</strong> (inherited projects!)</p>\n\n<p>I have a query like</p>\n\n<pre><code>   SELECT (SELECT Price1 from Table1) AS 'PriceOne', \n(SELECT Price2 From Table2) AS 'PriceTwo', \nPriceTwo * PriceOne AS 'Total'\n</code></pre>\n\n<p>But this generates an error of an unrecognized column for PriceOne and PriceTwo. I'm assuming its possible to multiply columns in this way, right?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":4,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12803231,"title":"tsql IN not working properly if passed as parameter","body":"<p>I have a sitution where I need to pass a string in order to do an IN</p>\n\n<pre><code>    declare @searchString varchar(50)\n    set @searchString = ' ''Nestle'',''UFI'' '\n\n    select * from tbl1 where CompanyName IN (@SearchString) \n</code></pre>\n\n<p>does't work.</p>\n\n<p>But if I do:</p>\n\n<pre><code>    select * from tbl1 where CompanyName IN ('Nestle','UFI')\n</code></pre>\n\n<p>It works fine. I cannot understand why one work and the other doesn't</p>\n"},{"tags":["c#","tsql","sql-server-2000","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":103,"score":0,"question_id":12790511,"title":"Show salary history in a table format from a listing format?","body":"<p>I'm sure this won't be a difficult question for the hardcore SQL geeks, but I need some help. This is for SQL Server 2000 (inherited projects!).</p>\n\n<p>I have a table of salary listings that look like this:</p>\n\n<pre><code>EmployeeID  |  EffectiveDate  | Salary\n1           |   2/1/2011      | 500\n1           |   6/1/2011      | 600\n1           |   12/1/2011     | 650\n</code></pre>\n\n<p>I need to create a query that will output these salaries by month for a given year. So the output would be like</p>\n\n<pre><code>EmployeeID  | Jan | Feb | Mar | Apr | Apr | May | Jun | Jul | Aug | Sept | Oct | Nov | Dec\n1           | 500 | 500 | 500 | 500 | 500 | 500 | 600 | 600 | 600 | 600  | 600 | 600 | 650\n</code></pre>\n\n<p>I know there must be a way to do this effectively with SQL, I just can't seem to get it right. Obviously, I would be naming the month columns above with SQL such as \nSELECT EmployeeID, 'Jan' AS Jan, 'Feb' AS Feb, etc but the rest of the statement is harder since I'm looking for ranges.</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":12801308,"title":"TSQL get all orders that have specific code in history","body":"<p>I have a table that holds status changes for orders:</p>\n\n<pre><code>ORDER_ID  |  CHANGE_DATE      |  CODE_1  |  CODE_2  |  CODE_3\n=============================================================\n1         |  2012-09-01 12:20 |  Z1      |  NULL    |  NULL\n1         |  2012-09-01 12:21 |  Z2      |  S01     |  NULL\n1         |  2012-09-01 12:22 |  Z2      |  S04     |  NULL\n2         |  2012-09-01 12:22 |  Z1      |  S01     |  NULL\n3         |  2012-09-01 12:23 |  Z1      |  S03     |  NULL\n1         |  2012-09-01 12:24 |  Z1      |  S02     |  NULL\n2         |  2012-09-01 12:29 |  Z1      |  S05     |  NULL\n1         |  2012-09-01 13:29 |  Z5      |  T01     |  X01\n2         |  2012-09-01 13:31 |  Z1      |  T01     |  NULL\n</code></pre>\n\n<p>I need to select ORDER_ID for every order that has in history CODE_2 IN (S01,S02,S03) but don't have S04 and S05 after them.</p>\n\n<p>In this specific case query should return order 1 because after CODE_2 there is no S04 and S05, please notice that order 1 had S04 in history, but after that it had code S02.\nIt should also return order 3 because of code S03.\nOrder 2 shouldn't be returned because last code in his history is S05 (last from S group).</p>\n\n<p>Can I do this without joining to other table? I would like to select ORDER_ID only from this table.</p>\n"},{"tags":["sql","sql-server-2005","tsql","sql-server-2008","format"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":2511,"score":3,"question_id":6469683,"title":"Format() function doesn't work?","body":"<p>I am trying to execute following built-in function in sql but it gives me error that this  function doesn't exist </p>\n\n<p>my query:</p>\n\n<pre><code>select EmpId, EmpName, format(EmpJoinDate, \"YYYY-DD-MM\") as date from Employee\n</code></pre>\n\n<p>Error i am getting:</p>\n\n<pre><code>'format' is not a recognized built-in function name\n</code></pre>\n\n<p>What may be  the problem, or what am i doing wrong? </p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":98,"score":2,"question_id":12797963,"title":"Left Join is not working","body":"<p>I wrote following query </p>\n\n<pre><code>SELECT \n   us.Id as Id, us.Name as Name,\n   SUM(CASE WHEN c.isPublish = 0 THEN 1 ELSE 0 END) AS PendingCoupons,\n   SUM(CASE WHEN c.isPublish = 1 and convert(date,c.PublishedDate,101) &gt;=  convert(date, GETDATE(), 101) THEN 1 ELSE 0 END) AS ApprovedCouponsToday,\n   SUM(CASE WHEN c.isPublish = 0 and convert(date,c. CreateDate, 101) = convert(date, GETDATE(), 101) THEN 1 ELSE 0 END) AS PendingCouponsToday,\n   SUM(CASE WHEN c.isPublish = 1 THEN 1 ELSE 0 END) AS ApprovedCoupons,\n   SUM(CASE WHEN c.isPublish = 1 and c.Userid = us.Id and convert(date, c.PublishedDate, 101) &gt;= convert(date, GETDATE(), 101) THEN 1 ELSE 0 END) AS ApprovedByUserToday,\n   SUM(CASE WHEN c.isPublish = 1 and c.Userid = us.Id THEN 1 ELSE 0 END) AS ApprovedByUser,\n   SUM(CASE WHEN c.ReviewVerify = 1 and convert(date, c.PublishedDate, 101) &gt;= convert(date, GETDATE(), 101) THEN 1 ELSE 0 END) AS ProcessToday,\n   COUNT(*) AS Total\nFROM \n   Users AS us\nLEFT JOIN \n   Coupon c ON Userid = us.Id\nGROUP BY \n   us.Name , us.Id\n</code></pre>\n\n<p>and I have following two tables </p>\n\n<p><img src=\"http://i.stack.imgur.com/tWZdT.png\" alt=\"Tables\"></p>\n\n<p>and after running above query the result is always this </p>\n\n<p><img src=\"http://i.stack.imgur.com/ZpCAR.png\" alt=\"Result\"></p>\n\n<p>Is there any error in this query , because its always returning me count \" 0 \"  and I have almost 100 coupons on every user but its not showing </p>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":1,"view_count":611,"score":0,"question_id":6223838,"title":"How to convert rows values into column in sql server 2005","body":"<p>How to convert row into column.I have following result set.</p>\n\n<pre><code>UserID  VendorName  QuestionText AnswerText\n1         KK         abc1         ans1\n1         KK         abc2         ans2\n1         KK         abc3         ans3\n2         JJ         abc1         ans2\n2         JJ         abc2         ans3\n2         JJ         abc3         ans1   \n</code></pre>\n\n<p>OUTPUT should be:</p>\n\n<pre><code>UserID VendorName   abc1    abc2   abc3\n1             KK    ans1    ans2   ans3\n2             JJ    ans2    ans3   ans1\n</code></pre>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql","query","select-query"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":18106,"score":3,"question_id":1943892,"title":"SQL Server PRINT SELECT (Print a select query result)?","body":"<p>I am trying to print a selected value, is this possible?</p>\n\n<p>Example:</p>\n\n<pre><code>PRINT \n    SELECT SUM(Amount) FROM Expense\n</code></pre>\n"},{"tags":["c#","asp.net","sql","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12798483,"title":"how can i use sql skip and take like linq skip and take method?","body":"<p>i have listview data pager and i use objectdatasource for data. i connect sql directly without linq. But the problem is all data comes from my database.  when i click to datapager \"page 2\" data should come part by part.   is it possible ? </p>\n\n<pre><code>&lt;asp:DataPager ID=\"pagerPersonel\" PageSize=\"10\" PagedControlID=\"lstPersonel\" runat=\"server\"&gt;\n                &lt;Fields&gt;\n                    &lt;asp:NextPreviousPagerField ShowFirstPageButton=\"true\" ShowNextPageButton=\"false\"\n                        ShowPreviousPageButton=\"true\" PreviousPageText=\"Geri\" FirstPageText=\"lk Sayfa\"\n                        ButtonType=\"Link\" /&gt;\n                    &lt;asp:NumericPagerField ButtonCount=\"5\" ButtonType=\"Link\" CurrentPageLabelCssClass=\"current\" /&gt;\n                    &lt;asp:NextPreviousPagerField ShowFirstPageButton=\"false\" ShowNextPageButton=\"true\"\n                        ShowPreviousPageButton=\"false\" ShowLastPageButton=\"true\" LastPageText=\"Son Sayfa\"\n                        NextPageText=\"leri\" ButtonType=\"Link\" /&gt;\n                &lt;/Fields&gt;\n            &lt;/asp:DataPager&gt;\n\n &lt;asp:ObjectDataSource EnablePaging=\"True\" StartRowIndexParameterName=\"startRow\" MaximumRowsParameterName=\"maxRow\"\n        ID=\"osdPersonel\" runat=\"server\" SelectMethod=\"PersonelListesi\" SelectCountMethod=\"PersonelSayisi\"\n        TypeName=\"EtsTur.Model.Dao.PersonelDAO\"&gt;\n\n    &lt;/asp:ObjectDataSource&gt;\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2012"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":90,"score":4,"question_id":12792578,"title":"SELECT 5 most recent SQL Server","body":"<p>I have a table with records like this:</p>\n\n<pre><code>id        timestamp               dose             drug_id\n1     2012-10-04 09:10:54          05                 2\n1     2012-10-04 09:12:34          15                 2\n1     2012-10-04 09:15:12          20                 2\n1     2012-10-04 09:35:32          25                 2\n1     2012-10-04 09:37:34          25                 2\n1     2012-10-04 09:39:24          25                 2\n1     2012-10-04 09:42:16          35                 2\n1     2012-10-04 09:43:07          35                 2\n</code></pre>\n\n<p>What I want to do is select the last 5 used dose values for a given drug, so in this case the query should return <strong>35, 25, 20, 15, 05</strong>.</p>\n\n<p>I know I can use TOP and ORDER BY to get the latest 5 entries, but in this case it would return duplicates (35, 35, 25, 25, 25).</p>\n\n<p>What should I use to get the output I want?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":159,"score":0,"question_id":12795264,"title":"Alphanumeric and special character sorting in SQL Server 2008","body":"<pre><code>Select number \nfrom tableName \norder by Number\n</code></pre>\n\n<p>It displays like below</p>\n\n<pre><code>1\n10\n11\n14\n14A\n14AA\n19\n2\n20\n21\n</code></pre>\n\n<p>Instead it should display like below</p>\n\n<pre><code>1 \n2\n10\n11\n14\n14A\n14AA\n19\n20\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":71,"score":-1,"question_id":12791574,"title":"Stored procedure using loops not working","body":"<p>I have a proc which generates a trigger to catch insert operations and load into the audit table. It creates and prints the first set of parameters (Local variables declartion for new data) but when it comes to the step \"Local variable declartion for new data Decode\" it doesnt print anything. It works for fewer columns but if table has lot of columns then it doesnt work. </p>\n\n<pre><code>CREATE PROCEDURE [Log].[Generate_AuditTrigger_For_Insert]  'T_Referral|T_ReferralInsertAudit', 'Umesh', 'RTS', 'True' \n(\n    @TableNameARRAY VARCHAR(MAX),\n    @NAME VARCHAR(MAX),\n    @SCHEMA_NAME VARCHAR(100),\n    @UseConfiguredRecordIdentifier bit\n)\n\nAS\nBEGIN\n\n/* Tool Variables*/\nDECLARE @TableName VARCHAR(1000)\nDECLARE @TableDescription VARCHAR(1000)\nDECLARE @ColumnCount INT \nDECLARE @INCREMENT INT\nSET @INCREMENT = 5\nDECLARE @Counter INT \nDECLARE @StringColumn VARCHAR(1000)\nDECLARE @seprater CHAR(1)\nSET @seprater =','\nDECLARE @seprater_position INT, @seprater_pos int\nDECLARE @ARRAY_VALUE VARCHAR(1000)\nDECLARE @SQL NVARCHAR(1000)\nDECLARE @PARAMS NVARCHAR(1000)\nDECLARE @COMMENTS VARCHAR(1000)\n\nIF @TableNameARRAY &lt;&gt; '0'\n BEGIN\n   SET @TableNameARRAY = @TableNameARRAY + ','\n   WHILE PATINDEX('%,%', @TableNameARRAY) &lt;&gt; 0\n   BEGIN\n             SELECT @seprater_position = PATINDEX('%,%', @TableNameARRAY)\n             SELECT @ARRAY_VALUE = LEFT(@TableNameARRAY, @seprater_position-1)\n\n            /*---------------------------------------------------*/\n\n            SELECT @seprater_pos = PATINDEX('%|%', @ARRAY_VALUE)\n\n            SET @TableName = LEFT(@ARRAY_VALUE,@seprater_pos-1)\n            SET @TableDescription = STUFF(@ARRAY_VALUE, 1, @seprater_pos, '')\n            SET @Counter = 0\n            PRINT ''\n            PRINT 'GO'\n            PRINT 'IF  EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N''' + @SCHEMA_NAME + '.[trg' + @TableDescription + ']''))'\n            PRINT 'DROP TRIGGER [' + @SCHEMA_NAME + '].[trg' + @TableDescription + ']'\n            PRINT ''\n            PRINT 'GO'\n            PRINT ''\n            PRINT '/********************************************************************************'  \n            PRINT '*  Name          : trg' + @TableDescription\n            PRINT '*  Version       : 1.0'  \n            PRINT '*  Developer     : '   +@NAME\n            PRINT '*  Description   : Insert Audit Log Trigger'  \n            PRINT '*  Tables        : ' + @TableName  \n            PRINT '*  Views Used    : None'   \n            PRINT '*  Procedures    : None'  \n            PRINT '*  Functions     : None' \n            PRINT '*********************************************************************************'\n            PRINT '*                  Modification History'  \n            PRINT '*'  \n            PRINT '* DATE               NAME                NATURE OF CHANGES'  \n            PRINT '*--------------------------------------------------------------------------------'  \n            PRINT '* ' + CONVERT(VARCHAR(10), GETDATE(), 110) + '       ' + @NAME + '               Creation &amp; Initial Coding'    \n            PRINT '*'   \n            PRINT '*'\n            PRINT '*'\n            PRINT '*'\n            PRINT '*' \n            PRINT '*********************************************************************************/' \n            PRINT ''\n            PRINT 'CREATE TRIGGER [' + @SCHEMA_NAME + '].[trg' + @TableDescription + ']' \n            PRINT 'ON [' + @SCHEMA_NAME + '].[' + @TableName + ']'\n            PRINT 'AFTER  INSERT'\n            PRINT 'AS'\n            PRINT ''\n            PRINT 'BEGIN'\n            PRINT ''            \n            SELECT @SQL = N'SELECT @ColumnCount = (SELECT count(COLUMN_NAME) ' + \n                    N'FROM INFORMATION_SCHEMA.COLUMNS ' +\n                    N'WHERE TABLE_NAME = ''' + REPLACE(REPLACE(quotename(@TableName), '[', ''), ']', '') +\n                    N''');'         \n\n            SELECT @PARAMS = N'@ColumnCount int OUTPUT'\n            EXEC sp_executesql @SQL, @PARAMS, @ColumnCount = @ColumnCount OUTPUT\n\n            PRINT '     /*Local variable declartion for new data*/'\n            PRINT ''\n            DECLARE @CREATED_COL_COUNT INT\n            SET @CREATED_COL_COUNT = 0\n\n            WHILE @Counter &lt; (@ColumnCount + @INCREMENT)\n            BEGIN\n                Set @Counter = @Counter + 1\n                SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')\n\n                SET @CREATED_COL_COUNT = @CREATED_COL_COUNT + 1\n                PRINT '     DECLARE @NEW_' + @StringColumn + ' VARCHAR(1000)'\n\n            CONTINUE\n            END\n\n            PRINT ''    \n            PRINT '     /*Local variable declartion for new data Decode*/'    \n            SET @CREATED_COL_COUNT = 0    \n            SET @Counter = 0    \n\n            WHILE @CREATED_COL_COUNT &lt; (@ColumnCount)    \n\n            BEGIN    \n                Set @Counter = @Counter + 1    \n                SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')    \n                IF @StringColumn IS NOT NULL      \n                SET @CREATED_COL_COUNT = @CREATED_COL_COUNT + 1    \n\n                PRINT '     DECLARE @NEW_' + @StringColumn + '_DECODE_VALUE VARCHAR(1000)'    \n                CONTINUE    \n            END    \n\n\n            IF @CREATED_COL_COUNT &lt; @ColumnCount  \n            BEGIN\n                PRINT ''\n                PRINT '     RAISERROR ''ERROR IN COLUMN COUNT INCREMENT, PLEASE CHECK THE TRIGGER TOOL AND TRY AGAIN'''\n                PRINT ''\n            END\n            SET @Counter = 0\n            PRINT ''\n\n            PRINT ''    \n            PRINT '     /*Local variable declartion for new data decode value sql*/'    \n            SET @CREATED_COL_COUNT = 0    \n            SET @Counter = 0    \n\n            WHILE @CREATED_COL_COUNT &lt; (@ColumnCount)    \n\n            BEGIN    \n                Set @Counter = @Counter + 1    \n                SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')    \n                IF @StringColumn IS NOT NULL      \n                    SET @CREATED_COL_COUNT = @CREATED_COL_COUNT + 1    \n\n                PRINT '     DECLARE @NEW_' + @StringColumn + '_SQL NVARCHAR(1000)'    \n                CONTINUE    \n            END    \n\n            PRINT ''\n\n            SET NOCOUNT ON\n            DECLARE @COUNTER_TEST INT\n            SET @COUNTER_TEST =0\n\n            PRINT '     /*Local variable declartion*/'\n            PRINT ''\n            PRINT '     DECLARE @AuditLogActionTypeID  INT'\n            PRINT '     DECLARE @RecordIdentifierName NVARCHAR(100)'            \n            PRINT '     DECLARE @RecordIdentifierValue NVARCHAR(1000)'\n            PRINT '     DECLARE @ActionBy_UserId VARCHAR(25)'\n            PRINT '     DECLARE @COMMENTS VARCHAR(600)'\n            PRINT '     '\n            PRINT '     IF (SELECT COUNT(*) FROM INSERTED) &gt; 0 '\n            PRINT '     BEGIN'\n            PRINT '         /*Get new data from inserted table and assign into local variable*/'\n            PRINT '         SELECT'\n\n            SET @Counter = 0\n            WHILE @COUNTER_TEST &lt; (@ColumnCount) \n            BEGIN\n                Set @Counter = @Counter + 1\n                SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')\n\n                IF @StringColumn IS NOT NULL\n                SET @COUNTER_TEST = @COUNTER_TEST + 1\n\n                IF @COUNTER_TEST &lt; (@ColumnCount)    \n                    BEGIN    \n                        PRINT '             @NEW_' + @StringColumn + ' = CAST(' + @StringColumn + ' AS VARCHAR(1000)),'    \n                        IF EXISTS (SELECT * FROM [Log].AuditLogDecodeTableMapping WHERE SourceColumn = @StringColumn)    \n                        PRINT '             @NEW_' + @StringColumn + '_SQL = [Log].GenerateDynamicQuery(''' + @SCHEMA_NAME + '.' + @TableName + ''',''' + @StringColumn + ''', CAST(' + @StringColumn + ' AS VARCHAR(1000))),'    \n                        IF EXISTS (SELECT * from [Log].AuditSubCategory where AssociatedTable = @TableName AND RecordIdentifierName = @StringColumn) AND (@UseConfiguredRecordIdentifier = 'True')\n                            BEGIN\n                                PRINT '             @RecordIdentifierName = ''' + @StringColumn + ''','\n                                PRINT '             @RecordIdentifierValue = CAST(' + @StringColumn + ' AS VARCHAR(1000)),' \n                            END                     \n                    END    \n                ELSE    \n                    BEGIN    \n                        PRINT '             @NEW_' + @StringColumn + ' = CAST(' + @StringColumn + ' AS VARCHAR(1000))'    \n                        IF EXISTS (SELECT * FROM [Log].AuditLogDecodeTableMapping WHERE SourceColumn = @StringColumn)    \n                        PRINT '             @NEW_' + @StringColumn + '_SQL = [Log].GenerateDynamicQuery(''' + @SCHEMA_NAME + '.' + @TableName + ''',''' + @StringColumn + ''', CAST(' + @StringColumn + ' AS VARCHAR(1000))),'    \n                        IF EXISTS (SELECT * from [Log].AuditSubCategory where AssociatedTable = @TableName AND RecordIdentifierName = @StringColumn) AND (@UseConfiguredRecordIdentifier = 'True')\n                        BEGIN\n                            PRINT '             @RecordIdentifierName = ''' + @StringColumn + ''''  \n                            PRINT '             @RecordIdentifierValue  = CAST(' + @StringColumn + ' AS VARCHAR(1000))'     \n                        END                             \n                    END    \n\n            CONTINUE\n            END\n\n            PRINT '         FROM'\n            PRINT '             INSERTED'\n            PRINT ''\n            PRINT '     END'\n            PRINT '     '\n            PRINT '     DECLARE @CURRENT_USER_NAME VARCHAR(MAX) '\n            PRINT '     SET @CURRENT_USER_NAME  = suser_sname() '\n            PRINT '     DECLARE @USER_NAME VARCHAR(MAX) '\n            PRINT '     SET @USER_NAME = Substring(@CURRENT_USER_NAME, patindex(''%\\%'', @CURRENT_USER_NAME) + 1, LEN(@CURRENT_USER_NAME)) '\n            PRINT '     SELECT @ActionBy_UserId = @@SPID'\n            PRINT '     '\n            PRINT '     IF (@ActionBy_UserId IS NULL)'\n            PRINT '     BEGIN '\n            PRINT '         SET @ActionBy_UserId = ''-1'''\n            PRINT '     END '\n\n            SET  @COMMENTS = ' Column in ' +@SCHEMA_NAME+'.'+ @TableName +  ' table has been Inserted by user id '' +  @ActionBy_UserId + '''\n            PRINT '     SET  @COMMENTS = ''' + @COMMENTS  + ''''\n            PRINT ''\n            SET @Counter = 0\n            SET @COUNTER_TEST = 0\n\n            IF (@UseConfiguredRecordIdentifier = 'False')\n            BEGIN\n\n            /*Create TABLE #PRIMARYCOLUMNS(variable) to take resultset*/\n            CREATE TABLE #PRIMARYCOLUMNS ( ROWID INT IDENTITY(1, 1), COLUMN_NAME VARCHAR(1000))\n            DECLARE @COUNT INT\n            DECLARE @ROW INT\n            DECLARE @COLUMN_NAME VARCHAR(1000)  \n            DECLARE @COMMENTS_NAME VARCHAR(1000)\n            DECLARE @COMMENTS_DATA VARCHAR(1000)\n\n            SET @COMMENTS_NAME = ''\n            SET @COMMENTS_DATA = ''\n\n            /*taking primary column details as record in to #PRIMARYCOLUMNS(variable)Table*/\n            INSERT #PRIMARYCOLUMNS \n            SELECT c.name AS COLUMN_NAME\n            FROM sysindexes i\n            INNER JOIN sysobjects t ON i.id = t.id\n            INNER JOIN sysindexkeys k ON i.indid = k.indid AND i.id = k.ID\n            INNER JOIN syscolumns c ON c.id = t.id AND c.colid = k.colid\n            WHERE  \n                i.id = t.id AND i.indid BETWEEN 1 And 254 \n                AND (i.status &amp; 2048) = 2048\n                AND t.id = OBJECT_ID(@SCHEMA_NAME + '.' + @TableName)\n            ORDER BY \n            k.KeyNo\n\n            SET @COUNT = @@ROWCOUNT\n            SET @ROW = 1\n\n            /*looping through the Result set (#PRIMARYCOLUMNS)*/\n            WHILE @ROW &lt; @COUNT + 1\n            BEGIN\n\n                SELECT @COLUMN_NAME = COLUMN_NAME FROM #PRIMARYCOLUMNS WHERE ROWID = @ROW\n\n                SET @COMMENTS_NAME = @COMMENTS_NAME + @COLUMN_NAME \n                SET @COMMENTS_DATA = @COMMENTS_DATA + 'CAST(@NEW_' + @COLUMN_NAME + ' AS VARCHAR(1000))'\n\n                IF @ROW &lt; @COUNT \n                BEGIN\n                    SET @COMMENTS_NAME = @COMMENTS_NAME + ', '\n                    SET @COMMENTS_DATA = @COMMENTS_DATA + ' +'', ''+ '\n                    END\n                    SET @ROW = @ROW + 1\n                END\n\n                PRINT '     SET @RecordIdentifierName' + ' = ''' + @COMMENTS_NAME + ''''\n                PRINT '     SET @RecordIdentifierValue' + ' = ' + @COMMENTS_DATA + ''\n\n                DROP TABLE #PRIMARYCOLUMNS\n\n            END\n\n\n            PRINT '     /*Execute the SQL Statement to load decode value for New Data*/'\n            SET @CREATED_COL_COUNT = 0\n            SET @Counter = 0\n\n                WHILE @CREATED_COL_COUNT &lt; (@ColumnCount)\n\n                BEGIN\n                        Set @Counter = @Counter + 1\n                        SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')\n\n                IF @StringColumn IS NOT NULL  \n                    SET @CREATED_COL_COUNT = @CREATED_COL_COUNT + 1\n\n                IF EXISTS (SELECT * FROM [Log].AuditLogDecodeTableMapping WHERE SourceColumn = @StringColumn)\n                        PRINT '     EXEC sp_executesql @NEW_' + @StringColumn + '_SQL , N''@DecodedValue VARCHAR(MAX) OUTPUT' + ''', ' +  N'@DecodedValue ' + ' = ' + N'@NEW_' + @StringColumn + '_DECODE_VALUE ' + ' OUTPUT'\n                        CONTINUE\n                END\n            PRINT '     '\n            PRINT '     DECLARE @AuditSubCategoryID smallint '\n            PRINT '     SET @AuditSubCategoryID = NULL'\n            PRINT '     SELECT @AuditSubCategoryID = AuditSubCategoryID from [Log].AuditSubCategory where AssociatedTable = ''' + @TableName + ''''\n\n            PRINT ''\n\n            PRINT '     IF @AuditSubCategoryID IS NULL'\n            PRINT '     SET @AuditSubCategoryID = -1'\n            PRINT '     /*Get the Action Type Id from [Log].AuditLogActionType Table for Insert transaction*/'\n            PRINT '     SELECT @AuditLogActionTypeID  = ActionTypeId  FROM [Log].AuditLogActionType WHERE ActionTypeDesc = ''Insert'''\n            PRINT ''\n            SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')\n            PRINT '     Insert into [Log].AuditLogData  (TableName, ColumnName, RecordIdentifierName, RecordIdentifierValue, ActionBy_UserId, ActionDateTime, ActionType, Audit_Description, OldValue, OldValue_Decode, NewValue, NewValue_Decode, AuditSubCategoryID)'\n\n            SET @COUNTER_TEST = 0\n            SET @Counter = 0\n            WHILE @COUNTER_TEST &lt; (@ColumnCount)\n                    BEGIN\n                            Set @Counter = @Counter + 1\n                            SELECT @StringColumn = (SELECT COL_NAME(OBJECT_ID(@SCHEMA_NAME + '.' + @TableName), @Counter) AS 'Column Name')\n                IF @StringColumn IS NOT NULL\n\n                SET @COUNTER_TEST = @COUNTER_TEST + 1\n                IF @COUNTER_TEST &lt; (@ColumnCount)\n                PRINT '         SELECT '''+ @TableName + ''', '''+ @StringColumn + ''', @RecordIdentifierName, @RecordIdentifierValue, @ActionBy_UserId, GetDate(), @AuditLogActionTypeID , ''' + @StringColumn + ''' + @COMMENTS , null , null, CAST(@NEW_' + @StringColumn + ' AS VARCHAR(1000)), COALESCE(('''' + @NEW_' + @StringColumn+'_DECODE_VALUE + ''''), null' + '), @AuditSubCategoryID UNION ALL'\n\n                ELSE\n                PRINT '         SELECT '''+ @TableName + ''', '''+ @StringColumn + ''', @RecordIdentifierName, @RecordIdentifierValue, @ActionBy_UserId, GetDate(), @AuditLogActionTypeID , ''' + @StringColumn + ''' + @COMMENTS , null , null, CAST(@NEW_' + @StringColumn + ' AS VARCHAR(1000)), COALESCE(('''' + @NEW_' + @StringColumn+'_DECODE_VALUE + ''''), null' + '), @AuditSubCategoryID'\n            CONTINUE\n            END\n            PRINT ''            \n            PRINT 'END'             \n            PRINT ''\n\n            /*---------------------------------------------------*/\n             SELECT @TableNameARRAY = STUFF(@TableNameARRAY, 1, @seprater_position, '')\n  END\nEND\nPRINT           'GO'\n\nEND\n\nGO\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":11137,"score":1,"question_id":5572169,"title":"Convert Decimal to String in T-SQL","body":"<p>I have a decimal column in a table defined as decimal(8,3). I would like to include this column in a Select statement, convert it to a varchar and only display two decimal places. I can't seem to find the right combination of options to do this because everything I try still produces three decimal places.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":63,"score":1,"question_id":12792020,"title":"TSql Case within Case","body":"<p>I am trying to do a select statment in tsql with a case within a case. First is based on what the SearchField is. Next I need to do it based on the SearchOper. </p>\n\n<pre><code>    declare @searchField varchar(50)  \n    declare @searchString varchar(50)\n    declare @searchOper varchar(50)\n\n    case @searchField\n     when 'CompanyName' then\n        case @searchOper\n          when 'eq' then\n            select * from tbl1 where CompanyName = @searchString\n         when 'ne' then \n           select * from tbl1 where CompanyName &lt;&gt; @searchString\n         end\n     when 'StoreNum' then\n        case @searchOper\n          when 'eq' then\n             select * from tbl1 where StoreNum = @searchString\n          when  'ne' then\n             select * from tbl1 where StoreNum &lt;&gt; @searchString\n        end \n     end \n</code></pre>\n\n<p>Note what I am trying to do is within the case statement do a select.</p>\n\n<p>I get a message saying Incorrect syntax near the keyword 'case'. </p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12793774,"title":"(Serial Column) Filtering SQL Query and shortening the results to Range","body":"<p>For example, i have column tables pallet_id and serial</p>\n\n<p>I would like to query them from</p>\n\n<pre><code>pallet_id       serial \nPA1             161\nPA1             163\nPA1             164\nPA1             165\nPA1             166\nPA1             177\nPA1             178\nPA1             179\n</code></pre>\n\n<p>to    </p>\n\n<pre><code>pallet_id       serial \nPA1             161-161\nPA1             163-166\nPA1             177-179\n</code></pre>\n\n<p>serials are incremented by 1 needs to stick as a range group</p>\n\n<p>I just using Views as of the moment. If there is another way to do this without resulting to stored procedure, please do advise.</p>\n\n<p>I am developing the SP now because I can't find another way.</p>\n\n<p>USING MSSQL2000 or lower.. 6.5? as it says here  .. so no functions in this SQL Version. Upgrading is not an option too.</p>\n"},{"tags":["sql","tsql","pivot"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":2928266,"title":"PIVOT not performing as expected","body":"<p>Sorry for an unclear question previously; hopefully I can start again...</p>\n\n<p>I have this data:</p>\n\n<pre><code>entityid    name                 stringvalue\n----------- -------------------- --------------------\n1           ShortDescription     Coal\n1           LongDescription      BlackCoal\n1           ShortDescription     Gold\n1           LongDescription      WhiteGold\n1           ShortDescription     Steel\n1           LongDescription      StainlessSteel\n</code></pre>\n\n<p>And this query:</p>\n\n<pre><code>select *\nfrom\n(\n    select entityid, name, stringvalue as stringvalue\n    from mytable\n) as d\npivot\n(\n    min([stringvalue])\n    for [name] in ([ShortDescription],[LongDescription])\n)\nas p\n</code></pre>\n\n<p>Producing this output:</p>\n\n<pre><code>entityid ShortDescription LongDescription\n-------- ---------------- ---------------\n1        Coal             BlackCoal\n</code></pre>\n\n<p>Could someone tell me why the other rows are not being produced, please?  I was expecting to see:</p>\n\n<pre><code>entityid ShortDescription LongDescription\n-------- ---------------- ---------------\n1        Coal             BlackCoal\n1        Gold             WhiteGold\n1        Steel            StainlessSteel\n</code></pre>\n"},{"tags":["tsql","table","pivot"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":2799,"score":2,"question_id":2922797,"title":"T-SQL Pivot? Possibility of creating table columns from row values","body":"<p>Is it actually possible to rotate a T-SQL (2005) so that (for the sake of argument) the values of the first column's rows become the titles of the output table's columns?</p>\n\n<p>I realise this is not really what PIVOT is for, but it's what I need - the ability to request a table where the columns are not known before-hand because they have been entered as values into a table.</p>\n\n<p>Even a hack would be nice, tbh.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":12790024,"title":"Backup failed in stored procedure","body":"<p>If I am using <code>BACKUP</code> statement:</p>\n\n<pre><code>BACKUP DATABASE [Database name]\nTO DISK = Location\nWITH INIT, NOSKIP, NOFORMAT\n</code></pre>\n\n<p>Backup did work. But if I am trying to use same query in a stored procedure like </p>\n\n<pre><code>SET @SQLCMD = N'BACKUP DATABASE [Database Name] TO DISK = ''' + @FILENAME + ''' WITH INIT,NOSKIP, NOFORMAT' \n\nEXEC (@SQLCMD)\n</code></pre>\n\n<p>I am getting error message:  </p>\n\n<blockquote>\n  <p>Msg 203, Level 16, State 2, Procedure sp_BackupDatabase, Line 31<br>\n  The name 'BACKUP DATABASE [Database Name] TO DISK =\n  'C:\\Users\\PC\\Desktop\\Backup\\20121008\\db.bak' WITH INIT,NOSKIP,\n  NOFORMAT' is not a valid identifier.</p>\n</blockquote>\n\n<p>I couldn't figure out where I am making error.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","syntax-error"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":12791793,"title":"SQL Syntax error on final REBUILD WITH ()","body":"<p>Any idea how to make this syntax error go away? It's on the final paranthesis of the whole procedure. I can't seem to figure out what it is I'm missing. No other errors occur when I try to run it. </p>\n\n<pre><code>CREATE PROCEDURE pRebuildOrReorg\n(\n    @db VARCHAR(50) =  'AdventureWorksLT2012',\n    @table VARCHAR(50) = 'SalesLT.Customer',\n    @indexName VARCHAR(50) = 'IX_Customer_EmailAddress'\n)\nAS \nDECLARE @objID INT\nDECLARE @dbID SMALLINT\nDECLARE @indexID SMALLINT\nDECLARE @avgFrag INT\nDECLARE @cmd VARCHAR(100)\nDECLARE @message VARCHAR(100)\n\n-- 1. find the object id of the desired table\nSET @objID = OBJECT_ID(@table)\nSET @dbID = DB_ID(@db)\nSET @IndexID = (SELECT index_id FROM sys.indexes WHERE name = @indexName)\n-- 2. View the statistics for all indexes of the table\nSELECT @avgFrag = avg_fragmentation_in_percent\nFROM sys.dm_db_index_physical_stats(DB_ID('AdventureWorksLT2012'),\n  OBJECT_ID('SalesLT.Customer'),\n @IndexID, NULL , 'DETAILED')\n\nif @avgFrag &gt;= 30\nBEGIN SET @cmd = 'ALTER INDEX ' + @indexName + ' ON ' + @table + ' STATISTICS_NORECOMPUTE = OFF)' \nEXEC (@cmd) \nSET @message = 'Reorganized Index ' + @indexName\nALTER INDEX PK_StoreContact_CustomerID_ContactID\n  ON AdventureWorks.Sales.StoreContact\nREORGANIZE \nEND\n\nelse if @avgFrag &lt; 30\nBEGIN SET @cmd = 'ALTER INDEX ' + @indexName + ' ON ' + @table + ' STATISTICS_NORECOMPUTE = OFF)' \nEXEC (@cmd) \nSET @message = 'Rebuilt Index ' + @indexName\nALTER INDEX IX_StoreContact_ContactID\n  ON AdventureWorks.Sales.StoreContact\nREBUILD WITH(\nfillfactor = 70,\nonline = ON\n)\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005","sql-server-2005-express"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":53,"score":-1,"question_id":12790139,"title":"SQL server column alias from another query","body":"<p>Why does this code not work in SQL Server 2005?</p>\n\n<pre><code>select c.price AS (select CityName from Cities ci where ci.cityid= c.cityid)\nfrom prices c\nwhere cityid=1\n</code></pre>\n\n<p>Thanks.</p>\n"},{"tags":["sql","tsql","sql-azure"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":37,"score":2,"question_id":12789901,"title":"How to convert T-SQL that deals with OPENXML, WITH and BIGINT?","body":"<p>I'm trying to convert a procedure to use in SQL Azure. I first got an error on <code>OPENXML</code> saying it's not supported on SQL Azure, then I find out it can be replaced with <code>nodes</code>.</p>\n\n<p>But I'm not sure how to convert the <code>WITH (Id BIGINT '.')</code> part. I know <code>WITH</code> creates a subquery but what is the <code>'.'</code> doing here?</p>\n\n<pre><code>CREATE Procedure [dbo].[DocsR]\n    @ids    xml     -- &lt;Ids&gt;&lt;Id&gt;1&lt;/Id&gt;&lt;Id&gt;2&lt;/Id&gt;&lt;/Ids&gt;\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    DECLARE @IdsXml xml \n    exec sp_xml_preparedocument @IdsXml OUTPUT, @Ids\n\n    SELECT\n        DoctId,\n        DocNm\n    FROM\n        Docs\n    WHERE\n        --DocId IN (SELECT Id FROM OPENXML(@IdsXml, '/Ids/Id', 2) WITH (Id BIGINT '.'))\n          DocId IN (SELECT Id FROM @IdsXml.nodes('/Ids/Id') WITH (Id BIGINT '.'))\nEND\nGO\n</code></pre>\n\n<p>Error:</p>\n\n<pre><code>Incorrect syntax near the keyword 'with'. If this statement is a common \ntable expression, an xmlnamespaces clause or a change tracking context clause, \nthe previous statement must be terminated with a semicolon.\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":78,"score":-2,"question_id":12783810,"title":"T SQL- Use Results of One Query as a variable for Other Query","body":"<p>I have written this query; I need help in assigning variable; which is coming from other query, How can I do that. </p>\n\n<p>How can I combine them together?</p>\n\n<p>Query 1</p>\n\n<pre><code>Select SUM(Credit)\nFROM(SELECT TOP 1  Credit\nFROM (SELECT DISTINCT TOP 2 Ref, Credit, PaymentID \nFROM  Payment where  Ref =  '????'  AND PaymentID &lt;= '????' \nORDER BY PaymentID DESC)\na ORDER BY PaymentID)\nb\n</code></pre>\n\n<p>Query 2</p>\n\n<pre><code>Select Ref, PaymentID \nFrom Payment\nWhere PaymentDate = '2012-09-23'\n</code></pre>\n\n<p>SO I need Ref and PaymentID of Query 2 and use as variable in Query 1</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","auto-increment"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":4689,"score":3,"question_id":4810627,"title":"SQL Server 2005 ROW_NUMBER() without OVER","body":"<p>I am trying to insert from one table into another using</p>\n\n<pre><code>DECLARE @IDOffset int;\nSELECT @IDOffset = MAX(ISNULL(ID,0)) FROM TargetTable\n\nINSERT INTO TargetTable(ID, FIELD)\nSELECT [Increment] + @IDOffset ,FeildValue\nFROM SourceTable\nWHERE [somecondition]\n</code></pre>\n\n<p>TargetTable.ID is not an identity column, which is why I have to find a way to auto-increment it myself. </p>\n\n<p>I know I can use a cursor, or create a table variable with an identity column and a FieldValue field, populate that, then use it in my <code>insert into...select</code>, but that is not very efficient. I tried using the ROW_NUMBER function to increment, but I really don't have a legitimate ORDER BY field in the SourceTable that I can use, and would like to keep the original order of the SourceTable (if possible).</p>\n\n<p>Can anyone suggest anything?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":12788635,"title":"How can I efficiently update a table based on other rows?","body":"<p>I have a table with this column (among others):</p>\n\n<pre><code>id int identity(1,1) not null\n</code></pre>\n\n<p>I've added a column to store the approximate date the record was inserted:</p>\n\n<pre><code>insertdate smalldatetime null\n</code></pre>\n\n<p>I've filled in the <code>insertdate</code> where I can using the earliest reference found in forensic searches of related tables and logs. This does, however, leave a number of NULL \"gaps\" in the data, as well as situations where a record with a lower ID number has a more recent <code>insertdate</code> value than subsequent ID values.</p>\n\n<p>The <code>identity</code> attribute provides an adequate basis to assume that a record must have been created before any record with a higher <code>ID</code> value, so I've decided to update the <code>insertdate</code> for any record where it is null or a subsequent ID has an earlier date:</p>\n\n<pre><code>UPDATE\ntable\nSET\ninsertdate = (SELECT MIN(insertdate) \n      FROM table t2\n      WHERE\n        t2.id &gt;= table.id \n        AND t2.insertdate IS NOT NULL\n      )\n</code></pre>\n\n<p>Unfortunately, updating like this is eating the server's lunch... 1 hour and counting for 2.5 million records.</p>\n\n<p>Any ideas for how to do this more efficiently?</p>\n\n<p>It only needs to be done once, but this is a production server, so I'd prefer to not lock up the table for any longer than necessary.</p>\n"},{"tags":["tsql","case","where-clause"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":2141,"score":0,"question_id":2006242,"title":"using CASE in T-SQL in the where clause?","body":"<p>Im trying to use case to vary the value im checking in a where clause but I'm getting the error:</p>\n\n<p>incorrect syntax near the keyword 'CASE'</p>\n\n<p>SQL Server 2005</p>\n\n<pre><code>select * \nfrom   table\nwhere  ((CASE when adsl_order_id like '95037%'\n         then select '000000'+substring(adsl_order_id,6,6)\n         ELSE select adsl_order_id\n       END)\n       not in (select mwebID from tmp_csv_dawis_bruger0105)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","datetime"],"answer_count":2,"favorite_count":2,"up_vote_count":3,"down_vote_count":1,"view_count":6734,"score":2,"question_id":6064674,"title":"SQL Server 2008 - How to convert GMT(UTC) datetime to local datetime?","body":"<p>I have an insert proc that passes in <code>GETDATE()</code> as one of the values because each insert also stores when it was inserted. This is hosted on SQL Azure - which uses GMT.</p>\n\n<p>Now, when I am receiving messages, I have the GMT date stored for each of them in their timestamp columns, how do I convert this to the local <code>datetime</code> for wherever you are when you are accessing my page? </p>\n\n<p>Thanks.</p>\n"},{"tags":["xml","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12788813,"title":"Post XML data to a URL in TSQL","body":"<p>I have some lead data which I need to post to a URL in XML format. Since lead data need to be posted after some calculations, I want to post within from TSQL. </p>\n\n<pre><code>&lt;LeadID&gt;1142637&lt;/LeadID&gt;\n&lt;LeadType&gt;2&lt;/LeadType&gt;\n&lt;DateCreated&gt;2012-05-08T13:13:59.103&lt;/DateCreated&gt;\n&lt;FirstName&gt;test&lt;/FirstName&gt;&lt;LastName&gt;name&lt;/LastName&gt;\n</code></pre>\n\n<p>I was able to convert Table join data to XML in TSQL as shown above but now I am stuck with posting this to 3rd party URL from TSQL. </p>\n\n<p>Can someone with this knowledge help me please?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":99,"score":2,"question_id":12784854,"title":"What are the differences between these?","body":"<p>What are the differences between the two queries?</p>\n\n<pre><code>   SELECT     CountryMaster.Id\n   FROM       Districts INNER JOIN\n   CountryMaster ON Districts.CountryId = CountryMaster.Id\n\n   SELECT     CountryMaster.Id\n   FROM       CountryMaster INNER JOIN\n   Districts ON Districts.CountryId = CountryMaster.Id  \n</code></pre>\n\n<p>Please mind the \ni) Table positions and second\nii) On Fields</p>\n\n<p>As I know, output will be same. But I  want to know, is there any drastic effects of the same if I neglect positions of tables and columns in complex queries or tables having tons of data like thousands and lakhs of rows...</p>\n"},{"tags":["java","sql","sql-server","tsql","cursor"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":825,"score":2,"question_id":6735719,"title":"A cursor with the name ... already exists - SQL Server 2008","body":"<p>I have a trigger that is used to perform some auditing tasks when changes are made to a table. Within this trigger there is a WHILE loop, and in the loop there is a cursor that is declared, used, closed and then deallocated before the next iteration of the loop.</p>\n\n<p>When I call a stored procedure that changes the table and in turn causes the trigger to run, and I do this from within the Management Studio, all works as expected.</p>\n\n<p>However, when this stored procedure is called from within my Java web application, I get an error: \"A cursor with the name ...  already exists\".</p>\n\n<p>Is there a reason why this stored procedure would work when I execute it manually, and not work when run from the web application?</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12788156,"title":"Within the Stored Procedure pass the array into a table valued Function for parsing","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/2091830/cannot-find-either-column-dbo-or-the-user-defined-function-or-aggregate-dbo-s\">Cannot find either column &ldquo;dbo&rdquo; or the user-defined function or aggregate &ldquo;dbo.Splitfn&rdquo;, or the name is ambiguous</a>  </p>\n</blockquote>\n\n\n\n<p>--function that parses an array based on any delimiter</p>\n\n<pre><code>CREATE FUNCTION valuedfunction\n(\n    @string VARCHAR(MAX),\n    @delimiter CHAR(1)\n)\nRETURNS @output TABLE(\n    data VARCHAR(256)\n)\nBEGIN\n\n    DECLARE @start INT, @end INT\n    SELECT @start = 1, @end = CHARINDEX(@delimiter, @string)\n\n    WHILE @start &lt; LEN(@string) + 1 BEGIN\n        IF @end = 0 \n            SET @end = LEN(@string) + 1\n\n        INSERT INTO @output (data) \n        VALUES(SUBSTRING(@string, @start, @end - @start))\n        SET @start = @end + 1\n        SET @end = CHARINDEX(@delimiter, @string, @start)\n    END\n\n    RETURN\n\nEND\n</code></pre>\n\n<p>--stored procedure that supports a comma separated value list of employee IDs.  I use the function ---(valuedfunction) to get the employee data.</p>\n\n<pre><code>CREATE PROCEDURE commaseparated  \n@keyList varchar(40) \nAS \nSELECT Title, Birthdate \nFROM HumanResources.Employee WITH (NOLOCK) \nWHERE EmployeeID IN (dbo.valuedfunction(@keyList))  \n</code></pre>\n\n<p>--This is the problem:  I am getting errors below:  What am I missing<br>\n    exec commaseparated '10,11,12,13'; </p>\n\n<p>--ERROR MESSAGE:\nMsg 4121, Level 16, State 1, Procedure commaseparated, Line 4\nCannot find either column \"dbo\" or the user-defined function or aggregate \"dbo.valuedfunction\", or the name is ambiguous.</p>\n"},{"tags":["tsql","exception-handling"],"answer_count":5,"favorite_count":1,"up_vote_count":7,"down_vote_count":0,"view_count":5629,"score":7,"question_id":1673892,"title":"Is there an equivalent in T-SQL to C#'s \"throw;\" to re-throw exceptions?","body":"<p>The title really is the question for this one: Is there an equivalent in T-SQL to C#'s \"throw;\" to re-throw exceptions?</p>\n\n<p>In C# one can do this:</p>\n\n<pre><code>try\n{\n    DoSomethingThatMightThrowAnException();\n}\ncatch (Exception ex)\n{\n    // Do something with the exception\n    throw; // Re-throw it as-is.\n}\n</code></pre>\n\n<p>Is there something in T-SQL's <code>BEGIN CATCH</code> functionality that does the same?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","nolock"],"answer_count":6,"favorite_count":8,"up_vote_count":41,"down_vote_count":0,"view_count":25324,"score":41,"question_id":1452996,"title":"Is the NOLOCK (Sql Server hint) bad practice?","body":"<p>I'm in the business of making website and applications that are <em>not</em> mission critical -> eg. banking software, space flight, intensive care monitoring application, etc. You get the idea.</p>\n\n<p>So, with that massive disclaimer, is it bad using the NOLOCK hint in some Sql statement? A number of years ago, it was suggested by a fellow Sql Administrator that I should use NOLOCK if I'm happy with a <code>dirty read</code> .. which will give me a bit more performance out of my system because each read doesn't lock the table/row/whatever.</p>\n\n<p>I was also told that it's a great solution if I'm experiencing <code>dead-locks</code> (cringe). So, I started following that thought for a few years until a Sql guru was helping me with some random code and noticed all the NOLOCKS in my sql code. I was politely scolded and he tried to explain it to me (why it's not a good thing) and I sorta got lost :( I felt that the essence of his explanation was 'it's a band-aid solution to a more serious problem .. especially if you're experiencing deadlocking. As such, fix the root of the problem`. </p>\n\n<p>I did some googling recently about it and came across <a href=\"http://blogs.msdn.com/davidlean/archive/2009/04/06/sql-server-nolock-hint-other-poor-ideas.aspx\" rel=\"nofollow\">this post</a>.</p>\n\n<p>So, can some sql db guru sensei's please enlighten me? Be nice .. I'm blond :( so take it slowly, kind sir/madam.</p>\n\n<p>cheers :)</p>\n"},{"tags":["sql","xml","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":12786865,"title":"Concatenate XML variables in SQL Server","body":"<p>I have a query in a stored procedure retrieving some data in XML format to be returned in a variable <code>@xml_data</code>, like this:</p>\n\n<pre><code>SELECT @xml_data = (\n    SELECT * FROM (\n        SELECT   1 AS Tag\n                ,0 AS Parent\n                .....\n        FROM    MyTable\n        WHERE   id = @id\n\n        UNION ALL\n\n        SELECT   2 AS Tag\n                ,1 AS Parent\n                ....\n        FROM    MyTable2\n        WHERE   id = @id\n\n        UNION ALL\n\n        SELECT   3 AS Tag\n                ,2 AS Parent\n                ....\n        FROM    MyTable3\n        WHERE   id = @id\n    ) results\nFOR XML EXPLICIT, TYPE)\n</code></pre>\n\n<p>This is working like the proverbial dream :)</p>\n\n<p>However, I'd like to concatenate a header to this XML (e.g. <code>&lt;xml version=\"1.0\" encoding=\"ISO-8859-1\"/&gt;</code>) and can't figure out how to do it. I've tried converting to <code>NVARCHAR</code>, selecting the two variables in one statement but can't seem to get it right. </p>\n\n<p>Can anyone help??</p>\n\n<p>Thanks :)</p>\n"},{"tags":["xml","tsql","sql-server-2008-r2","xquery","scope-identity"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12785667,"title":"T-SQL: scope_identity() misassigned on xml node parsing","body":"<p>Techies--\nI'm shredding through an Xml object without any issues on picking up the correct elements for the correct nodes, however I need to properly update a detail identifier, which is holding on to a single value, when what I really need it to do is refresh that value with the value it just wrote.  I like the efficiency  of the current shredding process--so\nI don't want to lose that by coming up with a foolish solution.  Please advise me on the best approach on how to fix this logic. </p>\n\n<p>Here's what's happening:</p>\n\n<pre><code>  -- Given:\n  -- @OrderXml  is an incoming, populated order containg the header, \n                -- subheaders and    detail records\n\n  -- This logic succeeds\n  -- step #1: write the header  row in the header table \n  insert into [order].OrderHeader\n  ( col.cone,\n    col.ctwo)\n  select\n   Order.detail.value('(cone/text())[1]','varchar(2)'),\n   Order.detail.value('(ctwo/text()) [1]','varchar(2)')\n    from @OrderXml.nodes('/Order') as Order(detail)\n\n  select @OrderId = scope_identity()\n\n  -- This logic succeeds\n  -- step #2: write the subheader rows in the subheader table\n\n insert into [order].OrderSubHeader\n(col.OrderId,\n col.xone,\n col.xtwo)\nselect\n@OrderId,        -- this works, because no matter how many subheader rows\n                -- get generated, the same order id needs to be associated with it.\n\nOrderSub.detail.value('(xone/text())[1]','varchar(2)'),\nOrderSub.detail.value('(xtwo/text()) [1]','varchar(2)')\nfrom @OrderXml.nodes('/Order/SubHeader'') as OrderSub(detail)\n\nSELECT @OrderSubId = SCOPE_IDENTITY()\n\n\n-- This logic FAILS\n-- step #3: write the detail rows in the detail table\n\ninsert into [order].OrderDetail\n(col.OrderId,\n col.OrderSubId,  \n col.yone,\n col.ytwo)\n  select\n   @OrderId,        -- this is correct\n   @OrderSubId,     -- this is WRONG when there are multiples\n   OrderDet.detail.value('(yone/text())[1]','varchar(2)'),\n   OrderDet.detail.value('(ytwo/text()) [1]','varchar(2)')\n  from @OrderXml.nodes('/Order/SubHeader/Detail'') as OrderDet(detail)\n</code></pre>\n"},{"tags":["sql","tsql","join","sql-update"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":12785446,"title":"Update join not updating the same number of rows as equivelant select","body":"<p>When I run this SELECT statement, I receive 642 rows...</p>\n\n<pre><code>SELECT *\nFROM _DevLoadIn a\nJOIN ArticleCompanyList b ON b.Company = a.Name\n</code></pre>\n\n<p>When I run this UPDATE statement, only 630 rows are updated...</p>\n\n<pre><code>UPDATE b\nSET b.BGCompanyId = a.RelatedId\nFROM _DevLoadIn a\nJOIN ArticleCompanyList b ON b.Company = a.Name\n</code></pre>\n\n<p>The JOIN is identical, so how can the number of effected rows be different?  Both statements execute without error.  I don't see how this could be possible.  Can anyone provide any insight?  Am I missing something about how an update/join works?</p>\n"},{"tags":["sql","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":96,"score":3,"question_id":12754663,"title":"Fixing my SQL Query View","body":"<p>I've got a query that I am trying to write that displays the MOST RECENT <strong>StatusID</strong> data from the Action table.</p>\n\n<p>Here's what my database looks like (Screenshot from SQL Server 2008):</p>\n\n<p><img src=\"http://i.stack.imgur.com/udMGt.png\" alt=\"screenshot\"></p>\n\n<p>From my sample data, you can see that the Action table contains two (2) entries for <code>RequestID</code> #26. I only want to display the most recent <code>StatusID</code> value (based on the <code>DateStamp</code> field).</p>\n\n<p><img src=\"http://i.stack.imgur.com/xwvsX.png\" alt=\"screenshot2\"></p>\n\n<p>I have created a View for my database. It is nasty looking, and bumps up onto my SQL writing ability.</p>\n\n<pre><code>SELECT\n  P.ID AS PacketID, R.ID AS RequestID, A.ID AS ActionID, A.EmpID, P.DateStamp,\n  RQ.Description AS RequestType, L.Description AS Line, R.PartNo, R.Workorder,\n  R.Qty, RZ.Description AS ReasonType, R.MTF, S.Description AS Status\nFROM Packet AS P\n  LEFT OUTER JOIN Request AS R ON R.PacketID = P.ID\n  INNER JOIN Action AS A ON A.RequestID = R.ID\n  INNER JOIN RequestType AS RQ ON R.RequestTypeID = RQ.ID\n  INNER JOIN Line AS L ON R.LineID = L.ID\n  INNER JOIN ReasonType AS RZ ON R.ReasonTypeID = RZ.ID\n  INNER JOIN Status AS S ON A.StatusID = S.ID\n</code></pre>\n\n<p>This View, however, is showing <strong>ALL</strong> of the values, and I need it to somehow only pull the most recent row for any given Action.</p>\n\n<p>How would I modify my View to do this?</p>\n"},{"tags":["sql","sql-server","tsql","query","syntax"],"answer_count":10,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":8257,"score":4,"question_id":497241,"title":"How do I perform a GROUP BY on an aliased column in MS-SQL Server?","body":"<p>I'm trying to perform a <em>group by</em> action on an aliased column (example below) but can't determine the proper syntax.</p>\n\n<pre><code>SELECT       LastName + ', ' + FirstName AS 'FullName'\nFROM         customers\nGROUP BY     'FullName'\n</code></pre>\n\n<p>What is the correct syntax?</p>\n\n<p><hr />\n<strong>EDIT</strong></p>\n\n<p>Extending the question further (I had not expected the answers I had received) would the solution still apply for a CASEed aliased column?</p>\n\n<pre><code>SELECT       \n    CASE\n        WHEN LastName IS NULL THEN FirstName\n        WHEN LastName IS NOT NULL THEN LastName + ', ' + FirstName\n    END AS 'FullName'\nFROM         customers\nGROUP BY     \n    LastName, FirstName\n</code></pre>\n\n<p>And the answer is yes it does still apply.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":150,"score":2,"question_id":12578119,"title":"SQL Server Fixed number of rows per recordID","body":"<p>I have 2 tables, <strong>Product</strong> and <strong>Pricing</strong>. Table <strong>Product</strong> is the parent table whereas <strong>Pricing</strong> is the child table. When I query table B using foreign keys from Product, I would like to generate exactly 11 rows for each foreign key, with or without data(null-fill all empty rows and columns)</p>\n\n<p>Below is sample of what I have so far. Does not work right but essentially my goal is to, for each ProductID, generate 11 rows, fill the empty row columns with null values </p>\n\n<pre><code>SELECT TOP 11\n   row_number() over(order by TheCount desc) AS row_num,  PRODID,  packageID\nFROM\n    (\n    select count(*) AS TheCount , PRODID ,max(PricingID) AS packageID\n    from \n       Product left  outer  join   Pricing on PRODID = ProductID \n    group by PRODID\n    UNION ALL\n    SELECT TOP 11 -1, NULL, NULL, NULL, NULL, NUK\n    FROM sys.columns\n    ) T\n</code></pre>\n\n<p>Eg </p>\n\n<pre><code> row_num        PRODID                                    PRICINGID                               COSBeginQty          COSColCode   COSTrade  COSTypeOfPrice  COSIsActive \n   1              A10D8642-F6DA-499E-9FC9-024FED104877      F82F533E-C1A0-4DC5-BB2C-06FFF2E59C18        2                 NULL              T2        A              1\n   2              A10D8642-F6DA-499E-9FC9-024FED104877      372E6B36-F9D1-4EFA-8A15-08CE673EFFBA        12                NULL              T1        A              1\n   3              A10D8642-F6DA-499E-9FC9-024FED104877      45E77A6F-DC2A-44BF-B6AE-0BE27BD2205F        7                 NULL              T2        A              1\n   4              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   5              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   6              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   7              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   8              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   9              A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   10             A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n   11             A10D8642-F6DA-499E-9FC9-024FED104877              NULL                                NULL              NULL              NULL      NULL       NULL\n</code></pre>\n\n<p>Here is a <a href=\"http://sqlfiddle.com/#!3/c7ca0/2\" rel=\"nofollow\"><em>SQLFiddle</em></a> Link that shows data and a working query that I am working to extend so that it extends to the 11th, i.e. displays 11 rows as columns. </p>\n\n<p>Using Damiens sample code, I have been able to put together the code below. It works to crossapply the elements from the product table to the Pricing table, however, I prefer a case where it does not apply the same PricingID to all of the ProductIDs from the product Table but to only that particular ProductId that the pricing record applies to. </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":8,"view_count":47,"score":-6,"question_id":12784392,"title":"\"Show table\" equivalent syntax","body":"<p>I need to do the equivalent of</p>\n\n<pre><code>SHOW TABLES LIKE 'ka_product_import'\n</code></pre>\n\n<p>in SQL Server 2008. How can I do this?</p>\n"},{"tags":["sql-server","tsql","spatial-index"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":46,"score":2,"question_id":12772012,"title":"Query on spatial index not responding","body":"<p>I have a database sitting on a SQL Server 2008 with ~12 billion rows that all contain lat, lon and a corresponding geography fields. I recently needed to add the ability to query on the geography field. I added spatial index, which took 6 days to process over 4TB of data.</p>\n\n<pre><code>CREATE SPATIAL INDEX IX_Location_Geo ON Location\n(\n    Geo\n) USING  GEOGRAPHY_GRID \nWITH (\n    GRIDS =(LEVEL_1 = MEDIUM,LEVEL_2 = MEDIUM,LEVEL_3 = MEDIUM,LEVEL_4 = MEDIUM), \n    CELLS_PER_OBJECT = 16, PAD_INDEX  = OFF, SORT_IN_TEMPDB = OFF, \n    DROP_EXISTING = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON PRIMARY\nGO\n</code></pre>\n\n<p>Add intended using a query as such...</p>\n\n<pre><code>SELECT TOP 100 \n    ci.LocationID, ci.Geo.STDistance(@g)  \nFROM Location ci WITH(INDEX(IX_Location_Geo))\nWHERE ci.Geo.Filter(@region) = 1 \nORDER BY ci.Geo.STDistance(@g)\n</code></pre>\n\n<p>Here's the estimate execution plan...</p>\n\n<p><img src=\"http://i.stack.imgur.com/I1ty1.png\" alt=\"Execution Plan\"></p>\n\n<p>I tested this query on sample set of 100 mill rows, and it worked splendidly. But on 12 bill rows the query does not respond after ~4 hours and finally fails with a disk write error, which is strange because the disk has 5TB unused.</p>\n\n<pre><code>Msg 1101, Level 17, State 10, Line 4 Could not allocate a new page \nfor database 'TEMPDB' because of insufficient disk space in filegroup \n'DEFAULT'. Create the necessary space by dropping objects in the filegroup, \nadding additional files to the filegroup, or setting autogrowth on for \nexisting files in the filegroup.\n</code></pre>\n\n<p>Hoping that there's someone that might see an obvious oversight on my part. Big Thanks!</p>\n"},{"tags":["tsql","adsi"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":16,"score":0,"question_id":12783049,"title":"Connecting to Active Directory ADSI from SQL Server within a view","body":"<p>I've had an intermittent problem on our production SQL server for several months now.</p>\n\n<p>A number of SQL views interrogate AD via ADSI (e.g. to get the users email address or department from the logon).</p>\n\n<p>Generally speaking this works fine (it's only a small quantity of users so we can ignore the upper limits for the purposes of this question I think).\nOccasionally AD will time out and return an error  which is passed back to the web application - this does need sorting, but it's beyond my remit at this time.</p>\n\n<p>What I'm concerned about is the remaining process.</p>\n\n<p>After the time out, if I do a sp_who2 I can see the IIS process is in a RUNNABLE state. It never leaves this state. Eventually I will need to take the database offline as time outs increase across the system.</p>\n\n<p>My long term goal is to take out the SQL joining to AD and write a batch job to refresh a SQL table.</p>\n\n<p>However, in the meantime can anyone suggest why my view might be causing the \"RUNNABLE\" status of various SPID's in SQL Server? Anyway to stop this happening?</p>\n\n<p>(I'm posting this here because fundamentally I think this is a programming issue - my view appears to cause an IIS process to remain RUNNABLE)</p>\n"},{"tags":["mysql","tsql","transactions"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12767618,"title":"Proper locking for reliable insertion (MySQL)","body":"<p>When receiving so called IPN message from PayPal, I need to update a row in my database.</p>\n\n<p>The issue is that I need perfect reliability.</p>\n\n<p>Currently I use InnoDB. I am afraid that the transaction may fail due a race condition.</p>\n\n<p>Should I use <code>LOCK TABLES</code>? Any other reliable solution?</p>\n\n<p>Should I check for a failure and repeat the transaction several (how many?) times?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":90,"score":0,"question_id":12776195,"title":"How to change case in string","body":"<p>My table has one column that contain strings like:   <code> HRM_APPLICATION_DELAY_IN</code></p>\n\n<p>I want to perform bellow operations on each row on this column </p>\n\n<ol>\n<li>convert to lower case</li>\n<li>remove underscore <code>_</code></li>\n<li>change case (convert to upper case) of the character after the underscore like: <code> hrm_Application_Delay_In</code></li>\n</ol>\n\n<p>Need help for conversion. Thanks for advance</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":408,"score":0,"question_id":3098879,"title":"TSQL Reverse FOR XML Encoding","body":"<p>I am using FOR XML in a query to join multiple rows together, but the text contains quotes, \"&lt;\", \">\", etc.  I need the actual character instead of the encoded value like \"&quot;\" etc.  Any suggestions?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":171,"score":0,"question_id":12776700,"title":"Using while loop in T-SQL function","body":"<p>Non-database programmer here. It happens so, that I need to create a function in T-SQL which returns workdays count between given dates. I believe that the easiest how it's done is with <strong>while</strong> loop. Problem is, that as soon as I write something like</p>\n\n<pre><code>while @date &lt; @endDate\nbegin\n\nend\n</code></pre>\n\n<p>the statement won't execute, claiming \"incorrect syntax near the keyword 'return'\" (not very helpful). Where's the problem?</p>\n\n<p>P.S. Full code:</p>\n\n<pre><code>ALTER FUNCTION [dbo].[GetNormalWorkdaysCount] (\n@startDate DATETIME,\n@endDate DATETIME\n)   \nRETURNS INT\n\nAS\nBEGIN\n    declare @Count INT,\n            @CurrDate DATETIME\n    set @CurrDate = @startDate\n\n    while (@CurrDate &lt; @endDate)\n    begin\n\n    end\n\n    return @Count\nEND\nGO\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12775845,"title":"Proper way to keep a single data in sql server?","body":"<p>I have a table (myData) with lots of columns and rows,\nand have another table (myFileNo) single value which means single row, single column, single cell (FileNo), </p>\n\n<p>I wrote an sql query which updates myData by checking  myFileNo, and after process ends it changes the value of FileNo.</p>\n\n<p>It does not make much sense to me to keep the single value data in a table, is this the proper way to do it ?</p>\n\n<p>Edit: purpose of FileNo</p>\n\n<p>It acts as an identification number, but not created like a primary key. An example (before, and after):</p>\n\n<p><strong>Before</strong></p>\n\n<pre><code>myData, FileNo\nA, NULL\nA, NULL\nB, NULL\nC, NULL\nA, NULL\nD, NULL\nD, NULL\n</code></pre>\n\n<p>FileNo: 15</p>\n\n<p><strong>After</strong></p>\n\n<pre><code>myData, FileNo\nA, 16\nA, 16\nB, 17\nC, 18\nA, 16\nD, 19\nD, 19\n\nFileNo: 19\n</code></pre>\n"},{"tags":["sql-server","query","tsql","select","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12775697,"title":"How to extract ids of the rows with minimum value in sql","body":"<p>I have the following table</p>\n\n<pre><code>RecordID     Group     Date        Value\n----------------------------------------\n 1           Test 1   1/01/2012     10\n 2           Test 1   1/01/2012     10\n 3           Test 1   1/01/2012     20\n 4           Test 2   1/01/2012     20\n 5           Test 1   2/01/2012     10\n 6           Test 2   2/01/2012     30\n 7           Test 1   2/01/2012     20\n 8           Test 1   2/01/2012     20\n 9           Test 2   2/01/2012     20\n10           Test 1   3/01/2012     10\n11           Test 2   3/01/2012     10\n12           Test 2   3/01/2012     20\n13           Test 3   3/01/2012     10\n14           Test 1   4/01/2012     10\n</code></pre>\n\n<p>I need to get all RecordIds, where for the same date and same group it has the lowest value and disregard all records for the same date and group that have greater value. So my query needs to group by \"date\" and \"group\" and find records with lowest value, that is result should be:</p>\n\n<p>RecordIds: 1, 2, 4, 5, 9, 10, 11, 13, 14</p>\n"},{"tags":["sql","tsql","date","sql-server-2008-r2"],"answer_count":5,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":88,"score":2,"question_id":12775480,"title":"how to find the duration between two dates","body":"<p>I want to find the duration between the two date columns. For this i used the DATEDIFF function to find number years and months separately but wanted both results in single column.\nThe two columns are given below.  </p>\n\n<pre><code>start_dt      |    end_dt\n06-Oct-2009      15-Jul-2011  \n</code></pre>\n\n<p>Result which needed </p>\n\n<pre><code>Duration(years.months)\n2.3\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":60,"score":2,"question_id":12774196,"title":"SQL MAX Command still returning more one result","body":"<p>I had this SQL Query working perfectly.  I made a few small changes to the database, and reran it and it simply stopped work.</p>\n\n<p>My goal here is to join <code>master_followups</code> with <code>followups_fb_messages.message_text</code> but only return a single row for each UID in <code>master_followups</code> with the most RECENT <code>followups_fb_messages.message_text</code> joined to it.</p>\n\n<pre><code>SELECT master_followups.*, \n  followups_fb_messages.message_text, \n  followups_fb_messages.message_time \nFROM\n  master_followups \n  LEFT JOIN followups_fb_messages \n    ON master_followups.UID = followups_fb_messages.FID \n    AND followups_fb_messages.message_time = \n      (SELECT\n        MAX(followups_fb_messages.message_time) \n        FROM followups_fb_messages \n        WHERE  followups_fb_messages.FID = master_followups.UID\n      )\n</code></pre>\n\n<p>I've been trying to figure out what happened for the last hour. </p>\n\n<p>Instead of returning 100 results as expected, this is returning 340.   I checked the database and it shows 100 rows in <code>master_followups</code> and 340 rows in <code>followups_fb_messages</code>. </p>\n\n<p>I had this exact query working fine about an hour ago, then it stopped.  Maybe I changed something, but I can't see it.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12773275,"title":"Remove Quotation Marks On All Rows in a Column","body":"<p>I have a column in a table that has values encapsulated in quotation marks (i.e. \"USA\", \"Mexico\", \"Russia\", \"China\", etc.) I would like to remove the quotation marks and leave the rest of the string intact (USA, Mexico, etc.). Is there a simple statement for this?  Or do I need to use a combination of LEFT, RIGHT, and SUBSTRING functions? Thanks in advance</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":21,"score":0,"question_id":12772828,"title":"Cannot Update a Numeric Named Column","body":"<p>I am trying to perform a simple task in SQL Server and receiving an error. I have a table called World.Internet_CountryYear. The table has year columns (i.e. 1960, 1965, etc.) with numerical data in the fields, but the data type for the columns is varchar(max). Currently, the fields that do not have data have \"\" in them, which I would like to replace with 0.00. So, I try to run a simple update command as follows:</p>\n\n<pre><code>UPDATE World.Internet_CountryYear\nSET 1960 = '0.00'\nWHERE 1960 = '\"\"'\n</code></pre>\n\n<p>For some reason, I receive an error saying \"Incorrect syntax near '1960'\"</p>\n\n<p>Is there a problem with the DDL of this table? What am I missing here? I have tried specifying World.Internet_CountryYear.1960 as well, but still receive a similar error: Incorrect syntax near '.1960'</p>\n\n<p>Any suggestions?</p>\n"},{"tags":["sql","regex","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":819,"score":0,"question_id":2851190,"title":"sql server 2000: TSQL special characters handling","body":"<p>Just using SQL Server 2000 built in features ONLY, what is the best way to handle special characters. I am not sure if Regular Expression could be used by purely using built in features? I would like to search and replace the special characters in my queries.</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql","replace","sql-server-2008-r2","left-join"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12771906,"title":"How to replace a column values when querying with left join command SQL Server 2008 r2","body":"<p>Alright let me explain my question with example</p>\n\n<p>We have a table that contains</p>\n\n<pre><code>Id\nName\nNumber\n</code></pre>\n\n<p>Now example</p>\n\n<pre><code>1 House 4\n2 Hospital 3\n3 Airport 'null'\n4 Station 2\n</code></pre>\n\n<hr>\n\n<pre><code> select t1.id, \n       t1.name,\n       t2.name as name2\nfrom your_table t1\nleft join your_table t2 on t1.number = t2.id\n</code></pre>\n\n<p>Ok when querying as the above, that 'null' value containing column is giving error. So i want to modify above query in a way that it will return name2 as null and won't give error for that rows.</p>\n\n<p>So the result I expect should be:</p>\n\n<pre><code>1 House Station\n2 Hospital Airport\n3 Airport null\n4 Station Hospital\n</code></pre>\n\n<p>This null here is as string.</p>\n\n<p>The current error I get</p>\n\n<blockquote>\n  <p><em>Msg 245, Level 16, State 1, Line 5<br>\n  Conversion failed when converting the varchar value 'null' to data type smallint.</em></p>\n</blockquote>\n\n<p>thank you</p>\n"},{"tags":["sql-server","tsql","deadlock","partitioning"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":60,"score":1,"question_id":12772109,"title":"Table partitioning in sql server - how do you ensure it wins a deadlock over queries?","body":"<p>The bane of my existence is when the MERGE on a table partition gets deadlocked and eventually loses.  </p>\n\n<p>I've tried setting the deadlock_priority to high.  </p>\n\n<p>I have code that kills each query hitting the tables beforehand, but sometimes I still get a query in there during those milliseconds.</p>\n\n<p>I'm at a loss.  Is there a good way to do this? </p>\n"},{"tags":["sql","database","sql-server-2008","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12769346,"title":"1:1 table relation can't insert new row","body":"<p>I have a table inheritance in my database. I have table \"<code>Item</code>\" and Table \"<code>Something</code>\". <code>Item</code> has <code>ItemId</code> which is <strong>primary key and auto increment</strong>. In table <code>Something</code> I have <code>ItemId</code> which is <strong>primary key (not autoincrement)</strong>. Theese tables are in <strong>1:1</strong> relation.<br/>\nSo I have tried to insert data in those tables but this doesn't work:</p>\n\n<pre><code>...\nDECLARE @itemId int\n\n    INSERT INTO dbo.Items\n    (ItemTypeId,UserId,CreatedOnDate,Title,Description)\n    VALUES\n    (@p_ItemTypeId,@p_UserId,@p_CreatedOnDate,@p_Title,@p_Description)\n\n    SELECT @itemId = SCOPE_IDENTITY()\n\n    INSERT INTO dbo.Something\n    (ItemsId)\n    VALUES\n    (@itemId)\n...\n</code></pre>\n\n<p>This is the error that I get:</p>\n\n<pre><code>The INSERT statement conflicted with the FOREIGN KEY constraint \"FK_Items_Somethings\".\n</code></pre>\n\n<p>Tables create script:</p>\n\n<pre><code>CREATE TABLE [dbo].[Items](\n    [ItemdId] [int] IDENTITY(1,1) NOT NULL,\n    [ItemTypeId] [int] NULL,\n    [UserId] [int] NULL,\n    [CreatedOnDate] [smalldatetime] NULL,\n    [Title] [nvarchar](50) NULL,\n    [Description] [nvarchar](max) NULL,\n\n CONSTRAINT [PK_Items] PRIMARY KEY CLUSTERED \n(\n    [ItemId] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n\nGO\n\nALTER TABLE [dbo].[Items]  WITH CHECK ADD  CONSTRAINT [FK_Items_Somethings] FOREIGN KEY([ItemId])\nREFERENCES [dbo].[Somethings] ([ItemId])\nGO\n\nALTER TABLE [dbo].[Items] CHECK CONSTRAINT [FK_Items_Somethings]\nGO\n\n\nCREATE TABLE [dbo].[Somethings](\n    [ItemId] [int] NOT NULL,\n CONSTRAINT [PK_Somethings] PRIMARY KEY CLUSTERED \n(\n    [ItemId] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n\nGO\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":84,"score":1,"question_id":12756223,"title":"T-SQL: Count and Group By Across Multiple Columns","body":"<p>I have the following table:</p>\n\n<pre>\nName | Col1 | Col2 | Col3\nJohn   A      B      C\nJohn   A      D      A\nBill   A      A      D\nBill   F      A      A\nSteve  F      A      B\nSteve  C      C      A\n</pre>\n\n<p>I want to know a total of how many As John, Bill, and Steve have...</p>\n\n<p>e.g. John: 3, Bill: 4, Steve: 2</p>\n\n<p>How could I do this using T-SQL? Thanks.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":34,"score":-3,"question_id":12767481,"title":"TSQL Help | The select list for the INSERT statement contains fewer items than the insert list","body":"<p>Please see my query below, I have counted the columns a number of times and also I have checked the commas, they seem to be fine but I keep on getting the error </p>\n\n<p>The select list for the INSERT statement contains fewer items than the insert list. The number of SELECT values must match the number of INSERT columns.</p>\n\n<pre><code>DECLARE @StatusValues TABLE (StatusId INT,StatusText VARCHAR(50))\n\nINSERT INTO @StatusValues VALUES(1,'Code 1 - Entered E&amp;D Waiver');\nINSERT INTO @StatusValues VALUES(2,'Code 2 - Nursing Facility');\nINSERT INTO @StatusValues VALUES(3,'Code 3 - Entered Assisted Living Waiver');\nINSERT INTO @StatusValues VALUES(4,'Code 4 - Entered TBI/SCI Waiver');\nINSERT INTO @StatusValues VALUES(5,'Code 5 - Entered IL Waiver');\nINSERT INTO @StatusValues VALUES(6,'Code 6 - DECEASED');\nINSERT INTO @StatusValues VALUES(7,'Code 7 - Refused Waiver Services');\nINSERT INTO @StatusValues VALUES(8,'Code 8 - Other (Explain)');\nINSERT INTO @StatusValues VALUES(NULL,'Please select');\n\n\nINSERT INTO SWMPDD.dbo.Clients(\n    AdditionalPertinent,\n    Address1,\n    Address2,\n    ApplicationApprovedBy,\n    ByWhom,\n    City,\n    ClientAt,\n    ContactPerson,\n    ContactPhone,\n    County,\n    DateClientContacted,\n    Diagnostic,\n    Diet,\n    Direction,\n    DateOfBirth,\n    Email,\n    FirstName,\n    Gender,\n    InOtherCase,\n    InTakeDate,\n    IPAddress,\n    LastName,\n    LastUpdateUser,\n    LastUpdateTime,\n    LockinStatus,\n    Medicaid,\n    Medicare,\n    MethodofContact,\n    MiddleInitial,\n    OfficalComments,\n    OtherComments,\n    ParticipantId,\n    ParticipantSignature,\n    PersonResidenceCode,\n    Phone,\n    Physician,\n    PhysicianAddress,\n    PhysicianCity,\n    PhysicianPhone,\n    PhysicianZip,\n    CreationDate,\n    ReferralPhone,\n    ReferralSoruce,\n    RelationshipToClient,\n    SignatureDate,\n    SSN,\n    [State],\n    CreationUser,\n    VerificationDate,\n    VerificationOfMedicaidStatus,\n    Zip,\n    ClientId,\n    StatusId,\n    StatusText\n)\nSELECT \n    AdditionalPertinent,\n    Address1,\n    Address2,\n    ApplicationApprovedBy,\n    ByWhom,\n    City,\n    ClientAt,\n    ContactPerson,\n    ContactPhone,\n    county,\n    DateClientContacted,\n    Diagnostic,\n    Diet,\n    Direction,\n    DOB,\n    EmailAddress,\n    FirstName,\n    Gender,\n    InOtherCase,\n    InTakeDate,\n    ipaddress,\n    LastName,\n    lastUpdatedBy,\n    lastupdatedDate,\n    LockinStatus,\n    Medicaid,\n    Medicare,\n    MethodofContact,\n    MiddleInit,\n    OfficalComments,\n    OtherComments,\n    ParticipantId,\n    ParticipantSignature,\n    PersonResidenceCode,\n    phone,\n    Physician,\n    PhysicianAddress,\n    PhysicianCity,\n    PhysicianPhone\n    PhysicianZip,\n    recDate,\n    ReferralPhone,\n    ReferralSoruce,\n    RelationshiptoClient,\n    SignatureDate,\n    SSN,\n    [state],\n    userid,\n    VerificationDate,\n    VerificationofMedicaidStatus,\n    zip,\n    NEWID(),\n    (SELECT StatusId FROM @StatusValues WHERE StatusText = ReasonforRemovalCode) abc,\n    Code8Other\nFROM msdepart.dbo.tblParticipant;\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","join","group-by"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12767105,"title":"Update Table by Join and Group by","body":"<p>A Company has many Reviews which has Rating Column itself.</p>\n\n<pre><code>CompID  Ratig\n12  3\n13  3\n17  4\n22  4\n23  5\n24  3\n28  3,2\n</code></pre>\n\n<p>This is what I need to be set to each company by id. <strong>Now Rating In Company Column is</strong> <code>NULL</code>.</p>\n\n<p>I've written something like this:</p>\n\n<pre><code>UPDATE Companies c\nJOIN Reviews r on c.CompanyID = r.CompanyID\nSET c.Rating = AVG(r.rating)\ngroup by r.CompanyID\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","where-clause"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":12212758,"title":"Check if datetime is in current date","body":"<p>I am using SQLServer 2008. I have a table X with field Y that is a datetime format. In the WHERE statement of my query I only want to keep the rows where the date of field Y equals the current date.</p>\n\n<p>I have searched the internet but couldnt find an example that works for SQLServer/</p>\n\n<p>Thank you for your help!</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12437227,"title":"how to know how many rows will be affected before running a query in microsoft sql server 2008","body":"<p>i've read a bit about ROWCOUNT but its not exactly what im looking for. from my understanding rowcount states the number of rows affected AFTER you run the query. what im looking for is knowing BEFORE you run the query. is this possible?</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":110,"score":0,"question_id":12760850,"title":"SQL- Week number of the Month NOT the Year & Why Query is Returning 6 Week in a Month","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/4928038/tsql-calculate-week-number-of-the-month\">TSQL Calculate week number of the month</a>  </p>\n</blockquote>\n\n\n\n<p>This is my SQL Query</p>\n\n<pre><code> SELECT DATEPART(MONTH,PaymentDate) AS 'Month',\n       DATEPART(WEEK,PaymentDate) AS 'Week #',\n       SUM(COALESCE(Amount,0)) AS 'Amount',\n       SUM(COALESCE(Balance,0)) AS 'Balance'\nFROM Payment\nWHERE     (MONTH(PaymentDate) = MONTH('2012-09-01'))\nGROUP BY DATEPART(MONTH,PaymentDate),\nDATEPART(WEEK,PaymentDate)\nGO\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/GJXId.jpg\" alt=\"enter image description here\"></p>\n\n<p>I am try to get Total payment of a month in weekly fashion.</p>\n\n<p>Now I have two Issues</p>\n\n<p>1)As you can see it shows week # of the year not that month.</p>\n\n<p>2)Also It show 6 weeks Groups not 4.</p>\n\n<p>How can I Fix that.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","performance","tsql","join"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":129,"score":2,"question_id":12746927,"title":"Using a join to optimize sql query","body":"<p>I have a table that stores a person's information with close to 10 million rows. </p>\n\n<p>Currently State is a char(2) field on the person table.  This leads to tons of duplication of data as you would expect.  If I normalize State data into it's own table and create an FK to it in the person table would this result in faster query times?</p>\n\n<p>Before:</p>\n\n<pre><code>SELECT Name, City, State FROM Person WHERE State = 'WI'\n</code></pre>\n\n<p>After:</p>\n\n<pre><code>SELECT p.Name, p.City, s.Name as State\nFROM Person p\n    INNER JOIN State s ON p.State == s.Id\nWHERE s.Name = 'WI'\n</code></pre>\n\n<p>It seems to me that this would accomplish an increase in performance but I am far from an expert when it comes to optimizing queries.</p>\n"},{"tags":["tsql","reporting-services"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":137,"score":0,"question_id":12397694,"title":"Query to get list of all SSRS Subscriptions with parameters","body":"<p>I've be searching and trying for hours to get a query that gives me all current subscriptions from an SSRS serv with parameters and their values, so that they can be recreated on a new server (after pruning).</p>\n\n<p>For example a simple report might be HoursByDepartment that takes three params:</p>\n\n<pre><code>@From =Today - 7 days (Default)\n@To   = Today (Default)\n@Dept = 2 (part of subscription)\n</code></pre>\n\n<p>What I want to get is something along these lines (or something that will let me create a report)</p>\n\n<pre><code>Report            ParamName   ParamValue    Default\nHoursByDepartment From        Today-7days    True\nHoursByDepartment To          Today          True\nHoursByDepartment Dept        2              False\n</code></pre>\n\n<p>OR </p>\n\n<pre><code>Report             Param1Name   Param1Value   Param1Def   Param2Name   Param2Value    Param2Def     \nHoursByDepartment  From         Today-7days   True        To           Today          True\n</code></pre>\n\n<p>I'm pretty good with XSl, so if i could get something like, I could work with it:</p>\n\n<pre><code>&lt;subid&gt;\n    &lt;report&gt;\n        &lt;ParameterValues&gt;\n            &lt;ParameterValue&gt;\n                &lt;Name&gt;MinAvailable&lt;/Name&gt;\n                &lt;Value&gt;10000&lt;/Value&gt;\n            &lt;/ParameterValue&gt;\n            &lt;ParameterValue&gt;\n                &lt;Name&gt;OwnerIDs&lt;/Name&gt;\n                &lt;Value&gt;0&lt;/Value&gt;\n            &lt;/ParameterValue&gt;\n            &lt;ParameterValue&gt;\n                &lt;Name&gt;ShowCosts&lt;/Name&gt;\n                &lt;Value&gt;False&lt;/Value&gt;\n            &lt;/ParameterValue&gt;\n            &lt;ParameterValue&gt;\n                &lt;Name&gt;MinValue&lt;/Name&gt;\n                &lt;Value&gt;0&lt;/Value&gt;\n            &lt;/ParameterValue&gt;\n        &lt;/ParameterValues&gt;\n    &lt;/report&gt;\n&lt;/subid&gt;\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":83,"score":0,"question_id":12748464,"title":"Optimizing a where clause (short circuiting), SQL Server 2008","body":"<p>How can one optimize this query:</p>\n\n<pre><code>declare @MyParam nvarchar(100) = 25846987;\n\nselect top 100 * from MySelectTable\nwhere\n(MyParam = @MyParam)\nOR\n(@MyParam = 0 and MyParam in (SELECT MyParam FROM aMassiveSlowTable WHERE Id = 'random1'))\nOR\n(@MyParam = 1 and MyParam in (SELECT MyParam FROM aMassiveSlowTable WHERE Id = 'random2'))\nOR\n(@MyParam = 2 and MyParam in (SELECT MyParam FROM aMassiveSlowTable WHERE Id = 'random3'))\n</code></pre>\n\n<p>When i use only this part:</p>\n\n<pre><code>declare @MyParam nvarchar(100) = 25846987;\n\nselect top 100 * from MySelectTable\nwhere\n(MyParam = @MyParam)\n</code></pre>\n\n<p>It returns in 1 second.</p>\n\n<p>When using all the parameters, it takes about 5 minutes. </p>\n\n<p>I believe it's because it's scanning aMassiveSlowTable when all it has to do is match MyParam = @MyParam.</p>\n\n<p>How do I make it skip all the other comparisons if @MyParam matches MyParam? I tried using CASE statements but they don't work with <strong>IN</strong> clauses. I tried rearranging the AND's in the paranthesis and even adding additional filtering to <em>aMassiveSlowTable</em>.</p>\n\n<p>If @MyParam does not match MyParam, it's ok if the query takes a little longer.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":12760804,"title":"How come numeric scale returns an additional digit","body":"<p>I have a column that is <code>varchar</code>, and I am trying to convert it to <code>numeric(8,2)</code> to return it like this <code>1.00</code>, but its returning it like this instead <code>1.000</code></p>\n\n<p>Example:</p>\n\n<pre><code> Select \n   Convert(numeric(8,2),WholesaleCost) * 2.2)\n FROM Table\n</code></pre>\n\n<p>This Returns <code>50.900</code></p>\n\n<p>Seems like when I reduce the scale to <code>numeric(8,1)</code> instead of <code>numeric(8,2)</code> it returns how I want it, which is <code>50.90</code></p>\n\n<p>Does anyone know why its doing this? Why its adding an additional scale digit to the result?  Shouldnt it be <code>50.9</code> when i do <code>numeric(8,1)</code>?</p>\n"},{"tags":["c#","sql","json","tsql","stored-procedures"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":183,"score":2,"question_id":9783587,"title":"Stored procedure with JSON input to create a table definition","body":"<p>I am to create a stored procedure to create a table to capture form data, this is part of a bigger project to create a Form Generator.</p>\n\n<p>I was wondering if anyone had created a stored procedure that took a stringified JSON object as input and created the the table based on this schema?</p>\n\n<p>I'm still toying with this in my brain as to whether I should be doing this within the sproc (preferable) or writing dynamic sql within a C# Service.</p>\n"},{"tags":["sql-server","tsql","current-dir"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12702960,"title":"How to Find Current Directory of itself with a TSQL Script File In SQL Server","body":"<p>I Think That My Question Is Simple.\nHow  Can I Find That My Query Is Running From Where\n( Where is The Location of the Script File itself ) ?</p>\n\n<p>Edit :</p>\n\n<p>Thank You For Your Answer.\nI Need To Import a XML File Using my TSQL Script File And i want to Keep Them Together,\nso Wherever Someone try to run the TSQL script file, it must knows the current directory of itself to know where is the XML file and then import it. Thank Again ! </p>\n"},{"tags":["sql-server-2008","tsql","bulkinsert","bcp"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":103,"score":0,"question_id":12755680,"title":"Bulk load data conversion error (overflow)","body":"<p>I have been racking my brain trying to figure out this error. I just don't get it.  </p>\n\n<p>SQL Server Database Error: Bulk load data conversion error (overflow) for row 1, column 1 (CUR_CLM_UNIQ_ID).  </p>\n\n<p>Here is my code:</p>\n\n<pre><code>SET DATEFORMAT ymd;\ngo\nBULK INSERT \naco.PartAClaimsHeader\nFROM 'C:\\Users\\Derek\\Documents\\files\\P.A1000.ACO.CCLF1.D120730.T1251070'\nWITH\n(\n --DATAFILETYPE ='CHAR',\n  FORMATFILE='C:\\Users\\Derek\\Documents\\files\\HeaderFileFormat.xml',\n  --ERRORFILE='C:\\Users\\Derek\\Documents\\files\\ERRORS.TXT',\n  ROWTERMINATOR='\\r\\n',\n  CODEPAGE='RAW',\n -- KEEPNULLS,\n  TABLOCK\n  )\n  GO  \n</code></pre>\n\n<p>It's fixed width.\nHere is  some sample data</p>\n\n<pre><code>00190000777340000000000000109061100000924A 102012-01-182012-02-16323569   ~         0000000003522.44 12010000~1154529360~         1518945500~         \n00158077735600000000000000100256140000646D 602011-07-222011-07-241141401  78650     0000000009238.12 12010247~1992759419159875707215987570721598757072\n0022980857396000000000000010S191274000037A 602012-06-042012-06-08112988   2988      0000000002255.52 12010885~1760429880~         1831184316~         \n</code></pre>\n\n<p>Here is my format file</p>\n\n<pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;BCPFORMAT xmlns=\"http://schemas.microsoft.com/sqlserver/2004/bulkload/format\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"&gt;\n&lt;RECORD&gt;\n    &lt;FIELD ID=\"1\" xsi:type=\"CharFixed\" LENGTH=\"13\"/&gt;\n    &lt;FIELD ID=\"2\" xsi:type=\"CharFixed\" LENGTH=\"13\"/&gt;\n    &lt;FIELD ID=\"3\" xsi:type=\"CharFixed\" LENGTH=\"6\"/&gt;\n    &lt;FIELD ID=\"4\" xsi:type=\"CharFixed\" LENGTH=\"11\"/&gt;\n    &lt;FIELD ID=\"5\" xsi:type=\"CharFixed\" LENGTH=\"2\"/&gt;\n    &lt;FIELD ID=\"6\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"7\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"8\" xsi:type=\"CharFixed\" LENGTH=\"1\"/&gt;\n    &lt;FIELD ID=\"9\" xsi:type=\"CharFixed\" LENGTH=\"1\"/&gt;\n    &lt;FIELD ID=\"10\" xsi:type=\"CharFixed\" LENGTH=\"7\"/&gt;\n    &lt;FIELD ID=\"11\" xsi:type=\"CharFixed\" LENGTH=\"7\"/&gt;\n    &lt;FIELD ID=\"12\" xsi:type=\"CharFixed\" LENGTH=\"2\"/&gt;\n    &lt;FIELD ID=\"13\" xsi:type=\"CharFixed\" LENGTH=\"17\"/&gt;\n    &lt;FIELD ID=\"14\" xsi:type=\"CharFixed\" LENGTH=\"1\"/&gt;\n    &lt;FIELD ID=\"15\" xsi:type=\"CharFixed\" LENGTH=\"2\"/&gt;\n    &lt;FIELD ID=\"16\" xsi:type=\"CharFixed\" LENGTH=\"2\"/&gt;\n    &lt;FIELD ID=\"17\" xsi:type=\"CharFixed\" LENGTH=\"4\"/&gt;  \n    &lt;FIELD ID=\"18\" xsi:type=\"CharFixed\" LENGTH=\"1\"/&gt;\n    &lt;FIELD ID=\"19\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"20\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"21\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"22\" xsi:type=\"CharFixed\" LENGTH=\"10\"/&gt;\n    &lt;FIELD ID=\"23\" xsi:type=\"CharTerm\" TERMINATOR=\"\\r\\n\"/&gt;\n&lt;/RECORD&gt;\n&lt;ROW&gt;\n    &lt;COLUMN SOURCE=\"1\" NAME=\"c1\" xsi:type=\"SQLINT\"/&gt;\n    &lt;COLUMN SOURCE=\"2\" NAME=\"c2\" xsi:type=\"SQLINT\"/&gt;\n    &lt;COLUMN SOURCE=\"3\" NAME=\"c3\" xsi:type=\"SQLVARYCHAR\"/&gt;\n    &lt;COLUMN SOURCE=\"4\" NAME=\"c4\" xsi:type=\"SQLVARYCHAR\" /&gt;\n    &lt;COLUMN SOURCE=\"5\" NAME=\"c5\" xsi:type=\"SQLTINYINT\" /&gt;\n    &lt;COLUMN SOURCE=\"6\" NAME=\"c6\" xsi:type=\"SQLDATE\"/&gt;\n    &lt;COLUMN SOURCE=\"7\" NAME=\"c7\" xsi:type=\"SQLDATE\"/&gt;\n    &lt;COLUMN SOURCE=\"8\" NAME=\"c8\" xsi:type=\"SQLCHAR\" LENGTH=\"1\"/&gt;\n    &lt;COLUMN SOURCE=\"9\" NAME=\"c9\" xsi:type=\"SQLCHAR\" LENGTH=\"1\" /&gt;\n    &lt;COLUMN SOURCE=\"10\" NAME=\"c10\" xsi:type=\"SQLVARYCHAR\" /&gt;\n    &lt;COLUMN SOURCE=\"11\" NAME=\"c11\" xsi:type=\"SQLVARYCHAR\"/&gt;\n    &lt;COLUMN SOURCE=\"12\" NAME=\"c12\" xsi:type=\"SQLCHAR\" LENGTH=\"2\"/&gt;\n    &lt;COLUMN SOURCE=\"13\" NAME=\"c13\" xsi:type=\"SQLDECIMAL\" SCALE=\"2\" PRECISION=\"17\"/&gt;\n    &lt;COLUMN SOURCE=\"14\" NAME=\"c14\" xsi:type=\"SQLCHAR\" LENGTH=\"1\" /&gt;\n    &lt;COLUMN SOURCE=\"15\" NAME=\"c15\" xsi:type=\"SQLCHAR\" LENGTH=\"2\" /&gt;\n    &lt;COLUMN SOURCE=\"16\" NAME=\"c16\" xsi:type=\"SQLCHAR\" LENGTH=\"2\"/&gt;\n    &lt;COLUMN SOURCE=\"17\" NAME=\"c17\" xsi:type=\"SQLVARYCHAR\"/&gt;\n    &lt;COLUMN SOURCE=\"18\" NAME=\"c18\" xsi:type=\"SQLCHAR\" LENGTH=\"1\"/&gt;\n    &lt;COLUMN SOURCE=\"19\" NAME=\"c19\" xsi:type=\"SQLCHAR\"  LENGTH=\"10\"/&gt;\n    &lt;COLUMN SOURCE=\"20\" NAME=\"c20\" xsi:type=\"SQLCHAR\" LENGTH=\"10\" /&gt;        \n    &lt;COLUMN SOURCE=\"21\" NAME=\"c21\" xsi:type=\"SQLCHAR\"  LENGTH=\"10\"/&gt;        \n    &lt;COLUMN SOURCE=\"22\" NAME=\"c22\" xsi:type=\"SQLCHAR\"  LENGTH=\"10\"/&gt;        \n    &lt;COLUMN SOURCE=\"23\" NAME=\"c23\" xsi:type=\"SQLCHAR\" /&gt;                \n&lt;/ROW&gt;\n&lt;/BCPFORMAT&gt;\n</code></pre>\n\n<p><strong>UPDATE</strong>: I changed the 2 first INT's to VARCHAR in the db and format file and it worked no problem. Would like to keep them INT's though.</p>\n"},{"tags":["sql","sql-server","tsql","sql-function"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12695974,"title":"SQL Function takes an sql string, execute the string and returns the table","body":"<p>I've done a lot of functions that return a table but somehow this one keeps on giving me an error at <code>Begin</code> and I couldn't figure out for the life of me why.  My <code>where</code> statement is stored in a table.  This function I want to pass in a value and the where statement.</p>\n\n<pre><code>CREATE FUNCTION dbo.Testtesttest(@employeeID        AS INT,\n                                 @sqlWhereStatement AS VARCHAR(max))\nReturns TABLE\n  BEGIN\n      DECLARE @mySQLStatement VARCHAR(max)\n\n      SET @mySQLStatement = 'Set Quoted_Identifier OFF Select '\n                           + CONVERT(VARCHAR, @employeeID) + ',* from (\n        select m.ManagerID, m.Name,m.Email,e.BU,\n        e.PSC from m inner join e on m.ManagerID = e.EmployeeID\n        group by m.ManagerID, m.Name,m.Email,e.BU,e.SC,\n        e.PSC) x where ' + @sqlWhereStatement\n\n      EXEC(@mySQLStatement)\n\n      RETURN\n  END \n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12756769,"title":"SQL convert datetime and subtract hours","body":"<p>I am trying to convert a datetime (createTime) field from its default 2012-10-06 02:29:37.243 format to am/pm so I use</p>\n\n<pre><code>convert(varchar, CreateTime, 100) as CreateTime\n</code></pre>\n\n<p>and get <strong>Oct  6 2012  4:29AM</strong>.</p>\n\n<p>So far so good but in the same statement I want to subtract 4 hours and then display the field (GMT issues).</p>\n\n<p>I have gone through some posts here but could not find anything that can do it in single statement.</p>\n"},{"tags":["sql","tsql","programming-languages","language-features"],"answer_count":4,"favorite_count":2,"up_vote_count":21,"down_vote_count":0,"view_count":3513,"score":21,"question_id":900055,"title":"Is SQL or even TSQL Turing Complete?","body":"<p>This came up at the office today.  I have no plans of doing such a thing, but theoretically could you write a compiler in SQL?  At first glance it appears to me to be turing complete, though extremely cumbersome for many classes of problems.  </p>\n\n<p>If it is not turing complete, what would it require to become so?</p>\n\n<p>Note: I have no desire to do anything like write a compiler in SQL, I know it would be a silly thing to do, so if we can avoid that discussion I would appreciate it.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":4660,"score":5,"question_id":206431,"title":"Meaning of sp_who Status in SQL Server","body":"<p>Can someone tell me what the statuses mean in SQL Server's sp_who command?  Why might a spid be suspended?  What does it mean to be \"runnable\"?</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":79,"score":1,"question_id":12693601,"title":"Selecting and sorting data from a single table","body":"<p>Correction to my question....</p>\n\n<p>I'm trying to select and sort in a query from a single table. The primary key for the table is a combination of a serialized number and a time/date stamp.</p>\n\n<p>The table's name in the database is \"A12\", the columns are defined as:</p>\n\n<pre><code>Serial2D (PK, char(25), not null)\nCompleted (PK, datetime, not null)\nResult (smallint, null)\nMachineID (FK, smallint, null)\nPT_1 (float, null)\nPT_2 (float, null)\nPT_3 (float, null)\nPT_4 (float, null)\n</code></pre>\n\n<p>Since the primary key for the table is a combination of the \"Serial2D\" and \"Completed\", there can be multiple \"Serial2D\" entries with different values in the \"Completed\" and \"Result\" columns. (I did not make this database... I have to work with what I got)</p>\n\n<p>I want to write a query that will utilize the value of the \"Result\" column ( always a \"0\" or \"1\") and retrive only unique rows for each \"Serial2D\" value. If the \"Result\" column has a \"1\" for that row, I want to choose it over any entries with that Serial that has a \"0\" in the Result column. There should be only one entry in the table that has a Result column entry of \"1\" for any Serial2D value. </p>\n\n<p>Ex. table</p>\n\n<pre><code>   Serial2d  Completed  Result   PT_1   PT_2    PT_3   PT_4   \n   -------   -------    ------   ----   ----   ----   ----\n    A1       1:00AM      0       32.5    20     26     29\n    A1       1:02AM      0       32.5    10     29     40\n    A1       1:03AM      1       10      5       4      3\n    B1       1:04AM      0       29      4       1      9\n    B1       1:05AM      0       40      3       4      9\n    C1       1:06AM      1       9       7       6      4 \n</code></pre>\n\n<p>I would like to be able to retrieve would be:</p>\n\n<pre><code>   Serial2d  Completed  Result   PT_1   PT_2    PT_3   PT_4   \n   -------   -------    ------   ----   ----   ----   ----\n    A1       1:03AM      1       10      5       4      3\n    B1       1:05AM      0       40      3       4      9\n    C1       1:06AM      1       9       7       6      4 \n</code></pre>\n\n<p>I'm new to SQL and I'm still learning ALL the syntax. I'm finding it difficult to search for the correct operators to use since I'm not sure what I need, so please forgive my ignorance. A post with my answer could be staring me right in the face and i wouldn't know it, please just point me to it. </p>\n\n<p>I appreciate the answers to my previous post, but the answers weren't sufficient for me due to MY lack of information and ineptness with SQL. I know this is probably insanely easy for some, but try to remember when you first started SQL... that's where I'm at.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12738330,"title":"Tsql sum measure accross dates","body":"<p>I need to sum the Idle column for the <code>New_Date</code> value in TSQL\neg: for the first date 20110502 the sum of the <code>Idle</code> column will be 21.25 + 21.60 = 42.85\nfor 20110509 the value will  be 22.43+23.22+ 14.90+22.90 +22.44 = 105.89</p>\n\n<pre><code>Date    New_Date    Idle\n20110502    NULL    21.2569444444444\n20110502    NULL    21.6019444444444\n20110503    NULL    22.4394444444444\n20110504    NULL    23.22\n20110505    NULL    14.9038230555556\n20110506    NULL    22.9086111111111\n20110508    NULL    22.4463888888889\n20110509    20110509    21.3794444444444\n20110510    NULL    22.5380555555556\n20110511    NULL    22.0638888888889\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":454,"score":2,"question_id":2644281,"title":"How many maximum recursion possible for CTE in SQL server?","body":"<p>How many maximum recursion level possible for CTE in SQL server? If maximum recursion level is reached then what are the alternative way?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":1,"up_vote_count":1,"down_vote_count":5,"view_count":54,"score":-4,"question_id":12735183,"title":"need a transact sql to duplicate existing tables. I want in a commit and roll back fashion","body":"<p>Need a stored procedure. that will duplicate a record in 10 tables. ( based on id or key field)</p>\n\n<p>First up, we need to search all the 10 tables, wheather that particular record is exist or not.  If exist ( in all tables or some tables) then fetch the record....</p>\n\n<p>insert/update the record in all those tables (after entering some un completed fields)</p>\n\n<hr>\n\n<p>scenario :</p>\n\n<p>I have sevaral forms say 10 different forms, each form has a corresponding table ( in a databse).</p>\n\n<p>User comes to the site create a profile, enter data in the forms... if he not completed all forms ( then some data will store in all those 10 tables)</p>\n\n<p>next time, he logs in and start enter the data.., we need to fetch his record..( to see if he has any records previously)...if record found, he may change the previous responses ....Once he finishes all 10 forms then only one transaction happens.</p>\n\n<p>So I need to simpify this, searching, duplicating, and update/roll back</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12748562,"title":"How to use EXCEPT in this stored procedure?","body":"<p>I have written a stored procedure:</p>\n\n<pre><code>SELECT \n    Encounter.EncounterNumber, \n    substring(Encounter.EncounterNumber,4,9) as Acct, \n    MedicalRecordNumber, \n    [AdmitDate - CCYYMMDD] as AdmitDate, \n    [DischargeDate - CCYYMMDD] as DischDate, \n    DischargeDisposition, \n    Encounter.Age, \n    EnctrAPR.APRDRG, \n    Age18, Age18To64, Age65\nfrom \n    Encounter\n    full outer join EnctrAPR on \n        substring(Encounter.EncounterNumber,4,9) = EnctrAPR.EncounterNumber\nwhere \n    HSP# = 1\n    and InOutCode = 'I'\n    and ActualTotalCharge &gt;0 \n    and AdmitSubService &lt;&gt; 'SIG'\n    and [DischargeDate - CCYYMMDD] between @StartDate and @EndDate\n    and Encounter.Age &gt;= 18\n</code></pre>\n\n<p>I would like to use the <code>EXCEPT</code> or <code>INTERSECT</code> directives to show me rows that are not in <code>EnctrAPR</code> that are in <code>Encounter</code>.  Note that I have different <code>EncounterNumber</code> formats on the two tables.  </p>\n\n<p>How would I accomplish this?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12748730,"title":"Join based on tables that vary by row","body":"<p>Say I have a table <code>Example</code> with three columns: <code>X, TableName, ColumnName</code>. </p>\n\n<p><code>TableName</code> stores the name of a table in the database, and <code>ColumnName</code> stores the name of the column that I want to join <code>X</code> to. The problem is that different rows need to be joined to different tables (in a well defined way). </p>\n\n<p>I want to be able to do something like:</p>\n\n<pre><code>Select *\nfrom Example join TableName on X = ColumnName\n</code></pre>\n\n<p>Which is obviously not going to work. </p>\n\n<p>I'm pretty new and did some googling and it seems like I might be able to use a cursor to loop over the rows and use dynamic SQL since the names of the Tables and Columns are stored in the database, but I've heard that both Cursors and Dynamic SQL should be avoided, so I haven't looked into the details of that. I was hoping there was a prefered way to solve this issue.</p>\n\n<p>Thanks.</p>\n"},{"tags":["c#","sql-server","tsql","error-handling"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":1,"view_count":4041,"score":1,"question_id":963379,"title":"Storing SqlServer's raiserror message in C#","body":"<p>How can I store SQLSERVER's raiserror message in C# ?</p>\n"}]}
{"total":16599,"page":10,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":1,"view_count":104,"score":3,"question_id":12747855,"title":"SQL - Returning all rows even if count is zero for item","body":"<p>I am performing a count based on a date range. Currently the query does return the correct result but I require additional information. In it's current form, the query shows the item with the correct count. However I need all items to be shown, even if their count is zero for the date range specified.</p>\n\n<p>Here is the SQL code:</p>\n\n<pre><code>INSERT INTO @CreationCount (BaselineID, Name)\n\nSELECT distinct [BaselineID],[Name] \nFROM [Baseline_INFO] \n\nDECLARE @ReqType TABLE (Type nvarchar(128))\nINSERT INTO @ReqType (Type)\nSELECT DISTINCT Tree.Type as 'Requirement Type'\nFROM [TREE]\nINNER JOIN [Project_INFO]  ON [Project_INFO].[ProjectID]=[Tree].[Project_ID] \nINNER JOIN [Baseline_INFO] ON [Baseline_INFO].[BaselineID]=[Tree].[Baseline_ID]\nWHERE [Project_INFO].[Name] = 'Address Book' AND [Baseline_INFO].[Name] = 'Current\nBaseline' \nGroup By Tree.Type\n\nSELECT Tree.Type as 'Requirement Type', COUNT(Tree.Type) as 'Number in Creation Range' \nFROM [Tree] \nINNER JOIN @ReqType As RT on RT.Type = Tree.Type\nINNER JOIN [Project_INFO]  ON [Project_INFO].[ProjectID]=[Tree].[Project_ID] \nINNER JOIN @CreationCount AS CCount ON CCount.BaselineID=Tree.Baseline_ID \nWHERE [Project_INFO].[Name] = 'Address Book' AND CCount.Name = 'Current Baseline' \nAND [Tree].[creationDate] &gt;= ('2010-01-01') and [Tree].[creationDate] &lt; ('2020-01-01') \nGROUP BY tree.Type\n</code></pre>\n\n<p>When I execute this query I get the following result:</p>\n\n<p><a href=\"https://dl.dropbox.com/u/17234826/SQLresult.png\" rel=\"nofollow\">https://dl.dropbox.com/u/17234826/SQLresult.png</a></p>\n\n<p>This result is correct however I need all requirement types to be list, even if there are no requirements in the creation range, i.e.</p>\n\n<p><a href=\"https://dl.dropbox.com/u/17234826/SQLresult1.png\" rel=\"nofollow\">https://dl.dropbox.com/u/17234826/SQLresult1.png</a></p>\n\n<p>I have tried using various joins, IFNULL and ISNULL but I haven't got anything to work.</p>\n\n<p>If someone could point me in the right direction I'd appreciate it.</p>\n"},{"tags":["sql","sql-server","tsql","select","sql-update"],"answer_count":10,"favorite_count":102,"up_vote_count":266,"down_vote_count":0,"view_count":253454,"score":266,"question_id":2334712,"title":"SQL Server UPDATE from SELECT","body":"<p>In SQL server you can insert into a table using a select statement.</p>\n\n<pre><code>INSERT INTO table(col,col2,col3)\nSELECT col,col2,col3 FROM other_table WHERE sql = 'cool'\n</code></pre>\n\n<p>How can I update via a select as well in a similar manner? I have a temp table that has the values and I want to update another table using those values.</p>\n\n<p>Something like this:</p>\n\n<pre><code>UPDATE Table SET col1,col2\nSELECT col1,col2 FROM other_table WHERE sql = 'cool'\nWHERE Table.id = other_table.id\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":65,"score":2,"question_id":12746687,"title":"Getting all records including non matching records","body":"<p>I have the following tables</p>\n\n<p>Payment</p>\n\n<p>PayTypeId, Description</p>\n\n<ul>\n<li>0 , Credit  </li>\n<li>1, Debit</li>\n<li>2,Master</li>\n</ul>\n\n<p>ActualPayment\nId,PayTypeId,Amount</p>\n\n<ul>\n<li>1,1,10</li>\n</ul>\n\n<p>Here is the output i am looking at </p>\n\n<p>Id,PayTypeId,Amount</p>\n\n<ul>\n<li>1,0,NULL</li>\n<li>1,1,10</li>\n<li>1,2,NULL</li>\n</ul>\n\n<p>Basically I want all the records of ActualPayment including all payment types.</p>\n\n<p>Here is the query i have used but am not getting any records</p>\n\n<pre><code>select\n*\nfrom #ActualPayments ap \nleft join #Payment p on ap.paytypeid = p.paytypeid \nwhere p.paytypeid is null\n</code></pre>\n"},{"tags":["sql-server","tsql","scope-identity","output-clause"],"answer_count":2,"favorite_count":1,"up_vote_count":5,"down_vote_count":0,"view_count":119,"score":5,"question_id":12698388,"title":"SQL Server OUTPUT clause","body":"<p>I am a little stuck with why I can not seem to get the 'new identity' of the inserted row with the statement below. <code>SCOPE_IDENTITY()</code> just returns null.</p>\n\n<pre><code>declare @WorkRequestQueueID int\ndeclare @LastException nvarchar(MAX)\nset @WorkRequestQueueID = 1\nset @LastException = 'test'\n\nset nocount off\n\nDELETE dbo.WorkRequestQueue\nOUTPUT\n        DELETED.MessageEnvelope,\n        DELETED.Attempts,\n        @LastException,\n        GetUtcdate(), -- WorkItemPoisened datetime\n        DELETED.WorkItemReceived_UTC\n    INTO dbo.FaildMessages\nFROM dbo.WorkRequestQueue\nWHERE\n    WorkRequestQueue.ID = @WorkRequestQueueID\n\nIF @@ROWCOUNT = 0 \n  RAISERROR ('Record not found', 16, 1) \n\nSELECT Cast(SCOPE_IDENTITY() as int) \n</code></pre>\n\n<p>Any assistance would be most appreciated.</p>\n\n<p>For now I use a workaround this like so.</p>\n\n<pre><code>declare     @WorkRequestQueueID int\ndeclare @LastException nvarchar(MAX)\nset @WorkRequestQueueID = 7\nset @LastException = 'test'\n\nset nocount on\nset xact_abort on \n\nDECLARE @Failed TABLE \n(\n    MessageEnvelope xml, \n    Attempts smallint,\n    LastException nvarchar(max),\n    WorkItemPoisened_UTC datetime,\n    WorkItemReceived_UTC datetime\n)\n\nBEGIN TRAN\n\nDELETE dbo.WorkRequestQueue\nOUTPUT\n    DELETED.MessageEnvelope,\n    DELETED.Attempts,\n    @LastException,\n    GetUtcdate(), -- WorkItemPoisened datetime\n    DELETED.WorkItemReceived_UTC\n\nINTO \n    @Failed\nFROM \n    dbo.WorkRequestQueue\nWHERE\n    WorkRequestQueue.ID = @WorkRequestQueueID\n\nIF @@ROWCOUNT = 0 BEGIN  \n    RAISERROR ('Record not found', 16, 1) \n    Rollback\nEND ELSE BEGIN\n    insert into dbo.FaildMessages select * from @Failed\n    COMMIT TRAN\n    SELECT Cast(SCOPE_IDENTITY() as int) \nEND\n</code></pre>\n"},{"tags":["sql-server","tsql","loops","stored-procedures","csv"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":84,"score":1,"question_id":12744552,"title":"Execute stored procedure for each line in a CSV","body":"<p>I am trying to run a stored procedure using tsql multiple times in a query using each CSV line for the parameters. </p>\n\n<p>How would I go about looping through this?</p>\n\n<p>Cheers</p>\n"},{"tags":["sql","sql-server-2005","tsql","constraints","foreign-key-relationship"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1439,"score":1,"question_id":5416926,"title":"Self referencing foreign-key constraints and delete","body":"<p>what is the recommended way to handle self-referencing foreignkey constraints in SQL-Server?</p>\n\n<p>Table-Model:</p>\n\n<p><img src=\"http://i.stack.imgur.com/MHdmX.jpg\" alt=\"enter image description here\"></p>\n\n<p><code>fiData</code> references a previous record in tabData. If i delete a record that is referenced by <code>fiData</code>, the database throws an exception: <code>\"The DELETE statement conflicted with the SAME TABLE REFERENCE constraint \"FK_tabDataPrev_tabDataNext\". The conflict occurred in database \"MyDataBase\", table \"dbo.tabData\", column 'fiData'\"</code> if <code>Enforce Foreignkey Constraint</code> is set to \"Yes\".</p>\n\n<p>I don't need to cascade delete records that are referenced but i would need to set <code>fiData=NULL</code> where it's referenced. My idea is to set <code>Enforce Foreignkey Constraint</code> to \"No\" and create a delete-trigger. Is this recommendable or are there better ways?</p>\n\n<p>Thank you.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":44,"score":0,"question_id":12732546,"title":"SQL Server 2008 'sp_syspolicy_purge_history' Function","body":"<p>What does this built-in function do?  What is the \"history\" that it is deleting?</p>\n"},{"tags":["tsql","reporting-services","ssrs-2008"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":179,"score":0,"question_id":11473771,"title":"How to populate a dataset in SSRS from a stored proc","body":"<p>I'm creating a SSRS report from a stored procedure in SQL, when i add a dataset to the report i'm finding i'm having to add this to the top of my procedure in order for fields to be returned into my data set from the stored proc:</p>\n\n<pre><code>IF 1=2 SELECT '' as [Date], '' as [Portfolio ID], '' as [Portfolio Base Ccy], 0 as [All in Market Value Base], 0 as [All in Market Value Converted]\n</code></pre>\n\n<p>Why would I have to do this and why does SSRS not simply pick up:</p>\n\n<pre><code>SELECT [Date], [Portfolio ID],   [Portfolio Base Ccy], [All in Market Value Base], [All in Market Value Converted]\nFROM @Worktable\n</code></pre>\n\n<p>from the bottom of my procedure or </p>\n\n<pre><code>SELECT * FROM @Worktable\n</code></pre>\n\n<p>?</p>\n\n<p>EDIT:\nOk i think i've narrowed down my issue in my procedure to the face that i have a debug parameter in my procedure.  So if this parameter is set to 'Y' then i show each step of my procedure, which makes it easier for debugging (i can add an example if need be).  Also at the end of my procedure i have an if statement for my final result set which says:</p>\n\n<pre><code>IF @ReportType IN ('SSD', 'TTD', 'STD')\nBEGIN\nSELECT.........\nEND\n\nIF @ReportType IN ('SS', 'TT', 'ST')\nBEGIN\nSELECT.........\nEND\n</code></pre>\n\n<p>Could this be an issue as well?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":12742799,"title":"Change row to columns","body":"<p>I have this query:</p>\n\n<pre><code>SELECT     \n   dbo.[Values].Value, dbo.Definition.FieldName, dbo.Definition.DefinitionID\nFROM         \n   dbo.Records AS R \nINNER JOIN\n   dbo.[Values] ON R.RecordID = dbo.[Values].RecordID \nINNER JOIN\n   dbo.Definition ON dbo.[Values].DefinitionID = dbo.Definition.DefinitionID\n</code></pre>\n\n<p>and result is:</p>\n\n<pre><code>Value   FieldName   DefinitionID\n1   test new    6\n4   abc 6\n0   test new    7\n0   abc 7\n34  test new    8\n910 abc 8\n</code></pre>\n\n<p>etc.</p>\n\n<p>I try to get this:</p>\n\n<pre><code>test new | abc | DefinitionID\n1           4     6\n0           0     7\n34          910   8\n</code></pre>\n\n<p>I try to pivot this, but without success. Column <code>dbo.[Values].Value</code> is type of <code>nvarchar(MAX)</code></p>\n"},{"tags":["sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":36,"score":0,"question_id":12743023,"title":"SQL Server 2005 : change collation for the existing database and LINQ2SQL","body":"<p>I have a SQL Server 2005 database. It was created with default collation which is not case-sensitive (my fault!). That's different from all other databases which I work with, where collations are by default case sensitive. I mostly consider comparing strings than sorting. I use Linq-to-SQL where there is no way to specify collation for <code>WHERE</code> clause.</p>\n\n<p>It seems that changing collation of existing database / server (and all tables' fields!) is error-prone and there is no tools for this.</p>\n\n<p>Maybe I'm missing something and there is a clean way?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","sql-server-2005","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12727942,"title":"Can I Group By an Unknown Number of Columns?","body":"<p>I am currently trying to re-write a stored procedure to take into account the normalisation of one of our tables. In the original procedure we have two tables:    </p>\n\n<pre><code>CREATE TABLE #t_batch\n(batch_id   integer, \nthread_group NVARCHAR(60),\ndye_code_1  NVARCHAR(10),\ndye_conc_1  NUMERIC(19, 7),\ndye_code_2  NVARCHAR(10),\ndye_conc_2  NUMERIC(19, 7),\ndye_code_3  NVARCHAR(10),\ndye_conc_3  NUMERIC(19, 7),\ndye_code_4  NVARCHAR(10),\ndye_conc_4  NUMERIC(19, 7),\ndye_code_5  NVARCHAR(10),\ndye_conc_5  NUMERIC(19, 7),\ndye_code_6  NVARCHAR(10),\ndye_conc_6  NUMERIC(19, 7))\n\nCREATE TABLE #t_group\n(group_id   INTEGER IDENTITY(1, 1),\ndye_code_1  NVARCHAR(10),\ndye_conc_1  NUMERIC(19, 7),\ndye_code_2  NVARCHAR(10),\ndye_conc_2  NUMERIC(19, 7),\ndye_code_3  NVARCHAR(10),\ndye_conc_3  NUMERIC(19, 7),\ndye_code_4  NVARCHAR(10),\ndye_conc_4  NUMERIC(19, 7),\ndye_code_5  NVARCHAR(10),\ndye_conc_5  NUMERIC(19, 7),\ndye_code_6  NVARCHAR(10),\ndye_conc_6  NUMERIC(19, 7),\nthread_group NVARCHAR(60), \nnum_batches INTEGER)\n</code></pre>\n\n<p>After a number of actions #t_batch was populated with a number of records. We then inserted data into #t_group in the following way:</p>\n\n<pre><code>INSERT INTO #t_group\n(dye_code_1, dye_conc_1, dye_code_2, dye_conc_2, dye_code_3, dye_conc_3,\ndye_code_4, dye_conc_4, dye_code_5, dye_conc_5, dye_code_6, dye_conc_6, \nthread_group, num_batches)\nSELECT dye_code_1, dye_conc_1, dye_code_2, dye_conc_2, dye_code_3, dye_conc_3, \ndye_code_4, dye_conc_4, dye_code_5, dye_conc_5, dye_code_6, dye_conc_6, \nthread_group, COUNT(batch_id_fk)\nFROM #t_batch\nGROUP BY dye_code_1, dye_conc_1, dye_code_2, dye_conc_2, dye_code_3, dye_conc_3, \ndye_code_4, dye_conc_4, dye_code_5, dye_conc_5, dye_code_6, dye_conc_6, \nthread_group\nORDER BY dye_code_1, dye_conc_1, dye_code_2, dye_conc_2, dye_code_3, dye_conc_3, \ndye_code_4, dye_conc_4, dye_code_5, dye_conc_5, dye_code_6, dye_conc_6, \nthread_group\n</code></pre>\n\n<p>So, we had a series of records that are grouped by the dye columns and a unique group_id for each unique combination of dyes and their concentrations. Also, there is a count of the batch records for each group. </p>\n\n<p>However, since there is in reality no limit to the number of dyes for a batch the tables have been normalised:</p>\n\n<pre><code>CREATE TABLE #t_batch\n(batch_id   INTEGER, \nthread_group NVARCHAR(60))\n\nCREATE TABLE #t_batch_dye\n(batch_id_fk INTEGER, \nstage   INTEGER,\nsequence    INTEGER, \ndye_code    NVARCHAR(10),\ndye_conc    NUMERIC(19,7))\n\nCREATE TABLE #t_group\n(group_id   INTEGER IDENTITY(1, 1),\nthread_group NVARCHAR(60), \nnum_batches INTEGER)\n\nCREATE TABLE #t_group_dye\n(group_id   INTEGER, \nstage   INTEGER,\nsequence    INTEGER,\ndye_code    NVARCHAR(10),\ndye_conc    NUMERIC(19,7))\n</code></pre>\n\n<p>Now, my question is: assuming that we have #t_batch and #t_batch_dye populated and that there are a varying number of #t_batch_dye records for each record in #t_batch, how can I insert records into #t_group with a unique group_id for each unique combination of dyes and their concentrations as well as a count of the batches for each group?</p>\n\n<p>Is this something I could use the PIVOT keyword for? The examples I have found on the web all seem to assume that the number of pivoted fields is known in advance.</p>\n\n<p>Many thanks, </p>\n\n<p>David</p>\n\n<p>Glasgow, Scotland</p>\n\n<hr>\n\n<p>Update:</p>\n\n<p>What I have done is to use a function that returns a concatenated string of codes and concs and used that to group the data.</p>\n\n<pre><code>DECLARE @dyes NVARCHAR(2000)  \n\n SELECT @dyes = ISNULL(@dyes,'') + dye_code + ' ' + convert(nvarchar,      requested_dye_conc) + ' '\n FROM   #t_batch_dye\n WHERE  batch_id_fk = @batch_id\n ORDER BY dye_code ASC\n</code></pre>\n"},{"tags":[".net","sql","xml","tsql","invalid"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":77,"score":-1,"question_id":12541666,"title":"How to parse xml file which has special characters in attribute values to java.parser not accepting .how to replace special character","body":"<p>I am trying to parse a xml file in java using DOM OR SAX.</p>\n\n<p>the problem is while parsing , if my xml contains atteibute values as special character like <code>&lt; &gt; \"</code> , then parser throws <code>ParserException</code>.</p>\n\n<p>for example xml file:</p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;\n&lt;abc&gt;\n     &lt;check name=\"bike\" value=\"apache&lt;is good model\"&gt;\n     &lt;check name=\"car\" value=\"tata \"sumo\"&gt;\n&lt;/abc&gt;\n</code></pre>\n\n<p>In this example xml element <code>&lt;check&gt;</code> has an attribute value and it contains <code>&lt;</code> or <code>\"</code> .</p>\n\n<p>The parser takes it as invalid and throws parser exception.</p>\n\n<p>Now my problem is before parsing xml file to parser, detect that special character in xml file attribute values and have to replace with symbol.</p>\n\n<p>eg:</p>\n\n<p>if xml contains <code>&lt;</code></p>\n\n<pre><code>&lt;check name=\"bike\" value=\"apache&lt;is good model\"&gt;\n</code></pre>\n\n<p>replace with space</p>\n\n<pre><code>&lt;check name=\"bike\" value=\"apache is good model\"&gt;\n</code></pre>\n\n<p>Please give me suggestions. In what method it can be done...can we do it using XSD...thanks in advance.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":4,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":75,"score":0,"question_id":12719266,"title":"How to join two unrelated tables in sql","body":"<p>I have two tables:</p>\n\n<p>Table 1: Formulas</p>\n\n<pre><code>FormulaId    Formula Text\n1            [Qty] * [Rect]\n2            [Qty] * [Al]\n3            [Mt] * [Cat]  \n</code></pre>\n\n<p>Table 2: Context</p>\n\n<pre><code>ContextId    Name\n1            Test 1\n2            Test 2\n3            Test 3\n4            Test 4    \n</code></pre>\n\n<p>I need to join those somehow in sql server 2008 R2 to get a table where for each context id I will have a full list of formulas, i.e.</p>\n\n<p>Result</p>\n\n<pre><code>ContextId    Name     FormulaId    Formula Text    \n1            Test 1   1            [Qty] * [Rect]\n1            Test 1   2            [Qty] * [Al]\n1            Test 1   3            [Mt] * [Cat]\n2            Test 2   1            [Qty] * [Rect]\n2            Test 2   2            [Qty] * [Al]\n2            Test 2   3            [Mt] * [Cat]\n3            Test 3   1            [Qty] * [Rect]\n3            Test 3   2            [Qty] * [Al]\n3            Test 3   3            [Mt] * [Cat]\n4            Test 4   1            [Qty] * [Rect]\n4            Test 4   2            [Qty] * [Al]\n4            Test 4   3            [Mt] * [Cat]\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":73,"score":1,"question_id":12739208,"title":"How to use Rank() in SQL Server","body":"<p>I have a problem using rank in SQL Server.</p>\n\n<p>Here's my code:</p>\n\n<pre><code>SELECT contendernum,totals, RANK() OVER (PARTITION BY ContenderNum ORDER BY totals ASC) AS xRank FROM\n(\nSELECT ContenderNum ,SUM(Criteria1+Criteria2+Criteria3+Criteria4) AS totals\nFROM dbo.Cat1GroupImpersonation\n GROUP BY ContenderNum\n) AS a\n</code></pre>\n\n<p>The results for that query are:</p>\n\n<pre><code>contendernum     totals      xRank\n1                    196       1\n2                    181       1\n3                    192       1\n4                    181       1\n5                    179       1\n</code></pre>\n\n<p>What my desired result is :</p>\n\n<pre><code>contendernum     totals      xRank\n    1                    196       1\n    2                    181       3\n    3                    192       2\n    4                    181       3\n    5                    179       4\n</code></pre>\n\n<p>I want to rank the result based on <code>totals</code> if there are same value like <code>181</code> then two numbers will have the same <code>rank</code></p>\n"},{"tags":["sql","sql-server","tsql","sql-order-by"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12739237,"title":"Sort the records in sqlserver with date( get the \"n\" latest added records from the table)","body":"<p>I have a table with a list of items. I add the records from the UI(asp.net webpage)\nAs n when I add the record, I also add the \"created date\" in a column with each record.\nNow I want to get the list of the 5 latest items, depending on the date. What will the query be ?\nmy Created_date columns has entries in this format: 2012-09-21</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12736551,"title":"Query to produce survey summary (PIVOT)","body":"<p>Let's suppose I have two tables:</p>\n\n<pre><code>Question (Id, Text)\nAnswer (Value, QuestionId, Guid)\n</code></pre>\n\n<p>Column <code>Guid</code> groups answers from the same person.</p>\n\n<p>I need a query to produce results like this:</p>\n\n<pre><code>'Question 1' | 'Question 2'\n4            | 3\n1            | NULL\nNULL         | 5\n2            | 6\n9            | NULL\n</code></pre>\n\n<p>Questions texts are transformed into column headers and answers values are in rows. Answers are grouped by <code>Guid</code>, so there are answers from one person in one row. If a person didn't answer particular question, NULL is returned.</p>\n\n<p>Number of questions can vary.</p>\n\n<p>Data used to produce sample results:</p>\n\n<pre><code> Question\n Id   | Text\n 1    | Question 1\n 2    | Question 2\n\n Answer\n Value | QuestionId | Guid\n 4     | 1          | AAA\n 3     | 2          | AAA\n 1     | 1          | BBB\n 5     | 2          | CCC\n 2     | 1          | DDD\n 6     | 2          | DDD\n 9     | 1          | EEE\n</code></pre>\n\n<p>Can you please help me out with a query to produce the results?</p>\n"},{"tags":["c#","sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":72,"score":0,"question_id":12736461,"title":"Best practice when create a subset of data in C#","body":"<p>What would be considered best practice when working with the following scenario?</p>\n\n<p>I have a dataset of ~6 million records total, broken down into 30+ tables with some tables having a few hundred thousand records.  I need to use an api that only allows an insert of 200 records at a time.</p>\n\n<p>I am breaking down the insert by table. Now here is where I am considering the first two options that came to my mind.  I can either get the full dataset for that table and then in C# loop through the dataset only inserting 200 at a time.  Or I can make multiple database calls grabbing 200 records at a time. Creating my object and making the call to the API to insert my records. Which I think I could make the next database call while the other records are being inserted.</p>\n"},{"tags":["sql","tsql","replication"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":12735721,"title":"How do I delete a Local Publication using T-SQL (by running a query)?","body":"<p>I want to delete the underlined below:</p>\n\n<p><img src=\"http://i.imgur.com/zuLxc.png\"></p>\n\n<p>How do I run a query to accomplish this task?</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12735730,"title":"recursive permutation combination","body":"<p>i need help achieving the following output.\ni have a table </p>\n\n<pre><code>declare @tblLevels  table(\nlevelsID                INT IDENTITY(1,1),\nlevelNumber             INT,\nlevelDesc               VARCHAR(100))\ninsert into @tblLevels(levelNumber,levelDescription)\n values \n(1,'L1D1'),\n(1,'L1D2'),\n(1,'L1D3'),\n(1,'L1D4'),\n(2,'L2D1'),\n(2,'L2D2'),\n(2,'L2D3'),\n(2,'L2D4'),\n(3,'L3D1'),\n(3,'L3D2'),\n(3,'L3D3')\n\nselect * from @tblLevels\n\nlevelsID    levelNumber levelDesc\n========================================\n1               1           L1D1\n2               1           L1D2\n3               1           L1D3\n4               1           L1D4\n5               2           L2D1\n6               2           L2D2\n7               2           L2D3\n8               2           L2D4\n9               3           L3D1\n10              3           L3D2\n11              3           L3D3\n</code></pre>\n\n<p>i have another table(@tblLevelSpreadOut) whose structure goes as below</p>\n\n<pre><code>declare @tblLevelSpreadOut  table(\nlevelSpreadOutID                INT IDENTITY(1,1),\nlevelNumber1                    INT,\nlevelDesc1                      VARCHAR(100),\nlevelNumber2                    INT,\nlevelDesc2                      VARCHAR(100),\nlevelNumber3                    INT,\nlevelDesc3                      VARCHAR(100))\n</code></pre>\n\n<p>it needs to be populated from the former table(@tblLevels), such that the output is</p>\n\n<pre><code>    select  levelNumber1, levelDesc1,  levelNumber2 ,levelDesc2 , levelNumber3 ,levelDesc3 \nfrom @tblLevelSpreadOut\n\n levelNumber1 levelDesc1  levelNumber2 levelDesc2  levelNumber3 levelDesc3\n============================================================================\n1   L1D1    2   L2D1    3   L3D1\n1   L1D1    2   L2D1    3   L3D2\n1   L1D1    2   L2D1    3   L3D3\n1   L1D1    2   L2D2    3   L3D1\n1   L1D1    2   L2D2    3   L3D2\n1   L1D1    2   L2D2    3   L3D3\n1   L1D1    2   L2D3    3   L3D1\n1   L1D1    2   L2D3    3   L3D2\n1   L1D1    2   L2D3    3   L3D3\n1   L1D1    2   L2D4    3   L3D1\n1   L1D1    2   L2D4    3   L3D2\n1   L1D1    2   L2D4    3   L3D3\n1   L1D2    2   L2D1    3   L3D1\n1   L1D2    2   L2D1    3   L3D2\n1   L1D2    2   L2D1    3   L3D3\n1   L1D2    2   L2D2    3   L3D1\n1   L1D2    2   L2D2    3   L3D2\n1   L1D2    2   L2D2    3   L3D3\n1   L1D2    2   L2D3    3   L3D1\n1   L1D2    2   L2D3    3   L3D2\n1   L1D2    2   L2D3    3   L3D3\n1   L1D2    2   L2D4    3   L3D1\n1   L1D2    2   L2D4    3   L3D2\n1   L1D2    2   L2D4    3   L3D3\n1   L1D3    2   L2D1    3   L3D1\n1   L1D3    2   L2D1    3   L3D2\n1   L1D3    2   L2D1    3   L3D3\n1   L1D3    2   L2D2    3   L3D1\n1   L1D3    2   L2D2    3   L3D2\n1   L1D3    2   L2D2    3   L3D3\n1   L1D3    2   L2D3    3   L3D1\n1   L1D3    2   L2D3    3   L3D2\n1   L1D3    2   L2D3    3   L3D3\n1   L1D3    2   L2D4    3   L3D1\n1   L1D3    2   L2D4    3   L3D2\n1   L1D3    2   L2D4    3   L3D3\n</code></pre>\n\n<p>thanks to all who replied and also to all who viewed the issue.</p>\n"},{"tags":["tsql","sybase"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":45,"score":1,"question_id":12732911,"title":"Sybase complains of duplicate insertion where none exists","body":"<p>I have moved some records from my SOURCE table in DB_1 into an ARCHIVE table in another DB_2 (ie. INSERTED the records from SOURCE into ARCHIVE and then DELETED the records from SOURCE.)</p>\n\n<p>My SOURCE table has the following index created as <code>SOURCE_1</code>:</p>\n\n<pre><code>CREATE UNIQUE NONCLUSTERED INDEX SOURCE_1\n    ON dbo.SOURCE(TRADE_SET_ID, ORDER_ID)\n</code></pre>\n\n<p>The problem is - when I try to insert the rows back into SOURCE from ARCHIVE, Sybase throws the following error:</p>\n\n<pre><code>Attempt to insert duplicate key row in object 'SOURCE' with unique index 'SOURCE_1'\n</code></pre>\n\n<p>And, of course, subsequently fails the insertions.</p>\n\n<p>I confirmed that my SOURCE table does not have these duplicates because the following query returned empty:</p>\n\n<pre><code>select * from DB_1.dbo.SOURCE\njoin DB_2.dbo.ARCHIVE\non DB_1.dbo.SOURCE.TRADE_SET_ID = DB_2.dbo.ARCHIVE.TRADE_SET_ID\nAND DB_1.dbo.SOURCE.ORDER_ID = DB_2.dbo.ARCHIVE.ORDER_ID\n</code></pre>\n\n<p>If the above query returned nothing, then that means I haven not violated my unique index constraint on the 2 columns, however Sybase complains that I have.</p>\n\n<p>Does anyone have any ideas on why this is happening?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12735365,"title":"SQL: Extract Row ID Based on the Min Value of Another Column","body":"<p>I can't seem to get this one.  So I have a table like this:</p>\n\n<pre><code>RowID    UserID  Type    Data\n1        A       A       1\n2        A       A       2\n3        A       B       1\n4        A       B       2\n5        B       A       1\n6        B       A       2\n7        B       B       1\n8        B       B       2\n</code></pre>\n\n<p>And I need to group this table by UserID and Type and then return the RowID for the record in each group that holds the MIN value in the Data column.</p>\n\n<p>So for my result set would be:\n1\n3\n5\n7</p>\n"},{"tags":["sql-server","tsql","sql-server-2008-r2","linked-server","user-defined-types"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12719738,"title":"Executing remote procedure with user-defined table type variable parameter","body":"<p>I'm trying to call a remote stored procedure over a linked server. The problem is, one of the required parameters is a user-defined table types. </p>\n\n<p>I can't seem to figure out how to declare a local variable as a user-defined table type from a remote server.</p>\n\n<p>This is what I'm trying so far, but it doesn't work:</p>\n\n<pre><code>DECLARE @tblVar [REMOTESERVER].REMOTEDB.dbo.user_defined_table_type\n\nEXEC [REMOTESERVER].REMOTEDB.dbo.procedure_name (@param1 = @tblVar)\n</code></pre>\n\n<p>However the error I'm getting is:</p>\n\n<blockquote>\n  <p>The type name 'REMOTESERVER.REMOTEDB.dbo' contains more than the maximum number of prefixes. The maximum is 1.</p>\n  \n  <p>Must declare the scalar variable \"@tblVar\"</p>\n</blockquote>\n"},{"tags":["tsql","wmi","monitor","wmi-query"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12734719,"title":"Is there a way to get WMI data into T-SQL","body":"<p>The following is a SQL-like command used in a sample VBScript to get Biztalk suspend instances via the WMI interface. </p>\n\n<pre><code>select * from MSBTS_serviceinstance where ServiceStatus=4 \n</code></pre>\n\n<p>MSBTS_serviceinstance is NOT a table, it is a WMI Class, as defined here: \n<a href=\"http://msdn.microsoft.com/en-us/library/aa560069%28v=BTS.70%29.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/aa560069%28v=BTS.70%29.aspx</a></p>\n\n<p>It is used in VBScript like this: </p>\n\n<pre><code> sQuery  = \"select * from MSBTS_serviceinstance where ServiceStatus=4 and ErrorId ='\" &amp; sErrorCode &amp; \"'\"   \n  Set intSet = GetObject(\"Winmgmts:!root\\MicrosoftBizTalkServer\").ExecQuery(sQuery)\n  ' then you have to loop through the results \n</code></pre>\n\n<p>Is there a way to run a similar command from directly T-SQL.  If I could get that data and store it in a table from T-SQL, then I wouldn't have to write a C# or VBScript program, and our DBA's could also understand and help maintain the code.  This is for the purpose of monitoring and created alerts; which so far is done mostly by SQL Agent Jobs.  [Down the road a few weeks or months we might be using Orion's Solar Wind to do more monitoring, but I need a quick alert created as soon as possible.] </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":9,"score":0,"question_id":12734772,"title":"SQL Server DB restore fails ","body":"<p>I am trying to do a SQL Server database restore using this T-SQL code:</p>\n\n<pre><code>----Make Database to single user Mode\nALTER DATABASE xyz\nSET SINGLE_USER WITH\nROLLBACK IMMEDIATE\n\n----Restore Database\nRESTORE DATABASE xyz\nFROM DISK = 'D:\\\\Program Files\\Microsoft SQL Server\\MSSQL.1\\MSSQL\\Backup\\xyz_backup_201204100301.bak'\nWITH MOVE 'abc' TO 'D:\\\\Program Files\\Microsoft SQL Server\\MSSQL.1\\MSSQL\\Data\\xyz.MDF',\nMOVE 'abc_log' TO 'E:\\\\Program Files\\Microsoft SQL Server\\MSSQL.1\\MSSQL\\Data\\xyz.LDF'\n</code></pre>\n\n<p>but I am getting this while running the following error:</p>\n\n<blockquote>\n  <p>Msg 5064, Level 16, State 1, Line 1<br>\n  Changes to the state or options of database 'xyz' cannot be made at this time. The database is in single-user mode, and a user is currently connected to it.<br>\n  Msg 5069, Level 16, State 1, Line 1<br>\n  ALTER DATABASE statement failed.</p>\n</blockquote>\n\n<p>How can I run my restore successfully?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12733638,"title":"multiple columns to XML column","body":"<p>Given two tables:</p>\n\n<p><code>T1( EntityID int , EmailAddress varchar(55),MaxNumberOfConnections int )</code></p>\n\n<p><code>T2( EntityID int , EntityAttributes XML )</code></p>\n\n<p>How do I insert all the data from <code>T1</code> into <code>T2</code> with a single statement in such a way that all the columns in <code>T1</code> (all but <code>EntityID</code> ) are converted into one XML column in <code>T2</code> : </p>\n\n<pre><code>T1( 1,'1234@1234.com',454)\n\nT2(1, '&lt;Attributes&gt;\n          &lt;Attribute EmailAddress=\"1234@1234.com\"&gt;\n          &lt;Attribute MaxNumberOfConnections =\"454\"&gt;\n      &lt;/Attributes&gt;' )\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":52,"score":2,"question_id":12732627,"title":"SQL Server system procedure 'sp_replmonitorrefreshjob'","body":"<p>What does this procedure do? It's a little discussed SP with no MSDN reference. </p>\n"},{"tags":["sql-server","tsql","sql-server-2012"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":58,"score":2,"question_id":12397224,"title":"Atomicity of INSERT with subquery","body":"<p>Assuming</p>\n\n<pre><code>CREATE TABLE TableA\n(\n    IntColumn INT NOT NULL PRIMARY KEY\n)\nINSERT INTO TableA VALUES (0)\n</code></pre>\n\n<p>is the following atomic?  i.e. if multiple application threads execute the following, am I at risk of an eventual PK violation?</p>\n\n<pre><code>INSERT INTO TableA\nVALUES ((SELECT MAX(IntColumn) FROM TableA) + 1)\n</code></pre>\n\n<p>Can you point me to any documentation about this?  My google-fu failed...</p>\n\n<p>[I'm aware of auto-incrementing columns, but that isn't sufficient for what I'm actually doing.]</p>\n"},{"tags":["sql","sql-server","xml","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1528,"score":1,"question_id":3809451,"title":"Convert tabular data to XML using SQL Server","body":"<p>I have a flattened table that contains columns that represent groups that need to be displayed in XML. Example data:</p>\n\n<pre><code>Market, Label, Style, Type\nXXX,    YYY,   JJJ,   111\nXXX,    YYY,   JJJ,   222\nXXX,    YYY,   JJJ,   333\nXXX,    YYY,   JJJ,   444    \nXXX,    YYY,   LLL,   111    \nXXX,    YYY,   LLL,   222    \nXXX,    YYY,   LLL,   333    \nXXX,    YYY,   LLL,   444\n</code></pre>\n\n<p>Using T-SQL what would be the best way to output the following:</p>\n\n<pre><code>&lt;Market value=XXX&gt;\n    &lt;label value=YYY&gt;\n       &lt;Style value=JJJ&gt;\n          &lt;Type value=111&gt;\n          &lt;/Type&gt;\n          ...\n       &lt;/Style&gt;\n       &lt;Style value=LLL&gt;\n          ...\n       &lt;/Style&gt;\n    &lt;/label&gt;\n&lt;/Market&gt;\n</code></pre>\n\n<p>Can I do this by using the XML Explicit clause in SQL Server?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":16,"score":0,"question_id":12732714,"title":"Error When Clicking on 'Edit' For Steps in Jobs","body":"<p>Every once in a while, after I've clicked on 'Edit' for steps on several SQL Agent jobs, I'll get the below error message.  </p>\n\n<p><img src=\"http://i.stack.imgur.com/zlgl9.png\" alt=\"enter image description here\">  </p>\n\n<p>When I exit and reopen SSMS, the errors stop appearing.  Anyone know what is causing this?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":13,"score":1,"question_id":12733040,"title":"Send Notification When Maintenance Plan Fails","body":"<p>Is there anyway to have Database Mail send a notification when a Maintenance Plan fails?  Or will this have to be done on the jobs that correspond to the Maintenance Plan?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":12732846,"title":"What is a 'Target Server' in a SQL Server Agent Job?","body":"<p>Can someone explain what a 'Target Server' is in this instance.  Also, what it means to \"Target Multiple Servers\"?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12729313,"title":"Order By using case with conditional results and partition row_number()","body":"<p>I have a SQL that I've not been able to return the order correctly.  Below is example of the rows and the order I want them to appear in.  I tried ORDER BY WITH CONDITIONAL CASE AND ROW_NUMBER OVER PARTION without success.  I want ColA to be the primary sort and ColB secondary only when ColC has a length &lt; 3 otherwise ColB is primary and ColA is secondary</p>\n\n<pre><code>ColA      ColB      ColC            \n5   750 15  \n5   750 15  \n3   984 13  \n3   984 13  \n5   1021    15  \n5   1021    15  \n4   1602    14  \n4   1602    14  \n4   1823    14  \n4   1823    14  \n6   4099    16  \n6   4099    16  \n11  4099    240990  \n0   10880   10  \n0   10880   10  \n3   10881   13  \n3   10881   13  \n2   11053   12  \n8   11053   211053  \n6   10891   16  \n6   10891   16  \n2   11034   12  \n10  11034   211034  \n\nColA      ColB      ColC            \n0   10880   10  \n0   10880   10  \n2   11034   12  \n10  11034   211034  \n2   11053   12  \n8   11053   211053  \n3   984 13  \n3   984 13  \n3   10881   13  \n3   10881   13  \n4   1602    14  \n4   1602    14  \n4   1823    14  \n4   1823    14  \n5   750 15  \n5   750 15  \n5   1021    15  \n5   1021    15  \n6   4099    16  \n6   4099    16  \n11  4099    240990  \n6   10891   16  \n6   10891   16  \n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":58,"score":3,"question_id":12729920,"title":"Shortcut method for n columns compared against the same constant?","body":"<p>I can't find an answer one way or the other for this. Pretty simple question with very little detail.</p>\n\n<p>Is there a better way to do something like this:</p>\n\n<pre><code>SELECT *\nFROM tablename tn\nWHERE tn.col1 = 1\n      AND tn.col2 = 1\n      AND tn.col3 = 1\n      AND tn.col4 = 1\n      ...\n      AND tn.coln = 1\n</code></pre>\n\n<p>Where multiple columns all have to be compared the same way to a single constant?</p>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":422,"score":1,"question_id":5378357,"title":"Error: There are uncommitted transactions","body":"<p>I open a new window in SSMS and run this:</p>\n\n<pre><code>SET ANSI_DEFAULTS ON \nGO\n\nCREATE PROCEDURE [dbo].[zzz_test2]\n(\n    @a    int\n)\nAS\n    SET NOCOUNT ON\n    SET @a=1\n    RETURN 0\nGO\n</code></pre>\n\n<p>and then close the window, which results in this warning:</p>\n\n<p><code>There are uncommitted transactions. Do you wish to commit these before closing the window?</code></p>\n\n<p>what is going on??</p>\n\n<p>when I open a new SSMS window and run this:</p>\n\n<pre><code>SET ANSI_NULLS  ON  \nGO    \n\nCREATE PROCEDURE [dbo].[zzz_test2]\n(\n    @a    int\n)\nAS\n    SET NOCOUNT ON\n    SET @a=1\n    RETURN 0\nGO\n</code></pre>\n\n<p>and close the window, I get no warning.</p>\n"},{"tags":["sql","sql-server","tsql","threshold"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":42,"score":-1,"question_id":12730262,"title":"T-SQL Calculate threshold from a recordset","body":"<p>I have the following result set :</p>\n\n<pre><code>    ContentSendId ContentId   NewsletterId Position    IsConditionMatch SendDate                NumberOfSends IsSendValid\n    ------------- ----------- ------------ ----------- ---------------- ----------------------- ------------- -----------\n    1             100001      51           1           0                2011-05-14 00:00:00.000 200           0\n    2             100001      51           1           0                2011-05-13 00:00:00.000 300           0\n    3             100001      51           1           0                2011-05-14 00:00:00.000 100           0\n    4             100001      51           1           0                2011-05-13 00:00:00.000 200           0\n</code></pre>\n\n<p>I need to run a calculation in T-SQL where if given a threshold value a record should get inserted (into a temp table) and any values outside the threshold should be ignored</p>\n\n<p>So in this example lets say the threshold value is 500, the first record and the second record should get inserted.</p>\n\n<p>EDIT :\nRunning total is something to take care of in this scenario, so for example (above example updated) in the above scenario the temp table should insert 1st and 2nd record and stop since the threshold of 500 has been met.</p>\n"},{"tags":["sql","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":10358,"score":3,"question_id":1707326,"title":"Define variable to use with IN operator (T-SQL)","body":"<p>I have a Transact-SQL query that uses the IN operator. Something like this:</p>\n\n<pre><code>select * from myTable where myColumn in (1,2,3,4)\n</code></pre>\n\n<p>Is there a way to define a variable to hold the entire list \"(1,2,3,4)\"? How should I define it?</p>\n\n<pre><code>declare @myList &lt;strong&gt;{data type}&lt;/strong&gt;&lt;br&gt;\nset @myList = (1,2,3,4)&lt;br&gt;\nselect * from myTable where myColumn in @myList\n</code></pre>\n"},{"tags":["sql-server","xml","tsql","attributes","root"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":134,"score":0,"question_id":12726426,"title":"TSQL for xml add schema attribute to root node","body":"<p>My situation is this (simplified):</p>\n\n<pre><code>DECLARE @period XML = (\nSELECT\n'2012' 'period'\nFOR XML PATH(''), ROOT ('survey'))\n\nDECLARE @persons XML = (\nSELECT\nPerson.Name 'users/person'\nFROM Person\nFOR XML PATH(''), ROOT ('company'))\n\nSET @persons.modify('insert sql:variable(\"@period\") as first into (/company)[1]')\nSELECT @persons\n</code></pre>\n\n<p>Which gives me a XML like this:</p>\n\n<pre><code>&lt;company&gt;\n  &lt;survey&gt;\n    &lt;period&gt;2012&lt;/period&gt;\n  &lt;/survey&gt;\n  &lt;users&gt;\n    &lt;person&gt;Dubach&lt;/person&gt;\n  &lt;/users&gt;\n  &lt;users&gt;\n    &lt;person&gt;Pletscher&lt;/person&gt;\n  &lt;/users&gt;\n  ...\n</code></pre>\n\n<p>Now I need to add a XML-schema to the root node like this:</p>\n\n<pre><code>&lt;company xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.mydomain.com/xmlns/bla/blabla/myschema.xsd\" xmlns=\"http://www.mydomain.com/xmlns/bla/blabla\"&gt;\n  &lt;survey&gt;\n    &lt;period&gt;2012&lt;/period&gt;\n  &lt;/survey&gt;\n  &lt;users&gt;\n    &lt;person&gt;Dubach&lt;/person&gt;\n  &lt;/users&gt;\n  &lt;users&gt;\n    &lt;person&gt;Pletscher&lt;/person&gt;\n  &lt;/users&gt;\n  ...\n</code></pre>\n\n<p><a href=\"http://msdn.microsoft.com/en-us/library/ms177400%28v=sql.100%29.aspx\" rel=\"nofollow\">Microsoft says I have to use <strong>WITH XMLNAMESPACES</strong></a> before the SELECT statement but that does not work in my case.</p>\n\n<p>How can I add these xmlnamespaces?</p>\n"},{"tags":["sql","sql-server","tsql","replace","trim"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":12725852,"title":"case statement to delete extra spaces only when there is some","body":"<p>I replace all blanks with @ using this</p>\n\n<pre><code>SELECT *,  REPLACE(NAME,' ','@') AS NAME2\n</code></pre>\n\n<p>which results miss@test@blogs@@@@@@@@@@@@@@ (different number of @s dependent on length of name!</p>\n\n<p>I then delete all @ signs after the name using this </p>\n\n<pre><code>select *, substring(Name2,0,charindex('@@',Name2)) as name3\n</code></pre>\n\n<p>which then gives my desired results of, for example MISS@test@blogs</p>\n\n<p>However some wheren't giving this result, they are null. This is because annoyingly some rows in the sheet I have read in dont have the spaces after the name.</p>\n\n<p>is there a case statement i can use so it only deletes @ signs after the name if they are there in the first place?\nThanks</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":48,"score":1,"question_id":12726090,"title":"Cant use LIKE but need to find related records in SQL Server","body":"<p>I've got a table used for issue tracking (kind of like stackoverflow :) to log PC related issues) and for simplicity I'll narrow it down to a few fields, something like the following:</p>\n\n<pre><code>Site               Category          Issue\nMI Office          Software          My MS word does not run macros.\nCL Office          Hardware          PC memory needs to be upgraded\nMX Office          Printer           Printer is out of memory.\nMI Office          Software          Office product prompts for allowing macro to run\n</code></pre>\n\n<p>I want to find related issues when I am looking at for instance one issue.  I can't really use the <code>LIKE</code> operator as for instance if I do:</p>\n\n<p><code>SELECT...FROM...WHERE Issue LIKE '%My MS word does not run macros.%'</code></p>\n\n<p>Would only return the first record.  Do I have to figure out how to pull key words like \"Macros\" ?  How would I find related records so that my query for instance could return records 1 and 4.  Or return 2 and 3 together?</p>\n"},{"tags":["sql","sql-server-2008","tsql","like","full-text"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":5,"view_count":98,"score":-5,"question_id":12724702,"title":"SQL text LIKE doesn't always work","body":"<p>I'm comparing text values in the same table and same column in SQL Server 2008, but the results are sometimes incorrect. Possibly relevant column info:  </p>\n\n<pre><code>Data type: text  \nFull Text: True  \nCollation: SQL_Latin1_General_CP1_CI_AS\n</code></pre>\n\n<p>Out of 100 actual matches I only get 62. I have compared field values that are not picked up by LIKE in some comparison tools and they are 100% same, no additional spaces, line breaks etc.</p>\n\n<p>Any idea why text LIKE doesn't always work?</p>\n\n<p>SQL:</p>\n\n<pre><code>SELECT a.text as one, b.text as two\n  FROM [Db].[dbo].[Table] a join\n  [Db].[dbo].[Table] b on\n  a.text LIKE b.text\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":106,"score":1,"question_id":12724337,"title":"How to use GETDATE() function in SQL Server to select a column value?","body":"<p>How to use <code>GETDATE()</code> in SQL Server to select a column value from table whose date is only 1 year back from today.</p>\n\n<p>E.g :</p>\n\n<pre><code> Select LTRating, RHDate \n from Accounts and If LTRating ='D' then RHDate = CURRENTDATE()-365\n</code></pre>\n\n<p>All <code>LTRating</code> column values and if <code>LTRating</code> value is 'D' the Date must be 1 year old only</p>\n"},{"tags":["xml","sql-server-2008","tsql","sql-server-2005","validation"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12724440,"title":"SQL Server :  validate XML","body":"<p>I'm using SQL Server 2005 and 2008 and am trying to import a variety different XML files into my db, and occasionally the XML is not valid. Each XML file will differ from the last.</p>\n\n<p>Is there any way to create a function which will return 0 or 1 depending on whether the XML is valid?</p>\n\n<p>Thanks</p>\n\n<p>C</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","stored-procedures"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":88,"score":0,"question_id":12542825,"title":"multiple outer join on the same table - low performance","body":"<p>My sales app. need to perform some calculation for assessment of distribution and sales operations, \nall the needed data within one table: \n<br>My tables:\nStoreTable: <code>storeId int,StoreName varchar</code>\nProductsDistributionTable:</p>\n\n<pre><code>distributionId int, StoreId int, DistributionDate date,productA float,productB float,productC float.\n</code></pre>\n\n<p>Indexes:storeId(PK),DistributionId(pk),distributionDate. <br>\nNONCLUSTERED INDEX [IX_D_storeID] ON [dbo].distribution <br>\nThe number of stores greater than 10,000 stores!<br>\nDistribution data for 3 months: records more than 3,500,000 records!\n<br>\nto get data looks like:</p>\n\n<p><br>  <code>store Id   storeName  Average from begining       Average within period, LastSales  ,LastSales within period , DaysFromLastSalesDateB,LastSalesDateA</code>\n<br>I used a stored proc:<br></p>\n\n<pre><code>ALTER PROCEDURE [dbo].[USP_StoresAndDistributionEvaluation_CX]\n        @startDate           date  ,\n        @endDate           date   \nAS\ndeclare @dateDiff_A Int\nset @dateDiff_A=DATEDIFF(dd,@startDate,@endDate)\nset @dateDiff_A=@dateDiff_A + 1;\n\nSELECT  s.storeId,s.storeName, Total_Average,  Period_Average, LastSalesValueA,LastSalesValueB, DaysFromLastSalesDateB,LastSalesDateA\nFROM (\n    SELECT  \n        sG.storeName, ds.storeId,  isnull(Period_Average,0)  as Period_Average,\n        isnull(DATEDIFF(dd,LastSalesDateA,getDate()),0) as DaysFromLastSalesDateA,\n        isnull(DATEDIFF(dd,LastSalesDateB,@endDate),0) as DaysFromLastSalesDateB\n    FROM \n        (\n            select \n                ds.storeId,\n                (isnull(SUM(product_A) + sum(product_C) + sum(product_B) ,0) / (DATEDIFF(dd, min(DistributionDate), getDate()) + 1)) AS Total_Average, \n                max(ds.DistributionDate) as lastSalesDateA\n            from dbo.distributionTable  ds\n            where (DistributionDate &gt;= '2012/01/01')\n            and ((product_A &gt; 0) OR  (product_B &gt; 0) OR  (product_C &gt; 0))\n            group by ds.storeId \n\n        ) AS ds\n        INNER JOIN\n            (select storeId, StoreName from dbo.storesTable) as s ON ds.storeId = s.storeId\n        LEFT OUTER JOIN (\n            SELECT \n                storeId, \n                (isnull(SUM(product_A) + sum(product_C) + sum(product_B) ,0) / @dateDiff_A) AS Period_Average,\n                max(DistributionDate) as LastSalesDateB\n            FROM  dbo.distributionTable\n            WHERE (DistributionDate BETWEEN CONVERT(VARCHAR, @startDate, 102) AND CONVERT(VARCHAR, @endDate, 102))\n            group by storeId\n            ) AS q ON q.storeId = ds.storeId\n        LEFT OUTER JOIN (\n            SELECT top 1 \n                storeId, \n                (isnull((product_A) + (product_C) + (product_B) ,0)) AS LastSalesValueA \n            FROM  dbo.distributionTable\n            WHERE (DistributionDate &gt;= '2012/01/01')\n            order by DistributionDate desc\n            ) AS qb on  qb.storeId = ds.storeId\n        LEFT OUTER JOIN (\n            SELECT top 1 \n                storeId, \n                (isnull((product_A) + (product_C) + (product_B) ,0)) AS LastSalesValueB \n            FROM  dbo.distributionTable\n            WHERE (DistributionDate BETWEEN CONVERT(VARCHAR, @startDate, 102) AND CONVERT(VARCHAR, @endDate, 102))\n            order by DistributionDate desc\n            ) AS qm on qm.storeId = ds.storeId\n    GROUP BY      \n        s.storeId, s.storeName, Total_Average, Period_Average, LastSalesValueA, LastSalesValueB, DaysFromLastSalesDateB, LastSalesDateA\n) as aq     \n</code></pre>\n\n<p><strong>The problem:performance is very bad</strong> <br></p>\n\n<p><br>\n<strong>EDIT :</strong> update first select statement (where , having).\n<br>I wonder if there is an optimal way to enhance this queries\n<br> Any help greatly appreciated!</p>\n"},{"tags":["sql","sql-server","tsql","triggers","jobs"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12709761,"title":"Select Values based on Range Automatically and Trigger Email","body":"<p>The table from which a data range is to be queried :</p>\n\n<pre><code>Id  Variance\n1     2\n2     17\n3     7\n4     4\n5     20\n6     1\n7     111\n8     8\n9     18\n10    67\n</code></pre>\n\n<p>Another table that has </p>\n\n<pre><code> Freq    StartRange   EndRange\nH   10         7\nH   8          8\nH   6          20   \n</code></pre>\n\n<p>The data in the first table is loaded every 30mins through an SSIS package.</p>\n\n<p>Now I want alert as in emails to be triggered when the data in the Variance column falls in the StartRange and EndRange.</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[SP_Email] @Start varchar(50),@End varchar(50),@Date datetime\nAS\nBEGIN\nDECLARE @xml NVARCHAR(MAX)\nDECLARE @body NVARCHAR(MAX)\n\nSET @xml = CAST(( SELECT [SlNo] AS 'td','',[date] AS 'td','',\n   [lag] AS 'td','', Percent AS 'td'\nFROM  TestTbl \nWHERE(percent &gt;= @Start AND percent &lt; @End)\nAND CAST(CONVERT(VARCHAR,curDate,106) AS DATETIME) = CAST(@Date AS DATETIME)\nORDER BY SlNo \nFOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))\n\nSET @body ='&lt;html&gt;&lt;body&gt;&lt;H3&gt;Report&lt;/H3&gt;\n&lt;table border = 1&gt; \n&lt;tr&gt;\n&lt;th&gt; SlNo &lt;/th&gt; &lt;th&gt; date &lt;/th&gt; &lt;th&gt; lag &lt;/th&gt; &lt;th&gt; Percent &lt;/th&gt;&lt;/tr&gt;'    \n\nSET @body = @body + @xml +'&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;'\n\nEXEC msdb.dbo.sp_send_dbmail\n@profile_name = 'Alert', \n@body = @body,\n@body_format ='HTML',\n@recipients = 'abc@gmail.com'\n@subject = 'Report';\nEND\n</code></pre>\n\n<p>Please suggest a process that will help me setup such in SQL Server 2005.</p>\n\n<p>Thanks in Advance</p>\n"},{"tags":["sql-server","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":14,"down_vote_count":0,"view_count":8570,"score":14,"question_id":26652,"title":"Is there a way to make a TSQL variable constant?","body":"<p>Is there a way to make a TSQL variable constant?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":223,"score":2,"question_id":12204577,"title":"Exporting binary file data (images) from SQL via a stored procedure","body":"<p>I am trying to export a fairly larege number of image files, stored internally in an SQL database as binary data. </p>\n\n<p>Being fairly new to writing stored procedures in SQL, I have come across a couple of very usefull guides on how this can be achived, but I seem to be missing something.</p>\n\n<p>I am running SQL Server 2008 R2 locally, and I am trying to write the files to a folder on my C:\\ drive.</p>\n\n<p>Here is the buisness part of what I have so far:</p>\n\n<pre><code>BEGIN\nDECLARE @cmd VARCHAR(8000)\nDECLARE @result int\n\nDECLARE curExportBinaryDocs CURSOR FAST_FORWARD FOR\nSELECT 'BCP \"SELECT Photograph_Data FROM [ALBSCH Trial].[dbo].[Photograph] WHERE Photograph_ID = '\n  + CAST(Photograph_ID AS VARCHAR(500)) + '\" queryout \"' + @OutputFilePath \n  + CAST(Photograph_ID AS VARCHAR(500)) + '.jpg\"' + ' -n -T'\nFROM dbo.Photograph\n\nOPEN curExportBinaryDocs   \nFETCH NEXT FROM curExportBinaryDocs INTO @cmd\nWHILE @@FETCH_STATUS = 0\n  BEGIN\n     --PRINT @cmd\n     EXEC @result = xp_cmdshell @cmd         \n     FETCH NEXT FROM curExportBinaryDocs INTO @cmd\n  END \nCLOSE curExportBinaryDocs\nDEALLOCATE curExportBinaryDocs\nEND\n</code></pre>\n\n<p>'@result' is always being set to '1' (failed) after the xp_cmdshell call. All the table names/fields are correct, so I suspect there is something wrong with my BCP call, but I am not sure what to try next.</p>\n\n<p>Any help or advice would be very welcome.</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12722728,"title":"Query to find the first date after a specific grouped sum value","body":"<p>I have an article table that holds the current stock for each article. I need to know the last date when new stock has arrived, after running out of stock for that specific article.</p>\n\n<p>The table looks like this.</p>\n\n<pre><code>+-----------+-----------------+-------+\n| ArticleID |    StockDate    | Stock |\n+-----------+-----------------+-------+\n|         1 | 1/1/2012 10:15  |   100 |\n|         1 | 2/1/2012 13:39  |   -50 |\n|         1 | 2/1/2012 15:17  |   -50 |\n|         1 | 4/1/2012 08:05  |   100 |\n|         2 | 5/1/2012 09:48  |    50 |\n|         1 | 6/1/2012 14:21  |   -25 |\n|         1 | 7/1/2012 16:01  |    10 |\n|         2 | 8/1/2012 13:42  |   -10 |\n|         1 | 9/1/2012 09:56  |   -85 |\n|         1 | 13/1/2012 08:12 |   100 |\n|         1 | 13/1/2012 10:50 |   -15 |\n+-----------+-----------------+-------+\n</code></pre>\n\n<p>The output should look like this.</p>\n\n<pre><code>+-----------+-----------------+\n| ArticleID |    StockDate    |\n+-----------+-----------------+\n|         2 | 5/1/2012 09:48  |\n|         1 | 13/1/2012 08:12 |\n+-----------+-----------------+\n</code></pre>\n\n<p>How did i get this output? ArticleID 1 had a 100 in stock but reached 0 for the first time on 2/1/2012 15:17. Then new stock arrived and it hit 0 again at 9/1/2012 09:56. So the result should shows the first date after the last empty stock grouped by ArticleID. ArticleID 2 didn't had a 0 point, so the first stock date is shown.</p>\n\n<p>I need a result set that can be joined with other queries. So a Stored Procedure does not work for me.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":91,"score":0,"question_id":12722631,"title":"Cannot-resolve the collation conflict between \"SQL_Latin1_General_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the equal to operation","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1607560/cannot-resolve-the-collation-conflict-between-sql-latin1-general-cp1-ci-as-and\">Cannot resolve the collation conflict between &ldquo;SQL_Latin1_General_CP1_CI_AS&rdquo; and &ldquo;Latin1_General_CI_AS&rdquo; in the equal to operation</a>  </p>\n</blockquote>\n\n\n\n<p>When I try to join two tables on the same column a.C1=b.C2 I get this message:</p>\n\n<p>Cannot resolve the collation conflict between \"SQL_Latin1_General_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the equal to operation.</p>\n\n<p>Can you tell me please is there any way to join them without changing the collations in tables?</p>\n\n<pre><code>SELECT * FROM\nBIT_Dashboard.dse.Solution a\nINNER JOIN\nLeistungsportfolio.dbo.EBFHB_Jobliste b\nON a.Solution_NAM = b.SolutionName\nWHERE a.Solution_NAM COLLATE DATABASE_DEFAULT = b.SolutionName COLLATE DATABASE_DEFAULT\n</code></pre>\n\n<p>Error Msg: \"Cannot resolve the collation conflict between \"SQL_Latin1_General_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the equal to operation.\"</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12722740,"title":"How to update a virtual Table with SQL?","body":"<p>I have this sql statement:</p>\n\n<pre><code>    SELECT \n     t0.col0,\n     t0.col1,\n     t2.col0,\n     t2.col1,\n     t1.col0,\n     t1.col1,\n     t3.col3,\n     t3.col5,\n     t1.col2\n    FROM table0 t0\n    INNER JOIN table1 t1 ON t0.col0 = t1.col1\n    INNER JOIN table2 t2 ON t2.col0 = t1.col0\n    INNER JOIN table3 t3 ON t1.col0 = t3.col1\n    WHERE t1.col1 in (300, 301, 302, 302)\n    AND t2.col5 like 'V-%'\n    AND t3.delete = 'false'\n</code></pre>\n\n<p>this is working perfectly and shows a virtual table with the joined columns. So i try to directly update this Table like this way:</p>\n\n<pre><code>UPDATE T SET  T.col1 = 1, T.col2 = '01.01.2012'\nFROM (\n    SELECT \n     t0.col0,\n     t0.col1,\n     t2.col0,\n     t2.col1,\n     t1.col0,\n     t1.col1,\n     t3.col3,\n     t3.col5,\n     t1.col2\n    FROM table0 t0\n    INNER JOIN table1 t1 ON t0.col0 = t1.col1\n    INNER JOIN table2 t2 ON t2.col0 = t1.col0\n    INNER JOIN table3 t3 ON t1.col0 = t3.col1\n    WHERE t1.col1 in (300, 301, 302, 302)\n    AND t2.col5 like 'V-%'\n    AND t3.delete = 'false'\n) as T\n</code></pre>\n\n<p>without success... The only way to made it was to create a View and proceed update on it. </p>\n\n<p>But can i update in one statement a virtual Table?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":42,"score":2,"question_id":12722298,"title":"GROUP-BY expression must contain at least one column that is not an outer reference","body":"<p>i have this query:</p>\n\n<pre><code>SELECT\nSolutionName    -- Solution_NAM\nfrom  Table_View\nGroup By 1\n</code></pre>\n\n<p>where Table_View is of course a view.\nI am gettign this error message:</p>\n\n<p>Each GROUP BY expression must contain at least one column that is not an outer reference.</p>\n\n<p>Can you help me resolve this?\nIts inside Ms SQL Server 2008</p>\n"},{"tags":["sql","tsql","group-by","sql-order-by"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":1,"view_count":76,"score":0,"question_id":12719754,"title":"SQL Executing Order by and Group by togather","body":"<p>I have the following table </p>\n\n<pre><code>UNIQUEKEY    ID      Clicks IsProcessed   INSERTDATE\n 1         100001   10        1         2011-05-14 00:00:00.000\n 2         100001   20        0         2011-05-13 00:00:00.000\n 3         100001   30        1         2011-05-18 00:00:00.000\n 4         100002   10        1         2011-05-20 00:00:00.000\n 5         100002   15        0         2011-05-24 00:00:00.000\n 6         100002   10        0         2011-05-05 00:00:00.000\n</code></pre>\n\n<p>I need a T-SQL query which will first Order by INSERTDATE (desc)\nOnce ordered it should return me a GROUP by on ID and IsProcessed and the result should display ALL columns Orderby and grouped by as described above.</p>\n\n<p>EDIT :\nSo If we run the query for lets say <code>ID 10001</code> it should give me 2 result sets :\nDesired Result :</p>\n\n<pre><code>UNIQUEKEY    ID      Clicks IsProcessed   INSERTDATE\n 3         100001   30        1         2011-05-18 00:00:00.000\n 1         100001   10        1         2011-05-14 00:00:00.000        \n 2         100001   20        0         2011-05-13 00:00:00.000\n</code></pre>\n\n<p>Reson being <code>ID</code> and <code>IsProcessed</code> are serving as a key and the Result is sorted by <code>Date (desc)</code>.</p>\n\n<p>Any help would be appreciated !</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12719011,"title":"SQL Server Date casting and format issue","body":"<p>I am trying to convert my existing sql dates in a table which is stored in <code>yyyy-mm-dd</code> format using following command to <code>dd-mm-yyyy</code>. While doing so I can successfully convert it to <code>nvarchar</code> data type but when convert it as date I receive still same old format of <code>yyyy-mm-dd</code>. </p>\n\n<p>Here is query</p>\n\n<pre><code>Select \n    Convert(date, CONVERT(VARCHAR(10), a.LogDateTime, 103), 103) AS LDate  \nfrom sec.[Log] AS a\n</code></pre>\n\n<p>I did also try to convert from <code>nvarchar</code> to date using following script but result remain same.</p>\n\n<pre><code>SELECT convert(date, '23/10/2016', 103)\n</code></pre>\n\n<p>Can any one tell what exactly the problem is? As I want my date to get convert to british format from us format without changing its datatype.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12718897,"title":"SQL Server CHECK Constraint - Ensure no duplicates on text","body":"<p>Need to add some sort of constraint on my table column. I need to make sure that the user does not enter, manually or otherwise, the same text in more than one row of the table. How can I achieve this? </p>\n"},{"tags":["sql-server-2008","tsql","merge"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":28,"score":1,"question_id":12718727,"title":"MERGE is not merging data as expected","body":"<p>My first attempt at a MERGE run is not throughing any errors but it is not merging the data like I want. Can anyone tell me what I am doing wrong? The point is to compair #Temp and #tblCollectionGameList and update #tblCollectionGameList so that it contains only the items inside #Temp (inserting missing items into tblCollecitonGameList and deleteing items from tblColletionGameList that are no longer in #Temp)</p>\n\n<pre><code>    CREATE TABLE #Temp\n(\n    CollectionID smallint NOT NULL,\n    IncludedSectionID smallint NOT NULL\n)\n\nINSERT INTO #Temp (CollectionID, IncludedSectionID) VALUES(0, 0);\nINSERT INTO #Temp (CollectionID, IncludedSectionID) VALUES(0, 1);\n\nSELECT * FROM #Temp;\n\nCREATE TABLE #tblCollectionGameList\n(\n    ID smallint IDENTITY(0,1) NOT NULL,\n    CollectionID smallint NOT NULL,\n    IncludedSectionID smallint\n)\n\nINSERT INTO #tblCollectionGameList (CollectionID, IncludedSectionID) VALUES(0,0);\nINSERT INTO #tblCollectionGameList (CollectionID, INcludedSectionID) VALUES(0,2);\n\nSELECT * FROM #tblCollectionGameList;\n\nBEGIN TRAN\n\nMERGE #tblCollectionGameList AS t\nUSING #Temp AS s\nON (t.CollectionID = s.CollectionID)\nWHEN NOT MATCHED BY TARGET\n    THEN\n        INSERT(CollectionID, IncludedSectionID) VALUES (s.CollectionID, s.IncludedSectionID)\nWHEN NOT MATCHED BY SOURCE\n    THEN\n        DELETE;\n\nSELECT * FROM #tblCollectionGameList;\n\nROLLBACK TRAN\n\nDROP TABLE #Temp;\nDROP TABLE #tblCollectionGameList;\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":2085,"score":6,"question_id":6046510,"title":"Stored procedure to drop table","body":"<p>I have created a stored procedure that will drop a table if it exists in a database. When running the stored procedure with EXEC, I am getting the following error: </p>\n\n<blockquote>\n  <p>Msg 203, Level 16, State 2, Procedure\n  sp_DropIfExists, Line 13 The name 'IF\n  EXISTS(SELECT 1 FROM sys.objects WHERE\n  OBJECT_ID = OBJECT_ID(N'table_name')\n  AND type = (N'U')) DROP TABLE\n  [table_name]' is not a valid\n  identifier.</p>\n</blockquote>\n\n<p>However if i copy and paste the T-SQL that is generated into management studio, it seems to be running fine. Can someone explain why this is not valid? The fix would be nice, but I am really after the Why primarily, The How would be nice to though! Thanks in advance. </p>\n\n<pre><code>ALTER PROCEDURE [dbo].[sp_DropIfExists](@tableName VARCHAR(255)) \nAS\nBEGIN\n    SET NOCOUNT ON;\n    DECLARE @SQL VARCHAR(MAX);\n    SET @SQL = 'IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(N''' + @tableName + ''') AND type = (N''U'')) DROP TABLE [' + @tableName + ']'\n    PRINT @SQL;\n    EXEC @SQL;\nEND\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12709014,"title":"Determine SELECTs are equivalent","body":"<p>Can you please help me to determine if these 2 SELECTs are equivalent?</p>\n\n<pre><code>SELECT sd.SESSION_DATA_ID\nFROM SessionData sd\nWHERE sd.DEVICE_TYPE = 'TRAC'\n    AND (EXISTS\n          (SELECT sr.ID\n           FROM SessionResult sr\n           LEFT JOIN BarcodeValues bv ON \n                sr.BARCODE_VALUE_0 = bv.ID AND \n                sr.SESSION_DATA_ID = sd.SESSION_DATA_ID AND\n                sr.EVENT_NAME = 'Multi Full Cntr'\n           WHERE\n             bv.ENCRYPTED_VALUE LIKE '' OR bv.ENCRYPTED_VALUE IS NULL))\n\nSELECT\n    DISTINCT sd.SESSION_DATA_ID\nFROM SessionData sd\nLEFT JOIN SessionResult sr ON sd.SESSION_DATA_ID = sr.SESSION_DATA_ID\nLEFT JOIN BarcodeValues bv ON bv.ID = sr.BARCODE_VALUE_0\nWHERE\n    sd.DEVICE_TYPE = 'TRAC' AND\n    (sr.EVENT_NAME = 'Multi Full Cntr' AND\n    bv.ENCRYPTED_VALUE LIKE '' OR bv.ENCRYPTED_VALUE IS NULL) OR\n    sr.EVENT_NAME is NULL\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":106,"score":1,"question_id":12713011,"title":"Multiple rows calculation SQL Server","body":"<p>I have a table :</p>\n\n<pre><code>UNIQUE KEY ID      Clicks    INSERTDATE\n 1         100001   10     2011-05-14 00:00:00.000\n 2         100001   20     2011-05-13 00:00:00.000\n 3         100001   30     2011-05-18 00:00:00.000\n 4         100002   10     2011-05-20 00:00:00.000\n 5         100002   15     2011-05-24 00:00:00.000\n 6         100002   10     2011-05-05 00:00:00.000\n</code></pre>\n\n<p>I have a threshold value for clicks, lets say 20.</p>\n\n<p>I need to write a T-SQL which should remove the clicks that do not meet the threshold of the accumulative Sum of clicks for each ID.</p>\n\n<p>So for the above example ID \"100001\" has an accumulative clicks of 60 (10+20+30) but since the threshold is 20, the last record i.e. with the click value of 30 should get removed from the result.\nHowever, the second record should still be included even though the sum at that point is > my threshold (10 + 20).</p>\n\n<p>EDIT :</p>\n\n<p>Another major rule that needs to be applied is that the INSERTDATE has to be ordered before performing any calculations</p>\n\n<p>Any help would be much appreciated.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12716719,"title":"SQL One-to-many or NONE to many?","body":"<p>I have a one-to-many join. Works flawlessly, and quickly. The one-to-many may have zero records in the many table. If this is the case, I want to join it to ALL records in the many table.</p>\n\n<pre><code>USERS\n-----\nUserID | Name\n\nCATEGORIES\n------------------\nCategoryID | CategoryName\n\nUSER_CATEGORIES\n---------------\nUserID | CategoryID\n</code></pre>\n\n<p>IF there are NO categories assigned to the user, I would like to join ALL categories. The reasoning behind this is, some users may manage all categories. If a category is added, it's automatically assigned to those users.</p>\n\n<pre><code>1 | Michael\n2 | Bob\n\n100 | Billing\n101 | Email\n102 | Technical\n\n1 | 101\n</code></pre>\n\n<p>I would like the result to be:</p>\n\n<pre><code>1 | Michael | 101 | Email\n2 | Bob | 100 | Billing\n2 | Bob | 101 | Email\n2 | Bob | 102 | Technical\n</code></pre>\n\n<p>So far, the way it works is:</p>\n\n<pre><code>DECLARE @USERS TABLE (UserID INT, UserName VARCHAR(10));\nDECLARE @USER_CATEGORIES TABLE (UserID INT, CategoryID INT);\nDECLARE @CATEGORIES TABLE (CategoryID INT, CategoryName VARCHAR(10));\n\nINSERT INTO @USERS (UserID, UserName)\n(\n    SELECT 1, 'Michael' UNION ALL\n    SELECT 2, 'Bob'\n)\n\nINSERT INTO @CATEGORIES (CategoryID, CategoryName)\n(\n    SELECT 100, 'Billing' UNION ALL\n    SELECT 101, 'Email' UNION ALL\n    SELECT 102, 'Technical'\n)\n\nINSERT INTO @USER_CATEGORIES (UserID, CategoryID)\n(\n    SELECT 1, 101\n)\n\nSELECT\n  U.UserID\n  , U.UserName\n  , C2.CategoryID\n  , C2.CategoryName\nFROM\n  @USERS U LEFT JOIN\n  @USER_CATEGORIES UC ON U.UserID = UC.UserID LEFT JOIN\n  @CATEGORIES C ON UC.CategoryID = C.CategoryID LEFT JOIN\n  @CATEGORIES C2 ON C.CategoryID = C2.CategoryID OR (C.CategoryID IS NULL)\n</code></pre>\n\n<p>Is this the correct way to handle this? It seems to be a little too much overhead when I have many users/category combinations.</p>\n"},{"tags":["sql-server","tsql","pivot","common-table-expression","recursive-query"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":57,"score":3,"question_id":12716753,"title":"SQL Server recursive CTE and pivot don't work together","body":"<p>Why doesn't this <a href=\"http://sqlfiddle.com/#!3/5637b/12/0\" rel=\"nofollow\">SQL Fiddle</a> work?</p>\n\n<p>Full script replicated:</p>\n\n<pre><code>create table tbl (\n  id int,\n  month varchar(9),\n  value float);\ninsert tbl values\n(1,'Jan',0.12),\n(1,'Feb',0.36),\n(1,'Mar',0.72),\n(2,'Mar',0.11),\n(2,'Apr',0.12),\n(2,'May',0.36);\n\ndeclare @tbl table (\n  id int,\n  number int,\n  month varchar(9),\n  value float);\ninsert @tbl\nselect id.id, Months.Number, Months.Name, t.value\nfrom (values(1,'Jan'),\n            (2,'Feb'),\n            (3,'Mar'),\n            (4,'Apr'),\n            (5,'May'),\n            (6,'Jun')) Months(Number,Name)\ncross join (select distinct id from tbl) id\nleft join tbl t on t.month = Months.name and t.id=id.id;\n\n;with cte as (\n  select id,Number,month,isnull(Value,0.0)value\n  from @tbl\n  where Number=1\n  union all\n  select cte.id,cte.Number+1,cte.month,isnull(t.value,cte.Value)\n  from cte\n  join @tbl t on t.id=cte.id and t.number=cte.number+1\n)\n/*update t\nset value=cte.value\nfrom @tbl t\njoin cte on t.id=cte.id and t.number=cte.number;*/\n\nselect id, Jan,Feb,Mar,Apr,May,Jun\nfrom (select id,month,value from /*@tbl*/ cte) p\npivot (max(value) for month in (Jan,Feb,Mar,Apr,May,Jun)) v;\n</code></pre>\n\n<p>Expected result:</p>\n\n<pre><code>ID  JAN FEB MAR APR MAY JUN\n1   0.12    0.36    0.72    0.72    0.72    0.72\n2   0   0   0.11    0.12    0.36    0.36\n</code></pre>\n\n<p>Actual result:</p>\n\n<pre><code>ID  JAN FEB MAR APR MAY JUN\n1   0.72    (null)  (null)  (null)  (null)  (null)\n2   0.36    (null)  (null)  (null)  (null)  (null)\n</code></pre>\n\n<p>If you uncomment the commented-out code, it works.  However, if you select from the CTE directly <code>SELECT * FROM CTE</code>, it shows the same values that are in <code>@tbl</code> after the UPDATE statement.</p>\n\n<p>I spent time analyzing <a href=\"http://stackoverflow.com/a/5417257/573261\">CTE + ROW_NUMBER()</a> a while back but hoping someone could explain this one.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12715819,"title":"Is there a T-SQL equivalent for #include, and why","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/3243139/constants-and-include-files-in-tsql\">Constants and Include files in TSQL</a>  </p>\n</blockquote>\n\n\n\n<p>I've been looking for a T-SQL equivalent of the C \"#include\" directive. As I haven't found, I wonder</p>\n\n<ul>\n<li>Is it possible that MS did not include any sort of SQL files inclusion / joined execution</li>\n<li>If not, why</li>\n<li>If not, is there any better way for me to execute several SQL files at once without copy-paste or manual precompilation</li>\n</ul>\n\n<p>For those curious of my motivations, I am writing a set of similar queries, and I find it convenient to externalize constants (from enum tables), pre-computations (making some test input tables) and parameter variables (which subsets I'm working on). </p>\n\n<p>As far as I know, I can't really use stored procedures or functions for that (And I don't like the idea of polluting my DB with those).</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12715765,"title":"TSQL self join to get results","body":"<p>I run the following query</p>\n\n<pre><code>Select * From\n(\nSelect \n    GUID,\n    MFG_CODE,\n    STK_NAME,\n    parentid,\n    masteritem,\n    ROW_NUMBER() over(order by guid) r\n From Fstock Where MasterItem=1 OR isNull(parentID, '')=''\n ) a\n Where r between 4716 And 4716\n</code></pre>\n\n<p>And I get following results</p>\n\n<pre><code>GUID    MFG_CODE    parentid    masteritem  r\n31955   369553         0            1       4717\n</code></pre>\n\n<p>As you can see <code>GUID 31955</code> is actually a <code>parentITEM</code> &amp; I need to bring in all the children of this parent item within the same query.</p>\n\n<p>For example if I do:</p>\n\n<pre><code>Select * From Fstock where parentID = 31955\n</code></pre>\n\n<p>It returns 3 children of it</p>\n\n<pre><code>GUID\n31956\n31957\n31958\n</code></pre>\n\n<p>So is there a way to combine these two queries together, I only want to return fixed amount of rows using <code>row_number()</code> function, however those returned rows sometimes contain a <code>Parent ITem</code>, I would like to return the children for those parent items as well within same query.</p>\n\n<p>Performance is very important for me.</p>\n\n<p>--- EDIT ----\nI got it to work with following query, does anyone have other ideas?</p>\n\n<pre><code>With CTE\n\nAs\n(\n\nSelect \n    GUID,\n    Manufacturer,\n    SELL_PRICE,\n    MFG_CODE,\n    parentid,\n    masteritem,\n    ROW_NUMBER() over(order by GUID) r\n From Fstock Where MasterItem=1 OR isNull(parentID, '')=''\n\n ) \n\nSelect A.*,F.parentID From\n(\n Select * From CTE\n Where r between 4717 And 6000  \n) A\n Left join Fstock F on F.parentID = A.GUID\n Order by A.r\n</code></pre>\n"},{"tags":["asp.net","sql","tsql","replication"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":19,"score":0,"question_id":12716654,"title":"How do I check whether a Local Publication exists given the publication name and how do I delete it along with everything associated with it?","body":"<p>I'm working in ASP .NET and I need to do a couple of things:</p>\n\n<ol>\n<li>Check whether the Publication I'm about to create already exists.</li>\n<li>If it does, delete it along with EVERYTHING related to it (jobs, etc. including anything at the subscriber side).</li>\n</ol>\n\n<p>I started with this:</p>\n\n<pre><code>public static bool PublicationExists(string server)\n        {\n            string finalConnString = Properties.Settings.Default.rawConnectionString.Replace(\"&lt;&lt;DATA_SOURCE&gt;&gt;\", server).Replace(\"&lt;&lt;INITIAL_CATALOG&gt;&gt;\", \"tempdb\");\n\n            using (var conn = new SqlConnection(finalConnString))\n            {\n                using (var cmd = new SqlCommand(\"what is the query to check whether a publication exists?\", conn))\n                {\n                    conn.Open();\n                    cmd.ExecuteNonQuery();\n\n                    using (var da = new SqlDataAdapter(cmd))\n                    {\n                        using (var ds = new DataSet())\n                        {\n                            da.Fill(ds);\n\n                            if (ds.Tables[0].Rows.Count &gt; 0)\n                            {\n                                return true;\n                            }\n                            return false;\n                        }\n                    }\n                }\n            }\n        }\n</code></pre>\n\n<p>Now...</p>\n\n<pre><code>If (PublicationExists(server) == true)\n{\n    //I want to delete the publication along with everything associated with it.\n}\n</code></pre>\n\n<p>How would I go about doing this?</p>\n"},{"tags":["sql","sql-server","tsql","foreign-keys","drop"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":83,"score":2,"question_id":12715001,"title":"Is there a simpler and faster way of dropping a table that has foreign key references to other tables?","body":"<p>I have a new table that has foreign key references to a number of existing tables. When I create the new table for the first time, I created the foreign keys in the following way:</p>\n\n<pre><code>ALTER TABLE [dbo].[NewTable] WITH CHECK ADD FOREIGN KEY([SectionDatabaseID])\nREFERENCES [dbo].[Section] ([SectionDatabaseID])\n\nALTER TABLE [dbo].[NewTable] WITH CHECK ADD FOREIGN KEY([TermDatabaseID])\nREFERENCES [dbo].[Term] ([TermDatabaseID])\n</code></pre>\n\n<p>The above way will generate names for the foreign key constraints using it's own automated naming convention.</p>\n\n<p>However, I want to drop the new table because I need to do some major modifications by creating it from scratch.</p>\n\n<p>Obviously, if I just execute a drop statement, the SQL Server database will complain stating that the new table has foreign key references to other tables.</p>\n\n<p>I've heard of running the following script to figure out what foreign keys exist so that we can drop them:</p>\n\n<pre><code>use perls;\nSELECT 'ALTER TABLE ' + TABLE_SCHEMA + '.[' + TABLE_NAME +\n'] DROP CONSTRAINT [' + CONSTRAINT_NAME + ']'\nFROM information_schema.table_constraints\nWHERE CONSTRAINT_TYPE = 'FOREIGN KEY' and TABLE_NAME = 'NewTable'\n</code></pre>\n\n<p>The above will give results that basically show alter statements which I need to run.</p>\n\n<p>I need something more automated. Why do I have to drop each foreign key constraint separately, and then only be able to drop the table?</p>\n\n<p>I want to drop the table in a simpler way. It's got to be easier than what I need to do above.</p>\n"},{"tags":["sql","sql-server","tsql","token","sql-job"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":12713283,"title":"How do I pass the SQL Server Job name to a stored procedure inside this job?","body":"<p>I have a job:</p>\n\n<p>RunProcedures</p>\n\n<p>It has steps:</p>\n\n<p>Step 1: Do Something<br>\nStep 2: Do something Else<br>\nStep 3: Email<br></p>\n\n<p>In step 3, I have:</p>\n\n<pre><code>EXEC spSendSuccessEmail -- and here's where I want to pass the job name.\n</code></pre>\n\n<p>Here's the code for the stored procedure above:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[spSendSuccessEmail] @JobName VARCHAR(30)\nAS \nBEGIN\n    SET NOCOUNT ON;\n\n    DECLARE @EmailBody VARCHAR(50)\n\n    SET @EmailBody = @JobName + ' ran successfully'\n\n    BEGIN TRY\n        EXEC msdb.dbo.sp_send_dbmail \n            @profile_name = 'DBTeam',\n            @recipients = 'user@universe.com',\n            @copy_recipients = 'user2@universe.com',\n            @subject = 'Process Complete',\n            @body = @EmailBody,\n            @importance = 'Normal',\n            @sensitivity = 'Normal';\n    END TRY\n    BEGIN CATCH\n        EXEC spGetDatabaseErrorInfo\n    END CATCH           \nEND\n</code></pre>\n\n<p>How do I pass to this stored procedure the name of the job it's in?</p>\n\n<p>I read on tokens but I'm a little confused on how to accomplish this task.</p>\n\n<p>Can anyone give me a hand?</p>\n"},{"tags":["tsql","sql-server-2012","sqlperformance"],"answer_count":3,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":45,"score":3,"question_id":12715217,"title":"SQL Server 2012 poor performance when selecting using LIKE from a large table","body":"<p>I have a table with ~1M rows and run the following SQL against it:</p>\n\n<pre><code>select * from E where sys like '%,141,%'\n</code></pre>\n\n<p>which takes 2-5 seconds to execute (returning ~10 rows), I need it to be 10 times faster at least, is it something which can be achieved with SQL Server 2012?</p>\n\n<p><strong>A sample <code>sys</code> value (<code>sys</code> values length ranges from 5 to 1000 characters):</strong></p>\n\n<pre><code>1,2,3,7,9,10,11,12,14,17,28,29,30,33,35,37,40,41,42,43,44,45,46,47,48,50,51,53,55,63,69,\n72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,97,109,110,111,113,117,\n119,121,122,123,124,130,131,132,133,134,135,139,141,146\n</code></pre>\n\n<p><strong>The table's DDL:</strong></p>\n\n<pre><code>CREATE TABLE [dbo].[E](\n    [o] [int] NOT NULL,\n    [sys] [varchar](8000) NULL,\n    [s] [varchar](8000) NULL,\n    [eys] [varchar](8000) NULL,\n    [e] [varchar](8000) NULL,\n CONSTRAINT [PK_E] PRIMARY KEY CLUSTERED \n(\n    [o] ASC\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","llblgenpro"],"answer_count":6,"favorite_count":3,"up_vote_count":7,"down_vote_count":0,"view_count":1162,"score":7,"question_id":1509561,"title":"SQL query slow from .NET code, but not interactively","body":"<p>We are using an ORM that is executing a call from .NET to SQL Server's sp_executesql stored procedure.</p>\n\n<p>When the stored proc is called from .NET, we receive a timeout exception.</p>\n\n<p>Looking at Profiler, I can see that the query is indeed taking a long time to execute.</p>\n\n<p>The query is essentially:</p>\n\n<pre><code>exec sp_executesql N'SELECT DISTINCT\nFROM [OurDatabase].[dbo].[Contract] [LPLA_1] ) [LPA_L1]\nLEFT JOIN [OurDatabase].[dbo].[Customer] [LPA_L2]  ON [LPA_L2].[Customer_ID]=[LPA_L1].[CustomerId] AND [LPA_L2].[Data]=[LPA_L1].[Data])\nWHERE ( ( ( ( ( [LPA_L1].[DealerId] = @DealerId1)) \nAND ( [LPA_L2].[Last_Name] = @LastName2))))',N'@DealerId1 varchar(18),@LastName2 varchar(25)',@DealerId1='1234',@LastName2='SMITH'\n</code></pre>\n\n<p>The confusing part for me is this: If I copy and paste the query that's timing out into SQL Management studio and execute it interactively, it executes just fine.</p>\n\n<p>Does anyone know why the same query would take significantly longer when executed via .NET code? (I'm able to reproduce this -- the query executed from code consistently times out, and the query executed interactively consistently works fine.)</p>\n\n<p>Any help is appreciated. Thanks!</p>\n"},{"tags":["sql-server","performance","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12714907,"title":"What is the best way to rewrite this query by removing sub-queries from select clause?","body":"<p>I couldn't figure out how to optimize this query and I didn't find a similar query as example.</p>\n\n<p>What would be the best way to rewrite this query in order not to have so many sub-queries in the select clause achieving the same result grouped by month/brand_id?</p>\n\n<p>The DBMS is SQL Server.</p>\n\n<pre class=\"lang-cs prettyprint-override\"><code>select\n    o.brand_id,\n    count(o.item_id) as \"Total bought items\",\n    count(o.sell_date) as \"Total sold items\",\n     /* Amount of sold items grouped by month per item */\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 1 and obj.brand_id = b.brand_id) as \"Jan\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 2 and obj.brand_id = b.brand_id) as \"Feb\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 3 and obj.brand_id = b.brand_id) as \"Mar\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 4 and obj.brand_id = b.brand_id) as \"Apr\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 5 and obj.brand_id = b.brand_id) as \"May\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 6 and obj.brand_id = b.brand_id) as \"Jun\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 7 and obj.brand_id = b.brand_id) as \"Jul\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 8 and obj.brand_id = b.brand_id) as \"Aug\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 9 and obj.brand_id = b.brand_id) as \"Sep\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 10 and obj.brand_id = b.brand_id) as \"Oct\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 11 and obj.brand_id = b.brand_id) as \"Nov\",\n    (select count(obj.sell_date) from tab_object as obj where month(obj.install_date) = 12 and obj.brand_id = b.brand_id) as \"Dec\"\nfrom  tab_brand as b\nleft join tab_object as o on b.brand_id = o.brand_id\n                            and year(o.sell_date) = 2012\nwhere b.brand_id in (1234, 1324, 1423, 2314)\ngroup by b.brand_id\norder by b.brand_id;\n</code></pre>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":9,"favorite_count":2,"up_vote_count":7,"down_vote_count":0,"view_count":4988,"score":7,"question_id":4024072,"title":"How to remove accents and all chars <> a..z in sql-server?","body":"<p>I need to do the following modifications to a varchar(20) field:</p>\n\n<ol>\n<li>substitute accents with normal letters (like  to e)</li>\n<li>after (1) remove all the chars not in a..z</li>\n</ol>\n\n<p>for example</p>\n\n<pre><code>'a=.32s df' \n</code></pre>\n\n<p>must become </p>\n\n<pre><code>'aeacsdf'\n</code></pre>\n\n<p>are there special stored functions to achieve this easily?</p>\n\n<p><strong>UPDATE</strong>: please provide a T-SQL not CLR solution. This is the workaround I temporarly did because it temporarly suits my needs, anyway using a more elegant approach would be better.</p>\n\n<pre><code>CREATE FUNCTION sf_RemoveExtraChars (@NAME nvarchar(50))\nRETURNS nvarchar(50)\nAS\nBEGIN\n  declare @TempString nvarchar(100)\n  set @TempString = @NAME \n  set @TempString = LOWER(@TempString)\n  set @TempString =  replace(@TempString,' ', '')\n  set @TempString =  replace(@TempString,'', 'a')\n  set @TempString =  replace(@TempString,'', 'e')\n  set @TempString =  replace(@TempString,'', 'e')\n  set @TempString =  replace(@TempString,'', 'i')\n  set @TempString =  replace(@TempString,'', 'o')\n  set @TempString =  replace(@TempString,'', 'u')\n  set @TempString =  replace(@TempString,'', 'c')\n  set @TempString =  replace(@TempString,'''', '')\n  set @TempString =  replace(@TempString,'`', '')\n  set @TempString =  replace(@TempString,'-', '')\n  return @TempString\nEND\nGO\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":7,"favorite_count":3,"up_vote_count":11,"down_vote_count":0,"view_count":15234,"score":11,"question_id":1488355,"title":"IF EXISTS, THEN SELECT ELSE INSERT AND THEN SELECT","body":"<p>How do you say the following in Microsoft SQL Server 2005:</p>\n\n<pre><code>IF EXISTS (SELECT * FROM Table WHERE FieldValue='') THEN\n   SELECT TableID FROM Table WHERE FieldValue=''\nELSE\n   INSERT INTO TABLE(FieldValue) VALUES('')\n   SELECT TableID FROM Table WHERE TableID=SCOPE_IDENTITY()\nEND IF\n</code></pre>\n\n<p>What I'm trying to do is to see if there is a blank fieldvalue already, and if there is then return that TableID, else insert a blank fieldvalue and return the corresponding primary key.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12713816,"title":"Dynamic tsql variable data types causing query to return wrong results","body":"<p>I am using Sql Server 2008</p>\n\n<p>Say you have a table named \"Weights\" and within that table you have a column named \"Weight\" with its data type defined as \"real\" with the following data.</p>\n\n<p>Weight(real data type)</p>\n\n<p>2\n2.001\n2.002\n2.003\n2.004\n2.005\n2.006\n2.007\n2.008\n2.009\n3</p>\n\n<p>Here is the query I am running in the new query window against the table</p>\n\n<pre><code>declare @sql nvarchar(MAX)\ndeclare @params nvarchar(MAX)\ndeclare @interval float = .001\ndeclare @conversion float = 1/@interval         \n\nset @sql =\nN'select FLOOR(Weight * @INPUTconversion)*@INPUTinterval as [Weight],\nCOUNT(1) as ''Count''\nFROM dbo.Weights\nGROUP BY FLOOR(Weight*@INPUTconversion)*@INPUTinterval\norder by FLOOR(Weight*@INPUTconversion)*@INPUTinterval'\n\nset @params =\nN'\n@INPUTconversion real,\n@INPUTinterval float'\n\nexec sp_executesql @sql, @params,  \n@INPUTconversion = @conversion,\n@INPUTinterval = @interval\n</code></pre>\n\n<p>Here is the result which appears to be wrong.</p>\n\n<p>Weight Count</p>\n\n<p>2   2\n2.002   1\n2.003   1\n2.004   1\n2.005   1\n2.006   1\n2.007   2\n2.009   1\n3   1</p>\n\n<p>How can I make the return look like this using the same query? Do I need to change my variable data types?</p>\n\n<p>Weight Count</p>\n\n<p>2   1\n2.001   1\n2.002   1\n2.003   1\n2.004   1\n2.005   1\n2.006   1\n2.007   1\n2.008   1\n2.009   1\n3   1</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":80,"score":0,"question_id":9716869,"title":"Table Insert and Range Check ?","body":"<p>I'm using the <a href=\"http://technet.microsoft.com/en-us/library/dd776382.aspx\" rel=\"nofollow\">Table Value constructor</a> to insert a bunch of rows at a time.</p>\n\n<p>However if i'm using sql replication, I run into a range check constraint on the publisher on my id column managed automatically.</p>\n\n<p>The reason is the fact that the id range doesn't seem to be increased during an insert of several values, meaning that the max id is reached before the actual range expansion could occur (or the id threshold).</p>\n\n<p>It looks like this <a href=\"http://support.microsoft.com/kb/972006\" rel=\"nofollow\">problem</a> for which the solution is either running the merge agent or run the sp_adjustpublisheridentityrange stored procedure.</p>\n\n<p>I'm litteraly doing something like :</p>\n\n<pre><code>INSERT INTO dbo.MyProducts (Name, ListPrice)\nVALUES ('Helmet', 25.50),\n       ('Wheel', 30.00),\n       ((SELECT Name FROM Production.Product WHERE ProductID = 720),\n        (SELECT ListPrice FROM Production.Product WHERE ProductID = 720));\nGO\n</code></pre>\n\n<p>What are my options (if I don't want or can't adopt any of the proposed solution) ? Expand the range ? Decrease the threshold ? </p>\n\n<p>Can I programmatically modify my request to circumvent this problem ? </p>\n\n<p>thanks.</p>\n"},{"tags":["query","tsql","subquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12699111,"title":"Update table using inner join with subquery","body":"<p>I've searched the web and have been unable to come up with a solution. I appreciate any help given.</p>\n\n<p>I've got a table with these values, among others.</p>\n\n<pre><code>Item Charge No  Item Ledger Entry No    IsReceivedInFull\n--------------------------------------------------------\nOcean Freight   1525593\nFactory Cost    1525593\nOverhead        1525593\nFactory Cost    1525593\nFee             1525593\nDuty            1525593\nLanding Freight 1525593\n</code></pre>\n\n<p>I'm trying to loop through my results to check that for each Item Ledger Entry No I've got these five components in my table; 'Ocean Freight', 'Factory Cost', 'Fee', 'Duty', and 'Landing Freight'. If an individual Item Ledger Entry No has atleast five rows, one for each of the above mentioned Item Charge No's then I'd like to set 'IsReceivedInFull' to \"Yes\"</p>\n\n<p>I come from an ABAP programming background and know this would be easily done with a couple of LOOP statements but I'm new to T-SQL and have struggled to solve this simple problem. Please help.</p>\n"},{"tags":["sql","sql-server","tsql","ssms"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":69,"score":3,"question_id":12640180,"title":"I want to write a summary query and present the results in a single table","body":"<p>I need to write a summary report on 3 different status values, with a count and an amount column for each status, with the results presented in a single table.  For example, the output would look like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/xyORi.png\" alt=\"enter image description here\"></p>\n\n<p>The query to produce each line of code (in an individual output) is:</p>\n\n<pre><code>select case when status_key = '2' then 'Paid' else '' end as 'Status'\n, COUNT(BillNo) as [Count]\n, SUM(amtpd) as [Amount Paid]\nfrom billtable \nwhere client = 101\nand status_key = '2'\ngroup by status_key\n\nselect case when status_key = '1' then 'Queued' else '' end as 'Status'\n, COUNT(BillNo) as [Count]\n, SUM(amtpd) as [Amount Paid]\nfrom billtable \nwhere client = 101\nand status_key = '1'\ngroup by status_key\n\nselect case when status_key = '4' then 'Hold' else '' end as 'Status'\n, COUNT(BillNo) as [Count]\n, SUM(amtpd) as [Amount Paid]\nfrom billtable \nwhere client = 101\nand status_key = '4'\ngroup by status_key\n</code></pre>\n\n<p>This produces three results like:</p>\n\n<p><img src=\"http://i.stack.imgur.com/vZaiW.png\" alt=\"enter image description here\"></p>\n\n<p>I am using SQL Server database and SSMS to develop the query.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","date"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12708616,"title":"Finding months between given dates","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/7885851/months-between-two-dates\">Months between two dates</a>  </p>\n</blockquote>\n\n\n\n<p>I need to bring the result ,what are the months falls between two dates.  </p>\n\n<p>Eg. Suppose date is</p>\n\n<pre><code>Declare @FrDate datetime,@ToDate datetime\nSet @FrDate ='2010-05-31 17:38:58.577' \nSet @ToDate ='2010-09-01 17:38:58.577'\n</code></pre>\n\n<p>need Output </p>\n\n<pre><code>Result\nMAY\nJUN\nJUL\nAUG\nSEP\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":12706956,"title":"Is there a way to duplicate part of a adjacent list hierarchy given a starting id?","body":"<p>I have an adjacent list hierarchy model that makes up a topic structure</p>\n\n<pre><code>   ID   Parent_Id Topic_Name\n   1    Null      Topic 1\n   2    Null      Topic 2\n   3    2            Topic 3\n   4    3               Topic 4\n   5    2            Topic 5\n   6    Null      Topic 6\n</code></pre>\n\n<p>This forms part of an application which I cant change - the topics dont have multiple parents so unfortunatly I can't move to a nested sets - although if this was an interim step in the process - this would be fine as long as it went back to adjacent list hierarchy model</p>\n\n<p>I want to specify a topic id and then copy it to a new topic id and retain the levels / structure underneath</p>\n\n<p>So in my example I could specify topic topic_id 2 and it would create</p>\n\n<pre><code>   ID   Parent_Id Topic_Name\n   7    Null      Topic 2\n   8    7            Topic 3\n   9    8               Topic 4\n   10   7            Topic 5\n</code></pre>\n\n<p>Auto numbering is taken care of for the ID so no need to construct that, but obviously the parent id needs to be retained</p>\n\n<p>How can I achieve the above? would I need to flatten the data and do 3 seperate inserts logging the id after each insert?</p>\n"},{"tags":["visual-studio-2010","tsql","vb.net-2010"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":5,"view_count":46,"score":-5,"question_id":12707752,"title":"I am getting duplicate rows of data when using a union. How do I eliminate the duplicates?","body":"<p>Below is the result from the query in question.  As you can see, some of the duplicate records (UPC) is missing data in several cloumns (Single_Retail, Case_Retail, etc) this is the data that is not suppose to retun.  There is data(UPC) that are duplicated that return data in all columns except Case_Retail, this is correct.  </p>\n\n<pre><code>Vendor_Num  Vendor_Name Vendor_item Reporting_Desc  Department  Category    Sales_Group Sales_SubGroup  Pack_Multiplier Receiving_UPC   Single_UPC  Single_PLU  Receiving_Zone_Desc Cost    Unit_Cost   Single_Retail   Case_Retail Entering_Retail Gross_Dollars   Gross_Percent   Begin_Retail_Date   Promo_Effective_Date    Promo_Expire_Date   Is_Promo    Deactivation_Date\n4710273 ASSOCIATED DISTRIBUTORS INC.    616312  YELLOW TAIL MOSCATO ALCB    11  111 115 1   031259032856    031259032856        ASSOC DIST ALL  5.24    5.24    --- --- --- --- --- 08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    616312  YELLOW TAIL MOSCATO ALCB    11  111 115 1   031259032856    031259032856        ASSOC DIST ALL  5.24    5.24    7.99    7.99    7.99    2.75    34.42   08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    516642  YELLOW TAIL RED ROO ALCB    11  111 115 1   031259044095    031259044095        ASSOC DIST ALL  5.24    5.24    --- --- --- --- --- 08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    516642  YELLOW TAIL RED ROO ALCB    11  111 115 1   031259044095    031259044095        ASSOC DIST ALL  5.24    5.24    7.99    7.99    7.99    2.75    34.42   08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    702402  VERDI GREEN APPLE SPARKLETINI   ALCB    11  111 115 1   038075207307    038075207307        ASSOC DIST ALL  4.49    4.49    --- --- --- --- --- 08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    702402  VERDI GREEN APPLE SPARKLETINI   ALCB    11  111 115 1   038075207307    038075207307        ASSOC DIST ALL  4.49    4.49    6.49    6.49    6.49    2.00    30.82   08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    10081       ROLLING RCK 12OZ 6PK NR ALCB    10  100 107 4   444444201713    071439348063        ASSOC DIST ALL  17.45   4.36    5.99    --- 23.96   1.63    27.21   03/05/2012  03/05/2012  12/31/2525  N   01/01/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    10081       ROLLING RCK 12OZ 6PK NR ALCB    10  100 107 4   444444201713    071439348063        ASSOC DIST ALL  17.45   4.36    6.09    --- 24.36   1.73    28.41   08/29/2012  08/29/2012  12/31/2525  N   01/01/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    104455      JDCC PUNCH 4PK  ALCB    10  108 100 6   444444119995    082184054338        ASSOC DIST ALL  28.74   4.79    6.99    --- 41.94   2.20    31.47   06/13/2006  06/13/2006  01/01/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    104457      JDCC LMNDE 4PK  ALCB    10  108 100 6   444444119988    082184054352        ASSOC DIST ALL  28.74   4.79    6.99    --- 41.94   2.20    31.47   06/13/2006  06/13/2006  01/01/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    105967      JD DWN HOME PNCH6P  ALCB    10  108 107 4   444444127990    082184226018        ASSOC DIST ALL  23.96   5.99    7.99    --- 31.96   2.00    25.03   04/29/2012  04/29/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    210682  GNARLY HEAD PINOT GRIGIO    ALCB    11  111 115 1   082242293334    082242293334        ASSOC DIST ALL  6.74    6.74    --- --- --- --- --- 08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    210682  GNARLY HEAD PINOT GRIGIO    ALCB    11  111 115 1   082242293334    082242293334        ASSOC DIST ALL  6.74    6.74    9.99    9.99    9.99    3.25    32.53   08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    210692  GNARLY HEAD PINOT NOIR  ALCB    11  111 115 1   082242293433    082242293433        ASSOC DIST ALL  8.24    8.24    --- --- --- --- --- 08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n4710273 ASSOCIATED DISTRIBUTORS INC.    210692  GNARLY HEAD PINOT NOIR  ALCB    11  111 115 1   082242293433    082242293433        ASSOC DIST ALL  8.24    8.24    11.49   11.49   11.49   3.25    28.29   08/23/2012  08/23/2012  12/31/2525  N   12/31/2525\n</code></pre>\n\n<p>My current query:</p>\n\n<pre><code>SELECT DISTINCT ISNULL(CAST(r.vendor_Num AS VARCHAR (9)), '---') AS Vendor_Num\n, ISNULL(a.pn_name, '---') AS Vendor_Name\n, ISNULL(r.vendor_item, '---') AS Vendor_item\n, ISNULL(CAST(u.reporting_desc AS VARCHAR(50)), '---')  AS Reporting_Desc\n, ISNULL(c.department, '---')  AS Department\n, ISNULL(CAST(c.category AS VARCHAR(6)), '---')  AS Category\n, ISNULL(CAST(h.sales_group AS VARCHAR(6)), '---')  AS Sales_Group\n, ISNULL(CAST(u.sales_subgroup AS VARCHAR(10)), '---') AS Sales_SubGroup\n, ISNULL(CAST(u2.multiplier AS VARCHAR(10)), '---') AS Pack_Multiplier\n, ISNULL(CAST(u2.upc AS VARCHAR(12)), '---') AS Receiving_UPC\n, ISNULL(CAST(u.upc AS VARCHAR(12)), '---') AS Single_UPC\n, ISNULL(CAST(u.plu AS VARCHAR(12)), '---') AS Single_PLU\n, ISNULL(CAST(rz.receiving_zone_desc AS VARCHAR (50)), '---') AS Receiving_Zone_Desc\n, ISNULL(CAST(r.cost AS VARCHAR(10)), '---') AS Cost\n, ISNULL(CAST(r.unit_cost AS VARCHAR(10)), '---') AS Unit_Cost\n, ISNULL(CAST(r.single_retail AS VARCHAR(10)), '---')  AS Single_Retail\n, ISNULL(CAST(r.case_retail AS VARCHAR(10)),  '---') AS Case_Retail\n, ISNULL(CAST(r.entering_retail AS VARCHAR(10)),  '---') AS Entering_Retail\n, ISNULL(CAST(r.single_retail - r.unit_cost AS VARCHAR(10)), '---') AS Gross_Dollars\n, ISNULL(CAST(CAST(((r.single_retail - r.unit_cost)/r.single_retail) * 100 AS DECIMAL(8,2)) AS VARCHAR(10)), '---') AS Gross_Percent\n, ISNULL(CONVERT(VARCHAR, r.effective_date, 101), '---') AS Begin_Retail_Date\n, ISNULL(CONVERT(VARCHAR, r.effective_date, 101), '---') AS Promo_Effective_Date\n, ISNULL(CONVERT(VARCHAR, r.expire_date, 101), '---') AS Promo_Expire_Date\n, ISNULL(r.is_promo, '---') AS Is_Promo\n, ISNULL(CONVERT(VARCHAR, r.deactivation_date, 101), '---') AS Deactivation_Date \nFROM report_pb_dump_det r \nLEFT OUTER JOIN p_altname_in a \nON r.vendor_num = a.pn_alt \nLEFT OUTER JOIN rs_pb_item_upc u \nON r.single_pack_id = u.pack_id \nAND u.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_sales_subgroup s \nON u.sales_subgroup = s.sales_subgroup \nAND s.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_category c \nON s.category = c.category \nAND c.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_item_hdr h \nON u.item = h.item AND h.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_item_upc u2 \nON r.case_pack_id = u2.pack_id \nAND u2.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_receiving_zone rz \nON r.receiving_zone = rz.receiving_zone \nAND rz.rec_exp_date IS NULL \nWHERE r.single_pack_id IS NOT NULL \nAND r.deactivation_date &gt; '01/01/2020' \nAND a.pn_vendor IN (4710273)  \nUNION \nSELECT DISTINCT ISNULL(CAST(r.vendor_Num AS VARCHAR (9)), '---') AS Vendor_Num\n, ISNULL(a.pn_name, '---') AS Vendor_Name\n, ISNULL(r.vendor_item, '---') AS Vendor_item\n, ISNULL(CAST(u.reporting_desc AS VARCHAR(50)), '---')  AS Reporting_Desc\n, ISNULL(c.department, '---')  AS Department\n, ISNULL(CAST(c.category AS VARCHAR(6)), '---')  AS Category\n, ISNULL(CAST(h.sales_group AS VARCHAR(6)), '---')  AS Sales_Group\n, ISNULL(CAST(u2.sales_subgroup AS VARCHAR(10)), '---') AS Sales_SubGroup\n, ISNULL(CAST(u2.multiplier AS VARCHAR(10)), '---') AS Pack_Multiplier\n, ISNULL(CAST(u2.upc AS VARCHAR(12)), '---') AS Receiving_UPC\n, ISNULL(CAST(u2.upc AS VARCHAR(12)), '---') AS Single_UPC\n, ISNULL(CAST(u2.plu AS VARCHAR(12)), '---') AS Single_PLU\n, ISNULL(CAST(rz.receiving_zone_desc AS VARCHAR (50)), '---') AS Receiving_Zone_Desc\n, ISNULL(CAST(r.cost AS VARCHAR(10)), '---') AS Cost\n, ISNULL(CAST(r.unit_cost AS VARCHAR(10)), '---') AS Unit_Cost\n, ISNULL(CAST(r.single_retail AS VARCHAR(10)), '---')  AS Single_Retail\n, ISNULL(CAST(r.case_retail AS VARCHAR(10)),  '---') AS Case_Retail\n, ISNULL(CAST(r.entering_retail AS VARCHAR(10)),  '---') AS Entering_Retail\n, ISNULL(CAST(r.single_retail - r.unit_cost AS VARCHAR(10)), '---') AS Gross_Dollars\n, ISNULL(CAST(CAST(((r.single_retail - r.unit_cost)/r.single_retail) * 100 AS DECIMAL(8,2)) AS   VARCHAR(10)), '---') AS Gross_Percent\n, ISNULL(CONVERT(VARCHAR, r.effective_date, 101), '---') AS Begin_Retail_Date\n, ISNULL(CONVERT(VARCHAR, r.effective_date, 101), '---') AS Promo_Effective_Date\n, ISNULL(CONVERT(VARCHAR, r.expire_date, 101), '---') AS Promo_Expire_Date\n, ISNULL(r.is_promo, '---') AS Is_Promo\n, ISNULL(CONVERT(VARCHAR, r.deactivation_date, 101), '---') AS Deactivation_Date \nFROM report_pb_dump_det r \nLEFT OUTER JOIN p_altname_in a \nON r.vendor_num = a.pn_alt \nLEFT OUTER JOIN rs_pb_item_upc u \nON r.single_pack_id = u.pack_id \nAND u.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_item_upc u2 \nON r.case_pack_id = u2.pack_id \nAND u2.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_sales_subgroup s \nON u2.sales_subgroup = s.sales_subgroup \nAND s.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_category c \nON s.category = c.category \nAND c.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_item_hdr h \nON u2.item = h.item AND h.rec_exp_date IS NULL \nLEFT OUTER JOIN rs_pb_receiving_zone rz \nON r.receiving_zone = rz.receiving_zone \nAND rz.rec_exp_date IS NULL \nWHERE r.single_pack_id IS NULL \nAND r.deactivation_date &gt; '01/01/2020' \nAND a.pn_vendor IN (4710273) \nORDER BY ISNULL(a.pn_name, '---')\n, ISNULL(CAST(u.upc AS VARCHAR(12)), '---')\n, ISNULL(r.is_promo, '---') ASC\n</code></pre>\n"},{"tags":["sql-server","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":62,"score":1,"question_id":12706287,"title":"SQL Server varchar equality test gives syntax error","body":"<p>I have a simple table running in SQL Server 2005 defined as</p>\n\n<pre><code>CREATE TABLE [dbo].[ap_purchases_tax_det](\n[invoice_s] [int] NOT NULL,\n[line_num] [smallint] NOT NULL,\n[tax_code] [varchar](10) NOT NULL,\n[tax_type] [varchar](2) NULL,\n[tax_det_s] [int] IDENTITY(1,1) NOT NULL,\n[old_entity] [varchar](14) NULL,\n[old_cc_code] [varchar](5) NULL,\n[old_vendor] [varchar](15) NULL,\n[old_invoice] [varchar](20) NULL,\n[citi] [varchar](1) NULL,\nCONSTRAINT [aaaaaap_purchases_tax_det_PK] PRIMARY KEY NONCLUSTERED \n(\n    [invoice_s] ASC,\n    [line_num] ASC,\n    [tax_code] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n\n<p>The tax_type field is filled with either 'W', 'V', 'B\", or '' (this one is not NULL).</p>\n\n<p>I need to get a boolean flag if tax_type is 'W', so I have the SQL:</p>\n\n<pre><code>select iif(tax_type = 'W',1,0) FROM dbo.ap_purchases_tax_det;\n</code></pre>\n\n<p>when I run this I get \"Incorrect syntax near '='.\".  This occurs even for a simple <code>tax_type = 'W'</code>.  The test for equality seems to work in the WHERE clause, but I need a flag, which means I would have to UNION together 2 selects.  This is actually part of a join that is a subquery in much larger statement so I don't want to do this.  I have tried excplicitly casting <code>tax_type = cast('W' as varchar(2))</code> to no avail. Same results if I use <code>ISNULL(tax_type,'x')</code>.</p>\n\n<p>I have no idea why the test for equality is not working, can someone provide guidance?</p>\n"},{"tags":["xml","tsql","delete","tags","self-closing"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12705382,"title":"TSQL for xml prevent empty- and self-closing tags","body":"<p>A while ago I asked this question:\n<a href=\"http://stackoverflow.com/questions/12086720/tsql-for-xml-xml-tag-just-once\">TSQL for xml xml-tag just once</a></p>\n\n<p>Now I've the issue that empty- and self-closing tags shouldn't appear in the xml.</p>\n\n<p>I found something but it doesn't work like I expect: <a href=\"http://www.sqlmusings.com/2009/04/12/sqlxml-how-to-work-with-xml-elements-or-nodes-in-sql-server/\" rel=\"nofollow\">http://www.sqlmusings.com/2009/04/12/sqlxml-how-to-work-with-xml-elements-or-nodes-in-sql-server/</a></p>\n\n<p>or</p>\n\n<p><a href=\"http://blogs.msdn.com/b/denisruc/archive/2006/05/17/600250.aspx\" rel=\"nofollow\">http://blogs.msdn.com/b/denisruc/archive/2006/05/17/600250.aspx</a></p>\n\n<p>I wrote \"$$\" in each potential empty tag and at the end I tried to remove all the tags with \"$$\" with:</p>\n\n<pre><code>SET @persons.modify('delete (//$$)')\n</code></pre>\n\n<p>But it does not work this way.</p>\n\n<p><strong>How can I remove empty- and self-closing tags with XQuery or prevent them to appear within TSQL for xml?</strong></p>\n"},{"tags":["sql-server","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":70,"score":3,"question_id":11758327,"title":"Contain a function within a query?","body":"<p>I have a query on a test DB that relies on a function installed on that DB. I need to run that query against another server that doesn't have that function and on which I can not install that function.</p>\n\n<p>Are there any elegant and/or practical solutions to this? The function is quite complicated with a number of params and so I had hoped there was a syntax that would allow me to label off a section of my query as a function and then call that code from the main body of the query.</p>\n\n<p>I have tried to Google but unfortunetly, as you might imagine, the words involved just lead to articles on how to create functions.</p>\n\n<p>Thanks for reading</p>\n\n<p>Edit: I am limited to SQL Server 2000 functionality for this.</p>\n"},{"tags":["sql","sql-server","tsql","while-loop"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":94,"score":0,"question_id":12076328,"title":"Looping in SQL stops abruptly (getting out of memeory)","body":"<p>Since many have asked me what I am trying to achieve - here is an explanation.</p>\n\n<p>I have to provide a file-feed to a Benfits carrier. The format of the file is\nMember1 Record, \nBenefits1 record, \nBenefits2 record etc..\n Member2 Record, \nBenefits1,\nBenefits2 and so on.</p>\n\n<p>The way I did this was to get all the member reords and put it in <code>@member table</code>. Then I got all the Benefits for all the members and put in the <code>@Medical_nonHMO table</code>.</p>\n\n<p>Then I loop through, get the first <code>@member</code> record (only one record) and the corresponding <code>@Medical_nonHMO</code> records (<strong>which could be more than 1</strong>). Then I get the second member record from <code>@member</code> and the corresponding Benefits Records from <code>@Medical_nonHMO</code> and so on.</p>\n\n<p>AND Yes, I have checked the value of <code>@count</code>. </p>\n\n<pre><code>    Select Max(idx) and select count(*) are returning the same value\n</code></pre>\n\n<p>I am not sure how to use cursors to achieve this.</p>\n\n<p>I have around 300 member records and around 400+ benefits records.\nIt works fine for around 200 records and then abruptly ends and sometimes gives -'Out of Memory' Error.</p>\n\n<p>I have the following loop.</p>\n\n<p><code>@member,@medical_nonHMO</code> are temp. tables that are populated with values.</p>\n\n<p><code>@tempcounttable</code> has 304 rows i.e. the value of <code>@count</code></p>\n\n<p>I am looping through for each member and member benefits</p>\n\n<p>The problem that I am facing, is that even after the query is executed, it has looped through just 174 times. </p>\n\n<p>The 'Out of Loop' doesn't get printed.</p>\n\n<p>BUT this happens only occasionally. Sometimes the loop completely executes and prints 'Out of Loop'</p>\n\n<pre><code>DECLARE @tempCounttable TABLE\n(\nidx smallint Primary Key IDENTITY(1,1),\nSSN varchar(9),\nSSN_dep varchar(9),\nfname varchar(25)\n)\n\n\nINSERT into @tempCounttable \nselect SubscriberSSN,   -- Employee SSN\n   MemberSSN,   -- Dependent SSN\n   FirstName\n from @member\n\nselect @count =  MAX(idx) from @tempCounttable\nSet @i = 1\nWhile(@i &lt;= @count) \nBegin\n\n  select * from @member\n where SubscriberSSN = (select SSN from @tempCounttable where idx = @i)\nand MemberSSN = (select SSN_dep  from @tempCounttable  where idx = @i)\n    and FirstName = (select fname from @tempCounttable  where idx = @i)\n</code></pre>\n\n<hr>\n\n<pre><code>   select * from @Medical_nonHMO\n   where SSN = (select SSN from @tempCounttable where idx = @i)\n    and SSN_dependent = (select SSN_dep from @tempCounttable where idx = @i)\n     and fname = (select fname from @tempCounttable where idx = @i)\n</code></pre>\n\n<hr>\n\n<pre><code>Set @i = @i + 1\nselect @i           \nend\n\n select 'OUT OF LOOP'\n</code></pre>\n"},{"tags":["query","tsql","sorting"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":12702627,"title":"Sorting in T-SQL by alphanumeric","body":"<p>I have a SQL 2008 database with a table having a field 'Category' of type nvarchar, which has values such as :</p>\n\n<pre><code>A1\nA10\nA2\nB1/1\nB1/2\nB1/3\nD1(1)\nD1(2)\n</code></pre>\n\n<p>etc.</p>\n\n<p>I know this is not good structure for the data, but we now need to somehow narrow down searches to this table such that the user will enter a start and end category (i.e. A1 to A15, or B1/1 to B/3) and we want to only return records with these category values.</p>\n\n<p>Is there a way this can be done? The other thing is that we would also like to have the results sorted correctly (ie. A10 after A2).</p>\n\n<p>c.</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12698376,"title":"How to set a bit based on a value existing in a table","body":"<p>I have a table. I have 2 variables, one is a <code>bit</code>, the other is an <code>int</code>.</p>\n\n<p>Table: <code>WorkGroupCollectionDetail</code></p>\n\n<p>Variables: <code>@WorkgroupID int, @IsFSBP bit</code></p>\n\n<p>The table has <code>WorkGroupId int PK</code> and <code>WorkGroupCollectionCode varchar PK</code>. That's it.</p>\n\n<p>I can run a query like this: </p>\n\n<pre><code>SELECT WorkGroupId \nFROM WorkGroupCollectionDetail \nWHERE WorkGroupCollectionCode = 'FSBP'\n</code></pre>\n\n<p>and it gives me a list of <code>WorkGroupID</code>.</p>\n\n<p>So what I need to do is if the value of <code>@WorkgroupID</code> is inside the results of that query, I need to set the bit variable to true.</p>\n"},{"tags":["asp.net","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":12700848,"title":"Multiple queries or a single query returning multiple tables when binding data to ASP.NET controls?","body":"<p>ASP.NET controls don't let you specify a table index to use when binding a data source, so your query can really only return a single table if you're using a SqlDataSource control to handle your data.  The alternative would be to run the query from the codebehind and databind manually.  Either method is fine with me really, but I'm curious what (and why) the \"best practice\" is in this situation.</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql","join"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12700079,"title":"TSQL: Convert old where clause to Join syntax","body":"<p>I have this query that I want to put into the 'modern Join syntax'</p>\n\n<pre><code>SELECT  \n    t.acct_order, \n    c1.acct_desc, \n    c1.position, \n    c1.end_pos,\n    Budget = sum(((g.data_set-1)/2)*(g.debits - g.credits)),\n    Actual = sum(((g.data_set-3)/-2)*(g.debits - g.credits)) \n\nFROM    \n    glm_chart c1, \n    glm_chart c2, \n    glh_deptsum g, \n    #TEMPTABLE t\n\nWHERE   \n        g.acct_uno=c2.acct_uno  \n    and c1.acct_code = t.acct_code  \n    and c2.position between c1.position and c1.end_pos  \n    and g.debits-g.credits&lt;&gt;0 \n    and c1.book=1  \n    and g.data_set in (1, 3)  \n    and (g.period between 201201 and 201212) \n\nGROUP   by  t.acct_order, \n            c1.acct_desc, \n            c1.position,\n            c1.end_pos \n\nORDER   by  t.acct_order \n</code></pre>\n\n<p>This is what I got to, but as you can see I can't seem to identify the join to table  glh_deptsum (g) to C1 or to T</p>\n\n<pre><code>SELECT  \n    t.acct_order, \n    c1.acct_desc, \n    c1.position, \n    c1.end_pos,\n    sum(((g.data_set-1)/2)*(g.debits - g.credits))  AS Budget,\n    sum(((g.data_set-3)/-2)*(g.debits - g.credits)) AS Actual, \n\n\nFROM         #TEMPTABLE T\nINNER JOIN  glm_chart c1 ON c1.acct_code = t.acct_code\nINNER JOIN  glh_deptsum g &lt;---- HELP WHAT GOES HERE ---------\nINNER JOIN  glm_chart c2 ON c2.position between c1.position and c1.end_pos AND g.acct_uno=c2.acct_uno\n\n\nWHERE   \n    g.debits - g.credits &lt;&gt; 0 \n    AND c1.book=1  \n    AND g.data_set in (1, 3) \n    AND (g.period between 201201 and 201212) \n\nGROUP BY t.acct_order, \n            c1.acct_desc, c1.position,c1.end_pos \n\nORDER BY t.acct_order \n</code></pre>\n\n<p>Can anyone let me know what I'm doing wrong please?</p>\n"},{"tags":["sql","sql-server","tsql","random"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":430,"score":1,"question_id":1521835,"title":"How to generate a RNGCryptoServiceProvider-like number in TSQL","body":"<p>Does anyone know of a way to generate a RNGCryptoServiceProvider-like random number in T-SQL without having to register any .NET Assemblies?</p>\n"},{"tags":["sql","tsql","syntax"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12697859,"title":"Are BEGIN / END keywords required in a stored procedure?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1180279/when-do-i-need-to-use-begin-end-blocks-and-the-go-keyword-in-sql-server\">When do I need to use Begin / End Blocks and the Go keyword in SQL Server?</a>  </p>\n</blockquote>\n\n\n\n<p>Example:</p>\n\n<pre><code>CREATE PROCEDURE DoSomething\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    -- Insert lots of statements in here, including other stored procedures.\nEND\n</code></pre>\n\n<p>Do you need the BEGIN and END? Does it make ANY difference if you have them or not?</p>\n"},{"tags":["tsql","sql-server-2005","cross-apply"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12681579,"title":"Cross Apply of UDF missing Results","body":"<p>I am performing a SQL query similar to the following</p>\n\n<pre><code>SELECT fn.FullName, pn.LastName, pn.FirstName, pn.MI\nFROM Source.dbo.tblPerson fn\n    cross apply dbo.ParseFullName(fn.FullName) pn\n</code></pre>\n\n<p>the result looks fine for the first 85 rows the 86th+ always have NULL for columns derived from the UDF. If I add a where or order by clause to change the result set, it is always the first 85 rows that return the complete set of results. because the 85 number is so consistent, I am thinking that it is something that I am overlooking.</p>\n\n<p>Any help that anyone can provide would be great</p>\n"},{"tags":["tsql","syntax","case"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":12697127,"title":"T-SQL SYNTAX ISSUE - using OR in CASE statement","body":"<p>i would like to build a CASE statement that incorporates the following logic, but the sql compiler does not like the 'OR' in my statement:</p>\n\n<pre><code>CASE expression\nWHEN expression1 OR expression2\nTHEN &lt;yadda yadda&gt;\nELSE &lt;yadda yadda&gt;\nEND\n</code></pre>\n\n<p><strong>more specific code below:</strong></p>\n\n<pre><code>CASE @var1\nWHEN '99' OR '22'   \n            THEN        \n                (CASE @var2\n                WHEN 'All' THEN col1\n                ELSE @var2\n                END)\nEND\n</code></pre>\n"},{"tags":["tsql","axapta","sql-server-2012","dynamics-ax-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":80,"score":1,"question_id":12628395,"title":"Adding +x years to every field of data type 'datetime'","body":"<p>I would like to take sample data for AX 2012 and add 3 years to every field of data type: datetime.  </p>\n\n<p>I know there is the dateadd function and I can update for every field individually, just not sure how to search through the db and find every field of type datetime and perform the update.  </p>\n\n<p>Maybe building a temporary table of all fields of that type?</p>\n\n<p>I am very new to sql so please be gentle...</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":1805,"score":3,"question_id":1038245,"title":"SQL Pivot based on value between two columns","body":"<p>I have a table in which I have, among other things, two columns, one for start date and another for end date.  I need to write a query that will return a column for each month of the year and the value of that column is 1 if the month is between 0 otherwise.  The PIVOT statement seems to be what I am looking for here, but from the best I can tell the PIVOT clause is looking to match values, not check if value is between two others.  Is the PIVOT clause the right construct here, or do I need to break down and write 12 case statements and then aggregate those?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","pivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":71,"score":0,"question_id":12686149,"title":"T-SQL pivot with more the one non-pivot columns","body":"<p>I have several columns and making pivot. I want to have multiple non-pivot columns and to make pivot using the last one. In the original specification <a href=\"http://msdn.microsoft.com/en-us/library/ms177410%28v=sql.105%29.aspx\" rel=\"nofollow\">here</a> it is shown that you can have only one non-pivot column.</p>\n\n<pre><code>SELECT &lt;non-pivoted column&gt;,\n\n    [first pivoted column] AS &lt;column name&gt;,\n\n    [second pivoted column] AS &lt;column name&gt;,\n\n    ...\n\n    [last pivoted column] AS &lt;column name&gt;\n\nFROM\n\n    (&lt;SELECT query that produces the data&gt;)\n\n    AS &lt;alias for the source query&gt;\n\nPIVOT\n\n(\n\n    &lt;aggregation function&gt;(&lt;column being aggregated&gt;)\n\nFOR\n\n[&lt;column that contains the values that will become column headers&gt;]\n\n    IN ( [first pivoted column], [second pivoted column],\n\n    ... [last pivoted column])\n\n) AS &lt;alias for the pivot table&gt;\n\n&lt;optional ORDER BY clause&gt;;\n</code></pre>\n\n<p>Is there a way to have more non-pivot columns, because it is pivoting my data using all columns after the first one.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":63,"score":1,"question_id":12579482,"title":"Find latest dowloaded item and download time","body":"<p>I have a CRM system and a web download service. At the web download the customers identify with customer name. In the crm system I have <code>crmID</code> as identifier. To map web customer name to a <code>crmID</code>, I have a mapping table. As some customers tend to write their customer names differently each time, many web names may link to the same <code>crmID</code>. The linking system is always in sync, and no problem.</p>\n\n<pre><code>crmMap( webName VACHAR(100),  \n        crmID CHAR(6) )  \nwebDownload( webName VARCHAR(100), \n             item VARCHAR(100), \n             itemVersion VARCHAR(100), \n             downloadTime DATETIME )\n</code></pre>\n\n<p>What I want is to display what each customer (<code>crmMap.crmID</code>) downloaded last time <code>(webDownload.item  and webDownload.itemVersion)</code> and when that happened <code>(webDownload.downloadTime)</code>.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","reportserver"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":12691494,"title":"Back-up Report Server Encryption Key as a Job","body":"<p>What's the T-SQL to back up your report server's encryption key?</p>\n"},{"tags":["sql","sql-server","tsql","string"],"answer_count":4,"favorite_count":0,"up_vote_count":42,"down_vote_count":0,"view_count":45968,"score":42,"question_id":1869465,"title":"IndexOf function in t-Sql","body":"<p>Given an email address column, I need to find the position of the @ sign for substringing.</p>\n\n<p>What is the indexof function, for strings in t-sql.</p>\n\n<p>Looking for something that returns the position of a substring within a string.</p>\n\n<p>in c#  </p>\n\n<pre><code>var s = \"abcde\";\ns.IndexOf('c'); // yields 2\n</code></pre>\n"},{"tags":["tsql","duplicates","primary-key","normalization"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12629985,"title":"Checking for differences in multiple records without primary keys","body":"<p>My table structure is roughly as follows (there are more columns I'm leaving out)</p>\n\n<pre><code>WEAPON    MUNITION    RANGE\n</code></pre>\n\n<p>I'm writing a query to check a single table with many WEAPON-MUNITION pairings with different ranges. I need to find every instance a WEAPON-MUNITION has a different range. Duplicates are allowed because there are multiple data sets in this table. Yes it violates normalization but I didn't make it I just have to query it.</p>\n\n<p>So say I have four weapon-munition parings with different ranges I need to be able to display them so they can be corrected. I've tried some complex CTE's and really convoluted self joins but when I think I have a result I can't tie it back to the original table because the column I thought was a primary key has duplicates between data sets! I need to display the whole record after finding the records described above. I end up with almost 10 times the rows I started with and I can't figure out why.</p>\n\n<p>Short of asking the DBA to allow me to generate unique keys for every record I don't know how I can accomplish this.</p>\n\n<p><em><strong>EDIT</em></strong>\nUsing gregmac's example I came up with this query (generic and leaving out some columns and any proprietary info)</p>\n\n<pre><code>WITH range_cte AS \n( \n    SELECT \n        d1.WEAPON\n       ,d1.MUNITION\n       ,d1.WEAPON\n       ,d1.RANGE\n       ,d1.ID    --This is NOT a primary key! There are duplicates\n    FROM data1 d1 INNER JOIN data2 d2\n        ON  d1.WEAPON = d2.WEAPON\n        AND d1.MUNITION = d2.MUNITION\n        AND d1.RANGE &lt;&gt; d2.RANGE\n    GROUP BY \n        d1.WEAPON\n       ,d1.MUNITION\n       ,d1.WEAPON\n       ,d1.RANGE\n       ,d1.ID\n    ORDER BY \n        d1.WEAPON\n       ,d1.MUNITION\n)\n--Self join the CTE on the original table using the ID (that's not a primary key)\nSELECT * FROM range_cte r INNER JOIN data d\n    ON r.ID = d.ID\n</code></pre>\n\n<p>My idea is to insert an auto generated key for the whole table or should I include more columns in the CTE (like data set) to form some sort of natural key?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","dynamic-sql"],"answer_count":1,"favorite_count":2,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12687419,"title":"create dynamic path to server.database.table in T-SQL","body":"<p>I am trying to dynamically create tables. Tables from one database (@sourcedatabase) are used to create tables in another (@targetdatabase).</p>\n\n<p>This works fine when I explicitly name the databases. However, I would like them to be dynamic, as in the following example. I have read a lot about that and I am fine using things like </p>\n\n<pre><code>set @sql = 'DROP TABLE ' + @targetdatabase + '.' + @SomeNAME \nexecute (@sql)\n</code></pre>\n\n<p>but I am at a loss when it gets a bit more complex:</p>\n\n<pre><code>declare @sourcedatabase as varchar(max) = 'DATABASE1'\ndeclare @targetdatabase as varchar(max) = 'DATABASE2'\n\ndeclare @HighestID as int = (SELECT  max(Id) FROM @sourcedatabase.system.Organisationtype)\ndeclare @i as int = (SELECT  max(Id) FROM @sourcedatabase.system.Organisationtype)\n\nwhile @i &gt;= (SELECT  min(Id) FROM @sourcedatabase.system.LaagTypeOrganisatie)\nBEGIN\n--SOME ACTIONS\nset @i = @i + 1 \nEND \n\ndeclare @x as int = (select count(*) from @targetdatabase.sys.tables where name = @SomeNAME)\n\nIF   @x &lt;&gt; 0\nBEGIN\nset @sql = 'DROP TABLE ' + @targetdatabase + '.' + @SomeNAME \nexecute (@sql)\nEND\n</code></pre>\n\n<p>As you see I would like to have the database-naming variable.\nTurning this whole script into one exec statement is quite complex and not very pretty to read.\nWould it be an idea to read this script in a textfile, do a replace on @targetdatabase en @sourcedatabase and then execute it? If so, how would this be done?</p>\n\n<p>I am looking forward to your ideas and contributions!</p>\n\n<p>edit: the script is executed as a jobagent</p>\n"},{"tags":["sql","sql-server","database","tsql","recursive-query"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":124,"score":1,"question_id":12683532,"title":"How to do a recursive query","body":"<p>I have a database table looks like this:</p>\n\n<pre><code>EVENT_ID TEXT_FRO TEXT_TO\n55001              05\n55001    05        10\n55001    10        15\n55001    15        20\n55001    20        30\n56215    06        11\n56215    11        22\n</code></pre>\n\n<p>I need to write a query (or a SP) to produce a result set to list all movements for each distinct event_ID which looks like this:</p>\n\n<pre><code>Event ID Movements\n55001    05 10 15 20 30\n56215    06 11 22\n</code></pre>\n\n<p>How can I do that?</p>\n\n<p>*Edit to simplify the example</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","dynamic-sql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":83,"score":2,"question_id":12689117,"title":"Get the count of rows in a stored procedure result regardless of number/type of columns","body":"<p>I have developed the following code:</p>\n\n<pre><code>  CREATE PROCEDURE [dbo].[Test01]\n  AS\n  BEGIN\n    SELECT * FROM TestTable\n  END\n\n\n  CREATE PROCEDURE [dbo].[Test02]\n  AS\n  BEGIN\n    DECLARE @tmp TABLE\n    (\n      TestID int,\n      Test   nvarchar(100),\n    )\n    INSERT INTO @tmp\n    EXEC Test01\n    SELECT COUNT(*) FROM @tmp\n  END\n</code></pre>\n\n<p>But if I add or remove a column on <code>TestTable</code> I must to modify <code>@tmp</code> otherwise the result is:</p>\n\n<blockquote>\n  <p><em>Column name or number of supplied values does not match table definition</em></p>\n</blockquote>\n\n<p>How can I solve this problem?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":12427712,"title":"Status of Data in Rollback of Large Transaction in SQL Server","body":"<p>I have a data warehousing procedure that downloads and replaces dozens of tables from a linked server to a local database.  Every once in a while, the code will get stuck on one of the tables on the linked server because the table on the linked server is in a state of transition.  I am under the assumption that since the entire procedure is considered one transaction commit, when the procedure gets stuck, none of the changes made by the procudure so far would have committed.  But the opposite seems to be true, tables that were \"downloaded\" before the procedure got stuck would have been updated with today's versions on the local server.  Shouldn't SQL Server wait for the entire procedure to finish before the changes are durable?  </p>\n\n<pre><code>CREATE PROCEDURE MYIMPORT\n\nAS\n\nBEGIN\n\n\nSET NOCOUNT ON\n\nIF EXISTS (SELECT * FROM INFORMATION.SCHEMA.TABLES WHERE TABLE_NAME = 'TABLE1')\nDROP TABLE TABLE1\n\nSELECT COLUMN1, COLUMN2, COLUMN3 \nINTO TABLE1\nFROM OPENQUERY(MYLINK, 'SELECT COLUMN1, COLUMN2, COLUMN3 FROM TABLE1')\n\nIF EXISTS (SELECT * FROM INFORMATION.SCHEMA.TABLES WHERE TABLE_NAME = 'TABLE2')\nDROP TABLE TABLE2\n\nSELECT COLUMN1, COLUMN2, COLUMN3 \nINTO TABLE2\nFROM OPENQUERY(MYLINK, 'SELECT COLUMN1, COLUMN2, COLUMN3 FROM TABLE2')\n--IF THE PROCEDURE GETS STUCK HERE, THEN CHANGES TO TABLE1 WOULD HAVE BEEN MADE ON THE LOCAL SERVER WHILE NO CHANGES WOULD HAVE BEEN MADE TO TABLE3 ON THE LOCAL SERVER\n\nIF EXISTS (SELECT * FROM INFORMATION.SCHEMA.TABLES WHERE TABLE_NAME = 'TABLE3')\nDROP TABLE TABLE3\n\nSELECT COLUMN1, COLUMN2, COLUMN3 \nINTO TABLE3\nFROM OPENQUERY(MYLINK, 'SELECT COLUMN1, COLUMN2, COLUMN3 FROM TABLE3')\n\n\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","reporting-services","ssms"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":11957835,"title":"Finding Out If a Table is Being Used by a Report","body":"<p>Is there anyway to find out if a particular table is being used by a report on the reporting server?</p>\n"}]}
{"total":16599,"page":11,"pagesize":100,"questions":[{"tags":["tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":81,"score":4,"question_id":12479244,"title":"nested SELECT statements interact in ways that I don't understand","body":"<p>I thought I understood how I can do a SELECT from the results of another SELECT statement, but there seems to be some sort of blurring of scope that I don't understand.  I am using  SQL Server 2008R2.</p>\n\n<p>It is easiest to explain with an example.</p>\n\n<p>Create a table with a single nvarchar column - load the table with a single text value and a couple of numbers:</p>\n\n<pre><code>CREATE TABLE #temptable( a nvarchar(30) ); \nINSERT INTO #temptable( a )\n    VALUES('apple');\nINSERT INTO #temptable( a )\n    VALUES(1);\nINSERT INTO #temptable( a )\n    VALUES(2);\n\nselect * from #temptable;\n</code></pre>\n\n<p>This will return:  apple, 1, 2 </p>\n\n<p>Use IsNumeric to get only the rows of the table that can be cast to numeric - this will leave the text value ('apple') behind.  This works fine.</p>\n\n<pre><code>    select cast(a as int) as NumA\n    from #temptable \n    where IsNumeric(a) = 1 ;\n</code></pre>\n\n<p>This returns: 1, 2</p>\n\n<p>However, if I use that exact same query as an inner select, and try to do a numeric WHERE clause, it fails saying cannot convert nvarchar value 'apple' to data type int.  How has it got the value 'apple' back??</p>\n\n<pre><code>    select \n        x.NumA\n    from \n    (\n        select cast(a as int) as NumA\n        from #temptable \n        where IsNumeric(a) = 1 \n    ) x\n    where x.NumA &gt; 1\n    ;\n</code></pre>\n\n<p>Note that the failing query works just fine without the WHERE clause:</p>\n\n<pre><code>    select \n        x.NumA\n    from \n    (\n        select cast(a as int) as NumA\n        from #temptable \n        where IsNumeric(a) = 1 \n    ) x\n    ;\n</code></pre>\n\n<p>I find this very surprising.  What am I not getting? TIA</p>\n"},{"tags":["tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":12378605,"title":"Best Way to Sequentially Parse Through a Table in T-SQL","body":"<p>I'm writing a stored procedure in SQL Server and hoping someone can suggest a more computationally efficient way to handle this problem:</p>\n\n<p>I have a table of <strong>Customer Orders</strong> (i.e., \"product demand\") data that contains 3000 line items.  Each record expresses the Order Qty for a specific product.</p>\n\n<p>I also have another table of <strong>Production Orders</strong> (i.e., \"product supply\") data that contains about 200 line items.  Each record expresses the Qty Available for each specific product.</p>\n\n<p>The problem is that there is typically less supply than demand and, therefore, the Custom Order table contains an Allocation Priority value that shows each Customer Order's position in line to receive product.</p>\n\n<p>What's the best way to allocate Qty Available in Production Orders to the Order Qty in Customer Orders?  Note that you can't allocate more to each Customer Order than has been ordered.</p>\n\n<p>I can do this by creating a WHILE loop and doing the allocation product-by-product, line-by-line but it is very slow.</p>\n\n<p>Is there a faster set-based way to approach this problem?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12689100,"title":"How to improve SQL Query Performance","body":"<p>I have the following DB Structure (simplified):</p>\n\n<pre><code>Payments\n----------------------\nId        | int\nInvoiceId | int\nActive    | bit\nProcessed | bit\n\n\nInvoices\n----------------------\nId              | int\nCustomerOrderId | int\n\n\nCustomerOrders\n------------------------------------\nId                       | int\nApprovalDate             | DateTime\nExternalStoreOrderNumber | nvarchar\n</code></pre>\n\n<p>Each Customer Order has an Invoice and each Invoice can have multiple Payments.\nThe <code>ExternalStoreOrderNumber</code> is a reference to the order from the external partner store we imported the order from and the <code>ApprovalDate</code> the timestamp when that import happened.</p>\n\n<p>Now we have the problem that we had a wrong import an need to change some payments to other invoices (several hundert, so too mach to do by hand) according to the following logic:<br>\nSearch the Invoice of the Order which has the same external number as the current one but starts with 0 instead of the current digit.</p>\n\n<p>To do that I created the following query:  </p>\n\n<pre><code>UPDATE DB.dbo.Payments \n    SET InvoiceId=\n        (SELECT TOP 1 I.Id FROM DB.dbo.Invoices AS I\n            WHERE I.CustomerOrderId=\n                (SELECT TOP 1 O.Id FROM DB.dbo.CustomerOrders AS O \n                    WHERE O.ExternalOrderNumber='0'+SUBSTRING(\n                      (SELECT TOP 1 OO.ExternalOrderNumber FROM DB.dbo.CustomerOrders AS OO\n                        WHERE OO.Id=I.CustomerOrderId), 1, 10000)))\n    WHERE Id IN (\n        SELECT P.Id\n          FROM DB.dbo.Payments AS P\n            JOIN DB.dbo.Invoices AS I ON I.Id=P.InvoiceId\n            JOIN DB.dbo.CustomerOrders AS O ON O.Id=I.CustomerOrderId\n         WHERE P.Active=0 AND P.Processed=0 AND O.ApprovalDate='2012-07-19 00:00:00'\n</code></pre>\n\n<p><strong>Now I started that query on a test system using the live data (~250.000 rows in each table) and it is now running since 16h - did I do something completely wrong in the query or is there a way to speed it up a little?</strong><br>\nIt is not required to be really fast, as it is a one time task, but several hours seems long to me and as I want to learn for the (hopefully not happening) next time I would like some feedback how to improve...</p>\n"},{"tags":["sql","tsql"],"answer_count":6,"favorite_count":5,"up_vote_count":16,"down_vote_count":0,"view_count":20247,"score":16,"question_id":92093,"title":"Removing leading zeroes from a field in a SQL statement","body":"<p>I am working on a SQL query that reads from a SQLServer database to produce an extract file. One of the  requirements to remove the leading zeroes from a particular field, which is a simple VARCHAR(10) field. So, for example, if the field contains '00001A', the SELECT statement needs to return the data as '1A'.</p>\n\n<p>Is there a way in SQL to easily remove the leading zeroes in this way? I know there is an RTRIM function, but this seems only to remove spaces. </p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":1,"view_count":23,"score":2,"question_id":12689456,"title":"T SQL: How get all minutes from Time type","body":"<p>I have the following code and I want get all minutes from time type.</p>\n\n<pre><code>declare @time time\nset @time = '01:30'\n\ndeclare @minutes int\n\n--select @minutes = convert time to minutes here\n\nselect @minutes -- @minutes == 90\n</code></pre>\n\n<p>Please help.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":12686175,"title":"SQL Server Insert into. . . Execute Statement","body":"<p>I created a stored procedure to return a record containing about 60 columns. However, I would like to in another part of my project select from the same stored proc about 40 out of the 60 columns it returns.  How do I properly specify which columns I need returned? In essence what are the rules, if any for </p>\n\n<p><strong>Insert into #TempTable \n( . . . .  . . .)\nExec StoredProcedure</strong> </p>\n\n<p>?</p>\n"},{"tags":[".net","xml","tsql","sql-server-2005","xml-parsing"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":42,"score":1,"question_id":12688828,"title":"Normalising XML in SQLServer for hashing","body":"<p>I asked <a href=\"http://stackoverflow.com/q/12674327/395628\">this question</a> which led me to do the following.</p>\n\n<ul>\n<li>Create an XML representation of a C# object structure in order to pass it to SQLServer.</li>\n<li>Create a stored procedure which <em>hashes the XML</em> and then shreds the XML into related tables and also stores the hash in the root table for quick lookup.</li>\n</ul>\n\n<p>This means that I can pass complex object data to SQLServer and do a lookup on the hash rather than trying to shred and match the XML against the tables (which I can also do but is slow(er))...</p>\n\n<p>However - One of the nice things about XML is that you can format it eg indent it etc - and also - that attribute order is not important. BUT when you hash something formatting and indentation IS important. So what I do in C# is...</p>\n\n<ul>\n<li>Normalise the XML by putting all attributes in alphabetical order</li>\n<li>use .ToString(DisableFormatting) to remove extra formatting spaces</li>\n</ul>\n\n<p>This works fine, but when I'm testing it's easier to have <em>formatted</em> XML so I can see more easily what I'm passing to the stored proc.</p>\n\n<p>It would be nice if SQLServer could be trusted to preserve attribute order <a href=\"http://msdn.microsoft.com/en-us/library/ms187107%28v=sql.90%29.aspx\" rel=\"nofollow\">but it can't</a>...</p>\n\n<blockquote>\n  <p>The order of attributes in an XML instance is not preserved. When you\n  query the XML instance stored in the xml type column, the order of\n  attributes in the resulting XML may be different from the original XML\n  instance.</p>\n</blockquote>\n\n<p>This means that I can't use SQLServer's XML datatype to normalise the data.</p>\n\n<p>What bothers me is that at some point someone will be using my procs and think \"oh great, XML, attribute order doesn't matter, formatting doesn't matter, <em>the data represented is the same</em>\" However, when I hash this isn't going to be the case.</p>\n\n<p>Anyone got any solutions to this problem? I don't really want to write an XML parser in T-SQL!! Or use an XML parser someone else has written in order to normalise it. Why can't the SQLServer XML datatype just preserve attribute order? </p>\n\n<p>I suppose I can \"trust\" my app to always pass XML in the same format/order thus resulting in the same hash for the same object. But I'm uncomfortable with the idea that the stored proc has to also \"trust\" the app to do this. I would like to somehow be able to check the normalisation of the XML, it will obviously be more robust like that.</p>\n"},{"tags":["tsql","select","limit"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12688576,"title":"TSQL show only first row","body":"<p>I have the following TSQL query: </p>\n\n<pre><code>SELECT DISTINCT MyTable1.Date\n  FROM MyTable1 \nINNER JOIN MyTable2 \nON MyTable1.Id = MyTable2.Id\nWHERE Name = 'John' ORDER BY MyTable1.Date DESC\n</code></pre>\n\n<p>It retrieves a long list of Dates, but I only need the first one, the one in the first row. </p>\n\n<p>How can I get it? </p>\n\n<p>Thanks a ton!  </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":32,"score":1,"question_id":12686112,"title":"Merge two retrived rows by variable","body":"<p>I have the following issue. I have declared a variable based on ID value, but there are two different values that have my data. This is what I retreive:</p>\n\n<pre><code>    entry_template_id   entry_template_name book_display_name   entry_count value_count null_value_count    null_percentage followed_value_count    followed_null_value_count   followed_null_percentage    \n                   9    Loading             Reporting            10            530           78              0.147169811320      520                      78                         0.150000000000 \n                   19   Loading             Reporting            1              53            8              0.150943396226       53                       8                         0.150943396226\n</code></pre>\n\n<p>I want to retrive just one row with ID like (9, 19), same template_name, same display_name, SUM (entry_count), SUM(value_count), SUM(null_value_count), AVG(null_percentage), SUM(followed_value_count), SUM(followed_nulls_value_count), AVG(followed_null_percentage).</p>\n\n<p>Can you please help me with the syntax?</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":41,"score":1,"question_id":12685941,"title":"procedure does not know custom type","body":"<p>I'm having a procedure and some custom types to pass some data to it:</p>\n\n<pre><code>CREATE TYPE StringList AS TABLE\n(Value NVARCHAR(255));\n\nGO\n\nCREATE TYPE KeyValueList AS TABLE\n(\nId uniqueidentifier,\nValue NVARCHAR(255));\n\nGO\n\nCREATE PROCEDURE \n#update_AttributeFormel(\n    @modelPrefix NVARCHAR(255), \n    @definitionNeutralName NVARCHAR(255), \n    @newFormula NVARCHAR(255),\n    @providersToRemove StringList READONLY,\n    @providersToAdd KeyValueList READONLY)\n    AS  ....\n</code></pre>\n\n<p>The ManagementStudio does not show any error (as it would when i comment out the type declaration) but when i execute the script, i'm getting the following errors:</p>\n\n<pre><code>Msg 2715, Level 16, State 3, Procedure #update_AttributeFormel, Line 2\nColumn, parameter, or variable #4: Cannot find data type StringList.\nParameter or variable '@providersToRemove' has an invalid data type.\nMsg 2715, Level 16, State 3, Procedure #update_AttributeFormel, Line 2\nColumn, parameter, or variable #5: Cannot find data type KeyValueList.\nParameter or variable '@providersToAdd' has an invalid data type.\n</code></pre>\n\n<p>Implementation as explained here:</p>\n\n<ol>\n<li><p><a href=\"http://www.simple-talk.com/sql/t-sql-programming/temporary-tables-in-sql-server/\" rel=\"nofollow\">http://www.simple-talk.com/sql/t-sql-programming/temporary-tables-in-sql-server/</a></p></li>\n<li><p><a href=\"http://www.sqlteam.com/article/sql-server-2008-table-valued-parameters\" rel=\"nofollow\">http://www.sqlteam.com/article/sql-server-2008-table-valued-parameters</a></p></li>\n</ol>\n\n<p>Does anyone have an idea why this happens?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","hex","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":79,"score":1,"question_id":12678380,"title":"Storing hex equivalent in identity column in sql","body":"<p>Just as the title says, if I have a table has a struct like this</p>\n\n<pre><code>create table myTable\n(\nID int identity(1,1) not null,\ncol1 varchar(20) not null,\ncol2 varchar(20) not null\nconstraint pk_myTable primary key (ID)\n)\n</code></pre>\n\n<p>If I insert some value in this table it would automatically take value in col <code>ID</code>. I wanna know is a way I could get SQL Server to store hex equivalent in the column. Say, for 1, it should store <code>0x01</code> <code>2 as 0x02</code>... <code>10 as 0xA</code> and so on?</p>\n\n<p>I don't wanna know any tricks or something, I know I can create this this col as <code>varchar</code> and then create a procedure for insert, or create a trigger for insert, that would do the required transformation and would produce the desired result, that's <em>not</em> a big issue.</p>\n\n<p>But what I wanna know is there a inbuilt function/procedure/trigger that would help me achieve what I am trying to achieve? Not necessarily in SQL Server 2008, but may be in 2012, does there exists anything like this?</p>\n"},{"tags":["sql","sql-server","multithreading","tsql","locking"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":243,"score":1,"question_id":8134318,"title":"SQLserver multithreaded locking with TABLOCKX","body":"<p>I have a table \"tbluser\" with 2 fields:</p>\n\n<ul>\n<li>userid = integer (autoincrement)</li>\n<li>user = nvarchar(100)</li>\n</ul>\n\n<p>I have a multithreaded/multi server application that uses this table.</p>\n\n<p>I want to accomplish the following:</p>\n\n<ul>\n<li>Guarantee that field user is unique in my table</li>\n<li>Guarantee that combination userid/user is unique in each server's memory</li>\n</ul>\n\n<p>I have the following stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE uniqueuser @user nvarchar(100) AS\nBEGIN\nBEGIN TRAN\n    DECLARE @userID int\n    SET  nocount ON\n    SET  @userID = (SELECT @userID FROM tbluser WITH (TABLOCKX) WHERE  [user] = @user)\n    IF @userID &lt;&gt; ''\n    BEGIN\n        SELECT  userID = @userID\n    END\n    ELSE\n    BEGIN\n        INSERT INTO  tbluser([user]) VALUES (@user)\n        SELECT userID = SCOPE_IDENTITY() \n    END \nCOMMIT TRAN\nEND\n</code></pre>\n\n<p>Basically the application calls the stored procedure and provides a username as parameter.\nThe stored procedure either gets the userid or insert the user if it is a new user.</p>\n\n<p>Am I correct to assume that the table is locked (only one server can insert/query)?</p>\n"},{"tags":["mysql","sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":42,"score":-3,"question_id":12681354,"title":"Sql Query to display follow format","body":"<p>I have a table Std Record and i need to show the record by query in the following format</p>\n\n<pre><code>Class   StdName  RegDate   Age\nStatus  Std#     Sub#      Marks\n\n1       XYZ      1/12/2009  2\n        123      M1        23\n\nTeacher:            \nNotes:          \n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures","ssis"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":96,"score":0,"question_id":12658590,"title":"SSIS - output stored procedure result to e-mail","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/5556276/send-mail-task-based-on-output-from-execute-sql-task\">Send Mail Task based on output from Execute SQL Task</a>  </p>\n</blockquote>\n\n\n\n<p>Goal: E-mail output of a stored procedure to someone using SSIS.</p>\n\n<p>I have a simple stored procedure that returns the count of a column. I would like to e-mail that value in e-mail. </p>\n\n<p>What I think I should do: I should create a package in SSRS. Bring in Execute SQL TASK and E-Mail task. For the execute SQL task, connect to server/database. Type in EXEC proc cmd. Connect that to e-mail. </p>\n\n<p>In the stored procedure I have declared a variable called <code>@COUNT</code> and inside the select statement, I have </p>\n\n<pre><code>SELECT @Count = COUNT(FIELD_A)....\nFROM blah blah....\nWHere blah blah.....\n\nSELECT @Count \n</code></pre>\n\n<p>When I execute that procedure, I get a count assigned to <code>@Count</code> variable. I would like to make a variable in SSIS and assign it the output value of the procedure. Use that variable and somehow e-mail value of that variable with a custom message. I will be making this a automated job so this package will run everyday at some time and an e-mail with count value should be sent.</p>\n\n<p>I am not sure how to go about doing this.</p>\n"},{"tags":["c#","sql","tsql","migration","bulkinsert"],"answer_count":7,"favorite_count":4,"up_vote_count":10,"down_vote_count":0,"view_count":29508,"score":10,"question_id":742540,"title":"TSQL: UPDATE with INSERT INTO SELECT FROM","body":"<p>so I have an old database that I'm migrating to a new one.  The new one has a slightly different but mostly-compatible schema. Additionally, I want to renumber all tables from zero.  </p>\n\n<p>Currently I have been using a tool I wrote that manually retrieves the old record, inserts it into the new database, and updates a v2 ID field in the old database to show its corresponding ID location in the new database. </p>\n\n<p>for example, I'm selecting from MV5.Posts and inserting into MV6.Posts. Upon the insert, I retrieve the ID of the new row in MV6.Posts and update it in the old MV5.Posts.MV6ID field.  </p>\n\n<p>Is there a way to do this UPDATE via INSERT INTO SELECT FROM so I don't have to process every record manually?</p>\n"},{"tags":["sql-server","tsql","sql-server-2008","date"],"answer_count":7,"favorite_count":3,"up_vote_count":11,"down_vote_count":0,"view_count":6674,"score":11,"question_id":7168874,"title":"Get first day of week in SQL Server","body":"<p>I am trying to group records by week, storing the aggregated date as the first day of the week. However, the standard technique I use for rounding off dates does not appear to work correctly with weeks (though it does for days, months, years, quarters and any other timeframe I've applied it to).</p>\n\n<p>Here is the SQL:</p>\n\n<pre><code>select \"start_of_week\" = dateadd(week, datediff(week, 0, getdate()), 0);\n</code></pre>\n\n<p>This returns <code>2011-08-22 00:00:00.000</code>, which is a Monday, not a Sunday. Selecting <code>@@datefirst</code> returns <code>7</code>, which is the code for Sunday, so the server is setup correctly in as far as I know.</p>\n\n<p>I can bypass this easily enough by changing the above code to:</p>\n\n<pre><code>select \"start_of_week\" = dateadd(week, datediff(week, 0, getdate()), -1);\n</code></pre>\n\n<p>But the fact that I have to make such an exception makes me a little uneasy. Also, apologies if this is a duplicate question. I found some related questions but none that addressed this aspect specifically.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":51,"score":2,"question_id":12681393,"title":"Return view FROM clause using only tsql?","body":"<p>Is there a way using TSQL to return the FROM section of an existing view?  </p>\n\n<p>I know I can get the whole of the view definition with sp_helptext and can get the list of columns either with sp_help or by selecting from INFORMATION_SCHEMA.VIEW_COLUMN_USAGE, but what I'm looking for are the tables and join clauses.</p>\n\n<p>Currently, I'm dumping the return from sp_helptext into an nvarchar(max), and doing a charindex search for 'from '.  I loop through checking to make sure the number of open parentheses equals the number of close parentheses (to factor out subqueries in the select), and if it doesn't I search for the next instance of 'from '.</p>\n\n<p>But I expect this solution is far from bulletproof, and would think there's some built in procedure or systable where I can get this.</p>\n\n<p>The code I'm currently using is as follows...</p>\n\n<pre><code>    declare @from int = 1\n    declare @newJoin nvarchar(max)\n    if OBJECT_ID('tempdb..#t') is not null\n    begin\n        drop table #t\n    end\n    create table #t(\n    LineId int identity(1,1),\n    Text nvarchar(max)\n    )\n\n    insert into #t (Text) exec sys.sp_helptext &lt;view_name&gt;\n\n    set @newJoin = ''\n    select @newJoin = @newJoin + Text \n    from #t\n    where LEFT(LTRIM(replace(Text,char(9),' ')),2)&lt;&gt;'--'\n    order by LineId\n\n    while @from &gt; 0\n        begin\n              SET @from = CHARINDEX('from ', @newJoin, @from + 5)\n              IF LEN(REPLACE(LEFT(@newJoin,@from),'(','')) = LEN(REPLACE(LEFT(@newJoin,@from),')','')) BREAK\n        end\n\n    set @newJoin = substring(@newJoin, @from + 5, len(@newJoin))\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12680131,"title":"\"NVARCHAR(255) is null\" brings collation confict","body":"<p>I'm having a temp procedure:</p>\n\n<pre><code>CREATE PROCEDURE \n#update_ListItemEntityNumberValueAndLocalizations(\n    @modelPrefix NVARCHAR(255), \n    @definitionNeutralName NVARCHAR(255), \n    @listItemNeutralValue NVARCHAR(255),    \n    @newNumberValue float,\n    @listItemEnName NVARCHAR(255),\n    @listItemDeName NVARCHAR(255))\n</code></pre>\n\n<p>In this procedure there is the following if statement:</p>\n\n<pre><code>if(@listItemEnName is not null)\n</code></pre>\n\n<p>And at this line I get the following error:</p>\n\n<blockquote>\n  <p>Cannot resolve the collation conflict between\n  \"SQL_Latin1_General_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the is\n  not operation.</p>\n</blockquote>\n\n<p>Does anyone know why this happens and how I can avoid it?</p>\n\n<p>UPDATE: Database collation is <code>SQL_Latin1_General_CP1_CI_AS</code></p>\n\n<p>Why does a \"is null\" needs the collation?</p>\n\n<p>Is there a way to cast the null or set the collation of the parameter?</p>\n"},{"tags":["sql","tsql","sql-server-2008","sql-server-2008-r2"],"answer_count":5,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":786,"score":1,"question_id":6131323,"title":"How to select the top n from a union of two queries where the resulting order needs to be ranked by individual query?","body":"<p>Let's say I have a table with usernames:</p>\n\n<pre><code>Id  |  Name\n-----------\n1   |  Bobby\n20  |  Bob\n90  |  Bob\n100 |  Joe-Bob\n630 |  Bobberino\n820 |  Bob Junior\n</code></pre>\n\n<p>I want to return a list of <code>n</code> matches on name for 'Bob' where the resulting set first contains exact matches followed by similar matches.    </p>\n\n<p>I thought something like this might work</p>\n\n<pre><code>SELECT TOP 4 a.* FROM\n(\n    SELECT * from Usernames WHERE Name = 'Bob'\n    UNION\n    SELECT * from Usernames WHERE Name LIKE '%Bob%'\n) AS a\n</code></pre>\n\n<p>but there are two problems:</p>\n\n<ol>\n<li>It's an inefficient query since the sub-select could return many rows (looking at the execution plan shows a join happening before top)</li>\n<li>(Almost) more importantly, the exact match(es) will not appear first in the results since the resulting set appears to be ordered by primary key.</li>\n</ol>\n\n<p>I am looking for a query that will return (for TOP 4)</p>\n\n<pre><code>Id | Name\n---------\n20 | Bob\n90 | Bob\n\n(and then 2 results from the LIKE query, e.g. 1 Bobby and 100 Joe-Bob)\n</code></pre>\n\n<p>Is this possible in a single query?</p>\n"},{"tags":["sql","sql-server","performance","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12677941,"title":"Matching sub string in a column","body":"<p>First I apologize for the poor formatting here. </p>\n\n<p>Second I should say up front that changing the table schema is not an option.</p>\n\n<p>So I have a table defined as follows:</p>\n\n<p><strong>Pin</strong> varchar<br>\n<strong>OfferCode</strong> varchar</p>\n\n<p>Pin will contain data such as:<br>\nabc,<br>\nabc123</p>\n\n<p>OfferCode will contain data such as:<br>\n123<br>\n123~124~125</p>\n\n<p>I need a query to check for a count of a Pin/OfferCode combination and when I say OfferCode, I mean an individual item delimited by the tilde.</p>\n\n<p>For example if there is one row that looks like <code>abc, 123</code> and another that looks like <code>abc,123~124</code>, and I search for a count of <code>Pin=abc,OfferCode=123</code> I wand to get a count = 2.</p>\n\n<p>Obviously I can do a similar query to this:<br>\n<code>SELECT count(1) from MyTable (nolock) where OfferCode like '%' + @OfferCode + '%' and Pin = @Pin</code></p>\n\n<p>using <code>like</code> here is very expensive and I'm hoping there may be a more efficient way.</p>\n\n<p>I'm also looking into using a split string solution. I have a Table-valued function <code>SplitString(string,delim)</code> that will return table <code>OutParam</code>, but I'm not quite sure how to apply this to a table column vs a string. <em>Would this even be worth wile pursuing?</em> It seems like it would be much more expensive, but I'm unable to get a working solution to compare to the <code>like</code> solution.</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":2,"view_count":41,"score":-2,"question_id":12680584,"title":"BIGINT scalar function","body":"<p>How to??\nCreate a scalar function that returns a bigint.\nThe function takes 2 inputs of bigint.\nThe function multiplies the inputs and returns the result.</p>\n\n<p>Thank You,</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","greatest-n-per-group"],"answer_count":3,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":1053,"score":6,"question_id":7579916,"title":"How do I select TOP 5 PERCENT from each group?","body":"<p>I have a sample table like this:</p>\n\n<pre><code>CREATE TABLE #TEMP(Category VARCHAR(100), Name VARCHAR(100))\n\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'John')\nINSERT INTO #TEMP VALUES('A', 'Adam')\nINSERT INTO #TEMP VALUES('A', 'Adam')\nINSERT INTO #TEMP VALUES('A', 'Adam')\nINSERT INTO #TEMP VALUES('A', 'Adam')\nINSERT INTO #TEMP VALUES('A', 'Lisa')\nINSERT INTO #TEMP VALUES('A', 'Lisa')\nINSERT INTO #TEMP VALUES('A', 'Bucky')\nINSERT INTO #TEMP VALUES('B', 'Lily')\nINSERT INTO #TEMP VALUES('B', 'Lily')\nINSERT INTO #TEMP VALUES('B', 'Lily')\nINSERT INTO #TEMP VALUES('B', 'Lily')\nINSERT INTO #TEMP VALUES('B', 'Lily')\nINSERT INTO #TEMP VALUES('B', 'Tom')\nINSERT INTO #TEMP VALUES('B', 'Tom')\nINSERT INTO #TEMP VALUES('B', 'Tom')\nINSERT INTO #TEMP VALUES('B', 'Tom')\nINSERT INTO #TEMP VALUES('B', 'Ross')\nINSERT INTO #TEMP VALUES('B', 'Ross')\nINSERT INTO #TEMP VALUES('B', 'Ross')\n\nSELECT Category, Name, COUNT(Name) Total\nFROM #TEMP\nGROUP BY Category, Name\nORDER BY Category, Total DESC\n\nDROP TABLE #TEMP\n</code></pre>\n\n<p>Gives me the following:</p>\n\n<pre><code>A   John    6\nA   Adam    4\nA   Lisa    2\nA   Bucky   1\nB   Lily    5\nB   Tom     4\nB   Ross    3\n</code></pre>\n\n<p>Now, how do I select the <code>TOP 5 PERCENT</code> records from each category <em>assuming each category has more than 100 records (did not show in sample table here)</em>? For instance, in my actual table, it should remove the <code>John</code> record from <code>A</code> and <code>Lily</code> record from <code>B</code> as appropriate (again, I did not show the full table here) to get: </p>\n\n<pre><code>A   Adam    4\nA   Lisa    2\nA   Bucky   1\nB   Tom     4\nB   Ross    3\n</code></pre>\n\n<p>I have been trying to use <code>CTE</code>s and <code>PARTITION BY</code> clauses but cannot seem to achieve what I want. It removes the TOP 5 PERCENT from the overall result but not from each category. Any suggestions?</p>\n"},{"tags":["sql","database","tsql","reporting-services"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":11363742,"title":"reporting services - datedif between grouped column 'time'","body":"<p>I have a Tablix with a group. For each group, I want the date difference of the column: \n<strong>Time (timestamp)</strong> from the prior group.</p>\n\n<p>Pseudo code:</p>\n\n<pre><code>=DateDiff(PriorGroup!Fields!Time,ThisGroup!Fields!Time)\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":69,"score":-2,"question_id":12678438,"title":"How to move and compare column values in sql table?","body":"<p>This is a code to get free and total disk space of physical drives and the data is stored in a temporary database <code>#output</code>.  All I want to do is that I want to compare each value from the <code>freespace</code> column available in <code>#output</code> table with \"1024000\" and if the value is less than this then I want to put the value in another table.</p>\n\n<p>I am new to SQL so I don't know how to do this.</p>\n\n<p>P.S. the number of drives can vary so I need a generic solution.</p>\n\n<pre><code>declare @svrName varchar(255)\ndeclare @sql varchar(400)\n\nset @svrName = @@SERVERNAME\nset @sql = 'powershell.exe -c \"Get-WmiObject -ComputerName ' + QUOTENAME(@svrName,'''') + ' -Class Win32_Volume -Filter ''DriveType = 3'' | select name,capacity,freespace | foreach{$_.name+''|''+$_.capacity/1048576+''%''+$_.freespace/1048576+''*''}\"'\n--creating a temporary table\nCREATE TABLE #output\n(line varchar(255))\n--inserting disk name, total space and free space value in to temporary table\n\ninsert #output\nEXEC xp_cmdshell @sql\n\nselect rtrim(ltrim(SUBSTRING(line,1,CHARINDEX('|',line) -1))) as drivename\n      ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('|',line)+1,\n      (CHARINDEX('%',line) -1)-CHARINDEX('|',line)) )) as Float)/1024,0) as 'capacity(GB)'\n      ,round(cast(rtrim(ltrim(SUBSTRING(line,CHARINDEX('%',line)+1,\n      (CHARINDEX('*',line) -1)-CHARINDEX('%',line)) )) as Float) /1024 ,0)as 'freespace(GB)'\nfrom #output\nwhere line like '[A-Z][:]%'\norder by drivename\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12678292,"title":"Earn the average of a row in a stored procedure in SQL Server","body":"<p>I have a stored procedure in SQL Server that returns the average of some column like this:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[Financial] \nAS\nBEGIN\n    SELECT \n        avg([aa ]) as 'aaa',\n        avg([bb]) as 'bbb',\n        avg([cc ]) as 'ccc',\n        avg([dd]) as 'ddd',\n        avg([ee]) as 'eee',\n        avg([ ff]) as 'fff'\n    FROM [FIN]\nEND\n</code></pre>\n\n<p>NOW my problem is that I want to have the average of this procedure's result, I mean this current procedure give me a row that it contains average of some column. Now I want to have the average of this row! what can I do?</p>\n\n<p>Let me explain more the result of above procedure may be:</p>\n\n<pre><code>4,7,8,9,6\n</code></pre>\n\n<p>For next I want the average of </p>\n\n<pre><code>4,7,8,9,6 \n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":96,"score":2,"question_id":12677635,"title":"Stored procedure dynamic T-SQL query not working properly","body":"<p>I am using SQL Server 2008 R2 and have run into an issue with my dynamic T-SQL query. I believe it has to do with my syntax however it runs in a new query window fine when taken out of the dynamic T-SQL context. When ran as a stored procedure I sometimes get the following error: </p>\n\n<blockquote>\n  <p><em>Column <code>dbo.Birds.weight</code> is invalid in the select list because it is\n  not contained in either an aggregate function or the <code>GROUP BY</code>\n  clause.</em></p>\n</blockquote>\n\n<p>T-SQL code:</p>\n\n<pre><code>set @sql =\nN'select FLOOR(dbo.Birds.weight * @INPUTconversion)*@INPUTinterval as ''Weight'',\nCOUNT(1) as ''Count''\nFROM dbo.Birds\nWHERE\nweight &gt;= @INPUTminwgt AND \nweight &lt;= @INPUTmaxwgt\nGROUP BY FLOOR(weight*@INPUTconversion) \norder by weight asc'\n\n\nset @params =\nN'@INPUTminwgt float, \n@INPUTmaxwgt float, \n@INPUTconversion float,\n@INPUTinterval float';\n\nexec sp_executesql @sql, @params,  \n@INPUTminwgt = @BirdMinWeight, \n@INPUTmaxwgt = @BirdMaxWeight,\n@INPUTconversion = @conversion,\n@INPUTinterval = @interval;\n</code></pre>\n\n<p>The weights are go to the 1000 decimal place (e.g. 3.154)</p>\n\n<pre><code>@INPUTconversion = 1/interval\n</code></pre>\n\n<p>The query should return weights between the min and max weight parameters, grouped by the the interval (e.g. .1 intervals would be like 1.1, 1.2, 1.3, 1.4 with the counts of the total birds in that weight span)</p>\n\n<p>Any help is appreciated</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":84,"score":0,"question_id":12677643,"title":"Column name or number of supplied values does not match table definition when working with temp table and stored procedure","body":"<p>I am trying to insert the result set from executing a stored procedure into a temp table, but I keep getting the error </p>\n\n<blockquote>\n  <p><em>Column name or number of supplied values does not match table definition</em></p>\n</blockquote>\n\n<p>Even after I have verified that the number of rows in the temp table and the returned result from execution of the stored procedure match in name and number. How can I please fix this issue? </p>\n\n<pre><code>INSERT into #TempPackaging(ID1, ProductID1, PkgGTIN1, GTINNextLowerLevelSubPk1, ConsumerUnit1, OrderableUnit1, BarCodeIndicator1,NumberSubPacks1,TotalUnits1,LowestLevelUOM1,AlternateUPC1,CountryofOrigin1,GrossWgtPerPk1,GrossWgtUOM1,Height1,HeightUOM1,Width1,WidthUOM1,Length1,LengthUOM1,IsActive1,StatusFlag1,StatusFlag2,IsActive2,LengthUOM2,Length2,WidthUOM2,Width2,HeightUOM2,Height2,GrossWgtUOM2,GrossWgtPerPk2,CountryofOrigin2,AlternateUPC2,LowestLevelUOM2,TotalUnits2,NumberSubPacks2,BarCodeIndicator2,OrderableUnit2,ConsumerUnit2,GTINNextLowerLevelSubPk2,PkgGTIN2,ProductID2,ID2,ProductID3,PkgGTIN3,GTINNextLowerLevelSubPk3,ConsumerUnit3,OrderableUnit3,BarCodeIndicator3,NumberSubPacks3,TotalUnits3,LowestLevelUOM3,AlternateUPC3,CountryofOrigin3,GrossWgtPerPk3,GrossWgtUOM3,Height3,HeightUOM3,Width3,WidthUOM3,Length3,LengthUOM3,IsActive3,StatusFlag3,ID3)\nExec IDW_spGetProductPackaging\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12678010,"title":"IF EXIST Drop Table in View results in Incorrect syntax near the keyword 'IF'. message","body":"<p>The following code in my view products the error message  <strong>Incorrect syntax near the keyword 'IF'</strong></p>\n\n<pre><code>ALTER VIEW [dbo].[IDW_vwGetProductOutPut] \nAS  \nIF EXISTS\n( SELECT * FROM tempdb.dbo.sysobjects \n  WHERE ID = OBJECT_ID(N'tempdb..#TempPackaging')) \nBEGIN\n    DROP TABLE #TempPackaging \nEND  . . . . . .     \n\n--code to create temp table goes here . .  and so on\n</code></pre>\n\n<p>How do I code this please? </p>\n"},{"tags":["sql","tsql","ssis","data-warehouse","dimensions"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":84,"score":2,"question_id":12657674,"title":"SQL Datawarehousing, need help populating my DIMENSION using TSQL SELECT or a better alternative?","body":"<p>I have a table in my SQL Server where I \"stage\" my datawarehouse extract from our ERP system.</p>\n\n<p>From this staging table (<strong>table name: DBO.DWUSD_LIVE</strong>) , I build my dimensions and load my fact data.</p>\n\n<p>An example DIMENSION table is called \"SHIPTO\", this dimensions has the following columns:</p>\n\n<pre><code>\"shipto_id\n\"shipto\"\n\"salpha\"\n\"ssalpha\"\n\"shipto address\"\n\"shipto name\"\n\"shipto city\"\n</code></pre>\n\n<p>Right now I have an SSIS package that does a SELECT DISTINCT across the above columns to retrieve the \"unique\" data, then through the SSIS package I assign the \"shipto_id\" surrogate key to.</p>\n\n<p>An example of my current TSQL Query is:</p>\n\n<pre><code>SELECT DISTINCT\n\"shipto\", \"salpha\", \"ssalpha\", \"shipto address\", \"shipto name\", \"shipto city\"\nFROM DBO.DWUSD_LIVE\n</code></pre>\n\n<p>This works great but is not \"speedy\", some dimensions have 10 columns and doing a distinct select on those is not ideal.</p>\n\n<p>In this dimension, my \"Business Key\" columns are <strong>\"SHIPTO\", \"SALPHA\", and \"SSALPHA\"</strong>.</p>\n\n<p>So if I do:</p>\n\n<pre><code>SELECT DISTINCT\n\"shipto\", \"salpha\", \"ssalpha\"\nFROM DBO.DWUSD_LIVE\n</code></pre>\n\n<p>It yields the same results as:</p>\n\n<pre><code>SELECT DISTINCT\n\"shipto\", \"salpha\", \"ssalpha\", \"shipto address\", \"shipto name\", \"shipto city\"\nFROM DBO.DWUSD_LIVE\n</code></pre>\n\n<p>Is there a better way to do this TSQL QUERY? I need all the columns, but only DISTINCT on the business key columns.</p>\n\n<p>Your help is appreciated.</p>\n\n<p>Below is an image of how my project is setup in SSIS, the Dimensions is a SCD 1.</p>\n\n<p><img src=\"http://i.stack.imgur.com/zuie1.png\" alt=\"\"></p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":12676727,"title":"List a Status even when there are no records in the resultset with that status when querying with t-sql","body":"<p>I am creating a summary report with columns Status, Count, and Amount.  How do I list a status even if no records in the query result match that status?  Sample data offered in below image:</p>\n\n<p><img src=\"http://i.stack.imgur.com/urAYc.png\" alt=\"enter image description here\"></p>\n\n<p>When I query for the report (counting those records in the table that match the Status), I get the following results:</p>\n\n<p><img src=\"http://i.stack.imgur.com/mS7zb.png\" alt=\"enter image description here\"></p>\n\n<p>How can I get the result to match the first table, which includes Status C (there are no records with a status of C)?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":81,"score":1,"question_id":12674600,"title":"Creating a correlation matrix in SQL Server","body":"<p>I'm trying to get a correlation matrix in SQL Server and my data is in a table the following way:</p>\n\n<pre><code>RptLOB1     RptLOB2   Correlation\nAE          AE             1\nBail        AE            0.35\nCommercial  Bail          0.25\nCommercial  AE            0.15\n</code></pre>\n\n<p>...and so on.</p>\n\n<p>I want to write a code so my output looks the following way:</p>\n\n<pre><code>            AE     Bail   Commercial\nAE          1      0.35      0.15\nBail        0.35    1        0.25\nCommercial  0.15   0.25       1\n</code></pre>\n\n<p>Order of the RptLOB doesn't matter as long as the order is the same from top to bottom and left to right on top.  I've been trying to find a way to approach this and I'm not quite sure what the best way is.  I was thinking using PIVOT but that will not output the RptLOB's on top (they will be considered as columns in the table).  </p>\n\n<p>EDIT:</p>\n\n<p>This output is going to be inserted in another table like so:</p>\n\n<pre><code>col1             col2        col3                            col4        col5              \n\nGeneric\nCompany Inputs   Insurance   Stochastic Model Correlations   Exposure    Correlation Matrix\n                 AE          Bail                            Commercial\nAE               1           0.35                            0.15\nBail             0.35        1                               0.25\nCommercial       0.15        0.25                            1\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2008"],"answer_count":6,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":948,"score":3,"question_id":5996177,"title":"Output a comma seperated list in T-SQL","body":"<p>I have a table with phone numbers in it. Instead of spitting out a single row for each number I want to return a comma separated list of phone numbers. What's the easiest way to do this in sql? A while loop?</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12674275,"title":"Find all foreign key references to a certain table","body":"<p>I have a table that I would like to find all the other tables that foreign key it. I thought this thread had the answer: <a href=\"http://stackoverflow.com/questions/483193/how-can-i-list-all-foreign-keys-referencing-a-given-table-in-sql-server-2005\">How can I list all foreign keys referencing a given table in SQL Server 2005?</a></p>\n\n<p>But after trying those things, it doesn't actually list all the tables.</p>\n"},{"tags":["sql-server","tsql","while-loop"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":135,"score":0,"question_id":12638886,"title":"tsql - While Loop issue using temp table","body":"<p>Our DBA has changed a function to be a procedure, so I am amending some of my procedures to cater for this. I've come across a problem with this in one of my procedures where I have a while loop.</p>\n\n<p>I populate my temp table from the new procedure (#DGContol), and then have the following while loop:</p>\n\n<pre><code>SELECT @MinRcd = MIN(RcdNum) FROM #PortfolioDisclosure \nSELECT @MaxRcd = MAX(RcdNum) FROM #PortfolioDisclosure \n\nSET @RcdNum = @MinRcd\nWHILE @RcdNum &lt;= @MaxRcd\n\nBEGIN\n\n    -- Temporarily assign values to variables\n    SELECT\n            @PortfolioGroup = PortfolioCode\n        ,   @EndDateTime    = MaxPositionDate_DetailedDisclosure\n\n    FROM  #PortfolioDisclosure\n    WHERE RcdNum = @RcdNum\n\n\n    INSERT INTO #PositionsTable\n        SELECT\n\n\n                fi.ID_ISIN                          AS [Fund_ISIN]                  \n            ,   RTRIM(a.acct_id)                    AS [Internal_Portfolio_Code]    \n            ,   a.acct_desc                         AS [Portfolio/Fund_Name]        \n            ,   CONVERT(CHAR(11),p.as_of_tms,103)   AS [Portfolio_Date]         \n            ,   a.alt_curr_cde                      AS [Portfolio_Base_Ccy]     \n            ,   i.iss_desc                          AS [Security_Description]       \n            ,   RTRIM(i.pref_iss_id)                AS [Security_ID SEDOL/Internal]\n            ,   RTRIM(ia.iss_id)                    AS [Security_ID ISIN]           \n            ,   i.denom_curr_cde                    AS [Denomination_Ccy]           \n\n            ,   SUM(p.valval_alt_cmb_amt) OVER (PARTITION BY RTRIM(a.acct_id))      \n                                                    AS [Total_Fund_Value]\n\n            ,   p.orig_quantity                     AS [Shares/Par_Value]           \n            ,   p.valval_alt_cmb_amt                AS [Market_Value]               \n            ,   p.fld5_rte                          AS [Pct_of_NAV] \n\n            ,   SUM(CASE WHEN i.issue_cls1_cde = '010' THEN p.valval_alt_cmb_amt ELSE 0 END) OVER (PARTITION BY a.acct_id)      \n                                                    AS [Cash/Cash_Equivalents]\n\n            ,   i.inc_proj_cmb_rte                  AS [Coupon_Rate]                \n            ,   CONVERT(CHAR(11),i.mat_exp_dte,103) AS [Maturity_Date]              \n\n\n        FROM dw_position_dg AS p\n\n            INNER JOIN #DGControl AS dgc -- [M]onthly, [M]ost recent position\n                ON dgc.DataGrpCtlNum = p.data_grp_ctl_num\n\n            INNER JOIN dw_ivw_acct AS a WITH (NOLOCK)\n                ON a.acct_id = p.acct_id\n\n            INNER JOIN dw_issue_dg AS i WITH (NOLOCK)\n                ON i.instr_id = p.instr_id\n\n            LEFT OUTER JOIN dw_issue_alt_id AS ia WITH (NOLOCK)\n                ON ia.instr_id = i.instr_id\n                AND ia.id_ctxt_typ = 'ISIN'\n\n            INNER JOIN #PortfolioDisclosure AS fi\n                ON fi.PortfolioCode = p.acct_id\n                and fi.MaxPositionDate_DetailedDisclosure &gt;= p.as_of_tms\n\n        WHERE RTRIM(a.acct_id) NOT IN ( SELECT xref.internal_value FROM  dbo.DP_CrossReference as xref\n                                        WHERE xref.Codeset_type_id = 10401 \n                                        AND xref.Originator_id = 'DataVendorPortfolioExclusion')\n\n            -- Clear down variable values\n            SET @PortfolioGroup = NULL\n            --SET @StartDateTime = NULL\n            SET @EndDateTime = NULL\n\n            -- Move to next record\n            SET @RcdNum = @RcdNum + 1\n\nEND -- END WHILE LOOP\n</code></pre>\n\n<p>However this returns lots of duplicate records. If I replace the temp table #DGControl with the original function then I get the correct number of records.</p>\n\n<p>I don't really know what the issue would be or how I could re code this while loop so that using the table #DGControl I get the correct number of records. Can anyone help?</p>\n"},{"tags":["asp.net","sql","tsql","asp.net-membership"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":92,"score":3,"question_id":12661356,"title":"How do I trigger a reset password?","body":"<p>I work in Microsoft .NET 4.0 environment.\nIn my application I enable the user to get new automatic password.\nSo I use in my .cs file the method:</p>\n\n<pre><code>MembershipUser user = Membership.GetUser();\nuser.ResetPassword();\n</code></pre>\n\n<p>I want to trigger on reset Password, means: when the password is changed to the automatic\none, an email will be sent to the user's email address with the new password (that is returned from user.ResetPassword()).</p>\n\n<p>I use standard Membership DB tables.</p>\n\n<p>I wrote the following trigger:</p>\n\n<pre><code>CREATE TRIGGER MembershipChangePass ON aspnet_Membership\nAFTER UPDATE,DELETE\nAS\nBEGIN\n\nDECLARE @user uniqueidentifier\nDECLARE @email nvarchar(256)\n\nSELECT @user = (SELECT UserId FROM UPDATED)\nSELECT @email =(SELECT LoweredEmail FROM aspnet_Membership\n            WHERE @user=UserId)\n\nEXEC xp_sendmail @email, ??? \n\nEND\nGO    \n</code></pre>\n\n<ol>\n<li>The problem is how do I get the ??? - the new automatic password I created by\nthe method: user.ResetPassword();</li>\n<li>Can I define the TRIGGER to be used only with user.ResetPassword(), and not with other \nmethods (like: (user.ChangePassword(...))?</li>\n<li>Maybe there is another simple way to trigger reset password?</li>\n</ol>\n\n<p>Thank you. </p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":12671272,"title":"Best practice inner select","body":"<p>In this example I am joining two tables.</p>\n\n<pre><code>DECLARE @AA TABLE\n        (\n            A1 INT,\n            A2 INT\n        )       \nDECLARE @BB TABLE\n        (\n            B1 INT,\n            B2 INT\n        )\n\nINSERT INTO @AA values (1,1)    \nINSERT INTO @AA values (2,2)    \nINSERT INTO @AA values (3,3)    \n\nINSERT INTO @BB values (1,1)    \nINSERT INTO @BB values (2,2)    \nINSERT INTO @BB values (3,3)\n\nSELECT A1, A2, B1, B2 from @AA a\n        JOIN @BB b on b.B1 = a.A1\n        where 1=1\n        and a.A1 in (1,2)\n        and b.B1 in (select max(bb.B1) from @BB bb JOIN @AA aa on bb.B1 = aa.A1 where aa.A1 in (1,2))\n</code></pre>\n\n<p>The above code is working since I am looking to get the result: \"2,2,2,2\"</p>\n\n<p>Is there a more efficient way to do this? The inner select is pretty much the same as the outer select and to me it doesn't look very nice.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","divide-by-zero"],"answer_count":6,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":1117,"score":0,"question_id":406520,"title":"Divide by zero error in stored procedure","body":"<p>Hi i executed the following stored procedure in .net web application. Then run the application. I got this error</p>\n\n<p>\" Divide By zero error \"</p>\n\n<p>Stored procedure:</p>\n\n<pre><code>CREATE procedure Details(@Stringtext varchar(8000),@SearchStringtext varchar(100))\nas begin\nSELECT ({fn LENGTH(@Stringtext)}-\n{fn LENGTH({fn REPLACE(@Stringtext, @SearchStringtext, '')})})/\n{ fn LENGTH(@SearchStringtext)}AS String_Count\n\nend\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":89,"score":2,"question_id":11545666,"title":"Format TSQL onto one line","body":"<p>Our company uses an old app which reads TSQL from a .INI file. Due to how the app process the INI file the TSQL has to be all on one line. I use Poor Mans TSQL Formatter to get everything nice and tidy for things like SPs, but am wondering if there's something out there to do the reverse - take nicely formatted TSQL and shove it all onto one line (removing carriage returns , line breaks etc).\nI'm working in SSMS but also use Notepad++, and will happily use some other editor if it has the functionality.</p>\n"},{"tags":["c#","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":4,"view_count":123,"score":-3,"question_id":9725436,"title":"Querying SQL Server from C#","body":"<p>I'm trying to fetch a person's account balance from a database table in SQL Server.</p>\n\n<p>I've created an SQL command that uses a person's card ID to find out their account ID, then check the balance in another table.</p>\n\n<p>I think I'm missing something - Class1.cardNumber is the card number chosen when you log in.</p>\n\n<p>ok full details is theres 2 forms the first form is a login for an atm that works perfectly i then put a class variable in to capture the cardnumber used in the first form (class1.cardNumber) then i created a command that goes a little like</p>\n\n<p>SELECT CARDDetails, CustomerDetails (bit different names)\nthen its the link between the 2 using the CustomerNumber\nWHERE (balance = @ balance) AND (cardNumber = @ cardNumber) AND (CustomerNumber = @ customerNumber)</p>\n\n<p>this is the only code really in the sheet to sorry about the slow update.</p>\n\n<pre><code>sqlCommandBalance.Connection.Open();\nsqlCommandBalance.Parameters[\"@accountID\"].Value = Class1.cardNumber;\nSqlDataReader readdata = sqlCommandBalance.ExecuteReader();\nstring balanceDB = \"\";\n\nwhile (readdata.Read())\n{\n    balanceDB = readdata[\"@balance\"].ToString();\n}\n\nsqlCommandBalance.Connection.Close();\nsqlCommandBalance.Connection.Dispose();\n\ntextBalance.Text += \" \" + balanceDB.ToString();\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12660970,"title":"FUNCTION that parses a folder path and returns a table","body":"<p>How to create a function that parses a folder path and returns a table?</p>\n\n<p>The delimiter  will be the backslash <code>\\</code>. Input will be a folder path  <code>FolderA\\FolderB</code>.</p>\n\n<p>Output will be a table with folders in sequence:</p>\n\n<pre><code>FolderName: FolderA  FolderB    \nLevel:      0      1\n</code></pre>\n"},{"tags":["tsql","computed-columns","divide-by-zero"],"answer_count":4,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":1074,"score":5,"question_id":5191701,"title":"TSQL divide by zero encountered despite no columns containing 0","body":"<p>I've been trying to understand why I get a \"divide by zero encountered\" (Msg 8134) with my SQL query, but I must be missing something. I would like like to know the <strong>why</strong> for the specific case below, I am <strong>not</strong> looking for <code>NULLIF</code>, <code>CASE WHEN...</code> or similar as I already know about them (and can of course use them in a situation as the one below).</p>\n\n<p>I have an SQL statement with a computed column similar to</p>\n\n<pre><code>SELECT\n    TotalSize,\n    FreeSpace,\n    (FreeSpace / TotalSize * 100)\nFROM\n    tblComputer\n...[ couple of joins ]...\nWHERE\n    SomeCondition = SomeValue\n</code></pre>\n\n<p>Running this statement errors with the above mentioned error messages, which, in itself, is not the problem - obviously <code>TotalSize</code> might well be 0 and therefore cause the error. </p>\n\n<p>Now what I don't understand is that I do not have any rows where the <code>TotalSize</code> column is 0 when I comment the computed column out, I double checked that this isn't the case.</p>\n\n<p>Then I thought that for some reason the column computation would be performed on the whole result set <strong>before</strong> actually filtering with the conditions of the where clause, but this a) wouldn't make sense imho and b) when trying to reproduce the error with a test set-up everything works fine (see below):</p>\n\n<pre><code>INSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0001',1)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0002',1)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0003',1)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0004',0)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0005',1)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0006',0)\nINSERT INTO tblComputer (ComputerName, IsServer) VALUES ('PC0007',1)\n\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (1,100,21)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (2,100,10)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (3,100,55)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (4,0,10)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (5,100,23)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (6,100,18)\nINSERT INTO tblHDD (ComputerID, TotalSize, FreeSpace) VALUES (7,100,11)\n\n-- This statement does not throw an error as apparently the row for ComputerID 4 \n-- is filtered out before computing the (FreeSpace / TotalSize * 100)\nSELECT \nTotalSize,\nFreeSpace,\n(FreeSpace / TotalSize * 100)\nFROM \ntblComputer\nJOIN\ntblHDD ON\ntblComputer.ID = tblHDD.ComputerID\nWHERE\nIsServer = 1\n</code></pre>\n\n<p>I am quite stumped and would like to know what the reason is.</p>\n\n<p>Any ideas or pointers into the right direction are very welcome, thanks in advance</p>\n\n<p><strong>Update</strong></p>\n\n<p>Thank you so far for your input, but unfortunately I seem not to be getting closer to the root of the problem. I managed to strip the statement down a little bit and now have the case that I can execute it without errors if one JOIN is removed (I would need it for additional columns in the output which I temporarily removed).</p>\n\n<p>I do not understand, why using the JOIN leads to the error, shouldn't a standard INNER JOIN always either return the same number of rows or <strong>less</strong>, but never <strong>more</strong>?</p>\n\n<p><strong>Working code</strong></p>\n\n<pre><code>SELECT \nTotalSize,\nFreeSpace\n((FreeSpace / TotalSize) * 100)\nFROM \nMyTable1\nINNER JOIN \nMyTable2 ON\nMyTable1.ID = MyTable2.Table1ID\nWHERE \nSomeCondition\n</code></pre>\n\n<p><strong>Error causing code</strong></p>\n\n<pre><code>SELECT \nTotalSize,\nFreeSpace\n((FreeSpace / TotalSize) * 100)\nFROM \nMyTable1\nINNER JOIN \nMyTable2 ON\nMyTable1.ID = MyTable2.Table1ID\n-- This JOIN causes \"divide by zero encountered\" error\nINNER JOIN \nMyTable3 ON\nMyTable2.ID = MyTable3.Table2ID\nWHERE \nSomeCondition\n</code></pre>\n\n<p>I also tried my luck using a cursor and looping over the result row by row, but in that case no error occurred (no matter, which of the two statements above I tried).</p>\n\n<p>Sorry for the messy code indentation, somehow the correct formatting doesn't seem to be applied.</p>\n\n<p>G.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","divide-by-zero"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":85,"score":1,"question_id":11337250,"title":"How to avoid divide by zero error here?","body":"<p>The following query that I have is encountering a divide by 0 error:</p>\n\n<pre><code>select  pp.building_name, \n        ld.tenant_trading_name,  \n        tenancy_reference,  \n        ld.turnover_threshold, \n        ld.percentage_rent, \n        ld.income_base_rent_ach, \n        ld.income_base_rent_ach / ld.percentage_rent as correct \nfrom \n    lease_deal.lease ld\n\ninner join property.property pp\n    on ld.building_id = pp.building_id\n\nwhere \n    (ld.income_base_rent_ach / ld.percentage_rent ) &lt;&gt; ld.turnover_threshold\n    and lease_status = 'APPROVED'\n    and ld.progenesis_load_date is  null\norder by pp.building_name\n</code></pre>\n\n<p>I've tried to correct this by doing the following - but I'm receiving a syntax error and I'm unsure why? What is syntactically incorrect here?</p>\n\n<pre><code>select  pp.building_name, \n        ld.tenant_trading_name,  \n        tenancy_reference,  \n        ld.turnover_threshold, \n        ld.percentage_rent, \n        ld.income_base_rent_ach, \n        ld.income_base_rent_ach / ld.percentage_rent as correct \nfrom \n    lease_deal.lease ld\n\ninner join property.property pp\n    on ld.building_id = pp.building_id\n\nwhere \n    case when ld.percentage_rent = 0\n    then 1=1\n    else ((ld.income_base_rent_ach / ld.percentage_rent ) &lt;&gt; ld.turnover_threshold)\n    end\n    and lease_status = 'APPROVED'\n    and ld.progenesis_load_date is  null\norder by pp.building_name\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","query","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":71,"score":7,"question_id":12666306,"title":"Properly using the Count Function","body":"<p>In the Enrollment_Changes table, the phone model listed is the phone the subscriber changed FROM on that date.</p>\n\n<p>If there is no subsequent change on Enrollment_Changes, the phone the subscriber changed TO is listed on the P_Enrollment table</p>\n\n<p>For example, subscriber 12345678 enrolled on 1/5/2011 with a RAZR.  On 11/1/2011 he changed FROM the RAZR.  You can see what he changed TO with the next transaction on Enrollment_Changes on 05/19/2012.  </p>\n\n<p>How would you find the Count of subs that first enrolled with the iPhone 3? </p>\n\n<p>Here is the code I have for creating the tables</p>\n\n<p>Create Tables: TBL 1</p>\n\n<pre><code>USE [Test2]\nGO\n\n/****** Object:  Table [dbo].[P_ENROLLMENT]    ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dbo].[P_ENROLLMENT](\n    [Subid ] [float] NULL,\n    [Enrollment_Date] [datetime] NULL,\n    [Channel] [nvarchar](255) NULL,\n    [Region] [nvarchar](255) NULL,\n    [Active_Status] [float] NULL,\n    [Drop_Date] [datetime] NULL,\n    [Phone_Model] [nvarchar](255) NULL\n) ON [PRIMARY]\n\nGO\n</code></pre>\n\n<p>TBL 2</p>\n\n<pre><code>USE [Test2]\nGO\n\n/****** Object:  Table [dbo].[ENROLLMENT_CHANGES]     ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dbo].[ENROLLMENT_CHANGES](\n    [Subid] [float] NULL,\n    [Cdate] [datetime] NULL,\n    [Phone_Model] [nvarchar](255) NULL\n) ON [PRIMARY]\n\nGO\n</code></pre>\n\n<p>Insert TBL1</p>\n\n<pre><code>INSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12345678, '2011-01-05 00:00:00', 'Retail', 'Southeast', 1, NULL, 'iPhone 4');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12346178, '2011-03-13 00:00:00', 'Indirect Dealers', 'West', 1, NULL, 'HTC Hero');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12346679, '2011-05-19 00:00:00', 'Indirect Dealers', 'Southeast', 0, '2012-03-15 00:00:00', 'Droid 2');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12347190, '2011-07-25 00:00:00', 'Retail', 'Northeast', 0, '2012-05-21 00:00:00', 'iPhone 4');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12347701, '2011-08-14 00:00:00', 'Indirect Dealers', 'West', 1, NULL, 'HTC Hero');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12348212, '2011-09-30 00:00:00', 'Retail', 'West', 1, NULL, 'Droid 2');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12348723, '2011-10-20 00:00:00', 'Retail', 'Southeast', 1, NULL, 'Southeast');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12349234, '2012-01-06 00:00:00', 'Indirect Dealers', 'West', 0, '2012-02-14 00:00:00', 'West');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12349745, '2012-01-26 00:00:00', 'Retail', 'Northeast', 0, '2012-04-15 00:00:00', 'HTC Hero');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12350256, '2012-02-11 00:00:00', 'Retail', 'Southeast', 1, NULL, 'iPhone 4');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12350767, '2012-03-02 00:00:00', 'Indirect Dealers', 'West', 1, NULL, 'Sidekick');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12351278, '2012-04-18 00:00:00', 'Retail', 'Midwest', 1, NULL, 'iPhone 3');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12351789, '2012-05-08 00:00:00', 'Indirect Dealers', 'West', 0, '2012-07-04 00:00:00', 'iPhone 3');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12352300, '2012-06-24 00:00:00', 'Retail', 'Midwest', 1, NULL, 'Droid 2');\n\nINSERT INTO [P_ENROLLMENT]([Subid ], [Enrollment_Date], [Channel], [Region], [Active_Status], [Drop_Date], [Phone_Model]) \n    VALUES(12352811, '2012-06-25 00:00:00', 'Retail', 'Southeast', 1, NULL, 'Sidekick');\n</code></pre>\n\n<p>Insert TBL2</p>\n\n<pre><code>INSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12345678, '2011-11-01 00:00:00', 'RAZR');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12346178, '2012-01-07 00:00:00', 'HTC Hero');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12348723, '2012-01-28 00:00:00', 'RAZR');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12350256, '2012-02-21 00:00:00', 'Blackberry Bold');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12349745, '2012-05-05 00:00:00', 'HTC Hero');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12345678, '2012-05-19 00:00:00', 'Palm Pre');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12347190, '2012-05-20 00:00:00', 'HTC Hero');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12350256, '2012-05-21 00:00:00', 'Blackberry Bold');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12349234, '2012-06-04 00:00:00', 'Palm Pre');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12346178, '2012-06-05 00:00:00', 'iPhone 3');\n\nINSERT INTO [ENROLLMENT_CHANGES]([Subid], [Cdate], [Phone_Model]) \n    VALUES(12350767, '2012-06-10 00:00:00', 'iPhone 3');\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":59,"score":1,"question_id":12665003,"title":"Sorting an CTE Query","body":"<p>I have a CTE Recursive query which returns the output as expected, however It would be nice if I can control the sort. For example I would like to sort PARENT nodes by using a custom SORT column in table...and IF POSSIBLE sort the nodes under Parent Categories as well by using a SORT column.</p>\n\n<p>Hete is <a href=\"http://sqlfiddle.com/#!3/1a7eb/4\" rel=\"nofollow\">SQL Fiddle</a></p>\n\n<p>Please look at sort Column, With Sort output should  be something like this.</p>\n\n<pre><code> Appliances &lt; -- Parent\n   Dryers\n   Washers\n Toys &lt; -- Parent\n Furniture &lt; -- Parent\n</code></pre>\n\n<p>if sorting on child nodes is NOT possible then its fine, but it would be nice to atleast control the sort for PARENT nodes.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":83,"score":2,"question_id":12659142,"title":"How to select only numeric values","body":"<p>Table1</p>\n\n<p>id</p>\n\n<pre><code>01\nwire\n02\nsteve\nram123\n03\n....\n</code></pre>\n\n<p>from the table1 i want to select only numeric values, \nIt should not display alphanumeric values like (ram123)</p>\n\n<p>Expected Output</p>\n\n<pre><code>01\n02\n03\n....\n</code></pre>\n\n<p>How to make a query for this condition</p>\n"},{"tags":["java","tsql","sql-server-2008","checksum"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":313,"score":3,"question_id":6892138,"title":"Implementing SQL CHECKSUM in Java","body":"<p>I have an existing database in SQL Server 2008 that performs user authentication via stored procedure for an existing PHP web application.  The web application sends the stored procedure a string, however the stored procedure stores, and checks the value with SQL Checksum (<a href=\"http://msdn.microsoft.com/en-us/library/ms189788.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms189788.aspx</a>).  The Stored Procedure casts the string as NVARCHAR(50), and stores the CHECKSUM as int in the user table.</p>\n\n<p>I am now writing a new Java application on top of the existing database, and I'm writing a custom spring authentication manager.  I would like to re-implement the CHECKSUM algorithm in Java so I do not need to call a stored procedure to perform the conversion, however I can not find any documentation on how SQL CHECKSUM works.</p>\n\n<p>I tried the following code, with the guess that it was CRC32, however it fails to return the same value as SQL CHECKSUM:</p>\n\n<pre><code>String pass = \"foobar\";\nCRC32 crc32 = new CRC32();\ncrc32.update(pass.getBytes(\"UTF-16\")); //This is due to the stored procedure casting as nvarchar\ncrc32.getValue();\n</code></pre>\n\n<p>Can anyone point me to the algorithm that SQL CHECKSUM uses so I can re-implement it in Java?</p>\n\n<p>The question also isn't which algorithm provides the best hash for security. Security is outside of the requirements in this particular instance, as we are not prepared to force a system wide password reset. The question is what algorithm is used by T-SQL CHECKSUM, so that it could be re-implemented. This particular use case is for auth, however there is potential for this being necessary in many different applications.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008"],"answer_count":11,"favorite_count":2,"up_vote_count":13,"down_vote_count":0,"view_count":56041,"score":13,"question_id":1509977,"title":"convert varchar into datetime in sql server","body":"<p>How do i convert a string of format -> mmddyyyy into datetime in sql server 2008?</p>\n\n<p>My target column in 'DateTime'</p>\n\n<p>I have tried with Convert and most of the Date style values - I get a 'The conversion of a varchar data type to a datetime data type resulted in an out-of-range value.' error message</p>\n"},{"tags":["sql","sql-server","tsql","precision","datediff"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12658312,"title":"t-SQL and DATEDIFF efficiency vs. precision","body":"<p>I have an SQL Server 2008 table that can be illustrated as such:</p>\n\n<pre><code>CREATE TABLE tbl (dtIn DATETIME2, dtOut DATETIME2)\nINSERT tbl VALUES\n('9/12/2012 3:21:22 AM', '9/12/2012 3:32:15 AM'),\n('9/12/2012 3:58:52 AM', '9/12/2012 4:00:47 AM'),\n('9/12/2012 4:02:00 AM', '9/12/2012 4:03:26 AM'),\n('9/12/2012 4:04:34 AM', '9/12/2012 4:17:03 AM'),\n('9/12/2012 4:22:37 AM', '9/12/2012 4:24:18 AM'),\n('9/12/2012 5:35:27 AM', '9/12/2012 5:36:26 AM'),\n('9/12/2012 5:37:00 AM', '9/12/2012 5:38:08 AM'),\n('9/12/2012 5:38:36 AM', '9/12/2012 5:39:40 AM'),\n('9/12/2012 5:44:22 AM', '9/12/2012 9:40:21 PM'),\n('9/12/2012 9:41:28 PM', '9/12/2012 9:44:19 PM'),\n('9/12/2012 10:25:40 PM', '9/12/2012 10:30:25 PM'),\n('9/12/2012 10:30:40 PM', '9/12/2012 10:34:06 PM'),\n('9/12/2012 10:37:53 PM', '9/12/2012 10:40:12 PM'),\n('9/12/2012 10:40:17 PM', '9/12/2012 11:59:59 PM')   --and so on\n</code></pre>\n\n<p>I then need to execute a query like this (to calculate duration in minutes):</p>\n\n<pre><code>WITH ctx AS(\n  SELECT datediff(minute, dtIn, dtOut) AS d FROM tbl\n  )\nSELECT SUM(d) FROM ctx\n</code></pre>\n\n<p>The issue with the query above is that I lose precision. For instance, this query for the table above will be 1 second off, which will get worse for more values to a point that I actually lose tens of minutes for a large dataset.</p>\n\n<p>I was thinking to replace it with one of two alternatives, but I'm not sure which one is more efficient to use?</p>\n\n<p>One with division:</p>\n\n<pre><code>WITH ctx AS(\n  SELECT datediff(second, dtIn, dtOut) / 60.0 AS d FROM tbl\n  )\nSELECT SUM(d) FROM ctx\n</code></pre>\n\n<p>Or two with the cast (to prevent int overrun that goes as far as 68 years):</p>\n\n<pre><code>WITH ctx AS(\n  SELECT datediff(second, dtIn, dtOut) AS d FROM tbl\n  )\nSELECT SUM(CAST(d AS BIGINT)) FROM ctx\n</code></pre>\n"},{"tags":["c#","sql-server","tsql","rounding","datediff"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":67,"score":3,"question_id":12657680,"title":"DATEDIFF with minute does not return expected value","body":"<p>Say, I have the following SQL Server 2008 table with data:</p>\n\n<pre><code>CREATE TABLE tbl (dtIn DATETIME2, dtOut DATETIME2)\nINSERT tbl VALUES\n('9/10/2012 5:14:10 AM', '9/10/2012 5:15:09 AM'),\n('9/10/2012 5:16:12 AM', '9/10/2012 5:18:12 AM'),\n('9/10/2012 5:18:43 AM', '9/10/2012 5:23:04 AM'),\n('9/10/2012 5:25:17 AM', '9/10/2012 5:26:05 AM'),\n('9/10/2012 5:26:57 AM', '9/10/2012 5:29:19 AM'),\n('9/10/2012 5:31:41 AM', '9/10/2012 5:32:41 AM'),\n('9/10/2012 5:33:16 AM', '9/10/2012 5:34:08 AM'),\n('9/10/2012 5:35:25 AM', '9/10/2012 5:49:46 AM'),\n('9/10/2012 5:55:35 AM', '9/10/2012 5:56:48 AM'),\n('9/10/2012 5:58:54 AM', '9/10/2012 5:59:59 AM')\n</code></pre>\n\n<p>and then I ran <a href=\"http://sqlfiddle.com/#!3/8e57d/1\" rel=\"nofollow\">this query</a>:</p>\n\n<pre><code>WITH ctx AS(\n  SELECT datediff(minute, dtIn, dtOut) AS d FROM tbl\n  )\nSELECT SUM(d) FROM ctx\n</code></pre>\n\n<p>I get 30 minutes.</p>\n\n<p>But when I try the same with C#:</p>\n\n<pre><code>double fM = 0;\nfM += (DateTime.Parse(\"9/10/2012 5:15:09 AM\") - DateTime.Parse(\"9/10/2012 5:14:10 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:18:12 AM\") - DateTime.Parse(\"9/10/2012 5:16:12 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:23:04 AM\") - DateTime.Parse(\"9/10/2012 5:18:43 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:26:05 AM\") - DateTime.Parse(\"9/10/2012 5:25:17 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:29:19 AM\") - DateTime.Parse(\"9/10/2012 5:26:57 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:32:41 AM\") - DateTime.Parse(\"9/10/2012 5:31:41 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:34:08 AM\") - DateTime.Parse(\"9/10/2012 5:33:16 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:49:46 AM\") - DateTime.Parse(\"9/10/2012 5:35:25 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:56:48 AM\") - DateTime.Parse(\"9/10/2012 5:55:35 AM\")).TotalMinutes;\nfM += (DateTime.Parse(\"9/10/2012 5:59:59 AM\") - DateTime.Parse(\"9/10/2012 5:58:54 AM\")).TotalMinutes;\n</code></pre>\n\n<p>I get fM = 29.016666666666669.</p>\n\n<p>By adding Math.Round() to each C# statement, I get 28.0.\nBy adding Math.Floor() I get 25.0.\nBy adding Math.Ceiling I get 33.0.</p>\n\n<p>Can someone explain this discrepancy?</p>\n"},{"tags":["sql","database","sql-server-2008","tsql","self-join"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":12208025,"title":"Fetch rows based on the highest value of a column and criteria on another column","body":"<p>I'm looking for an SQL query that gives a Scr for each user, from the highest Seq, where the Scr is not equal to 0. It is guaranteed that the Seq values are unique for each User.</p>\n\n<p><strong>Sample data:</strong></p>\n\n<pre>\nID  Cde User    Scr Seq\n1   1   James   110 19\n2   1   James   85  20\n3   1   James   99  21\n4   1   James   99  22\n5   1   James   0   23\n6   2   Andrew  88  19\n7   2   Andrew  88  20\n8   2   Andrew  88  21\n9   2   Andrew  0   22\n10  2   Andrew  0   23\n11  3   David   0   19\n12  3   David   95  20\n13  3   David   95  21\n14  3   David   0   22\n15  3   David   0   23\n</pre>\n\n<p><strong>Query results:</strong></p>\n\n<pre>\nID  Cde User    Scr Seq\n4   1   James   99  22\n8   2   Andrew  88  21\n13  3   David   95  21\n</pre>\n"},{"tags":["sql","database","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":101,"score":1,"question_id":10731405,"title":"How can I join these two tables into the same Sql result","body":"<p>I'm trying to generate a SQL query that can join two tables together and return the result .. but the second table is 'flattened'. I'm not sure if that's the correct technical term. Is it denormalized?</p>\n\n<p>Anyways, can someone suggest how I could do this?</p>\n\n<p>Table: <strong>Users</strong></p>\n\n<pre><code>UserId  Name\n1       Pure.Krome\n2       John\n3       Jill\n4       Jane\n</code></pre>\n\n<p>Table: <strong>UserAliases</strong></p>\n\n<pre><code>UserAliasId  UserId  Alias\n1            1       Idiot\n2            1       PewPew\n3            3       BlahBlahBlah\n</code></pre>\n\n<p><strong>Desired results</strong></p>\n\n<pre><code>UserId  Name        Aliases\n1       Pure.Krome  Idiot PewPew\n2       John\n3       Jill        BlahBlahBlah\n4       Jane\n</code></pre>\n\n<p>Please note: </p>\n\n<ul>\n<li>A user does NOT need to have an alias. So that's a zero->many relationship (<code>outer join</code>)</li>\n<li>The delimiter for the flattening of the 2nd table is a SPACE. If an alias has a space, bad luck for me. (Consider it, bad data).</li>\n</ul>\n\n<p>Another example of my problem is to think of a StackOverflow question + tags.</p>\n"},{"tags":["database","sql-server-2008","tsql","join"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":73,"score":2,"question_id":11822522,"title":"Complex SQL Join","body":"<p>I am fairly new to SQL joins, but I have a tricky issue here. I have tried to resolve this on my own, and searched as well, but unsuccessful.  </p>\n\n<p>I have two primary SQL tables </p>\n\n<p><strong>CustProfile</strong>  </p>\n\n<pre><code>ClientID || ClientName \n</code></pre>\n\n<p><strong>CustTransaction</strong>  </p>\n\n<pre><code>CorpID || DivID || DeptID \n</code></pre>\n\n<p>I need to display my output as follows:  </p>\n\n<pre><code>`CorpID` `CorpIDClientName` `DivID` `DivIDName` `DeptID` `DeptIDName`  \n\nCustTransaction.CorpID join on CustProfile.ClientID to get `CorpIDClientName`  \nCustTransaction.DivID join on CustProfile.ClientID to get `DivIDName`  \nCustTransaction.DeptID join on CustProfile.ClientID to get `DeptIDName`  \n</code></pre>\n\n<p>I hope someone can provide the join query. Thanks in advance</p>\n"},{"tags":["sql","database","sql-server-2008","tsql","count"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":117,"score":1,"question_id":12360143,"title":"TSQL Count function and distinct missing NULL values","body":"<p>According to MSDN, the TSQL COUNT(*) function includes any NULL values in the result unless DISTINCT is also used (source: <a href=\"http://msdn.microsoft.com/en-us/library/ms175997.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms175997.aspx</a>)</p>\n\n<p>However, in my query NULL values are being ignored. To test this, I created a small table and filled it with some data:</p>\n\n<pre><code>CREATE TABLE tbl (colA varchar(1), colB varchar(10))\nINSERT tbl VALUES\n('Y', 'test1'),\n('Y', 'test2'),\n(null, 'test3'),\n(null, 'test4'),\n('N', 'test5')\n</code></pre>\n\n<p>I then ran the following 2 queries on it: </p>\n\n<pre><code>SELECT count(*) FROM tbl\nWHERE colA &lt;&gt; 'N'\n</code></pre>\n\n<p>and </p>\n\n<pre><code>SELECT DISTINCT colA FROM tbl\nWHERE colA &lt;&gt; 'N'\n</code></pre>\n\n<p>Both results ignore the NULL values. I get 2 and 'Y' as the results respectively. I'm at a loss to why this is happening. Could someone please clue me in?</p>\n\n<p>Results simulated in SQL Fiddle: <a href=\"http://sqlfiddle.com/#!3/8f00b/9\" rel=\"nofollow\">http://sqlfiddle.com/#!3/8f00b/9</a></p>\n"},{"tags":["sql","sql-server","database","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":72,"score":2,"question_id":12248899,"title":"How can i concatenate and make a group of text in sql server?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/451415/simulating-group-concat-mysql-function-in-ms-sql-server-2005\">Simulating group_concat MySQL function in MS SQL Server 2005?</a>  </p>\n</blockquote>\n\n\n\n<p>I have a table <strong>tb1</strong>. I want concatenated result set.</p>\n\n<p><img src=\"http://i.stack.imgur.com/60DSY.png\" alt=\"enter image description here\"></p>\n\n<p>Please help me by writing  a query for this problem?</p>\n"},{"tags":["sql-server","database","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":218,"score":0,"question_id":8812733,"title":"Getting a count of each distinct row in SQL Server ","body":"<p>How do I get this statement (which returns duplicates):</p>\n\n<pre><code>  Select Name from Table\n</code></pre>\n\n<p>To return this:</p>\n\n<pre><code>  Select Distinct Name, Count(Number of non-distinct Name rows)\n</code></pre>\n\n<p>?</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","database","sql-server-2008","tsql","reporting-services"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":93,"score":2,"question_id":12241362,"title":"Make single row of multiple rows by appending to the right in SQL Server?","body":"<p>I have a table such as this:</p>\n\n<pre>\nUserID  AddressLine1, AddressLine2, Phone\n1, First Street, Somewhere, 123\n1, Second Street, Somewhere2, 124\n2, 32th Street, Somewhere, 125\n2, 24th Street, Somewhere3, 126\n2, 25th Street, Somewhere4, 127\n</pre>\n\n<p>How do I convert this to (Output needs to have each field in separate column, each comma implies a column de-limiter):</p>\n\n<pre>\n1, First Street, Somewhere, 123, Second Street, Somewhere2, 124\n2, 32th Street, Somewhere, 125, 24th Street, Somewhere3, 126, 25th Street, Somewhere4, 127</pre>\n\n<p>This is for a report i am doing in SSRS.  Each user can have a dynamic number of addresses and they all need to be on a single row per user in the end result.</p>\n"},{"tags":["sql","database","windows","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":104,"score":4,"question_id":12593492,"title":"SQL Server : max date and inner join","body":"<p>I have two tables, one is a list of tasks. The other containing historical values for those tasks.</p>\n\n<p>I need to generate a list of the latest event (and its description) for each check, as long as long as its <code>Date_Executed</code> is less than the current datetime minus the <code>Timeframe</code> (<code>TimeFrame</code> being hours within the task has to be done, formatted for use in <code>DATEADD</code>). But only if they have an <code>active = 1</code>. </p>\n\n<p>Table: <strong>checks</strong></p>\n\n<pre><code>Check_id  description  TimeFrame active\n1         Task One     -24       0\n2         Task Two     -24       0\n3         Task Forty   -48       1\n4         Task Somehin -128      1\n</code></pre>\n\n<p>Table: <strong>events</strong></p>\n\n<pre><code>Event_id  Check_id   Comment     Date_Executed             User_Executed\n1         1          NULL        2012-09-18 16:10:44.917   admin\n2         1          NULL        2012-09-25 11:39:01.000   jeff\n3         4          Failed      2012-09-25 13:20:09.930   steve\n4         4          Half failed 2012-09-25 13:05:09.953   marsha\n5         2          NULL        2012-09-25 14:02:24.000   marsha\n6         3          NULL        2012-09-18 16:10:55.023   marsha\n</code></pre>\n\n<p>The best solutions I have so far is:</p>\n\n<pre><code>SELECT \n    a.[Date_Executed]\n    a.[Check_id], \n    a.[Comments],\n    b.[frequency], \n    b.[Check_id],\n    b.[description]     \nFROM \n    [checksdb].[dbo].events as a, \n    [checksdb].[dbo].checks as b\nwhere \n    b.active = 1\n    and a.[Date_Executed] &lt; = dateadd(HOUR,b.[frequency],GETDATE())\n    and a.Check_id = b.Check_id\norder by Check_id, priority\n</code></pre>\n\n<p>and</p>\n\n<pre><code>select MAX(date_Executed), Task_id from daily_check_events group by Task_id\n</code></pre>\n\n<p>Neither of which gets me what I need, I could really use some help.</p>\n"},{"tags":["sql","sql-server","database","sql-server-2008","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":73,"score":4,"question_id":12634436,"title":"How to get the latest row from table using JOIN","body":"<p>I have a join of 5 tables to get the tasks posted by each member having about 15 columns. But for sample code I have taken just two tables of them. </p>\n\n<pre><code>SELECT TOP 5 \n    dbo.MemberMst.MemberID, dbo.MemberMst.fname, \n    dbo.TaskMst.TaskMstID, dbo.TaskMst.OnDate, dbo.TaskMst.Description\nFROM   \n    dbo.MemberMst \nLEFT JOIN\n    dbo.TaskMst ON dbo.MemberMst.MemberID = dbo.TaskMst.MemberID\n</code></pre>\n\n<p>Output is:</p>\n\n<pre><code>MemberID fname  TaskMstID    OnDate                   Description\n3    Ursula     NULL         NULL                      NULL\n84   Opeyemi    30           2012-09-18 00:00:00.000     asd\n85   test       21           2012-09-18 10:30:46.900     aaa\n85   test       22           2012-09-18 10:31:04.967     eeee\n85   test       23           2012-09-18 10:31:26.640     vvvv\n</code></pre>\n\n<p>Here in above query I get 3 rows for <code>MemberID=85</code> who posted 3 tasks but I need only one task from that member which is the latest. How to get the latest task posted by a member so that result would be:-</p>\n\n<pre><code>MemberID fname  TaskMstID OnDate                Description\n3    Ursula     NULL      NULL                   NULL\n84   Opeyemi    30        2012-09-18 00:00:00.000   asd\n85   test       23        2012-09-18 10:31:26.640   vvvv\n</code></pre>\n\n<p>I mean to say just only one record for each <code>memberID</code> having tasks?</p>\n\n<p>Help appreciated..!</p>\n\n<p>Thanks in advance...!</p>\n"},{"tags":["sql","database","oracle","sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":100,"score":1,"question_id":12559551,"title":"SQL Server equivalent of WM_CONCAT function","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1621747/concat-field-value-to-string-in-sql-server\">Concat field value to string in SQL Server</a>  </p>\n</blockquote>\n\n\n\n<p>What is the SQL Server equivalent of WM_CONCAT?</p>\n"},{"tags":["sql","sql-server","database","sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12624382,"title":"SQL Server : join and append columns","body":"<p>I have a SQL question, and hope someone could help me or give me some pointers. Much appreciated.</p>\n\n<p>I have two tables: A and B.</p>\n\n<ul>\n<li>A has columns <code>ID</code> which is the primary key field, and <code>NAME</code></li>\n<li>B has columns <code>DUPID</code>, <code>NAME</code> and <code>ID</code> which is the primary key </li>\n</ul>\n\n<p>The relationship between A and B is in B, the <code>DUPID</code> contains certain values of <code>A.ID</code>, and the request is to append distinct <code>B.NAME</code> value to <code>A.NAME</code> separated by semi-colon based on join <code>A.ID = B.DUPID</code>.. </p>\n\n<p>Maybe my explanation isn't clear, here is a simple example.</p>\n\n<pre><code>A                                  B\nID  NAME                           DUPID      NAME\n1   null                            1             John\n2   null                            1             John\n3   null                            1             Mark\n4   null                            3             Luke\n5   null                            3             Luke\n                                    3             Luke\n                                    3             Matthew\n</code></pre>\n\n<p>So eventually, I will need to update table A, and make it look like below</p>\n\n<pre><code>A\nID      NAME\n1        John;Mark\n2        null\n3        Luke;Matthew\n4        null\n5        null\n</code></pre>\n"},{"tags":["sql","sql-server","database","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":48,"score":3,"question_id":12542864,"title":"SQL SVR 08 R2 Limit a field to specific values","body":"<p>For example, say I have field 'Gender' and I want to allow only the values Male, Female or Unisex. Is this possible in the SQL server management studio? </p>\n\n<p>Update: So far the solution is pointing towards the 'Check constraints' function which can be found by right-clicking on the desired column.</p>\n\n<p>Still, I'm getting syntax errors. Any thoughts on how I should type up the constraint?</p>\n\n<p>Answer: Turns out I just needed to type it likes this </p>\n\n<pre><code>Gender = 'Male' OR Gender = 'Female' OR Gender = 'Unisex'\n</code></pre>\n"},{"tags":["sql","sql-server-2008","query","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":180,"score":0,"question_id":11714915,"title":"FULL OUTER JOIN vs. FULL JOIN","body":"<p>Just playing around with queries and examples to get a better understanding of joins.  I'm noticing that in SQL Server 2008, the following two queries give the same results:</p>\n\n<pre><code>SELECT * FROM TableA\nFULL OUTER JOIN TableB\nON TableA.name = TableB.name\n</code></pre>\n\n<hr>\n\n<pre><code>SELECT * FROM TableA\nFULL JOIN TableB\nON TableA.name = TableB.name\n</code></pre>\n\n<p>Are these performing exactly the same action to produce the same results, or would I run into different results in a more complicated example?  Is this just interchangeable terminology?</p>\n"},{"tags":["sql","sql-server","string","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":84,"score":3,"question_id":12622771,"title":"Find first non-zero in a numeric string","body":"<p>I have a <code>char(12)</code> column with data such as:</p>\n\n<pre><code>000000004012\n000000615737\n000000000012\n000000000100\n</code></pre>\n\n<p>And I need to convert it to this:</p>\n\n<pre><code>4012\n615737\n12\n100\n</code></pre>\n\n<p>My initial thought is to use string manipulation, such as CHARINDEX.  However, I would need to search from left-to-right for the first occurrence of <code>NOT 0</code>.  How can I accomplish this in SQL Server?</p>\n"},{"tags":["sql","sql-server","tsql","join","left-join"],"answer_count":1,"favorite_count":1,"up_vote_count":7,"down_vote_count":0,"view_count":66,"score":7,"question_id":12655988,"title":"Join statement order of operation","body":"<p>Given the following 3 way  join</p>\n\n<pre><code>select t1.* from t1\nleft join t2 on t1.fk = t2.pk\njoin t3 on t2.fk = t3.pk\n</code></pre>\n\n<p>If the join between t2 and t3 failed, would the row from the successful join between t1 and t2 be returned? If the order of operation goes from left to right, I assume not,  but if it's evaluated from right to left (t3 is joined to t2 first) then t1 will still be returned even when the former failed.</p>\n\n<p>How does it work?</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":59,"score":0,"question_id":12638252,"title":"Adding a, b, c to end of data","body":"<p>I have table with contract_code column, but in this column have same data, how can I change the same data to samedata_a, and samedata_b and etc.</p>\n\n<p>For example:\nChange this data</p>\n\n<pre>\nASFRETERT\nJDFJDSFJS\nASFRETERT\n</pre>\n\n<p>TO</p>\n\n<pre>\nASFRETERT_a\nJDFJDSFJS\nASFRETERT_b\n</pre>\n"},{"tags":["sql","tsql","stored-procedures","syntax-error","dynamic-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":100,"score":0,"question_id":12618771,"title":"dynamic T-SQL in stored procedure: error near keyword FROM. Code in new query run flawlessly","body":"<p>I'm using SQL Server 2008 R2 (T-SQL) and have dynamic SQL code, which inserting into temporary table some data.\nIf I run code in new query window or PRINT code and then run in new query window everything is allright, BUT if I try to run this from stored procedure it throw error </p>\n\n<pre><code>Msg 156, Level 15, State 1, Procedure users, Line 3\nIncorrect syntax near the keyword 'FROM'.\n</code></pre>\n\n<p>If I remove line with <code>INSERT INTO #viewsTmp (webId, listId, viewName, viewTitle)</code>, code runs fine.\nI have similar code above within same stored procedure and that code is fine.</p>\n\n<p>Temp table:\n</p>\n\n<pre><code>CREATE TABLE #viewsTmp \n(\n    webId uniqueidentifier,\n    listId uniqueidentifier,\n    viewName NVARCHAR(128),\n    viewTitle NVARCHAR(255)\n)\n</code></pre>\n\n<p>variable @databaseName is declared as parameter of stored procedure\n</p>\n\n<pre><code>@databaseName NVARCHAR(255)\n</code></pre>\n\n<p>Code which is OK in new query window, but not ok if is runned from stored procedure:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SET @sql = N'\nINSERT INTO #viewsTmp (webId, listId, viewName, viewTitle)\nSELECT c.tp_WebId, c.tp_ID, b.LeafName, c.tp_Title\nFROM (\n    SELECT *\n    FROM (\n        SELECT [ListId], [LeafName], [Type], [WebId]\n              ,ROW_NUMBER() OVER (PARTITION BY ListId ORDER BY DirName) AS RowNumber\n          FROM ['+@databaseName+'].[dbo].[Docs]\n          WHERE [LeafName] = ''users''\n    ) AS a\n    WHERE  [RowNumber] = 1 AND [Type] = 1\n) AS b\nINNER JOIN \n    (SELECT [tp_WebId], [tp_ID], [tp_Title] FROM ['+@databaseName+'].[dbo].[Lists]) \n    AS c \n    ON b.ListId = c.tp_ID AND b.WebId = c.tp_WebId\n\n';\n--PRINT @sql\nexec sp_executesql @sql;\n</code></pre>\n\n<p>What is wrong with this code?</p>\n"},{"tags":["sql-server","linq","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":75,"score":0,"question_id":11590737,"title":"A SELECT Statement from Self-Referential Many-To-Many Relationships","body":"<p>Table Definition  </p>\n\n<pre><code>Table1: ID [PK], Name\nTable2: FID1 [FK], FID2 [FK]\n(Many to One): ID 8=&gt; FID1, ID 8=&gt; FID2\n</code></pre>\n\n<p>Sample Data</p>\n\n<pre><code>Table1: [1,A],[2,B],[3,C],[4,D],[5,E],[6,F]\nTable2: [1,2],[1,3],[2,4],[2,5],[3,4],[3,6],[5,6]\n</code></pre>\n\n<p>TREE VIEW OF DATA:</p>\n\n<pre><code>[1=&gt;2, 1=&gt;2=&gt;4, 1=&gt;2=&gt;5], [1=&gt;3, 1=&gt;3=&gt;4, 1=&gt;3=&gt;6], [5=&gt;6]\n</code></pre>\n\n<p>My Question are...</p>\n\n<p>What is the best TSQL select statement which the result set become 4,5,6?</p>\n\n<p>What is the best LINQ select statement which the result set become 4,5,6?</p>\n"},{"tags":["tsql","sql-server-2005","select","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":94,"score":2,"question_id":12637774,"title":"T-SQL Parse text in select statement","body":"<p>I am currently working on a project to import data from one table to another. I am trying to parse a field that contains a FULLNAME into its parts LAST,FIRST,MI. The names are all in the format of \"LAST,FIRST MI\" I have written a stored procedure that correctly parses and returns the results as neccessary but I am unsure as to how to encorporate the stored procedure into a single select statement. For instance, current I have:</p>\n\n<pre><code>SELECT FULLNAME From UserInfo\n</code></pre>\n\n<p>and what I would like to have is something like this:</p>\n\n<pre><code>SELECT Last, First, MI from UserInfo\n</code></pre>\n\n<p>Currently my stored procedure takes the form of ParseName(FULLNAME, Last as OUTPUT, First as OUTPUT, MI as OUTPUT). How can I call this procedure and have the output variables split into 3 different columns?</p>\n"},{"tags":["asp.net","query","tsql","reporting-services"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12652186,"title":"Count the first row data in SSRS / SQL Query","body":"<p>In my SSRS report, there is a matrix showing following data... Every single of data in the matrix is dynamic.</p>\n\n<pre><code>Departure    Arravial     Bus name        Tour\n01:51        02:01        07 ABY 04\n02:02        02:12        07 AB 978\n02:21        02:31        07 ABY 04\n02:32        02:42        07 AB 978\n03:01        03:11        07 ABY 04\n03:02        03:12        07 AB 978\n03:31        03:41        07 ABY 04\n03:42        03:52        07 AB 978\n04:01        04:11        07 ABY 04\n</code></pre>\n\n<p>What I want to do is count the first row bus name and put it next to it. Can this be achievable with expressions? or how can I come up with such query in SQL? How can I solve this puzzle?</p>\n\n<pre><code>Departure    Arravial     Bus name        Tour\n01:51        02:01        07 ABY 04       1\n02:02        02:12        07 AB 978       \n02:21        02:31        07 ABY 04       2\n02:32        02:42        07 AB 978       \n03:01        03:11        07 ABY 04       3\n03:02        03:12        07 AB 978       \n03:31        03:41        07 ABY 04       4\n03:42        03:52        07 AB 978       \n04:01        04:11        07 ABY 04       5\n</code></pre>\n\n<p>This is my query by the way,</p>\n\n<pre><code>SELECT HCPD.DepartureTime, HCPD.ArrivalTime, V.BusName\nFROM HAT_CALISMA_PLANI HCP WITH(NOLOCK)\nINNER JOIN HAT_CALISMA_PLANI_DETAY HCPD WITH(NOLOCK) ON HCPD.HatCalismaPlaniKey = HCP.HatCalismaPlaniKey\nINNER JOIN VALIDATOR V WITH(NOLOCK) ON V.ValidatorKey = HCPD.ValidatorKey\nWHERE HCPD.DepartureTime = @Time AND HCP.HatKey = @HatKey\nORDER BY HCPD.DepartureTime\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","pagination"],"answer_count":3,"favorite_count":5,"up_vote_count":5,"down_vote_count":0,"view_count":1009,"score":5,"question_id":3747186,"title":"Best paging solution using SQL Server 2005?","body":"<p>What is the most efficient paging solution using SQL Server 2005 against a table with around 5,000-10,000 rows? I've seen several out there but nothing comparing them.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":2,"up_vote_count":10,"down_vote_count":0,"view_count":2575,"score":10,"question_id":7611394,"title":"Maximum size of a varchar(max) variable","body":"<p>At any time in the past, if someone had asked me the maximum size for a <code>varchar(max)</code>, I'd have said 2GB, or looked up a more exact <a href=\"http://msdn.microsoft.com/en-us/library/ms176089.aspx\" rel=\"nofollow\">figure</a> (2^31-1, or 2147483647).</p>\n\n<p>However, in some recent testing, I discovered that <code>varchar(max)</code> variables can apparently exceed this size:</p>\n\n<pre><code>create table T (\n    Val1 varchar(max) not null\n)\ngo\ndeclare @KMsg varchar(max) = REPLICATE('a',1024);\ndeclare @MMsg varchar(max) = REPLICATE(@KMsg,1024);\ndeclare @GMsg varchar(max) = REPLICATE(@MMsg,1024);\ndeclare @GGMMsg varchar(max) = @GMsg + @GMsg + @MMsg;\nselect LEN(@GGMMsg)\ninsert into T(Val1) select @GGMMsg\nselect LEN(Val1) from T\n</code></pre>\n\n<p>Results:</p>\n\n<pre><code>(no column name)\n2148532224\n(1 row(s) affected)\nMsg 7119, Level 16, State 1, Line 6\nAttempting to grow LOB beyond maximum allowed size of 2147483647 bytes.\nThe statement has been terminated.\n\n(no column name)\n(0 row(s) affected)\n</code></pre>\n\n<p>So, given that I now know that a <em>variable</em> can exceed the 2GB barrier - does anyone know what the actual limit is for a <code>varchar(max)</code> variable?</p>\n\n<hr>\n\n<p>(Above test completed on SQL Server 2008 (not R2). I'd be interested to know whether it applies to other versions)</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12650944,"title":"How to insert value from stored procedure to variable in function in SQL Server","body":"<p>I have a stored procedure which returns a value (ex: <code>GetData</code>)</p>\n\n<p>How can I declare a variable in another function to get this value?</p>\n\n<p>Something like this</p>\n\n<pre><code>Create Function Test\nReturn Int\nBegin\n    Declare @data My_Data_Type\n    Declare @count int\n    SET @data = exec GetData\n    Select @count = count(*)\n    From @data\n\n    Return @count\nEnd\n</code></pre>\n\n<p>Please help me !!!!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12093095,"title":"SQL Server Collation conflict - creating a view","body":"<p>i am trying to create a View in a Database A, that is filled by a select from the Database B and i am having a collation conflict, to be more exactly , its between ( Latin1_General_CI_AS\" and \"Latin1_General_BIN ). WHere(in the code) i need to put the collate?</p>\n\n<p>Best Regards.</p>\n\n<p>The code is here:</p>\n\n<pre><code>CREATE VIEW [dbo].[CML_SDG_MENSAL_ESTOQUE]\nAS\n\nselect  \nSUM(dw_fato_faturmes.val_fatur) val_fatur, \nSUM(dw_fato_faturmes.val_receita) val_receita, \nSUM(dw_fato_faturmes.qtd_bonif_item) qtd_bonif_item, \nSUM(dw_fato_faturmes.val_bonif_fatur) val_bonif_fatur,\nSUM(dw_fato_faturmes.val_bonif_receita) val_bonif_receita,\nSUM(dw_fato_faturmes.val_devol_fatur) val_devol_fatur,\nSUM(dw_fato_faturmes.val_devol_receita) val_devol_receita,\nDW_DIM_PRODUTO.B1_CODDB B1_CODDB,\ndw_fato_faturmes.cod_produto cod_produto, \nSUM(dw_fato_faturmes.qtd_estoque) qtd_estoque, \nSUM(dw_fato_faturmes.qtd_devol) qtd_devol, \nSUM(dw_fato_faturmes.qtd_item) qtd_item, \nSUM(dw_fato_faturmes.qtd_meta) qtd_meta,\nSUM(dw_fato_faturmes.qtd_pedido) qtd_pedido,\nSUM(dw_fato_faturmes.qtd_item)+\n    SUM(dw_fato_faturmes.qtd_bonif_item)+\n    SUM(dw_fato_faturmes.qtd_devol) venda_liquida\n(SUM(dw_fato_faturmes.qtd_item)\n     +SUM(dw_fato_faturmes.qtd_bonif_item)\n    +SUM(dw_fato_faturmes.qtd_devol))\n    +SUM(dw_fato_faturmes.qtd_pedido) venda___pedido\nFROM \nlogixbi.dbo.dw_fato_faturmes dw_fato_faturmes, \nlogixbi.dbo.DW_DIM_CLIENTE DW_DIM_CLIENTE, \nDW_DIM_EMPRESA DW_DIM_EMPRESA, \nlogixbi.dbo.DW_DIM_MARCA DW_DIM_MARCA, \nlogixbi.dbo.DW_DIM_PRODUTO DW_DIM_PRODUTO, \nlogixbi.dbo.DW_DIM_REPRESENTANTE DW_DIM_REPRESENTANTE\n\nwhere \nDW_DIM_EMPRESA.SM0_FILIAL=dw_fato_faturmes.filial and\nDW_DIM_MARCA.BM_GRUPO=dw_fato_faturmes.grupo and\nDW_DIM_PRODUTO.B1_COD=dw_fato_faturmes.cod_produto and\nDW_DIM_REPRESENTANTE.A3_COD=dw_fato_faturmes.vendedor and\nDW_DIM_CLIENTE.A1_COD=dw_fato_faturmes.cliente and\nDW_DIM_CLIENTE.A1_LOJA=dw_fato_faturmes.loja\n\ngroup by DW_DIM_PRODUTO.B1_CODDB,dw_fato_faturmes.cod_produto\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":1177,"score":1,"question_id":8061713,"title":"Cannot resolve the collation conflict between \"SQL_Latin1_General_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the equal to operation","body":"<p>Need help here. I have 2 questions based on this query.</p>\n\n<pre><code>SELECT cdd.FieldID,cdd.PlanTypeID,pt.IsFinancial            \nFROM ClientDataDictionary cdd\n    INNER JOIN #tblPlanTypes pt ON cdd.PlanTypeID = pt.PlanTypeID\n    INNER JOIN ClientDataDictionaryFieldType cddftype\n    ON cdd.FieldId = cddftype.FieldID AND cdd.PlanTypeId = cddftype.PlanTypeID\n    WHERE cdd.ClientId = @ClientID AND cdd.IsHidden = 0\n    AND cddftype.FieldTypeID = 4 \n    AND cddftype.FieldID = cddftype.ParentFieldIDSectionTitle \n    AND  (SELECT COUNT(cddftype2.FieldID)\n              FROM ClientDataDictionaryFieldType  cddftype2\n              Where cddftype2.ParentFieldIDSectionTitle = cdd.FieldID\n              AND cddftype2.PlanTypeID = cdd.PlanTypeID\n              AND EXISTS(Select tbl.FieldID From #tblSelectedFields tbl\n                          Where tbl.FieldID = cddftype2.FieldID AND tbl.PlantypeID =cdd.PlanTypeID COLLATE SQL_Latin1_General_CP1_CI_AS)\n              ) != 0 COLLATE SQL_Latin1_General_CP1_CI_AS\n</code></pre>\n\n<ol>\n<li>Where do I place my <code>COLLATE</code> keyword in this query? I know that temp tables have different collate \"type\".</li>\n<li>I tried using <code>COLLATE DATABASE_DEFAULT</code> however, the error still occurs. Will this resolve the issue?</li>\n</ol>\n\n<p>Please help me here. Thanks!</p>\n\n<p>[UPDATE 1]\n<code>ClientID</code> is set to <code>UNIQUEIDENTIFIER</code> data type.</p>\n\n<p>[UPDATE 2]\nhere are the table definitions</p>\n\n<p><code>#tblPlanTypes</code></p>\n\n<pre><code>PlanTypeId nvarchar(50),  \nPlanType nvarchar(max),  \nPrefix NVARCHAR(10),  \nIsFinancial BIT,  \nTotalCount BIGINT,  \nPlanCount BIGINT  \n</code></pre>\n\n<p><code>ClientDataDictonary</code></p>\n\n<pre><code>[ClientDataDictionaryId] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT      [DF_ClientDataDictionary_ClientDataDictionaryId] DEFAULT (newid()),\n[ClientId] [uniqueidentifier] NOT NULL,\n[PlanTypeId] [uniqueidentifier] NULL,\n[FieldId] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,\n[FieldText] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[FieldType] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[DefaultValue] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[HelpText] [nvarchar] (512) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[IsHidden] [bit] NULL CONSTRAINT [DF_ClientDataDictionary_IsHidden] DEFAULT ((0)),\n[IsSummable] [bit] NULL,\n[IsRequired] [bit] NULL,\n[IsContractRenewal] [bit] NULL,\n[HasAlert] [bit] NULL CONSTRAINT [DF_ClientDataDictionary_HasAlert] DEFAULT ((0)),\n[AlertMessage] [nvarchar] (512) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[CentralLanguageId] [uniqueidentifier] NOT NULL,\n[LookupTypeName] [varchar] (500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[RowVersion] [timestamp] NULL,\n[LastUpdated] [datetime] NULL CONSTRAINT [DF_ClientDataDictionary_LastUpdated] DEFAULT (getutcdate()),\n[Sequence] [int] NULL\n</code></pre>\n\n<p><code>ClientDataDictionaryFieldType</code></p>\n\n<pre><code>[ClientDataDictionaryFieldTypeID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ClientDataDictionaryFieldType_ClientDataDictionaryFieldType] DEFAULT (newid()),\n[PlanTypeID] [uniqueidentifier] NULL,\n[FieldID] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,\n[FieldTypeID] [int] NULL,\n[ParentFieldIDSectionTitle] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL\n</code></pre>\n\n<p><code>#tblSelectedFields</code></p>\n\n<pre><code>FieldID nvarchar(255),  \nPlanTypeID UniqueIdentifier,  \nFieldText nvarchar(MAX),  \nsequence int,  \nFieldType nvarchar(100),  \nIsFinancial bit  \n</code></pre>\n\n<p>[UPDATE 3]</p>\n\n<p>Tried the suggestion by @Mack, but a new error emerged. <code>Expression type uniqueidentifier is invalid for COLLATE clause.</code> This is caused by the @ClientID having a data type of uniqueidentifier. Any suggestions?</p>\n"},{"tags":["sql-server","tsql","collation"],"answer_count":4,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":7035,"score":4,"question_id":2048187,"title":"Cannot resolve the collation conflict between \"SQL_Latin1_General_Pref_CP1_CI_AS\" and \"Latin1_General_CI_AS\" in the equal to operation","body":"<p>I have the following query:</p>\n\n<pre><code>SELECT \nDISTINCT(po.SONumber) AS [Sales Order No_],\n po.PONumber AS PoNo, ph.[Buy-from Vendor No_] AS VendorNo, \n ph.[Pay-to Name], ph.[Document Date], 'Ship-to Name' = \n CASE WHEN sh.[Ship-to Name] &gt; '' THEN sh.[Ship-to Name] ELSE sih.[Ship-to Name] END, \n 'Ship-to Post Code' = CASE WHEN sh.[Ship-to Post Code] &gt; '' THEN sh.[Ship-to Post Code] ELSE sih.[Ship-to Post Code] END, \n sh.DeliveryPhoneNo AS [Delivery Phone No], 'CustomerPriceGroup' = CASE WHEN sh.[Customer Price Group] &gt; '' THEN sh.[Customer Price Group] ELSE sih.[Customer Price Group] END, \n 'DeliveryComment' = CASE WHEN sh.[Delivery Comment] &gt; '' THEN sh.[Delivery Comment] ELSE sih.[Delivery Comment] END, \n 'GiftMessage' = CASE WHEN sh.[GiftMessage] &gt; '' THEN sh.[GiftMessage] ELSE sih.[GiftMessage] END, \n si.Shipped, si.ShippedDate, si.CourierID \n\n FROM \n NavisionMeta.dbo.PoToSo po, \n [Crocus Live$Purchase Header] ph, \n [Crocus Live$Purchase Line] pl, \n [Crocus Live$Sales Header] sh, \n [Crocus Live$Sales Invoice Header] sih, \n NavisionMeta.dbo.SupplierInput si \n\n WHERE po.PONumber = ph.[No_] AND \n ph.[No_] = pl.[Document No_] AND \n po.SONumber *= sh.No_ AND \n po.SONumber *= sih.[Order No_] AND \n po.PONumber *= si.PONo AND \n ph.[Document Date] BETWEEN '01-01-10' AND '31-01-10' \n\n ORDER BY po.PONumber DESC\n</code></pre>\n\n<p>When it executes, I get the following error:</p>\n\n<blockquote>\n  <p>Cannot resolve the collation conflict\n  between\n  \"SQL_Latin1_General_Pref_CP1_CI_AS\"\n  and \"Latin1_General_CI_AS\" in the\n  equal to operation.</p>\n</blockquote>\n\n<p>The collation of the NavisionMeta database is SQL_Latin1_General_Pref_CP1_CI_AS</p>\n\n<p>What can I do to fix this??</p>\n"},{"tags":["sql-server-2008","tsql","function","reporting-services"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":80,"score":2,"question_id":12639163,"title":"Cannot resolve the collation conflict","body":"<p>I am getting the following error message.</p>\n\n<blockquote>\n  <p>Cannot resolve the collation conflict between \"Latin1_General_CI_AI\" and \"SQL_Latin1_General_CP1_CI_AS\" in the equal to operation.</p>\n</blockquote>\n\n<p>I only get it when I place this code below in my WHERE clause.</p>\n\n<pre><code>WHERE Region IN (SELECT Token FROM dbo.getParmsFromString(@Region))\n</code></pre>\n\n<p>Now @Region contains all the values from my multi-select fields from SSRS.</p>\n\n<p>Below is the code for the function that is used.</p>\n\n<pre><code>CREATE FUNCTION [dbo].[getParmsFromString]\n    (@String VARCHAR(MAX))\nRETURNS @Parms TABLE\n(\n    Token VARCHAR(MAX)\n)\nAS\nBEGIN\n    IF CHARINDEX(',', @String) != 0\n    BEGIN\n        ;WITH cte0(Token, List) AS\n              (\n                SELECT   SUBSTRING(@String, 1, CHARINDEX(',',@String,1) - 1)\n                        ,SUBSTRING(@String,CHARINDEX(',',@String,1) + 1, LEN(@String)) + ','\n\n                UNION ALL\n\n                SELECT     SUBSTRING(List,1,ISNULL(CHARINDEX(',',List,1) - 1,1))\n                        ,SUBSTRING(List,CHARINDEX(',',List,1) + 1, LEN(List))\n                FROM cte0\n                WHERE LEN(cte0.List) &gt; 0\n              )\n\n            INSERT INTO @Parms (Token)\n            SELECT Token\n            FROM cte0\n            OPTION (MAXRECURSION 0)\n        RETURN;\n    END\n\n    ELSE\n        INSERT INTO @Parms\n            SELECT @String\n        RETURN;\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","join"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":67,"score":1,"question_id":12631012,"title":"SQL Join with table including from/to values","body":"<p>I'm working with a 3rd-party SQL Server database, containing the two tables below (simplified), which I'd like to join into a single view.</p>\n\n<p>The <strong>Document</strong> table contains the following columns:\n<strong>ID</strong> primary key<br>\n\"other columns\".</p>\n\n<p>The <strong>DocumentTag</strong> table contains the following columns: \n<strong>FromDocumentID</strong> \n<strong>ToDocumentID</strong> \n<strong>Tag</strong>.</p>\n\n<p>How do I create a view of the form <strong>Document.ID</strong>, <strong>Tag</strong>, \"other columns\"?<br>\nJoin each document its tag (yes, with repetitions) instead of looking for the right ID range in the <strong>Document Tag</strong> table.</p>\n\n<p>[EDIT] an example:</p>\n\n<p>Document table</p>\n\n<pre><code>ID    | Description | Owner ....\n------+-------------+---------\n1     | blah        | me \n2     | blah 2      | me\n3     | blah 3      | Alice\n4     | blah 4      | Bob\n5     | blah blah   | me \n6     | blah blah 2 | Bob\n7     | blah blah 3 | Alice\n8     | blah blah 4 | Alice\n</code></pre>\n\n<p>Document Tag table</p>\n\n<pre><code>FromDocumentID | ToDocumentID | Tag         | ...\n---------------+--------------+-------------+----\n1              | 3            | Bananas\n4              | 4            | Crocodiles\n5              | 5            | Bananas\n6              | 8            | Donuts\n</code></pre>\n\n<p>What I would like to have is </p>\n\n<pre><code>ID    | Description | Owner  | Tag      | ....\n------+-------------+--------+----------+-----\n1     | blah        | me     | Bananas\n2     | blah 2      | me     | Bananas\n3     | blah 3      | Alice  | Bananas\n4     | blah 4      | Bob    | Crocodiles\n5     | blah blah   | me     | Bananas\n6     | blah blah 2 | Bob    | Donuts\n7     | blah blah 3 | Alice  | Donuts\n8     | blah blah 4 | Alice  | Donuts\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005","boolean"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12646063,"title":"boolean expression with min/max in nullif possible?","body":"<p>is it possible to put a boolean expression with max or min into a nullif() statemtent?</p>\n\n<p>for example</p>\n\n<pre><code>select \n    min(a) as b ---grabbing first value\n    ,max(a) as  c --- grabbing last value but could be same as min value, this is the problem\n    ,nullif(min(a), (min(a) = max(a))) ---my idea for a solution that didnt work\n   from table\n</code></pre>\n\n<p>trying to weed out duplicate rows when a field has a value that only happens 1 time.  I am thinking there may be a way to do this with counting and then weeding out all values with a value over 1 but am not sure how to accomplish that. working on sql server 2005, need this in t-sql if possible, anything that will work on the server is ok though. </p>\n\n<p>edit to provide more info: \ni am looking at a status history for orders in an order management system that tags each time a correction is requested with an id.  the id's are unique and numerical. in this format 1234  each orderid is unique and numerical as well in this format 1111111.2. a represents the unique correction id.  I want to look at the order, and if one correction id has already happened to grab the next one ideally, and the next after that and so on if possible. At very minimum i would want the MAX value and MIN value. i cannot just do two columns because that would count the min value twice (using my example) and will not give me accurate data</p>\n\n<p>was trying to be simple with my example but its not providing enough info, here is more:</p>\n\n<pre><code>SELECT Cast(oi.orderid AS VARCHAR(MAX)) + '.' \n                 + Cast(oi.orderitemid AS VARCHAR(MAX)) AS OrderNumber,\n       Min(oici.orderitemcorrectionid)                  AS a,\n       Max(oici.orderitemcorrectionid)                  AS b\nFROM   Orderitems oi\n       LEFT JOIN orderitemcorrections oic\n         ON oic.orderid = oi.orderid\n            AND oic.orderitemid = oi.orderitemid\n       LEFT JOIN orderitemcorrectionissues oici\n         ON oici.orderitemcorrectionid = oic.orderitemcorrectionid\n       LEFT JOIN correctiontypes ct\n         ON ct.correctiontypeid = oici.correctiontypeid\nGROUP  BY Cast(oi.orderid AS VARCHAR(MAX)) + '.' \n                   + Cast(oi.orderitemid AS VARCHAR(MAX)) \n</code></pre>\n\n<p>sample table data of above query:</p>\n\n<pre><code>OrderNumber a   b\n1098048.1   1   2\n1098210.1   160 160\n1098222.1   78  78\n1098300.1   31  31\n1098408.1   4   4\n1098462.1   224 224\n1098468.1   602 602\n1098492.2   1457 1457\n</code></pre>\n\n<p>above is data where a and b are the same\nbelow is where they are different but i want to null any duplicates from a to b</p>\n\n<pre><code>1100268.1   181 191\n1100256.1   306 379\n</code></pre>\n\n<p>more data, not grouped to show duplicates for rows. -- sample raw data</p>\n\n<pre><code>OrderNumber orderitemcorrectionid\n1098048.1   1\n1098048.1   2\n1098210.1   160\n1098210.1   160\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12645840,"title":"TSQL Self Join: Exclude consecutive ID records having set criteria","body":"<p>I have a table as below:</p>\n\n<pre><code>ID, DATE, STATUS\n1, 01JAN2012, STOP\n1, 04JAN2012, RESTART\n2, 01JAN2012, STOP-1\n3, 10JAN2012, STOP\n4, 15JAN2012, RESTART\n5, 01JAN2012, STOP-1\n5, 04JAN2012, STOP-2\n5, 10JAN2012, STOP\n5, 15JAN2012, RESTART\n</code></pre>\n\n<p>Expected Output:</p>\n\n<pre><code>ID, DATE, STATUS\n2, 01JAN2012, STOP-1\n3, 10JAN2012, STOP\n4, 15JAN2012, RESTART\n5, 01JAN2012, STOP-1\n5, 04JAN2012, STOP-2\n</code></pre>\n\n<p>I want a SELECT statement to exclude all records with same ID having (STATUS='RESTART') and one consecutive previous record, if available. </p>\n"},{"tags":["sql-server","tsql","cursor"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":1,"view_count":68,"score":-1,"question_id":12646027,"title":"better than a cursor tsql","body":"<p>The question here is simple (although I am prepared for the answer not to be), how can I make this query more efficient.</p>\n\n<p>In a nutshell it copies records.  It selects X records, then using those records data duplicates them capturing the new identifier.  Using the id of the original record and new record, it then inserts by copying data of the original data for another table using the new identifier.</p>\n\n<p>This takes a long time. Can you help shorten it?</p>\n\n<pre><code>DECLARE DaysToDuplicateCursor CURSOR FAST_FORWARD FOR \nSELECT \n    DayId \nFROM [Days] \nWHERE AgentId IN ('XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX') \nAND PersonAgentId IN (\n     'YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY'\n    ,'WWWWWWWW-WWWW-WWWW-WWWW-WWWWWWWWWWWW'\n    ,'ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ'\n    ,'TTTTTTTT-TTTT-TTTT-TTTT-TTTTTTTTTTTT'\n)\n\nDECLARE @Id INT\n\nOPEN DaysToDuplicateCursor\n    FETCH NEXT FROM DaysToDuplicateCursor INTO @Id\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        --\n        -- Insert Days data.\n        --\n        INSERT INTO [Days] (\n               [DayTemplateId]\n              ,[DayDate]\n        )\n        SELECT [DayTemplateId]\n              ,DATEADD(YEAR,-1,[DayDate]) AS [DayDate]\n          FROM [Days] WHERE [DayId] = @Id\n        --\n        -- Insert Periods data.\n        --\n        INSERT INTO [Periods] (\n           [DayId]\n          ,[PeriodTemplateId]\n        )\n        SELECT \n           SCOPE_IDENTITY()\n          ,[PeriodTemplateId]\n        FROM [Periods] WHERE [DayId] = @Id\n        --\n    END\nCLOSE DaysToDuplicateCursor\nDEALLOCATE DaysToDuplicateCursor\n</code></pre>\n"},{"tags":["database","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12644506,"title":"How to select entries that are back to back?","body":"<p>How would I select <code>c_user_id</code> who have made back to back entries in a SQL Server 2008 database ?  </p>\n\n<p>Preferably people who have made more than 3 back to back entries like <code>pras.chla@gmail.com</code> below (sorting by <code>c_id desc</code> and <code>c_id</code> is an identity column)</p>\n\n<pre><code>c_id    c_user_id             c_entry\n1427    xermadr.asdf@me.com   155575\n1426    pras.chla@gmail.com   155829\n1425    pras.chla@gmail.com   155826\n1424    pras.chla@gmail.com   155828\n1423    pras.chla@gmail.com   155830\n1422    sdfe.qqol@gmail.com   155559 \n</code></pre>\n\n<p>thanks again ?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":40,"score":1,"question_id":12644414,"title":"@@ERROR - How to process / evaluate in TSQL?","body":"<p>This update will fail as ID is Identity </p>\n\n<p>But I am getting direct error message.<br>\nI am getting none of the PRINT statements.</p>\n\n<p>How do I use @@ERROR?<br>\nUsing SSMS.<br>\nWould you call this a script or a query?  </p>\n\n<pre><code>PRINT   'start';\nDECLARE @ErrorVal INT;\nUPDATE IndenText SET ID = 7;\nSELECT @ErrorVal = @@ERROR;\nPRINT @ErrorVal;\nIF @ErrorVal &lt;&gt; 0\nBEGIN\n    PRINT N'A error caught.';\nEND\nPRINT 'done';\n</code></pre>\n\n<p>This also does not work from me</p>\n\n<pre><code>PRINT   'start';\nDECLARE @ErrorVal INT;\nBEGIN TRY\n    UPDATE IndenText SET ID = 7;\n    SELECT @ErrorVal = @@ERROR;\n    PRINT @ErrorVal;\nEND TRY\nBEGIN CATCH\n    IF @@ERROR &lt;&gt; 0\n    BEGIN\n        PRINT N'A error caught.' + @@ERROR;\n    END\nEND CATCH\nPRINT 'done';\n</code></pre>\n\n<p>I get<br>\nMsg 8102, Level 16, State 1, Line 4 \nCannot update identity column 'ID'. </p>\n\n<p>As Martin stated it was a compile error.<br>\nCreated a constraint that would not be a compile error.<br>\nAnd got the @@ERROR to process.</p>\n\n<pre><code>PRINT   'start';\nDECLARE @ErrorVal INT;\nDECLARE @newVal INT;\nselect  @newVal = -1;\nBEGIN TRY\n    update Twaste1 set ID = @newVal ;\n    PRINT 'End Try';\nEND TRY\nBEGIN CATCH\n    Select @ErrorVal = @@ERROR;\n    PRINT 'Begin Catch';\n    IF @ErrorVal &lt;&gt; 0\n    BEGIN\n        PRINT CAST(@ErrorVal as varchar(30));\n        PRINT N'A error caught.';\n    END\nEND CATCH\nPRINT 'done'\n</code></pre>\n\n<p>;</p>\n"},{"tags":["tsql","triggers"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":63,"score":1,"question_id":12643216,"title":"T-SQL: Conversion failed when converting date and/or time from character string","body":"<p>Below is a trigger used to capture updates/inserts on an SQL table. I cannot figure out why, but whenever an update is done, I get the error message Conversion failed when converting date and/or time from character string. Here is the structure of the Transaction Log table: </p>\n\n<pre><code>CREATE TABLE [dbo].[TransactionLog](\n    [Id] [int] IDENTITY(1,1) NOT NULL,\n    [TransactionDate] [datetime] NOT NULL,\n    [Operator] [varchar](35) NOT NULL,\n    [TableName] [varchar](50) NOT NULL,\n    [Action] [char](1) NOT NULL,\n    [TableString] [nvarchar](255) NOT NULL,\n    [UserId] [char](6) NULL,\n CONSTRAINT [PK_TransactionLog] PRIMARY KEY CLUSTERED \n(\n    [Id] ASC\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n\n<p>Here is the table being updated: </p>\n\n<pre><code>CREATE TABLE [dbo].[AgentContEd](\n    [Id] [int] IDENTITY(1,1) NOT NULL,\n    [sNumber] [int] NOT NULL,\n    [StateCode] [char](3) NOT NULL,\n    [CourseCode] [char](6) NOT NULL,\n    [DateTaken] [date] NOT NULL,\n    [ExpirationDate] [date] NULL,\n    [CourseHours] [smallint] NOT NULL,\n    [Method] [varchar](15) NULL,\n    [LastChangeOperator] [char](8) NOT NULL,\n    [LastChangeDate] [datetime] NOT NULL,\n    [ControlId] [int] NULL,\n CONSTRAINT [PK_AgentContEd] PRIMARY KEY CLUSTERED \n(\n    [Id] ASC\n)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n\n<p>And here is the trigger that's causing the headache...</p>\n\n<pre><code>BEGIN\n    INSERT INTO dbo.TransactionLog \n    (\n        TransactionDate, \n        Operator, \n        TableName, \n        Action, \n        TableString, \n        UserId\n    )\n    SELECT \n        LastChangeDate,\n        'Op',\n        @tableName,\n        @action,\n        CAST(\n          'ID:'             + CAST(ISNULL(Id,             'NULL') as char(4))\n        + ' SymNum:'        + CAST(ISNULL(sNumber,  'NULL') as char(10))\n        + ' StateCode:'     + ISNULL(StateCode,           'NULL')\n        + ' DateTaken:'     + CAST(ISNULL(DateTaken,      'NULL') as nvarchar(9))\n        + ' ExpDate:'       + CAST(ISNULL(ExpirationDate, 'NULL') as nvarchar(9))\n        + ' CourseCode:'    + ISNULL(CourseCode,          'NULL')\n        + ' Hours:'         + CAST(ISNULL(CourseHours,    'NULL')  as char(3))\n        + ' Mthd:'          + ISNULL(Method,              'NULL')\n        As char(255)), \n        LastChangeOperator\n    FROM inserted\nEND\n</code></pre>\n"},{"tags":["sql-server","tsql","powershell","cmd","sqlcmd"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":187,"score":0,"question_id":12604902,"title":"How to convert this sqlcmd script to an Invoke-Sqlcmd script?","body":"<p>I have a SQL script designed to be executed by <a href=\"http://msdn.microsoft.com/en-us/library/ms162773.aspx\" rel=\"nofollow\">sqlcmd</a>, and a Command script that executes sqlcmd with the correct parameters.</p>\n\n<p>I want to convert the Command script to a PowerShell script that uses <a href=\"http://technet.microsoft.com/en-us/library/cc281720.aspx\" rel=\"nofollow\">Invoke-Sqlcmd</a> instead of sqlcmd.</p>\n\n<p>The SQL script, the Command script, and the new PowerShell script all live in the directory <code>C:\\Users\\iain.CORP\\SqlcmdQuestion</code>.</p>\n\n<h3>SQL Script</h3>\n\n<p>The SQL script is called <code>ExampleQuery.sql</code>. It selects a string literal. The value of the string literal is set by sqlcmd at runtime to the value of the <code>ComputerName</code> sqlcmd scripting variable. The code looks like this:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT '$(ComputerName)';\n</code></pre>\n\n<h3>Command Script</h3>\n\n<p>The command script is called <code>ExecQuery.cmd</code>. It calls sqlcmd to execute <code>ExampleQuery.sql</code> and sets the value of the scripting variable <code>ComputerName</code> to the value of the environment variable <code>COMPUTERNAME</code>. The code looks like this:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>sqlcmd -i ExampleQuery.sql -v ComputerName = %COMPUTERNAME%\n</code></pre>\n\n<p>When I open a command prompt, the default working directory is <code>C:\\Users\\iain.CORP</code>. I change the to the directory containing the files, and run the Command script:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>cd C:\\Users\\iain.CORP\\SqlcmdQuestion\nExecQuery.cmd\n</code></pre>\n\n<p>I see this output:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>---------\nSKYPC0083\n\n(1 rows affected)\n</code></pre>\n\n<p>The script successfully selects a string literal set by sqlcmd.</p>\n\n<h3>PowerShell Script</h3>\n\n<p>The PowerShell script is called ExecQuery.ps1. It is supposed to do the same as the command script, using Invoke-Sqlcmd instead of sqlcmd. The code looks like this:</p>\n\n<pre class=\"lang-powershell prettyprint-override\"><code>Add-PSSnapin SqlServerCmdletSnapin100\nAdd-PSSnapin SqlServerProviderSnapin100\n\nInvoke-Sqlcmd -InputFile 'ExampleQuery.sql' -Variable \"ComputerName = $Env:COMPUTERNAME\"\n</code></pre>\n\n<p>When I open a PowerShell prompt, the default working directory is <code>Z:\\</code>.  I change to the directory containing the files, and run the PowerShell script:</p>\n\n<pre class=\"lang-powershell prettyprint-override\"><code>cd C:\\Users\\iain.CORP\\SqlcmdQuestion\n.\\ExecQuery.ps1\n</code></pre>\n\n<p>I see this output:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>Invoke-Sqlcmd : Could not find file 'Z:\\ExampleQuery.sql'.\nAt C:\\Users\\iain.CORP\\SqlcmdQuestion\\ExecQuery.ps1:4 char:14\n+ Invoke-Sqlcmd &lt;&lt;&lt;&lt;  -InputFile 'ExampleQuery.sql' -Variable \"ComputerName = $Env:COMPUTERNAME\"\n    + CategoryInfo          : InvalidResult: (:) [Invoke-Sqlcmd], FileNotFoundException\n    + FullyQualifiedErrorId : ExecutionFailed,Microsoft.SqlServer.Management.PowerShell.GetScriptCommand\n</code></pre>\n\n<p>The PowerShell script raises an error because Invoke-Sqlcmd can't find the the input file in the <code>Z:\\</code> directory, which happens to be the default working directory.</p>\n\n<p>The Command script found the script in the current working directory.</p>\n\n<p>How do I make Invoke-Sqlcmd use the current working directory instead of the default working directory?</p>\n"},{"tags":["tsql","sql-server-2008-r2","ingestion"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":11885037,"title":"Apply diffs between two SQL Server Tables efficiently","body":"<p>I have a once-a-day ingestion case in which I will be getting a large file via FTP which contains the up-to-date versions of 4 database tables.</p>\n\n<p><strong>For each table, I would like to:</strong></p>\n\n<ol>\n<li>Truncate table in staging database</li>\n<li>BCP the FTP'd file into that table</li>\n<li>Find diffs (IUD) between staging table and production table</li>\n<li>Make any required IUDs to production table so it matches staging table</li>\n</ol>\n\n<p>I'm sure this is a reasonably common problem, but I'm not 100% sure as to the best way to approach it.</p>\n\n<p>Are there any built in T-SQL features for this kind of problem, or do I just need to do various joins to find the inserted/updated/deleted records and execute them manually?  I'm sure I can manage to do it this second way, but any suggestions are greatly appreciated none-the-less (not looking for working code).</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":12642223,"title":"sql server batch database alters, batch database changes - best and safest way","body":"<p>We have a small development team of 5 developers working on a large enterprise level web based asp.net/c# system. </p>\n\n<p>We do a lot of database updates which include stored procedure creations and alters as well as new table creation, column creation, record inserts, record updates and so on and so forth.</p>\n\n<p>Today all of the developers place all change scripts in one large sql change script file that gets ran on our Test and Production environments. So this single file contains stored proc alters and record inserts, updates etc etc.  The file can end up being quite lengthy as we may only do a test or production release every 1 to 2 months.</p>\n\n<p>The problem that I am currently facing is this: </p>\n\n<p>Once in a while there is a script error that may occur at any given location in this large \"batch change script\". Perhaps an insert fails or perhaps an alter fails for a proc for instance.</p>\n\n<p>When this occurs, it is very difficult to tell what changes succeeded and what failed on the database.</p>\n\n<p>Sometimes even if one alter fails for instance code will continue to execute throughout the script and sometimes it will stop execution and nothing further gets ran.</p>\n\n<p>So I end up manually checking procs and records today to see what actually worked and what actually did not and this is a bit painstaking.</p>\n\n<p>I was hoping I could roll up this entire change script into one big transaction so that if any problem occurred I could just roll every change back, but that does not appear to be possible with batch scripts like this in sql server.</p>\n\n<p>So, then I tried to backup the databases before I ran the scripts so that if an error occurred I could simply restore  the db, fix the problem and then re-run the fixed script. However in order to restore a database I have to turn off our database mirroring so this is also not totally ideal.</p>\n\n<p>So my question is, what is the safest way to run batch scripts on a production database? </p>\n\n<p>Is there some way that I can wrap the entire script in a transaction that i can roll back that I am not seeing?</p>\n\n<p>Would it possibly be better for us to track and run separate script files so that if 1 file fails we can just shove it off in a failed directory to be looked at and continue running all other files? </p>\n\n<p>Looking for advice and expertise.</p>\n\n<p>thank you for your time.\nMatt</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":152,"score":0,"question_id":12641981,"title":"SQL code to generate next sequence in a alphanumeric string","body":"<p>I have some string values already populated in a nvarchar column. the format of the strings are like this: </p>\n\n<p>For example: 16B, 23G, 128F, 128M etc...</p>\n\n<p>I need to find out the maximum value from these, then generate the next one from code. The logic for picking up the maximum item is like the following:</p>\n\n<ol>\n<li>Pick up the string with the largest number.</li>\n<li>If multiple largest number, then pick up the string the largest alphabet among those.</li>\n</ol>\n\n<p>For example, the largest string from the above series is 128M.</p>\n\n<p>Now I need to generate the next sequence. the next string will have</p>\n\n<ol>\n<li>The same number as the largest one, but alphabet incremented by 1. I.E. 128N</li>\n<li>If the alphabet reaches to Z, then the number gets incremented by 1, and alphabet is A.\nfor example, the next String of 128Z is 129A.</li>\n</ol>\n\n<p>Can anyone let me know what kind of SQL can get me the desired string.</p>\n"},{"tags":["sql-server","tsql","latitude-longitude"],"answer_count":4,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":680,"score":1,"question_id":2298450,"title":"Location Based Search (Lat,Long) TSQL MS Server 2003 R2","body":"<p>Group, </p>\n\n<p>I'm looking for a query that can do a location search in radians with in a binding box. With a table structure like </p>\n\n<p>ProductID,latitude,longitude,timestampGMT.</p>\n\n<p>Any helpful suggestions. </p>\n\n<p>Chad </p>\n"},{"tags":["sql-server-2005","tsql","stored-procedures","full-text-search"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":123,"score":1,"question_id":5605097,"title":"COALESCE together with FTS","body":"<p>I have a form that has a 'brand' dropdown and a 'model' dropdown.I am searching for cars here that has some brand and/or a model.\nNow if I choose \"all\" from the 'brand' dropdown and some 'model' value other then the \"all\" ,I use </p>\n\n<blockquote>\n  <p>COALESCE(@brand,cars.brand)</p>\n</blockquote>\n\n<p>and </p>\n\n<blockquote>\n  <p>COALESCE(@model,cars.model)</p>\n</blockquote>\n\n<p>, it works fine as in returning all the cars if I choose \"all\" for both the dropdown menus and specific results if I choose some value.\nNow I want to use FTS with the <code>CONTAINS</code> keyword and using a query like </p>\n\n<pre><code>CONTAINS(cars.model , 'COALESCE(@model,cars.model)')\n</code></pre>\n\n<p>is returning with an error as </p>\n\n<blockquote>\n  <p>Syntax error near '(' in the full-text search condition 'COALESCE(@model,cars.model)'.</p>\n</blockquote>\n\n<p>I would really appreciate if someone can refer me to a query/sproc that is FTS together with COALESCE .Please help.\nP.S </p>\n\n<pre><code>SET @SQL = '\nSET @query_result = ( \n    SELECT items.id AS \"ID\"\n            ,items.title AS \"Title\"\n            ,cars.brand AS \"Brand\"\n            ,cars.model AS \"Model\"\n            ,cars.type AS \"Type\"\n            ,items.city AS \"City\"\n            ,items.name AS \"Name\"\n            ,items.date_added AS \"Date\"\n            ,items.small_1 AS \"Image\"\n      FROM [cars]\n      JOIN [items] \n        ON items.id=cars.item_id\n     WHERE cars.item_id = COALESCE(@item_id,cars.item_id)\n            AND CONTAINS(cars.brand ,''COALESCE('+@brand+',cars.brand)'')\n            AND cars.model = COALESCE(@model,cars.model)\n            AND cars.type = COALESCE(@type,cars.type)\n            AND items.city = COALESCE(@city,items.city)\n            AND DATEDIFF(DAY,items.date_added,GETDATE())&lt;=COALESCE(@period,items.date_added)\n            AND items.new = COALESCE(@isnew,items.new)\n       FOR XML\n      PATH(''car''),ROOT(''items''))'\n</code></pre>\n"},{"tags":["sql-server","tsql","ansi"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":2,"view_count":69,"score":-2,"question_id":12639594,"title":"Convert T-SQL to ANSI-SQL","body":"<p>I want to convert my stored procedures from T-SQL to ANSI-SQL. Is there any tool or a checklist to do it?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":12630378,"title":"T-SQL to find length of time a particular value is in-range","body":"<p>I have a table in SQL Server where, for each row <code>r</code> at time <code>t</code>, I would like to find the first <code>t + i</code> for some function of <code>r</code> where <code>abs(f(r, t + i) - f(r, t)) &gt; epsilon</code>. </p>\n\n<p>I can imagine doing this with two cursors, but this seems highly inefficient. </p>\n\n<p>Any of the T-SQL gurus out there have any advice?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":93,"score":5,"question_id":12628459,"title":"Group by column A but comparing column B","body":"<p>This one has had me stumped for the last few hours and at this stage I think I need some help...</p>\n\n<p>I need to compare multiple groups from a single table and to identify where items listed in col B match.  For example: -</p>\n\n<pre><code>Col A...............Col B\nJohn................Apple\nJohn................Orange\nJohn................Banana\nMary................Orange\nMary................Strawberry\nDavid...............Apple\nDavid...............Orange\nDavid...............Banana\n</code></pre>\n\n<p>I want 'John' and 'David' returned because their items in col B match.  Hope this makes sense!\nThanks in advance!\nG</p>\n"},{"tags":["sql-server","tsql","case"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12636783,"title":"SQL Case statements, making sub selections on a condition?","body":"<p>I've come across a scenario where I need to return a complex set of calculated values at a crossover point from \"legacy\" to current. </p>\n\n<p>To cut a long story short I have something like this ...</p>\n\n<pre><code>with someofit as\n(\n   select id, col1, col2, col3 from table1\n)\n\nselect someofit.*, \n  case when id &lt; @lastLegacyId then\n    (select ... from table2 where something = id) as 'bla'\n   ,(select ... from table2 where something = id) as 'foo'\n   ,(select ... from table2 where something = id) as 'bar'\n  else\n    (select ... from table3 where something = id) as 'bla'\n   ,(select ... from table3 where something = id) as 'foo'\n   ,(select ... from table3 where something = id) as 'bar'\n  end\nfrom someofit\n</code></pre>\n\n<p>No here lies the problem ...\nI don't want to be constantly doing that case check for each sub selection but at the same time when that condition applies I need all of the selections within the relevant case block.</p>\n\n<p>Is there a smarter way to do this? </p>\n\n<p>if I was in a proper OO language I would use something like this ...</p>\n\n<pre><code>var common = GetCommonSuff()\n\nforeach (object item in common)\n{\n   if(item.id &lt;= lastLegacyId)\n   {\n      AppendLegacyValuesTo(item);\n   }\n   else\n   {\n      AppendCurrentValuesTo(item);\n   }\n}\n</code></pre>\n\n<p>I did initially try doing 2 complete selections with a union all but this doesn't work very well due to efficiency / number of rows to be evaluated. </p>\n\n<p>The sub selections are looking for total row counts where some condition is met other than the id match on either table 2 or 3 but those tables may have millions of rows in them.</p>\n\n<p>The cte is used for 2 reasons ... </p>\n\n<p>firstly it pulls only the rows from table 1 i am interested in so straight away im only doing a fraction of the sub selections in each case. </p>\n\n<p>secondly its returning the common stuff in a single lookup on table 1 </p>\n\n<p>Any ideas?</p>\n\n<p>EDIT 1 : </p>\n\n<p>Some context to the situation ...</p>\n\n<p>I have a table called \"imports\" (table 1 above) this represents an import job where we take data from a file (csv or similar) and pull the records in to the db. </p>\n\n<p>I then have a table called \"steps\" this represents the processing / cleaning rules we go through and each record contains a sproc name and a bunch of other stuff about the rule. </p>\n\n<p>There is then a join table that represents the rule for a particular import \"ImportSteps\" (table 2 above - for current data), this contains a \"rowsaffected\" column and the import id</p>\n\n<p>so for the current jobs my sql is quite simple ... </p>\n\n<p>select 123 456\nfrom imports\njoin importsteps</p>\n\n<p>for the older legacy stuff however I have to look through table 3 ... table 3 is the holding table, it contains every record ever imported, each row has an import id and each row contains key values. </p>\n\n<p>on the new data rowsaffected on table 2 for import id x where step id is y will return my value. </p>\n\n<p>on the legacy data i have to count the rows in holding where col z = something</p>\n\n<p>i need data on about 20 imports and this data is bound to a \"datagrid\" on my mvc web app (if that makes any difference)</p>\n\n<p>the cte i use determines through some parameters the \"current 20 im interested in\" those params represent start and end record (ordered by import id).</p>\n\n<p>My biggest issue is that holding table ... it's massive .. individual jobs have been known to contain 500k + records on their own and this table holds years of imported rows so i need my lookups on that table to be as fast as possible and as few as possible. </p>\n\n<p>EDIT 2: </p>\n\n<p>The actual solution (suedo code only) ...</p>\n\n<pre><code>-- declare and populate the subset to reduce reads on the big holding table\ndeclare table @holding ( ... )\ninsert into @holding\nselect .. from holding\n\nselect \n   ... common stuff from inner select in \"from\" below\n   ... bunch of ...\n   case when id &lt; @legacy then (select getNewValue(id, stepid))\n   else (select x from @holding where id = ID and ... ) end as 'bla'\nfrom\n\n(\n   select ROW_NUMBER() over (order by importid desc) as 'RowNum'\n   , ...\n) as I\n-- this bit handles the paging\nwhere RowNum &gt;= @StartIndex\nand   RowNum &lt; @EndIndex \n</code></pre>\n\n<p>i'm still confident i can clean it up more but my original query that looked something like bills solution was about 45 seconds in execution time, this is about 7</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","dynamic-sql"],"answer_count":4,"favorite_count":3,"up_vote_count":6,"down_vote_count":0,"view_count":2519,"score":6,"question_id":3840730,"title":"Getting result of dynamic SQL into a variable","body":"<p>Executing dynamic SQL as follows in Stored Procedure:</p>\n\n<pre><code>DECLARE @sqlCommand nvarchar(1000)\nDECLARE @city varchar(75)\nSET @city = 'London'\nSET @sqlCommand = 'SELECT COUNT(*) FROM customers WHERE City = @city'\nEXECUTE sp_executesql @sqlCommand, N'@city nvarchar(75)', @city = @city\n</code></pre>\n\n<p>How do I use the count(*) column value as return value in the SP?</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":12639301,"title":"Stored procedure table parameter versus xml in SQL Server 2008","body":"<p>I've got two versions of a stored procedure that does basically the same - does a right join query on a largish table and another table that is provided as a parameter. </p>\n\n<ul>\n<li>The first version takes a string with XML and does a select from <code>OPENXML</code>.</li>\n<li>The second takes the provided table variable parameter.</li>\n</ul>\n\n<p>I expected the second/table version to outperform the first/XML version as it doesn't do any parsing, doc object creating and disposing explicitly. My test show, however, that both versions get executed in approx the same time.</p>\n\n<p>What might be the reason? Table parameter serializes worse than string parameter? XML queries are very efficient?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":135,"score":2,"question_id":10820827,"title":"T-SQL Change Data Capture log cleanup","body":"<p>I have enabled CDC on few tables in my SQL server 2008 database. I want to change the number of days I can keep the change history.</p>\n\n<p>I have read that by default change logs are kept for 3 days, before they are deleted by  sys.sp_cdc_cleanup_change_table stored proc.</p>\n\n<p>Does anyone know how I can change this default value, so that I can keep the logs for longer.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server","tsql","dayofweek"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":378,"score":3,"question_id":11912181,"title":"Get last Friday's Date unless today is Friday using T-SQL","body":"<p>I'm trying to get the correct SQL code to obtain last Friday's date.  A few days ago, I thought I had my code correct.  But just noticed that it's getting last week's Friday date, not the last Friday.  The day I'm writing this question is Saturday, 8/11/2012 @ 12:23am.  In SQL Server, this code is returning Friday, 8/3/2012.  However, I want this to return Friday, 8/10/2012 instead.  How can I fix this code?  Since we're getting to specifics here, if the current day is Friday, then I want to return today's date.  So if it were yesterday (8/10/2012) and I ran this code yesterday, then I would want this code to return 8/10/2012, not 8/3/2012.</p>\n\n<pre><code>SELECT DATEADD(DAY, -3, DATEADD(WEEK, DATEDIFF(WEEK, 0, GETDATE()), 0))\n</code></pre>\n"},{"tags":["sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":146,"score":-1,"question_id":12614580,"title":"How to check if a string contains certain characters and split it in SQL Server 2008 R2?","body":"<p>I need to check the existence of following characters in a given string:</p>\n\n<pre><code>characters =('N', 'E', 'M', 'H', 'T', 'V', 'L', 'C' )\nstring = 2449.555N06704.2855EM0701H071T44.098V11.764L0.372C1\n</code></pre>\n\n<p>And if string contains these characters, then need to split them into values as following to insert them in <code>details_Tb</code>:</p>\n\n<pre><code>N = 2449.7183 \nE = 06704.2855 \nT = 0701\nH = 071\nT = 44.098\nV = 11.764\nL = 0.372\nC =  1\n</code></pre>\n\n<p>Any solution to this?</p>\n"},{"tags":[".net","vb.net","linq","tsql","linq-to-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":114,"score":2,"question_id":12145326,"title":"How to implement large COALESCE in LINQ-to-SQL query","body":"<p>If I have a lot of columns to COALESCE in a TSQL query that needs to be executed as a LINQ-to-SQL query. How can it be converted to an efficient LINQ-to-SQL query? For example:</p>\n\n<pre><code>SELECT COALESCE(t1.Date, t2.DocDate, t3.PostingDate, t4.DocDate, t5.DocDate) DocDate\nFROM t0\nLEFT JOIN t1 ON t0.t1id = t1.id\nLEFT JOIN t2 ON t0.t2id = t2.id\nLEFT JOIN t3 ON t0.t3id = t3.id\nLEFT JOIN t4 ON t0.t4id = t4.id\nLEFT JOIN t5 ON t0.t5id = t5.id\n</code></pre>\n\n<p>Is there any way to write this in a LINQ query better than the following?</p>\n\n<pre><code>Dim result = ( _\n   From c in context.t0 _\n   Select DocDate=If(t0.t1.Date, If(t0.t2.DocDate, If(t0.t3.PostingDate, _\n   If(t0.t4.DocDate, t0.t5.DocDate)))))\n</code></pre>\n\n<p>I actually have a couple dozen columns within the coalesce to \"merge\", and two different coalesces to return two different coalesced columns, so the result could get pretty messy, and I fear it'd be pretty inefficient if it weren't processed as COALESCE.</p>\n"},{"tags":["sql-server-2008","tsql","full-text-search"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12630475,"title":"Full Text Near with Max Distance Syntax in SQL Server 2008","body":"<p>I'm trying to write a full text search using a near proximity term with a max distance.  </p>\n\n<p>From what I can tell of the grammer...</p>\n\n<pre><code>    &lt;custom_proximity_term&gt; ::= \n  NEAR ( \n     {\n        { &lt;simple_term&gt; | &lt;prefix_term&gt; } [ ,n ]\n     |\n        ( { &lt;simple_term&gt; | &lt;prefix_term&gt; } [ ,n ] ) \n      [, &lt;maximum_distance&gt; [, &lt;match_order&gt; ] ]\n     }\n       ) \n\n      &lt;maximum_distance&gt; ::= { integer | MAX }\n      &lt;match_order&gt; ::= { TRUE | FALSE } \n</code></pre>\n\n<p>...I should be able to use <code>NEAR</code> like such:</p>\n\n<pre><code>'NEAR(term1,term2,5)'\n</code></pre>\n\n<p>OR</p>\n\n<pre><code>'NEAR((term1,term2),5)'\n</code></pre>\n\n<p>However always throws a syntax error.</p>\n\n<pre><code>Syntax error near '(' in the full-text search condition 'NEAR((term1, term2), 4, TRUE)'.\n</code></pre>\n\n<p>Even when i try to copy the exact search from a microsoft Example it throws an error:</p>\n\n<pre><code>USE AdventureWorks2012\nGO\n\nSELECT DocumentNode, Title, DocumentSummary\nFROM Production.Document AS DocTable \nINNER JOIN CONTAINSTABLE(Production.Document, Document,\n  'NEAR(bracket, reflector)' ) /* doesn't like this */ AS KEY_TBL\n  ON DocTable.DocumentNode = KEY_TBL.[KEY]\nWHERE KEY_TBL.RANK &gt; 50\nORDER BY KEY_TBL.RANK DESC\nGO\n\nSyntax error near '(' in the full-text search condition 'NEAR(bracket, reflector)'.\n</code></pre>\n"}]}
{"total":16599,"page":12,"pagesize":100,"questions":[{"tags":["c#","sql-server-2008","tsql","ado.net","cursor"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":396,"score":0,"question_id":11034970,"title":" Cursor as an output parameter","body":"<p>I have a stored procedure in SQL Server 2008 R2 that returns a Cursor as an OUTPUT value. Is it possible to return this Cursor to a C# application using the .NET 4.0 framework?</p>\n\n<p>My Stored procedure has the following signature:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[MyProcedure]\n      @nuserid    int,\n      @nfetchtype int,\n      @returncursor CURSOR VARYING OUTPUT\nAS\n...\n</code></pre>\n\n<p>At the end of the stored procedure I have</p>\n\n<pre><code>...\n    set @returncursor = CURSOR FORWARD_ONLY STATIC for SELECT * FROM MyTable WHERE          column=@Value\n    open @returncursor\nEND\n</code></pre>\n\n<p>In my C# Web Application, I use a wrapper that utilizes System.Data.DbType and I set my return value/parameter as DbType.Object. When I execute the query against the database, I get the following error:</p>\n\n<blockquote>\n  <p>Operand type clash: sql_variant is incompatible with cursor</p>\n</blockquote>\n\n<p>This DbType.Object parameter will work for a REFCURSOR in Oracle but I'm curious to see if there is a way to do the same for SqlServer. My goal is to have stored procedures in both SqlServer and Oracle that have the exact same signature.</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":12629040,"title":"updates HumanResources.Employee table 'column SickLeave Hours' 10 rows at a time (allow the batch size to be variable)","body":"<p>updates HumanResources.Employee table 'column SickLeave Hours'</p>\n\n<p>I need to do the following logic:\nif Hours greater than or equal to 35 set to 40\nif less than 35 set it to 0.\nHow to break the loop?</p>\n\n<p>How can I achieve this in SQL Server?  Thanks.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12628860,"title":"Select first group of 10 for each day (removing duplicate records)","body":"<p>I have a table called BillingInformation with the following columns:\nid, clientId, type, order, value, timestamp</p>\n\n<p>id is an artificial key\nFor each clientId on a particular date there will be 10 types e.g.</p>\n\n<pre><code>clientId   type              order    timestamp\n1          Outstanding AR    0        2012-09-24 10:45:28.557\n1          Est. Days In AR   1        2012-09-24 10:45:28.580\n1          ...               2        2012-09-24 10.45.28.603\n1          ...               3        2012-09-24 10.45.28.620  \n1          ...               4        2012-09-24 10.45.28.630  \n1          ...               5        2012-09-24 10.45.28.653\n1          ...               6        2012-09-24 10.45.28.697\n1          ...               7        2012-09-24 10.45.28.717\n1          ...               8        2012-09-24 10.45.28.727\n1          ...               9        2012-09-24 10.45.28.727\n2          Outstanding AR    0        ...\n2          Est. Days In AR   1        ...\n(cont. 8 more rows for client 2)\n</code></pre>\n\n<p>My issue is that I have some clientIds where the 10 entries are in the database more than once and I just want to select just 10 (where order = 0 through 9) per client.</p>\n\n<p>Here is my situation now:</p>\n\n<pre><code>clientId   type              order    timestamp\n1          Outstanding AR    0        2012-09-24 10:45:28.557\n1          Est. Days In AR   1        2012-09-24 10:45:28.580\n1          ...               2        2012-09-24 10.45.28.603\n1          ...               3        2012-09-24 10.45.28.620  \n1          ...               4        2012-09-24 10.45.28.630  \n1          ...               5        2012-09-24 10.45.28.653\n1          ...               6        2012-09-24 10.45.28.697\n1          ...               7        2012-09-24 10.45.28.717\n1          ...               8        2012-09-24 10.45.28.727\n1          ...               9        2012-09-24 10.45.28.727\n1          Outstanding AR    0        2012-09-24 10:45:28.557\n1          Est. Days In AR   1        2012-09-24 10:45:28.580\n1          ...               2        2012-09-24 10.45.28.603\n1          ...               3        2012-09-24 10.45.28.620  \n1          ...               4        2012-09-24 10.45.28.630  \n1          ...               5        2012-09-24 10.45.28.653\n1          ...               6        2012-09-24 10.45.28.697\n1          ...               7        2012-09-24 10.45.28.717\n1          ...               8        2012-09-24 10.45.28.727\n1          ...               9        2012-09-24 10.45.28.727\n2          Outstanding AR    0        ...\n2          Est. Days In AR   1        ...\n</code></pre>\n\n<p>(cont. 8 more rows for client 2)\n(cont. 10 rows for client 3)\n(and so on...)</p>\n\n<p>No matter how many times the records 0 through 9 are repeated for client 1 for the day of 2012-09-14 (disregarding hours minutes seconds and milliseconds), I just want to select just one group of 10 along with the other records.  So if any client has duplicated sets of 10 for the same month day and year, I just want one group of 10 for that month day and year.</p>\n\n<p>Can anyone help me with this?</p>\n"},{"tags":["sql","sql-server","tsql","bitwise-operators"],"answer_count":5,"favorite_count":4,"up_vote_count":10,"down_vote_count":0,"view_count":863,"score":10,"question_id":4105543,"title":"Why does SELECT 2^3 return 1 in SQL Server?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/3769200/what-does-a-caret-do-in-a-sql-query\">What does a caret (^) do in a SQL query?</a>  </p>\n</blockquote>\n\n\n\n<p>Why does SELECT 2^3 return 1 in SQL Server ?</p>\n\n<p>The above was an interview question I came across and could not get why it returns 1.</p>\n\n<p>After googling a bit, I found out that it is a bitwise operator. But I still couldn't understand why 1 is an output.</p>\n\n<p>I have basic knowledge of queries, stored procedure and T-SQL. Can anybody please explain to me:</p>\n\n<ol>\n<li>How do I get 1 in SELECT 2^3 ?</li>\n<li>What is the practical use of such operators ?</li>\n</ol>\n\n<p>And if there is a practical use, then what are the best practices while using such operators</p>\n"},{"tags":["sql-server-2008","tsql","sql-server-2008-r2","sql-server-2012"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":12629092,"title":"Named stored proc parameters and concatenation","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/4936180/cast-integer-and-concatenate-to-varchar-in-tsql\">Cast integer and concatenate to varchar in TSQL</a>  </p>\n</blockquote>\n\n\n\n<p>How do you call a stored procedure using named parameters that have more complex values. Here is a somewhat concocted example:</p>\n\n<pre><code>EXEC MyStoredProc @Param1='My name is: '+@Name\n</code></pre>\n\n<p>Or:</p>\n\n<pre><code>EXEC MyStoredProc @Param1=CONCAT('My name is: ',@Name)\n</code></pre>\n\n<p>I get an error trying to concatenate the literal string 'My name is: ' with the variable @Name. Parentheses do not help the matter any. Is this a limitation of T-SQL (i.e., when named parameters are used, the expression after the equal sign must be a single literal or variable)?</p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","tsql","triggers"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":76,"score":0,"question_id":12627851,"title":"Error trying to insert data using trigger T-SQL","body":"<p>Below is a trigger used on one of our SQL tables for any insert/update action. 99/100 times this trigger works just fine however every now and then we receive this error message: </p>\n\n<blockquote>\n  <p><em>Cannot insert the value NULL into column 'TransactionDate', table\n  'AgentResourcesU01.dbo.TransactionLog'; column does not allow nulls.<br>\n  INSERT fails. The statement has been terminated.</em></p>\n</blockquote>\n\n<p>As you can see from the Insert statement, the columns in our transaction log table are <code>TransactionDate, Operator, TableName, Action, TableString</code> and <code>UserId</code>. I set the variable <code>@transDate</code> in the opening SELECT statement so as it appears to me, there should be no way a NULL gets in there unless it's bad data coming in. </p>\n\n<p>Any thoughts?</p>\n\n<pre><code>    BEGIN\n        SELECT @symetraNumber = SymetraNumber, @lastChangeOperator = LastChangeOperator, @transDate = LastChangeDate, @entityType = EntityType, \n        @firstName = FirstName, @lastName = LastName, @suffix = NameSuffix, @corpName = CorporateName, @controlId = ControlId\n        FROM inserted\n\n        IF @firstName IS NULL SET @firstName = 'NULL'\n        IF @lastName IS NULL SET @lastName = 'NULL'\n        IF @suffix IS NULL SET @suffix = 'NULL'\n        IF @corpName IS NULL SET @corpName = 'NULL'\n        IF @controlId IS NULL SET @controlId = 'NULL'\n\n        SET @tableString = 'SymNum:' + @symetraNumber + ' EntType:' + @entityType + ' Fname:' + @firstName + ' Lname:' + @lastname + ' Suff:' + @suffix +\n            ' CorpName:' + @corpName + ' ctrlId:' + @controlId\n\n        INSERT INTO TransactionLog (TransactionDate, Operator, TableName, Action, TableString, UserId)\n        VALUES (@transDate, 'Op', @tableName, @action, @tableString, @lastChangeOperator)\n    END\n</code></pre>\n"},{"tags":["sql-server","tsql","linq-to-sql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":121,"score":1,"question_id":12608780,"title":"Understanding SQL Server LOCKS on SELECT queries","body":"<p>I'm wondering what is the benefit to use <code>SELECT WITH (NOLOCK)</code> on a table if the only other queries affecting that table are <code>SELECT</code> queries.</p>\n\n<p>How is that handled by SQL Server? Would a <code>SELECT</code> query block another <code>SELECT</code> query?</p>\n\n<p>I'm using SQL Server 2012 and a Linq-to-SQL <code>DataContext</code>.</p>\n\n<p>(EDIT) </p>\n\n<p>About performance : </p>\n\n<ul>\n<li>Would a 2nd <code>SELECT</code> have to wait for a 1st <code>SELECT</code> to finish if using a locked <code>SELECT</code>?</li>\n<li>Versus a <code>SELECT WITH (NOLOCK)</code>?</li>\n</ul>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12626382,"title":"Show Time Difference Out of Order","body":"<p>Id like to get a count of how many times a process code of 20 has a LastModifiedTime before a  process code of 10 for each WorkflowId grouping.</p>\n\n<p>This query shows the table layout and some data:</p>\n\n<pre><code>SELECT TOP 10 * \nFROM master.ProcessLogging with (nolock) \nWHERE ProcessCode = 10 OR ProcessCode = 20 \nORDER BY WorkflowId, ProcessCode\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/OIHcn.png\" alt=\"enter image description here\"></p>\n\n<p>I've tried a few things, but I'm having a difficult time getting it to work. Each attempt has lead to a dead end that's not worth posting here. Is there a way to see all of the times a 20 comes before a 10? And maybe even see the time difference between them?</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12627896,"title":"IF or CASE or WHILE LOOP. What's the Best approach?","body":"<p>If it's greater than 10 set the variable to -1 and select that variable output.\nIf less than 10 select the variable as the output.</p>\n\n<pre><code>DECLARE @i INT\nSET @i = 10 \nSELECT @i = (@i * 10)\n</code></pre>\n\n<p>Thank You,</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":12624339,"title":"SELECT same column from two different tables T-SQL","body":"<p>I need to grab a column called SymNumber from two different tables. Both are going to be selected using a similar criteria. Below is what I have so far and it is not working...</p>\n\n<pre><code>DECLARE @date datetime\n\nSELECT @date = LastChangeDate\nFROM QueueUpdates\n\nSELECT DISTINCT u.CompanyCode, u.AgentId \nFROM SymNumberToAgentId u, AgentIdToTradingPartner a, TradingPartner t, AgentContEd c \nWHERE u.SymNumber in \n(SELECT SymNumber FROM \n(SELECT a.SymeNumber, c.SymNumber \nFROM AgentProductTraining a, AgentContEd c \nWHERE a.LastChangeDate &gt;= @date and c.LastChangeDate &gt;= @date) a ) and \nu.AgentId = a.AgentId and a.TradingPartnerCode = t.TradingPartnerCode and t.TradingPartnerCode = 'SE2'\n\nGO\n</code></pre>\n\n<p>The part that is giving me headaches is the inner query listed below. I think that adjusting this portion will allow me to grab the SymNum column from both tables. </p>\n\n<pre><code>(SELECT SymetraNumber FROM \n(SELECT a.SymetraNumber, c.SymetraNumber \nFROM AgentProductTraining a, AgentContEd c \nWHERE a.LastChangeDate &gt;= @date and c.LastChangeDate &gt;= @date) a )\n</code></pre>\n"},{"tags":["tsql","sql-server-2008"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":96,"score":2,"question_id":6857024,"title":"How to get days dd in dd/mm/yyyy in a dateime column","body":"<p>I want to get all the <code>dd</code> in <code>dd/mm/yyyy</code> date column. How do I write the query for it? \nFor Example: If I want <code>dd</code> between <code>28/06/2011</code> to <code>02/07/2011</code>, then I should get the output like this:</p>\n\n<pre><code>28\n29\n30\n01\n02\n</code></pre>\n\n<p>Please help me through this</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":66,"score":0,"question_id":12623258,"title":"T-SQL date conversion","body":"<p>I have the following date format <code>92845</code> which represent <code>hhmmss</code>.</p>\n\n<p>I would like to convert that to a <code>datetime</code> in SQL.  </p>\n\n<p>I could use something like this: </p>\n\n<pre><code>SELECT STUFF(STUFF('84936',3,0,'-'),6,0,'-') \n</code></pre>\n\n<p>but it appears T-SQL is not liking the <code>hour</code> part.</p>\n\n<p>thank you!</p>\n"},{"tags":["tsql","sql-server-2005","merge"],"answer_count":1,"favorite_count":2,"up_vote_count":0,"down_vote_count":0,"view_count":97,"score":0,"question_id":12621241,"title":"Can I use the MERGE statement in SQL Server 2005?","body":"<p>I am using SQL Server 2005 and I wanted to create MERGE statement or concept in single query in SQL Server 2005. Is it possible?</p>\n"},{"tags":["sql","sql-server","tsql","join"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":12602362,"title":"Joining two tables on based on second number value from first table","body":"<p>I am new to SQL, so please bear with me. </p>\n\n<p>I am working with two tables that do not have common fields. I am trying to create simple hierarchy based on the two tables that look like this: </p>\n\n<pre><code>   Table 1. \n\nCul 1   Cul 2 \n============== \nS10000  Name \nS20000  Name 1 \nS30000  Name 2 \nS40000  Name 3\n\n Table 2 \n\nCul 1   Cul 2  \n=====================\nA10000  Test \nA10001  Test 123 \nA20000  Test 1\nA20001  Test 999 \nA30000  Test 2  \nA30002  Test 5555 \nA40000  Test 3   \nA40006  Test 84384848\n</code></pre>\n\n<p>I would like to write a query that will display Name field from Table 1 based on matching numeric values in the first columns from table 1 &amp; 2. </p>\n\n<p>So if Table 1 is S10000, display A1000  Test  </p>\n\n<p>Is that possible?</p>\n\n<p>Thank you</p>\n"},{"tags":["tsql","levenshtein-distance"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":12621927,"title":"Check SQL Server table values against themselves","body":"<p>Imagine I had this table:</p>\n\n<pre><code>declare @tmpResults table ( intItemId int, strTitle nvarchar(100), intWeight float )\n\ninsert into @tmpResults values (1, 'Item One', 7)\ninsert into @tmpResults values (2, 'Item One v1', 6)\ninsert into @tmpResults values (3, 'Item Two', 6)\ninsert into @tmpResults values (4, 'Item Two v1', 7)\n</code></pre>\n\n<p>And a function, which we'll call fn_Lev that takes two strings, compares them to one another and returns the number of differences between them as an integer (i.e. the Levenshtein distance).</p>\n\n<p>What's the most efficient way to query that table, check the fn_Lev value of each strTitle against all the other strTitles in the table and delete rows are similar to one another by a Levenshtein distance of 3, preferring to keeping higher intWeights?</p>\n\n<p>So the after the delete, @tmpResults should contain</p>\n\n<pre><code>1   Item One    7\n4   Item Two v1 7\n</code></pre>\n\n<p>I can think of ways to do this, but nothing that isn't horribly slow (i.e iterative). I'm sure there's a faster way?</p>\n\n<p>Cheers,\nMatt</p>\n"},{"tags":["sql","database","tsql","plsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":77,"score":2,"question_id":12619188,"title":"SUM field not summing","body":"<p>Similar to my last question. Heres my code:</p>\n\n<pre><code>  SELECT TR.ITEMNO,\n      SUM ( TR.TRANS_QUAN * CASE TR.TRANS_TYPE WHEN 'PO' THEN 1 ELSE 0 END ) AS SUM_IN,\n      SUM ( TR.TRANS_QUAN * CASE TR.TRANS_TYPE WHEN 'MH' THEN 1 ELSE 0 END ) AS SUM_OUT\n  FROM IQMS.TRANSLOG TR\n  WHERE TR.ITEMNO = '200672'\n  GROUP BY TR.ITEMNO\n  HAVING SUM ( TR.TRANS_QUAN * CASE TR.TRANS_TYPE WHEN 'PO' THEN 1 ELSE -1 END ) &lt; 0\n  ORDER BY TR.ITEMNO\n</code></pre>\n\n<p>The code is running fine but it is not summing anything for SUM_OUT. I know for a fact however that there are numbers there to be summed. Is there something obvious that I am missing? Thanks in advance!! :)</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","thread-safety"],"answer_count":5,"favorite_count":3,"up_vote_count":6,"down_vote_count":0,"view_count":1482,"score":6,"question_id":1483383,"title":"Is this stored procedure thread-safe? (or whatever the equiv is on SQL Server)","body":"<p>With the help of others on SO I've knocked up a couple of Tables and Stored Procedures, this morning, as I'm far from a DB programmer.</p>\n\n<p>Would someone mind casting an eye over this and telling me if it's thread-safe?  I guess that's probably not the term DBAs/DB developers use but I hope you get the idea: basically, what happens if this sp is executing and another comes along at the same time?  Could one interfere with the other?  Is this even an issue in SQL/SPs?</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[usp_NewTicketNumber]\n\t@ticketNumber int OUTPUT\nAS\nBEGIN\n\tSET NOCOUNT ON;\n\tINSERT INTO [TEST_Db42].[dbo].[TicketNumber]\n\t\t\t   ([CreatedDateTime], [CreatedBy])\n\t\t VALUES\n\t\t\t\t(GETDATE(), SUSER_SNAME())\n\tSELECT @ticketNumber = IDENT_CURRENT('[dbo].[TicketNumber]');\n\tRETURN 0;\nEND\n</code></pre>\n"},{"tags":["sql-server","tsql","group-by"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12618226,"title":"Tsql group by clause with exceptions","body":"<p>I have a problem with a query.</p>\n\n<p>This is the data (order by Timestamp):</p>\n\n<pre><code>Data\n    ID  Value   Timestamp\n    1   0       2001-1-1\n    2   0       2002-1-1\n    3   1       2003-1-1\n    4   1       2004-1-1\n    5   0       2005-1-1\n    6   2       2006-1-1\n    7   2       2007-1-1\n    8   2       2008-1-1\n</code></pre>\n\n<p>I need to extract distinct values and the first occurance of the date. The exception here is that I need to group them only if not interrupted with a new value in that timeframe.\nSo the data I need is:</p>\n\n<pre><code>ID  Value   Timestamp\n1   0       2001-1-1\n3   1       2003-1-1\n5   0       2005-1-1\n6   2       2006-1-1\n</code></pre>\n\n<p>I've made this work by a complicated query, but am sure there is an easier way to do it, just cant think of it. Could anyone help?</p>\n\n<p>This is what I started with - probably could work with that. This is a query that should locate when a value is changed.</p>\n\n<pre><code>  &gt; SELECT * FROM Data d1 join Data d2 ON d1.Timestamp &lt; d2.Timestamp and\n    &gt; d1.Value &lt;&gt; d2.Value\n</code></pre>\n\n<p>It probably could be done with a good use of row_number clause but cant manage it.</p>\n"},{"tags":["tsql","code-kata"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":27,"score":0,"question_id":12617521,"title":"Good resources on SQL Code Katas","body":"<p>I have just started doing the FizzBuzz Kata and the syntax is really sticking. I think it's an excellent technique</p>\n\n<p>Most stuff I have looked at on the internet seems geared towards Java/C++</p>\n\n<p>Any good resources for SQL?</p>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":45,"score":1,"question_id":12286789,"title":"Error with the following dynamic sql statement","body":"<p>I am having an error I cannot see in the following dynamic SQL statement:</p>\n\n<pre><code>  SET @sql_statement =\n    \"INSERT INTO \" +\n      @archive_db_name + \".dbo._TEST_TB_ACTIVE_ORDERS \n    SELECT \" +\n      @reporting_db_name + \".dbo._TEST_TB_ACTIVE_ORDERS.* \n    FROM \" +\n      @reporting_db_name + \".dbo._TEST_TB_ACTIVE_ORDERS \n    WHERE \" +\n      @reporting_db_name + \".dbo._TEST_TB_ACTIVE_ORDERS.ORDER_ID \n    IN\n      (\n        select #tmp_table_order_ids.order_id\n        from #tmp_table_order_ids\n      )\"\n  EXEC(@sql_statement)\n</code></pre>\n\n<p>The error is:</p>\n\n<p><code>Msg 102, Level 15, State 1:\nServer 'server_name', Line 5:\nIncorrect syntax near 'IN'</code></p>\n\n<p>But I cannot see any syntax errors at the location the error specifies. Could someone please kindly point out why I am getting this error?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-ce"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12614551,"title":"Parent Child Reference SQL query","body":"<p>I have Parent + Reference tables  where\nReference table is as follows</p>\n\n<pre><code>Ref_ID    PARENT_ID    \n-------------------\n1           1            \n2           1            \n1           2       \n3           2       \n1           3       \n3           3       \n4           3       \n2           4       \n3           4       \n</code></pre>\n\n<p>Trying to return all distinct parent rows WHERE ref_id in ( 2, 3 ) \nusing a join instead of using a subquery \nbut duplicates are being returned for parent via join query</p>\n\n<p>Any help is appreciated </p>\n\n<p>FYI - there are 4-7 tables in the query ( depending on user selections )so performance is a huge factor</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":66,"score":5,"question_id":12613961,"title":"SQL Select: how to return count of consecutive values from an ordered data set","body":"<p>The following is a subset of a table I have in a SQL Server 2008 database.</p>\n\n<p>I am trying to output the <code>Serial Number</code>, the <code>LID</code> with the greatest count of consecutive <code>LID</code> values, and the actual count. Important to note that the table is ordered by the <code>Last Updated Date</code> value descending (this condition is critical). It can be grouped by <code>Serial Number</code> or ordered by <code>Serial Number</code> ascending or descending... whatever is more efficient and makes sense.  </p>\n\n<p>Here's what the data looks like:</p>\n\n<pre><code>[Serial Number]  [LID]   [Last Updated Date]\n--------------------------------------    \n123456            AAA     2012-09-24\n123456            AAA     2012-09-23\n123456            AAA     2012-09-22\n123456            AAA     2012-09-21\n123456            BBB     2012-09-20\n123456            BBB     2012-09-19\n123456            AAA     2012-09-18\n123456            AAA     2012-09-17\n123456            AAA     2012-09-16\n234567            BBB     2012-09-24\n234567            BBB     2012-09-23\n234567            AAA     2012-09-22\n</code></pre>\n\n<p>The desired output to the table is:</p>\n\n<pre><code>[Serial Number]     [LID]     [LID Count]\n-------------------------------------------    \n123456            AAA     4\n234567            BBB     2\n</code></pre>\n\n<p>I am at a loss. I've tried using </p>\n\n<pre><code>ROW_NUMBER() OVER(PARTITION BY [Service Tag], [LID]\n                  ORDER BY [Last Updated Date] DESC) \n</code></pre>\n\n<p>but all that does is break up my descending date order and I end up with the count and the LID that occurs the most during the range of dates.</p>\n\n<p>Thanks in advance for any assistance you can provide!</p>\n\n<p>Best Regards,</p>\n\n<p>VP</p>\n"},{"tags":["sql","xml","tsql","group-by","sqlxml"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12599885,"title":"Group by a result of a xml query","body":"<p>I have table with a XML column (called MetaData) which looks like this:</p>\n\n<pre><code>&lt;props&gt;\n  &lt;prop name=\"bytes\" value=\"194\" /&gt;\n  &lt;prop name=\"error\" value=\"File is a text file\" /&gt;\n  &lt;prop name=\"mime-type\" value=\"text/plain \" /&gt;\n&lt;/props&gt;\n</code></pre>\n\n<p>Now I have some differnt errors which I can select with this here:</p>\n\n<pre><code>SELECT MetaData.value('(/props/prop[@name=\"error\"]/@value)[1]', 'varchar(50)') Error,\n       MetaData.value('(/props/prop[@name=\"mime-type\"]/@value)[1]', 'varchar(50)') MimeType,\n       *\nFROM source\nWHERE MetaData.exist('/props/prop[@name=\"error\"]') = 1\n</code></pre>\n\n<p>Now I would like to count how often a error accours:</p>\n\n<pre><code>SELECT MetaData.value('(/props/prop[@name=\"error\"]/@value)[1]', 'varchar(50)') Error,\n       COUNT(*) Count\nFROM source\nWHERE MetaData.exist('/props/prop[@name=\"error\"]') = 1\nGROUP BY Error\n</code></pre>\n\n<p>But I get the error message:</p>\n\n<blockquote>\n  <p>Meldung 207, Ebene 16, Status 1, Zeile 5<br/>\n  Ungltiger Spaltenname 'Error'.</p>\n</blockquote>\n\n<p>Which means something like: Invalid column name 'Error'</p>\n\n<p>I also tried this here:</p>\n\n<pre><code>Select Error, COUNT(Error) FROM (\n    SELECT MetaData.value('(/props/prop[@name=\"error\"]/@value)[1]', 'varchar(50)') Error\n    FROM videos\n    WHERE MetaData.exist('/props/prop[@name=\"error\"]') = 1\n)\nGROUP BY Error\n</code></pre>\n\n<p>But that crashes with:</p>\n\n<blockquote>\n  <p>Meldung 156, Ebene 15, Status 1, Zeile 6<br/>\n  Falsche Syntax in der Nhe des GROUP-Schlsselworts.</p>\n</blockquote>\n\n<p>Which means something like: Syntax error near the keyword GROUP</p>\n\n<p>How can I fix that problem?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","type-conversion"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12612700,"title":"Convert Hexadecimal to INT and vice versa","body":"<p>I will be creating a sequential Serial Number made from Hexadecimal values</p>\n\n<p>With this Format: </p>\n\n<pre><code>XX-XX-XX-YYYY\nWhich XX-XX-XX is default value\nAnd YYYY is the incrementing hexa decimal value\n</code></pre>\n\n<p>Now to create the serial number based on hex value I need Add 6 to the last generated hex value</p>\n\n<pre><code>MIN: 2D41 + 6 = 2D47    \n     2D47 + 6 ... and so on\nMAX: 4100   generation of serial will stop when I meet the MAX value.\n</code></pre>\n\n<p>I already created it in c# but I need to do it on SQL</p>\n\n\n\n<pre><code>int num1 = int.Parse(\"2D41\", NumberStyles.HexNumber); //Convert hex to int\nint result = num1 + 6; //Add + 6 for increment\nstring myHex = result.ToString(\"X\");  //Convert result to hex\nMessageBox.Show(myHex);  // result 2D47\n</code></pre>\n\n<p>How can this be done in T-SQL?</p>\n"},{"tags":["sql","sql-server","performance","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":98,"score":2,"question_id":12592211,"title":"Overwrite values every time vs query to see if value has changed","body":"<p>I have a column that I would like to update only if the value I pass in to a stored procedure is different than the value in the column. It happens to be an NVARCHAR(255) column, if that matters.</p>\n\n<p>What are the pros and cons of writing this value every time? What are the pros and cons of checking the value first and writing only if what I have passed in is different than what is in the database?</p>\n\n<p>My simplified example where I'm doing a comparison before writing:</p>\n\n<pre><code>-- @URL and @ContentName are parameters of the sproc    \n\nSET @ExistingURL =\n    (SELECT TOP 1 C.URL\n    FROM Content C\n    WHERE ContentName = @ContentName)\n\n-- update only if the parameter and existing value are different\nIF(@ExistingURL != @URL)\nBEGIN\n    UPDATE Content\n    SET URL = @URL\n    WHERE ContentName = @ContentName\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":68,"score":2,"question_id":12610823,"title":"SQL Query To Get Multiple Max Values From Multiple Columns","body":"<p>I am trying to figure out how to pull multiple max values from multiple columns.  Here is some  sample data:</p>\n\n<pre><code>DATE | A | B | C\n\n4/4/2011 | 64.4 | 62.1 | 33.3\n\n4/5/2011 | 34.6 | 33.5 | 32.3\n\n4/6/2011 | 33.1 | 49.4 | 32.1\n\n4/7/2011 | 55.2 | 32.8 | 33.5\n\n4/8/2011 | 31.2 | 50.1 | 30.4\n\n4/9/2011 | 31.7 | 31.1 | 30.4\n</code></pre>\n\n<p>I want the top 5 so:</p>\n\n<pre><code>4/4/2011 | 64.4\n\n4/4/2011 | 62.1\n\n4/7/2011 | 55.2\n\n4/8/2011 | 50.1\n\n4/6/2011 | 49.4\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12609864,"title":"Count based on Or is not differentiating the count","body":"<p>My results are showing both counts the same but there should be some that have different counts as CarCode is sometimes null.</p>\n\n<pre><code>SELECT  distinct car.carKey,            \n    car.Weight,\n    car.CarCode,\n    COUNT(car.carKey)OVER(PARTITION BY car.carKey) AS TotalCarKeyCount,\n    COUNT(Case When (car.[Weight] IS not null) and (car.CarCode is null) as CarCountWithoutCode \n           then 0 \n       else car.carKey End) OVER(PARTITION BY car.carKey) AS CarCount\nfrom car\n</code></pre>\n\n<p>results show <code>TotalCarKeyCount</code> and <code>CarCountWithoutCode</code> always with the same counts like the case statement isn't working or something.</p>\n"},{"tags":["tsql","implicit-conversion"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":85,"score":2,"question_id":12609536,"title":"T-SQL implicit conversion between 2 varchars","body":"<p>I have some T-SQL (SQL Server 2008) that I inherited and am trying to find out why some of queries are running really slow. In the <code>Actual Execution Plan</code> I have three clustered index scans which are costing me 19%, 21% and 26%, so this seems to be the source of my problem.</p>\n\n<p>The contents of the fields are usually numeric (but some job numbers have an alpha prefix)</p>\n\n<p>The database design (vendor supplied) is pretty poor. The max length of a job number in their application is 12 chars, but in the tables that are joined it is defined as <code>varchar(50)</code> in some places and <code>varchar(15)</code> in others. My parameter is a <code>varchar(12)</code>, but I get same thing if I change it to a <code>varchar(50)</code></p>\n\n<p>The node contains this:</p>\n\n<pre><code>Predicate: [Live_Costing].[dbo].[TSTrans].[JobNo] as [sts1].[JobNo]=CONVERT_IMPLICIT(varchar(50),[@JobNo],0)\n</code></pre>\n\n<p><code>sts1</code> is a derived table, but the table it pulls <code>jobno</code> from is a <code>varchar(50)</code></p>\n\n<p>I don't understand why it's doing an implicit conversion between 2 varchars. Is it just because they are different lengths?</p>\n\n<p>I'm fairly new to the execution plan</p>\n\n<p>Is there an easy way to figure out which node in the exec plan relates to which part of the query?\nIs the predicate, the join clause?</p>\n\n<p>Regards</p>\n\n<p>Mark</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":12609795,"title":"SQL Server : Distinct + random rows","body":"<p>How do I pick distinct as well as random rows from a SQL Server 2008/2005 table?</p>\n\n<p>I have a list of tips from which I need to pick a few tips <strong>randomly</strong> and they must be <strong>unique</strong> too.</p>\n\n<p>I tried:</p>\n\n<pre><code>Select \n    Distinct Tips \nFrom \n    jfpastrologytips \nWhere \n    GetDate() &lt;= validtill \nOrder by \n    NewId()\n</code></pre>\n\n<p>and got commissioned with exception</p>\n\n<blockquote>\n  <p><em>Msg 145, Level 15, State 1, Line 1<br>\n  ORDER BY items must appear in the select list if SELECT DISTINCT is specified.</em></p>\n</blockquote>\n"},{"tags":["linq","tsql","linq-to-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":47,"score":1,"question_id":12566972,"title":"converting sql to linq woes","body":"<p>At my job our main application was written long ago before n-tier was really a thing, ergo - it has tons and tons of business logic begin handled in stored procs and such.  </p>\n\n<p>So we have finally decided to bite the bullet and make it not suck so bad.  I have been tasked with converting a 900+ line sql script to a .NET exe, which I am doing in C#/Linq.  Problem is...for the last 5-6 years at another job, I had been doing Linq exclusively, so my SQL has gotten somewhat rusty, and some of thing I am converting I have never tried to do before in Linq, so I'm hitting some roadblocks.</p>\n\n<p>Anyway, enough whining.</p>\n\n<p>I'm having trouble with the following sql statement, I think due to the fact that he is joining on a temp table and a derived table.  Here's the SQL:</p>\n\n<pre><code>insert into #processedBatchesPurgeList\n    select d.pricebatchdetailid\n    from pricebatchheader h (nolock)\n    join pricebatchstatus pbs (nolock) on h.pricebatchstatusid = pbs.pricebatchstatusid\n    join pricebatchdetail d (nolock) on h.pricebatchheaderid = d.pricebatchheaderid\n    join \n    (   -- Grab most recent REG.\n        select\n            item_key \n            ,store_no\n            ,pricebatchdetailid = max(pricebatchdetailid)\n        from pricebatchdetail _pbd (nolock)\n        join pricechgtype pct (nolock) on _pbd.pricechgtypeid = pct.pricechgtypeid\n        where\n            lower(rtrim(ltrim(pct.pricechgtypedesc))) = 'reg'\n            and expired = 0\n        group by item_key, store_no\n    ) dreg\n        on d.item_key = dreg.item_key\n        and d.store_no = dreg.store_no\n    where\n        d.pricebatchdetailid &lt; dreg.pricebatchdetailid -- Make sure PBD is not most recent REG.\n        and h.processeddate &lt; @processedBatchesPurgeDateLimit\n        and lower(rtrim(ltrim(pbs.pricebatchstatusdesc))) = 'processed' -- Pushed/processed batches only.\n</code></pre>\n\n<p>So that's raising an overall question first:  how to handle temp tables in Linq?  This script uses about 10 of them.  I currently have them as List.  The problem is, if I try to .Join() on one in a query, I get the \"Local sequence cannot be used in LINQ to SQL implementations of query operators except the Contains operator.\" error.</p>\n\n<p>I was able to get the join to the derived table to work using 2 queries, just so a single one wouldn't get nightmarishly long:</p>\n\n<pre><code>var dreg = (from _pbd in db.PriceBatchDetails.Where(pbd =&gt; pbd.Expired == false &amp;&amp; pbd.PriceChgType.PriceChgTypeDesc.ToLower().Trim() == \"reg\")\n                    group _pbd by new { _pbd.Item_Key, _pbd.Store_No } into _pbds\n                    select new \n                    {\n                        Item_Key = _pbds.Key.Item_Key,\n                        Store_No = _pbds.Key.Store_No,\n                        PriceBatchDetailID = _pbds.Max(pbdet =&gt; pbdet.PriceBatchDetailID)\n                    });\n\n        var query = (from h in db.PriceBatchHeaders.Where(pbh =&gt; pbh.ProcessedDate &lt; processedBatchesPurgeDateLimit)\n                    join pbs in db.PriceBatchStatus on h.PriceBatchStatusID equals pbs.PriceBatchStatusID\n                    join d in db.PriceBatchDetails on h.PriceBatchHeaderID equals d.PriceBatchHeaderID\n                    join dr in dreg on new { d.Item_Key, d.Store_No } equals new { dr.Item_Key, dr.Store_No }\n                    where d.PriceBatchDetailID &lt; dr.PriceBatchDetailID\n                    &amp;&amp; pbs.PriceBatchStatusDesc.ToLower().Trim() == \"processed\"\n                    select d.PriceBatchDetailID);\n</code></pre>\n\n<p>So that query gives the expected results, which I am holding in a List, but then I need to join the results of that query to another one selected from the database, which is leading me back to the aforementioned \"Local sequence cannot be used...\" error.</p>\n\n<p>That query is this:</p>\n\n<pre><code>insert into #pbhArchiveFullListSaved\n    select h.pricebatchheaderid\n    from pricebatchheader h (nolock)\n        join pricebatchdetail d (nolock)\n            on h.pricebatchheaderid = d.pricebatchheaderid\n        join #processedBatchesPurgeList dlist\n            on d.pricebatchdetailid = dlist.pricebatchdetailid -- PBH list is restricted to PBD purge list rows that have PBH references.\n    group by h.pricebatchheaderid\n</code></pre>\n\n<p>The join there on #processedBatchesPurgeList is the problem I am running into.</p>\n\n<p>So uh...help?  I have never written SQL like this, and certainly never tried to convert it to Linq.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12608879,"title":"SQL Server merge function - Delete and output deleted not working properly","body":"<p>I have a pretty standard script that uses the merge functionality to insert, update, and delete records. However, I am having a lot of trouble with outputting deleted results to an audit type table. When I run the procedure against a clean target table I somehow end up with all nulls in the audit table, despite the fact nothing has been deleted (only inserts to non-audit table at this point, which does happen as it should). Under the same conditions and against the same clean target table, if I remove the:</p>\n\n<pre><code>OUTPUT deleted.Column1, deleted.Column2 INTO Table_Audit (Column1, Column2)\n</code></pre>\n\n<p>and replace it with:</p>\n\n<pre><code>OUTPUT $action, Inserted.*, Deleted.*\n</code></pre>\n\n<p>I see that nothing has actually been deleted, which is odd considering the source and target tables were the same on both runs and the merge predicate remained the same. All the records in the action column of the second statement are inserts as we would expect. Literally the only thing different is what I just mentioned above. Any ideas as to what could be going on?</p>\n"},{"tags":["sql","sql-server","performance","tsql","query-optimization"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":64,"score":2,"question_id":10744736,"title":"Which is the actual query execution time with Statistic Time enabled in T-SQL?","body":"<p>When Statistics Time is enabled in the SQL Sever options in SQL Server Management Studio, I get the following information.</p>\n\n<blockquote>\n  <p>SQL Server parse and compile time:     CPU time = 15 ms, elapsed time\n  = 47 ms.</p>\n  \n  <p>(1745 row(s) affected)</p>\n  \n  <p>SQL Server Execution Times:    CPU time = 31 ms,  elapsed time = 99\n  ms. SQL Server parse and compile time:     CPU time = 0 ms, elapsed\n  time = 0 ms.</p>\n</blockquote>\n\n<p>There are four times in milliseconds. Now, which one is the actual time it took to run the query? They don't seem to be relative.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":21,"score":0,"question_id":12608935,"title":"Or inside Case statement","body":"<p>trying to figure out how to incorporate an OR in a case statement in T-SQL</p>\n\n<p>I'm essentially checking for 2 things, and if either one is true, just look at them as 0 for the count.</p>\n\n<pre><code>COUNT(Case When (car[Weight] IS null) then 0 else car.CarKey \n           OR When (car.BinNumber is null) then 0 else car.CarKey \n      End) as Carkey\n</code></pre>\n\n<p>also tried this but syntax is wrong</p>\n\n<pre><code>COUNT(Case When (car[Weight] IS null) then 0 \n         else When (car.BinNumber is null) then 0 \n         else car.CarKey \n      End) as Carkey\n</code></pre>\n"},{"tags":["sql","query","tsql","logic"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":1,"view_count":47,"score":0,"question_id":12605096,"title":"Perplexing SQL statement","body":"<p>Given a table with this data:</p>\n\n<pre><code>   L    |    N\n-------------------\n   A    |    1\n   A    |    3\n   A    |    5\n   B    |    5\n   B    |    7\n   B    |    9\n   C    |    1\n   C    |    2\n   C    |    3\n</code></pre>\n\n<p>Write an elegant SQL query that achieves this:</p>\n\n<p>FIND Letters (L) that include ALL of 1, 2, and 3</p>\n\n<p>The expected outcome is obvious:\nA single row with \"C\"</p>\n\n<p>Anyone have solution?  And no, this isn't a CS homework question. Just curious how you would write a SQL query to find the solution.</p>\n\n<p>Thanks in advance,\nDaniel</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12607743,"title":"T-SQL SELECT top Category by LastUpdateDateTime","body":"<p>I want a more elegant way to select the top category in the table below by LastUpdatedDateTime descending.  Basically I only want to see the latest single row for each Category by CategoryID.</p>\n\n<p>I can get that by doing the following...</p>\n\n<pre><code>SELECT Category,\n   MAX(LastUpdateDateTime) as LastUpdateDateTime\nINTO #t\nFROM Settings\nWHERE CatalogID = 123\nGROUP BY Category\nORDER BY Category\n\nSELECT s.*\nFROM Settings s\nINNER JOIN #t t\nON s.Category = t.Category\nAND s.LastUpdateDateTime = t.LastUpdateDateTime\n</code></pre>\n\n<p>--> Settings table</p>\n\n<pre><code>CREATE TABLE [dbo].[Settings](\n[ID] [int] IDENTITY(1,1) NOT NULL,\n[CatalogID] [int] NOT NULL,\n[Category] [varchar](50) NOT NULL,\n[Facings] [bit] NOT NULL,\n[Quantity] [bit] NOT NULL,\n[LastUpdateDateTime] [datetime] NOT NULL,\n CONSTRAINT [PK_Settings_1] PRIMARY KEY CLUSTERED \n (\n[ID] ASC,\n[CatalogID] ASC,\n[Category] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF,     ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n</code></pre>\n\n<p>This is pretty simple, just looking for someone to point me in the right direction to do this a little more efficiently.  What I have WORKS.  I want to refactor please.</p>\n\n<p>Thanks for looking.</p>\n\n<p>-B</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":81,"score":2,"question_id":12607134,"title":"SQL - Create \"virtual\" column based on data from other columns","body":"<p>I have a some issues with a SQL query I'm working on, I'm sorry that I don't have any work-in-progress to show because nothing that I have tried until now have worked out too well, so I am hoping that someone will be able to point me in the right direction.</p>\n\n<p><strong>Tables:</strong></p>\n\n<p>Computers:</p>\n\n<pre><code>[SN][PN][ComputerName][Model][OS][Architecture][RAM][CPU]\n</code></pre>\n\n<p>Logons: </p>\n\n<pre><code>[SN][Username][Timestamp]\n</code></pre>\n\n<p><strong>Info:</strong></p>\n\n<p>It works this way, every time a user logs on to a computer the computer info gets updated to the computer table and the username and timestamp gets inserted to the logons table.</p>\n\n<p><strong>Result</strong></p>\n\n<p>The result I am trying to acheive is the following:</p>\n\n<pre><code>[SN][PN][ComputerName][Model][OS][Architecture][RAM][CPU]**[Primary User]**\n</code></pre>\n\n<p>It should be only one row for each computer</p>\n\n<p>The Primary User field should be based from the 5 latest logons and being the username with the most recurrences in those 5.</p>\n\n<p>So I think that wraps It up, I hope someone here is able to at least point me in the right direction as every result google have to offer now show up as red.</p>\n"},{"tags":["tsql","casting","integer","isnumeric"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3084,"score":1,"question_id":10517777,"title":"T-sql - determine if value is integer","body":"<p>I want to determine if a value is integer (like <code>TryParse</code> in .NET). Unfortunatelly <code>ISNUMERIC</code> does not fit me because I want to parse only integers and not every kind of number. Is there such thing as <code>ISINT</code> or something?</p>\n\n<p>Here is some code to make things clear. If <code>MY_FIELD</code> is not int, this code would fail:</p>\n\n<pre><code>SELECT @MY_VAR = CAST(MY_FIELD AS INT)\nFROM MY_TABLE\nWHERE MY_OTHER_FIELD = 'MY_FILTER'\n</code></pre>\n\n<p>Thank you</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":25,"score":1,"question_id":12604379,"title":"Get total count per ID change","body":"<p>how can I get a total count of sheets per change of sheet</p>\n\n<p>example:</p>\n\n<pre><code>select sheetID,\n       ..\nfrom SomeTable\n</code></pre>\n\n<p>results look something like this:</p>\n\n<pre><code>sheetID\n-----------\n1000\n1000\n1000\n1000\n3000\n3000\n3000\n</code></pre>\n\n<p>so I want something like this:</p>\n\n<pre><code>select sheetID,\n       count(sheetID) as TotalsheetCount\nfrom SomeTable\n</code></pre>\n\n<p>I just don't know how to break the count up per change of sheetID.</p>\n\n<p>So I'd end up with this essentially:</p>\n\n<pre><code>sheetID   TotalsheetCount\n--------  -----------\n1000          4\n1000          4\n1000          4\n1000          4\n3000          3\n3000          3\n3000          3\n</code></pre>\n\n<p>so 4 is because there are 4 1000s, 3 because there are 3 3000s.  I am wanting to repeat the total count for that sheetID for each row, even though it's repeating, I want to provide that.</p>\n\n<p>UPDATE, here's what I did per the replies but I'm getting way too many results now as compoared to the count where I did not add that partition count before</p>\n\n<pre><code>   select MainTable.sheetID,\n           COUNT(SomeTable.sheetID)OVER(PARTITION BY SomeTable.sheetID) AS TotalSheetCount\n           table2.SomeField1,\n           table2.SomeField1\n    from MainTable\n        join (select distinct Sales.SalesKey from SomeLongTableName_Sales) sales on sales.SheetKey = MainTable.sheetKey\n        left outer join Site on MainTable.SiteKey = Site.SiteKey\n        join Calendar on sales.Date &gt;= Calendar.StartDate\n             and sales.Date &lt; Calendar.EndDate\n        group by SomeTable.sheetID\n</code></pre>\n\n<p>the joins and stuff is more realistic to my real query but formatted for this post to hide real field and table names.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":59,"score":2,"question_id":12604146,"title":"SQL Join on Table A value within Table B range","body":"<p>I have two tables that can be seen in accompanying image.</p>\n\n<p><em>Table A</em> contains <strong>Department</strong>, <strong>Month</strong> and <strong>Average</strong>.</p>\n\n<p><em>Table B</em> contains <strong>Month</strong>, <strong>Year</strong>, <strong>RangeStart</strong>, <strong>RangeEnd</strong> and <strong>Colour</strong>.</p>\n\n<p>If you look at the screen shot of <em>Table B</em>, you will see for each Month you have a Green, Yellow, Orange and Red value. You also have a range.</p>\n\n<p><strong>What I need.........</strong></p>\n\n<p>I need a new column on <em>Table A</em> named 'Colour'. In this column, I need either Green, Yellow, Orange or Red. The deciding factor on which colour is assigned to the month will be the 'Average' column.</p>\n\n<p>For example:</p>\n\n<p>DepartmentA for May's Average is equal to <code>0.96</code>\nUpon referencing <em>Table B</em>, I can see that line 8, <code>0.75+</code> will be the range this fits into. Therefore Red is the colour I want placed in <em>table A</em> next to Mays average.</p>\n\n<p>I have left RangeEnd for the highest range per month as NULL as it is basically <code>75+</code>, anything greater than <code>0.75</code> slots in here.</p>\n\n<p>Can anyone point me in the right direction that is not too time consuming.</p>\n\n<p><img src=\"http://i.stack.imgur.com/g6zLd.png\" alt=\"enter image description here\"></p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":12591758,"title":"Sum up items between setup of custom times","body":"<p>We need to count the number of items that occur 10 minutes before and 10 minutes after the hour, by day. We have a table that tracks the items individually. Ideally i would like to have the output be something like the below, but and totally open to other suggestions.</p>\n\n<pre><code>Table - Attendance\nAtt_item    timestamp\n1       2012-09-12 18:08:00\n2       2012-09-01 23:26:00\n3       2012-09-23 09:33:00\n4       2012-09-11 09:43:00\n5       2012-09-06 05:57:00\n6       2012-09-17 19:26:00\n7       2012-09-06 10:51:00\n8       2012-09-19 09:42:00\n9       2012-09-06 13:55:00\n10      2012-09-05 07:26:00\n11      2012-09-02 03:08:00\n12      2012-09-19 12:17:00\n13      2012-09-12 18:14:00\n14      2012-09-12 18:14:00\n\nOutput\nDate        Timeslot_5pm  Timeslot_6pm    Timeslot_7pm\n9/11/2012        11           22              22\n9/12/2012        30           21              55\n9/13/2012        44           33              44\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":1,"view_count":381,"score":2,"question_id":9349336,"title":"Merge Rows in SQL Server 2008","body":"<p>I have a table like the one below:</p>\n\n<pre>\nCustomer   |Type     |Count\nJoe        |Silver-S |1\nJoe        |Silver   |7\nJoe        |Gold     |3\nJoe        |Gold-S   |2\n</pre>\n\n<p>I need to merge this so that it looks like the following:</p>\n\n<pre>\nCustomer   |Type     |Count\nJoe        |Silver   |8\nJoe        |Gold     |5\n</pre>\n\n<p>Help!</p>\n"},{"tags":["sql","sql-server-2008","tsql","summary"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":38,"score":4,"question_id":12601708,"title":"Generate summary data based on configuration table in SQL Server","body":"<p>I'm trying to generate a summary from a list of scores in SQL Server 2008.<br>\nI have two tables: <a href=\"http://sqlfiddle.com/#!3/85314\" rel=\"nofollow\"><strong>SQL Fiddle link</strong></a></p>\n\n<p>The <code>ScorePerson</code> table contains people's ID and their score from -5 to 15.  End users of my SQL/Stored Procedure needs to create a summary like this:</p>\n\n<pre><code>Scoreband| TotalNoOfPeople | AvgScore\n--------------------------------\n-5 to 0  | 2               | -2\n0 to 5   | 3               |  2\n5 to 10  | 2               |  8\n10 to 15 | 3               | 13.3\n</code></pre>\n\n<p>The score band i.e. the min and max values should be configurable from the <code>ScoreMinMax</code> table by the end user.</p>\n\n<p>I have tried to achive this using CASE stement, but it generates the summary as columns.  I I would probably need to pivot it or use UNION from multiple select statements.  But this approach doesn't seem scalable if there were new rows added to the <code>ScoreMinMax</code> table.\nSo far I was able to achieve some results similar to the example above using CROSS JOINT, but it doesn't always produces the correct results.</p>\n\n<p>Is anyone able to point me in the right direction on how to achieve this please?</p>\n\n<p><a href=\"http://sqlfiddle.com/#!3/85314\" rel=\"nofollow\"><strong>SQL Fiddle link</strong></a></p>\n\n<pre><code>ScorePerson - contains actual scores\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/rayEl.png\" alt=\"Table screenshot\"></p>\n\n<pre><code>ScoreMinMax - the configuration for min and max score bands\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/IKS7M.png\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":104,"score":2,"question_id":12585713,"title":"Update value from previous row value using CTE","body":"<p>This question is a variation of my older question <a href=\"http://stackoverflow.com/questions/11785805/update-null-column-value-from-non-null-value-in-previous-row\">here</a>. I hope to explain the problem using an example. So</p>\n\n<p><strong>Sample Data</strong><br>\nHere is sample data to work with:</p>\n\n<pre><code>DECLARE @Test TABLE (GID      int,             Seq     int, \n                     IsLive   bit,             Eff     date, \n                     Name     varchar(50),     Salary  decimal) \n\nINSERT INTO @Test VALUES (1, 1, 1, '01-08-2012', 'RTS', NULL)\nINSERT INTO @Test VALUES (1, 2, 0, '01-09-2012', 'RTA', NULL)\nINSERT INTO @Test VALUES (1, 3, 1, '01-10-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (1, 4, 0, '01-11-2012',  NULL, NULL)\nINSERT INTO @Test VALUES (1, 5, 1, '01-12-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (2, 1, 1, '01-08-2012', 'RTS', NULL)\nINSERT INTO @Test VALUES (2, 2, 0, '01-09-2012', 'RTA', NULL)\nINSERT INTO @Test VALUES (2, 3, 1, '01-10-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (2, 4, 0, '01-11-2012', 'GSM', NULL)\nINSERT INTO @Test VALUES (2, 5, 1, '01-12-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (3, 1, 1, '01-01-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (3, 2, 0, '01-02-2012', NULL, NULL)\nINSERT INTO @Test VALUES (4, 1, 1, '01-01-2012', NULL, NULL)\nINSERT INTO @Test VALUES (4, 2, 0, '01-02-2012', 'FSA', NULL)\nINSERT INTO @Test VALUES (4, 3, 0, '01-03-2012', NULL, NULL)\nINSERT INTO @Test VALUES (5, 1, 0, '01-01-2012', NULL, NULL)\nINSERT INTO @Test VALUES (5, 2, 1, '01-02-2012', 'LSI', NULL)\nINSERT INTO @Test VALUES (5, 3, 0, '01-03-2012', NULL, NULL)\nINSERT INTO @Test VALUES (6, 1, 1, '01-01-2012', NULL, NULL)\nINSERT INTO @Test VALUES (6, 2, 0, '01-02-2012', 'LSI', NULL)\nINSERT INTO @Test VALUES (6, 3, 1, '01-03-2012', NULL, NULL)\n\nSELECT * FROM @Test\n</code></pre>\n\n<p><strong>Following, are two <em>sample result sets</em>.  Although the snippet shows <em>inserts</em> the point is to show what acceptable <em>output set</em> would look like:</strong></p>\n\n<p><strong>Sample Output #1</strong><br>\nIn the data set below when a row has <code>IsLive=0</code> then the value from its columns must over write the value of the same columns on the rows where <code>IsLive=1</code> below it skipping NULL values. Ignore any <code>IsLive=1</code> rows before the first <code>IsLive=0</code> row.</p>\n\n<pre><code>    INSERT INTO @Test VALUES (1, 1, 1, '01-08-2012', 'RTS', NULL)\n    INSERT INTO @Test VALUES (1, 2, 0, '01-09-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (1, 3, 1, '01-10-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (1, 4, 0, '01-11-2012',  NULL, NULL)\n    INSERT INTO @Test VALUES (1, 5, 1, '01-12-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 1, 1, '01-08-2012', 'RTS', NULL)\n    INSERT INTO @Test VALUES (2, 2, 0, '01-09-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 3, 1, '01-10-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 4, 0, '01-11-2012', 'GSM', NULL)\n    INSERT INTO @Test VALUES (2, 5, 1, '01-12-2012', 'GSM', NULL)\n    INSERT INTO @Test VALUES (3, 1, 1, '01-01-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (3, 2, 0, '01-02-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (4, 1, 1, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (4, 2, 0, '01-02-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (4, 3, 0, '01-03-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (5, 1, 0, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (5, 2, 1, '01-02-2012', 'LSI', NULL)\n    INSERT INTO @Test VALUES (5, 3, 0, '01-03-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (6, 1, 1, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (6, 2, 0, '01-02-2012', 'LSI', NULL)\n    INSERT INTO @Test VALUES (6, 3, 1, '01-03-2012', 'LSI', NULL)\n\n    SELECT * FROM @Test AS FakedOutput_1\n</code></pre>\n\n<p><strong>Sample Output #2</strong><br>\nIn the data set below when a row has <code>IsLive=0</code> then the value from its columns must over write the value of the same columns on the rows where <code>IsLive=1</code> below it. Columns with NULL values take the value from the previous row.</p>\n\n<pre><code>    INSERT INTO @Test VALUES (1, 1, 1, '01-08-2012', 'RTS', NULL)\n    INSERT INTO @Test VALUES (1, 2, 0, '01-09-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (1, 3, 1, '01-10-2012', 'RTA', NULL)\n    -- &lt;- the following row is different from prev\n    INSERT INTO @Test VALUES (1, 4, 0, '01-11-2012', 'RTA', NULL) \n    INSERT INTO @Test VALUES (1, 5, 1, '01-12-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 1, 1, '01-08-2012', 'RTS', NULL)\n    INSERT INTO @Test VALUES (2, 2, 0, '01-09-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 3, 1, '01-10-2012', 'RTA', NULL)\n    INSERT INTO @Test VALUES (2, 4, 0, '01-11-2012', 'GSM', NULL)\n    INSERT INTO @Test VALUES (2, 5, 1, '01-12-2012', 'GSM', NULL)\n    INSERT INTO @Test VALUES (3, 1, 1, '01-01-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (3, 2, 0, '01-02-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (4, 1, 1, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (4, 2, 0, '01-02-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (4, 3, 0, '01-03-2012', 'FSA', NULL)\n    INSERT INTO @Test VALUES (5, 1, 0, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (5, 2, 1, '01-02-2012', 'LSI', NULL)\n    INSERT INTO @Test VALUES (5, 3, 0, '01-03-2012', 'LSI', NULL)\n    INSERT INTO @Test VALUES (6, 1, 1, '01-01-2012', NULL, NULL)\n    INSERT INTO @Test VALUES (6, 2, 0, '01-02-2012', 'LSI', NULL)\n    INSERT INTO @Test VALUES (6, 3, 1, '01-03-2012', 'LSI', NULL)\n\n    SELECT * FROM @Test AS FakedOutput_2\n</code></pre>\n\n<p><strong>Attempted Solution</strong><br>\nHere is what I have come up with so far, but it fails my first test case (<code>GID=1</code>)</p>\n\n<pre><code>;WITH CTE AS ( \n    -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \n    SELECT  T.GID, T.SEQ, T.IsLive, NULL cGuid, NULL cSEQ, \n            cast(0 as bit) cIsLive, T.Name, T.Salary \n    FROM    @Test T\n    JOIN    @Test S ON T.GID = S.GID AND T.Seq = S.Seq AND S.IsLive = 0\n    -- - - - - - - \n      UNION ALL \n    -- - - - - - - \n    SELECT  t.GID, t.SEQ, T.IsLive, c.GID cGID, c.Seq cSEQ, \n             c.IsLive cIsLive, ISNULL(C.Name, T.Name), \n             ISNULL(t.Salary, c.Salary) \n    FROM    CTE c \n    JOIN    @Test t ON    t.GID     = c.GID   AND \n                          t.Seq     &gt; c.Seq   AND \n                          t.IsLive  = 1       AND \n                          c.IsLive  = 0\n    -- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \n) \n--SELECT * FROM CTE ORDER BY CTE.GID, CTE.Seq\nUPDATE  t \nSET     Name = c.Name, Salary = c.Salary\nFROM    @Test t \nJOIN    CTE c     ON c.GID = t.GID AND c.Seq = t.SEQ\nWHERE   C.cIsLive IS NOT NULL\n</code></pre>\n"},{"tags":["arrays","tsql","cursor"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12598848,"title":"Table Column as Array in T-SQL","body":"<p>Instead of traversing a table using a cursor, I'd like to populate an ARRAY with the table column data and then rather traverse the T-SQL array for my calculations or whatever, using something like \"while not end-of-file do something\".  I feel this will minimize disk usage and be much more efficient.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":58,"score":3,"question_id":12599141,"title":"Sql timestamp for created/updated dates","body":"<p>In a few logging tables that are frequently written to, I'd like to be able to store a relative order so that I can union between these tables, and get the order that things actually occurred in. </p>\n\n<p>DateTime2's resolution is lacking. Several rows will get the exact same date, so there is no way to tell which happened first. \nBecause sorting should work across several tables, sorting by Id is out. </p>\n\n<p>Then I started looking at timestamp. This works for updated dates, but it does not work for created dates, because you can only have one timestamp column per table, and it automatically updates. </p>\n\n<p>This is for Microsoft Sql Server 2008. </p>\n\n<p>Any suggestions? </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":22,"score":1,"question_id":12598529,"title":"How to include distinct count in one result set","body":"<p>Is it possible to have a optimize single query statement which will return the count distinct of rows? See below:</p>\n\n<pre><code>create table #tbl (id int, name varchar(30))\ngo\nINSERT INTO #tbl (id, name) values(1, 'test1')\nINSERT INTO #tbl (id, name) values(2, 'test2')\nINSERT INTO #tbl (id, name) values(1, 'test3')\nINSERT INTO #tbl (id, name) values(1, 'test4')\nINSERT INTO #tbl (id, name) values(3, 'test5')\nINSERT INTO #tbl (id, name) values(1, 'test6')\nINSERT INTO #tbl (id, name) values(1, 'test7')\nINSERT INTO #tbl (id, name) values(2, 'test8')\nINSERT INTO #tbl (id, name) values(1, 'test9')\n</code></pre>\n\n<p>I want to return a record below:</p>\n\n<pre><code>id      name\n---     ----\n3       test1\n3       test2\n3       test3\n3       test4\n3       test5\n3       test6\n3       test7\n3       test8\n3       test9\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","audit"],"answer_count":3,"favorite_count":2,"up_vote_count":1,"down_vote_count":1,"view_count":360,"score":0,"question_id":7859443,"title":"Best practice for auditing data in SQL Server and retrieving point in time data","body":"<p>I,ve been doing history tables for some time now in databases but never put to much effort or thought into it. I wonder what is the best practice out there.</p>\n\n<p>my main goal is to record any changes to a record for a particular day. If more than one change happens in a day then then only one history record will exist. I need to record the date the record was changed also as when I retrieve data I need to pull the correct correct from history as it was at a particular time. So for example I have a customers table and what to pull out what their address was for a particular date. My Sprocs like get Cust details will take in an optional date and if no date is passed in then it returns the most recent record.</p>\n\n<p>So heres what I was looking for advice on... and anything else.</p>\n\n<p>Do I keep the history table in the same table and use a logical delete flag to hide the historial ones. I normally dont do this as some tables can change a lot and have lots of records. Do I use a seperate table that mirrors the main table. I usally do this Should I only put change records into the history table and not the current one. What is the most efficent way given a date to pull out the right record at a point in time... get every record for a customer &lt;= date passed in and then sort by most recent date and take the top.</p>\n\n<p>Thanks for all the help... regards M</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":64,"score":2,"question_id":12596522,"title":"How do I get multiple rows when value > 1","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/8679067/select-records-multiple-times-from-table\">Select Records multiple times from table</a>  </p>\n</blockquote>\n\n\n\n<p>I want to have my query return (multiple) rows for the value of TABLE_B.QTY.</p>\n\n<pre><code>TABLE A\nSALESNR  ITEMNR LINENR\n100      B2001  1\n101      B2002  2\n102      A1021  3 \n\nTABLE B \nLINENR   COLOR QTY\n1        WHITE  3  \n2        BLACK  1\n3        BROWN  8\n</code></pre>\n\n<p>For instance, with the following query:</p>\n\n<pre><code>SELECT    TABLE_A.SALESNR, TABLE_A.ITEMNR, TABLE_B.COLOR, TABLE_B.QTY\nFROM       TABLE_A  INNER JOIN TABLE_B ON TABLE_B.LINENR = TABLE_A.LINENR\n</code></pre>\n\n<p>I get:</p>\n\n<pre><code>100    B2001   White   3\n</code></pre>\n\n<p>What I need is:</p>\n\n<pre><code>100    B2001   White   3\n100    B2001   White   3\n100    B2001   White   3\n</code></pre>\n\n<p>Is there a way to do this?\nCan't think of the right keywords to Google this...</p>\n\n<p>Thnx,</p>\n\n<p>Mike</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":41,"score":5,"question_id":12581841,"title":"SQL Tree find anscestors at a specific level","body":"<p>Say I have the following tree:</p>\n\n<pre><code>CREATE TABLE Tree(Id int, ParentId int, Name varchar(20), Level int)\n\nINSERT INTO Tree(Id, ParentId, Name, Level)\nSELECT 1, NULL, 'Bob', 0 UNION ALL \nSELECT 2, 1, 'John', 1 UNION ALL\nSELECT 3, 1, 'Bill', 1 UNION ALL\nSELECT 4, 3, 'Peter', 2 UNION ALL\nSELECT 5, 4, 'Sarah', 3\n</code></pre>\n\n<p>I need a script to find the ancestor of a given node at a specific level:</p>\n\n<p>For example the ancestor of Sarah at level 2 is Peter, and the ancestor of Peter at level 0 is Bob. </p>\n\n<p>Is there an easy way to do this using a hierarchical CTE? <a href=\"http://sqlfiddle.com/#!3/b0572\" rel=\"nofollow\">sqlfiddle</a></p>\n"},{"tags":["sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12582220,"title":"Concatenate columns together, columns can be null","body":"<p>I need to bring values together and copy it to a diffrent column.</p>\n\n<pre><code>COLUMN 1 | COLUMN 2 |  COLUMN 3 | COLUMN 4 \nHallo      out         there      Hallo out there\nMy         NULL        name is    My name is\nI'm        a           rabbit     I'm a rabbit\n</code></pre>\n\n<p>How to merge column 1, 2, 3 and copy it to column4 separated with space.</p>\n\n<p>Columns can be null.</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":63,"score":1,"question_id":12593420,"title":"Update SQL variable when recordset is empty","body":"<p>We have a loop in SQL Server 2005 that loops around on a table getting each items parent until it gets to the top of the tree:</p>\n\n<pre><code>DECLARE @T Table\n(\n  ItemID INT NOT NULL PRIMARY KEY,\n  AncestorID INT NULL \n)\n</code></pre>\n\n<p>Which has data like this:</p>\n\n<pre><code>ItemID | AncestorID\n  1          2\n  2          3\n  3          4\n  4          NULL\n</code></pre>\n\n<p>We have a loop that basically does this:</p>\n\n<pre><code>DECLARE @AncestorID INT\nSELECT @AncestorID = 1\nWHILE (@AncestorID IS NOT NULL)\nBEGIN   \n  --Do some work   \n  SELECT @AncestorID = T.AncestorID   \n  FROM @T t  \n  WHERE T.ItemID = @AncestorID\n\n  print @AncestorID\nEND\n</code></pre>\n\n<p>(Yes I know SQL is set based, and this is processing row by row, the \"Do some work\" needs to be done line by line for a reason).</p>\n\n<p>This has always worked fine until today when we ended up in an endless loop. Turns out the cause was some wrong data:</p>\n\n<pre><code>ItemID | AncestorID\n  1          2\n  2          3\n\n  4          NULL\n</code></pre>\n\n<p><code>ItemID</code> 3 was deleted. The loop now never ends because <code>AncestorID</code> is never <code>NULL</code> - it stays at 3.</p>\n\n<p>Is there anyway to rewrite the select statement to make <code>@AncestorID</code> null if the <code>SELECT</code> query returns 0 rows, or do I need to have a separate <code>SELECT</code> statement to count the records and some <code>IF ELSE</code> type logic?</p>\n"},{"tags":["sql","tsql","csv","sqlcmd","sql-agent-job"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":218,"score":0,"question_id":12567410,"title":"I need best practice in T-SQL Export data to CSV (with header)","body":"<p><strong>What I need to do is export data into CSV file using T-SQL.</strong></p>\n\n<p>And I'm very confuse about there are many ways can do it, I don't know to choose which one, please help me to confirm the bollowing:</p>\n\n<p>As I know there are about 3 methods, and I want you help me to confirm:</p>\n\n<h2>Using Microsoft.Jet.OLEDB.4.0, like this:</h2>\n\n<pre><code>INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0',\n                       'Text;Database=C:\\Temp\\;HDR=Yes;',\n                       'SELECT * FROM test.csv')\n            (object_id, name)\nSELECT object_id, name\n  FROM sys.tables;\n</code></pre>\n\n<p><strong>but this need the csv file is there, and with header</strong></p>\n\n<h2>using SQLCMD</h2>\n\n<p>command line. </p>\n\n<h2>using BCP</h2>\n\n<p>Use union, get data and it's column header. </p>\n\n<p>This is all my understanding about T-SQL export to CSV, please help me to confirm.</p>\n\n<p>Is there other way to export to CSV? </p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-ce"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":12580080,"title":"How to export SQL Server 2005 tables to SQL Server Compact database ","body":"<p>I don't know if this is a newbie question or not, I want to export some tables from \"full\" SQL Server 2005 database to a SQL Server Compact Edition database through a CLR stored procedure.</p>\n\n<p>I know it is possible through SSIS.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":8,"down_vote_count":0,"view_count":9854,"score":8,"question_id":312861,"title":"Pivot using SQL Server 2000","body":"<p>I need some urgent help! I put together a sample scenario of my issue and I hope its enough for someone to point me in the right direction.</p>\n\n<p>I have two tables</p>\n\n<p>Products</p>\n\n<p><img src=\"http://img407.imageshack.us/img407/1166/productsyz4.gif\" alt=\"alt text\" /></p>\n\n<p>Product Meta</p>\n\n<p><img src=\"http://img293.imageshack.us/img293/8945/metqz0.gif\" alt=\"alt text\" /></p>\n\n<p>I need a result set of the following</p>\n\n<p><img src=\"http://img407.imageshack.us/img407/8174/resultmp6.gif\" alt=\"alt text\" /></p>\n"},{"tags":[".net","sql-server","tsql","sqlclr"],"answer_count":10,"favorite_count":4,"up_vote_count":11,"down_vote_count":0,"view_count":3056,"score":11,"question_id":58190,"title":"Are CLR stored procedures preferred over TSQL stored procedures in SQL 2005+?","body":"<p>My current view is no, prefer Transact SQL stored procedures because they are a lighter weight and (possibly) higher performing option, while CLR procedures allow developers to get up to all sorts of mischief.</p>\n\n<p>However recently I have needed to debug some very poorly written TSQL stored procs.  As usual I found many of the problems due to the original developer developer having no real TSQL experience, they were  ASP.NET / C# focused.</p>\n\n<p>So, using CLR procedures would firstly provide a much more familiar toolset to this type of developer, and secondly, the debugging and testing facilities are more powerful (ie Visual Studio instead of SQL Management Studio).  </p>\n\n<p>I'd be very interested in hearing your experience as it's seems it is not a simple choice. </p>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":93,"score":0,"question_id":12589963,"title":"T-SQL Query against previous queries results","body":"<p>I'm having a hard time searching the internet for this, so thought I would ask the T-SQL question here.  I have a table called CUST.  CUST contains customer entrydate, name, company, address, email, among other things.  I wrote a simple query to find new customers based off entrydate;</p>\n\n<pre><code>Select * from CUST WHERE ENTRYDATE between '2012-08-01' and '2012-08-30'\n</code></pre>\n\n<p>This works great, except I found a problem.  When our webstore creates new orders, if the customer details don't match EXACTLY, a new customer is created.  That being the case, I want to take my original results, and trim the results set if I have more than one occurrence of cust.firstname + cust.lastname + cust.company.  I can write these in individual queries, just unsure how to do this in a single sql script.</p>\n\n<p>I thought about doing a join on name back to the table, and while the join doesn't error, I don't know how to count the occurrences, I was thinking of counting customer numbers.</p>\n\n<p>My join looks like this (stripped out the group by and column selection to make it easier to read;</p>\n\n<pre><code>from CUST\n    Right Outer Join \n    (\n    select *\n    from CUST \n    WHERE ENTRYDATE between '2012-08-01' and '2012-08-30'\n            AND LTRIM(RTRIM(Firstname + Lastname + Company)) &lt;&gt; ''\n    Group By *     \n    ) as newcs\n\n    on LTRIM(RTRIM(CUST.Firstname + CUST.Lastname + CUST.Company)) = LTRIM(RTRIM(newcs.Firstname + newcs.Lastname + newcs.Company))\n</code></pre>\n\n<p>Any suggestions?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":91,"score":0,"question_id":12588865,"title":"simplifying query that has multiple WITH and multiple subqueries","body":"<p>It is bothering me that for a simple query, I have to write out so many sub-selects and WITH statements. </p>\n\n<p>The question is: <strong>are there basic guidelines on how to simplify queries that have subqueries</strong>?</p>\n\n<p>Here's my query:</p>\n\n<pre><code>WITH cte_min\n     AS (SELECT a.client_id,\n                a.specimen_source,\n                a.received_date\n         FROM   f_accession_daily a\n                JOIN (SELECT DISTINCT f.client_id,\n                                      f.received_date,\n                                      f.accession_daily_key\n                      FROM   F_ACCESSION_DAILY f\n                             JOIN (SELECT CLIENT_ID,\n                                          Min(received_date) MinRecDate\n                                   FROM   F_ACCESSION_DAILY\n                                   GROUP  BY CLIENT_ID) i\n                               ON f.CLIENT_ID = i.CLIENT_ID\n                                  AND f.RECEIVED_DATE = i.MinRecDate) b\n                  ON a.ACCESSION_DAILY_KEY = b.ACCESSION_DAILY_KEY),\n     cte_max\n     AS (SELECT a.client_id,\n                a.specimen_source,\n                a.received_date\n         FROM   f_accession_daily a\n                JOIN (SELECT DISTINCT f.client_id,\n                                      f.received_date,\n                                      f.accession_daily_key\n                      FROM   F_ACCESSION_DAILY f\n                             JOIN (SELECT CLIENT_ID,\n                                          Max(received_date) MaxRecDate\n                                   FROM   F_ACCESSION_DAILY\n                                   GROUP  BY CLIENT_ID) i\n                               ON f.CLIENT_ID = i.CLIENT_ID\n                                  AND f.RECEIVED_DATE = i.MaxRecDate) b\n                  ON a.ACCESSION_DAILY_KEY = b.ACCESSION_DAILY_KEY),\n     cte_est\n     AS (SELECT DISTINCT client_id,\n                         MLIS_DATE_ESTABLISHED\n         FROM   D_CLIENT\n         WHERE  REC_ACTIVE_FLG = 1\n                AND MLIS_DATE_ESTABLISHED IS NOT NULL)\nSELECT DISTINCT f.client_id,\n                cmin.specimen_source,\n                cmin.received_date,\n                cmax.specimen_source,\n                cmax.received_date,\n                cest.MLIS_DATE_ESTABLISHED\nFROM   F_ACCESSION_DAILY f\n       LEFT JOIN cte_max cmax\n         ON cmax.CLIENT_ID = f.CLIENT_ID\n       LEFT JOIN cte_min cmin\n         ON cmin.CLIENT_ID = f.CLIENT_ID\n       LEFT JOIN cte_est cest\n         ON cest.CLIENT_ID = f.CLIENT_ID \n</code></pre>\n\n<p>I am not asking necessarily for you to do the simplification yourself (although I would be very grateful for this), rather I am asking for general guidelines/directions on re-writing this query to be more elegant.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":0,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":36,"score":0,"question_id":12590473,"title":"Is it possible to Send and Receive TCP/Socket messages using SQL","body":"<p>Quick question, is it possible to send and receive TCP/Socket message using SQL? If there is one would you mind providing some examples or maybe direct me to a post/website where I could this information.</p>\n\n<p>thank you</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":12585986,"title":"Sql Server error [SQLState 42000] (Error 325)","body":"<p>I have a script that utilizes the new Merge Output clause. I've run it in 3 different instances (all non-Production environments) and it works great. When I tried running it in our production environment, I get the error:</p>\n\n<blockquote>\n  <p>Executed as user: xxx\\xxx. Incorrect syntax near 'Merge'. You\n  may need to set the compatibility level of the current database to a\n  higher value to enable this feature. See help for the SET\n  COMPATIBILITY_LEVEL option of ALTER DATABASE. [SQLSTATE 42000] (Error\n  325)  Incorrect syntax near 'Merge'. You may need to set the\n  compatibility level of the current database to a higher value to\n  enable this feature. See help for the SET COMPATIBILITY_LEVEL option\n  of ALTER DATABASE. [SQLSTATE 42000] (Error 325).  The step failed.</p>\n</blockquote>\n\n<p>I've checked the versions of each instance and they are all 10.0.4000.0. All of the non-system databases are set to compatibility level 90 (2005), and system databases are set to 100 (2008). What else do I need to check to see where my production instance is different from the other non-Production instances?</p>\n\n<p>Here's the query:</p>\n\n<pre><code>Declare @user varchar(20),\n        @message varchar(max)\nSet     @user = 'ISS20120917-144'\n\nCreate Table #data\n(\n    CustomerEventID_Surrogate Int Identity (1,1) Not Null Primary Key,\n    CustomerNumber Int Not Null,\n    ConvictionEventID Int Not Null,\n    CustomerEventHierarchyID Int Not Null,\n    SanctionEventID Int Not Null,\n    ReferenceNumber varchar(40) Null,\n    ConvictionACDID Int Null,\n    State_Code varchar(2) Not Null,\n    County_ID Int Null,\n    CitationCDLHolderValueID Int Null,\n    Hazmat Bit Null,\n    CMV Bit Null,\n    PassengerEndorsement Bit Null,\n    OccurrenceDate DateTime Not Null,\n    ConvictionDate DateTime Not Null,\n    CourtOrder Bit Null\n)\n\nCreate Table #surrogatemap\n(\n    CustomerEventID_Surrogate Int Not Null,\n    NewCustomerEventID Int Not Null\n)\n\nCreate Table #surrogateHIDmap\n(\n    NewCustomerEventID Int Not Null,\n    NewHistoryEventDetailID Int Not Null\n)\n\nBegin Tran\n\nBegin Try\n    Insert Into #data\n    Select  ce.Cust_No,\n            ce.CustomerEventID,\n            ceh.CustomerEventHierarchyID,\n            ceSAN.CustomerEventID,\n            ce.ReferenceNumber,\n            hed.ACDID,\n            hed.State_Code,\n            hed.County_ID,\n            hed.CitationCDLHolderValueID,\n            hed.Hazmat,\n            hed.CMV,\n            hed.PassengerEndorsement,\n            hed.OccurrenceDate,\n            Case    When cd.ConvictionDate IS NOT NULL Then cd.ConvictionDate\n                    Else hed.OccurrenceDate\n            End As [ConvictionDate],\n            hed.CourtOrder\n    From IADS..CustomerEvent ce\n    Inner Join IADS..HistoryEventDetail hed On hed.CustomerEventID = ce.CustomerEventID\n        And hed.EndDate IS NULL\n    Inner Join IADS..CustomerEventCode cec On cec.CustomerEventCodeID = hed.CustomerEventCodeID\n        And cec.CustomerEventCodeID &lt;&gt; -51\n    Left Outer Join IADS..ConvictionDetail cd On cd.HistoryEventDetailID = hed.HistoryEventDetailID\n    Inner Join IADS..CustomerEventHierarchy ceh On ceh.CustomerEventID = ce.CustomerEventID\n        And ceh.EndDate IS NULL\n    Inner Join IADS..CustomerEvent ceSAN On ceSAN.CustomerEventID = ceh.RelatedCustomerEventID\n        And ceSAN.CustomerEventDispositionID IS NULL\n    Inner Join IADS..CustomerSanctionDetail csd On csd.CustomerEventID = ceSAN.CustomerEventID\n        And csd.SanctionDiscardedReasonID IS NULL\n    Inner Join IADS..SanctionReasonCode src On src.SanctionReasonCodeID = csd.SanctionReasonCodeID\n        And src.SanctionReasonCodeID = -320\n    Where ce.CustomerEventDispositionID IS NULL\n\n    Merge Into IADS..CustomerEvent\n        Using #data As src On 1 = 0\n    When Not Matched Then\n    Insert\n    (\n        CustomerEventCategoryID,\n        Cust_No,\n        ReferenceNumber,\n        CreatedBy,\n        CreatedDate,\n        UpdatedBy,\n        UpdatedDate\n    )\n    Values\n    (\n        -2,\n        src.CustomerNumber,\n        src.ReferenceNumber,\n        @user,\n        GetDate(),\n        @user,\n        GetDate()\n    )\n    Output\n        src.CustomerEventID_Surrogate,\n        inserted.CustomerEventID\n    Into #surrogatemap;\n\n    Select  sm.NewCustomerEventID,\n        -8 As [HistoryEventTypeID],\n        -51 As [CustomerEventCodeID],\n        131 As [ACDID],\n        d.State_Code,\n        d.County_ID,\n        d.CitationCDLHolderValueID,\n        d.OccurrenceDate,\n        d.ConvictionDate,\n        d.Hazmat,\n        d.CMV,\n        d.CourtOrder,\n        GETDATE() As [EffectiveDate],\n        @user As [UpdatedBy],\n        GETDATE() As [UpdatedDate],\n        d.ConvictionACDID,\n        d.PassengerEndorsement\n    Into    #hiddata\n    From    #data d\n    Inner Join #surrogatemap sm On sm.CustomerEventID_Surrogate = d.CustomerEventID_Surrogate\n\n    Merge Into IADS..HistoryEventDetail\n        Using #hiddata As src On 1 = 0\n    When Not Matched Then\n    Insert\n    (\n        CustomerEventID,\n        HistoryEventTypeID,\n        CustomerEventCodeID,\n        ACDID,\n        State_Code,\n        County_ID,\n        CitationCDLHolderValueID,\n        OccurrenceDate,\n        Hazmat,\n        CMV,\n        CourtOrder,\n        EffectiveDate,\n        UpdatedBy,\n        UpdatedDate,\n        UnderlyingACDID,\n        PassengerEndorsement\n    )\n    Values\n    (\n        src.NewCustomerEventID,\n        src.HistoryEventTypeID,\n        src.CustomerEventCodeID,\n        src.ACDID,\n        src.State_Code,\n        src.County_ID,\n        src.CitationCDLHolderValueID,\n        src.OccurrenceDate,\n        src.Hazmat,\n        src.CMV,\n        src.CourtOrder,\n        src.EffectiveDate,\n        src.UpdatedBy,\n        src.UpdatedDate,\n        src.ConvictionACDID,\n        src.PassengerEndorsement\n    )\n    Output\n        src.NewCustomerEventID,\n        inserted.HistoryEventDetailID\n    Into #surrogateHIDmap;\n\n    Insert Into IADS..CustomerEventHierarchy\n    (\n        CustomerEventID,\n        RelatedCustomerEventID,\n        EffectiveDate,\n        UpdatedBy,\n        UpdatedDate\n    )\n    Select  sm.NewCustomerEventID,\n            d.SanctionEventID,\n            GETDATE(),\n            @user,\n            GETDATE()\n    From    #data d\n    Inner Join #surrogatemap sm On sm.CustomerEventID_Surrogate = d.CustomerEventID_Surrogate\n\n    Insert Into IADS..CourtFineDetail\n    (\n        HistoryEventDetailID,\n        ConvictionDate\n    )\n    Select  s.NewHistoryEventDetailID,\n            d.ConvictionDate\n    From  #hiddata d\n    Inner Join #surrogateHIDmap s On s.NewCustomerEventID = d.NewCustomerEventID\n\n    -- Remove the tie to the SUS077\n    Update IADS..CustomerEventHierarchy\n    Set     EndDate = GETDATE(),\n            UpdatedBy = @user,\n            UpdatedDate = GETDATE()\n    Where   CustomerEventHierarchyID In (Select CustomerEventHierarchyID From #data)\n\n    -- Build temp table containing the records that have already purged\n    Select  ce.Cust_No,\n            ce.CustomerEventID,\n            ceh.CustomerEventHierarchyID\n    Into    #disposedRecords\n    From    IADS..CustomerEvent ce\n    Inner Join IADS..HistoryEventDetail hed On hed.CustomerEventID = ce.CustomerEventID\n        And hed.EndDate IS NULL\n    Inner Join IADS..CustomerEventCode cec On cec.CustomerEventCodeID = hed.CustomerEventCodeID\n        And hed.CustomerEventCodeID &lt;&gt; -51\n    Inner Join IADS..CustomerEventHierarchy ceh On ceh.CustomerEventID = ce.CustomerEventID\n        And ceh.EndDate IS NULL\n    Inner Join IADS..CustomerEvent ceSAN On ceSAN.CustomerEventID = ceh.RelatedCustomerEventID\n        And ceSAN.CustomerEventDispositionID IS NOT NULL\n    Inner Join IADS..CustomerSanctionDetail csd On csd.CustomerEventID = ceSAN.CustomerEventID\n        And csd.SanctionReasonCodeID = -320\n    Where   ce.CustomerEventDispositionID IS NOT NULL\n    Order By ce.CustomerEventDispositionDate Desc\n\n    -- Un-purge all of the records that were previously tied to a SUS077\n    Update  IADS..CustomerEvent\n    Set     CustomerEventDispositionID = Null,\n            CustomerEventDispositionComment = Null,\n            CustomerEventDispositionDate = Null,\n            UpdatedBy = @user,\n            UpdatedDate = GETDATE()\n    Where   CustomerEventID In (Select CustomerEventID From #disposedRecords)\n\n    -- Remove the records from the PURGEEventsReadyForPurge table\n    Delete\n    From IADS..PURGEEventsReadyForPurge\n    Where CustomerEventID In (Select CustomerEventID From #disposedRecords)\n\n    -- Remove tie of purged records\n    Update  IADS..CustomerEventHierarchy\n            Set EndDate = GETDATE(),\n            UpdatedBy = @user,\n            UpdatedDate = GETDATE()\n    Where   CustomerEventHierarchyID In (Select CustomerEventHierarchyID From #disposedRecords)\n\n    Delete From IADS..PURGEEventsReadyForPurge Where PURGEEventsReadyForPurgeID In\n    (\n        Select  PURGEEventsReadyForPurgeID\n        From    IADS..PURGEEventsReadyForPurge p\n        Inner Join IADS..CustomerEvent ce On ce.CustomerEventID = p.CustomerEventID\n            And ce.CustomerEventDispositionID IS NULL\n        Inner Join IADS..CustomerEventCategory ceg On ceg.CustomerEventCategoryID = ce.CustomerEventCategoryID\n        Left Outer Join IADS..CustomerEventHierarchy ceh On ceh.CustomerEventID = ce.CustomerEventID\n        Left Outer Join IADS..CustomerEventHierarchy ceh2 On ceh2.RelatedCustomerEventID = ce.CustomerEventID\n        Where   p.PurgeDate IS NOT NULL\n    )\n\n    Drop Table #disposedRecords\n    Drop Table #hiddata\n    Drop Table #surrogateHIDmap\n    Drop Table #surrogatemap\n    Drop Table #data\n\n    Commit\nEnd Try\nBegin Catch\n    Drop Table #disposedRecords\n    Drop Table #hiddata\n    Drop Table #surrogateHIDmap\n    Drop Table #surrogatemap\n    Drop Table #data\n\n    Rollback\nEnd Catch\n</code></pre>\n"},{"tags":["sql","tsql","lookup-tables","table-variable"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":86,"score":1,"question_id":12589244,"title":"TSQL table variable initialization","body":"<p>I have the following TSQL table variable:</p>\n\n<pre><code>declare @NumDaysMonth table\n(\n   month_id smallint,\n   num_days smallint\n)\n</code></pre>\n\n<p>I just want a quick look-up for the number of days in each month. How can I initialize this table like a C array:</p>\n\n<pre><code>int numDaysMonth[] = {31, 28, 30, ... , 31};\n</code></pre>\n"},{"tags":["sql","sql-server-2008","query","tsql","insert"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12587929,"title":"Using Case statement to either Insert into a table or Update an existing row","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/108403/solutions-for-insert-or-update-on-sql-server\">Solutions for INSERT OR UPDATE on SQL Server</a><br>\n  <a href=\"http://stackoverflow.com/questions/3407857/only-inserting-a-row-if-its-not-already-there\">Only inserting a row if it&#39;s not already there</a>  </p>\n</blockquote>\n\n\n\n<p>My title pretty much explains what I'm trying to do, but I'll go into a little more detail. I'm creating a stored procedure when called it first checks to see if the row already exists (by comparing against two parameters) and if it does, it will update a specific column in the row and if the row doesn't exist already it will insert a new row into the table. </p>\n\n<pre><code>BEGIN\nSELECT \n(\nCASE WHEN [Site] = @site and Plant = @plant\nthen \nUPDATE [Status]\nFROM Server_Status\nWHERE [Site] = @site\nELSE\nInsert into Server_Status(Name, [Path], [Site], Plant, [Status])\nValues (@name, @path, @site, @plant, @status)\nend\n)\nFROM Server_Status \nEND\n</code></pre>\n\n<p>Is what I have so far, but doesn't work (obviously). Does anyone with more SQL knowledge than I have any suggestions?</p>\n\n<p>-J</p>\n"},{"tags":["sql","tsql","bcp"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":12588149,"title":"How to make Microsoft BCP export empty string instead of a NUL char?","body":"<p>I was working trying to get this bcp tool to work in a particular way. The -c switch is supposed to export using chars, but for some reason there was a weird char showing in Notepad++ like if it was UNICODE or some other formatting.</p>\n\n<p>I wanted to get that char, which was an Empty string in the database, to export as an empty string into the text file. How do you do that?</p>\n"},{"tags":["asp.net","sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12587650,"title":"When calling stored procedure, .hasRows keeps staying \"false\"","body":"<p>I have a stored procedure which I am calling which will return data from a table.</p>\n\n<p>But when I try to populate an .aspx with the data it skips my method from doing it because my method is based on whether a reader detects rows.</p>\n\n<p>Here is my method:</p>\n\n<pre><code>private void editExhibit(int expenseID)//new\n{\n  saveExhibitBtn.Text = \"Update Exhibit\";\n\n  SqlConnection conn = new SqlConnection(ConfigurationManager.ConnectionStrings[\"OSCIDConnectionString\"].ToString());\n  SqlCommand cmd = new SqlCommand(\"p_CaseFiles_Exhibits_RetrieveExhibitDetails\", conn);\n  cmd.CommandType = CommandType.StoredProcedure;\n  //cmd.Parameters.AddWithValue(\"@ExhibitID\", expenseID);\n  cmd.Parameters.Add(new SqlParameter(\"@ExhibitID\", SqlDbType.Int));\n  cmd.Parameters[\"@ExhibitID\"].Value = expenseID;\n\n  bool hasAttachments = false;\n  string investigatorID = \"\";\n  //bool alreadyInvoiced = false;\n  bool isExpenseOwner = false;\n  string fileID = \"-1\";\n\n  try\n  {\n      conn.Open();\n      var reader = cmd.ExecuteReader();\n      if (reader.HasRows)//////////////////////craps out here bcause hasRows is false....\n      {\n          reader.Read();\n          fileID = reader[\"FileID\"].ToString();\n          ddlCaseFiles.SelectedValue = fileID;\n          ddlCaseFiles.Enabled = false;\n          // retrieve exhibit details here\n          hasAttachments = (bool)reader[\"HasAttachments\"];\n          investigatorID = reader[\"InvestigatorID\"].ToString();\n          if (Session[\"InvestigatorID\"].ToString() == investigatorID)\n          {\n              isExpenseOwner = true;\n          }\n          txtDateReceived.Value = reader[\"SeizeDate\"].ToString();\n          ddlReceivedBy.SelectedValue = reader[\"SeizedByInvestigatorID\"].ToString();\n          txtTimeReceived.Value = reader[\"SeizeTime\"].ToString();\n          txtWhyHowReceived.Value = reader[\"SeizeAuthority\"].ToString();\n          txtReceivedLocation.Value = reader[\"SeizeLocation\"].ToString();\n          txtOurItemNum.Value = reader[\"NewExhibitOutItemNumber\"].ToString();////////////\n          txtTheirItemNum.Value = reader[\"ClientItemNum\"].ToString();\n          txtBagNum.Value = reader[\"BagNumber\"].ToString();\n          txtBoxNum.Value = reader[\"BoxNumber\"].ToString();\n          txtComment.Value = reader[\"ExhibitDecriptionPlainText\"].ToString();\n      }\n  }\n  catch (SqlException ex)\n  {\n      ErrorLogger.Log(ex.Number, \"NewExhibit.aspx - editExhibit - Retrieve Details\", ex.Message);\n  }\n</code></pre>\n\n<p>Here is my stored procedure:</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nALTER procedure [dbo].[p_CaseFiles_Exhibits_RetrieveExhibitDetails]\n  @FilterField nvarchar(max)=null\n, @FilterQuery nvarchar(max)=null\n, @SortName nvarchar(max)='SeizeDate, SeizeTime '\n, @SortOrder nvarchar(max)='desc'\n, @ExhibitID int\nas\nSET CONCAT_NULL_YIELDS_NULL OFF\ndeclare @Command nvarchar(max)\nSelect @Command = 'select E.ExhibitID,convert(nvarchar,SeizeDate,111) as ''SeizeDate'',SeizeTime,ExhDesc,E.InvestigatorID as ''EnteredBy'' \n  ,E.SeizedByInvestigatoID as ''SeizedBy'',SBI.ActiveInvestigator, SBI.FName+'' '' + SBI.LName as ''SeizedByName'', E.FileID,[FileName]\n  ,Investigators.FName,Investigators.LName,SzAuthority,Location,ItemID,SubItemID1,SubItemID2,SubItemID3,PageSerial,ClientItemNum,Privileged\n  ,Private,E.HasAttachments,ItemEntryGradeID,BagNumber,BoxNumber,PL.PropertyId,P.PropertyTypeID,P.PropertyMakeID,P.PropertyModelID,SerialNumber,ColorID\n  ,cast(ItemID as varchar)+''-''+cast(SubItemID1 as varchar)+''-''+cast(SubItemID2 as varchar)+''-''+cast(SubItemID3 as varchar) as ''ItemNumber'',StoredLocally \n  from CaseFileExhibits E \n  join Investigators on E.InvestigatorID = Investigators.InvestigatorID \n  join Investigators SBI on SBI.InvestigatorID=E.SeizedByInvestigatoID \n  join CaseFiles on E.FileID = CaseFiles.FileID \n  left join CaseFileExhibitPropertyLink PL on E.ExhibitID=PL.ExhibitID \n  left join Element09a_Properties P on P.PropertyID=PL.PropertyId \n  left join ElementPropertyTypes PT on PT.PropertyTypeID=P.PropertyTypeID \n  left join ElementPropertyMakes PM on PM.PropertyMakeID=P.PropertyMakeID \n  left join ElementPropertyModels PMD on PMD.PropertyModelID=P.PropertyModelID \n  where E.ExhibitID='+convert(nvarchar,@ExhibitID);\nif(@FilterQuery is not null)\nbegin\n  select @Command+=' and '+@FilterField+ ' like '''+@FilterQuery+''' ';\nend\nselect @Command+=' order by '+@SortName+' '+@SortOrder\n</code></pre>\n\n<p>So according to the stored procedure I only need to pass in the <code>exhibitID</code>, which I did.</p>\n"},{"tags":["sql-server","tsql","join"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":81,"score":1,"question_id":12587790,"title":"T-SQL - joining two tables without primary key","body":"<p>I have 2 tables that represent 2 different model simulations.  As back ground info the 2 models are trying to simulate the same thing but modelA tries to represent very specific attributes whereas and modelb tries to model a broader range.  Table A has n rows which is larger than the m rows in tableB.  I'm trying to create a table with the same number of rows (n) as table A where I can see which modelA_IDs relate to modelB_IDs.</p>\n\n<p>TableA:</p>\n\n<pre><code>ModelA_ID  region height weight\n1          1       25      7.1            \n2          1       70      7.1            \n3          1       10      7.2            \n4          1       30      7.3\n5          1       35      7.4\n6          2       30      7.1\n</code></pre>\n\n<p>TableB:</p>\n\n<pre><code>ModelB_ID  region min_height max_height min_weight max_weight\n9001       1        0             50      7.1        7.3    \n9002       1        51            100     7.1        7.3\n9003       1        0             100     7.4        7.5\n9004       2        0             100     7.1        7.5\n</code></pre>\n\n<p>So in the example above I should end with something along the lines of</p>\n\n<pre><code>ModelA_ID  ModelB_ID    \n1        9001            \n2        9002            \n3        9001            \n4        9001      \n5        9003     \n6        9004\n</code></pre>\n\n<p>Region is not unique in either table.  If it were I think I would join on that, something along the lines of</p>\n\n<pre><code>SELECT  TableA.ModelA_ID TableB.ModelB_ID \nFROM TableA\ninner JOIN TableA\nON TableA.region =TableB.region\nwhere \nTableA.height &gt;= TableB.min_height\nand TableA.height &lt;= TableB.max_height\nand TableA.weight &gt;= TableB.min_weight\nand TableA.weight &lt;= TableB.max_weight\n</code></pre>\n\n<p>However region is not a unique key so I can't do that!</p>\n\n<p>New to SQL as of a couple of days ago but come from a cshell background but new job has sql only policy :-(</p>\n\n<p>Any ideas?  It is not something that has to be repeated often so efficiency is not key.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":73,"score":0,"question_id":12574016,"title":"tsql best way to merge records with start date and end date when there is no gap in between","body":"<p>I have a mapping table as follows :</p>\n\n<pre><code>FirstEntityID int\nMappedTo int\nBeginDate Date\nEndDate Date\n</code></pre>\n\n<p>and lets say I have following records in the table :</p>\n\n<pre><code>FirstEntityID  MappedTo  BeginDate     EndDate \n     1             2     2012-09-01   2012-10-01\n     2             3     2012-09-01   2012-10-01\n     1             2     2012-10-02   2012-11-24\n     2             3     2012-11-01   2012-11-24\n</code></pre>\n\n<p>I need a script which will get this table and merges records based on the Start and end date to return a result like :</p>\n\n<pre><code>   FirstEntityID  MappedTo  BeginDate     EndDate \n     1             2     2012-09-01   2012-11-24\n     2             3     2012-09-01   2012-10-01\n     2             3     2012-11-01   2012-11-24\n</code></pre>\n"},{"tags":["sql","sql-server","oracle","tsql","plsql"],"answer_count":5,"favorite_count":4,"up_vote_count":15,"down_vote_count":0,"view_count":23872,"score":15,"question_id":1201358,"title":"How can I get the number of records affected by a stored procedure?","body":"<p>For <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> SQL statements executed directly against the database, most database providers return the count of rows affected. For stored procedures, the number of records affected is always <code>-1</code>.</p>\n\n<p>How do we get the number of records affected by a stored procedure?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":257,"score":1,"question_id":10240582,"title":"Referencing Columns on the Inserted Table T-SQL","body":"<p>So, I'm trying to create a trigger that will throw an error on inserting data if a foreign key code is not valid. I have two tables, Publisher and Title. Title has a publisher code on it, as does Publisher. I have the trigger on my Title for insert, and I am currently doing an if not exists and selecting the Publisher row where the code is equal to the inserted row's publisher code. I don't know if this is the right way to do it, and probably not, as SQL is giving me a \"multi-part identifier Inserted.PublisherCode could not be found\" error. Any help you guys could give would be appreciated. Thanks.</p>\n\n<pre><code>go\ncreate trigger TR_Title_PublisherCode_Insert\non title\nfor Insert\nas\n    if not exists(select * from Publisher where PublisherCode = Inserted.PublisherCode)\n    begin\n        raiserror('Publisher does not exist', 16, 1)\n        rollback tran\n    end\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":2,"up_vote_count":1,"down_vote_count":0,"view_count":210,"score":1,"question_id":10804675,"title":"Optimizing specific sql query","body":"<p>I am not an SQL expert, please help, how can I optimize this query?</p>\n\n<p>I don't have indexes, only the table called master_table and more tables, I must optimize this query to get the same results, I can create indexes if I have to, but I cannot change the creation table....</p>\n\n<pre><code>select month(date_hour), passenger, nationality, passport, airline,\n   count(*) N_Viagens\nfrom masterTable\ngroup by month(date_hour), passenger, airline, nationality, passport \nhaving count(*) &gt; 10\n</code></pre>\n\n<p>next is the code to create the table but I can't edit that code, only the query or creating indexes:</p>\n\n<pre><code>select\np.birthdate, p.gender, p.passport, p.name + ' ' + p.surname passenger, p.nationality,\n    r.class, r.flightNR, r.payment, r.ticketNR,\n    f.src_AP_ID, f.dest_AP_ID, f.AL_ID, f.date_hour, f.AirCrft_Code,ac.manufacturer, ac.model,\n    SA.City 'Origin City', SA.Country 'Origin Country', SA.Name 'Origin Airport', \n    DA.City 'Dest City', DA.Country 'Dest Country', DA.Name 'Dest Airport',\n    al.Name airline, al.IATA, al.icao\ninto masterTable \nfrom passenger p\njoin reservation r on r.passport = p.passport\njoin flight f on f.flightNR = r.flightNR\njoin airport SA on f.src_AP_ID = SA.AP_Id \njoin airport DA on f.dest_AP_ID = DA.AP_Id \njoin aircraft ac on f.airCrft_Code = ac.code\njoin airline al on f.AL_ID = al.AL_ID \n</code></pre>\n\n<p>without index:</p>\n\n<pre><code>SQL Server Execution Times: CPU time = 10125 ms,  elapsed time = 17052 ms.\n</code></pre>\n\n<p>PEOPLE I THINK I DID IT, THANKS TO ALL OF YOU, THANK YOU AGAIN</p>\n\n<p>I created the index like this:</p>\n\n<pre><code>create index idx_MasterTable_Passenger on masterTable(passport, airline)\n</code></pre>\n\n<p>and the query I changed to this:</p>\n\n<pre><code>select month(date_hour), max(passenger) as passenger, nationality, passport, airline, count(*) N_Viagens\nfrom masterTable\ngroup by airline, nationality, passport, month(date_hour)\nhaving count(*) &gt; 10\n</code></pre>\n\n<p>What you think, is it acceptable?</p>\n\n<pre><code>SQL Server Execution Times: CPU time = 8362 ms,  elapsed time = 5721 ms.\n</code></pre>\n\n<p>I will talk to the teacher if he agrees with this</p>\n\n<p><strong>The teacher did not accepted this changes, we cannot change tables or query, only creating a good index.... suggestions??</strong></p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":107,"score":0,"question_id":10860245,"title":"Summing From Consecutive Rows","body":"<p>Assume we have a table and we want to do a sum of the Expend column so that the summation only adds up values of the same Week_Name. </p>\n\n<pre><code>SN  Week_Name  Exp  Sum\n--  ---------  ---  ---\n1   Week 1     10   0\n2   Week 1     20   0\n3   Week 1     30   60\n4   Week 2     40   0\n5   Week 2     50   90\n6   Week 3     10   0\n</code></pre>\n\n<p>I will assume we will need to `Order By' Week_Name, then compare the previous  Week_Name(previous row) with the current row Week_name(Current row).<br>\nIf both are the same, put zero in the SUM column.</p>\n\n<p>If not the same, add all expenditure, where Week_Name = Week_Name(Previous row) and place in the Sum column. The final output should look like the table above.</p>\n\n<p>Any help on how to achieve this in T-SQL is highly appreciated.</p>\n"},{"tags":["sql","query","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":136,"score":0,"question_id":11229316,"title":"Selecting the 2nd row in sql","body":"<p>I want to select the second row only from the table. From the ClientUserName column.</p>\n\n<pre><code>SELECT\n    ClientUserName, DestHost, count(DestHost) counts  \nFROM \n    #ProxyLog_record  \nWHERE\n    ClientUserName = (Select top 1 ClientUserName from #ProxyLog_count_2)  \nGROUP BY \n    ClientUserName, DestHost \nORDER BY \n    counts DESC\n</code></pre>\n\n<p>The <code>(Select top 1 ClientUserName from #ProxyLog_count_2)</code> shows <code>top 1</code> only but I need to get the 2nd data from that table. How can I do this?</p>\n"},{"tags":["sql","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":278,"score":0,"question_id":2852144,"title":"SQL Query with computed column","body":"<p>Please help me with a query. Assume that we have a table with columns:</p>\n\n<ul>\n<li>Transaction</li>\n<li>StartTime </li>\n<li>EndTime</li>\n</ul>\n\n<p>Now, I need a query with computed column of (value = EndTime-Startime).\nActually I need to group Users(Transaction has a FK for Users) and sort them by average time spent for transaction.</p>\n"},{"tags":["tsql","function","loops","alternative","updates"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":60,"score":1,"question_id":12583043,"title":"T-SQL Update table columns using function","body":"<p>I have the following table:</p>\n\n<pre><code>RecordID \nName\nCol1\nCol2\n....\nColN\n</code></pre>\n\n<p>The <code>RecordID</code> is <code>BIGINT  PRIMARY KEY CLUSTERED IDENTITY(1,1)</code> and <code>RecordID</code> and <code>Name</code> are initialized. The other columns are NULLs.</p>\n\n<p>I have a function which returns information about the other columns by <code>Name</code>.</p>\n\n<p>To initialized my table I use the following algorithm:</p>\n\n<ol>\n<li>Create a LOOP</li>\n<li>Get a row, select its <code>Name</code> value</li>\n<li>Execute the function using the selected name, and store its result\nin temp  variables</li>\n<li>Insert the temp variables in the table</li>\n<li>Move to the next record</li>\n</ol>\n\n<p>Is there a way to do this without looping?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":37,"score":1,"question_id":12583508,"title":"Splitting SQL Data Into Months","body":"<p>I have a Datatable with several hundred rows for this year in it. (MS SqlServer 2k8)</p>\n\n<p>I would like to split this data set out into customer enquiries / Month.</p>\n\n<p>What I have so far is;</p>\n\n<pre><code>Select count(id) As Customers, DatePart(month, enquiryDate) as MonthTotal, productCode From customerEnquiries\nwhere enquiryDate &gt; '2012-01-01 00:00:00'\ngroup by productCode, enquiryDate\n</code></pre>\n\n<p>But this then produces a row for each data item. (Whereas I want a row per month for each data item.)</p>\n\n<p>So how do I change the above query, so that instead of getting</p>\n\n<pre><code>1 1 10\n1 1 10\n1 1 11\n1 2 10\n1 2 10\n</code></pre>\n\n<p>...</p>\n\n<p>I get</p>\n\n<pre><code>2 1 10    &lt;-- 2 enquiries for product code 10 in month 1\n1 1 11    &lt;-- 1 enquiries for product code 11 in month 1\n2 2 10    &lt;-- 2 enquiries for product code 10 in month 2\netc\n</code></pre>\n\n<p>And as a bonus question, is there an easy way of naming each month so the output is Jan, Feb, March instead of 1,2,3 in the month column?</p>\n"},{"tags":["sql","database","tsql","database-design","sage"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":151,"score":3,"question_id":10381841,"title":"Sage 200 - Counter table instead of Identity columns - strange behaviour","body":"<p>I've recently been tasked with writing a sage import tool that imports Quantity Price Break Discounts.</p>\n\n<p>The sage 200 tables in question are:</p>\n\n<ul>\n<li><strong>StockItem</strong> - Main Product Table</li>\n<li><strong>StockItemDiscount</strong> - Main Discount Table</li>\n<li><strong>StockItemQtyDiscBreak</strong> - Discount Qty Price Breaks</li>\n</ul>\n\n<p>I wont bore you with schema information as it's not relevant to my question, suffice to say - the primary key in all 3 tables is a BigInt <strong>without</strong> identity set (sigh), 1 StockItem can have many Discounts and 1 Discount can have many Qty Discount Breaks.</p>\n\n<p>Now then, to create an import routine i first had to analyse what Sage 200 did on SQL if you created Discount and Breaks manually in sage (using SQL Profiler). As i say, Sage 200 does not make use of Identity columns, instead it uses a counter table.</p>\n\n<p>Inserting a new row into StockItemDiscount did the following:</p>\n\n<pre><code>UPDATE [Counter] SET [NextValue] = [NextValue] + 10 WHERE [CounterID] = 1\n</code></pre>\n\n<p>It then selects the new ID:</p>\n\n<pre><code>SELECT NextValue FROM Counter WHERE CounterID = 1\n</code></pre>\n\n<p>It then inserts the new row using the new value it just selected from the counter:</p>\n\n<pre><code>INSERT INTO StockItemDiscount (StockItemDiscountID, /.../) VALUES (@NewID, /.../) \n</code></pre>\n\n<p><strong>My question is this</strong>: Why on earth is sage doing it this way? what could possibly be the reasoning behind it? (Specifically the +10 THEN reading the value)</p>\n\n<p>All the tables share the same counter too, so 5 rows in 1 table would results in a gap in the id's of another table - i'm just really at a loss as to why they do it like this?</p>\n\n<p><strong>The reason i ask:</strong> After inserting a row into <code>StockItemDiscount</code> i then need to delete any related rows in <code>StockItemQtyDiscBreak</code> &amp; insert replacements - however, using SQL profiler i cant see incrementing of the counter table unless i insert 5 or more discounts (the 6th causes it to hit the counter table again, it's almost as if the Sage UI is reserving those 10 ID's using them for a variety of inserts then reserving an additional 10 as it needs them - this just seems very very odd to me?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":4,"view_count":67,"score":-4,"question_id":12580416,"title":"Getting the Emp_ID","body":"<p>In Table_A I have atrribute \"Verantwortlicher\". This attribute contains the last name and the first name of the person respectively i.e. \"Doe John\"</p>\n\n<p>In Table_B I have two attributes \"Lastname_NAM\" and \"Firstname_NAM\" which of course contain lastnames and firstnames of a person respectively i.e. \n\"Lastname_NAM\" - Doe\n\"Firstname_NAM\" - John</p>\n\n<p>Table_A has a foreign key (Responsible_Emp_ID) which is referencing Table_Bs primary key (Emp_ID)</p>\n\n<p>What I would like is to join these two tables so that beside the strig-type full name in the Table_A I also have a ID of that person (which of course comes from Table_B)</p>\n\n<p>I forgot to mention that I need this data so I can FILL the values in aforeign key. Table_A is EMPTY.</p>\n\n<p>Im using T-SQL\nPlease help,\nThanks, D.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":161,"score":1,"question_id":12223111,"title":"Selecting more than 5 columns in my SQL query is slowing it down ","body":"<p>I am running a simple SQL query in SQL Server Management Studio (which I am actually executing in my application also) and I found this interesting. I'm hoping someone can explain what is wrong with it.</p>\n\n<p>The database table has 25 columns, 5 columns are indexed and one primary key column exists.\nExcept for one column, all the rest of the columns are of type <code>varchar</code> of lengths &lt;= 50 or <code>datetime</code> or <code>int</code>. That one exception is that the column is of type <code>varchar(512)</code> (let's call this column <code>BigColumn</code>)</p>\n\n<p>My query is this:</p>\n\n<pre><code>Select PKColumn, column1, column2, column3, column4, column5\nfrom database_table\nwhere PKColumn = value\n</code></pre>\n\n<p>The query executes faster (&lt; 1sec) when I select 5 or fewer columns. I can select any 5 columns except the <code>BigColumn</code> (along with PK, of course) and the result comes back in &lt; 1sec. But, if I select more than 5 columns the query slows down considerably (result comes back 6 secs). Also, if I select <code>PKColumn</code> and <code>BigColumn</code> the result comes back in 6 secs.</p>\n\n<p>Does anyone know what the problem might be? I did put in a request for our DBA to look into this, but I want to know if anyone has faced a problem like this and how they resolved it.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12580078,"title":"Operate pairs from 2 tables in SQL","body":"<p>Say I have the following situation: I have some cities with buildings.\nEach city is divided into districts. Each district should have a \"main house\" (one per district).</p>\n\n<p>I have (sql server 2005) a corresponding associate table <code>CITY_BUILDS (IDCITY, IDBUILD)</code><br>\nI have also a buildings table <code>BUILD (ID, DISTRICT, IS_MAIN, COLOR)</code></p>\n\n<p>So, say the city mayor decided to repaint the \"main house\" of the districts in the color of the first house in the district list (crazy idea, but anyway)</p>\n\n<p>I need to in a city foreach district select the \"main house\", then search for the first district house, peek its color and paint the main house.</p>\n\n<p>I started a stub for my procedure but soon got confused...</p>\n\n<pre><code>DECLARE L_CURSOR CURSOR FAST_FORWARD FOR\nSELECT B.DISTRICT, B.IS_MAIN, B.ID \nFROM BUILD B \n    INNER JOIN CITY_BUILDS C_B \n        ON B.ID = C_B.IDBUILD                   \nWHERE IDCITY = 142 --AND B.IS_MAIN=1\nORDER BY DISTRICT\n</code></pre>\n\n<p><strong>PS.</strong> By FIRST building, I mean ANY first occurrence in the CITY_BUILDS list...\nAlso, that \"FIRST\" house should not be the MainHouse itself...</p>\n\n<p><strong>PPS.</strong> I used a cursor, because once I obtain the pair (ID_MAIN_HOUSE - ID_FIRST_HOUSE) in the real project I need to do call a stored procedure with that 2 arguments and the COLOR...</p>\n"},{"tags":["sql","tsql","variables"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":37,"score":1,"question_id":12579922,"title":"Assign one variable to other variable (SQL)","body":"<p>I'm writing a short piece of code with some calculation method, and im using temp varibles in order to perform it.</p>\n\n<p>When I'm just assigning the <code>SELECT</code> statment to <code>@sum1</code> it's working, but when I'm changing it to <code>@sum1 += SELECT...</code> it return <code>NULL</code> (see picture attached)</p>\n\n<p>I've already tried the following:</p>\n\n<ul>\n<li><p>tried to do some casting (although both @sum1 and activityDur are defined as INT) </p></li>\n<li><p>tried to assign <code>SELECT</code> statment into one variable and then assign that variable in a new variable. </p></li>\n<li><p>tried to find similar problems over the web (including stackoverflow)</p></li>\n</ul>\n\n<p>thx.</p>\n\n<pre><code>SET @sum1=0\n        WHILE @i &lt;= 10\n            BEGIN   \n //**** HERE IS THE PROBLEM\nSET @sum1 += (SELECT activityDur FROM dbo.tmp_activityCalculation WHERE RowNum = @i)\n//**** \nIF (@sum1 &gt; 200)\n                    BEGIN\n                        SET @index += 1\n                        SET @sum1 = 0\n                    END\n                INSERT INTO tmp_finalCalc (RowNum, activityID, activityDur,actDay)\n                SELECT \n                    RowNum,\n                    activityID,\n                    activityDur,\n                    @sum1\n                FROM tmp_activityCalculation WHERE Rownum = @i      \n                SET @i += 1\n            END\n</code></pre>\n\n<p><a href=\"http://i.stack.imgur.com/lrCIW.png\" rel=\"nofollow\">Execution Result of the Query</a></p>\n"},{"tags":["tsql","table","optimization","index","sql-update"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12579094,"title":"T-SQL Update Table's Columns with function - index optimization/fast technique approach","body":"<p>I have a external file with many rows and one column. For example:</p>\n\n<pre><code>Tokio\nLondon\nParis\n...\nAtina\n</code></pre>\n\n<p>I my database, I have a function that use this town name as an input parameter, and the returns several values. For example:</p>\n\n<pre><code>SELECT * FROM myfunction('Tokio')\n</code></pre>\n\n<p>will return:</p>\n\n<pre><code>Longitute = ...\nLatitude  = ...\nPostalCode= ...\nIsCapital = ...\n...\n</code></pre>\n\n<p>I  have to executed all rows values from the file across this function in order to check if there is a situation, when the function do no returns any data.</p>\n\n<p>Firstly, I made a simple</p>\n\n<pre><code>SELECT * FROM myfunction(Row1Value)\nUNION ALL\nSELECT * FROM myfunction(Row2Value)\n...\nUNION ALL\nSELECT * FROM myfunction(RowNValue)\n</code></pre>\n\n<p>but after 3th hour I stop the query and of course it gives me nothing.</p>\n\n<p>Now, I think to create a table, with the following structure:</p>\n\n<pre><code>CREATE TABLE MyTable\n(\n     RecordID BIGINT PRIMARY KEY\n    ,ValueFromFile NVARCHAR(10)\n    ,ReturnColumn1FromFunctiion NVARCHAR(10)\n    ,ReturnColumn1FromFunctiion NVARCHAR(10)\n    ....\n)\n</code></pre>\n\n<p>Then, I will return all values from the file and updated it using my function.</p>\n\n<p>So, could you help me with the index on this table. I suppose some index on the \"ValueFromFile\" must be created as I will executed the function across all rows using this value?</p>\n\n<p>Also, If anyone has done something like this and get a better idea for a solution, please advise.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":2,"view_count":110,"score":2,"question_id":12577319,"title":"SQL Query to filter record for perticular record count","body":"<p>I have a table which have Identity, RecordId, Type, Reading And IsDeleted columns. Identity is primary key that is auto increment, RecordId is integer that can have duplicate values, Type is a type of reading that can be either 'one' or 'average', Reading is integer that contains any integer value, and IsDeleted is bit that can be 0 or 1 i.e. false or true. \nNow, I want the query that contains all the records of table in such a manner that if COUNT(Id) for each RecordId is greater than 2 then display all the records of that RecordId.  </p>\n\n<p>If COUNT(Id) == 2 for that specific RecordId and Reading value of both i.e. 'one' or 'average' type of the records are same then display only average record. </p>\n\n<p>If COUNT(Id) ==1 then display only that record.</p>\n\n<p>For example : </p>\n\n<pre><code>Id          RecordId          Type          Reading       IsDeleted \n1           1                 one             4              0\n2           1                 one             5              0\n3           1                 one             6              0\n4           1                 average         5              0\n5           2                 one             1              0\n6           2                 one             3              0\n7           2                 average         2              0\n8           3                 one             2              0\n9           3                 average         2              0\n10          4                 one             5              0\n11          4                 average         6              0\n12          5                 one             7              0\n</code></pre>\n\n<p>Ans result can be </p>\n\n<pre><code>Id          RecordId          Type          Reading       IsDeleted \n1           1                 one             4              0\n2           1                 one             5              0\n3           1                 one             6              0\n4           1                 average         5              0\n5           2                 one             1              0\n6           2                 one             3              0\n7           2                 average         2              0\n9           3                 average         2              0\n10          4                 one             5              0\n11          4                 average         6              0\n12          5                 one             7              0\n</code></pre>\n\n<p>In short I want to skip the 'one' type reading which have an average reading with same value and its count for 'one' type reading not more than one. Can anyone have idea? </p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":4,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":317,"score":4,"question_id":11721332,"title":"How to get 6 months old data given only month and year from current date?","body":"<p>I have a table that contains only Month and Year field both as int.\nGiven an input say month, 6 months.\nI need to project the data that are 6 months old.</p>\n\n<p>for example I have data from 2001 , 1st Janaury till date. Given input as 6 months , so I have to go back 6 months \nfrom cuurent date to get the result .</p>\n\n<p>Output will be Data From Jan 2001 to Jan 2012.</p>\n\n<p>I have done the program using the right,substring, string comparison.(a nasty hack)</p>\n\n<p>Is there any prominent way of doing so?</p>\n\n<p><strong>DDL</strong></p>\n\n<pre><code>Declare @t table (Mnth int, Yr int)\nInsert Into @t \n\n-- 2011\nSelect 1,2011 Union All select 2,2011 Union All Select 3, 2011 Union ALL Select 4,2011 Union ALL\nSelect 5,2011 Union All select 6,2011 Union All Select 7, 2011 Union ALL Select 8,2011 Union ALL\nSelect 9,2011 Union All select 10,2011 Union All Select 11, 2011 Union ALL Select 12,2011 Union ALL\n\n--2012\nSelect 1,2012 Union All select 2,2012 Union All Select 3, 2012 Union ALL Select 4,2012 Union ALL\nSelect 5,2012 Union All select 6,2012 Union All Select 7, 2012 Union ALL Select 8,2012 Union ALL\nSelect 9,2012 Union All select 10,2012 Union All Select 11, 2012 Union ALL Select 12,2012\n\nDeclare @inputMonth int = 6\n</code></pre>\n\n<p>I am trying without string conversion </p>\n\n<pre><code>Select Mnth,Yr,YEAR(DATEADD(mm,-@inputMonth,getdate())),MONTH(DATEADD(mm,-@inputMonth,getdate()))\nFrom @t\nWHERE   YEAR(DATEADD(mm,-@inputMonth,getdate())) &lt; Yr\nAND MONTH(DATEADD(mm,-@inputMonth,getdate())) &lt; Mnth\n</code></pre>\n\n<p>But it is not working</p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","identity-column"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12577411,"title":"How does SQL Server generate values in an identity column?","body":"<p>My question is if I have two batch inserts into one table in parallel, how does SQL Server create identity values? </p>\n\n<p>I mean, if in one session I insert multiple rows (Row1-Row2-Row3) and simultaneously another session inserts multiple rows (Row4-Row5-Row6) at the same time, the result would be like this?</p>\n\n<pre><code>Row1\nRow2\nRow3\nRow4\nRow5\nRow6\n</code></pre>\n\n<p>or maybe something like this?</p>\n\n<pre><code>Row1\nRow6\nRow3\nRow5\nRow4\nRow2\n</code></pre>\n"},{"tags":["sql","tsql","parsing","csv"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":172,"score":3,"question_id":12278198,"title":"t-sql find specific value with a csv string","body":"<p>I need some on help a SQL Query. I have a column with values stored as comma separated values. </p>\n\n<p>I need to write a query which finds the 3rd delimited item within each value in the column. </p>\n\n<p>Is this possible to do this in a Select statement?\nex: ColumnValue: <code>josh,Reg01,False,a0-t0,22/09/2010</code></p>\n\n<p>So I will need to get the 3rd value (i.e.) <code>False</code> from the above string.</p>\n"},{"tags":["sql","sql-server","entity-framework","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":12575800,"title":"Deleting objects through foreign key relationship with T-SQL query","body":"<p>Looking for a way to write the following LinQ to entities query as a T-SQL statement.</p>\n\n<pre><code>repository.ProductShells.Where(x =&gt; x.ShellMembers.Any(sm =&gt; sm.ProductID == pid)).ToList().ForEach(x =&gt; repository.ProductShells.Remove(x));\n</code></pre>\n\n<p>The below is obviously not correct but I need it to delete respective ProductShell object where\nany ShellMember contains a ProductID equal to the passed in variable <code>pid</code>. I would presume this would involve a join statement to get the relevant ShellMembers.</p>\n\n<pre><code>repository.Database.ExecuteSqlCommand(\"FROM Shellmembers WHERE ProductID={0} DELETE FK_ProductShell\", pid);\n</code></pre>\n\n<p>I have cascade delete enabled for the FK_ShellMembers_ProductShells foreign key, so when I delete the ProductShell it will delete all the ShellMembers that are associated with it. I am going to pass this statement to System.Data.Entity <code>Database.ExecuteSqlCommand</code> method.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":80,"score":0,"question_id":12560874,"title":"recursive query Sort","body":"<p>I have a Standard table, which sotres parent, child category relationship...like this.</p>\n\n<pre><code>id, parent, catName, sort\n</code></pre>\n\n<p>And I use the following query to create a recursive tree</p>\n\n<pre><code>;WITH cte AS (\n    SELECT 0 AS lvl, id, catName, parent,levels,sort,\n        CAST(id AS VARCHAR(128)) AS path\n    FROM CategoriesMap WHERE parent =0\n    UNION ALL\n    SELECT p.lvl + 1, c.id, c.catName, c.parent,c.levels,c.sort,\n        CAST(p.path + '_' + CAST(c.id AS VARCHAR) AS VARCHAR(128))\n    FROM CategoriesMap c\n    INNER JOIN cte p ON p.id = c.parent\n)\nSELECT \n    id, \n    catName AS catName, \n    lvl,\n    levels,\n    path,\n    parent,\n    sort\nFROM cte \nORDER BY path\n</code></pre>\n\n<p>And the output is like this Image:</p>\n\n<p><img src=\"http://i.stack.imgur.com/P1ahO.jpg\" alt=\"enter image description here\"></p>\n\n<p>Look for the Row with value ASP.NET &amp; CLASSIC ASP, these are the last leaf(children) for the technology > Software (parents), I want to sort the LAST CHILDREN of any given parent (last parent). I can have multiple parents for a given node (last child) &amp; <strong>all I care about is sort the LAST Children (leaf) using the \"Sort\" column.</strong></p>\n\n<p>so basicly \"Classic Asp\" shoud be before \"Asp.Net\" (Last Column is SORT column in my image).</p>\n\n<p>My query is fine, it returns the results as expected...only challenege is i want to SORT the last NODE using the SORT column in table, last node can have 3 or 4 children which I want to sort, all nodes above the last node are its parents (which are in correct order already).</p>\n\n<blockquote>\n  <p>I want output like this.... Internet > ISP's > CableVision (1) :\n  Verizon (2) as you can see CableVision &amp; Verizon have Sort Value of 1\n  &amp; then 2, Now lets say we have Shopping > Coupons > Macys(0) : Sears\n  (2), same thing....I want Macys &amp; Sears to be sorted...and its pretty\n  obvious their parents are Shopping >  Coupons.</p>\n</blockquote>\n\n<p>@Richard aka cyberkiwi, after applying your code, my sorting for Categories table is very random. output is below\n<img src=\"http://i.stack.imgur.com/6n53U.png\" alt=\"enter image description here\"></p>\n"},{"tags":["sql-server","sql-server-2005","tsql","identity","sql-server-2005-express"],"answer_count":10,"favorite_count":5,"up_vote_count":30,"down_vote_count":1,"view_count":59645,"score":29,"question_id":751522,"title":"How to change identity column values programmatically?","body":"<p>I have a MS SQL 2005 database with a table Test with column ID. ID is a identity column. I have rows in this table and all of them have their corresponding ID autoincremented value.</p>\n\n<p>Now I would like to change every ID in this table like this:</p>\n\n<pre><code>ID = ID + 1\n</code></pre>\n\n<p>But when I do this I get error:</p>\n\n<pre><code>Cannot update identity column 'ID'.\n</code></pre>\n\n<p>I've tried with:</p>\n\n<pre><code>ALTER TABLE Test NOCHECK CONSTRAINT ALL \nset identity_insert ID ON\n</code></pre>\n\n<p>But this does not solve this problem.</p>\n\n<p>I need to have identity set to this column, but I need to change values as well from time to time. So my question is how to acomplish this task that is required by my project.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":4063,"score":6,"question_id":2265629,"title":"Transaction count after EXECUTE indicates that a COMMIT or ROLLBACK TRANSACTION statement is missing - SQL server 2005","body":"<p>I am getting the error from the application as following with SQL server 2005 </p>\n\n<blockquote>\n  <p>\"Transaction count after EXECUTE\n  indicates that a COMMIT or ROLLBACK\n  TRANSACTION statement is missing.\n  Previous count = 1,  current count =\n  0\"</p>\n</blockquote>\n\n<p>How can i find the stage where this error raised?\nhow can i found the missing transaction or the stored procedure where it is not committ or rollback?</p>\n"},{"tags":["sql","tsql","pivot"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":73,"score":1,"question_id":12558031,"title":"How to pivot and concatenate data in a view?","body":"<p>I'm creating a view to serve as a report that displays row data from various tables as columns, in some cases involving concatenation.\nMy query works excellent when I use a temporary table, but it needs to be a view, and <strong>I'm wrestling with converting the temporary table approach to subqueries</strong>.</p>\n\n<p>I've created a couple sample tables and data to simplify this question as much as possible.\nHere's the schema:</p>\n\n<pre><code>CREATE TABLE [Car] (\n    [CarId] [int] NOT NULL,\n    [Name] [varchar](50) NOT NULL,\n CONSTRAINT [PK_Car] PRIMARY KEY CLUSTERED ([CarId] ASC))\n INSERT INTO [Car] VALUES\n    (1, 'Honda')\n\nCREATE TABLE [Part] (\n    [PartId] [int] IDENTITY(1,1) NOT NULL,\n    [CarId] [int] NOT NULL,\n    [Name] [varchar](50) NOT NULL,\n    [PercentComplete] [decimal](3, 2) NOT NULL,\n CONSTRAINT [PK_Part] PRIMARY KEY CLUSTERED  ([PartId] ASC))\nINSERT INTO [Part] VALUES\n    (1, 'Engine', 0.5)\n    ,(1, 'Transmission', 0.75)\n    ,(1, 'Suspension', 0.3)\n</code></pre>\n\n<p>Here's the initial step:</p>\n\n<pre><code>SELECT\n    c.CarId\n    ,c.Name AS [CarName]\n    ,p.Name AS [PartName]\n    ,p.PercentComplete AS [PartPercentComplete]\nINTO #Temp\nFROM Car c\nJOIN Part p\nON p.CarId = c.CarId\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/8lOWm.png\" alt=\"Initial Setup\"></p>\n\n<p>Here's the grouped select which converts it to my report view:</p>\n\n<pre><code>SELECT\n    MAX(CarName) AS [Car Name]\n\n    ,STUFF((\n        SELECT ', ' + [PartName] \n        FROM #Temp\n        WHERE (CarId = t1.CarId) \n        FOR XML PATH (''))\n    ,1,2,'') AS [Parts]\n\n    ,MAX(CASE [PartCompleteAvg] WHEN 1.00 THEN 'Complete' ELSE 'Incomplete' END) AS [Part Status]\n    ,MAX(CASE [PartId] WHEN [LatestPartId] THEN [PartName] ELSE NULL END) AS [Latest Part]\nFROM (\n    SELECT\n        CarId\n        ,AVG(PartPercentComplete) AS [PartCompleteAvg]\n        ,MAX(PartId) AS [LatestPartId]\n    FROM #Temp\n    GROUP BY CarId\n) t1\nLEFT JOIN #Temp t2\nON t2.CarId = t1.CarId\nGROUP BY t1.CarId\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/JyRRS.png\" alt=\"Report\"></p>\n\n<p>It works fantastic except I have trouble converting it to a view because of the intermediate aggregate function <code>AVG(PartPercentComplete)</code>, and the concatenation trick with <code>STUFF</code>. My report requires several of each of these.</p>\n\n<p>I know I can't nest <code>AVG()</code> within <code>MAX()</code> as that gives <code>Cannot perform an aggregate function on an expression containing an aggregate or a subquery.</code></p>\n\n<p>(FYI I'm aware of <code>PIVOT</code> but it'd need to be over <a href=\"http://pratchev.blogspot.com/2009/01/pivoting-on-multiple-columns.html\" rel=\"nofollow\">multiple columns</a>, though I realize that's possible too, <code>CASE</code> seems easier and <a href=\"http://stackoverflow.com/a/3241524/879\">I'm told faster</a>.)</p>\n\n<p>My totally incorrect and poor attempt:</p>\n\n<pre><code>SELECT\n    MAX(CarName) AS [Car Name]\n    ,STUFF((\n        SELECT ', ' + [PartName] \n        FROM #Temp\n        WHERE (CarId = t1.CarId) \n        FOR XML PATH (''))\n    ,1,2,'') AS [Parts]\n\n    ,MAX(CASE [PartCompleteAvg] WHEN 1.00 THEN 'Complete' ELSE 'Incomplete' END) AS [Part Status]\nFROM (\n    SELECT\n        CarId\n        ,AVG(PartPercentComplete) AS [PartCompleteAvg]\n    FROM (\n        SELECT\n            c.CarId\n            ,c.Name AS [CarName]\n            ,p.Name AS [PartName]\n            ,p.PercentComplete AS [PartPercentComplete]\n        FROM Car c\n        JOIN Part p\n        ON p.CarId = c.CarId\n    ) t1\n    GROUP BY CarId\n) t1\nLEFT JOIN #Temp t2\nON t2.CarId = t1.CarId\nGROUP BY t1.CarId\n</code></pre>\n\n<p>Obviously <code>#Temp</code> is invalid in both locations. I'm not a SQL expert and I'm hoping there is a clean and relatively simple way to do this, maybe even avoiding the self-join.</p>\n\n<p><strong>Edit</strong></p>\n\n<p>I added in</p>\n\n<pre><code>MAX(PartId) AS [LatestPartId]\n</code></pre>\n\n<p>and</p>\n\n<pre><code>MAX(CASE [PartId] WHEN [LatestPartId] THEN [PartName] ELSE NULL END) AS [Latest Part]\n</code></pre>\n\n<p>as it's a better example of why I need an intermediate <code>GROUP BY</code>.</p>\n"},{"tags":["sql-server","tsql","stored-procedures","sql-server-2000","flow-control"],"answer_count":7,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":16468,"score":7,"question_id":1862871,"title":"SQL Server 2000: How to exit a stored procedure?","body":"<p>How can i exit in the middle of a stored procedure?</p>\n\n<p>i have a stored procedure where i want to bail out early (while trying to debug it). i've tried calling <code>RETURN</code> and <code>RAISERROR</code>, and the sp keeps on running:</p>\n\n<pre><code>CREATE PROCEDURE dbo.Archive_Session @SessionGUID uniqueidentifier AS\n\nprint 'before raiserror'\nraiserror('this is a raised error', 18, 1)\nprint 'before return'\nreturn -1\nprint 'after return'\n\n[snip]\n</code></pre>\n\n<p>i know it keeps running because i encounter an error further down. i don't see any of my <strong>prints</strong>. If i comment out the bulk of the stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE dbo.Archive_Session @SessionGUID uniqueidentifier AS\n\nprint 'before raiserror'\nraiserror('this is a raised error', 18, 1)\nprint 'before return'\nreturn -1\nprint 'after return'\n\n/*\n[snip]\n*/\n</code></pre>\n\n<p>Then i don't get my error, and i see the results:</p>\n\n<pre><code>before raiserror\nServer: Msg 50000, Level 18, State 1, Procedure Archive_Session, Line 5\nthis is a raised error\nbefore return\n</code></pre>\n\n<p>So the question is: how do i bail out of a stored procedure in SQL Server?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":83,"score":0,"question_id":12568779,"title":"Transposing columns to rows using UNPIVOT","body":"<p>I have a table that for some reason has hardcoded values like so:</p>\n\n<pre><code>Row ID    QtyC1   QtyC2  QtyC3   QtyC4  QtyN1   QtyN2  QtyN3   QtyN4  \n100       10      5      8       9      11      12     5       6\n101       9       11     12      5      6       10     4       9\n</code></pre>\n\n<p>The table has 35 columns and around 12k records (meaning around 500k values) and is being added to and amended constantly.</p>\n\n<p>I am trying to transpose this in a view into:</p>\n\n<pre><code>Row ID  Year  Period  Val\n100     C     1       10\n100     C     2       5\n100     C     3       8\n100     C     4       9\n100     N     1       11\n100     N     2       12\n100     N     3       5\n100     N     4       6\n</code></pre>\n\n<p>So far I have managed to split it out into single values using this query:</p>\n\n<pre><code>SELECT Row ID, YP, Val\n\nFROM (SELECT Row ID\n    , QtyC1 AS C1\n    , QtyC2 AS C2\n    , QtyC3 AS C3\n    , QtyC4 AS C4\n    , QtyN1 AS N1\n    , QtyN2 AS N2\n    , QtyN3 AS N3\n    , QtyN4 AS N4\n\nFROM MyTable\n) SUB\nUNPIVOT (Val FOR YP IN (C1,C2,C3,C4,N1,N2,N3,N4)) AS PVT\n</code></pre>\n\n<p>This is getting me a single identifying value (eg <code>C1</code>) but how can I split it so I have a numeric period and a single character for the year (<code>1</code> and <code>C</code>)?</p>\n\n<p>I can see it might be possible just splitting up the string into two parts but I was hoping for a cleaner way if possible.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":111,"score":0,"question_id":12559643,"title":"T-SQL stuff column into another column","body":"<p>I have two columns (<code>A, B</code>)  like this....</p>\n\n<pre><code>A           B\n12_18_19    20\n</code></pre>\n\n<p>I want a 3rd column (C) added within same <code>SELECT</code> statement like this...</p>\n\n<pre><code>C\n12_18_20_19\n</code></pre>\n\n<p>in other words, my column <code>A</code> is delimited by \"_\", so the second last index of column <code>A</code> should be column <code>B</code>.</p>\n\n<p>If possible I would do do all this within same <code>SELECT</code> statement like this...</p>\n\n<pre><code>A         B    C\n12_18_19  20   12_18_20_19\n</code></pre>\n"},{"tags":["sql-server","tsql","max","min","union-all"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12569373,"title":"TSQL UNION GETTING UNIQUE VALUE","body":"<p>I'm trying to get the unique record between two databases based on two criteria.  The criteria is:</p>\n\n<ol>\n<li>If the data is found in database 1 (@SCCM in my example below), it\nis given preference  </li>\n<li>Grab the MAX resource id within the selected database</li>\n</ol>\n\n<p>Here is an example, which is half working.  The database preference is working, but the maximum resource id WITHIN that database isn't.  Right now it's selecting the max between both @SMS and @SCCM</p>\n\n<pre><code>\nDECLARE @SMS TABLE (\n    name0 varchar(100),\n    resid int\n)\n\nDECLARE @SCCM TABLE (\n    name0 varchar(100),\n    resid int\n)\n\nINSERT INTO @SMS\nSELECT 'TEST', 1000 UNION\nSELECT 'TEST', 1500 UNION\nSELECT 'TEST1', 2000 UNION\nSELECT 'TEST2', 3000 UNION\nSELECT 'TEST3', 4000\n\nINSERT INTO @SCCM\nSELECT 'TEST', 100 UNION\nSELECT 'TEST', 150 UNION\nSELECT 'TEST1', 200 UNION\nSELECT 'TEST2', 300\n\nSELECT MIN(SMSDB) as SMSDB, MAX(Resid), Name0 FROM\n(\n    SELECT name0, resid, 2 as SMSDB FROM @SMS\n    UNION ALL\n    SELECT name0, resid, 1 as SMSDB FROM @SCCM\n) as tbl\nGROUP BY NAME0\n</code></pre>\n\n<p>Expected results:</p>\n\n<pre><code>SMSDB | Resid | Name0\n----------------------\n1     | 150   | TEST\n1     | 200   | TEST1\n1     | 300   | TEST2\n2     | 4000  | TEST3\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","datetime"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12569633,"title":"Use something like LEAST in T-SQL on a datetime field","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1947753/getting-the-minimum-of-two-values-in-sql\">Getting the minimum of two values in sql</a>  </p>\n</blockquote>\n\n\n\n<p>Okay what I Have a table with two datetime fields and I want to select the rows where the oldest date is equal to some date variable. I saw the LEAST function used somewhere but I can't use this in T-SQL</p>\n\n<p>I need something like this</p>\n\n<pre><code>SELECT LEAST(date1, date2) as theDate FROM theTable WHERE theDate = '2012-09-24'\n</code></pre>\n\n<p>but that will work in T-SQL. Also date1 or date2 can sometimes be null so that may be important to know.</p>\n"},{"tags":["c#","linq","sql-server-2008","tsql","whitespace"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":12569358,"title":"A sequence of whitespace added to the end of CHAR columns","body":"<p>Today I ran into a weird problem. I have a database in SQL Server which is filled with Linq data access layer. Now I've got some columns that are of datatype <code>CHAR(100)</code> for example . </p>\n\n<p>When I`m inserting everything seems to be working fine but when I retrieve these values there some sequence of whitespace has been added to the end of each value.</p>\n\n<p>Anyone got an idea? </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":74,"score":2,"question_id":12566406,"title":"COUNT select and local variable storage","body":"<p>I need to find the id of the person with the least number of clients associated to them, inorder that the current new client is allocated to this staff member.</p>\n\n<p>I've used the following to establish the id of this staff member as follows;</p>\n\n<pre><code>    SELECT TOP(1) JA.judgeID, COUNT(JA.judgeId) AS COUNT\n    FROM recJudgeAssignment AS JA\n    LEFT JOIN recEntrantStatus AS ES\n    ON JA.bandId = ES.entrantId\n    GROUP BY JA.judgeId, ES.roundId\n    HAVING ES.roundId = @round\n    ORDER BY COUNT\n</code></pre>\n\n<p>But I need to catch this as a local variable to use in the next statement;</p>\n\n<pre><code>    UPDATE recJudgeAssignment\n    SET judgeId = @judge\n    WHERE roundId = @round\n    AND bandId = @entrantId\n</code></pre>\n\n<p>How do I catch the judgeId in the 1st select? Normally I would do something like;</p>\n\n<pre><code>    SELECT @judge =(SELECT TOP(1) JA.judgeID, COUNT(JA.judgeId) AS COUNT\n    FROM recJudgeAssignment AS JA\n    LEFT JOIN recEntrantStatus AS ES\n    ON JA.bandId = ES.entrantId\n    GROUP BY JA.judgeId, ES.roundId\n    HAVING ES.roundId = @round\n    ORDER BY COUNT)\n</code></pre>\n\n<p>This doesn't work of course because the select is returning the judgeId and the COUNT. I would prefer to not have to send the result of the 1st select back to the webpage and then do the subsequent update statement in a seperate web>db transaction.</p>\n\n<p>So... Any help or even remedies anyone can offer, would be greatly appreciated.</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["tsql","sum","maxdate"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12568620,"title":"Summing Multiple Records by maxdate","body":"<p>I have a table with the following data</p>\n\n<pre>\n<b>Bldg        Suit    SQFT     Date</b>\n1           1       1,000    9/24/2012              \n1           1       1,500    12/31/2011\n1           2       800      8/31/2012\n1           2       500      10/1/2005\n</pre>\n\n<p>I want to write a query that will sum the max date for each suit record, so the desired result would be 1,800, and must be in one cell/row.  This will ultimately be part of subquery, I am just not getting what I expect with the queries I have writtren so far.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":2,"favorite_count":1,"up_vote_count":8,"down_vote_count":0,"view_count":159,"score":8,"question_id":12544051,"title":"Randomly assign work location and each location should not exceed the number of designated employees","body":"<p>I am trying to select unique random posting/recruitment places of employees within a list of places, all the employees are already posted at these places, i am trying to generate a new random posting place for them with \"where\" condition that \"employee new random location will not be equal to their home place and randomnly selected Employees with their designation must be less than or equal to Place wise designation numbers from Places table \"</p>\n\n<p>the Employee table is :</p>\n\n<pre><code>EmpNo   EmpName           CurrentPosting    Home        Designation   RandomPosting\n1       Mac               Alabama           Missouri      Manager       \n2       Peter             California        Montana       Manager       \n3       Prasad            Delaware          Nebraska      PO       \n4       Kumar             Indiana           Nevada        PO       \n5       Roy               Iowa              New Jersey    Clerk       \n</code></pre>\n\n<p>And so on...</p>\n\n<p>And the Places table (PlaceNames with number of employees  - designation wise) is :-</p>\n\n<pre><code>PlaceID  PlaceName      Manager     PO    Clerk\n1        Alabama           2        0     1\n2        Alaska            1        1     1\n3        Arizona           1        0     2\n4        Arkansas          2        1     1\n5        California        1        1     1\n6        Colorado          1        1     2\n7        Connecticut       0        2     0\n</code></pre>\n\n<p>and so on...</p>\n\n<p>tried with with newid() like as below and to be able to select Employees with RandomPosting place names,</p>\n\n<pre><code>WITH cteCrossJoin AS (\nSELECT e.*, p.PlaceName AS RandomPosting,\n       ROW_NUMBER() OVER(PARTITION BY e.EmpNo ORDER BY NEWID()) AS RowNum\n    FROM Employee e\n        CROSS JOIN  Place p\n    WHERE e.Home &lt;&gt; p.PlaceName\n)\nSELECT *\nFROM cteCrossJoin\nWHERE RowNum = 1;\n</code></pre>\n\n<p>additionally I need to limit the random selection based upon designation numbers(in Places table)... that is to assign each Employee a PlaceName(from Places) randomly which is not equal to CurrentPosting and Home(in Employee) and Place wise designation will not exceed as given numbers.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":85,"score":3,"question_id":12563952,"title":"How to select item matching Only IN List in sql server","body":"<p>How can one select only the items he want in the IN list? for example</p>\n\n<pre><code>select * from pagetags where TagID in (1,2,4)\n</code></pre>\n\n<p>Now I want all the pages which has all the above 3 IDs assigned to them (1,2,4), not just any of them but all of them?</p>\n\n<p>Is there a way? any other operator? I have already tried <code>= Any</code> and <code>= All</code> but no luck.</p>\n"},{"tags":["tsql","sql-server-2008","full-text-search","freetexttable"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":577,"score":3,"question_id":3097166,"title":"FREETEXTTABLE always has a rank of 0","body":"<p>I'm using SQLServer 2008 and if I perform the following query:</p>\n\n<pre><code>SELECT \n  *\nFROM\n  FREETEXTTABLE(SomeTable, Name, 'a name that I know exists')\n</code></pre>\n\n<p>I get the rows back that I would expect, but the rank is always 0.</p>\n\n<p>Searching for a solution to this problem, <a href=\"http://forums.asp.net/t/1206348.aspx\" rel=\"nofollow\">I found this question</a> on the Microsoft ASP.NET forum, and sure enough if I add:</p>\n\n<pre><code>ALTER FULLTEXT CATALOG MyCatalog REBUILD\n</code></pre>\n\n<p>I start to get a rank - but only temporarily.</p>\n\n<p>I don't want to have to rebuild my catalog every time I do a search especially when I have lots of data in my database and if I add it to my Sproc directly before the query, my query returns no results anyway, presumably because the catalog has finished being rebuilt. There seem to be other people having this and similar problems but I have been unable to find a solution. Any ideas?</p>\n"},{"tags":["vb.net","tsql","dynamic-sql"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":112,"score":2,"question_id":12566265,"title":"VB.NET GUI - TSQL dynamic SQL nightmare design","body":"<p>This is more of a design rather than implementation question. We have a VB.NET front end to our database. The current design is using table upon table of meta data to enforce a \"NO SQL in the front end\" policy. I view the things we do as worse than hard coding because we now have a nice smattering of STORED PROC spaghetti code. We have lots of dynamic SQL that is used to build the fully qualified names of tables that then get sent back to another STORED PROC that handles actual loading of flat text files for example.</p>\n\n<pre><code>    ID DATA_TABLE_NAME DATA_TABLE_SCHEMA PTR_TABLE_NAME PTR_TABLE_SCHEMA\n    1  datatable            DBO            datatable_ptr       DBO\n</code></pre>\n\n<p>So we have a class that will grab the data table name and the table pointer and mash it into a class in the VB.NET front end that sends a full name like database.dbo.datatable which maps to database.dbo.datable_ptr and uses global temp tables to load the flat text files. Well someone added a row to this nasty little table of meta data and it BROKE THE VB.NET FRONT END! There has got to be a better way to do this but I'm not experienced enough to come up with a better general solution.</p>\n\n<p>How on earth does a programmer emphasize code reuse and generic programming using T-SQL and VB.NET while keeping the code readable and maintainable? Does anyone have some recommendations on books with design patterns or a cook book that can point me to some more workable solution?</p>\n"}]}
{"total":16599,"page":13,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":2977,"score":4,"question_id":1092433,"title":"How can you cancel a SQL Server execution process programmatically","body":"<p>Let's say you have execute the following (long running) process from your code:</p>\n\n<pre><code>int processID = DB.Execute(SQL); //some long running sql statement\n</code></pre>\n\n<p>Is there a way to programatically call SQL Server to cancel the process if it is taking too long (kind of like hitting the \"Stop\" button in QueryAnalyzer)?</p>\n\n<pre><code>//cancel the process if it is taking too long\nDB.Execute(\"sp_CancelProcess @ProcessID=\" + processID);\n</code></pre>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12556097,"title":"tsql join 2 tables with duplicate records in the second table","body":"<p>I have 2 tables.</p>\n\n<p><strong>Table 1:</strong></p>\n\n<pre><code>Id     Name\n\n1      John\n2      Mike\n3      Sam\n</code></pre>\n\n<p><strong>Table 2:</strong></p>\n\n<pre><code>Name   Data\n\nJohn   Data1\nJohn   Data1\nJohn   Data1\nMike   Data2\nMike   Data2\nSam    Data3\n</code></pre>\n\n<p>If I write</p>\n\n<pre><code>select Table2.Name, Table2.Data \nfrom Table1 \ninner join Table2 on Table1.Name= Table2.Name\n</code></pre>\n\n<p>I get all the duplicate data.</p>\n\n<p>I would like to be able to retrieve something like: </p>\n\n<pre><code>John Data1\nMike Data2\nSam  Data3\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":71,"score":0,"question_id":12560847,"title":"Sql Query to check availability by day and max people","body":"<p>Hello this is are 2 tables on my db :\n<img src=\"http://i.stack.imgur.com/omTMU.jpg\" alt=\"enter image description here\"></p>\n\n<p>I'm trying to get the hotels available for a interval of dates.\nIn the Rooms table are defined the types of rooms : eg Signe:max_guests=1, Triple : max_guests=3\nSo for 10 people booking i need something like: </p>\n\n<pre><code>SELECT  SUM(rooms.max_guests * av.RoomAvailable) AS maxPeople \nFROM av AS av INNER JOIN rooms \nON av.room = rooms.ID AND av.DateofDays BETWEEN '09/28/2012' AND '10/03/2012' \nGROUP BY av.userid\nHAVING Count(*) &gt;= 6\n</code></pre>\n\n<p>but this doesn't really fit my requirements ..it return me total max_people available/ userID  i just need to check if every day for each userID(hotel) there's >= 10 (max_people) available </p>\n\n<p>Thank yo for your help</p>\n\n<p>Update: if i use this query :</p>\n\n<pre><code>SELECT  av.userid, av.DateofDays, SUM(rooms.max_guests * \n\nav.RoomAvailable) AS maxPeople \nFROM av AS av INNER JOIN rooms \nON av.room = rooms.ID AND av.DateofDays BETWEEN '09/28/2012' \n\nAND '10/03/2012' \nGROUP BY av.userid, av.DateofDays\nORDER BY av.userid, av.DateofDays\n</code></pre>\n\n<p>i get this:\n<img src=\"http://i.stack.imgur.com/5RF6v.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["c#","sql","sql-server","tsql"],"answer_count":8,"favorite_count":6,"up_vote_count":22,"down_vote_count":0,"view_count":14191,"score":22,"question_id":209686,"title":"Passing List<> to SQL Stored Procedure","body":"<p>I've often had to load multiple items to a particular record in the database. For example: a web page displays items to include for a single report, all of which are records in the database (Report is a record in the Report table, Items are records in Item table). A user is selecting items to include in a single report via a web app, and let's say they select 3 items and submit. The process will add these 3 items to this report by adding records to  a table called ReportItems (ReportId,ItemId).</p>\n\n<p>Currently, I would do something like this in in the code:</p>\n\n<pre><code>public void AddItemsToReport(string connStr, int Id, List&lt;int&gt; itemList)\n{\n    Database db = DatabaseFactory.CreateDatabase(connStr);\n\n    string sqlCommand = \"AddItemsToReport\"\n    DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);\n\n    string items = \"\";\n    foreach (int i in itemList)\n        items += string.Format(\"{0}~\", i);\n\n    if (items.Length &gt; 0)\n        items = items.Substring(0, items.Length - 1);\n\n    // Add parameters\n    db.AddInParameter(dbCommand, \"ReportId\", DbType.Int32, Id);\n    db.AddInParameter(dbCommand, \"Items\", DbType.String, perms);\n    db.ExecuteNonQuery(dbCommand);\n}\n</code></pre>\n\n<p>and this in the Stored procedure:</p>\n\n<pre><code>INSERT INTO ReportItem (ReportId,ItemId)\nSELECT  @ReportId,\n          Id\nFROM     fn_GetIntTableFromList(@Items,'~')\n</code></pre>\n\n<p>Where the function returns a one column table of integers.</p>\n\n<p>My question is this: is there a better way to handle something like this? Note, I'm not asking about database normalizing or anything like that, my question relates specifically with the code.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":83,"score":-2,"question_id":11908551,"title":"Combine datetime with nvarchar","body":"<p>I have two columns in DB: <code>StartDate</code> (datetime column) and <code>StartTime</code> (nvarchar column).\n<code>StartDate</code> contains date when event shoud start. \n<code>StartTime</code> contains time when event should start. It is 24hour format (for example, 22:00 or 12:00).</p>\n\n<p>I need to combine <code>StartDate</code> with <code>StarTime</code> to use it in <code>WHERE</code> clause and compare the result with variable. It would look like:</p>\n\n<pre><code>WHERE COMBINED_STARTDATE_WITH_STARTIME &gt;= @DATETIME_VARIABLE\n</code></pre>\n\n<p>I am using SQL SERVER 2008.\nThis is existing DB design and would not like to change it. Probably, I can create third column and combine datetime + startdate into one column, but I am looking for another sollutions (that doesn't touch database).</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","pivot"],"answer_count":5,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":11682,"score":5,"question_id":1677645,"title":"Using PIVOT in SQL Server 2008","body":"<p>Let's say I have some data, either in a SQL Server 2008 table or a [table]-typed variable:</p>\n\n<pre><code>author_id     review_id     question_id     answer_id\n88540         99001         1               719\n88540         99001         2               720\n88540         99001         3               721\n88540         99001         4               722\n88540         99001         5               723\n36414         24336         1               302\n36414         24336         2               303\n36414         24336         3               304\n36414         24336         4               305\n36414         24336         5               306\n</code></pre>\n\n<p>I want to retrieve the data as a result set that looks like this:</p>\n\n<pre><code>author_id     review_id     1     2     3     4     5\n88540         99001         719   720   721   722   723\n36414         24336         302   303   304   305   306\n</code></pre>\n\n<p>I suspect the PIVOT operator is what I need (according to <a href=\"http://stackoverflow.com/questions/1461489/best-way-to-flatten-denormalize-sql-lookup-tables\">this post</a>, anyway), but I can't figure out how to get started, especially when the number of <strong>question_id</strong> rows in the table can vary.  In the above example, it's 5, but in another query the table might be populated with 7 distinct questions.</p>\n"},{"tags":["sql","sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":12462113,"title":"Sending the Sproc results to an Email in SQL Server","body":"<p>I am trying to send an email of the Sproc results. I have tried doing this:</p>\n\n<pre><code>EXEC msdb.dbo.sp_send_dbmail  \n    @recipients = 'Testemail@XYZ.com',\n    @query = 'EXEC test_email' ,\n    @subject = 'Sample Data',\n    @attach_query_result_as_file = 1 ;\n</code></pre>\n\n<p>It gives me the following error:</p>\n\n<blockquote>\n  <p>Msg 15281, Level 16, State 1, Procedure sp_send_dbmail, Line 0<br>\n     SQL Server blocked access to procedure 'dbo.sp_send_dbmail' of component 'Database Mail XPs' because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of 'Database Mail XPs' by using sp_configure. For more information about enabling 'Database Mail XPs', see \"Surface Area Configuration\" in SQL Server Books Online.</p>\n</blockquote>\n\n<p>Is there any other way to do this?</p>\n"},{"tags":["sql","sql-server-2008","tsql","reporting-services"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12557097,"title":"Function is exceeding SQLs 1024 column limit","body":"<p>Parameters: <code>@Year int, @Month int</code></p>\n\n<p>Environment: SQL Server 2008 R2, Visual Studio</p>\n\n<p>Developing a statistical report to find a 6 month average for each code type (about 50+ types) depending on the selected month and year. </p>\n\n<p>So for example if February 2012 is selected then the query will count every time a code type appears in January 2012, December/November/October/September/August 2011 then divide that sum by 6 to get the past 6 month average. The actual average is calculated in a dataset in Visual Studio.</p>\n\n<p>The SQL code looks something like this:</p>\n\n<pre><code>CASE WHEN TypeCode = \"xyz\" and [Year] = (@Year - 1) and [Month] in (12, 11, 10, \n9, 8, 7) then 1 else 0 end as TypeXYZ_Jan_Avg,\n\nCASE WHEN TypeCode = \"xyz\" and (([Year] = (@Year ) and [Month] = 1) OR \n([Year] = @Year and [Month] in (12, 11, 10, 9, 8)) \nthen 1 else 0 end as TypeXYZ_Feb_Avg,\n\nCASE WHEN TypeCode = \"xyz\" and ([Year] = @Year and [Month] in (11, 10, 9, 8, 7, \n6)) then 1 else 0 end as TypeXYZ_Dec_Avg\n</code></pre>\n\n<p>This is done for each 50+ code types. </p>\n\n<p>There are other fields in this function (not mentioned here) that I need to keep. Anyhow, the final query exceeds the maximum amount of columns permitted. </p>\n\n<p>I tried to minimize the amount of fields by making the code type a parameter. </p>\n\n<p>Something like this:</p>\n\n<pre><code>CASE WHEN TypeCode = @CodeType and ([Year] = @Year and [Month] in (11, 10, 9, \n8, 7, 6)) then 1 else 0 end as Type_Dec_Avg\n</code></pre>\n\n<p>However, this doesnt work when I declare the <code>@CodeType</code> parameter in the function (because of a multi-valued error I get in VS):</p>\n\n<pre><code> SELECT * FROM CodeTypes(@CodeType, @Year, @Month) \n</code></pre>\n\n<p>Values are passed but the calculations are off:</p>\n\n<pre><code> SELECT * FROM CodeTypes(@Year, @Month) WHERE CodeType in (@CodeType)\n</code></pre>\n\n<p>Any suggestions? Maybe make a temp table? Im not too familiar with how to do this but I plan to do some research right now.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server-2008","tsql","set-based"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":82,"score":3,"question_id":12542908,"title":"How to find the longest sequence of letter in a string","body":"<p>I want to find out the longest sequence of letter in a string</p>\n\n<p>e.g. in the word <code>Honorificabcdwert</code> , the output will be <code>abcd</code>.</p>\n\n<p>How can I do it? </p>\n\n<p>My idea is to get the Ascii and then count the sequence until it breaks at some point. But I was able to proceed with only</p>\n\n<pre><code>DECLARE @t TABLE(ID INT IDENTITY,String VARCHAR(100))\nINSERT INTO @t SELECT 'Honorificabcdwert'\n\n;with Get_Individual_Chars_Cte AS\n( \n   SELECT \n        ID\n        ,Row_ID =ROW_NUMBER() Over(PARTITION by ID Order by ID) \n        ,SUBSTRING(String,Number,1) AS [Char]\n        ,ASCII(SUBSTRING(String,Number,1)) AS [Ascii Value]\n\nFROM @t  \nINNER JOIN master.dbo.spt_values ON\n Number BETWEEN 1 AND LEN(String)\n AND type='P'\n\n)\n\nSelect * from Get_Individual_Chars_Cte \n</code></pre>\n\n<p>After this I don't know what to do. Help needed for this or any other way of doing so.</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":10,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":349,"score":2,"question_id":1773333,"title":"Interesting SQL issue","body":"<p>I have a SQL problem I am trying to digest. I am using SQL Server 2005.</p>\n\n<p>In a table I have data as such:</p>\n\n<pre><code>ID     Type\n1        A\n2        A\n3        A\n3        B\n4        B\n</code></pre>\n\n<p>I need to find all of the IDs that have a Type of both A and B.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":146,"score":0,"question_id":12557446,"title":"SQL - SELECT all records for month based on timestamp","body":"<p>I have an SQL query that selects all records within a 24 hour period, however, I need to update it to select all the records within a month (relative to a records timestamp). So for example if I selected any record within the month of Feb, it should return all records from the beginning to the end of the month.</p>\n\n<p>The code I have to the daily query is:</p>\n\n<pre><code>SELECT  Snapshot.xId,  MAX(Snapshot.TimeStamp) AS Timestamp_Actual, \n                dateadd(dd, datediff(dd,0, MAX(Snapshot.TimeStamp)), 0) AS TimestampRange_Start,\n                dateadd(MI, 1439, dateadd(dd, datediff(dd,0, MAX(Snapshot.TimeStamp)), 0)) AS TimestampRange_End\n                FROM Snapshot\n                GROUP BY Snapshot.xId\n</code></pre>\n\n<p>What I have so far is:</p>\n\n<pre><code>SELECT  Snapshot.xId,  MAX(Snapshot.TimeStamp) AS Timestamp_Actual, \n                dateadd(mm, datediff(mm,0, MAX(Snapshot.TimeStamp)), 0) AS TimestampRange_Start,\n                dateadd(dd, 0, dateadd(mm, datediff(mm,0, MAX(Snapshot.TimeStamp)), 0)) AS TimestampRange_End\n                FROM Snapshot\n                GROUP BY Snapshot.xId\n</code></pre>\n\n<p>From the above statement, I can then include a standard WHERE clause to check the values of TimestampRange_Start and TimestampRange_End to see if Timestamp_Actual falls between them.</p>\n"},{"tags":["sql-server","tsql","sql-server-2000"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":34,"score":-1,"question_id":12535982,"title":"DayOfYear function in T-SQL / SQL Server 2000","body":"<p>2 FEB is the 33rd day of the year, for example. </p>\n\n<p>Is there a built-in T-SQL function that returns the day-of-year (in SQL Server 2000)?  Or do you have to roll your own using casts to get the first day of the year for the supplied date, and then do a DateDiff?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":37,"score":1,"question_id":12541538,"title":"Add 0's in sql server","body":"<p>I have a query like this:</p>\n\n<pre><code>DECLARE @MilestoneName VARCHAR( 50 );\nSELECT @MilestoneName = 'Milsetone' + CAST( 001 AS VARCHAR );\n</code></pre>\n\n<p>This gives me the result <code>Milestone1</code></p>\n\n<p>But I want to the result to be <code>Milestone001</code> </p>\n\n<p>How can I achieve this?</p>\n"},{"tags":["sql","sql-server","tsql","concatenation"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":12556692,"title":"How to evenly space 3 concatenated fields in the result set","body":"<p>I have three fields that I concatenated into one field, but when I run the query the result-set is correct, but they are not evenly spaced within the one field.  How would I space them neatly and correctly.  Thank-you for the help.</p>\n\n<p>Here is the query:</p>\n\n<pre><code>SELECT CONVERT(varchar(20),Book)+ Space(2) + '(' + CONVERT(varchar(30),Year)\n+ ')' + Space(2) + '(' + CONVERT(varchar(30),Print) + ')' As  'Film Description', Genre,\nCost\nFROM Film\nOrder By Year DESC, Book ASC\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","select"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":12556318,"title":"How to get rid of zeros in the result-set of a select statement?","body":"<p>I have a join statement that is finding the ratio of cost to charge.  The query is right, but returning the 5 zeroes after the decimal place.  I tried the round function but it did not work.</p>\n\n<p>The Query:</p>\n\n<pre><code>Select Book, Year, (Round(Sum(Cost/Fee),2) As 'Ratio'\nFrom Book B\nInner Join Fees F\nOn B.Fee_Code = F.Fee_Code\nGroup By Book, Year;\n</code></pre>\n\n<p>It is returning 15.250000000 for the Ratio</p>\n\n<ul>\n<li>15.25 is correct, I just want to knock off the zeroes</li>\n</ul>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12552716,"title":"How to create column that can contain few parameters?","body":"<p>I need to create a SQL Server table.</p>\n\n<p>This table will have 4 columns.</p>\n\n<p>One of these columns, <code>colour</code>, will have to be with 3 parameters (HSL).</p>\n\n<p>It should look like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/x8Kim.png\" alt=\"enter image description here\"></p>\n\n<p>Any idea how can I implement this?</p>\n\n<p>Thank you in advance.</p>\n"},{"tags":["sql","tsql","recursion","common-table-expression"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":87,"score":2,"question_id":12549971,"title":"Recursion in SQL - Common Table Expression vs WHILE","body":"<p>I have this table:</p>\n\n<pre><code>Categories( CatId, Name, ParentId NULL )\n</code></pre>\n\n<p>...which is recursive, so each category can name a parent category, which in turn has a parent, and so on. Like so:</p>\n\n<pre><code>1, \"Sports\", NULL\n2, \"Football\", 1\n3, \"Golf\", 1\n4, \"Handegg\", 2\n5, \"Sex\", NULL\n6, \"On the beach\", 5\n</code></pre>\n\n<p>A while ago I used a CTE to perform a recursive lookup on a category's parent, like so:</p>\n\n<pre><code>WITH Categories(CatId, Name, ParentId, n) AS (\n    SELECT CatId, Name, ParentId, 1\n    FROM Categories\n    WHERE CatId = @categoryId\n\n    UNION ALL\n\n    SELECT c1.CatId, c1.Name, c1.ParentId, c2.n + 1\n    FROM Categories AS c1\n         INNER JOIN Categories AS c2 ON c1.CatId = c2.ParentId\n)\n</code></pre>\n\n<p>But I was thinking, couldn't I rephrase that as a WHILE query?</p>\n\n<pre><code>DECLARE @ret TABLE( CatId, Name, ParentId )\n\nDECLARE @tCatId int\nDECLARE @tName nvarchar(255)\nDECLARE @tParentId int NULL\n\nSELECT @tCatId = CatId, @tName = Name, @tParentId = ParentId\nFROM Categories\nWHERE CatId = @categoryId\n\nWHILE( @tParentId IS NOT NULL ) BEGIN\n    INSERT INTO @ret ( CatId, Name, ParentId ) VALUES ( @tCatId, @tName, @tParentId )\n\n    SELECT @tCatId = CatId, @tName = Name, @tParentId = ParentId\n    FROM Categories\n    WHERE CatId = @tParentId\nEND\n\nSELECT @ret\n</code></pre>\n\n<p>Obviously it's a bit rough around the edges (such as not completing when the first row's ParentId is NULL), and I haven't been able to test it (as my SQL Server is down for a rebuild), but surely it's just as correct?</p>\n"},{"tags":["sql","database","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":66,"score":2,"question_id":12472571,"title":"Alter table then update","body":"<p>How can I achieve this in transact sql.</p>\n\n<p>I want to add new column to existing table and then update it with some values. Is it possible to do it in one sql script or I should use separate scripts?</p>\n\n<p>Here is a samples code</p>\n\n<pre><code> ALTER TABLE my_table ADD my_new_column bit NULL;\n\n UPDATE my_table SET my_new_column = 0;\n</code></pre>\n\n<p>I know that I am doing writing while the column still doesn't exist so thats why these two lines are not working. But how to acheve this in one script, i.e use some delay or how to be sure the column is created and then write data to it?</p>\n\n<p>I used IF EXISTS with select from the table but it doesn't work.</p>\n\n<p>thanks</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":3,"up_vote_count":7,"down_vote_count":0,"view_count":10473,"score":7,"question_id":68677,"title":"How can I print a binary value as hex in TSQL?","body":"<p>I'm using SQL Server 2000 to print out some values from a table using <code>PRINT</code>.  With most non-string data, I can cast to nvarchar to be able to print it, but binary values attempt to convert using the bit representation of characters.  For example:</p>\n\n<pre><code>DECLARE @binvalue binary(4)\nSET @binvalue = 0x12345678\nPRINT CAST(@binvalue AS nvarchar)\n</code></pre>\n\n<p>Expected:</p>\n\n<blockquote>\n  <p>0x12345678</p>\n</blockquote>\n\n<p>Instead, it prints two gibberish characters.</p>\n\n<p>How can I print the value of binary data?  Is there a built-in or do I need to roll my own?</p>\n\n<p>Update: This isn't the only value on the line, so I can't just PRINT @binvalue.  It's something more like PRINT N'other stuff' + ???? + N'more stuff'.  Not sure if that makes a difference: I didn't try just PRINT @binvalue by itself.</p>\n"},{"tags":["tsql","stored-procedures","select"],"answer_count":3,"favorite_count":2,"up_vote_count":11,"down_vote_count":0,"view_count":13782,"score":11,"question_id":2881024,"title":"T-SQL get SELECTed value of stored procedure","body":"<p>In T-SQL, this is allowed:</p>\n\n<pre><code>DECLARE @SelectedValue int\nSELECT @SelectedValue = MyIntField FROM MyTable WHERE MyPrimaryKeyField = 1\n</code></pre>\n\n<p>So, it's possible to get the value of a SELECT and stuff it in a variable (provided it's scalar, obviously).</p>\n\n<p>If I put the same select logic in a stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE GetMyInt\nAS\nSELECT MyIntField FROM MyTable WHERE MyPrimaryKeyField = 1\n</code></pre>\n\n<p>Can I get the output of this stored procedure and stuff it in a variable?</p>\n\n<p>Something like:</p>\n\n<pre><code>DECLARE @SelectedValue int\nSELECT @SelectedValue = EXEC GetMyInt\n</code></pre>\n\n<p>(I know the syntax above is not allowed because I tried it!)</p>\n"},{"tags":["tsql","sql-server-2008-r2","running-total","cumulative-sum"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":137,"score":2,"question_id":12543127,"title":"TSQL cumulative column from previous row","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/860966/calculate-a-running-total-in-sqlserver\">Calculate a Running Total in SqlServer</a>  </p>\n</blockquote>\n\n\n\n<p>I need to use values from previous row inorder to generate a cumulative value as shown below. Always for each Code for the year 2000 the starting Base is 100.\nI need to ahieve this using tsql code.</p>\n\n<pre><code>id                Code              Yr             Rate           Base        \n\n1                   4               2000           5              100                                  \n2                   4               2001           7              107 (100+7)             \n3                   4               2002           4              111 (107+4)                              \n4                   4               2003           8              119 (111+8)\n5                   4               2004           10             129 (119+10)\n6                   5               2000           2              100\n7                   5               2001           3              103 (100+3)\n8                   5               2002           8              111 (103+8)\n9                   5               2003           5              116 (111+5)\n10                  5               2004           4              120 (116+4) \n</code></pre>\n"},{"tags":["sql-server","tsql","function","dynamic"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12543168,"title":"passing a TSQL function database name","body":"<p>Is there any way to pass a tsql function a database name so it can perform selects on that database</p>\n\n<pre><code>ALTER function [dbo].[getemailjcp]\n(\n@DB_Name varchar(100)\n)\nReturns varchar(4000)\nAS\nBEGIN\nDECLARE @out varchar (4000);\nDECLARE @in varchar (1000);\nSet @out = \n(select substring\n((select ';' + e.email from \n(SELECT DISTINCT ISNULL(U.nvarchar4, 'NA') as email \nFROM [@DB_Name].dbo.Lists ...\n</code></pre>\n"},{"tags":["asp.net",".net","sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":109,"score":1,"question_id":12545599,"title":"Unable to cast object of type 'System.DBNull' to type 'System.String'.","body":"<p>I have a problem at hand here that I can't seem to figure out. I have this Button which fires a OnClick. On this event I'm calling a stored procedure in the SQL server. Before creating a new record I have a check in place to see if the already exist. If it does then I'm outputting an error. This part works fine but when record doesn't exist I get this error in ASP.NET: </p>\n\n<p>\"Unable to cast object of type 'System.DBNull' to type 'System.String'.\"</p>\n\n<p>Any help would be really appreciated</p>\n\n<pre><code>protected void createloctype_Click(object sender, EventArgs e)\n{\n    con.Open();\n    cmd = new SqlCommand(\"sp_CREATE_LOCATION_TYPE\", con);\n    cmd.CommandType = CommandType.StoredProcedure;\n    cmd.Parameters.Add(\"@lt_code\", SqlDbType.VarChar, 2).Value = loctype.Text;\n    cmd.Parameters.Add(\"@lt_description\", SqlDbType.VarChar, 50).Value = loctypedescription.Text;\n    cmd.Parameters.Add(\"@lt_putaway_zone\", SqlDbType.VarChar, 5).Value = putaway_zone_txt.Text;\n    cmd.Parameters.Add(\"@lt_rule1\", SqlDbType.VarChar, 5).Value = rule1_txt.Text;\n    cmd.Parameters.Add(\"@lt_rule2\", SqlDbType.VarChar, 5).Value = rule2_txt.Text;\n    cmd.Parameters.Add(\"@lt_rule3\", SqlDbType.VarChar, 5).Value = rule3_txt.Text;\n    cmd.Parameters.Add(\"@lt_rule4\", SqlDbType.VarChar, 5).Value = rule4_txt.Text;\n    cmd.Parameters.Add(\"@lt_rule5\", SqlDbType.VarChar, 5).Value = rule5_txt.Text;\n    cmd.Parameters.Add(\"@lt_misc1\", SqlDbType.VarChar, 500).Value = misc1_txt.Text;\n    cmd.Parameters.Add(\"@lt_misc2\", SqlDbType.VarChar, 500).Value = misc2_txt.Text;\n    cmd.Parameters.Add(\"@lt_misc3\", SqlDbType.VarChar, 500).Value = misc3_txt.Text;\n    cmd.Parameters.Add(\"@lt_misc4\", SqlDbType.VarChar, 500).Value = misc4_txt.Text;\n    cmd.Parameters.Add(\"@lt_misc5\", SqlDbType.VarChar, 500).Value = misc5_txt.Text;\n    cmd.Parameters.Add(\"@lt_user\", SqlDbType.VarChar, 10).Value = user;\n    cmd.Parameters.Add(\"@error\", SqlDbType.VarChar, 250);\n    cmd.Parameters[\"@error\"].Direction = ParameterDirection.Output;\n    cmd.ExecuteNonQuery();                 \n    message = (string)cmd.Parameters[\"@error\"].Value;\n\n    error_message.Text = message;\n\n    con.Close();\n\n}\n</code></pre>\n\n<p>/STORED PROCEDURE/</p>\n\n<pre><code>USE [1_WMS]\n\nGO\n\nALTER PROCEDURE [dbo].sp_CREATE_LOCATION_TYPE\n@LT_CODE VARCHAR(5)\n, @LT_DESCRIPTION VARCHAR(250)\n, @LT_PUTAWAY_ZONE VARCHAR(5)\n, @LT_RULE1 VARCHAR(5)\n, @LT_RULE2 VARCHAR(5)\n, @LT_RULE3 VARCHAR(5)\n, @LT_RULE4 VARCHAR(5)\n, @LT_RULE5 VARCHAR(5)\n, @LT_MISC1 VARCHAR(20)\n, @LT_MISC2 VARCHAR(20)\n, @LT_MISC3 VARCHAR(20)\n, @LT_MISC4 VARCHAR(20)\n, @LT_MISC5 VARCHAR(20)\n, @LT_USER VARCHAR(20)\n, @ERROR VARCHAR(250) OUT\n\nAS\nDECLARE\n    @LT_DATE VARCHAR(10)\n    , @LT_TIME VARCHAR(8)\n    , @LT_ROW_COUNT INT\n\nSET @LT_DATE = CONVERT(VARCHAR(10), GETDATE(),101)\nSET @LT_TIME = CONVERT(VARCHAR(8), GETDATE(),114)   \n\n/* CHECK FOR EXISTING */\nSELECT @LT_ROW_COUNT = COUNT(*)\n    FROM LOC_TYPE(NOLOCK)\nWHERE lt_code = @LT_CODE\n\n/*  */\nIF @LT_ROW_COUNT = 0\n    BEGIN\n        INSERT INTO LOC_TYPE\n            (\n                lt_code             , lt_description            , lt_putaway_zone               , lt_rule_1\n                , lt_rule_2         , lt_rule_3                 , lt_rule_4                     , lt_rule_5\n                , lt_misc1          , lt_misc2                  , lt_misc3                      , lt_misc4\n                , lt_misc5          , lt_created_date           , lt_created_time               , lt_created_by\n                , lt_modify_date    , lt_modify_time            , lt_modify_by  \n            )\n            VALUES\n            (\n                @LT_CODE            , @LT_DESCRIPTION           , @LT_PUTAWAY_ZONE              , @LT_RULE1\n                , @LT_RULE2         , @LT_RULE3                 , @LT_RULE4                     , @LT_RULE5\n                , @LT_MISC1         , @LT_MISC2                 , @LT_MISC3                     , @LT_MISC4\n                , @LT_MISC5         , @LT_DATE                  , @LT_TIME                      , @LT_USER\n                , @LT_DATE          , @LT_TIME                  , @LT_USER \n            )\n    END\n\nELSE IF @LT_ROW_COUNT = 1\n    BEGIN\n\n        SET @ERROR = 'LOCATIOIN TYPE ALREADY EXIST'\n\n        EXEC sp_CREATE_ERROR_MESSAGE\n            'CRT_LTY'       , @ERROR            , @LT_CODE          , @LT_PUTAWAY_ZONE\n            , @LT_RULE1     , @LT_RULE2         , @LT_RULE2         , @LT_RULE3\n            , @LT_RULE4     , @LT_RULE5         , ''                , ''        \n            , @LT_USER\n    END\n\n\nGO\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12538696,"title":"transforming/manipulating result of a tsql join","body":"<p>I have a dataset like the following:</p>\n\n<pre><code>dataset1:\n **columns:** id  type  loc  x_qty  y_qty  z_qty  j_1   j_2   date\n **row: **   1   fe    32   292    394    112    NULL  NULL  2012-09-21\n **row: **   2   fd    30   298    394    112    NULL  NULL  2012-09-22\n **row: **   3   fc    31   343    394    112    NULL  NULL  2012-09-23\n</code></pre>\n\n<p>and I'm left joining dataset2 onto dataset1 on type, loc, and date to get j_1 and j_2</p>\n\n<pre><code>dataset2:\n**columns:** id  type  loc  x_qty  y_qty  z_qty  j_1   j_2   date\n**row: **    1   fe    32   NULL   NULL   NULL   239   349   2012-09-21\n**row: **    2   fe    31   NULL   NULL   NULL   209   319   2012-09-23\n</code></pre>\n\n<p>My problem is that dataset1 has a row for every single day, while dataset2 only has rows for days that j_1 and j_2 have values. So for the ending dataset, there will be a NULL in j_1 and j_2 for every date that does not exist in dataset2. </p>\n\n<p>My question: Is there a way, to put the value for the previous date in the column if there is not a date. For example, using the datasets above. 9-22 does not exist in dataset 2, so there will be a the 9-22 row in the final result, with NULLs in j_1 and j_2, is there a way to use the previous date's values of j_1 and j_2 and put them in that row?</p>\n\n<p>Thanks in advance for any help!</p>\n\n<p>SQL SERVER 2008</p>\n"},{"tags":["sql","string","tsql","function","append"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":59,"score":2,"question_id":12542916,"title":"TSQL function that returns a string of delimited emails - trying nested select","body":"<p>I have a table with column <code>email</code>. I need to return all those emails in a string. I'm trying this code but getting:</p>\n\n<pre><code>Msg 102, Level 15, State 1, Procedure getemailjcp, Line 24\nIncorrect syntax near '='.\nMsg 102, Level 15, State 1, Procedure getemailjcp, Line 31\nIncorrect syntax near 'a'.\n</code></pre>\n\n<p>TSQL function:</p>\n\n<pre><code>ALTER function [dbo].[getemails]\n(\n    @DB_Name varchar(100)\n)\nReturns varchar(4000)\nAS\nBEGIN\n    DECLARE @out varchar (4000);\n    DECLARE @in varchar (4000);\n    SET @out =\n        (\n            SELECT @in = @in + email +'; ' \n            FROM \n                (\n                    SELECT DISTINCT ISNULL(U.nvarchar4, 'NA') as email\n                    FROM\n                        sometable\n            ) a\n        ) b\n    RETURN @out\nEND\n</code></pre>\n"},{"tags":["mysql","sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":52,"score":5,"question_id":12543397,"title":"Does the user who executes a stored procedure which contains a delete query need delete permission?","body":"<p>Or do they need to be granted to delete a record from a table only when they execute a query which is not a stored procedure?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":170,"score":0,"question_id":12541265,"title":"Using if-else in where clause in SQL Server 2008","body":"<p>I need to implement in the <code>where</code> clause. </p>\n\n<p>I tried in <code>case</code> statement but between cannot be used in <code>case</code> statement</p>\n\n<pre><code>where \n    if  start_mth &lt; end_mth\n        mth_no between start_mth and end_mth\n    else start_mth &gt; end_mth\n        mth_no between start_mth and 12\n                      or\n        mth_no between 1 and end_mth\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":64,"score":1,"question_id":12525371,"title":"MSSQL SUM Issue","body":"<p>I am trying to run through a table and get the sum of the <code>mins</code> column however it always tells me that <code>mins</code> is not a valid column name</p>\n\n<pre><code>SELECT \n    acs.cid, \n    DATEDIFF (n, acs.StartTime, acs.EndTime ) as prepromomins,\n    CASE \n        WHEN (p.multiplier is null) THEN DATEDIFF (n , acs.StartTime, acs.EndTime)\n        ELSE (DATEDIFF ( n , acs.StartTime , acs.EndTime ) * p.multiplier) \n    END AS mins \nFROM \n    activecards as acs\n    LEFT JOIN Promotions as p \n    ON acs.StartTime &gt; p.StartTime and acs.EndTime &lt; p.EndTime\n</code></pre>\n"},{"tags":["c#","asp.net",".net","visual-studio","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12538175,"title":"Can one use sql query in default.aspx web application","body":"<p>Can I use sql query and alter server url based on the sql query result?</p>\n\n<p>If sql query gives value of 1, point the server to home.aspx and if the sql query gives value of 0, point to home2.aspx?</p>\n\n<p>I am trying to show different person different homepage based on a specific associated value in sql database.</p>\n\n<p>Thank you</p>\n\n<p>p.s. I honestly dont know how the log in works. I am not a .net guy and didn't create the system. I know about URL direct for the server in default.aspx because I have been through that. there is singlesignon settings applied on the website so when a user logs into the lets say web A, he/she can click on a hyperlink, it will pass the encrypted user login info and the user will automatically be on the home page of website b (log in page for website B is skipped). I will update my acceptance rate. </p>\n\n<p>Thank you</p>\n\n<p>p.s. 2: I am just trying to pull the INCOMING user's active flag from a column in a table in a sql db. If the flag for that particular user is set to 1, point them to URL A, if flag is set to 0, point them to URL B.</p>\n\n<p>Thank you</p>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12538880,"title":"tsql - how to pivot the following table?","body":"<p>How to pivot the following table by week1, week2, week3..etc. for each month? Thanks.</p>\n\n<p>for example\ndb table:</p>\n\n<p><img src=\"http://i.stack.imgur.com/d2fMm.jpg\" alt=\"enter image description here\"></p>\n\n<p>This is the table I need:</p>\n\n<p><img src=\"http://i.stack.imgur.com/NDWrQ.jpg\" alt=\"enter image description here\"></p>\n\n<p>This is what I did but I need more efficient way to do this.</p>\n\n<pre><code>SELECT    'Oct' AS [Month]\n,[Ocd]\n          ,(select Wk_Cmpl from tb1 where WkNum = '1' and RIGHT(wkdt,2) = '10' and Ocd = '167') as wk1\n          ,(select WKLY_PCT from tb1 where WkNum = '1' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as [wk1%]\n          ,(select WE from tb1 where WKNum = '2' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as wk2\n          ,(select WKLY_PCT from tb1 where WkNum = '2' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as [wk2%]\n          ,(select WE from tb1 where WkNum = '3' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as wk3\n          ,(select WKLY_PCT from tb1 where WkNum = '3' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as [wk3%]\n          ,(select WE from tb1 where WkNum = '4' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as wk4\n          ,(select WKLY_PCT from tb1 where WkNum = '4' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as [wk4%]\n          ,(select WE from tb1 where WkNum = '5' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as wk5\n          ,(select WKLY_PCT from tb1 where WkNum = '5' and SUM_LVL_Sort=3.00 and RIGHT(wkdt,2) = '10' and Ocd = '167') as [wk5%]\n          ,[WKLY_AVG]                           As [Wk Avg] \n          ,[MTH]                                AS [Mo. Cmpl] \n          ,[COMB_FYTD_COMPLT_ALL]               As [M/YTD Total]\n          ,[COMB_FYTD_COMPLT_TARGET_PCT]        As [% Goal]\nFROM tb1\n</code></pre>\n"},{"tags":["sql","tsql","join"],"answer_count":4,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":79,"score":1,"question_id":12536538,"title":"How to make an sql join to achieve desired result?","body":"<p>I have 2 selects which are returning:</p>\n\n<pre><code>SELECT_A (COLUMN_A,COLUMN_B, SELECT_A_JOIN_COLUMN)\n\nSELECT_B (COLUMN_A,COLUMN_B, SELECT_B_JOIN_COLUMN)\n</code></pre>\n\n<p>Desired result:</p>\n\n<pre><code>Result  (COLUMN_A,COLUMN_B,SELECT_A_JOIN_COLUMN,SELECT_B_JOIN_COLUMN)\n</code></pre>\n\n<p>example:</p>\n\n<p><code>SELECT_A</code> result:</p>\n\n<pre><code>A B zxc\nA B rty\n</code></pre>\n\n<p><code>SELECT_B</code> result:</p>\n\n<pre><code>A B yui\nA B hjk\n</code></pre>\n\n<p>desired result:</p>\n\n<pre><code>A B zxc null\nA B rty null\nA B null yui\nA B null hjk\n</code></pre>\n\n<p>How to achieve this?</p>\n\n<p>It's almost like union, but can I do this with a join?</p>\n\n<p><strong>EDIT</strong>:</p>\n\n<p>Ok. So let me state my goal. I want to make query returning a hierarchical tree.\nIt's because LINQ2Entities is generating extra slow and unefficient sql for query with many includes for navigation properties.</p>\n\n<p>So what I want to achieve first is to get the tree... somehow.</p>\n\n<p>Example:</p>\n\n<p>I want to achieve result as:</p>\n\n<pre><code>ObjectId | ChildType1Id | ChildType1Field | ChildType2Id | ChildType2Field\n\n    1          34          asd          null        null\n    1          12          xcv          null        null\n    1          5           klk          null        null\n    1          null        null         6           vbn\n    1          null        null         7           jkh\n</code></pre>\n\n<p>I got so far 2 simple selects with left joins which return me:</p>\n\n<pre><code>ObjectId  | ChildType1Id | ChildType1Field\n    1          34             asd\n    1          12             zcv\n    1          5              klk\n</code></pre>\n\n<p>and</p>\n\n<pre><code>ObjectId  | ChildType2Id | ChildType2Field\n   1             6           vbn \n   1             7           jkh\n</code></pre>\n\n<p>What if I will have more children types?\nFor each childType it seems I do need to use an union. If I will have 50 columns, i need to state all those columns in UNION (because it needs the same number of columns).\nCan I avoid making all those unions with something like join just to add the columns i need (next childrentype columns)?</p>\n\n<p>Desired result for 3 different childrenTypes:</p>\n\n<pre><code>ObjectId|ChildType1Id|ChildType1Field|ChildType2Id|ChildType2Field|ChildType3Id|ChildType3Field\n\n    1          34          asd          null        null       null         null \n    1          12          xcv          null        null       null         null\n    1          5           klk          null        null       null         null\n    1          null        null         6           vbn        null         null\n    1          null        null         7           jkh        null         null\n    1          null        null         null        null        5           iop\n    1          null        null         null        null        9           klp\n</code></pre>\n\n<p>Any help appreciated.</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":74,"score":1,"question_id":12516079,"title":"Tsql - Is there an efficient way to query this?","body":"<p>Is there an efficient or simple way to query this? for example to minimize server load. Thanks!</p>\n\n<p>db table</p>\n\n<pre><code>qId     WKDT    WK_ENDT                  SUM_LVL_Sort  ADOCD  ocd  OfficeName     WKLY_AVG  WeekCode\n------  ------  -----------------------  ------------  -----  ---  -------------  --------  --------\n201112  201110  2011-10-28 00:00:00.000  19.00         NULL   NAT  NATION         2.23      n\n201112  201110  2011-10-28 00:00:00.000  13.00         NULL   F09  SAN FRANCISCO  2.20      n\n201112  201111  2011-11-25 00:00:00.000  19.00         NULL   NAT  NATION         2.39      n\n201112  201111  2011-11-25 00:00:00.000  13.00         NULL   F09  SAN FRANCISCO  2.14      n\n201112  201112  2011-12-30 00:00:00.000  19.00         NULL   NAT  NATION         2.37      n\n201112  201112  2011-12-30 00:00:00.000  13.00         NULL   F09  SAN FRANCISCO  2.18      n\n</code></pre>\n\n<p>This is the layout I need</p>\n\n<pre><code>WK_ENDT                  adocd  ocd  OfficeName     SUM_LVL_Sort  10    11    12\n-----------------------  -----  ---  -------------  ------------  ----  ----  ----\n2011-10-07 00:00:00.000  NULL   F09  SAN FRANCISCO  13.00         2.2   2.14  2.18\n2011-10-07 00:00:00.000  NULL   NAT  NATION         19.00         2.23  2.39  2.37\n</code></pre>\n\n<p>tql query</p>\n\n<pre><code> select TOP 1 (WK_ENDT),\n     ,SUM_LVL_Sort\n     ,ADOCD     as adocd\n     ,Alias   as ocd\n     ,OfficeName\n     ,(select WKLY_AVG from kpi.dbo.tb_ssi_rzli where SUM_LVL_Sort = 19.00 and RIGHT(wkdt,2) = '10' and weekcode = 'n'  ) as [10]\n     ,(select WKLY_AVG from kpi.dbo.tb_ssi_rzli where SUM_LVL_Sort = 19.00 and RIGHT(wkdt,2) = '11' and weekcode = 'n'  ) as [11]\n     ,(select WKLY_AVG from kpi.dbo.tb_ssi_rzli where SUM_LVL_Sort = 19.00 and RIGHT(wkdt,2) = '12' and weekcode = 'n'  ) as [12]\nfrom kpi.dbo.tb_ssi_rzli\nwhere SUM_LVL_Sort = 19.00 and right(qId,2) = '12' and WeekCode = 'n'\norder by WK_ENDT desc\n</code></pre>\n\n<p>bluefeet's query result</p>\n\n<pre><code>WK_ENDT                  SUM_LVL_Sort  adocd  ocd  OfficeName  10    11    12\n-----------------------  ------------  -----  ---  ----------  ----  ----  ----\n2011-12-30 00:00:00.000  19.00         NULL   NAT  NATION      NULL  NULL  2.37\n2011-11-25 00:00:00.000  19.00         NULL   NAT  NATION      NULL  2.39  NULL\n2011-10-28 00:00:00.000  19.00         NULL   NAT  NATION      2.23  NULL  NULL\n</code></pre>\n"},{"tags":["sql-server-2005","tsql","xml-namespaces"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":2866,"score":3,"question_id":5467387,"title":"Ignore XML namespace in T-SQL","body":"<p>How do I remove/ignore the XML namespace in an xml file when querying the data with T-SQL?</p>\n\n<p>Im loading an xml file into a variable, and it works just fine. But the xml has a namespace set, and unless I remove it, my queries come up empty.</p>\n\n<p>T-SQL:</p>\n\n<pre><code>DECLARE @xml xml\nSELECT @xml = BulkColumn FROM OPENROWSET(BULK 'C:\\myfile.xml', SINGLE_BLOB) AS A\n\nSELECT X.z.value('ID[1]', 'VARCHAR(3)') FROM @xml.nodes('myroot/element') AS X(z)\n</code></pre>\n\n<p>XML sample:</p>\n\n<pre><code>&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;myroot xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"&gt;\n  &lt;element&gt;\n    &lt;ID&gt;1&lt;/ID&gt;\n  &lt;/element&gt;\n  &lt;element&gt;\n    &lt;ID&gt;2&lt;/ID&gt;\n  &lt;/element&gt;\n  &lt;element&gt;\n    &lt;ID&gt;3&lt;/ID&gt;\n  &lt;/element&gt;\n&lt;/myroot&gt;\n</code></pre>\n\n<p>This works, the query returns this:</p>\n\n<blockquote>\n  <p>1<br>\n  2<br>\n  3  </p>\n</blockquote>\n\n<p>But the XML also contains a default namespace:</p>\n\n<pre><code>&lt;myroot xmlns=\"http://XXX\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"&gt;\n</code></pre>\n\n<p>The <code>xmlns=\"http://XXX\"</code> completely screws up my query. And unfortunately manually modifying the xml before loading it is not really an option.</p>\n\n<p><strong>Questions:</strong>  </p>\n\n<ul>\n<li>How do I remove or ignore the namespace when I load the data into the variable? </li>\n<li>Or how do I modify my query to handle the namespace?</li>\n</ul>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12537531,"title":"SQL Server 2008 - need help merging 2 tables (cartesian)","body":"<p>I have 2 tables that are not related at all and I need to put them together - one column per table. When I try the cartesian join, I end up with every combination:</p>\n\n<pre><code>SELECT Field1, Field2 FROM Table1, Table2\n</code></pre>\n\n<p>Result:</p>\n\n<pre><code>Table1.Field1 Table2.Field2\n---------------------------\n1             1\n1             2\n1             3 \n2             1\n2             2\n2             3\n3             1\n3             2\n3             3\n</code></pre>\n\n<p>I need it to return side-by-side:</p>\n\n<pre><code>Table1.Field1 Table2.Field2\n---------------------------\n1             1\n2             2\n3             3 \n</code></pre>\n\n<p>is this possible? Thanks in advance</p>\n\n<p><em><strong>EDIT</em></strong></p>\n\n<pre><code>Table1.Table1IDs\n----------------\n1\n2\n3\n4\n5\n\nTable2.Table2IDs\n----------------\n6\n7\n8\n9\n10\n</code></pre>\n\n<p>Desired output (into a temp table/select statement)</p>\n\n<pre><code>Table1.Table1IDs    Table2.Table2IDs\n------------------------------------\n1                   6\n2                   7\n3                   8\n4                   9\n5                   10\n</code></pre>\n\n<p>So that I can then do my insert into the actual table I need to do an insert:</p>\n\n<pre><code>INSERT INTO dbo.MTMObjects\n    SELECT Table1IDs, Table2IDs \n    FROM [temp table or solution]\n</code></pre>\n\n<p><em><strong>ANSWER</em></strong>\nBluefeet gave me the idea to use temp tables with an identity column that i can then use to join.  His is 'safer' because you aren't relying on SQL's good humor to sort both recordsets the same, but this might help the next guy:</p>\n\n<pre><code>DECLARE @tmp_Table1 TABLE(ID int IDENTITY(1,1) NOT NULL, TableID1 int NOT NULL)\nDECLARE @tmp_Table2 TABLE(ID int IDENTITY(1,1) NOT NULL, TableID2 int NOT NULL)\n\nINSERT INTO @tmp_Table1 \n    OUTPUT INSERTED.Field1\nSELECT * FROM Table1\n\nINSERT INTO @tmp_Table2 \n    OUTPUT INSERTED.Field2\nSELECT * FROM Table2\n\nOUTPUT\nSELECT tmp1.Field1, tmp2.Field2 \nFROM @tmp_Table1 tmp1 INNER JOIN @tmp_Table2 tmp2 ON tmp2.ID = tmp1.ID\n</code></pre>\n\n<p>CHEERS!</p>\n"},{"tags":["sql-server","tsql","date","ssis"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":111,"score":2,"question_id":12532839,"title":"Extracting 6-8 digit dates from alphanumeric fields","body":"<p>Screenshot explains it all.\n<a href=\"http://i46.tinypic.com/f3hobl.png\" rel=\"nofollow\">http://i46.tinypic.com/f3hobl.png</a></p>\n\n<p>With the current configuration, <strong>InvoiceSentDate</strong> only accepts 8-digit dates (MM-DD-YY). I want to be able to capture MM-DD-YYYY dates as well. How do I do this?</p>\n\n<p>For comparison, look at invoice 2106-2112 vs 2116.</p>\n\n<p>FURTHERMORE, to complicate things! Some records have text after the date.\n<a href=\"http://i50.tinypic.com/2r5qa88.png\" rel=\"nofollow\">http://i50.tinypic.com/2r5qa88.png</a></p>\n"},{"tags":["sql","tsql","stored-procedures","ado.net"],"answer_count":6,"favorite_count":6,"up_vote_count":21,"down_vote_count":0,"view_count":22748,"score":21,"question_id":749622,"title":"How to get Return Value of a Stored Procedure","body":"<p>Probably an easy-to-answer question. I have this procedure:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[AccountExists]\n    @UserName nvarchar(16)\nAS\nIF EXISTS (SELECT Id FROM Account WHERE UserName=@UserName)\nSELECT 1\nELSE SELECT 0\n</code></pre>\n\n<p>When I have ADO.NET code that calls this procedure and does this:</p>\n\n<pre><code>return Convert.ToBoolean(sproc.ExecuteScalar());\n</code></pre>\n\n<p>Either true or false is returned.</p>\n\n<p>When I change the stored procedure to RETURN 1 or 0 instead of SELECT:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[AccountExists]\n    @UserName nvarchar(16)\nAS\nIF EXISTS (SELECT Id FROM Account WHERE UserName=@UserName)\nRETURN 1\nELSE RETURN 0\n</code></pre>\n\n<p>sproc.ExecuteScalar() returns null. If I try sproc.ExecuteNonQuery() instead, -1 is returned.</p>\n\n<p><strong>How do I get the result of a stored procedure with a RETURN in ADO.NET?</strong></p>\n\n<p>I need AccountExists to RETURN instead of SELECT so I can have another stored procedure call it:</p>\n\n<pre><code>--another procedure to insert or update account\n\nDECLARE @exists bit\n\nEXEC @exists = [dbo].[AccountExists] @UserName \n\nIF @exists=1\n--update account\nELSE\n --insert acocunt\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":101,"score":0,"question_id":12536232,"title":"Using T-SQL to convert Table to HTML, handling NULL issue","body":"<pre><code>DECLARE @tableHTML  NVARCHAR(MAX) ;\n\nSET @tableHTML =\n    N'&lt;H1&gt;Report Heading&lt;/H1&gt;' +\n    N'&lt;table border=\"1\"&gt;' +\n    N'&lt;th&gt;Check Number&lt;/th&gt;' +\n    N'&lt;th&gt;Last Operator Date&lt;/th&gt;' +\n    N'&lt;th&gt;Last Timestamp&lt;/th&gt;' +\n    N'&lt;th&gt;Run Date&lt;/th&gt;' +\n    N'&lt;th&gt;Issued Check Number&lt;/th&gt;' +\n    N'&lt;th&gt;Error Description&lt;/th&gt;' +\n    '&lt;tr&gt;' +\n    CAST ( ( SELECT td = S.CHK_NUM,       '',\n                    td = S.LAST_OPER_ID, '',\n                    td = S.LAST_TIMESTMP, '',\n                    td = S.RUN_DT, '',\n                    td = ISNULL(S.RE_ISSUE_CHK_NUM,-1), '',\n                    td = ISNULL(S.ERR_DESC,'&lt;null&gt;'), ''\n              FROM STAGNG_CDDP_ERR_RCD S\n              FOR XML PATH('tr'), TYPE \n    ) AS NVARCHAR(MAX) ) +\n    N'&lt;/table&gt;' ;\n\nPRINT @tableHTML\n</code></pre>\n\n<p>If I attempt to substiture -1 with a varchar literal '(Null)', I get the error</p>\n\n<pre><code>Msg 245, Level 16, State 1, Line 3\nConversion failed when converting the varchar value 'Null' to data type int.\n</code></pre>\n\n<p>I would prefer to display  if the RE_ISSUE_CHK_NUM is null, but that field is an int and i believe the \"TYPE\" param is forcing teh returned value to match the original column's type.</p>\n\n<p>How do I modify the output so all of teh columns are text and hence formattable?</p>\n\n<p><strong>Edit</strong></p>\n\n<p>When I try this...</p>\n\n<pre><code>DECLARE @tableHTML  NVARCHAR(MAX) ;\n\nSET @tableHTML =\n    N'&lt;H1&gt;Report Heading&lt;/H1&gt;' +\n    N'&lt;table border=\"1\"&gt;' +\n    N'&lt;th&gt;Check Number&lt;/th&gt;' +\n    N'&lt;th&gt;Last Operator Date&lt;/th&gt;' +\n    N'&lt;th&gt;Last Timestamp&lt;/th&gt;' +\n    N'&lt;th&gt;Run Date&lt;/th&gt;' +\n    N'&lt;th&gt;Issued Check Number&lt;/th&gt;' +\n    N'&lt;th&gt;Error Description&lt;/th&gt;' +\n    '&lt;tr&gt;' +\n    CAST ( ( SELECT td = S.CHK_NUM,       '',\n                    td = S.LAST_OPER_ID, '',\n                    td = S.LAST_TIMESTMP, '',\n                    td = S.RUN_DT, '',\n                    --td = ISNULL(S.RE_ISSUE_CHK_NUM,-1), '',\n                    td = CONVERT(NVARCHAR(16), ISNULL(S.RE_ISSUE_CHK_NUM,'(Null)')), '',\n                    td = ISNULL(S.ERR_DESC,'&lt;null&gt;'), ''\n              FROM STAGNG_CDDP_ERR_RCD S\n              FOR XML PATH('tr'), TYPE \n    ) AS NVARCHAR(MAX) ) +\n    N'&lt;/table&gt;' ;\n\nPRINT @tableHTML\n</code></pre>\n\n<p>I get this:</p>\n\n<pre><code>Msg 245, Level 16, State 1, Line 3\nConversion failed when converting the varchar value '(Null)' to data type int.\n</code></pre>\n\n<p>It's tthe Check Number field that is Null that is numeric that i would like to display the string 'Null' in the HTML.</p>\n\n<p>Is it the <code>TYPE</code> param that is the issue?</p>\n"},{"tags":["sql-server","performance","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":337,"score":1,"question_id":10722339,"title":"DBCC FREEPROCCACHE and DBCC DROPCLEANBUFFERS alike for specific scope","body":"<p>I would like to check options to improve my queries. </p>\n\n<p>sometimes, i want to do the tests on a production server so i can't use DBCC FREEPROCCACHE\nand DBCC DROPCLEANBUFFERS to clear the entire server cache. </p>\n\n<p>could you please share with me the way to do a kind of \"cache clean\" only for my connection/scope?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","tsql","common-table-expression"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12534790,"title":"Looking for Suggesting on Making These Recursive CTEs More Efficient","body":"<p>Pretty new to CTEs (today actually). I wanted to search a tree and, at any node that matches the filter, build the tree going up (take only parent nodes) and down (take all children). I was successful with the following T-SQL:</p>\n\n<pre><code>DECLARE @Filter varchar(255);\nSET @Filter = 'test';\n\nWITH ClimbUpCte AS \n    (\n        SELECT ID, ParentID, Name\n        FROM   Nodes\n        WHERE  Name LIKE '%' + @Filter + '%'\n\n        UNION ALL\n\n        SELECT n.ID, n.ParentID, n.Name\n        FROM   Nodes n INNER JOIN \n               ClimbUpCte cte ON cte.ParentID = n.ID\n    )\nSELECT   ID, ParentID, Name\nINTO     #ClimbUpCte\nFROM     ClimbUpCte\nGROUP BY ID, ParentID, Name;\n\nWITH ClimbDownCte AS\n    (\n        SELECT *\n        FROM #ClimbUpCte\n        WHERE Name LIKE '%' + @Filter + '%'\n\n        UNION ALL\n\n        SELECT n.ID, n.ParentID, n.Name\n        FROM   Nodes n INNER JOIN\n               ClimbDownCte cte ON cte.ID = n.ParentID \n        WHERE  NOT n.ID IN \n            (SELECT ID \n             FROM #ClimbUpCte)\n    )\nSELECT   ID, ParentID, Name\nFROM     ClimbDownCte\nGROUP BY ID, ParentID, Name\nUNION ALL\nSELECT   *\nFROM     #ClimbUpCte\nWHERE    NOT ID IN \n    (SELECT ID \n     FROM ClimbDownCte)\n</code></pre>\n\n<p>My question is, how efficient is this and can the same thing be written in a smarter more efficient way?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":104,"score":2,"question_id":3778006,"title":"Read-only committed data","body":"<p>I have a table called [Test], which has a single column [Id] int.</p>\n\n<p>I open a transaction, insert one row to the table and NOT commit it.</p>\n\n<pre><code>begin tran\ninsert into [Test]([Id]) values(1)\n</code></pre>\n\n<p>In another request I want to select data from table [Test].\nHow can I read only committed data immediately?</p>\n\n<p>Readcommited table hint holds a lock.</p>\n\n<pre><code>select * from test with(readcommitted) \n</code></pre>\n\n<p>Thank you.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":3,"up_vote_count":6,"down_vote_count":0,"view_count":1493,"score":6,"question_id":3317433,"title":"delete duplicate records in SQL Server","body":"<p>Consider a column named <code>EmployeeName</code> table <code>Employee</code>. The goal is to delete repeated records, based on the <code>EmployeeName</code> field.</p>\n\n<pre><code>EmployeeName\n------------\nAnand\nAnand\nAnil\nDipak\nAnil\nDipak\nDipak\nAnil\n</code></pre>\n\n<p>Using one query, I want to delete the records which are repeated.</p>\n\n<p>How can this be done with TSQL in SQL Server?</p>\n"},{"tags":["sql-server-2008","tsql","parameters","filter","null"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":12533003,"title":"Handling T-SQL Query with null filters as parameters","body":"<p>Suppose I have a stored procedure where I'm passing in 5 filters as parameters.  These parameters are filters to each column in my query.  My query has 5 fields.  What is the best way to prevent my query from throwing an exception/error if I have 1 or more NULL (or '') valued parameters for my filters?</p>\n\n<pre><code>    SELECT \n        [helpings_turkey],\n        [helpings_green_beans],\n        [scoops_squash],\n        [qty_buscuits],\n        [pieces_pie]\n    FROM\n        [thanksgiving_guest]\n    WHERE \n        [helpings_turkey] &gt; @helpings_turkey_filter\n        AND [helpings_green_beans] &gt; @helpings_green_beans_filter\n        AND [scoops_squash] &gt; @scoops_squash_filter\n        AND [qty_buscuits] &gt; @qty_buscuits_filter\n        AND [pieces_pie] &gt; @pieces_pie_filter\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":12533054,"title":"Inserting blob file with tsql but source file is only on client machine not at the server side?","body":"<p>I want to put a file as a blob in to my database. The file is not on the sql server side, but only on my client from where i start the sql skripts.</p>\n\n<p>If I try to open the file like this </p>\n\n<pre><code>select * from openrowset(BULK, 'E:\\Installer\\metadata.hwr.de.xml',SINGLE_BLOB) a,\n</code></pre>\n\n<p>I receive the error</p>\n\n<pre><code>Msg 4861, Level 16, State 1, Line 1\nCannot bulk load because the file \"E:\\Installer\\metadata.hwr.de.xml\"\ncould not be opened.  Operating system error code 3(The system cannot find the path specified.).\n</code></pre>\n\n<p>Only when I add the file to the server, it will work. Is there a possibility to achieve this?</p>\n\n<p>Thanks </p>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":2331904,"title":"Generate calendar ","body":"<p>How can I generate the dates for the entire range? \nThanks</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12532782,"title":"Query to know the average of data in each day","body":"<p>I want to know de average of numbers of datas in each date in august month. </p>\n\n<p><strong>Example</strong></p>\n\n<pre><code>31-08 - 2 registers\n30-08 - 3 registers\n</code></pre>\n\n<p>I tryied the follow query, but without success</p>\n\n<pre><code>SELECT AVG(ROW_NUMBER() over (order by Chave_ID desc)), DATEPART(day, datahora) \nfrom San_Chave \nwhere DATEPART(month, datahora) = 8 \ngroup by DATEPART(day, datahora), Chave_ID\norder by DATEPART(day, datahora)  desc\n</code></pre>\n\n<p>DataHora is <code>DateTime</code> type and \nChave_Id is <code>Primary Key</code> but the numbers aren't in a logical order, so I try to use <code>ROW_NUMBER()</code> function</p>\n\n<p>Somebody can help me ?</p>\n\n<p><strong>OUTPUT THAT I DESIRE</strong></p>\n\n<pre><code>MONTH  DAY    REGISTER\n8      31     10\n8      30     9\n8      29     1\n</code></pre>\n\n<p><strong>TABLE</strong></p>\n\n<p>To do the query I think will need just the <code>Chave_Id</code> and <code>DataHora</code>, <code>Chave_id</code> will be the numbers of registers</p>\n\n<pre><code>CREATE TABLE [dbo].[San_Chave](\n    [Chave_Id] [int] IDENTITY(1,1) NOT NULL,\n    [Usuario_Id] [int] NULL,\n    [Credenciada_Id] [int] NULL,\n    [Usuario_Id_Responsavel] [int] NULL,\n    [DataHora] [datetime] NULL,\n    [Transacao] [int] NULL,\n    [Cliente_Id] [int] NULL,\n    [DataHoraPegou] [datetime] NULL,\n    [DataHoraDevolverPrevisao] [datetime] NULL,\n    [DataHoraEntregou] [datetime] NULL,\n    [HorasDevolucao] [int] NULL,\n    [NomeResponsavel] [varchar](130) NULL,\n    [CpfResponsavel] [varchar](20) NULL,\n    [RgResponsavel] [varchar](20) NULL,\n    [TelResponsavel] [varchar](15) NULL,\n    [Tel2Responsavel] [varchar](15) NULL,\n    [Endereco] [varchar](300) NULL,\n    [Devolvido] [bit] NULL,\n    [TextoDevolucao] [varchar](5000) NULL,\n    [De] [int] NULL,\n CONSTRAINT [PK_San_Chave] PRIMARY KEY CLUSTERED \n(\n    [Chave_Id] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\nGO\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","datetime"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12509664,"title":"Return only the current and past months of the year","body":"<p>Below is my code that will return all the months in a year.</p>\n\n<pre><code>SELECT TOP 12\nDATENAME(MONTH, DATEADD(MONTH,ROW_NUMBER() OVER (ORDER BY object_id) - 1,0))\nFROM sys.columns\n</code></pre>\n\n<p>What change must I make to only return the months that have passed and the current month?</p>\n"},{"tags":["tsql","split","sql-update"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12529522,"title":"Split a string and update specific value in sql","body":"<p>Field value:03/2008<br>\nI want to split it from \"/\" and want to update year's value i.e. 2012 instead of 2008. I want to update the value in same column i.e. 03/2012 instead of 03/2008. In update query, I am not getting should i have to use substr and then how to replace the new value in same string? </p>\n\n<p>Thanks   </p>\n"},{"tags":["sql-server","tsql","tree","common-table-expression","recursive-query"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":329,"score":2,"question_id":10012961,"title":"Recursive SQL Query with order tree","body":"<p>I have a problem to order a query as a tree as this </p>\n\n<pre><code>WITH UtHierarchy\nAS (\n    SELECT etabid\n        ,ut\n        ,utlib\n        ,parenteut\n        ,0 AS LEVEL\n        ,ut AS root\n    FROM RUT\n    WHERE etabid = 1\n        AND parenteut IS NULL\n\n    UNION ALL\n\n    SELECT RUT.etabid\n        ,RUT.ut\n        ,RUT.utlib\n        ,RUT.parenteut\n        ,LEVEL + 1 AS LEVEL\n        ,RUT.parenteut AS root\n    FROM RUT\n    INNER JOIN UtHierarchy uh ON uh.ut = rut.parenteut\n    WHERE RUT.ETABID = 1\n    )\nSELECT *\nFROM UtHierarchy\nORDER BY root\n</code></pre>\n\n<p>I need to have the following tree :</p>\n\n<pre>\nUT Root\nUT Root\n-- UT level 1\nUT Root\n-- UT level 1\n-- -- UT level 2\nUT Root\n</pre>\n\n<p>This is working as intended for level 0 or 1, but for higher level it s broken. I try to select in root column the 'level 0' parent to order by root and ut, but after some time on this problem, I can't :(</p>\n\n<p>How to resolve this ?</p>\n\n<p>Thanks for your help.</p>\n\n<p><strong>EDIT</strong> : Thank you for editing with sql colors :)\nI've seen the solution for the topmost level but user has deleted his post.</p>\n\n<pre><code>WITH UtHierarchy \nAS (\n  SELECT etabid\n  ,ut\n  ,utlib\n  ,parenteut,\n  0 as profondeur,\n  ut as root\n  FROM RUT \n  where etabid = 278\n  and parenteut is null\n  UNION  ALL\n  SELECT RUT.etabid\n  , RUT.ut\n  , RUT.utlib\n  , RUT.parenteut\n  , profondeur + 1 as profondeur\n  , root as root \n  FROM RUT \n  inner join UtHierarchy uh on uh.ut = rut.parenteut\n  where RUT.ETABID = 278\n)\nselect ut, parenteut, profondeur, root \nfrom UtHierarchy\norder by root\n</code></pre>\n\n<p>but it's not working too</p>\n\n<p>Here an example with true data </p>\n\n<pre>\nut  parenteutlevel  root\n10  1   1   1\n11  1   1   1\n12  1   1   1\n13  1   1   1\n14  1   1   1\n130 13  2   1\n131 13  2   1\n132 13  2   1\n133 13  2   1\n134 13  2   1\n135 13  2   1\n136 13  2   1\n120 12  2   1\n121 12  2   1\n122 12  2   1\n110 11  2   1\n111 11  2   1\n112 11  2   1\n113 11  2   1\n114 11  2   1\n115 11  2   1\n116 11  2   1\n101 10  2   1\n102 10  2   1\n103 10  2   1\n104 10  2   1\n105 10  2   1\n106 10  2   1\n107 10  2   1\n1       0   1\n</pre>\n\n<p>As you can see it is not the good structure.\nI need a tree as this :</p>\n\n<pre>\nut  parenteutlevel  root\n1       0   1\n10  1   1   1\n101 10  2   1\n102 10  2   1\n103 10  2   1\n104 10  2   1\n105 10  2   1\n106 10  2   1\n107 10  2   1\n11  1   1   1\n110 11  2   1\n111 11  2   1\n112 11  2   1\n113 11  2   1\n114 11  2   1\n115 11  2   1\n116 11  2   1\n12  1   1   1\n120 12  2   1\n121 12  2   1\n122 12  2   1\n13  1   1   1\n130 13  2   1\n131 13  2   1\n132 13  2   1\n133 13  2   1\n134 13  2   1\n135 13  2   1\n136 13  2   1\n14  1   1   1    \n</pre>\n"},{"tags":["sql","sql-server","tsql","triggers","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":12530739,"title":"Apply single trigger to same tables","body":"<p>Can I apply a single trigger to some tables?</p>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12530755,"title":"case - query optimization","body":"<p>I have this query :</p>\n\n<pre><code>INSERT INTO #t1 (VALUE1, VALUE2)\nSELECT \nCASE\nWHEN EXISTS(SELECT * FROM T2)\nTHEN SELECT VALUE1, VALUE2 FROM T2\nEND\n</code></pre>\n\n<p>This does not work , I get : \"The select list for the INSERT statement contains fewer items than the insert list. The number of SELECT values must match the number of INSERT columns.\"</p>\n\n<p>Instead I have to use :</p>\n\n<pre><code>INSERT INTO #t1 (VALUE1, VALUE2)\nSELECT \nCASE\nWHEN EXISTS(SELECT * FROM T2)\nTHEN SELECT VALUE1 FROM T2\nEND\n\nCASE\nWHEN EXISTS(SELECT * FROM T2)\nTHEN SELECT VALUE2 FROM T2\nEND\n</code></pre>\n\n<p>But this decreases performance. Is there a solution to do it properly? Within a single CASE, to benefit from a sinqle query for the second table t2.</p>\n"},{"tags":["sql-server","tsql","unique","rownumber"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":93,"score":2,"question_id":12518659,"title":"row_number() Group by?","body":"<p>I have a data set that contains the columns <code>Date</code>, <code>Cat</code>, and <code>QTY</code>. What I want to do is add a unique column that only counts unique <code>Cat</code> values when it does the row count. This is what I want my result set to look like: </p>\n\n<p><img src=\"http://i.imgur.com/lqjdl.jpg\" alt=\"enter image description here\"></p>\n\n<p>By using the SQL query below, I'm able to get row using the <code>row_number()</code> function. </p>\n\n<p>However, I can't get that unique column that I have depicted above. When I add group by to the <code>OVER</code> clause, it does not work. Does anybody have any ideas as how I could get this unique count column to work?</p>\n\n<pre><code>SELECT \n   Date,    \n   ROW_NUMBER() OVER (PARTITION BY Date ORDER By Date, Cat) as ROW,\n   Cat,\n   Qty\nFROM SOURCE\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":52,"score":-1,"question_id":12528441,"title":"Select values from table A and count corresponding values from table B","body":"<p>I have a problem which I can't really see how to work, I've tried some things based on findings on\nGoogle, but to no avail. I hope someone here can help.</p>\n\n<p>I have two tables (A and B), in table A I have some overview data which I want to select, and in table B I have details corresponding to table A (joined on two parameters), however the data in table B only needs to be summarized on number of rows.</p>\n\n<p>I have this query:</p>\n\n<pre><code>SELECT s.CartID,\n   s.Sender,\n   s.Destination,\n   s.CartType,\n   s.SendDate,\n   p.PackageID,\n   p.CartID,\n   COUNT(b.*) AS nRows\n         FROM tblA s LEFT OUTER JOIN tblB p\n         ON s.CartID = p.CartID AND s.SendDate = p.CartDate\n         WHERE s.Client='3' AND s.SendDate BETWEEN '2012-09-01' AND '2012-09-07'\n</code></pre>\n\n<p>However, this only gives the following errror:</p>\n\n<p><em>Incorrect syntax near '</em>'.*</p>\n\n<p>I've also tried using this COUNT(b.PackageID) instead but then I get:</p>\n\n<p>Column 'tblA.CartID' is invalid in the select list because it is not contained in either an aggregate function or the GROUP BY clause.</p>\n\n<p>I really don't see how I'm going to get this data in one query.</p>\n\n<p>Any help would be appreciated. :)</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12527305,"title":"Can use select into with multiple cte","body":"<p>Can use select into with multiple cte? for example in the below code the result of the first cte cte_table is inserted into dbo.table1, then the other cte is defined. is this possible?</p>\n\n<pre><code>WITH cte_table \nAS \n( \nSELECT * \nFROM dbo.table\n)\nINSERT INTO dbo.table1 \nSELECT *\nFROM [cte_table]\n, cte_table2\nAS\n(\nSELECT * \nFROM dbo.table2\n)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-update"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":763,"score":3,"question_id":8108798,"title":"SQL UPDATE statement to switch two values in two rows","body":"<p>I'm using SQL Server to swap two values in two rows. Let me show:</p>\n\n<pre><code>[ord] [name]\n1     John\n4     Jack\n7     Pete\n9     Steve\n11    Mary\n</code></pre>\n\n<p>Say, I need to swap [ord] numbers for \"Pete\" and \"Steve\" to make this table to be like so:</p>\n\n<pre><code>[ord] [name]\n1     John\n4     Jack\n9     Pete\n7     Steve\n11    Mary\n</code></pre>\n\n<p>This seems like a trivial task but I can't seem to write an SQL UPDATE statement for it.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":351,"score":2,"question_id":8103183,"title":"SQL to move rows up or down in two-table arrangement","body":"<p>I have two tables that I designed this way with a possible reshuffling of elements in mind:</p>\n\n<pre><code>1. [dbo.test_db_002] with columns:\n[id] = INT NOT NULL IDENTITY(1,1) PRIMARY KEY\n[name] = NVARCHAR(255)\n</code></pre>\n\n<p>and</p>\n\n<pre><code>2. [dbo.test_db_003] with columns:\n[ord] = INT\n[itmid] = INT NOT NULL PRIMARY KEY\n</code></pre>\n\n<p>[itmid] column has a constraint linking it to [dbo.test_db_002].[id] like so:</p>\n\n<pre><code>ALTER TABLE [dbo.test_db_003] \nADD CONSTRAINT fk1 FOREIGN KEY ([itmid]) \nREFERENCES [dbo.test_db_002]([id]) \nON DELETE CASCADE ON UPDATE CASCADE;\n</code></pre>\n\n<p>Say, [dbo.test_db_002] table has the following data:</p>\n\n<pre><code>[id] [name] \n3    John\n5    Mary\n8    Michael\n10   Steve\n13   Jack\n20   Pete\n</code></pre>\n\n<p>and [dbo.test_db_003] has the following ordering data:</p>\n\n<pre><code>[ord] [itmid]\n1      5\n4      8\n5      13\n8      3\n10     10\n13     20\n</code></pre>\n\n<p>So when I retrieve names from the database I use the following SQL:</p>\n\n<pre><code>SELECT [name]\nFROM   [dbo.test_db_002] t1\nLEFT JOIN [dbo.test_db_003] t2 ON t1.[id]=t2.[itmid]\nORDER BY t2.[ord] ASC\n</code></pre>\n\n<p>It produces the list of names (ordered by the [dbo.test_db_003].[ord] column):</p>\n\n<pre><code>Mary\nMichael\nJack\nJohn\nSteve\nPete\n</code></pre>\n\n<p>What I am looking for is an option to move each of the names up and down the list. For instance, if I want to move \"John\" one position up, what do I do?</p>\n\n<p>So far I came up with this partial SQL:</p>\n\n<pre><code>WITH cte AS\n(\n    SELECT [id], [ord], ROW_NUMBER() OVER (ORDER BY t2.[ord] ASC) AS rowNum\n    FROM [dbo.test_db_002] t1\n    LEFT JOIN [dbo.test_db_003] t2 ON t1.[id] = t2.[itmid]\n)\n</code></pre>\n\n<p>That will select the following:</p>\n\n<pre><code>rowNum  [id]  [ord]\n1        1     5\n2        4     8\n3        5     13\n4        8     3\n5        10    10\n6        13    20\n</code></pre>\n\n<p>So I understand that I need to shift values in [ord] column up by one starting from the index 3 (since \"John\" index is 4) and then somehow make \"John\"'s [ord] to be set to 5, but how do you do that?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":9,"down_vote_count":0,"view_count":6767,"score":9,"question_id":1117761,"title":"SQL query to return rows in random order","body":"<p>Hi<br/>Is it possible to write SQL query that returns table rows in random order every time the query run?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12526222,"title":"how to get results with zero values","body":"<p>my query is </p>\n\n<pre><code>select m.year_id,Count(*) as Distinctions from NewTestDB.dbo.[Master_MARKS2005] as m\njoin NewTestDB.dbo.Master_Student as s\non s.Student_id=m.Student_Id\njoin NewTestDB.dbo.Master_School as sc\non sc.school_id=s.school_code\nwhere sc.SCHOOL_CODE= 'an0001' and m.YEAR_ID between 1 and 8 and m.[NRC_CLASS]='D'\ngroup by m.year_id,\n</code></pre>\n\n<p>i want out of all year_id's between 1 to 8 but now i am getting only when m.[NRC_CLASS]='D'\nhow to rewrite this query so that i can get count as '0' when no rows in the m.NRC_CLASS column contains 'D' value</p>\n"},{"tags":["sql-server","tsql","optimization","keyboard-shortcuts"],"answer_count":30,"favorite_count":41,"up_vote_count":39,"down_vote_count":0,"view_count":16162,"score":39,"question_id":101079,"title":"SQL Server Management Studio  tips for improving the TSQL coding process","body":"<p>I used to work in a place where a common practice was to use Pair Programming. I remember how many small things we could learn from each other when working together on the code. Picking up new shortcuts, code snippets etc. with time significantly improved our efficiency of writing code.</p>\n\n<p>Since I started working with SQL Server I have been left on my own. The best habits I would normally pick from working together with other people which I cannot do now.</p>\n\n<p>So here is the question:</p>\n\n<ul>\n<li>What are you tips on efficiently\nwriting TSQL code using SQL Server\nManagement Studio? </li>\n<li>Please keep the\ntips to 2  3 things/shortcuts that\nyou think improve you speed of\ncoding </li>\n<li>Please stay within the scope\nof TSQL and SQL Server Management\nStudio 2005/2008 If the feature is\nspecific to the version of\nManagement Studio please indicate:\ne.g. Works with SQL Server 2008\nonly\"</li>\n</ul>\n\n<p><strong>EDIT:</strong></p>\n\n<p>I am afraid that I could have been misunderstood by some of you.\nI am not looking for tips for writing efficient TSQL code but rather for advice on how to efficiently use Management Studio to speed up the coding process itself. </p>\n\n<p>The type of answers that I am looking for are: </p>\n\n<ul>\n<li>use of templates, </li>\n<li>keyboard-shortcuts, </li>\n<li>use of IntelliSense plugins etc. </li>\n</ul>\n\n<p>Basically those little things that make the coding experience a bit more efficient and pleasant.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12524329,"title":"How to print select results from within a stored procedure","body":"<p>I have a stored procedure that I'm trying to debug (T-SQL).</p>\n\n<p>It contains creates a temporary table, and has several update statements to update it with various data.</p>\n\n<p>How can I insert statements to view the contents of this table at various points during the running of the stored procedure.</p>\n\n<p>Ideally, I'll be running this directly from MS SQL Server Management Studio, and simple output to the Message frame will suffice.</p>\n"},{"tags":["sql","tsql","sql-server-2005","try-catch","raiserror"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":103,"score":0,"question_id":12485234,"title":"RAISERROR from Catch Block in TSQL Passed to Calling Batch - Need that Passed to Calling Application","body":"<p>I have been researching the TRY/CATCH block and I am a little stumped on how to pass an error the way I need to do so.  From what I have read and if I understand correctly, a RAISERROR in a CATCH block in SQL will be passed to the calling batch OR the calling application.  The application is running a stored procedure which has a transaction in it.  The transaction is wrapped in a TRY/CATCH block.  In the CATCH block, I am raising the error if something in the transaction fails causing it to jump to CATCH. If running the procedure via SSMS, the error shows up fine and the transaction rolls back.  However, if the application calls the stored procedure and the same error occurs, the application never knows about the error and thus doesn't now the procedure failed.</p>\n\n<p>First of all, am I understanding correctly how the RAISERROR in CATCH works?  If so, how can I get that error raised back to the calling application?</p>\n\n<pre><code>BEGIN TRY \n    BEGIN TRAN \n        ............... \n    COMMIT \nEND TRY \nBEGIN CATCH \n    IF @@TRANCOUNT &gt; 0 \n        ROLLBACK \n    DECLARE @ErrMsg NVARCHAR(4000) \n    SELECT @ErrMsg = ERROR_MESSAGE() \n    RAISERROR(@ErrMsg, 16, 1) \nEND CATCH \n</code></pre>\n\n<p>I am Running Windows 7, SQL Server 2005</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":52,"score":-2,"question_id":12495147,"title":"SQL Filter rows on groups","body":"<p>i have a sql table with say 100 rows.\nthe structure is somthing like </p>\n\n<pre><code>colectiveNo    colectiveName         p1Number        P1EffectiveFromDate   morecol\n--------------------------------------------------------------------------------------\n1                  name1             somenumber         somedate            NULL\n1                  name1             somenumber         somedate            1234\n1                  name1             somenumber         somedate            5432\n</code></pre>\n\n<p>we group by , by colectiveNo</p>\n\n<p>i want to use conditon like this:</p>\n\n<ol>\n<li><p>if  row from the group with \"morcol\" is null and \nthere is row in the same group with morcol with some number\ndont show the row with the null\nshow row 2,3</p></li>\n<li><p>ELSE\nif i have only rows with morecol is null show them for that group</p></li>\n</ol>\n\n<p>.</p>\n\n<pre><code>colectiveNo    colectiveName         p1Number        P1EffectiveFromDate   morecol\n    ----------------------------------------------------------------------------------\n    1                name1           somenumber         somedate            NULL\n    1                name1           somenumber         somedate            NULL\n    1                name1           somenumber         somedate            NULL\n</code></pre>\n\n<p>show row 1,2,3</p>\n\n<p>i'm getting difficult to do that please help</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2012"],"answer_count":3,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":183,"score":4,"question_id":12491404,"title":"SQL 2008 VS 2012","body":"<p>My friend sent me the commands that he wrote in server 2008 and they worked with no problems, mine however from a copy and past did not work with 2012. Is there any reason why? Here is the code:</p>\n\n<pre><code>        Use Kudler_Database\n        SELECT  AccountNumber, [Description], ShortDescription,Balance\n        FROM Chart_of_Accounts \n        ORDER BY left (AccountNumber, 2)\n        COMPUTE SUM(Balance) BY left (AccountNumber, 2)\n        COMPUTE SUM(Balance); \n</code></pre>\n\n<p>Here is the error :</p>\n\n<blockquote>\n  <p>Msg 156, Level 15, State 1, Line 6 Incorrect syntax near the keyword\n  'COMPUTE'.</p>\n</blockquote>\n"},{"tags":["sql-server","tsql","triggers","ddl"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":60,"score":1,"question_id":12523269,"title":"Giving a database level trigger full access to a different database table [T-SQL]","body":"<p>I'm trying to have a trigger set up in an arbitrary database that will store information in a specific database on execution. However, I found that if the trigger is triggered by someone without explicit access to that database, the trigger execution will fail.</p>\n\n<p>I was hoping to find away around this using:</p>\n\n<pre><code>CREATE TRIGGER [myTrigger] \non database\nwith execute as 'UserWithPermissions'\n</code></pre>\n\n<p>but that doesn't seem to work either... Does anyone know if this is possible? Any pointers would be greatly appreciated. Thanks.</p>\n"},{"tags":["sql-server","tsql","string-comparison","empty-string"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":83,"score":1,"question_id":12521690,"title":"What's the fastest way to compare to an empty string in T-SQL?","body":"<p>I am working in a SQL Server environment, heavy on stored procedures, where a lot of the procedures use 0 and '' instead of Null to indicate that no meaningful parameter value was passed.</p>\n\n<p>These parameters appear frequently in the WHERE clauses.  The usual pattern is something like</p>\n\n<pre><code>WHERE  ISNULL(SomeField,'') = \n    CASE @SomeParameter \n        WHEN ''  THEN ISNULL(SomeField,'')\n        ELSE @SomeParameter\n    END\n</code></pre>\n\n<p>For various reasons, it's a lot easier to make a change to a proc than a change to the code that calls it.  So, given that the calling code will be passing empty strings for null parameters, what's the fastest way to compare to an empty string?</p>\n\n<p>Some ways I've thought of:</p>\n\n<pre><code>@SomeParameter = ''\n\nNULLIF(@SomeParameter,'') IS NULL\n\nLEN(@SomeParameter) = 0\n</code></pre>\n\n<p>I've also considered inspecting the parameter early on in the proc and setting it to NULL if it's equal to '', and just doing a <code>@SomeParameter IS NULL</code> test in the actual WHERE clause.      </p>\n\n<p>What other ways are there?  And what's fastest?  </p>\n\n<p>Many thanks.</p>\n"},{"tags":["sql","xml","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":12521661,"title":"How to escape a string embedded in XML to be used in a SQL Server 2008 XML field?","body":"<p>I have the following SQL insert statement.</p>\n\n<pre><code>insert into [dbo].[Lookup] (XMLField)\n        select          \n            '&lt;root&gt;' +          \n            '&lt;SQL&gt;' + SQLQueryToEscape + '&lt;/SQL&gt;' +         \n            '&lt;/root&gt;' as CustomData         \n        from dbo.CustomView \n</code></pre>\n\n<p>My dilemma is that the SQLQueryToEscape has characters in it that aren't XML safe. I need to escape the string. What is the best way to do this in tSQL?</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12513678,"title":"SQL Select from 1 table, get min max from another table with multiple rows","body":"<p>I have 2 tables I wish to 'join' as efficiently as possible.</p>\n\n<p>1st Table has a product code, I need all columns from this one.</p>\n\n<p>2nd Contains the same paorduct code, with multiple rows per product code.</p>\n\n<p>I need to get the min and max of the 2nd tables rows where the product codes match that of the first table.</p>\n\n<p>The below is what I have so far, it's ugly, probably very incorrect and slow. The 2nd table is the issue as this has 750k rows!</p>\n\n<pre><code> ALTER PROCEDURE [dbo].[GetProductDescriptions]\n(\n    @site INT = 0,\n    @langid INT = 0\n)\nAS\n\nselect p.* ,\nstuff((select ',' + cast(FilterValueID as nvarchar(max))from Product_Filter_Mapping c where c.ProductCode = p.ProductCode AND c.ApplicationID = @site for xml path('')),1,1,'') as FilterIDs,\nstuff((select ',' + cast(BrandID as nvarchar(max))from Product_Brand_Mapping d where d.ProductCode = p.ProductCode AND d.ApplicationID = @site for xml path('')),1,1,'') as BrandIDs,\nstuff((select '|' + cast(Name as nvarchar(max))from Brands e where e.ID IN (SELECT BrandID FROM Product_Brand_Mapping f WHERE f.ProductCode = p.ProductCode AND f.ApplicationID = @site)  for xml path('')),1,1,'') as BrandNames,\nstuff((select ',' + cast(DepartmentID as nvarchar(max))from Product_Department_Mapping e where e.ProductCode = p.ProductCode and e.ApplicationID = @site for xml path('')),1,1,'') as DepartmentIDs,\n(select MAX(pr.Sell) from Products pr where pr.ProductCode = p.ProductCode AND pr.ApplicationID = @site) as SellTo, \n(select MAX(pr.WholeSale) from Products pr where pr.ProductCode = p.ProductCode AND pr.ApplicationID = @site) as WasTo\nfrom ProductDescription p WHERE p.ApplicationID = @site AND p.LanguageID = @langid\n</code></pre>\n"},{"tags":["tsql","combinations","combinatorics","picking"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":88,"score":1,"question_id":11626995,"title":"How to pick items from warehouse to minimise travel in TSQL?","body":"<p>I am looking at this problem from a TSQL point of view, however any advice would be appreciated.</p>\n\n<p><b>Scenario</b></p>\n\n<p>I have 2 sets of criteria which identify items in a warehouse to be selected.</p>\n\n<p>Query 1 returns 100 items<br>\nQuery 2 returns 100 items</p>\n\n<p>I need to pick any 25 of the 100 items returned in query 1.<br>\nI need to pick any 25 of the 100 items returned in query 2.<br>\n- The items in query 1/2 will not be the same, ever.</p>\n\n<p>Each item is stored in a segment of the warehouse. \n<br>A segment of the warehouse may contain numerous items.</p>\n\n<p>I wish to select the 50 items (25 from each query) in a way as to reduce the number of segments I must visit to select the items. </p>\n\n<p><b>Suggested Approach</b></p>\n\n<p>My initial idea has been to combined the 2 result sets and produce a list of </p>\n\n<p>Segment ID, NumberOfItemsRequiredInSegment</p>\n\n<p>I would then select 25 items from each query, giving preference to those in a segments with the most NumberOfItemsRequiredInSegment. <br><br>I know this would not be optimal but would be an easy to implement heuristic.</p>\n\n<p><b>Questions</b></p>\n\n<p>1) I suspect this is a standard combinational problem, but I don't recognise it.. perhaps multiple knapsack, does anyone recognise it?</p>\n\n<p>2) Is there a better (easy-ish to impliment) heuristic or solution - ideally in TSQL?</p>\n\n<p>Many thanks.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":101,"score":1,"question_id":12514121,"title":"SQL Server 2008 Replace Unicode Characters","body":"<p>I just completed a project where I aggregated data from 34 un-normalized data sources into one normalized SQL Server 2008 database.</p>\n\n<p>The only problem is...the larger text fields from those data sources have lost some fidelity and are now displaying Unicode control characters throughout (a lot of them).</p>\n\n<p>This is the code I used to import the data from one of the tab-delimited *.txt files:</p>\n\n<pre><code>BULK INSERT MyTabeNameHere\n        FROM 'C:\\FILE\\PATH\\HERE\\FileNameHere.txt'       \n        WITH\n        (\n            FIELDTERMINATOR = '\\t',\n            ROWTERMINATOR = '\\n',\n            FIRSTROW = 2\n        )\n</code></pre>\n\n<p>Example data might be:</p>\n\n<pre><code>Lorem ipsum  dolor sit amet\n Lorem ipsum dolor sit amet\nLorem ipsum dolor sit amet\nLorem ipsum dolor sit amet\nLorem ipsum dolor sit amet\n</code></pre>\n\n<p>I'd like to run that data through a SQL function and output this...</p>\n\n<p>The desired output would be:</p>\n\n<pre><code>Lorem ipsum dolor sit amet\nLorem ipsum dolor sit amet\nLorem ipsum dolor sit amet    \nLorem ipsum dolor sit amet\nLorem ipsum dolor sit amet\n</code></pre>\n\n<p>Thanks in advance!</p>\n"},{"tags":["sql","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12519764,"title":"BULK INSERT adding two spaces at the beginning of each row after the first one","body":"<p>The below script is being use to do a BULK INSERT but some reason when executing the script after the first line it adds two space at the beginning of each row. Any idea why it might be doing that? I have search online but I can't find anything so far. </p>\n\n<pre><code> BULK INSERT IMPORT_DATA\n FROM 'C:\\Users\\jam\\Desktop\\JamWMS\\Inbound\\IG00000002.txt'\n WITH\n (\n     ROWTERMINATOR = ';',\n     CHECK_CONSTRAINTS\n )\n</code></pre>\n\n<p>Here is some sample data of what is happening:</p>\n\n<pre><code>IG0000002     312344001052      301234     23        2         S         43012342324         1001      5          \n  IG0000002     312344001052      301234     23        2         S         43012342324         1002      3          \n  IG0000002     312344001052      301234     23        2         S         43012342324         1003      4          \n  IG0000002     312344001052      301234     23        2         S         43012342324         1004      2          \n  IG0000002     312344001052      301234     23        2         S         43012342324         1005      1          \n</code></pre>\n\n<p>This is how the file IG00000002.txt looks like</p>\n\n<pre><code>IG0000002     312344001052      301234     23        2         S         43012342324         1001      5          ;\nIG0000002     312344001052      301234     23        2         S         43012342324         1002      3          ;\nIG0000002     312344001052      301234     23        2         S         43012342324         1003      4          ;\nIG0000002     312344001052      301234     23        2         S         43012342324         1004      2          ;\nIG0000002     312344001052      301234     23        2         S         43012342324         1005      1          ;\n</code></pre>\n\n<p>Any help will be greatly appreciated.</p>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12519769,"title":"Executing multiple procs in select statement to return row count","body":"<p>Here is what I am trying to do, get the number of rows that a stored proc returns (plus a column name that it has in the proc)\n<strong>Obviously this is Pseudo-Code</strong></p>\n\n<pre><code>SELECT\n(select col_name, Count(*) FROM stored_proc1)\n(select col_name, Count(*) FROM stored_proc2)\n(select col_name, Count(*) FROM stored_proc3)\n</code></pre>\n\n<p>To return 2 columns as such</p>\n\n<pre><code>col_name  |  row_count\n----------------------\nmyCol1        3\nmyCol2        6\nmyCol3        8\n</code></pre>\n\n<p>Is there anyway to do this?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":73,"score":-1,"question_id":12518533,"title":"Speeding up Counting","body":"<p>If you were to look at this page: <a href=\"http://www.storeboard.com/directory/california/sanfrancisco/\" rel=\"nofollow\">http://www.storeboard.com/directory/california/sanfrancisco/</a> you would discover a page that is practically inaccessible because it can take over 30 secs to load.  Reason being is that there is a counter that counts the number of business members in each category.  I want to know if there is a way to speed up my existing script as now we have over a million members and the script in its current state is useless.  Here is my current script: </p>\n\n<pre><code>SELECT COUNT(MemberID) AS MembersInCountyCat\nFROM Member\nWHERE NYKACountyID = @NYKACountyID\nAND (\n        NYKACatID IN (\n            SELECT NYKACatID\n            FROM NYKACat\n            WHERE ParentID = @NYKACatID\n        )\n        OR\n        NYKACatID = @NYKACatID\n    )\nAND ProfileTypeID &lt;&gt; 1\n</code></pre>\n\n<p>Any advice as to how I can speed the sql script up would be greatly appreciated.</p>\n\n<p>Many thanks in advance,</p>\n\n<p>neojakey</p>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12499179,"title":"Efficiency help on inserting and deleting rows from a large DB table ~100M rows","body":"<p>I am inserting rows from a large DB table into an archive table and then deleting the inserted rows. My code is as follows:</p>\n\n<pre><code>-- insert here\ninsert into DEST_DB.dbo.ARCHIVE_TABLE\nselect SRC_DB.dbo.ORIG_TABLE.*\nfrom SRC_DB.dbo.ORIG_TABLE\nwhere SRC_DB.dbo.ORIG_TABLE.ORDER_ID\nIN ( select #tmp_table.order_id from #tmp_table )\n\n-- delete here\ndelete from SRC_DB.dbo.ORIG_TABLE\nwhere SRC_DB.dbo.ORIG_TABLE.ORDER_ID\nIN ( select #tmp_table.order_id from #tmp_table )\n</code></pre>\n\n<p>The size of the <code>#tmp_table.order_id</code> table is currently set to 10K rows and the temp table will be filled and cleared in a loop, which means it will be used for my insertion and deletion operations within each loop iteration.</p>\n\n<p>I have <code>UNIQUE UNCLUSTERED</code> indexes on the ORDER_ID column for my SRC_DB.dbo.ORIG_TABLE</p>\n\n<p>My problem is when I try my stored procedure, it just seems to halt on processing this table.</p>\n\n<p>I understand I may not have the most efficient solutions and would like to hear criticism and suggestions on how I can improve my stored procedure.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server","tsql","triggers","insert"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12519057,"title":"Issues with Trigger on insert (t-sql)","body":"<p>Say I have a self relation table as following :</p>\n\n<pre><code>   ID - Name - ParentID\n</code></pre>\n\n<p>Now everytime that users insert sth in this table I would like to check if the Name inserted is already in the \nrows where <code>ParentID</code> equals to the inserted one , if true then rollback the transaction.</p>\n\n<p>But the problem is when I check the rows with the <code>parentID</code> from the inserted table the inserted row is already in the main table too. So, the trigger always rolls back the transaction.</p>\n\n<p>Here is my trigger :</p>\n\n<pre><code>ALTER TRIGGER TG_Check_Existance_In_myTbl\nON myTbl FOR INSERT,UPDATE AS\n\n\nDEClARE @result BIT\nDECLARE @numberOfRows INT\nDECLARE @counter INT\nDECLARE @names nVARCHAR (30)\nDECLARE @name NVARCHAR (30)\nSET @result = 0\nSET @numberOfRows = (SELECT COUNT (Name)\n                    FROM myTbl\n                    WHERE ParentID IN\n                        (\n                            SELECT ParentID\n                            FROM inserted\n                        )\n                    )\nSET @counter = 1;\nSELECT @name = Name \nFROM inserted\nWHILE (@counter &lt;= @numberOfRows)\nBEGIN\n    WITH Q\n    AS\n    (\n    SELECT ROW_NUMBER()\n    OVER (ORDER BY Name) 'Row', Name\n    FROM myTbl WHERE ParentID IN\n            (\n                SELECT ParentID\n                FROM inserted\n            )\n    )\n    SELECT @names = Name\n    FROM Q \n    WHERE Row = @counter\n    IF @name = @names\n    SET @result=1;\n    SET @counter = @counter + 1\nEND\nIF @result = 1\nROLLBACK TRAN\n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures","triggers"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":82,"score":2,"question_id":12518692,"title":"varchar entry of 5118 causing SQL Server stored procedure to fail","body":"<p>and thanks in advance</p>\n\n<p>I have a very basic stored procedure that inserts a row into a table. It has been working flawlessly until today</p>\n\n<p>Here is the script</p>\n\n<pre><code>(\n@emp varchar(16),\n@logdate date,\n@logtime time,\n@term char(20),\n@SSID char(16)\n)\nAS\nINSERT INTO AccessLog (EmployeeID, LogDate, LogTime, TerminalID, InOut, ChangedBy) \nVALUES (@emp, @logdate, @logtime, @term, 3, @SSID)\n</code></pre>\n\n<p>When the string of 5118 is passed to it the insert will fail. There are several triggers that fire after this insert finishes. </p>\n\n<p>Here's the strange part. You can pass it anyother number for the <code>@emp</code> variable and it works just fine, but pass it 5118, it fails.</p>\n\n<p>The error I receive is below:</p>\n\n<blockquote>\n  <p><em>Msg 241, Level 16, State 1, Procedure UpdateTimeWorked, Line 27<br>\n  Conversion failed when converting date and/or time from character\n  string.</em></p>\n</blockquote>\n\n<p>Here is the procedure that is failing  the highlighted line is Line 27</p>\n\n<pre><code>TRIGGER [dbo].[UpdateTimeWorked] ON [dbo].[TimeLog]\nFOR UPDATE\nAS\nSET NOCOUNT ON\nDECLARE @ID int;\nDECLARE @RCDIDIN int;\nDECLARE @RCDIDOUT int;\nDECLARE @ComboIn datetime;\nDECLARE @ComboOut datetime;\nSELECT @ID = ID FROM INSERTED;\nSELECT @ComboIn = LoginCombo FROM INSERTED;\nSELECT @ComboOut = LogoutCombo FROM INSERTED;\nSELECT @RCDIDIN = RCDIDIN FROM INSERTED;\nSELECT @RCDIDOUT = RCDIDOUT FROM INSERTED;\n\n**IF ( UPDATE(LogoutCombo))**\nBEGIN\n    IF (@RCDIDOUT != 0)\n    BEGIN\n        UPDATE TimeLog\n            SET LogOutRND = (select CAST(dbo.roundtime(LogOutRND,0.25) AS TIME))\n            WHERE ID = @ID\n        UPDATE TimeLog\n            SET LogOutComboRND = CAST(CAST(LogOutDate AS DATE) AS SMALLDATETIME) + CAST(LogOutRND AS TIME)\n            WHERE ID = @ID\n        UPDATE TimeLog\n            SET TimeWorked = dbo.gettime(DATEDIFF(ss,LogInComboRND,LogoutComboRND))\n            WHERE ID = @ID AND LogInEntered = 1 AND LogOutEntered = 1\n        UPDATE TimeLog\n            SET TimeWorked = (select CAST(dbo.roundtime(TimeWorked,0.25) AS TIME)), Rounded = 1\n            WHERE ID = @ID AND LogInEntered = 1 AND LogOutEntered = 1\n    END\nEND\n\nIF ( UPDATE(LoginCombo))\nBEGIN\n    IF (@RCDIDIN != 0)\n    BEGIN\n        UPDATE TimeLog\n            SET LogInRND = (select CAST(dbo.roundtime(LogInRND,0.25) AS TIME))\n            WHERE ID = @ID\n        UPDATE TimeLog\n            SET LogInComboRND = CAST(CAST(LogInDate AS DATE) AS SMALLDATETIME) + CAST(LogInRND AS TIME)\n            WHERE ID = @ID\n        UPDATE TimeLog\n            SET TimeWorked = dbo.gettime(DATEDIFF(ss,LogInComboRND,LogoutComboRND))\n            WHERE ID = @ID AND LogInEntered = 1 AND LogOutEntered = 1\n        UPDATE TimeLog\n            SET TimeWorked = (select CAST(dbo.roundtime(TimeWorked,0.25) AS TIME)), Rounded = 1\n            WHERE ID = @ID AND LogInEntered = 1 AND LogOutEntered = 1\n    END\nEND\n\n\nGO\n</code></pre>\n\n<p>I am at a total blank to come up with why this is not working.</p>\n\n<p>Anyone have any ideas?</p>\n\n<p>Like I stated, pass it any other entry for the @emp and it will run fine. I can even pass it 5118 and it will work, but not 5118.</p>\n"},{"tags":["sql-server","xml","tsql","xquery"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":89,"score":1,"question_id":12503313,"title":"t-sql XML parse out to multiple records with event and data and value","body":"<p>I'm trying to parse this out. I want one record for each event, so I need a way to query each event separately.  </p>\n\n<p>But I'd like it to look something like this:</p>\n\n<pre><code>Event Name                                         || ID  || Timestamp || process_utilization\n---------------------------------------------------------------------------------------------\nscheduler_monitor_system_heal_ring_buffer_recorded ||  0  || 0         || 33\n</code></pre>\n\n<p>Here's the XML:</p>\n\n<pre><code>&lt;events&gt;\n  &lt;session startTime=\"2012-09-06T10:48:15.373\" droppedEvents=\"0\" largestDroppedEvent=\"0\"&gt;\n    &lt;RingBufferTarget truncated=\"0\" processingTime=\"0\" totalEventsProcessed=\"14\" eventCount=\"14\" droppedCount=\"0\" memoryUsed=\"3994\"&gt;\n      &lt;event name=\"scheduler_monitor_system_health_ring_buffer_recorded\" package=\"sqlos\" timestamp=\"2012-09-19T16:46:33.091Z\"&gt;\n        &lt;data name=\"id\"&gt;\n          &lt;type name=\"uint32\" package=\"package0\" /&gt;\n          &lt;value&gt;0&lt;/value&gt;\n        &lt;/data&gt;\n        &lt;data name=\"timestamp\"&gt;\n          &lt;type name=\"uint64\" package=\"package0\" /&gt;\n          &lt;value&gt;0&lt;/value&gt;\n        &lt;/data&gt;\n        &lt;data name=\"process_utilization\"&gt;\n          &lt;type name=\"uint32\" package=\"package0\" /&gt;\n          &lt;value&gt;33&lt;/value&gt;\n        &lt;/data&gt;\n      &lt;/event&gt;\n      &lt;event name=\"resource_monitor_ring_buffer_recorded\" package=\"sqlos\" timestamp=\"2012-09-19T16:46:38.386Z\"&gt;\n        &lt;data name=\"id\"&gt;\n          &lt;type name=\"uint32\" package=\"package0\" /&gt;\n          &lt;value&gt;0&lt;/value&gt;\n        &lt;/data&gt;\n      &lt;/event&gt;\n    &lt;/RingBufferTarget&gt;\n  &lt;/session&gt;\n&lt;/events&gt;\n</code></pre>\n\n<p>EDIT:\nAlternatively, if we could return rows that look like this, that would be Just Fine:</p>\n\n<pre><code>scheduler_monitor_system_heal_ring_buffer_recorded || id || 0\nscheduler_monitor_system_heal_ring_buffer_recorded || timestamp || 0\nscheduler_monitor_system_heal_ring_buffer_recorded || process_utilization|| 33\n</code></pre>\n\n<p>EDIT: (Thanks, Mark)\nUsing Mark's code, I got this which is 98% of what I want - just need the Event Name.</p>\n\n<pre><code>SELECT\n    DataName = Evt.value('@name[1]', 'varchar(50)'),\n    TypeName= Evt.value('type[1]/@name[1]', 'varchar(50)'),\n    DataValue = Evt.value('value[1]', 'varchar(50)'),\n    DataText = Evt.value('text[1]', 'varchar(50)')\nFROM \n    @input.nodes('/events/session/RingBufferTarget/event/data') as Tbl(Evt)\n</code></pre>\n\n<p>which returns:</p>\n\n<pre><code>id                  uint32  0   NULL\ntimestamp           uint64  0   NULL\nprocess_utilization uint32  33  NULL\nid                  uint32  0   NULL\n</code></pre>\n\n<p>(but, obviously, need the event name)</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":30,"score":2,"question_id":12516541,"title":"SQL Find Records Where Date is Not Unique","body":"<p>I have a table in which a file is imported daily and, unfortunately, it was created without a constraint so I have to find issues where the same records may have been imported two days in a row.  </p>\n\n<p>So, I want to write a query that will tell me when records with a particular \"header date\" were imported more than once (the header date should be unique each day).  The field I'm using for import date is a datetime \"dataDate\" field.  My header date field is called \"headerDate\" and is a datetime field as well, and my table is tblCases.  Any help is appreciated.  Thanks!</p>\n"},{"tags":["sql-server","xml","tsql","xml-parsing"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12516241,"title":"Parsing XML with T-SQL returns anything","body":"<p>I wrote a web service and a webmethod it returns list of my class(DOVIZ_RETURN) on xml format like this:</p>\n\n<pre><code> &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;ArrayOfDOVIZ_RETURN xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://tempuri.org/\"&gt;\n    &lt;DOVIZ_RETURN&gt;\n        &lt;dovizAdi&gt;AMERKAN DOLARI&lt;/dovizAdi&gt;\n        &lt;dovizKodu&gt;USD&lt;/dovizKodu&gt;\n        &lt;dovizAlis&gt;1.7928&lt;/dovizAlis&gt;\n        &lt;dovizSatis&gt;1.8014&lt;/dovizSatis&gt;\n    &lt;/DOVIZ_RETURN&gt;\n    &lt;DOVIZ_RETURN&gt;\n        &lt;dovizAdi&gt;KANADA DOLARI&lt;/dovizAdi&gt;\n        &lt;dovizKodu&gt;CAD&lt;/dovizKodu&gt;\n        &lt;dovizAlis&gt;1.8321&lt;/dovizAlis&gt;\n        &lt;dovizSatis&gt;1.8404&lt;/dovizSatis&gt;\n    &lt;/DOVIZ_RETURN&gt;\n&lt;/ArrayOfDOVIZ_RETURN&gt;\n</code></pre>\n\n<p>and  am calling this service with a stored procedure sucessfully. I am getting this xml. But when  parse this xml with sql below, it returns any rows just returns column titles; Look below please:</p>\n\n<pre><code>ALTER PROCEDURE GET_DOVIZ_KUR_RESULT_FROM_SERVIS\n\nAS\n    declare @obj int\n    declare @servisUrl varchar(200)\n    declare @response xml\n\n    SET @servisUrl='http://localhost/DovizKurTestApp/DovizKurService.asmx/GET_DOVIZ_KUR'\n\n    EXEC sp_OACreate 'MSXML2.ServerXMLHttp', @obj OUT\n    EXEC sp_OAMethod @obj,'Open',NULL,'GET',@servisUrl,false\n    EXEC sp_OAMethod @obj,'send'\n    EXEC sp_OAGetProperty @obj, 'responseText', @response OUT\n\n    create table #DOVIZ_KUR (dovizKurList xml)\n    insert into #DOVIZ_KUR select @response \n\n    SELECT\n    a.b.value('dovizAdi[1]', 'Varchar(100)') DovizAdi,\n    a.b.value('dovizKodu[1]', 'Varchar(100)') DovizKodu,\n    a.b.value('dovizAlis[1]', 'Varchar(100)') DovizAlis,\n    a.b.value('dovizSatis[1]', 'Varchar(100)') DovizSatis\n    FROM #DOVIZ_KUR\n    CROSS APPLY dovizKurList.nodes('/ArrayOfDOVIZ_RETURN/DOVIZ_RETURN') AS a(b)\n\n    EXEC sp_OADestroy @obj\n\nRETURN\n</code></pre>\n\n<p>what is wrong here?</p>\n"},{"tags":["sql","tsql","xpath"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12516134,"title":"T-sql for xml path","body":"<p>I have a table which has the following structure\nOrderItems</p>\n\n<pre><code>    OrderId  ProductName  UnitPrice\n      1      Harley         1.0\n      1      Gloves         0.25\n      2      Gloves         0.25\n\n\n By doing a select I would like to obtain something similar with :\n&lt;Order&gt;\n&lt;OrderItem&gt;\n&lt;OrderId&gt;1&lt;/OrderId&gt;&lt;ProductName&gt;Harley&lt;/ProductName&gt;&lt;UnitPrice&gt;1.0&lt;/UnitPrice&gt;\n&lt;/OrderItem&gt;\n&lt;OrderItem&gt;\n&lt;OrderId&gt;1&lt;/OrderId&gt;&lt;ProductName&gt;Gloves&lt;/ProductName&gt;&lt;UnitPrice&gt;0.25&lt;/UnitPrice&gt;\n&lt;/OrderItem&gt;\n&lt;/Order&gt;\n\nand \n&lt;Order&gt;\n&lt;OrderItem&gt;\n&lt;OrderId&gt;2&lt;/OrderId&gt;&lt;ProductName&gt;Gloves&lt;/ProductName&gt;&lt;UnitPrice&gt;0.25&lt;/UnitPrice&gt;\n&lt;/OrderItem&gt;\n&lt;/Order&gt;\n</code></pre>\n\n<p>Currently I am stuck at</p>\n\n<pre><code>SELECT \n  t2.OrderId, t2.ProductName, t2.UnitPrice  \n       FROM OrderItems t2,OrderItems t1 where t2.OrderId = t1.OrderId\n        FOR XML PATH('OrderItem') , ROOT('Order')\n</code></pre>\n"},{"tags":["sql-server","tsql","filegroup"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":1938,"score":3,"question_id":576358,"title":"SQL Server file and filegroup","body":"<p>I can not think of any reasons why we need to have multiple files inside a file group. The reason why I think of this way is we can control from T-SQL (end user) level about file group, but can not control from T-SQL (end user) level about individual files of a file group. Any comments or ideas why files are still needed?</p>\n\n<p>thanks in advance,\nGeorge</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":81,"score":1,"question_id":12471625,"title":"Query running slow after upgrade to Sql Server 2008 R2 from Sql Server 2005","body":"<p>I am seeing strange behaviour after recent Sql server upgrade to 2008 r2 from Sql server 2005.\nBefore upgrade below query was running in subsecond but now after upgrade it takes 10 seconds .Both table have millions of rows..</p>\n\n<p>There is index on nullable column colB in model table . Below query is obviously doing index scan as there is scalar function isnull being used in Join clause..</p>\n\n<pre><code> select distinct a.colA\n             from ptransaction a\n             inner join model b on ISNULL(b.colB,0) = a.colB\n             where a.transid = 234\n</code></pre>\n\n<p>I don't have any pre-upgrade plan info but this query never ran for more than 1 second..So not sure if something changed in optimizer behaviour in Sql server 2008 which causes it to run slow. </p>\n\n<p>I know alternate solution but don't want to modify schema in hurry..I know I can convert colB in model as notnull to fix this. Other solution is to create indexed computed column which would fix this problem. Schema changes in our env is not easy so want to explore if Sql guru's here have some idea or some other solution which won't require schema change.\nI can't still understand how optimizer or overall sql server upgrade can make this query worse.\nAny help appreciated.</p>\n\n<p>NJ</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","ms-access"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":100,"score":0,"question_id":12490325,"title":"convert ms-access last() function to sql server 2008","body":"<p>How to convert ms-access last() function to sql server 2008 equivalent query? code is</p>\n\n<pre><code>SELECT \n    DISTINCT Last([Title].[Number) AS Row_ID \nFROM [Title] \nHAVING (Last([Title].[Number]) Is Null)\n</code></pre>\n"},{"tags":["tsql","try-catch"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":12513708,"title":"TSQL TRY..CATCH and multiple blocks","body":"<p>This question is related to \n<a href=\"http://stackoverflow.com/questions/9599975/t-sql-try-catch-and-multiple-batches-2-begin-end-if-else\">T-SQL try ... catch and multiple batches (2 begin...end, if...else)</a>.</p>\n\n<p>I have read MSDN's explanation on TRY/CATCH:<br>\n<strong>A TRYCATCH construct cannot span multiple batches. A TRYCATCH construct cannot span multiple blocks of Transact-SQL statements. For example, a TRYCATCH construct cannot span two BEGINEND blocks of Transact-SQL statements and cannot span an IFELSE construct.</strong></p>\n\n<p>The answer of the related question showed some examples to explain multiple batches and multiple blocks.  All is well, except when applying the same logic to a batch that contains a <code>CREATE TRIGGER</code> statement didn't work for me.</p>\n\n<pre><code>PRINT N'Creating trigger [dbo].[Trigger1] on [dbo].[Table1]'\nCREATE TRIGGER [dbo].[Trigger1] ON [dbo].[Table1] AFTER INSERT,DELETE,UPDATE AS\nBEGIN\n     -- empty body\nEND\n</code></pre>\n\n<p>It complained about <code>Incorrect Syntax near 'TRY'</code>.  Why isn't this allowed?  Any reference to the TSQL rules is great.</p>\n\n<p>I found another example on SOF that stores the <code>CREATE TRIGGER</code> statement in a string and executed as a dynamic statement.  That worked fine.</p>\n"},{"tags":["sql-server","tsql","database-design"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":2644,"score":2,"question_id":533659,"title":"Why would you NOT set IGNORE_DUP_KEY to ON?","body":"<p><code>IGNORE_DUP_KEY = ON</code> basically tells SQL Server to insert non-duplicate rows, but silently ignore any duplicates; the default behavior is to raise an error and abort the entire transaction when there are duplicates in a column that doesn't allow them.</p>\n\n<p>I've worked with a ton of data that normally has at least one duplicate when there shouldn't be, so I like to make use of <code>UNIQUE</code> constraints when I know a value shouldn't have dups; however when I try to bulk load data the last thing I want is for it to get 90% done and then suddenly run into a duplicate and error the whole thing out (Yes, I know the obvious solution is to make sure there are no duplicates, but sometimes I'm just handed a spreadsheet filled with data and told to load it ASAP).</p>\n\n<p>So, what is the reason for having the default be <code>OFF</code>, and why <strong>wouldn't</strong> you want it to be on all the time so that any non-dup entries succeed while you don't have to worry about any duplicates; chances are the duplicates are in there by mistake anyway.</p>\n\n<p>Is it related to performance, or something else?  This seems like a great idea, but there's got to be some reason why it's not the default behavior.</p>\n\n<p>Mainly, is there a good reason <strong>not</strong> to use this that I should be aware of, or should it be up for evaluating on a case-by-case basis?</p>\n"},{"tags":["tsql","relational-division"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":12512902,"title":"t - sql how to intersect records with 2 columns","body":"<p>I have 2 columns</p>\n\n<pre><code>Config      Plant\n------      -----\nROC         DEP1  \nRET         DEP1  \nROC         UAP1\nRET         UAP1\nSSL         UAP1\nROC         PLP2\nRET         PLP2\n</code></pre>\n\n<p>How to get records of <code>config</code> which is same for all <code>plant</code>s.</p>\n\n<p>In this example result should be</p>\n\n<pre><code>ROC\nRET \n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","counter"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":44,"score":2,"question_id":12512369,"title":"TSQL grouping with count","body":"<p>My Employee have a Name, an Outlet he must score and he must give a score for the Outlet.\nEach Employee can have many Outlets but only 1 Outlet need to be scored at least if that Outlet belongs to that Employee.</p>\n\n<p>So I might have a records like this.</p>\n\n<pre><code>Mike -----Outlet1---- 20\nMike----- Outlet2----  0\nJohn----- Outlet3---- 44\nLarry---- Outlet4----- 0\n</code></pre>\n\n<p>An employee must at least have 1 score for 1 of the outlets that belong to him.\nThus I do not want to count Mike because he rated an Outlet, I just want to return the value 1 as my result set because Larry did not rate any Outlets.</p>\n\n<p>Table will be: <code>Select Name, Outlet, Score from TableName</code></p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12509794,"title":"Using MAX for date but adding column to group on 'breaks' the query - sub query?","body":"<p>I Have a table which holds date but I need to know the latest date where a condition is true per location, only issue is once I add a column called 'notes' it breaks the query and returns too many rows, current query is ...</p>\n\n<pre><code>SELECT\n        Location,\n        MAX(date) AS date,\n        type,\n        notes\n  FROM NotesTable a\n INNER JOIN Location b on a.LocationID = b.LocationID\n INNER JOIN Type c on a.typeid = c.typeid\n WHERE typeid &lt;&gt; 8\n GROUP BY Location, type, notes\n</code></pre>\n\n<p>If I comment out the notes column then it works fine but as soon as I add that to the grouping it then returns more rows than required.</p>\n\n<p>Have tried using a subquery but still cant get it working, subquery below</p>\n\n<pre><code>SELECT\n        r.location,\n        r.date,\n        r.type,\n        t.notes\n  FROM (SELECT Location, MAX(date), type\n          FROM NotesTable a INNER JOIN Location b on a.LocationID = b.LocationID\n         INNER JOIN Type c on a.typeid = c.typeid\n         WHERE typeid &lt;&gt; 8\n         GROUP BY location,type\n        ) r\nINNER JOIN NotesTable t ON t.date = r.date\n</code></pre>\n\n<p>Anyone got any other suggestions?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","dynamic-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12508973,"title":"use variable in FROM statement","body":"<p>I am trying to create a query that will be executed once for a specific table in a specific database in each server in <code>sys.server</code>.</p>\n\n<p>For each <code>server.database.dbo.table</code> I want to know the contents.</p>\n\n<p>So what I need is something like:</p>\n\n<pre><code>declare @numrows int = (select count(*) from sys.servers)\ndeclare @i int = 1\n\nwhile @i &lt;= @numrows\nBEGIN\ndeclare @servername varchar(max) = (select servernaam from #servers where rij = @i)\n\nselect * from @servername.DATABASE.DBO.TABLE\n\nset @i = @i+1\n\nEND\n</code></pre>\n\n<p>However, the <code>@servername</code> in <code>@servername.DATABASE.DBO.TABLE</code> does not seem to work.</p>\n\n<p>Suggestions? Thanks for thinking with me.</p>\n"},{"tags":["sql","sql-server","arrays","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":102,"score":1,"question_id":12507287,"title":"Building dynamic T-SQL query from a string argument in a sproc","body":"<p>Let's say I have a table which contains a varchar field:</p>\n\n<pre><code>CREATE TABLE [MyTable] (\n    [MyId]    varchar(3)    NOT NULL,\n    .....\n)\n</code></pre>\n\n<p>The <strong>[MyId]</strong> column contains sequential alphanum values like A1, A2... A99, B1, B2..B99, C1 and so on (up to Z99).</p>\n\n<p>What I'd like to do is to extract rows from the table whose <strong>MyId</strong> field matches some specific prefixes... e.g. I'd like to fetch rows from the series A, C, P and X. </p>\n\n<p>And I'd like to this with a sproc which will dynamically construct the query based on the prefix alphabets supplied in the argument.</p>\n\n<p>I'm thinking about something like this...</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[uspFilterMyTable]\n  @prefixArray varchar(max)\nAS\n  ... -- split individual characters from @prefixArray into an array\n\n  SELECT * FROM [MyTable] \n  WHERE \n    [MyId] LIKE ....\n    OR\n    [MyId] LIKE ....  -- iterate all characters from @prefixArray\n</code></pre>\n\n<p>I think the main bulk of the stored procedure will resemble the following pseudo-code:</p>\n\n<pre><code>DECLARE @sql nvarchar(max)\n-- iterate through all the characters\nSET @sql = 'SELECT * FROM [MyTable] WHERE [MyId] LIKE ' + @charInTheArray + '%'\nSET @sql = @sql + ' OR [MyId] LIKE ' + @nextCharInArray + '%'\n\n\nEXEC (@sql)\n</code></pre>\n\n<p>The above proecedure will be called like this:</p>\n\n<pre><code>EXEC uspFilterMyTable(\"A,C,P,X\")\n</code></pre>\n\n<p>... or perhaps like this (if it makes splitting the alphabets easier):</p>\n\n<pre><code>EXEC uspFilterMyTable(\"ACPX\")\n</code></pre>\n\n<p>Any ideas? Pointers?</p>\n\n<hr>\n\n<p><strong>Update:</strong> OK, this is what I've come up with ([Split] function borrowed from Chhatrapati Sharma):</p>\n\n<pre><code>-- [MyTable] contains these rows: 'A7', 'A87', 'B16', 'C51', 'H99', 'X12'\n\n-- the \"input\" parameter\nDECLARE @prefixArray NVARCHAR(100)= 'H,A,C'\n\n-- split the string into SQL wild-card patterns\nDECLARE charCursor CURSOR FOR\n    select items + N'%' from dbo.Split(@prefixArray, ',')\n\n\nOPEN charCursor;\nDECLARE @pattern CHAR(2)\n\n-- create temp table if necessary\nIF NOT EXISTS(SELECT * FROM TEMPDB.SYS.TABLES WHERE NAME LIKE '#tmpTable%')\n    CREATE TABLE #tmpTable ([Id] VARCHAR(3) NOT NULL)\n\n-- purge old data\nDELETE FROM #tmpTable\n\nFETCH NEXT FROM charCursor into @pattern\nWHILE @@FETCH_STATUS = 0\nBEGIN\n      --SELECT * INTO #tmpTable FROM [MyTable] WHERE [MyId] LIKE @pattern   \n      Insert Into #tmpTable Select * FROM [MyTable] WHERE [MyId] LIKE @pattern  \n    FETCH NEXT FROM charCursor into @pattern\nEND\n\nCLOSE charCursor;\nDEALLOCATE charCursor;\n\n-- return the values\nSELECT * FROM #tmpTable    \n</code></pre>\n\n<p>It's ugly I know, but it works... any tips to improvise the code?</p>\n"},{"tags":["c#","linq","entity-framework","tsql","linq-to-entities"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12490004,"title":"LINQ-Entities Group By With Range Variable Query","body":"<p>Here's my T-SQL which i'm trying to convert to a LINQ-Entities query....</p>\n\n<pre><code>SELECT  [a].[ModLimit], [b].[NumberOfMods]\nFROM    [dbo].[Site][a]\nINNER JOIN\n(\n    SELECT          [SiteId], ISNULL(COUNT(*),0) AS [NumberOfMods]\n    FROM            [dbo].[Users][a]\n    WHERE           [a].[IsMod] = 1\n    GROUP BY        [SiteId]\n) [b] ON [a].[SiteId] = [b].[SiteId]\nWHERE   [a].[SiteId] = 1\n</code></pre>\n\n<p>What i'm working with so far (not compiling...)</p>\n\n<pre><code>from u in db.Set&lt;User&gt;()\njoin s in db.Set&lt;Site&gt;() on u.SiteId equals s.SiteId\nlet x = t.ModLimit\nwhere s.SiteId == 1\ngroup u by u.SiteId into g\nselect new { g,x});\n</code></pre>\n\n<p>Ideas?</p>\n\n<p>Cutdown Structure of tables:</p>\n\n<p><strong>Site</strong></p>\n\n<p><em>SiteId</em> int PK</p>\n\n<p><em>ModLimit</em> int</p>\n\n<p><strong>Users</strong></p>\n\n<p>UserId int PK</p>\n\n<p><em>SiteId</em> int FK\n<em>IsMod</em>  bit</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":92,"score":2,"question_id":12504732,"title":"Strip non-numeric characters from a string","body":"<p>I'm currently doing a data conversion project and need to strip all alphabetical characters from a string. Unfortunately I can't create or use a function as we don't own the source machine making the methods I've found from searching for previous posts unusable.</p>\n\n<p>What would be the best way to do this in a select statement? Speed isn't too much of an issue as this will only be running over 30,000 records or so and is a once off statement.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":50,"score":-1,"question_id":12504985,"title":"How to take last four characters from a varchar?","body":"<p>I'm trying to take the last four characters only from a varchar field. All the rows are different lengths. What function should I be using to accomplish this?</p>\n\n<p>edit: Well that was embarrassingly easy.. Seems I have a way to go with my knowledge!</p>\n"},{"tags":["sql","sql-server","tsql","common-table-expression"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":147,"score":1,"question_id":9129724,"title":"SELECT inherit values from parent in a hierarchy","body":"<p>I'm trying to acheive through T-SQL (in a stored procedure) a way to copy a value from a parent into the child when retrieving rows. Here is some example data:</p>\n\n<pre><code>DROP TABLE TEST_LEVELS\nCREATE TABLE TEST_LEVELS(\n     ID INT NOT NULL\n    ,VALUE INT NULL\n    ,PARENT_ID INT NULL\n    ,LEVEL_NO INT NOT NULL\n)\n\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (1, 10000, NULL, 1)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (2, NULL, 1, 2)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (3, NULL, 2, 3)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (4, 20000, NULL, 1)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (5, NULL, 4, 2)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (6, 25000, 5, 3)\nINSERT INTO TEST_LEVELS (ID, VALUE, PARENT_ID, LEVEL_NO) VALUES (7, NULL, 6, 4)\n</code></pre>\n\n<p>Selecting the data as follows:</p>\n\n<pre><code>SELECT ID, VALUE, LEVEL_NO\nFROM TEST_LEVELS\n</code></pre>\n\n<p>results in:</p>\n\n<pre>\n+----+-------+----------+\n| ID | VALUE | LEVEL_NO |\n+----+-------+----------+\n|  1 | 10000 |        1 |\n|  2 | NULL  |        2 |\n|  3 | NULL  |        3 |\n|  4 | 20000 |        1 |\n|  5 | NULL  |        2 |\n|  6 | 25000 |        3 |\n|  7 | NULL  |        4 |\n+----+-------+----------+\n</pre>\n\n<p>But I need something like this (values are inherited by the parent):</p>\n\n<pre>\n+----+-------+----------+\n| ID | VALUE | LEVEL_NO |\n+----+-------+----------+\n|  1 | 10000 |        1 |\n|  2 | 10000 |        2 |\n|  3 | 10000 |        3 |\n|  4 | 20000 |        1 |\n|  5 | 20000 |        2 |\n|  6 | 25000 |        3 |\n|  7 | 25000 |        4 |\n+----+-------+----------+\n</pre>\n\n<p>Can this be achieved without using cursors (it must also run on SQL Server 2005)?</p>\n"},{"tags":["sql","query","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":102,"score":0,"question_id":12502213,"title":"How to read a Text file using T-SQL?","body":"<p>What's the best way to read a text file using T-SQL? I've seen the BULK INSERT and many different functions but non of them are what I'm looking for. </p>\n\n<p>I need to read each line in the text file and then insert it into a table with some other information like filename, filelocation, status, record date &amp; time created, etc. </p>\n\n<p>The BULK INSERT does not allow me to add extra field unless I'm missing something on this.</p>\n\n<p>Any help or pointing the right direction will be really appreciate it. </p>\n"},{"tags":["sql","sql-server","tsql","foxpro","bcp"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":110,"score":0,"question_id":12503713,"title":"SQL server table to FoxPro table issues","body":"<p>I am trying to get some SQL server tables into FoxPro dbf.  </p>\n\n<p>I successfully managed to bcp export data such that when I use FoxPro Import Wizard, the data imports correctly.  But when I try to do it at the command line, I can at best import the first few columns and all the other columns disappear.  </p>\n\n<p>In the following directory, I put both the .CSV file and the successful DBF import table. </p>\n\n<p><a href=\"http://witold.org/se/\" rel=\"nofollow\">directory with 2 files here</a></p>\n\n<p>What I need to figure out is how to import these CSV files from the command line in FoxPro.   </p>\n\n<p>I tried various combinations of;</p>\n\n<pre><code>APPEND FROM D:\\work\\oh\\output\\sqloutput.csv TYPE CSV\nAPPEND FROM D:\\work\\oh\\output\\sqloutput.csv DELIMITED WITH TAB\n</code></pre>\n\n<p>None of it works.  </p>\n\n<p>Any ideas? I know I have done this before, I don't remember what the trick was... </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12498058,"title":"SQL Server: WHERE NOT EXISTS is not working","body":"<p>I have a table <code>Main1</code> which have 21 records and temp table  <code>@recordsToDel</code> have 20 records. \n20 Rows are identical in both tables but the following select query is not returning the missing record and delete is also not deleting it. Both table have similar columns.</p>\n\n<p>Any suggestions please?</p>\n\n<pre><code>SELECT * FROM dbo.Main1\nWHERE NOT EXISTS\n(\n    SELECT * FROM @recordsToDel\n);\n\nDELETE FROM dbo.Main1\nWHERE NOT EXISTS\n(\n    SELECT * FROM @recordsToDel\n);\n</code></pre>\n\n<p>Many Thanks</p>\n"},{"tags":["xml","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":25,"score":1,"question_id":12414233,"title":"Is there a local-path function similar to local-name?","body":"<p>in a previous SO post: <a href=\"http://stackoverflow.com/questions/12397722/the-argument-1-of-the-xml-data-type-method-value-must-be-a-string-literal\">The argument 1 of the XML data type method &quot;value&quot; must be a string literal</a> I failed to figure out a solution but if anyone can answer this question, I can solve that previous problem.</p>\n\n<p>Question: how do I retrieve the full path of a given node, in the way that I can retrieve the name of a given node?</p>\n\n<pre><code>declare @x xml; set @x='&lt;ROOT&gt;&lt;a&gt;111&lt;/a&gt;&lt;/ROOT&gt;'\nSELECT @x.value('local-name((/ROOT/a)[1])', 'varchar(256)')\n</code></pre>\n\n<p>the above will return 'a'.  how do I return '/ROOT/a'?</p>\n"},{"tags":["xml","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":88,"score":1,"question_id":12397722,"title":"The argument 1 of the XML data type method \"value\" must be a string literal","body":"<p>I've read through SO: <a href=\"http://stackoverflow.com/q/11029674/62576\">XML data type method value must be a string literal</a> but my problem's a bit different.  I have a bit of xml in a variable I want to pick apart and am given a path.  originally I tried this:</p>\n\n<pre><code>declare @x xml\nselect @x = '....'\nselect @x.value('(' + @path + ')[1]', 'varchar(max)')\n</code></pre>\n\n<p>but, of course, that fails.  then I found the sql:variable and tried this:</p>\n\n<pre><code>select @x.value('(sql:variable(\"@path\"))[1]', 'varchar(max)')\n</code></pre>\n\n<p>but that curiously returns the value of @path (why?).  I've been messing with it but can't get it to do the right thing.</p>\n\n<p>thoughts anyone?</p>\n\n<p>thanks - e</p>\n"},{"tags":["entity-framework","tsql","ef-code-first"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":178,"score":1,"question_id":10710277,"title":"Transaction deadlocked on lock resources when using EF code first","body":"<p>I am using EF code first. Recently I had to replace the following code:</p>\n\n<pre><code>User user = userRepository.GetByEmail(\"some@email.com\");\n\nif (user == null)\n{\n    user = New User { Email = email, CreatedAt = DateTime.Now };\n\n    userRepository.Add(user);\n    unitOfWork.Commit();\n}\n</code></pre>\n\n<p>with</p>\n\n<pre><code>Context.ExecuteSqlCommand(\"IF NOT EXISTS(SELECT 1 FROM Users WHERE Email = '{0}')\n                           INSERT INTO Users(Email, CreatedAt)\n                           VALUES ('email', GETDATE())\");\n</code></pre>\n\n<p>The reason behind this is that it took EF a very long time to run the first piece of code when trying to add thousands of rows. By changing it to a ExecuteSqlCommand, the time to handle that many rows decreased by a multitude.</p>\n\n<p>The problem I am seeing now (only occurred twice so far) is the following message from the database: Transaction (Process ID 52) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction.</p>\n\n<p>How would I go about resolving this? Most of my data access is done through EF with a few exceptions like the the one above. I have never seen a deadlock in my logs before so I assume this ha something to do with the query.</p>\n\n<p>My questions are:</p>\n\n<ol>\n<li>Is there a way to write the query using No LOCK? How would that\nquery look?</li>\n<li>Is there a way to tell EF to use NO LOCK for certain queries?</li>\n</ol>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","full-text-search"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":276,"score":3,"question_id":11642886,"title":"SQL Server full-text search for phrase containing a hyphen doesn't return expected results","body":"<p>We have an application that using a SQL Server 2008 database, and full-text search. I'm trying to understand why the following searches behave differently:</p>\n\n<p>First, a phrase containing a hyphenated word, like this:</p>\n\n<pre><code>contains(column_name, '\"one two-three-four five\"')\n</code></pre>\n\n<p>And second, an identical phrase, where the hyphens are replaced by spaces:</p>\n\n<pre><code>contains(column_name, '\"one two three four five\"')\n</code></pre>\n\n<p>The full-text index uses the ENGLISH (1033) locale, and the default system stoplist.</p>\n\n<p>From my observations of other full-text searches containing hyphenated words, the first one should allow for matches on either <code>one two three four five</code> or <code>one twothreefour five</code>. Instead, it only matches <code>one twothreefour five</code> (and not <code>one two-three-four five</code>).</p>\n\n<hr>\n\n<p><strong>Test Case</strong></p>\n\n<p>Setup:</p>\n\n<pre><code>create table ftTest \n(\n    Id int identity(1,1) not null, \n    Value nvarchar(100) not null, \n    constraint PK_ftTest primary key (Id)\n);\n\ninsert ftTest (Value) values ('one two-three-four five');\ninsert ftTest (Value) values ('one twothreefour five');\n\ncreate fulltext catalog ftTest_catalog;\ncreate fulltext index on ftTest (Value language 1033)\n    key index PK_ftTest on ftTest_catalog;\nGO\n</code></pre>\n\n<p>Queries:</p>\n\n<pre><code>--returns one match\nselect * from ftTest where contains(Value, '\"one two-three-four five\"')\n\n--returns two matches\nselect * from ftTest where contains(Value, '\"one two three four five\"')\nselect * from ftTest where contains(Value, 'one and \"two-three-four five\"')\nselect * from ftTest where contains(Value, '\"one two-three-four\" and five')\nGO\n</code></pre>\n\n<p>Cleanup:</p>\n\n<pre><code>drop fulltext index on ftTest\ndrop fulltext catalog ftTest_catalog;\ndrop table ftTest;\n</code></pre>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12479059,"title":"Improve a query with duplicated SELECTS?","body":"<p>I am performing a query that selects two times from the exact same table on 2 different columns and performing a compare with the same set of data twice from another table.</p>\n\n<p>My current method:</p>\n\n<pre><code>DELETE FROM MY_TABLE\nWHERE MY_TABLE.BUY_ORDER_ID\nIN ( SELECT #tmp_table.order_id FROM #tmp_table )\nOR MY_TABLE.SELL_ORDER_ID\nIN ( SELECT #tmp_table.order_id FROM #tmp_table )\n</code></pre>\n\n<p>Is there a way to improve on the query?</p>\n\n<p>Thanks</p>\n"}]}
{"total":16599,"page":14,"pagesize":100,"questions":[{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":34,"score":0,"question_id":12501793,"title":"Nesting transactions and honoring rollbacks","body":"<p>In general, I just want to be able to do this:</p>\n\n<pre><code>begin transaction\nbegin transaction\nselect 'x'\nrollback\nrollback\n</code></pre>\n\n<p>The reason is, I have a stored proc with code like this:</p>\n\n<pre><code>begin transaction\n\n--Do stuff\n\nIf(problem)\nbegin \n    rollback\nend else begin\n    commit\nend\n</code></pre>\n\n<p>It works just like I want it to, but I want to test it by doing this:</p>\n\n<pre><code>begin transaction\nexec MyStoredProc\nrollback\n</code></pre>\n\n<p>When the stored proc executes a rollback it seems to close both transactions, and then my rollback outside the stored proc fails.</p>\n"},{"tags":["sql","performance","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":108,"score":6,"question_id":12500646,"title":"Which is faster - NOT IN or NOT EXISTS?","body":"<p>I have an insert-select statement that needs to only insert rows where a particular identifier of the row does not exist in either of two other tables. Which of the following would be faster?</p>\n\n<pre><code>INSERT INTO Table1 (...)\nSELECT (...) FROM Table2 t2\nWHERE ...\n   AND NOT EXISTS (SELECT 'Y' from Table3 t3 where t2.SomeFK = t3.RefToSameFK)\n   AND NOT EXISTS (SELECT 'Y' from Table4 t4 where t2.SomeFK = t4.RefToSameFK AND ...)\n</code></pre>\n\n<p>... or...</p>\n\n<pre><code>INSERT INTO Table1 (...)\nSELECT (...) FROM Table2 t2\nWHERE ...\n   AND t2.SomeFK NOT IN (SELECT RefToSameFK from Table3)\n   AND t2.SomeFK NOT IN (SELECT RefToSameFK from Table4 WHERE ...)\n</code></pre>\n\n<p>... or do they perform about the same? Additionally, is there any other way to structure this query that would be preferable? I generally dislike subqueries as they add another \"dimension\" to the query that increases runtime by polynomial factors.</p>\n"},{"tags":["tsql","sql-server-2008","foreign-keys"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2524,"score":1,"question_id":3038727,"title":"Drop all foreign keys in a table","body":"<p>I had this script which worked in sql server 2005</p>\n\n<pre><code>-- t-sql scriptlet to drop all constraints on a table\nDECLARE @database nvarchar(50)\nDECLARE @table nvarchar(50)\n\nset @database = 'dotnetnuke'\nset @table = 'tabs'\n\nDECLARE @sql nvarchar(255)\nWHILE EXISTS(select * from INFORMATION_SCHEMA.TABLE_CONSTRAINTS where constraint_catalog = @database and table_name = @table)\nBEGIN\n    select    @sql = 'ALTER TABLE ' + @table + ' DROP CONSTRAINT ' + CONSTRAINT_NAME \n    from    INFORMATION_SCHEMA.TABLE_CONSTRAINTS \n    where    constraint_catalog = @database and \n            table_name = @table\n    exec    sp_executesql @sql\nEND\n</code></pre>\n\n<p>It does not work in SQL Server 2008. How can I easily drop all foreign key constraints for a certain table? Does anyone have a better script?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":74,"score":4,"question_id":12498010,"title":"Getting the latest date from a subquery (with more than 1 record) in the Insert Statement","body":"<p>I have a table I need to copy my data from (Log), into another table (BigTable). The Log table got the following data:</p>\n\n<pre><code>   LogID   LogTime             JobNumber    LogType   Description\n   =====   =======             =========    =======   ===========\n   1       2012-09-01 00:00:01   1          100       Accepted by D#12\n   2       2012-09-01 00:05:33   1          100       Accepted by D#14\n   3       2012-09-01 01:00:14   2          107       Message sent\n   4       2012-09-01 05:00:53   2          100       Accepted by D#78\n   5       2012-09-01 05:01:55   1          110       POB at Stop 1\n   6       2012-09-01 05:02:22   3          100       Accepted by D#98\n   7       2012-09-01 05:03:00   1          110       POB at Stop 2\n   8       2012-09-01 05:04:00   2          110       POB at Stop 1\n   9       2012-09-01 05:05:25   3          110       POB at Stop 1\n  10       2012-09-01 05:15:36   1          200       Completed\n  11       2012-09-01 05:20:45   2          200       Completed\n</code></pre>\n\n<p>The following data is already in BigTable</p>\n\n<pre><code>   JobNumber     Accepted_At     POB_At       Completed\n   =========     ===========     ======       =========\n    1            NULL            NULL         NULL\n    2            NULL            NULL         NULL\n    3            NULL            NULL         NULL\n</code></pre>\n\n<p>I am trying to update BigTable with values from Log. Note that in case of duplicate entries like LogID 1 and 2 (above), I am picking up only the latest date (2012-09-01 00:05:33). The same is desired for POB, as we are only interested in \"POB at Stop 1\".</p>\n\n<p>There are millions of rows in Log for lots of Job numbers, however, I need to get time for only those Jobs which are in BigTable only.\nThe Ideal table (after all updates) will look like the following: </p>\n\n<pre><code>   JobNumber   Accepted_At            POB_At                  Completed\n   =========   ===========            ======                  =========\n    1          2012-09-01 00:05:33    2012-09-01 05:01:55     2012-09-01 05:15:36\n    2          2012-09-01 05:00:53    2012-09-01 05:04:00     2012-09-01 05:20:45\n    3          2012-09-01 05:02:22    2012-09-01 05:05:25     NULL\n</code></pre>\n\n<p>Please note I am novice in this field. Any help is appreciated.\nThanks in advance.\nRegards</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":2200,"score":3,"question_id":10304373,"title":"How convert string to date T-SQL?","body":"<p>For example I have string like this '24.04.2012', how I can convert to date type in T-SQL?</p>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":63,"score":0,"question_id":12463263,"title":"Select number of records in various tables","body":"<p>I want to have the result of this queries in one stored procedure. With this query I want to return the number of rows in <code>table1</code> to <code>table4</code></p>\n\n<pre><code>select count(*) from table1\nselect count(*) from table2\nselect count(*) from table3\nselect count(*) from table4\n</code></pre>\n\n<p>I want to have this result in a temp table and select all columns of temp table.</p>\n"},{"tags":["mysql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":12498876,"title":"MySQL - Remove dublets and preserve first instance","body":"<p>I have created a pretty messy table that I need to clean up. This is not an easy task.</p>\n\n<p>Situation:</p>\n\n<ul>\n<li>Messy table is called tbl_users.</li>\n<li>It contains information about a user. It has a unique ID.</li>\n<li>The most unique colomn is phone_number which identifies a user.</li>\n</ul>\n\n<p>For varoius reasons I have the same user with the same phone number more than once in this table.</p>\n\n<p>You can see when it is created in a colomn called created_date.</p>\n\n<p>What i need:</p>\n\n<ul>\n<li>I need to find the FIRST created instance of each user and then I\nneed to find</li>\n<li>all the ID's of the second and even maybe third instance of the user,\nif \n   such exists.</li>\n</ul>\n\n<p>I need the ID's because there's data from other tables where I need to change the user_id to first instance.</p>\n\n<p>How do I proceed with this challenge?</p>\n"},{"tags":["c#",".net","tsql","round"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12461859,"title":"Sql server round my decimal data","body":"<p>Sql data type is money, .Net data type is decimal. I send 1.8714 to sql for insert data but sql server round it to 1.8700. How can I save my data? And how do I send without rounding?</p>\n"},{"tags":["tsql","return-value","dynamic-sql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12481352,"title":"How do I get the return value from a CASE statement as a dynamic SQL query?","body":"<pre><code>DECLARE @command = 'SELECT  CASE WHEN ( SELECT  COUNT(*)\n                    FROM    [table] WITH ( NOLOCK )\n                    WHERE   DATEDIFF(minute, systemupdatedtimestamp, GETDATE()) &lt; 10\n                  ) &gt; 0 THEN 0\n             ELSE 1\n        END'\n</code></pre>\n\n<p>Now I need to get the 'return value' of the above command (0 or 1).</p>\n\n<pre><code>EXEC(@commnad)\n</code></pre>\n\n<p>How do I get the return value from the above?</p>\n\n<p>I tried </p>\n\n<pre><code>SET @ReturnValue = EXEC(@command)\n</code></pre>\n\n<p>but no luck.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":91,"score":-2,"question_id":12496404,"title":"\"AND OR\" Usage in sql server","body":"<p>what is different (in performance ) when using :\nA:         </p>\n\n<pre><code>SELECT Col1, Col2, Col3, col7 \n  FROM xTable  \n WHERE (col1 &gt; 0) \n   AND (col7 &gt;= 0) \n    OR (col2 &gt; 0)\n   AND (col7 &gt;= 0) \n    OR (col3 &gt; 0) \n   AND (col7 &gt;= 0)\n</code></pre>\n\n<p>B:and using:         </p>\n\n<pre><code>SELECT Col1, Col2, Col3, col7\n  FROM xTable\n WHERE ( (col1 &gt; 0) OR (col2 &gt; 0) OR (col3 &gt; 0) )\n   AND (col7 &gt;= 0)\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12495574,"title":"How copy one table contents to another, ignoring PK duplicates when i don't know column set","body":"<p>I have 2 databases: SRC and DST. Each one contains table DATA an in every database DATA's columns sets are equal, but it's unknown for user (I don't know name of PK or even is PK identity or single).</p>\n\n<p>I already have the following script:</p>\n\n<pre><code>insert into DST.dbo.DATA select * from SRC.dbo.DATA\n</code></pre>\n\n<p>But if DST.DATA contains rows with same PK it throws an error (I'm using C#). That's why i want to use something like</p>\n\n<pre><code>on duplicate ignore\n</code></pre>\n\n<p>from mysql</p>\n\n<p>Could you please advice me script that copies rows from SRC.dbo.DATA to DST.dbo.DATA ignoring primary key constraints. And if possible, foreign constraints too</p>\n\n<p>Sorry for bad english</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12484600,"title":"Verify result set has a row for each value in a column","body":"<p>I want to check that if a record exists for a given SubId/WorkflowId combination with <code>ProcessCode = 10</code> that the same <code>SubId/WorkflowId</code> combination has a row with a <code>ProcessCode</code> 20, 30, and 40.  Below is a poorly written version of what I'm trying to do; I'm hoping for a more elegant solution. This query is basically identifying anything that is breaking the rule.</p>\n\n<pre><code>IF EXISTS( SELECT * FROM @DataTable WHERE SubID = @SubId and WorkflowId = @WorkflowId and ProcessCode = 10)\nAND (\nNOT EXISTS( SELECT * FROM @DataTable WHERE SubID = @SubId and WorkflowId = @WorkflowId  and ProcessCode = 20) or \nNOT EXISTS( SELECT * FROM @DataTable WHERE SubId = @SubId and WorkflowId = @WorkflowId and ProcessCode = 30) or\nNOT EXISTS( SELECT * FROM @DataTable WHERE SubID = @SubId and WorkflowId = @WorkflowId and ProcessCode = 40)\n)\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":76,"score":1,"question_id":12199215,"title":"Dynamic declaration in tsql","body":"<p>is it possible to do dynamic declarations? \nI will explain: I have a table <code>COLUMNAMES</code>:</p>\n\n<pre><code>ID|Name\n 1|Country\n 2|City\n 3|District\n 4|Neighbourhood\n</code></pre>\n\n<p>For each record in that table I would like to do something like:</p>\n\n<pre><code>declare @i int = 1\ndeclare @number int\nset @number = (SELECT count(*) FROM COLUMNNAMES)\n\nWhile @i &lt;= @number\nBEGIN\nExecute ('Declare column' + @i +'varchar(25)')\nExecute ('set column' + @i +' = (Select NAME from COLUMNAMES where id = ' + @i)\nset @i = @i + 1\nEND\n</code></pre>\n\n<p>The idea is that I get a list of variables (strings) that I can use to create SELECT statements with dynamic table-aliases:</p>\n\n<pre><code> Execute ('Select SOMECOLUMN as ' + @columname +  @i +', ANOTHERCOLUMN as ' + @columname +  @i +', ATHIRDCOLUMN as ' + @columname +  @i + ' FROM SOMETABLE')\n</code></pre>\n\n<p>Can this be done? If so, how?</p>\n"},{"tags":["performance","sql-server-2008","tsql","sql-tuning"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12492572,"title":"SP slow on powerful server, but quick locally (both from SSMS)","body":"<p>I have inherited a large and slow stored procedure and it's giving me a nightmare:</p>\n\n<p>I have SQL Server 2008 installed on my desktop with a copy of the production db.  I am running everything from SSMS and I have tried straight SQL and SP.  Time for Sp vs SQL is close enough to the same to not worry unduly about - its the time of local vs server that's concering me.</p>\n\n<pre><code>Local:\n2Ghz dual-core\n4Gb RAM\nSQL 2008 Sp1\nMicrosoft SQL Server 2008 R2 (SP1) - 10.50.2500.0 (Intel X86)   \nEnterprise Edition on Windows NT 6.1 &lt;X86&gt; (Build 7601: Service Pack 1) \n\nServer:\n2Ghz dual-core\n4Gb RAM\nMicrosoft SQL Server 2008 (SP1) - 10.0.2573.0 (X64)   \nStandard Edition (64-bit) on Windows NT 5.2 &lt;X64&gt; (Build 3790: Service Pack 2) (VM) \n</code></pre>\n\n<p>When I run the sproc \"locally\", it takes around 6 seconds to complete.</p>\n\n<p>When I run the sproc against the server, it takes around 25 minutes to complete!!!</p>\n\n<p>[Total inserts = 45,500]</p>\n\n<p>I have tried to tune the SP as much as I can and avoided parameter sniffing but not sure WHY this should be SO much slower on a pretty much equivalent machine (I know SQL Server version is slightly different, but can't see whjy it would make THAT much difference?)</p>\n\n<p>I know the SP isn't fantastic, but if it runs in 6 seconds locally, then its not total pants!  If it took 60 seconds on the server then that would still be fine.  There are 15 calls to this SP...so 15*0:06 is acceptable...15*25:00 is not!</p>\n\n<p>Server has a pretty low load on it when these SP's are not running, and around 50% CPU when they are in progress (one core 100%?).  Locally CPU never gets above 25%.</p>\n\n<hr>\n\n<p>Apols for posting the whole SP...but can't see how else to show what its doing in case there is an option that can be set to improve things :(</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[LoadProfitabilitySummaryByCustomer] \n    @inCustomerType char(2),\n    @inClearTable int = 0,\n    @inStartNum int,\n    @inEndNum int\nWITH RECOMPILE\nAS\n    BEGIN\n    SET ANSI_NULLS ON\n    DECLARE @customers TABLE (\n        CUSNUM CHAR(6) DEFAULT 0\n        ,IILQAR DECIMAL(20,5) DEFAULT 0\n        ,IILUSD DECIMAL(20,5) DEFAULT 0\n        ,IILGPB DECIMAL(20,5) DEFAULT 0\n        ,IILEUR DECIMAL(20,5) DEFAULT 0\n        ,IILKWD DECIMAL(20,5) DEFAULT 0\n        ,IILOTH DECIMAL(20,5) DEFAULT 0\n        ,IILMTD DECIMAL(20,5) DEFAULT 0\n        ,IILYTD DECIMAL(20,5) DEFAULT 0\n        ,TCQAR DECIMAL(20,5) DEFAULT 0\n        ,TCUSD DECIMAL(20,5) DEFAULT 0\n        ,TCGPB DECIMAL(20,5) DEFAULT 0\n        ,TCEUR DECIMAL(20,5) DEFAULT 0\n        ,TCKWD DECIMAL(20,5) DEFAULT 0\n        ,TCOTH DECIMAL(20,5) DEFAULT 0\n        ,TCMTD DECIMAL(20,5) DEFAULT 0\n        ,TCYTD DECIMAL(20,5) DEFAULT 0\n        )\n\n    DECLARE @CustomerType char(2)\n    DECLARE @ClearTable int\n    DECLARE @StartNum int\n    DECLARE @EndNum int\n\n    SET @CustomerType = @inCustomerType\n    SET @ClearTable = @inClearTable\n    SET @StartNum = @inStartNum\n    SET @EndNum = @inEndNum\n\n    DECLARE @sCustomerNumber char(6)\n\n    DECLARE @iDaysInMonth decimal\n    DECLARE @iDaysInYear decimal\n    DECLARE @dAvgCostQAR DECIMAL(20,5)\n    DECLARE @dAvgCostUSD DECIMAL(20,5)\n    DECLARE @dAvgCostGBP DECIMAL(20,5)\n    DECLARE @dAvgCostEUR DECIMAL(20,5)\n    DECLARE @dAvgCostKWD DECIMAL(20,5)\n    DECLARE @dAvgCostOTH DECIMAL(20,5)\n    DECLARE @dAvgCostTOT DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsQAR DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsUSD DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsGBP DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsEUR DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsKWD DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsOTH DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsTOT DECIMAL(20,5)\n    DECLARE @dTIIntIncLnsYTD DECIMAL(20,5)\n    DECLARE @dTITradeCommQAR DECIMAL(20,5)\n    DECLARE @dTITradeCommUSD DECIMAL(20,5)\n    DECLARE @dTITradeCommGBP DECIMAL(20,5)\n    DECLARE @dTITradeCommEUR DECIMAL(20,5)\n    DECLARE @dTITradeCommKWD DECIMAL(20,5)\n    DECLARE @dTITradeCommOTH DECIMAL(20,5)\n    DECLARE @dTITradeCommTOT DECIMAL(20,5)\n    DECLARE @dTITradeCommYTD DECIMAL(20,5)\n    DECLARE @dtMaxDate varchar(30)\n\n    DECLARE @iReportYear int\n    DECLARE @START_DATE datetime\n    DECLARE @FIRST_MONTH datetime\n    DECLARE @END_MONTH datetime\n    DECLARE @iNumMonths int\n    DECLARE @iNumDaysToday int\n\n    INSERT INTO @customers (CUSNUM)\n        SELECT DISTINCT CUSNUM\n            FROM EQPRF_SUMMARY\n            WHERE CUSTYP = @CustomerType\n                AND CUSNUM &gt;= @StartNum\n                AND CUSNUM &lt; @EndNum\n            GROUP BY CUSNUM\n\n    UPDATE @customers\n    SET IILQAR = t2.Amount\n    FROM @customers c INNER JOIN\n        (\n            SELECT CUSNUM,\n                -SUM(ISNULL(CONVERT(decimal(20,5),t.TOTALMTDLCY),0)) as Amount\n            FROM TI_INTINCLOANS t\n            WHERE t.CCY = 'IILQAR'\n                AND t.LINEID = 'LN17'\n            GROUP BY t.CUSNUM\n        ) AS t2\n        ON c.CUSNUM = t2.CUSNUM\n\n    UPDATE @customers\n    SET IILUSD = t2.Amount\n    FROM @customers c INNER JOIN\n        (\n            SELECT CUSNUM,\n                -SUM(ISNULL(CONVERT(decimal(20,5),t.TOTALMTDLCY),0)) as Amount\n            FROM TI_INTINCLOANS t\n            WHERE t.CCY = 'IILUSD'\n                AND t.LINEID = 'LN17'\n            GROUP BY t.CUSNUM\n        ) AS t2\n        ON c.CUSNUM = t2.CUSNUM\n\n    --REPEAT FOR 14 OTHER CRITERIA  \n\n    IF (@ClearTable = 1)\n        BEGIN\n            IF EXISTS (SELECT name FROM sysindexes WHERE name = 'IX_GROUP_ACCT') DROP INDEX IX_GROUP_ACCT ON PROFITABILITY_SUMMARY\n\n            TRUNCATE TABLE [PROFITABILITY_SUMMARY]\n\n            IF NOT EXISTS (SELECT name FROM sysindexes WHERE name = 'IX_GROUP_ACCT')\n            CREATE NONCLUSTERED INDEX IX_GROUP_ACCT\n            ON dbo.PROFITABILITY_SUMMARY(CUST_TYPE,GROUP_CODE,ACCOUNT)\n            WITH (FILLFACTOR = 90,PAD_INDEX = ON);  \n        END\n\n    IF MONTH(getdate())= 1 SET @iReportYear = YEAR(DATEADD(m,-1,getdate()))  -- get last month's year\n    ELSE SET @iReportYear = YEAR(getdate())\n\n    SET @START_DATE = CAST('1/1/'+cast(@iReportYear as varchar(4)) as datetime) --first day of report year (If Jan, it's last year)\n    SET @FIRST_MONTH = DATEADD(day,-DAY(getdate())+1,getdate())--first day of current month\n    SET @END_MONTH = DATEADD(day,-1,@FIRST_MONTH)--determine last day of the previous month\n    SET @FIRST_MONTH = DATEADD(M,-1,@FIRST_MONTH)--reset to first day of the previous month\n    SET @FIRST_MONTH = CAST(FLOOR( CAST( @FIRST_MONTH AS FLOAT ) ) AS DATETIME) --TRUNCATE HOURS\n    SET @END_MONTH = CAST(FLOOR( CAST( @END_MONTH AS FLOAT ) ) AS DATETIME) --TRUNCATE HOURS\n\n    SELECT TOP 1 \n        @dAvgCostQAR = AVGCOSTQAR\n        ,@dAvgCostUSD = AVGCOSTUSD\n        ,@dAvgCostGBP = AVGCOSTGBP\n        ,@dAvgCostEUR = AVGCOSTEUR\n        ,@dAvgCostKWD = AVGCOSTKWD\n        ,@dAvgCostOTH = AVGCOSTOTH\n        ,@dAvgCostTOT = AVGCOSTTOT\n    FROM dbo.PRFCOSTF\n\n    SET @dtMaxDate = (select top 1 s.txnstmp from EQPRF_SUMMARY s)\n    SELECT @iDaysInMonth = dbo.ufn_GetDaysInMonth(CAST(@dtMaxDate as datetime))\n    SELECT @iDaysInYear = 360\n    SET @iNumDaysToday = (DATEDIFF(dd, @START_DATE, @END_MONTH)+1)\n\n    DECLARE CustomerCursor CURSOR FAST_FORWARD\n        FOR\n        SELECT CUSNUM\n        FROM @customers\n\n    OPEN CustomerCursor\n\n    FETCH NEXT FROM CustomerCursor \n        INTO @sCustomerNumber\n\n    WHILE @@FETCH_STATUS = 0\n        BEGIN\n\n        SELECT \n            @dTIIntIncLnsQAR = c.IILQAR\n            ,@dTIIntIncLnsUSD = c.IILUSD\n            ,@dTIIntIncLnsGBP = c.IILGPB\n            ,@dTIIntIncLnsEUR = c.IILEUR\n            ,@dTIIntIncLnsKWD = c.IILKWD\n            ,@dTIIntIncLnsOTH = c.IILOTH\n            ,@dTIIntIncLnsTOT = c.IILMTD\n            ,@dTIIntIncLnsYTD = c.IILYTD\n            ,@dTITradeCommQAR = c.TCQAR\n            ,@dTITradeCommUSD = c.TCUSD\n            ,@dTITradeCommGBP = c.TCGPB\n            ,@dTITradeCommEUR = c.TCEUR\n            ,@dTITradeCommKWD = c.TCKWD\n            ,@dTITradeCommOTH = c.TCOTH\n            ,@dTITradeCommTOT = c.TCMTD\n            ,@dTITradeCommYTD = c.TCYTD\n        FROM @customers c\n        WHERE c.CUSNUM = @sCustomerNumber\n\n    INSERT INTO PROFITABILITY_SUMMARY\n            SELECT SORT_ORDER = 1, LINE_NO = 'LN01', RPT_DATE=cast(TXNSTMP as datetime),\n                LINE_TITLE='Month Loans Outstanding', \n                ACCOUNT = RTRIM(CUSNUM),\n                CUST_TYPE = RTRIM(CUSTYP),\n                GROUP_CODE = (CASE\n                                WHEN RTRIM(CUSGRP) IS NULL OR RTRIM(CUSGRP)='' THEN LEFT(CUSNAME,3)+'--'+RTRIM(CUSNUM)\n                                ELSE RTRIM(CUSGRP)\n                                END),\n                PARENT_COUNTRY = RTRIM(CUSNAP),\n                RM_CODE = RTRIM(CUSACO),\n                RM_NAME = RTRIM(CUSRNAM),\n                CUST_NAME = RTRIM(CUSNAME),\n                RISK_CODE = RTRIM(CUSRSKE),\n                QAR = ISNULL((SELECT CAST(CURDLAMT AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY='QAR'),0),\n                USD = ISNULL((SELECT CAST(CURDLAMT AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY='USD'),0),\n                GBP = ISNULL((SELECT CAST(CURDLAMT AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY='GBP'),0),\n                EUR = ISNULL((SELECT CAST(CURDLAMT AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY='EUR'),0),\n                KWD = ISNULL((SELECT CAST(CURDLAMT AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY='KWD'),0),\n                OTHER = ISNULL((SELECT sum(CAST(CURDLAMT AS DECIMAL(20,5))) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n              where CUSNUM=@sCustomerNumber AND CUSCCY NOT IN ('QAR', 'USD', 'GBP', 'EUR', 'KWD')),0),\n                TOTAL = SUM(CAST(CURDLAMT AS DECIMAL(20,5))),\n                YTD = 0\n              FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY] where CUSNUM=@sCustomerNumber\n              GROUP BY CUSNUM,CUSTYP,CUSGRP,CUSNAP,CUSACO,CUSRNAM,CUSNAME,CUSRSKE,TXNSTMP\n\n            UNION ALL\n                SELECT SORT_ORDER = 2,LINE_NO = 'LN02', RPT_DATE=cast(TXNSTMP as datetime),\n                    LINE_TITLE ='Average Loans Outstanding', \n                    ACCOUNT = RTRIM(CUSNUM),\n                    CUST_TYPE = RTRIM(CUSTYP),\n                GROUP_CODE = (CASE\n                                WHEN RTRIM(CUSGRP) IS NULL OR RTRIM(CUSGRP)='' THEN LEFT(CUSNAME,3)+'--'+RTRIM(CUSNUM)\n                                ELSE RTRIM(CUSGRP)\n                                END),\n                    PARENT_COUNTRY = RTRIM(CUSNAP),\n                    RM_CODE = RTRIM(CUSACO),\n                    RM_NAME = RTRIM(CUSRNAM),\n                    CUST_NAME = RTRIM(CUSNAME),\n                    RISK_CODE = RTRIM(CUSRSKE),\n                    QAR = ISNULL((SELECT CAST(LNAVGMTD AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='QAR'),0),\n                    USD = ISNULL((SELECT CAST(LNAVGMTD AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='USD'),0),\n                    GBP = ISNULL((SELECT CAST(LNAVGMTD AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='GBP'),0),\n                    EUR = ISNULL((SELECT CAST(LNAVGMTD AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='EUR'),0),\n                    KWD = ISNULL((SELECT CAST(LNAVGMTD AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='KWD'),0),\n                    OTHER = ISNULL((SELECT SUM(CAST(LNAVGMTD AS DECIMAL(20,5))) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY NOT IN ('QAR', 'USD', 'GBP', 'EUR', 'KWD')),0),\n                    TOTAL = SUM(CAST(LNAVGMTD AS DECIMAL(20,5))),\n                    YTD = SUM(CAST(LNAVGYTD AS DECIMAL(20,5)))\n                  FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY] where CUSNUM=@sCustomerNumber\n                  GROUP BY CUSNUM,CUSTYP,CUSGRP,CUSNAP,CUSACO,CUSRNAM,CUSNAME,CUSRSKE,TXNSTMP\n------------------------------------------------------------------------------\n            --THERE ARE 32 LINES IN TOTAL...ALL FOLLOWING ROUGHLY SAME PATTERN\n------------------------------------------------------------------------------\n            UNION ALL\n                SELECT SORT_ORDER = 32,LINE_NO = 'GRANTOTAL',RPT_DATE=cast(TXNSTMP as datetime),\n                    LINE_TITLE ='Total Income', \n                    ACCOUNT = RTRIM(CUSNUM),\n                    CUST_TYPE = RTRIM(CUSTYP),\n                GROUP_CODE = (CASE\n                                WHEN RTRIM(CUSGRP) IS NULL OR RTRIM(CUSGRP)='' THEN LEFT(CUSNAME,3)+'--'+RTRIM(CUSNUM)\n                                ELSE RTRIM(CUSGRP)\n                                END),\n                    PARENT_COUNTRY = RTRIM(CUSNAP),\n                    RM_CODE = RTRIM(CUSACO),\n                    RM_NAME = RTRIM(CUSRNAM),\n                    CUST_NAME = RTRIM(CUSNAME),\n                    RISK_CODE = RTRIM(CUSRSKE),\n                    QAR = @dTITradeCommQAR+@dTIIntIncLnsQAR+ISNULL((SELECT CAST(SUSINTMTD AS DECIMAL(20,5)) + CAST(INTINCMTD AS DECIMAL(20,5))- cast(COSTLNMTD as DECIMAL(20,5))+cast(COSTDPMTD as DECIMAL(20,5)) - CAST(INTEXPMTD AS DECIMAL(20,5))+CAST(LNFEEMTD  AS DECIMAL(20,5))+CAST(OTRINCMTD  AS DECIMAL(20,5))+CAST(EXCHINCMTD  AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='QAR'),0),\n                    USD = @dTITradeCommUSD+@dTIIntIncLnsUSD+ISNULL((SELECT CAST(SUSINTMTD AS DECIMAL(20,5)) + CAST(INTINCMTD AS DECIMAL(20,5))- cast(COSTLNMTD as DECIMAL(20,5))+cast(COSTDPMTD as DECIMAL(20,5)) - CAST(INTEXPMTD AS DECIMAL(20,5))+CAST(LNFEEMTD  AS DECIMAL(20,5))+CAST(OTRINCMTD  AS DECIMAL(20,5))+CAST(EXCHINCMTD  AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='USD'),0),\n                    GBP = @dTITradeCommGBP+@dTIIntIncLnsGBP+ISNULL((SELECT CAST(SUSINTMTD AS DECIMAL(20,5)) + CAST(INTINCMTD AS DECIMAL(20,5))- cast(COSTLNMTD as DECIMAL(20,5))+cast(COSTDPMTD as DECIMAL(20,5)) - CAST(INTEXPMTD AS DECIMAL(20,5))+CAST(LNFEEMTD  AS DECIMAL(20,5))+CAST(OTRINCMTD  AS DECIMAL(20,5))+CAST(EXCHINCMTD  AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='GBP'),0),\n                    EUR = @dTITradeCommEUR+@dTIIntIncLnsEUR+ISNULL((SELECT CAST(SUSINTMTD AS DECIMAL(20,5)) + CAST(INTINCMTD AS DECIMAL(20,5))- cast(COSTLNMTD as DECIMAL(20,5))+cast(COSTDPMTD as DECIMAL(20,5)) - CAST(INTEXPMTD AS DECIMAL(20,5))+CAST(LNFEEMTD  AS DECIMAL(20,5))+CAST(OTRINCMTD  AS DECIMAL(20,5))+CAST(EXCHINCMTD  AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='EUR'),0),\n                    KWD = @dTITradeCommKWD+@dTIIntIncLnsKWD+ISNULL((SELECT CAST(SUSINTMTD AS DECIMAL(20,5)) + CAST(INTINCMTD AS DECIMAL(20,5))- cast(COSTLNMTD as DECIMAL(20,5))+cast(COSTDPMTD as DECIMAL(20,5)) - CAST(INTEXPMTD AS DECIMAL(20,5))+CAST(LNFEEMTD  AS DECIMAL(20,5))+CAST(OTRINCMTD  AS DECIMAL(20,5))+CAST(EXCHINCMTD  AS DECIMAL(20,5)) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY='KWD'),0),\n                    OTHER=@dTITradeCommOTH+@dTIIntIncLnsOTH+ISNULL((SELECT SUM(CAST(SUSINTMTD AS DECIMAL(20,5)))+ SUM(CAST(INTINCMTD AS DECIMAL(20,5)))-SUM(CAST(COSTLNMTD AS DECIMAL(20,5)))+SUM(CAST(COSTDPMTD AS DECIMAL(20,5))) - SUM(CAST(INTEXPMTD AS DECIMAL(20,5)))+SUM(CAST(LNFEEMTD AS DECIMAL(20,5)))+SUM(CAST(OTRINCMTD  AS DECIMAL(20,5)))+SUM(CAST(EXCHINCMTD  AS DECIMAL(20,5))) FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY]\n                  where CUSNUM=@sCustomerNumber AND CUSCCY NOT IN ('QAR', 'USD', 'GBP', 'EUR', 'KWD')),0),\n                    TOTAL = @dTITradeCommTOT+@dTIIntIncLnsTOT+ SUM(CAST(SUSINTMTD AS DECIMAL(20,5)))+SUM(CAST(INTINCMTD AS DECIMAL(20,5)))-SUM(CAST(COSTLNMTD AS DECIMAL(20,5)))+SUM(cast(COSTDPMTD as DECIMAL(20,5))) - SUM(CAST(INTEXPMTD AS DECIMAL(20,5)))+SUM(CAST(LNFEEMTD  AS DECIMAL(20,5)))+SUM(CAST(OTRINCMTD  AS DECIMAL(20,5)))+SUM(CAST(EXCHINCMTD  AS DECIMAL(20,5))),\n                    YTD = @dTITradeCommYTD+@dTIIntIncLnsYTD+ SUM(CAST(SUSINTYTD AS DECIMAL(20,5)))+SUM(CAST(INTINCYTD AS DECIMAL(20,5)))-SUM(CAST(COSTLNYTD AS DECIMAL(20,5)))+SUM(cast(COSTDPYTD as DECIMAL(20,5))) - SUM(CAST(INTEXPYTD AS DECIMAL(20,5)))+SUM(CAST(LNFEEYTD  AS DECIMAL(20,5)))+SUM(CAST(OTRINCYTD  AS DECIMAL(20,5)))+SUM(CAST(EXCHINCYTD  AS DECIMAL(20,5)))\n\n                  FROM [MISReportInterface].[dbo].[EQPRF_SUMMARY] where CUSNUM=@sCustomerNumber\n                GROUP BY CUSNUM,CUSTYP,CUSGRP,CUSNAP,CUSACO,CUSRNAM,CUSNAME,CUSRSKE,TXNSTMP\n            ORDER BY 1\n\n        FETCH NEXT \n            FROM CustomerCursor \n            INTO @sCustomerNumber\n\n        END\n\n    CLOSE CustomerCursor\n    DEALLOCATE CustomerCursor\n\nEND\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2008-r2"],"answer_count":4,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":71,"score":5,"question_id":12491087,"title":"SQL Server Query to group sequential dates","body":"<p>I have a table named Absence Details and I want to group sequential dates. Here, is the data </p>\n\n<pre><code>EID        AbsenceType  AbsenceStartDate               AbsenceEndDate\n769     Holiday     2012-06-25  00:00:00.000            2012-06-25 23:59:59.000\n769     Holiday     2012-06-26  00:00:00.000            2012-06-26 23:59:59.000\n769     Holiday     2012-09-03  00:00:00.000            2012-09-03 23:59:59.000\n769     Holiday     2012-09-04  00:00:00.000            2012-09-04 23:59:59.000\n769     Holiday     2012-09-05  00:00:00.000            2012-09-05 23:59:59.000\n769     Holiday     2012-09-06  00:00:00.000            2012-09-06 23:59:59.000\n769     Holiday     2012-09-07  00:00:00.000            2012-09-07 23:59:59.000\n</code></pre>\n\n<p>The result i am trying to get is </p>\n\n<pre><code>EID     AbsenceType AbsenceStartDate          AbsenceEndDate\n769     Holiday     2012-06-25  00:00:00.000         2012-06-26 23:59:59.000\n769     Holiday     2012-09-03  00:00:00.000         2012-09-07 23:59:59.000\n</code></pre>\n\n<p>Any help is much appreciated.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":1128,"score":6,"question_id":7053471,"title":"Understanding the differences between CUBE and ROLLUP","body":"<p>My assignment asked me to find out \"how many invoices are written for each date?\"</p>\n\n<p>I was a little stuck and asked my professor for help. She emailed me a query that would answer the question, \"How many stoves of each type and version have been built?\nFor a challenge but no extra points, include the total number of stoves.\"</p>\n\n<p>This was the query she sent me:</p>\n\n<pre><code>SELECT STOVE.Type + STOVE.Version AS 'Type+Version'\n, COUNT(*) AS 'The Count'\nFROM STOVE\nGROUP BY STOVE.Type + STOVE.Version WITH ROLLUP;\n</code></pre>\n\n<p>So, I tweaked that query until it met my needs. This is what I came up with:</p>\n\n<pre><code>SELECT InvoiceDt\n, COUNT(InvoiceNbr) AS 'Number of Invoices' \nFROM INVOICE \nGROUP BY InvoiceDt WITH ROLLUP \nORDER BY InvoiceDt ASC;\n</code></pre>\n\n<p>And it returned the following results that I wanted. </p>\n\n<p>Anyway, I decided to read up on the ROLLUP clause and started with an article from <a href=\"http://msdn.microsoft.com/en-us/library/ms189305%28v=sql.90%29.aspx\">Microsoft</a>. It said that the ROLLUP clause was similar to the CUBE clause but that it was distinguished from the CUBE clause in the following way:</p>\n\n<ol>\n<li>CUBE generates a result set that shows aggregates for all combinations of values in the selected columns.</li>\n<li>ROLLUP generates a result set that shows aggregates for a hierarchy of values in the selected columns.</li>\n</ol>\n\n<p>So, I decided to replace the ROLLUP in my query with CUBE to see what would happen. They produced the same results. I guess that's where I'm getting confused.</p>\n\n<p>It seems like, if you're using the type of query that I am here, that there isn't any practical difference between the two clauses. Is that right? Or, am I not understanding something? I had thought, when I finished reading the Microsoft article, that my results should've been different using the CUBE clause.</p>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12494034,"title":"T-SQL - get count of joined entries","body":"<p>I wonder how better to write the following query to Microsoft SQL Server.</p>\n\n<p>I have three tables: <code>surveys</code>, <code>survey_presets</code> and <code>survey_scenes</code>. They have the following columns:</p>\n\n<pre><code>CREATE TABLE [dbo].[surveys](\n    [id] [int] IDENTITY(1,1) NOT NULL,\n    [caption] [nvarchar](255) NOT NULL,\n    [creation_time] [datetime] NOT NULL,\n)\nCREATE TABLE [dbo].[survey_presets](\n    [id] [int] IDENTITY(1,1) NOT NULL,\n    [survey_id] [int] NOT NULL,\n    [preset_id] [int] NOT NULL,\n)\nCREATE TABLE [dbo].[survey_scenes](\n    [id] [int] IDENTITY(1,1) NOT NULL,\n    [survey_id] [int] NOT NULL,\n    [scene_id] [int] NOT NULL,\n)\n</code></pre>\n\n<p>Both <code>survey_presets</code> and <code>survey_scenes</code> have foreign keys on <code>surveys</code> for <code>survey_id</code> column.</p>\n\n<p>Now I want to select all surveys with the count of corresponding presets and scenes for each. Here is the \"pseudo-query\" of what I want:</p>\n\n<pre><code>SELECT\n    surveys.*,\n    COUNT(survey_presets, where survey_presets.survey_id = surveys.id), \n    COUNT(survey_scenes, where survey_scenes.survey_id = surveys.id)\nFROM surveys\nORDER BY suverys.creation_time\n</code></pre>\n\n<p>I can do a mess with <code>SELECT DISTINCT</code>, <code>JOIN</code>, <code>GROUP BY</code>, etc., but I'm new to T-SQL and I doubt my query will be optimal in any sense.</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures","dynamic-sql","sql-view"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":98,"score":0,"question_id":12481744,"title":"Error creating view using stored procedure","body":"<p>I have following stored procedure which creates a view:</p>\n\n<pre><code>ALTER PROC Proc_Guards_By_Client\n(\n    @client_number INT,\n    @client_name   NVARCHAR(16)\n)\nAS\n BEGIN\n   IF EXISTS(select * FROM sys.views where name = 'vwGuardsByClients')\n   BEGIN\n    EXEC ('CREATE VIEW vwGuardsByClients\n    AS\n    SELECT TOP 1000 \n      cgt.[guard_id],\n      sg.first_name,\n      sg.last_name,\n      sg.ammunition_quantity    \n      FROM [sws4].[dbo].[client_guard_tracking] cgt\n      INNER JOIN CLIENTS c\n      ON c.client_number = cgt.client_number\n      INNER JOIN security_guard sg\n      ON sg.guard_id = cgt.guard_id\n      WHERE cgt.client_number = @client_number\n      OR c.client_name = @client_name\n    ')\n    END\n    ELSE\n    BEGIN\n      EXEC ('UPDATE VIEW vwGuardsByClients\n      SELECT TOP 1000 \n      cgt.[guard_id],\n      sg.first_name,\n      sg.last_name,\n      sg.ammunition_quantity    \n      FROM [sws4].[dbo].[client_guard_tracking] cgt\n      INNER JOIN CLIENTS c\n      ON c.client_number = cgt.client_number\n      INNER JOIN security_guard sg\n      ON sg.guard_id = cgt.guard_id\n      WHERE cgt.client_number = @client_number\n      OR c.client_name = @client_name\n    ')\n    END\n\n    IF @@ROWCOUNT = 0\n        PRINT 'Warning: No rows were updated'\n END\n</code></pre>\n\n<p>But when I execute it, I get:</p>\n\n<pre><code>Msg 156, Level 15, State 1, Line 2\nIncorrect syntax near the keyword 'VIEW'.\n\nMsg 137, Level 15, State 2, Line 14\nMust declare the scalar variable \"@client_number\".\n</code></pre>\n"},{"tags":["sql","tsql","insert","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":33,"score":3,"question_id":12492868,"title":"How to insert BIT value if row has relation","body":"<p>I have 3 tables BusStop, BusRoute, and Stop_Route (for M-2-M relation). Some stops do not have relation (routes), and I need to update each record in BusStop table with Bit value 1 or 0, depending on whether it has relation or not. I have a query to select all stops which have no relations: </p>\n\n<pre><code>SELECT\n    BusStop.StopId \nFROM\n    BusStop\n    LEFT OUTER JOIN BusStop_BusRoute \n    ON BusStop.StopId = BusStop_BusRoute.StopId\nWHERE \n    BusStop_BusRoute.StopId IS NULL\n</code></pre>\n\n<p>but I don't clearly understand how to add a value based on this result. I've read about CURSOR and CASE WHEN statements, but I still can't figure out how to apply them in my case. There is a StopStatus column type of Bit where I need to insert that value. </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":12490244,"title":"Symmetric cross join","body":"<p>I'm tryng to extract all pair say <code>i,j</code> from each element in a table against each element on the same table, here my query:</p>\n\n<pre><code>select a.Id L,b.id R into #cross from MyTable a cross join mytable b \n</code></pre>\n\n<p>I'm in the situation where <code>i,j == j,i</code> so just half the record are needed. My naive attempt is:</p>\n\n<pre><code>select a.Id L,b.id R into #cross from MyTable a cross join mytable b \nwhere not exists\n    (select * from #cross c where c.L=R and c.R=L)\n</code></pre>\n\n<p>but I can't query the destination table while inserting in, as said by SQL Server:</p>\n\n<pre><code>The SELECT INTO statement cannot have same source and destination tables\n</code></pre>\n\n<p>how can I do in an efficient way ?</p>\n\n<p><strong>EDIT</strong>\nJust for reference, I said \"I need half the records\", that is wrong, the record count after taking in account that <code>i,j == j,i</code> is <code>n*(n+1)/2</code></p>\n"},{"tags":["sql-server","tsql","date"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":82,"score":2,"question_id":12489404,"title":"SET DATEFIRST in FUNCTION","body":"<p>I want to SET DATEFIRST in my function but it is not allowed.</p>\n\n<pre><code>SET DATEFIRST 1\n</code></pre>\n\n<p>I can add the code in a SP and call the SP from the function but I am not keen on doing that.</p>\n\n<p>I can SET the DATEFIRST before I call my function but I am not keen on doing that as well.</p>\n\n<p>Any other work around?</p>\n\n<p><strong>EDIT</strong></p>\n\n<p>Below is the code I want to use in my FUNCTION to return the total working days of the month. But I cant add this code into the FUNCTION because of my DATEFIRST</p>\n\n<pre><code>DECLARE @my int\nDECLARE @myDeduct int\nDECLARE @day INT\nDECLARE @mydate DATETIME\nDECLARE @TotalDays INT\n\nSET @mydate = GETDATE()\n\nSET @myDeduct = 0\nIF (@@DATEFIRST + DATEPART(DW, @mydate)) % 7 not in (0,1)\nSET DateFirst 1 -- Set it monday=1 (value)\n\n--Saturday and Sunday on the first and last day of a month will Deduct 1\nIF (DATEPART(weekday,(DATEADD(dd,-(DAY(@mydate)-1),@mydate))) &gt; 5)\nSET @myDeduct = @myDeduct + 1\n\nIF (DATEPART(weekday,(DATEADD(dd,-(DAY(DATEADD(mm,1,@mydate))),DATEADD(mm,1,@mydate)))) &gt; 5)\nSET @myDeduct = @myDeduct + 1\n\nSET @my = day(DATEADD(dd,-(DAY(DATEADD(mm,1,@mydate))),DATEADD(mm,1,@mydate)))\n\nSet @TotalDays = (select (((@my/7) * 5 + (@my%7)) - @myDeduct))\n\nSelect @TotalDays\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","date"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12481031,"title":"Get 1st Day of Week (Sunday)","body":"<p>I have this formula in my column to calculate the start date of a given week :</p>\n\n<pre><code>dateadd(week,[Week]-(1),\n dateadd(day,(-1),\n  dateadd(week,\n   datediff(week,(0),\n    CONVERT([varchar](4),[Year],(0))+'-01-01'),\n     (1))))\n</code></pre>\n\n<p>Where <code>Week</code> and <code>Year</code> are other fields like <code>38</code> and <code>2012</code></p>\n\n<p>Problem is, it calculates the start date of week 38/2012 as a monday (17th Sept), I would like it to be a sunday instead (16th Sept) is this possible?</p>\n\n<p>Many thanks.</p>\n"},{"tags":["c#","sql","sql-server","performance","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":220,"score":4,"question_id":12455730,"title":"Performance issue with/without parameters","body":"<p>I have some performance issues.</p>\n\n<p>I have a table with about 2 million rows.</p>\n\n<pre><code>CREATE TABLE [dbo].[M8](\n    [M8_ID] [int] IDENTITY(1,1) NOT NULL,\n    [APPLIC] [char](8) NOT NULL,\n    [NIVALERTE] [numeric](1, 0) NOT NULL,\n    [LOGDH] [datetime2](7) NULL,\n    [USERX] [char](20) NOT NULL,\n    [TACHE] [char](3) NOT NULL,\n    [PRG] [char](32) NOT NULL,\n    [DOS] [numeric](3, 0) NOT NULL,\n    [ERRNUM] [numeric](5, 0) NOT NULL,\n    [LOGTXT] [char](200) NOT NULL)\n</code></pre>\n\n<p>I read them with C# and ADO.NET</p>\n\n<p>In the management studio (SQL Server 2008 R2), with that query : </p>\n\n<pre><code>SELECT \n    M8.M8_ID, M8.APPLIC, M8.NIVALERTE, M8.LOGDH, M8.USERX, M8.TACHE, \n    M8.PRG, M8.DOS, M8.ERRNUM, M8.LOGTXT\nFROM \n    M8 AS M8 WITH(NOLOCK) \nWHERE \n    ((M8.APPLIC LIKE 'DAV' ) )\nORDER BY \n    M8.LOGDH DESC, M8.M8_ID ASC\nOPTION (FAST 1)\n</code></pre>\n\n<p>It take about 1 minute to have the first rows.</p>\n\n<p>But, with </p>\n\n<pre><code>DECLARE @APPLIC_ZOOMAPRESCLE_ZOOM_LIKE_APPLIC_WHERE_0 as char(8) = 'DAV'\n\nSELECT \n   M8.M8_ID, M8.APPLIC, M8.NIVALERTE, M8.LOGDH, M8.USERX, M8.TACHE, \n   M8.PRG, M8.DOS, M8.ERRNUM, M8.LOGTXT\nFROM \n   M8 AS M8 WITH(NOLOCK) \nWHERE \n   ((M8.APPLIC LIKE @APPLIC_ZOOMAPRESCLE_ZOOM_LIKE_APPLIC_WHERE_0 ) )\nORDER BY \n   M8.LOGDH DESC, M8.M8_ID ASC\nOPTION(FAST 1)\n</code></pre>\n\n<p>I get the first rows after 4 seconds.</p>\n\n<p>PS : I know, I have no % in the like.</p>\n\n<p>Edit: Here are the execution plans <a href=\"https://www.dropbox.com/sh/jgai5f9txbs84x6/EP5_hj8DNv\" rel=\"nofollow\">https://www.dropbox.com/sh/jgai5f9txbs84x6/EP5_hj8DNv</a> </p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":1,"view_count":41,"score":3,"question_id":12487856,"title":"SQL Query to Join Two Tables With The Following Output","body":"<p>I need to write a simple query as a part of larger function to join two tables. The tables are as under</p>\n\n<p><strong>Table1</strong></p>\n\n<pre><code>Code    Subactivity\n647     1\n647     2\n648     3\n648     4\n</code></pre>\n\n<p><strong>Table 2</strong></p>\n\n<pre><code>Subactivity    Hours\n1              5\n2              10\n3              7\n4              3\n</code></pre>\n\n<p>The final output should look like</p>\n\n<pre><code>Code    hours\n647     15\n648     10\n</code></pre>\n\n<p>I have done this before, but today I just cant get my head around it..</p>\n"},{"tags":["sql-server","xml","tsql","xquery-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":12452522,"title":"Efficient way of doing \"insert only if node with specific value does not exist\" for an xml column","body":"<p>Say, I have a xml column that looks like this:</p>\n\n<pre><code>&lt;mi&gt;\n  &lt;m&gt;42&lt;/m&gt;\n&lt;/mi&gt;\n</code></pre>\n\n<p>Assuming table: </p>\n\n<pre><code>Word(WordId:bigint, Wordtext:nvarchar, MessageIndex:xml)\n</code></pre>\n\n<p>I do NOT want the following parameterized query to insert a new xml node if @MessageId already exists somewhere in the xml tree of Messageindex, but rather either fail with a deterministic error code, or silently:</p>\n\n<pre><code>begin try\n    insert into Word (WordText, MessageIndex) values (@WordText, '&lt;mi&gt;&lt;/mi&gt;');\n    update Word set MessageIndex.modify('insert (&lt;m&gt;{sql:variable(\"\"@MessageId\"\")}&lt;/m&gt;) into(/mi)[1]') where WordId = scope_identity();\nend try\nbegin catch\n    if error_number() = 2627\n    begin\n        update Word set\n            MessageIndex.modify('insert (&lt;m&gt;{sql:variable(\"\"@MessageId\"\")}&lt;/m&gt;) into(/mi)[1]')\n        where\n            WordText = @WordText;\n    end\n    else\n        throw\nend catch\n</code></pre>\n\n<p>select WordId from Word where WordText = @WordText;</p>\n\n<p>How do I make this happen <strong>efficiently</strong>?</p>\n"},{"tags":["sql","tsql","count"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":81,"score":1,"question_id":12482290,"title":"Count taking forever","body":"<p>I'm not a T-SQL Extrodinare, I'm an App Dev guy.  With that I can't figure out why this count is taking forever.</p>\n\n<pre><code>select  p.Code,\n    count(p.Head) as HeadCount,\n        p.Wt\nfrom Povs p\nleft outer join Sales s on SheetKey = p.SheetKey\nleft outer join Site [site] on [site].CompanyKey = s.CompanyKey\nleft outer join Lot lot on lot.LotID = s.LotID\ngroup by lot.LotID, [site].SiteKey, Code, Wt\n</code></pre>\n\n<p>Povs has around 115749000 records in it.</p>\n"},{"tags":["tsql","stored-procedures","temptables"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12486215,"title":"How do I know which temp table to delete if multiple stored procedures are creating temp tables with the same name?","body":"<p>I have been trying to figure this out the ENTIRE DAY :( ...</p>\n\n<p>I have several stored procedures (in the same database as well as different databases) that do the same thing.</p>\n\n<ol>\n<li>Creates temp table with name X.</li>\n<li>Does processing with X.</li>\n<li>Drops X.</li>\n</ol>\n\n<p>The problem is that these stored procedures are creating temp tables with the same name. How do I know which temp table to drop once I'm done with the processing if they all have the name and I can't really DROP using \"LIKE\" because a temp table might be being used by a different stored procedure?</p>\n\n<p>Here's a scenario.</p>\n\n<p>SP1 starts -</p>\n\n<ol>\n<li>Create temp table.\n...and before it goes on, this happens:</li>\n</ol>\n\n<p>SP2 is about finish</p>\n\n<ol>\n<li>Drop temp table.</li>\n</ol>\n\n<p>If the above happens, SP1 runs into issues. Such as \"temp table does not exist\"</p>\n\n<p>How do I bypass this issue?</p>\n\n<p>When I go to drop a temp table, I need to make sure I'm dropping the table related to the stored procedure that created it. Is this even possible?</p>\n"},{"tags":["sql-server-2005","tsql","sql-server-2008","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":8,"down_vote_count":0,"view_count":4618,"score":8,"question_id":259803,"title":"T-SQL Stored Procedure Execution 'atomic'?","body":"<p>Let's say I have a simple stored procedure that looks like this (note: this is just an example, not a practical procedure):</p>\n\n<pre><code>CREATE PROCEDURE incrementCounter AS\n\nDECLARE @current int\nSET @current = (select CounterColumn from MyTable) + 1\n\nUPDATE\n    MyTable\nSET\n    CounterColumn = current\nGO\n</code></pre>\n\n<p>We're assuming I have a table called 'myTable' that contains one row, with the 'CounterColumn' containing our current count.</p>\n\n<p>Can this stored procedure be executed multiple times, at the same time?  </p>\n\n<p>i.e. is this possible:</p>\n\n<p>I call 'incrementCounter' twice.  Call A gets to the point where it sets the 'current' variable (let's say it is 5).  Call B gets to the point where it sets the 'current' variable (which would also be 5).  Call A finishes executing, then Call B finishes.  In the end, the table should contain the value of 6, but instead contains 5 due to the overlap of execution</p>\n"},{"tags":["tsql","table","variables","temporary-tables"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12485445,"title":"How do I execute a sql statement through a variable (dynamic sql) that tries to do an insert into a variable table?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/4626292/how-to-use-table-variable-in-a-dynamic-sql-statement\">How to use table variable in a dynamic sql statement?</a>  </p>\n</blockquote>\n\n\n\n<p>If I do what I wanna do with a TEMPORARY TABLE, it works fine:</p>\n\n<pre><code>DECLARE @CTRFR VARCHAR(MAX)\n\nSET @CTRFR = 'select blah blah blah' -- &lt;-- very long select statement. this returns a 0 or some greater number. Please note! --&gt; I NEED THIS NUMBER.\n\nIF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo][#CTRFRResult]') AND type IN (N'U') ) \n   DROP TABLE [dbo].[#CTRFRResult]\n\nCREATE TABLE #CTRFRResult\n(\n  CTRFRResult VARCHAR(MAX)\n)\n\nSET @CTRFR = 'insert into #CTRFRResult ' + @CTRFR\nEXEC(@CTRFR)\n</code></pre>\n\n<p>The above works fine.</p>\n\n<p>The problem is that several databases are using the same TEMP table. Therefore I need to use a VARIABLE table (instead of a temporary table).</p>\n\n<p>What I have below is not working because it says that the table must be declared.</p>\n\n<pre><code>DECLARE @CTRFRResult TABLE\n(\n   CTRFRResult VARCHAR(MAX)\n)\n\nSET @CTRFR = 'insert into @CTRFRResult ' + @CTRFR -- I think the issue is here.\nEXEC(@CTRFR)\n</code></pre>\n\n<p>Setting <code>@CTRFR</code> to <code>insert into...</code> is not working because I'm assuming the table name is out of scope. How would I go about mimicking the temporary table code using a variable table?</p>\n\n<p>The error message I'm getting is: </p>\n\n<blockquote>\n  <p><em>Must declare the table variable \"@CTRFRResult\"</em></p>\n</blockquote>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12479986,"title":"I want to create a table from a restricted user account and give access to that account","body":"<p>Is this even possible?\nThis user account will have access to a few SPs &amp; Fns in the database &amp; 1 of the SPs create a new table. When creating the table, I want GRANT SELECT to this particular user for the table.\nCan this be done?</p>\n"},{"tags":["tsql","full-text-search"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":91,"score":0,"question_id":11962401,"title":"SQL Fulltext search on multiple tables with same schema","body":"<p>I am working on an Intranet helpdesk website that provides a search on some tables. Each table has the exact same schema, but is presented slightly differently depending on the purpose. For example, the Blog will display author names to the user while the FAQ and Guides sections will not. The tables have the following columns:</p>\n\n<pre><code>id int IDENTITY,\ntitle VARCHAR(255),\nbody NVARCHAR(MAX),\nauthor VARCHAR(80),\ndate DATETIME,\nlasteditor varchar(80),\nlastedited DATETIME,\nCONSTRAINT [PK_blog_id] PRIMARY KEY CLUSTERED\n([id] ASC)\n</code></pre>\n\n<p>I would like for the results of each table to return a rank with respect to <em>all</em> of the tables. </p>\n\n<p>I am using Transact SQL (SQL Server 2008), so full text indexes require a primary key to operate on. So far I've come up with two possibilities to solve the problem of getting a unique key for the fulltext index:</p>\n\n<ol>\n<li><p>Create a View every time a search is performed that unions all of the tables, and generates a unique ID column on the View using something like this:</p>\n\n<pre><code>    SELECT id,\n    variety,\n    1 + (SELECT COUNT(*) FROM tbl WHERE t.id &lt; id) as num\n    FROM tbl\n</code></pre></li>\n<li><p>Merge all of the tables into one big table, and append an extra column denoting the type (i.e \"blog\", \"faq\", \"guides\", etc). Use bigtable's primary key as the key for the fulltext index, and get the \"table\" I want using an extra WHERE clause.</p></li>\n</ol>\n\n<p>Which one is considered better practice, or performs better? It would seem like creating a view and generating an \"auto-increment\" for the view everytime someone performs a global site search is a bit slow. Maybe there's an easier way of generating a unique id column for the view?</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2","sql-server-profiler","sqlgeography"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":12484629,"title":"SQL Timeout Geography Query","body":"<p>I Get a random/intermittent SQL timeout on this query looks like it generates a lot of processing from a simple query.  Is this correct behavior?</p>\n\n<p>I have a simple stored procedure like this:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[FindClosestXNearCoordinates]\n      @latitude decimal,\n      @longitude decimal\n   AS\nBEGIN\n\nSET NOCOUNT ON;\ndeclare @emptyGUID uniqueidentifier\nset @emptyGUID = cast(cast(0 as binary) as uniqueidentifier)\ndeclare @radiusInMeters float\nset @radiusInMeters = 3500 * 1609.344   \ndeclare @coordinatePoint as Geography   \nSET @coordinatePoint = geography::STGeomFromText('POINT(' + CAST(@longitude AS VARCHAR(20)) + ' ' + CAST(@latitude AS VARCHAR(20)) + ')', 4326)\ndeclare @coordinateRadius as Geography\nset @coordinateRadius = @coordinatePoint.STBuffer(@radiusInMeters);\n\n\nselect  top 1   [b].[BaseId], [b].[Code], [b].[Name], [b].[Location], [b].[TerritoryId], [b].[Latitude], [b].[Longitude]\nfrom        XTable b\nwhere       ( b.GeoLocation.STIntersects(@coordinateRadius) = 1 )\norder by b.GeoLocation.STDistance(@coordinatePoint) asc\n\nEND\n</code></pre>\n\n<p>I capture it in SQL Profiler and it shows the query and over 188 statements in a row, which is really confusing because when i run this in SSMS it just shows 1 execution, but running in application generates 188 sub-statements.:</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":47,"score":2,"question_id":12484674,"title":"How to do double comparison on a table","body":"<p>I need compare one column LeadDate (datatype is datetime ) to the values saved in another table (named EmployeeWorkTime). The format of the LeadDate column is like this \"2006-08-08 11:50:51. 000\". </p>\n\n<p>The employeeworktime table is like this:</p>\n\n<pre><code>SyStaffId       Associate Name           Monday    Tuesday  Wednesday Thursday   Friday    Saturday        Sunday\n34128           Natasha Dawson            0919      0918      0920      0918      0918      WKEND           WKEND    \n34169           Elaine Bueno              0918      1019      0918      1019      0918      WKEND           WKEND    \n34385           Aida Rodriguez            0918      1019      0918      1019      0918      WKEND           WKEND    \n34419           Sy Lim                    1019      1019      1019      1019      0918      WKEND           WKEND     \n</code></pre>\n\n<p>I created a view and included all the fields I need for the comparison. The new view is as in the attachment. But when I want to compare the lead time to the values in the time columns. I had some difficulties. Since the leadday is different, they are in column DayofWeekName, and I want to compare the leadtime to only one column which is the same as the lead day. how could I do that?</p>\n\n<p>For example, for the first lead, the dayofweekname is Thursay, and i want to copmare the leadtime which is the leadhour column to the Thursday column, how could I write code to achieve it. </p>\n\n<p>Thank you very much.</p>\n\n<p>The commands used for creating the new view:</p>\n\n<pre><code>Create View dbo.cstAdmissionDailyReportLeadCount_jy\nAS\nSELECT     dbo.syStudent.AmRepID, dbo.syStudent.LeadDate, DATEPART(dw, syStudent.LeadDate) AS DayofWeekNumber, DATEPART(hh, syStudent.LeadDate)\n                      AS LeadHour, dbo.EmployeeWorkTime.[Associate Name], DATENAME(dw, syStudent.LeadDate) AS DayofWeekName, EmployeeWorkTime.Monday,\n                      EmployeeWorkTime.Tuesday, EmployeeWorkTime.Wednesday, EmployeeWorkTime.Thursday, EmployeeWorkTime.Friday,\n                      EmployeeWorkTime.Saturday, EmployeeWorkTime.Sunday, CASE WHEN DATEPART(hh, syStudent.LeadDate)\n                      &lt; 18 THEN 1 ELSE 0 END AS CountAsEffectiveLead\nFROM         dbo.syStudent INNER JOIN\n                      dbo.EmployeeWorkTime ON dbo.syStudent.AmRepID = dbo.EmployeeWorkTime.SyStaffId \n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":31,"score":2,"question_id":12484381,"title":"Counting records that have count(column) > 2","body":"<p>I have a CustomerData table with the following attributes:\nFirstName, LastName, DateofBirth, ID, Location</p>\n\n<p>I am trying to write a query that pulls the first name, last name, date of birth, and IDNumber of users who belong to more than one location.</p>\n\n<p>I tried the following code but I am getting an error about aggregates needing a group by clause.</p>\n\n<pre><code>SELECT *\nFROM CustomerData\nWHERE Count(Location) &gt; 2\n</code></pre>\n\n<p>Any assistance would be greatly appreciated</p>\n"},{"tags":["tsql","crystal-reports","parameter-passing","crystal-reports-xi"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12451916,"title":"application assigns value to parameter in stored procedure, used in Crystal Report","body":"<p>i have a custom application that has an embedded Crystal Reports viewer. the RPT file in question calls a stored procedure. the stored procedure has a parameter, \"<strong>UserID</strong>\".</p>\n\n<p>i want to configure the report so it can recieve a value for <strong>UserID</strong> from the application.</p>\n\n<p>right now, when i preview the report in CR11.5, it prompts me to enter a value for <strong>UserID</strong>. instead, i would like the custom application to do this for me so the <strong>Enter Values</strong> box does not appear when the report is run.</p>\n\n<p>please note: i would like answers to be about how to configure the RPT file, <strong>not</strong> about how to configure the custom application.</p>\n"},{"tags":["sql-server","tsql","schedule"],"answer_count":5,"favorite_count":1,"up_vote_count":5,"down_vote_count":0,"view_count":92,"score":5,"question_id":12476360,"title":"Now and Next TV Programme Information SQL Query","body":"<p>My table is a list of Scheduled TV Programmes for multiple days and channels.</p>\n\n<pre><code>SELECT * FROM [Scheduled_Programmes]\n\nChannel   Date          Time     Title\n1         2012-09-19    06:00    Family Guy\n2         2012-09-19    06:01    CSI Miami\n3         2012-09-19    06:20    News\n1         2012-09-19    06:30    Heroes\n2         2012-09-19    07:01    Spiderman\n3         2012-09-19    06:40    Batman\n1         2012-09-19    07:30    Micky Mouse\n2         2012-09-19    07:31    CSI New York\n3         2012-09-19    07:10    Friends\n1         2012-09-19    07:55    The Wire\n2         2012-09-19    08:00    Dodgeball\n3         2012-09-19    07:35    Gossip Girl\n</code></pre>\n\n<p>The result set I'm trying to create is What's on Now and What's on Next.</p>\n\n<pre><code>Let's assume the current datetime is (D/M/Y HH:MM) 19/09/2012 07:15 \n</code></pre>\n\n<p>So something like:</p>\n\n<pre><code>          Channel 1     Channel 2       Channel 3\nNOW       Heroes        Spiderman       Friends  \nNEXT      Micky Mous    CSI New York    Gossip Girl\n</code></pre>\n\n<p>I've been racking my brain for the best way to do this without having to hard code an individual query for each channel. I think I've got the the overthinking it stage now\n so it would be great if someone can point me in the right direction.</p>\n\n<p>Thanks</p>\n\n<p>PS: If it makes a difference I'm on Microsoft SQL Server 2012</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":74,"score":-3,"question_id":12466506,"title":"T-SQL pulling multiple columns of data from a single column field","body":"<p>I am trying to pull 3 columns of data from one field. basically i have a field with for arguments sake a table with the following data:</p>\n\n<ul>\n<li>Color,</li>\n<li>Model,</li>\n<li>Year of a car.</li>\n</ul>\n\n<p>It is itemized as <code>ID4</code> is Color, <code>ID5</code> is Model and <code>ID6</code> is Year. I can pull one data set with no problem using a filter, ex. Filter = 4, 5 or 6. But I cannot pull multiples as I just get the headers and no data at all. </p>\n"},{"tags":["sql-server-2008","query","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12482642,"title":"Using Multiple Row Criteria In the Where Clause","body":"<p>I'm trying to formulate a query that will allow me to return all of the rows with the same ID number if one of the rows meets a certain criteria. My current table and desired tables are as follows:</p>\n\n<p>Current Table:</p>\n\n<pre><code>ID  Parameter\n1   x\n1   x\n1   y\n1   x\n2   x\n2   x\n2   x\n3   y\n3   y\n3   x\n4   x\n4   x\n4   x\n</code></pre>\n\n<p>Desired Results:</p>\n\n<pre><code>ID  Parameter\n1   x\n1   x\n1   y\n1   x\n3   y\n3   y\n3   x\n</code></pre>\n\n<p>In this example, my parameter of interest is \"y\". Since y appears in at least one of the rows for ID's 1 and 3, then all of the row data for ID's 1 and 3 are selected while the rest are filtered out. Is there a way to write this in a where clause or will I need to consider another method?</p>\n\n<p>Thank you!</p>\n"},{"tags":["sql-server","performance","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12475172,"title":"How to improve t-sql performance for statement containing IsNull(NullIf(...))","body":"<p>I have inherited the following statement:</p>\n\n<pre><code>SELECT ISNULL((SELECT (-1)*SUM(CAST(ISNULL(NULLIF(TOTALMTDLCY,''),0) AS DECIMAL(20,5))) \nFROM TI),0) \n</code></pre>\n\n<p>and although I know what it's trying to do (prevent null values and return 0) I feel there must be a more performant way of doing this?</p>\n\n<p>The reason is that I have a sproc that uses this statement 12 times to get values from different tables, for 40,000 customers (480,000) and then inserts three records for each (1.5M).</p>\n\n<p>This takes around 13 mins to complete - and by gathering some simple stats on the process and totalling them it shows that although the actual time taken for the 12 statements is 00:00.015, the total time is therefore approx 10 mins.</p>\n\n<p>So, my thinking is that if I can speed up this process, then I can speed up my sproc?</p>\n"},{"tags":["sql","sql-server","tsql","where","sql-view"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":59,"score":4,"question_id":12481537,"title":"Where & Top interaction in SQL Server View","body":"<p>Do you know how to persuade SQL Server to consider WHERE clauses inside the view?\nIt looks like SQL Server is running just my view, evaluating the TOP 1, then applying the \"where id=N\" clause to filter the view's result set.\nExample:</p>\n\n<pre><code>create table mytable ( id int, name varchar(64) );\n\ninsert into mytable values ( 5, 'BOB' );\ninsert into mytable values ( 5, 'ROBERT' );\ninsert into mytable values ( 5, 'SMITH, ROBERT' );\ninsert into mytable values ( 8, 'A.J.' );\ninsert into mytable values ( 8, 'Al J.' );\ninsert into mytable values ( 8, 'Albert Johnston' );\n\nselect * from mytable;\n\n+----+-----------------+\n: id : name            :\n+----+-----------------+\n:  5 : BOB             :\n:  5 : ROBERT          :\n:  5 : SMITH, ROBERT   :\n:  8 : A.J.            :\n:  8 : Al J.           :\n:  8 : Albert Johnston :\n+----+-----------------+\n\ncreate view myview as\n   select top 1 id, name\n   from mytable\n   order by len(name) desc\n</code></pre>\n\n<p>Problem:</p>\n\n<pre><code>-- bad, empty result set\n-- (I want this to answer 5, 'SMITH, ROBERT')\nselect * from myview where id = 5 \n</code></pre>\n\n<p>These work as expected:</p>\n\n<pre><code>-- good, answers 8, 'Albert Johnston'\nselect * from myview\n\n-- good, also answers 8, 'Albert Johnston'\nselect * from myview where id = 8 \n</code></pre>\n\n<p>Now without the view:</p>\n\n<pre><code>-- good, answers 5, 'SMITH, ROBERT'\nselect top 1 id, name\nfrom mytable\nwhere id = 5\norder by len(name) desc\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","global-variables"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":7415,"score":3,"question_id":1838429,"title":"Create a global static variable in SQL Server?","body":"<p>Is there a way to create a global variable in SQL Server, in such a way that it persists even if the server is restarted, so I can use it in functions?</p>\n\n<p>Example from what I need:</p>\n\n<pre><code>DECLARE @@DefaultValue bit\n</code></pre>\n\n<p>This variable should never be deleted unless I explicityl do so.</p>\n"},{"tags":["sql-server","tsql","table","variables","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":72,"score":2,"question_id":12478228,"title":"How to put the result of a stored procedure into a table variable?","body":"<p>I'm using SQL Server 2005.</p>\n\n<p>My stored procedure returns 100 columns and has 10 pages.</p>\n\n<p>I'd only need to return 5 of the columns and don't want to duplicate the 10 pages of the stored procedure by creating a new stored procedure.</p>\n\n<p>I'd like to avoid defining a new table variable with 100 columns! and I'd like to avoid defining a LinkServer and use OPENROWSET because the server name, etc shouldn't be hardcoded.</p>\n\n<p>Is there any easier/better way?</p>\n\n<p>if so, how to write it? the below code doesn't work</p>\n\n<pre><code>select ID, Title, (the remaining 3 columns)\nfrom exec dbo.sp_myName\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":46,"score":1,"question_id":12470219,"title":"Different calculation for different ranges (intervals) of decimal value","body":"<p>A decimal type field needs to be split up into ranges (intervals), calculated differently and then summed up.</p>\n\n<p>This problem concerns field values, not rows.\nSo for a certain field (fieldX) in every row in a table:</p>\n\n<pre><code>FieldX &lt;  0.013           &lt;----remain just FieldX\nFieldX &gt;= 0.013 to 0.026  &lt;----be multiplied with 50%.\nFieldX &gt;  0.026           &lt;----be omitted.\n</code></pre>\n\n<p><em>Editorial comment:</em> The examples below show for values in the closed-closed range <code>[0.013, 0.026]</code> that the expression is:</p>\n\n<ul>\n<li><code>0.013 + (FieldX - 0.013) * 0.5</code></li>\n</ul>\n\n<p>Then these ranges (intervals) or parts needs to be summed.</p>\n\n<p>Example cases:</p>\n\n<pre><code>FieldX     Result\n-0.12      -0.12\n-0.05      -0.05\n+0.05      +0.05                                  mismatch with specification\n+0.011     +0.011\n+0.014     +0.0135 = (0.013 + (0.014-0.013)*50%)\n+0.021     +0.017  = (0.013 + (0.021-0.013)*50%)\n+0.026     +0.0195 = (0.013 + (0.026-0.013)*50%)\n+0.031     +0.0195 = (0.013 + (0.026-0.013)*50%)  mismatch with specification\n</code></pre>\n\n<p>I will hand out a Nobel prize to the genius who solves it!</p>\n"},{"tags":["visual-studio","tsql","reporting-services","ssas","mdx"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":12477542,"title":"Filter out a member from SSRS (MDX)","body":"<p>Ok, So I have a dim called <code>Employee</code> that has <code>Employee_ID</code> and the <code>ID</code> I am trying to filter out from the report table is <code>&amp;[12345]</code>. </p>\n\n<p>How would I go about filtering out a record for just that employee ID from my report table?</p>\n"},{"tags":["sql-server","xml","tsql","xquery"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":12467326,"title":"T-SQL DML: how to change/add a parent of an existing XML node?","body":"<p>I have several XML in my DB that need to be updated. Here is the simplistic representation of them:</p>\n\n<pre><code>&lt;root&gt;\n  &lt;child1&gt;blah&lt;/child1&gt;\n&lt;/root&gt;\n</code></pre>\n\n<p>I need to wrap <code>&lt;child1&gt;</code> with another element to get structure like this:</p>\n\n<pre><code>&lt;root&gt;\n  &lt;child1Root&gt;\n    &lt;child1&gt;blah&lt;/child1&gt;\n  &lt;/child1Root&gt;\n&lt;/root&gt;\n</code></pre>\n\n<p>Appears easy but I am not T-SQL and DML specialist.</p>\n\n<p>Note: if one is interested in knowing why to update, the answer is that the XML below is not deserializable using DataContractSerializer. It can be deserialized using XmlSerializer and XmlArray attribute but not DCS:</p>\n\n<pre><code>&lt;root&gt;\n  &lt;child1&gt;blah&lt;/child1&gt;\n  &lt;child2&gt;blah&lt;/child2&gt;\n&lt;/root&gt;\n</code></pre>\n"},{"tags":["sql-server","tsql","ftp"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12054482,"title":"Rename file on FTP push | SQL","body":"<p>Below is my code to push a file with SQL to another server.</p>\n\n<pre><code> EXEC [ftpPushRegisteredSSIS] '12345', '54321', 'C:\\TCC\\Manufacturer Integration\\100_110  DiaryBelle','Daily_Dairybelle.txt', '111.111.111.11', 1, 1\n</code></pre>\n\n<hr>\n\n<pre><code> CREATE PROCEDURE [dbo].[FtpPushRegisterSSIS]\n    @User VARCHAR(50),\n    @Password VARCHAR(50),\n    @sourceDir VARCHAR(250),\n    @SourceFiles VARCHAR(50),\n    @DestinationFTPServer VARCHAR(50),\n    @DestinationFTPPath VARCHAR(250),\n    @Overwrite BIT,\n    @isASCII BIT\n\nAS\nBEGIN\n    DECLARE @overwriteTF VARCHAR(5)\n    DECLARE @isASCIITF VARCHAR(5)\n\n    SET @overwriteTF = 'true'\n    SET @isASCIITF = 'true'\n\n    IF @Overwrite = 0\n    BEGIN\n        SET @overwriteTF = 'false'\n    END\n\n    IF @isASCII = 0\n    BEGIN\n        SET @isASCIITF = 'false'\n    END\n\n--  DECLARE @FtpPackage VARCHAR(150)\n--  SET @FtpPackage = 'E:\\ftpProcTesting\\ftpPush.dtsx'\n    DECLARE @cmd VARCHAR(1000)\n    DECLARE @params VARCHAR(MAX)\n    SET @params =   ' /set \\package.variables[ftpUser].Value;\"' +           @User + '\"'+\n                    ' /set \\package.variables[ftpServer].Value;\"' +         @DestinationFTPServer + '\"'+\n                    ' /set \\package.Variables[sourceDir].Value;\"' +         @sourceDir + '\"' +\n                    ' /set \\package.variables[sourceFiles].Value;\"' +       @SourceFiles + '\"'+\n                    ' /set \\package.variables[destiPath].Value;\"/' +        @DestinationFTPPath + '\"' +\n                    ' /set \\package.variables[ftpPass].Value;\"' +           @Password + '\"' +\n                    ' /set \\package.variables[overwrite].Value;\"' +         @overwriteTF + '\"' +\n                    ' /set \\package.variables[isASCII].Value;\"' +           @isASCIITF + '\"'\n\n\n    -- FOR Filesystem package SET @cmd = 'dtexec /f \"'+@FtpPackage+'\" /Rep N' --set N to V for verbose logging\n    SET @cmd = 'dtexec /sq ' + 'ftpPush' + ' /ser DBNAME '\n    SET @cmd = @cmd + @params\n\n    CREATE TABLE #output ([output] VARCHAR(500))\n    INSERT INTO #output\n    EXEC master.dbo.xp_cmdshell @cmd -- ,NO_OUTPUT\n\n    IF  (\n            SELECT COUNT(*)\n            FROM #output\n            WHERE [output] LIKE '%fail%'\n            OR [output] LIKE '%error%'\n            OR [output] LIKE '%not valid%'\n        ) &gt; 0\n    BEGIN\n        SELECT * FROM #output\n        RAISERROR('***|||FTP Operation FAILED|||***',15,1)\n    END\n\n    SELECT * FROM #output\n\nEND\n\nGO\n</code></pre>\n\n<p>When the file <code>Dairybelle.txt</code> get to the server I want it to contain the getDate() in front of the filename.</p>\n\n<p>Something like this: <code>2012-08-01_Dairybelle.txt</code></p>\n\n<p>What changes can me made to my code to do this?</p>\n\n<p>I dont want to change the file name in the current location, I just want to change it when I send it.\nSo the name will still always be <code>Dairybelle.txt</code> on my server but when it gets to them it will have the renamed file.</p>\n\n<p>I know I can write code that will change the file name in place and then after it is send change it back, but I am sure there is an easier way?</p>\n"},{"tags":["sql-server","tsql","select","concurrency","sql-update"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":82,"score":0,"question_id":12474822,"title":"T-SQL concurrent select and update statements","body":"<p>I have 2 SQL statements, that can be executed concurrently.<br>\n1st one updates request from Requests table, when request is taken for processing:</p>\n\n<pre><code>UPDATE Requests\nSET IsInProcess = '1'\n</code></pre>\n\n<p>2nd one counts requests in process:</p>\n\n<pre><code>SELECT COUNT(*)\nFROM Requests\nWHERE IsInProcess = '1'\n</code></pre>\n\n<p>I need to count requests only after update statement is finished.<br>\nWhat transaction isolation levels or table hints do I need to use to accomplish this ?</p>\n"},{"tags":["tsql","sql-server-2008"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":1347,"score":2,"question_id":6820227,"title":"Calculate working days - Monday to Fri in Tsql","body":"<p>How can i calculate the last working five days which is monday to Friday. my current script gets the last monday's date, but i cannot get the last friday's date. Please help</p>\n\n<pre><code>declare @StartDate datetime\ndeclare @EndDate datetime\n\n\n--Calculate date range for report\n\nselect @EndDate = Cast(convert(char(10), getdate(), 101)+' 00:00:00' as datetime)\nselect @StartDate = DateAdd(d, -7, @EndDate)\nselect @EndDate = Cast(convert(char(10), getdate(), 101)+' 23:59:59' as datetime)\n\nselect @StartDate startdate\nselect @EndDate  enddate\n</code></pre>\n"},{"tags":["sql","tsql","ms-access"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":47,"score":2,"question_id":12471581,"title":"How to convert sgn() function in ms-access to t-sql","body":"<p>How to convert <code>sgn()</code> function in Access to T-SQL in the following query:</p>\n\n<pre><code>SELECT \n    DISTINCT Customer.Branch_ID, \n    Customer.Bankrupt, \n    -Sgn([Bankrupt]) AS [Counts]\nFROM \n    Customer\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":6,"down_vote_count":0,"view_count":61,"score":6,"question_id":12471346,"title":"How to weekly group if you have daily data","body":"<p>I'm currently stuck with this problem. Suppose I have the following daily data</p>\n\n<pre><code>    +-------------------------+-----+----+\n    |          Date           | C1  | C2 |\n    +-------------------------+-----+----+\n    | 2012-08-01 00:00:00.000 |  44 | 44 |\n    | 2012-08-02 00:00:00.000 |  51 | 49 |\n    | 2012-08-03 00:00:00.000 |  60 | 59 |\n    | 2012-08-04 00:00:00.000 |  68 | 67 |\n    | 2012-08-05 00:00:00.000 |  82 | 78 |\n    | 2012-08-06 00:00:00.000 |  62 | 59 |\n    | 2012-08-07 00:00:00.000 |  58 | 53 |\n    | 2012-08-08 00:00:00.000 |  69 | 65 |\n    | 2012-08-09 00:00:00.000 |  82 | 72 |\n    | 2012-08-10 00:00:00.000 |  70 | 68 |\n    | 2012-08-11 00:00:00.000 |  75 | 71 |\n    | 2012-08-12 00:00:00.000 |  64 | 64 |\n    | 2012-08-13 00:00:00.000 |  74 | 69 |\n    | 2012-08-14 00:00:00.000 |  60 | 56 |\n    | 2012-08-15 00:00:00.000 |  66 | 60 |\n    | 2012-08-16 00:00:00.000 |  57 | 51 |\n    | 2012-08-17 00:00:00.000 |  52 | 49 |\n    +-------------------------+-----+----+\n</code></pre>\n\n<p>How will I group it in such a way that it will sum up C1 and C2 by weekly basis? \nExpected output should be</p>\n\n<pre><code>+---------------------------+------+----+\n|          Date             | GRU  | C1 |\n+---------------------------+------+----+\n| 2012-08-06 to 2012-12-12  |  480 | 452|\n| 2012-08-013 to 2012-08-19 |  430 | 394|\n+---------------------------+------+----+\n</code></pre>\n\n<p>It started with 2012-08-06 since the cycle should be Monday to Sunday.\nI've tried googling about an hour or so and it seems that no result fits with my problem, I Hope someone could help me. </p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","tsql","indexing","inner-join","clustered-index"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12472048,"title":"Joining tables via PK Columns when one is CLUSTERED whereas the other is NON-CLUSTERED... Bad Idea?","body":"<p>Can it have a negative performance impact to <code>INNER JOIN</code> two tables via <code>PrimaryKey</code> columns while one table has a <code>CLUSTERED</code> Index on its <code>PrimaryKey</code> column whereas the other table has a <code>NON-CLUSTERED</code> index on its <code>PrimaryKey</code> column?</p>\n"},{"tags":["sql","sql-server-2008","tsql","group-by"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12464663,"title":"SQL - Grouping with aggregation","body":"<p>I have a table (TABLE1) that lists all employees with their Dept IDs, the date they started and the date they were terminated (NULL means they are current employees). </p>\n\n<p>I would like to have a resultset (TABLE2) , in which every row represents a day starting since the first employee started( in the sample table below, that date is 20090101 ), till today. (the DATE field). I would like to group the employees by DeptID and calculate the total number of employees for each row of TABLE2.</p>\n\n<p>How do I this query? Thanks for your help, in advance.</p>\n\n<p>TABLE1</p>\n\n<pre><code>DeptID     EmployeeID   StartDate   EndDate\n--------------------------------------------\n001        123           20100101   20120101   \n001        124           20090101   NULL\n001        234           20110101   20120101\n</code></pre>\n\n<p>TABLE2</p>\n\n<pre><code>DeptID       Date      EmployeeCount\n-----------------------------------\n001          20090101     1\n001          20090102     1\n...          ...          1\n001          20100101     2\n001          20100102     2\n...          ...          2\n001          20110101     3\n001          20110102     3\n...          ...          3\n001          20120101     1\n001          20120102     1\n001          20120103     1\n...          ...          1\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":5,"favorite_count":2,"up_vote_count":2,"down_vote_count":1,"view_count":8377,"score":1,"question_id":1325044,"title":"Dynamic SQL (passing table name as parameter)","body":"<p>I want to write a stored proc which will use a parameter, which will be the table name.</p>\n\n<p>E.g:</p>\n\n<pre><code>@tablename &lt;&lt; Parameter\n\nSELECT * FROM @tablename\n</code></pre>\n\n<p>How is this possible?</p>\n\n<p>I wrote this:</p>\n\n<pre><code>set ANSI_NULLS ON\nset QUOTED_IDENTIFIER ON\nGO\n\nALTER PROCEDURE [dbo].[GetAllInterviewQuestions]\n@Alias varchar = null\nAS\nBEGIN\nExec('Select * FROM Table as ' @Alias) \nEND\n</code></pre>\n\n<p>But it says incorrect syntax near @Alias.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":168,"score":1,"question_id":12467833,"title":"Generate a unique alphanumeric ID","body":"<p>My idea is to generate a unique ID for my table Alphanumeric for My table in SQL server So I use Newid function to do that and then I truncate the result to 8 character. My question is with this code I am sure to have a unique ID? Or maybe not here is the code: </p>\n\n<pre><code>DECLARE @r varchar(8) \n\nSELECT @r = coalesce(@r, '') + n \nFROM (SELECT top 8 CHAR(number) n \n   FROM master..spt_values \n   WHERE type = 'P' AND \n      (number between ascii(0) and ascii(9) \n         OR number between ascii('A') and ascii('Z') \n         OR number between ascii('a') and ascii('z')) \n   ORDER BY newid()) a \n\nDECLARE @id varchar(10)  \nSET @id=CONVERT(varchar(8), @r)  \nDECLARE @myid varchar(10) \n\nSELECT @myid=SUBSTRING(@r,1,2)+'-'+SUBSTRING(@r,3,3)+'-'+SUBSTRING(@r,6,3)  \n\nPRINT 'Value of @myid is: '+ @myid\n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":66,"score":1,"question_id":12467406,"title":"unicode string literals using double-quotes","body":"<p>in SQL Server we denote unicode string literals thus:</p>\n\n<pre><code>declare @s nvarchar(max)\nselect @s = N'test'\n</code></pre>\n\n<p>however, we can also use double quotes... so we should be able to do this:</p>\n\n<pre><code>set quoted_identifier off\ndeclare @s nvarchar(max)\nselect @s = N\"test\"\n</code></pre>\n\n<p>but there I've gone wrong:</p>\n\n<blockquote>\n  <p>Msg 102, Level 15, State 1, Line 2 Incorrect syntax near 'test'.</p>\n</blockquote>\n\n<p>what is the correct form?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":107,"score":2,"question_id":12466568,"title":"How can I determine largest bit in a bitwise value","body":"<p>I am wondering if there is a short way (without programming the whole thing) of determining the largest number in a binary value in T-SQL.</p>\n\n<p>In a column I store what days are selected (<code>1 = sunday, 2 = monday, .. 7 = saturday</code>) bitwise. </p>\n\n<p>My translation table:</p>\n\n<pre><code>-- day of week\n-- 1 == 1       -&gt; POWER(2,0) -&gt; sunday\n-- 2 == 2       -&gt; POWER(2,1) -&gt; monday\n-- 3 == 4       -&gt; POWER(2,2)\n-- 4 == 8       -&gt; POWER(2,3)\n-- 5 == 16      -&gt; POWER(2,4)\n-- 6 == 32      -&gt; POWER(2,5)\n-- 7 == 64      -&gt; POWER(2,6) -&gt; saturday\n</code></pre>\n\n<p>So if I select <strong>FOR EXAMPLE</strong> sunday and saturday my binary value is 65.</p>\n\n<p>How can I select with <code>T-SQL</code> that <code>65</code> will be <code>7</code>??</p>\n\n<hr>\n\n<p><strong>Edit</strong></p>\n\n<p>Lets say I have two record with a two columns:</p>\n\n<pre><code> ID   | SelectedDays \n------|--------------\n 1    | 65\n 2    | 3\n</code></pre>\n\n<p>So, <code>ID 1</code> will return 7, because that will be the saturday that is selected selected and <code>ID 2</code> will return monday.</p>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12462482,"title":"How to purposely test errors in a transaction?","body":"<p>I have a stored procedure that has several transactions in a loop:</p>\n\n<pre><code>WHILE @COUNT &lt; @MY_NUM\nBEGIN\n  BEGIN TRANSACTION\n  -- DO STUFF HERE\n\n  IF(@@ERROR != 0)\n  BEGIN\n    ROLLBACK TRANSACTION\n    BREAK\n  END\n\n  COMMIT TRANSACTION\nEND\n</code></pre>\n\n<p>I would now like to test whether or not my <code>ROLLBACK TRANSACTION</code> and <code>BREAK</code> logic will work by purposely introducing an error to the loop after a certain number of runs and look at the data.</p>\n\n<p>Furthermore, I run these stored procedures from a shell script. So, I would like to test by using <code>Ctrl + C</code> in the middle of a run. Will this work? If not, how can I purposely introduce an error?</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":12466162,"title":"creating / updating view using stored procedure","body":"<p>I want to create or update a view using stored procedure like this:</p>\n\n<pre><code>CREATE PROC Proc_Get_Ready_Weapons\nAS\nBEGIN\n\n  IF EXISTS(select * FROM sys.views where name = 'dbo.vwGetReadyWeapons')\n  BEGIN\n    EXEC ('CREATE VIEW dbo.vwGetReadyWeapons ... rest of view')\n  END\n  ELSE\n  BEGIN\n    EXEC ('CREATE OR REPLACE VIEW dbo.vwGetReadyWeapons ... rest of view')\n  END\n\n  IF @@ROWCOUNT = 0\n    PRINT 'Warning: No rows were updated'  \nEND\n</code></pre>\n\n<p>But getting this error:</p>\n\n<blockquote>\n  <p>Msg 156, Level 15, State 1, Line 1<br>\n  Incorrect syntax near the keyword 'OR'.<br>\n  Warning: No rows were updated</p>\n</blockquote>\n"},{"tags":["query","tsql","syntax","common-table-expression"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":2,"view_count":69,"score":-2,"question_id":12465394,"title":"Syntax for TSQL Query and CTE query","body":"<p>I'm going to post my query at the end of this post here, but just exposition is required first. Please ignore the column names and table names but I have syntax errors in two spots. When I put this query with my CTE it tells me I have to first 'terminate the previous statement with a ;' Then I go onto alias a column name in the CTE and then it says 'The multi-part identifier \"E.ActiveAGVs\" could not be bound.'</p>\n\n<p>I hope that I am explaining my problem well enough. If anyone can see what I'm trying to do and let me know if it will work or correct my syntax errors, I would really appreciate it. </p>\n\n<pre><code>Select A.move_hour as 'Hour', \n       isnull(B.move_count,0) as 'Current_Count', \n       isnull(C.move_count,0) as '1_Day_Previous', \n       isnull(D.move_count,0) as '2_Day_Previous',\n       ISNULL (E.ActiveAGVs,0) as 'Active AGV''s'\n           --^ Error right here\nfrom\n   (select distinct(DATEPART(HH, Move_History.Move_Dt)) as move_hour \n   from Move_History \n   where Plant_Id = 1 and Building_Id = 1) as A\nleft outer join\n   (select datepart(HH,Move_History.Move_Dt) as move_hour, \n           Move_History.Move_Cnt as move_count \n   from Move_History \nGroup by datepart(HH,Move_History.Move_Dt), Move_Cnt) as B on A.move_hour = B.move_hour\nleft outer join\n(select datepart(HH,Move_History.Move_Dt) as move_hour, Move_History.Move_Cnt as       move_count \nfrom Move_History \nGroup by datepart(HH,Move_History.Move_Dt), Move_Cnt) as C on A.move_hour = C.move_hour\nleft outer join\n(select datepart(HH,Move_History.Move_Dt) as move_hour, Move_History.Move_Cnt as move_count \nfrom Move_History \nGroup by datepart(HH,Move_History.Move_Dt), Move_Cnt) as D on A.move_hour = D.move_hour;\nwith const as (\n    select cast(cast(getdate() as date) as datetime) as midnight\n    ),\nallhours as (\n    select 0 as m_hour, midnight as timestart, dateadd(hour, 1, midnight) as timeend from const union all\n   ...\n    select 23 as m_hour, dateadd(hour, 23, midnight) as timestart, dateadd(hour, 24, midnight) as timeend from const\n   ) \n(select ah.m_hour,\n   (sum(datediff(SECOND, timestart), ah.timeend else dt.End_Dt end)) \n   / 18000.0) * 5 as ActiveAGVs              \nfrom allhours as ah\n left outer join AGV_Report as dt\n on ah.timestart&lt; coalesce(dt.End_dt, getdate()) and\n    ah.timeend &gt;= dt.Begin_Dt\nGroup by datepart(SECOND,ah.hour), ah.timestart) as E on A.move_hour = E.move_hour\n                                   --^ 'Incorrect syntax near \"as\"'\n where A.move_hour is not null\norder by ah.m_hour asc\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":76,"score":0,"question_id":12464956,"title":"Weird SQL query","body":"<p>I am working on a project and I have a weird requirement. </p>\n\n<p>I have a table <code>A</code> with fields <code>(TechID(Primary Key), Orders (INTEGER NUMBER),Name (Varchar))</code>. </p>\n\n<p>The values of <code>Orders</code> can be <code>0, 1, 2, 3, .......</code> My task is to display the contents of the table ordered by <code>Orders</code> field. rows where the <code>Orders</code> field has a value of <code>1</code> are displayed first, followed sequentially by the rest. rows with a value of <code>0</code> must be displayed at the end. If all the <code>Orders</code> field's values are 0 I need to order the table by the <code>TechID</code> field.</p>\n\n<p>Any ideas about achieving this ? Can this be achieved with a SQL query or should I write a T-Sql script for this ? </p>\n"},{"tags":["tsql","case","ssms"],"answer_count":0,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":12466172,"title":"How to develop TSQL Case Where statement","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/2006242/using-case-in-t-sql-in-the-where-clause\">using CASE in T-SQL in the where clause?</a><br>\n  <a href=\"http://stackoverflow.com/questions/12411326/how-to-best-add-a-report-parameter-with-multiple-values-to-multiple-reports\">How to best add a report parameter with multiple values to multiple reports?</a>  </p>\n</blockquote>\n\n\n\n<p>I am using SSMS 2008 R2 to develop a query that will return records as follows.\nI have one parameter for this dataset that can either be one value or multiple values.  But the tricky part is that both the single value and multiple values are part of the same list:\nA = multi-value\nB, C, D = single values</p>\n\n<p>So if A is selected, A includes all 3 values: B, C, D.\nBut if B is selected, only B records should show.</p>\n\n<p>What is the best way to handle this within my sproc?<br>\nSo far I created a permanent table which stores the info for B,C,D.  And now I'm trying to figure out how to JOIN in B,C,D if A is selected.  Should I use a CASE statement in my WHERE clause?  Some special kind of JOIN?  A CTE?</p>\n"},{"tags":["sql","sql-server","tsql","transactions"],"answer_count":7,"favorite_count":3,"up_vote_count":14,"down_vote_count":0,"view_count":7900,"score":14,"question_id":971177,"title":"Using \"GO\" within a transaction","body":"<p>I'm building a web app that attempts to install/upgrade the database on App_Start.\nPart of the installation procedure is to ensure that the database has the asp.net features installed. For this I am using the System.Web.Management.SqlServices object.</p>\n\n<p>My intention is to do all the database work within an SQL transaction and if any of it fails, roll back the transaction and leave the database untouched.</p>\n\n<p>the SqlServices object has a method \"Install\" that takes a ConnectionString but not a transaction. So instead I use SqlServices.GenerateApplicationServicesScripts like so:</p>\n\n<pre><code>string script = SqlServices.GenerateApplicationServicesScripts(true, SqlFeatures.All, _connection.Database);\nSqlHelper.ExecuteNonQuery(transaction, CommandType.Text, script, ...);\n</code></pre>\n\n<p>and then I use the SqlHelper from the Enterprise Library.</p>\n\n<p>but this throws an Exception with a butt-load of errors, a few are below</p>\n\n<pre><code>Incorrect syntax near 'GO'.\nIncorrect syntax near 'GO'.\nIncorrect syntax near 'GO'.\nIncorrect syntax near 'GO'.\nIncorrect syntax near the keyword 'USE'.\nIncorrect syntax near the keyword 'CREATE'.\nIncorrect syntax near 'GO'.\nThe variable name '@cmd' has already been declared. Variable names must be unique within a query batch or stored procedure.\n</code></pre>\n\n<p>I'm presuming it's some issue with using the GO statement within an SQL Transaction.</p>\n\n<p>How can I get this generated script to work when executed in this way.</p>\n"},{"tags":["c#","sql","tsql","stored-procedures"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":107,"score":0,"question_id":12462447,"title":"How to run an SQL stored procedure through C# at a specific time?","body":"<p>I am building a website now for a library and i need to check every day at the same time if there are people who need to return their books in the next five days and to send them a reminder via email.</p>\n\n<p>My question is what will be the correct way to do that?</p>\n\n<p>What i need to accomplish is when the specific time of day comes i need to run an sql stored procedure and check either through visual studio 2010 or any other way if the stored procedure has returned any results to which i need to email.</p>\n\n<p>Is there a way to maybe check the system time constantly on C# and not as a triggered event?</p>\n"},{"tags":["sql-server","xml","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":117,"score":1,"question_id":12308099,"title":"t-sql: dynamically filter XML on multiple conditions?","body":"<p>I'm trying to find a way to do a accept/reject on an XML string, by joining it to a table of conditions.  I have one \"filter\" working now, but want to write it so that it can filter 2 or more.  </p>\n\n<p>Here's code that matches one of the two.  If either matches, it will filter the string.\nWhat I want to do is make it so it has to match BOTH, while still leaving the option for single-condition</p>\n\n<pre><code>CREATE TABLE #filter (exclusion_type CHAR(1), excluded_value varchar(10))\nINSERT INTO #filter VALUES ('B','boy')\nINSERT INTO #filter VALUES ('C','cat')\n\nDECLARE @data XML\nSELECT @data = '&lt;A&gt;&lt;B&gt;boy&lt;/B&gt;&lt;C&gt;cat&lt;/C&gt;&lt;/A&gt;'\nSELECT * FROM (SELECT CONVERT(VARCHAR(128),node.query('fn:local-name(.)')) AS NodeName, CONVERT(VARCHAR(MAX),node.query('./text()')) AS NodeValue\nFROM @data.nodes(N'//*') T(node))xml_shred\n\nIF NOT EXISTS \n(SELECT * FROM (SELECT CONVERT(VARCHAR(128),node.query('fn:local-name(.)')) AS NodeName, CONVERT(VARCHAR(MAX),node.query('./text()')) AS NodeValue\nFROM @data.nodes(N'//*') T(node)) xml_shred\nINNER JOIN #filter\nON   (nodename = exclusion_type AND nodevalue LIKE excluded_value)\n)\nselect 'record would be inserted '\nELSE select 'record was filtered'\n</code></pre>\n\n<p>Here's how I currently have it to filter both.  Ugly and non-expandable.</p>\n\n<pre><code>IF NOT EXISTS \n(SELECT * FROM (SELECT CONVERT(VARCHAR(128),node.query('fn:local-name(.)')) AS NodeName, CONVERT(VARCHAR(MAX),node.query('./text()')) AS NodeValue\nFROM @data.nodes(N'//*') T(node)) xml_shred\nINNER JOIN #filter\nON   (nodename = exclusion_type AND nodevalue LIKE excluded_value)\n)\n--combination filters don't easily work within that xml_shred\nand not(\n        @data.value('(/A/B)[1]', 'varchar(128)') = 'boy'\n        AND \n        @data.value('(/A/C)[1]', 'varchar(128)')='cat'\n        )\n\nselect 'record would be inserted '\nELSE select 'record was filtered'\n</code></pre>\n\n<p>My only other ideas:</p>\n\n<ul>\n<li>some sort of GUID that would link records in the #filter table together, and then inner join on a GROUP BY of #filtertable, grouping by the GUID and using the SUM to match the number of records.</li>\n<li>use semicolons to split the #filter rows, then use a CTE or something to fake a hierarchy and work from there.</li>\n</ul>\n\n<hr>\n\n<p>Code changes made by Mikael's suggestion</p>\n\n<pre><code>CREATE TABLE #filter\n    (\n      exclusion_set SMALLINT,\n      exclusion_type CHAR(1) ,\n      excluded_value VARCHAR(10)\n    )\nINSERT  INTO #filter\nVALUES  (1, 'B', 'boy')\nINSERT  INTO #filter\nVALUES  (1, 'C', 'cat')\nINSERT  INTO #filter\nVALUES  (2, 'D', 'dog' )\n\nDECLARE @data XML\nSELECT  @data = '&lt;A&gt;&lt;B&gt;boy&lt;/B&gt;&lt;C&gt;cat&lt;/C&gt;&lt;/A&gt;'\nIF NOT EXISTS(\nSELECT * FROM \n(\nselect COUNT(*) AS match_count, exclusion_set\n              from #filter as F\n              where exists (\n                           select *\n                           from (\n                                select X.N.value('local-name(.)', 'varchar(128)') as     NodeName,\n                                       X.N.value('./text()[1]', 'varchar(max)') as     NodeValue\n                                from @data.nodes('//*') as X(N)\n                                ) T\n                           where T.NodeName = F.exclusion_type and\n                                 T.NodeValue like F.excluded_value \n                           )\nGROUP BY exclusion_set\n) matches_per_set\nINNER JOIN \n(SELECT COUNT(*) AS total_count, exclusion_set FROM #filter GROUP BY exclusion_set)     grouped_set\nON match_count = total_count\nAND grouped_set.exclusion_set = matches_per_set.exclusion_set\n)\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12462998,"title":"How can you make a new, non-nullable column whose initial data will just clone over from that of another column?","body":"<p>Let's say there's a table in SQL Server 2008 with two columns: id and name.  Now let's say you want to add a non-nullable column to the table called \"description\", and in the process of adding this column, you want to use the data in name as the original batch of data in  description.  Is there not a way to do this directly, i.e., without dropping the table and re-creating it or filling in the values manually post-addition or something?  If there is a way, how?  Thanks!</p>\n"},{"tags":["tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12461913,"title":"TVP - are they used for input and output?","body":"<p>I've started to read the notes on Table Value Parameters</p>\n\n<ul>\n<li><p><a href=\"http://msdn.microsoft.com/en-us/library/bb510489.aspx\" rel=\"nofollow\">HERE ON MSDN</a></p></li>\n<li><p><a href=\"http://www.sommarskog.se/arrays-in-sql-2008.html#TVP_in_TSQL\" rel=\"nofollow\">HERE ON SOMMARSKOG</a></p></li>\n</ul>\n\n<p>Can these TVPs be used as input parameters and output parameters?<br>\nIs there a point in having them as an output parameter?<br>\nI get the feeling it might be possible to have a TVP as output from one stored procedure and then that feeding into another stored procedure - possible?<br>\nThe syntax of the script which calls the first sproc and then calls the second sproc using the output TVP from the first is the bit I'm unsure of.</p>\n\n<p><strong>EDIT</strong></p>\n\n<p>Apologies for the confusion of my post - it seems that the initial procedures results need to go into the TVP - I thought that the TVP needed to be involved <em>within</em> that sproc. So a model of what I was talking about is the following - hopefully a valid use of TVPs...</p>\n\n<pre><code>CREATE TYPE myfirstTVP AS TABLE (id INT NOT NULL PRIMARY KEY);\n\nGO --&lt;&lt;this sproc will find the ids (+ other fields) that need to be investigated\n    CREATE PROC test1 as\n        SELECT 1 UNION \n        SELECT 2 UNION\n        SELECT 3;\nGO\n\nGO --&lt;&lt;this sproc uses the found ids to do one aspect of the investigation\n    CREATE PROC test2 \n    @t2 myfirstTVP READONLY \n    AS\n            SELECT id*2 \n            FROM @t2;\nGO\n\nGO --&lt;&lt;this sproc uses the found ids to do another aspect of the investigation\n    CREATE PROC test3 \n    @t4 myfirstTVP READONLY \n    AS\n            SELECT id*3 \n            FROM @t4;\nGO    \n\n    --&lt;&lt;this is where the TVP is used and the sprocs are called \n    DECLARE @t3 myfirstTVP ;\n    INSERT INTO @t3 \n    EXEC test1;\n\n    EXEC test2 @t3;\n    EXEC test3 @t3;\n</code></pre>\n"},{"tags":["sql","tsql","select","except"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12462560,"title":"Update with except statement","body":"<p>This is my query </p>\n\n<pre><code>SELECT PageVisit_ID,TargetSite_ID FROM [A].Datawarehouse.mi.ctb_PageEvent WITH (NOLOCK)\n EXCEPT \n SELECT PageVisit_ID ,TargetSite_ID FROM [B].Datawarehouse.mi.ctb_PageEvent WITH (NOLOCK)\n</code></pre>\n\n<p>these two tables from two servers. I need to update <code>targetsite_id</code> in <code>[A].Datawarehouse.mi.ctb_PageEvent</code> records from <code>[B].Datawarehouse.mi.ctb_PageEvent</code>\nonly matched with above query results. </p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12413269,"title":"Group by with aggregate or a subquery","body":"<p>How can I do this (not production, know it's not pretty):</p>\n\n<pre><code>SELECT mat1_01_06, count(mat1_01_06), MAX(mat_no),\nMAX(\n        (\n          SELECT \n          document.mat_no\n          FROM TimeMatters11.lntmu11.document \n          WHERE matter.sysid = document.mat_id and ccode = 'SUMS' \n        )\n    )\nFROM TimeMatters11.lntmu11.matter\nWHERE con_no in \n('PR12-221' , '...', '...)\nAND mat1_01_06 != ''\nGROUP BY mat1_01_06\nHAVING count(mat1_01_06) &gt; 1\nORDER BY count(mat1_01_06) desc\n</code></pre>\n\n<p>The output is </p>\n\n<blockquote>\n  <p>Msg 130, Level 15, State 1, Line 7<br>Cannot perform an aggregate function on an expression containing an aggregate or a   subquery.</p>\n</blockquote>\n\n<p>I would just like the mat_no that has a child document coded 'SUMS'</p>\n\n<h2>Edit 2</h2>\n\n<p>Output without subquery</p>\n\n<pre><code>Index                Cnt    mat_no(not useful)\n112565/11            25     12-61692\n16601/11             12     12-58850\n34934/11             12     12-58854\n34935/11             12     12-61983\n704612/12            12     12-55487\n712166/12            11     12-55613\n707588/12            9      12-55604\n91394/11             8      12-57115\n</code></pre>\n\n<p>Desired</p>\n\n<pre><code>Index           Cnt     Mat_no that contains doc 'SUMS' \n112565/11   25      12-61692\n16601/11    12      12-58850\n34934/11    12      12-58854\n34935/11    12      12-61983\n704612/12   12      12-55487\n712166/12   11      12-55613\n707588/12   10      12-55604\n</code></pre>\n\n<p>The mat_no is a many to one relationship to the index, the specific mat_no that has a child doc 'SUMS' is the master record.  The one I need to then focus on.  Sorry lil confusing.</p>\n"},{"tags":["c#","sql","tsql","currency"],"answer_count":6,"favorite_count":2,"up_vote_count":12,"down_vote_count":0,"view_count":4211,"score":12,"question_id":618056,"title":"What is the best way to store a money value in the database?","body":"<p>I need to store a couple of money related fields in the database but I'm not sure which data type to use between <strong>money</strong> and <strong>decimal</strong>.</p>\n"},{"tags":["c#","asp.net","sql","tsql","query-string"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":152,"score":0,"question_id":12357297,"title":"Input to SQL Stored Procedure","body":"<p>I am trying to grab a querystring from the URL and send it to my stored procedure in MSSQL. The querystring is of type varbinary and when i try to send it my application is throwing an exception. I also wanted to return the select statement at the bottom of my storedprocedure that simply says <code>Select 'Processed'</code></p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12461605,"title":"remove duplicate values from the column of the table without deleting the row of the table","body":"<p>I have written this code </p>\n\n<pre><code>SELECT  \n\ncast(isnull(x.hc,'') AS VARCHAR(500)) as A,\n\nCase\nWhen cast(isnull(p.dg,'') AS VARCHAR(500)) = '0' then ''\nelse cast(isnull(p.dg,'') AS VARCHAR(500))\nEnd as B, \n\nCase\nWhen cast(isnull(h.cno,'') as varchar(500)) = '0' then ''\nelse cast(isnull(h.cno,'') as varchar(500))\nEnd as C, --added\n\ncast(isnull(p.vol,0) as varchar(500)) as D,\n\ncast(isnull(p.weigh,0) as varchar(500)) as E\n\nFROM ship g\ninner join S_M d on d.ship_id = g.ship_id\nleft join Pack h on h.ship_id = g.ship_id\nleft join pack_d p on p.pack_id = h.pack_id\nleft join comm x on x.comm_id = p.comm_id\nWHERE g.ship_pk = @ship_pk \nGROUP BY  cast(isnull(x.hc,'') AS VARCHAR(500)), cast(isnull(p.dg,'') AS VARCHAR(500)), cast(isnull(h.cno,'') as varchar(500)), cast(isnull(p.vol,0) as varchar(500)), cast(isnull(p.weigh,0) as varchar(500)) \n</code></pre>\n\n<p>Which gives me the ouput as </p>\n\n<pre><code>A     B      C        D        E\n\n123   Yes    AB456    26.34    28.45\n123   Yes    AB687    26.34    28.45\n125   No     AB794    22.58    24.36\n125   No     AB456    22.58    24.36\n125   No     AB687    22.58    24.36\n</code></pre>\n\n<p>How Can I change my code above so that I can get the Output as</p>\n\n<pre><code>A     B      C        D        E\n\n123   Yes    AB456    26.34    28.45\n             AB687    26.34    28.45\n125   No     AB794    22.58    24.36\n             AB456    22.58    24.36\n             AB687    22.58    24.36\n</code></pre>\n\n<p>How can I remove the duplicate values from the first two columns of the table\nAs shown above? \nI am not deleting any row here, instead just removing the duplicate values and keeping that field blank.</p>\n\n<p>How can I do that? </p>\n"},{"tags":["tsql","jdbc","sybase","isql","jconnect"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":179,"score":0,"question_id":10457348,"title":"Trying to get sybase db to connect via isql command line.... Gui RazorSQL works","body":"<p>Im using RazorSQL and the settings to connect is </p>\n\n<p>GUI RazorSQL Connections show as</p>\n\n<pre><code> Driver Class  net.sourcefourge.jtds.jdbc.Driver\n\n Driver Location  /Java/drivers/jtds/jtds12.jar\n\n JDBC URL   jdbc:jtds:sybase://IP-address:4100/DATABASE\n</code></pre>\n\n<p>LINUX connections show</p>\n\n<p><strong>/etc/freetds.conf</strong></p>\n\n<pre><code>[Serverconnection]\n\n    host = 10.10.10.10\n    port = 4100\n    tds version = 8.0\n    dump file = /var/log/freetds.log\n</code></pre>\n\n<p><strong>/etc/odbc.ini</strong> </p>\n\n<pre><code>[Serverconnection]\n\n     Driver          = /usr/local/freetds/lib/libtdsodbc.so\n     Description     = Sybase JDBC Server\n     Trace           = No\n     Server          = 10.10.10.10\n     Database        = SYB\n     Port            = 4100\n     TDS_Version     = 5.0\n</code></pre>\n\n<p>End goal is to connect to the sybase db Via command line so i can build them in bash scripts but i cant seem to connect to it via ISQL </p>\n\n<p>not sure if theres a driver or jar needed or something really.</p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12460742,"title":"Single quote in a query","body":"<p>How can I insert an single quotes in a query ?</p>\n\n<p><strong>Example</strong></p>\n\n<pre><code>select *, 'INSERT INTO San_Endereco (Endereco_Id, Logradouro_Id, Bairro_Id, CEP, Logradouro, Livre) VALUES \n(' + CAST(Endereco_Id as varchar) + ','\n+ CAST(Logradouro_Id as varchar) + ','\n+ CAST(Bairro_Id as varchar) + ','\n+ CAST (CEP as varchar) + ','\n+ CAST(Logradouro as varchar) + ','\n+ CAST(Livre as varchar) + ')'  as teste\nFROM San_Endereco\n</code></pre>\n\n<p>Before each <code>CAST</code> I need put the single quote. How can I do that ?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12460225,"title":"SQL query involving group by and joins","body":"<p>I couldn't be more specific in the title part but I want to do something a little bit complex for me. I thought I did it but it turned out that it is buggy.</p>\n\n<p>I have three tables as following:</p>\n\n<p>ProjectTable</p>\n\n<ul>\n<li>idProject</li>\n<li>title</li>\n<li>idOwner</li>\n</ul>\n\n<p>OfferTable</p>\n\n<ul>\n<li>idOffer</li>\n<li>idProject</li>\n<li>idAccount</li>\n</ul>\n\n<p>AccountTable</p>\n\n<ul>\n<li>idAccount</li>\n<li>Username</li>\n</ul>\n\n<p>Now in one query I aim to list all the projects with most offers made, and in the query I also want to get details like the username of the owner, <s>username of the offerer*</s> etc. So I don't have to query again for each project.</p>\n\n<p>Here is my broken query, it's my first experiment with GROUP BY and I probably didn't quite get it.</p>\n\n<pre><code>SELECT Project.addDate,Project.idOwner ,Account.Username,Project.idProject,\n    Project.Price,COUNT(Project.idProject) as offercount \nFROM Project \nINNER JOIN Offer \n    ON Project.idProject= Offer.idProject \nINNER JOIN Account \nON Account.idAccount = Project.idOwner  \nGROUP BY Project.addDate,Project.idOwner,\n    Account.Username,Project.idProject,Project.Price \nORDER BY addDate DESC\n</code></pre>\n\n<p>*:I wrote that without thinking I was just trying to come up with example extra information, that is meaningless thanks to Hosam Aly.</p>\n"},{"tags":["xml","sql-server-2008","tsql","telerik","treeview"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":100,"score":0,"question_id":12376218,"title":"Query for treeview","body":"<p>I have a query which is working fine.</p>\n\n<p>Is it possible that if the table3's column(Child) is only related to table 1  to show it under table 1 and not under table 2, but at the same time another (Child) has a parent in table 2 (which usually is the case)  it will show under table 2 as its currently doing.</p>\n\n<p><strong>In other words Child column is directly under Table2's row column name (Father), but occasionally it comes under Table1 with no relation to Table 2.</strong></p>\n\n<p>How can I out put that in a query for a treeview? I am assuming that I will have to program   the out come in c# also with 3 for loops and in the second loop I can check if the column is grandchild or Child and make that as a second row or 2nd node of treeview, but I am having a problem building a query in sql. Any help is much appreciated.</p>\n\n<p>The query below shows all Parent, then child then grand child(all well and working),  but what is desired is at times child takes place of a father.</p>\n\n<pre><code>declare @x as xml\nset @x =\n(\nSELECT distinct  \nTable1.AssetSysID, Table1.Asset_ID , Table1.FromLR, Table1.Asset_ID + ', ' + Table1.[Desc2] as GarndFather,\nTable2.ACISysID ,Table2.PAssetSysID, Table2.FeatureName + ', ' + Table2.[DESC] AS Father,\nTable3.ITMSysID  ,Table3.Item_ID + ',' + Table3.[DESC] as Child\nFROM  Table1 left outer join \nTable2 ON Table1.AssetSysID = Table2.PAssetSysID left outer join \nTable3 ON Table1.AssetSysID = Table3.AssetSysID AND Table2.ACISysID = Table3.ACISysID\nwhere (Table1.AssetType = @AssetType)\nfor xml auto,root('xml')\n)\n</code></pre>\n\n<p>Asp.Net Telerik Treeview DataBinding Code:</p>\n\n<p>\n                        \n\n<pre><code>DataMember=\"Table1\" TextField=\"Assets\" ValueField=\"AssetSysID\" ToolTip=\"Asset\" ImageUrl=\"~/Images/DeleteIco.png\"/&gt;\n                        &lt;telerik:RadTreeNodeBinding DataMember=\"Table2\" TextField=\"Feature\" ValueField=\"ACISysID\" ToolTip=\"Feature\" ImageUrl=\"~/Images/CutIco.png\"/&gt;\n                         &lt;telerik:RadTreeNodeBinding DataMember=\"Table3\" TextField=\"Equipment\" ValueField=\"ITMSysID\" ToolTip=\"Equipment\" ImageUrl=\"~/Images/EditIco.png\"/&gt;\n\n          &lt;/DataBindings&gt; \n</code></pre>\n\n<p>*<strong><em>Final Code:</em></strong></p>\n\n<pre><code> select Table1.AssetObjID as \"@AssetObjID\",\n           Table1.Asset_ID as \"@Asset_ID\",\n           Table1.FromLR as \"@FromLR\",\n           Table1.AssetType + ', ' + Table1.StreetName + ', ' +  Table1.FromMunicNo   as \"@FirstRow\",\n           (\n           select Table2.ACIObjID as \"@ACIObjID\",\n                  Table2.PAssetObjID as \"@PAssetObjID\",\n                  Table2.Feature_ID + ', ' + Table2.FeatureName   AS \"@ChildOfFirstRow\",\n                  (\n                  select Table3.ITMObjID as \"@ITMObjID\",\n                         Table3.Item_ID + ',' + Table3.[DESC] as \"@GrandChildOfFirstRow\"\n                  from Table3\n                  where Table1.AssetObjID = Table3.AssetObjID and \n                        Table2.ACIObjID = Table3.ACIObjID\n                  for xml path('Table3'), type\n                  )\n           from Table2\n           where Table1.AssetObjID = Table2.PAssetObjID\n           for xml path('Table2'), type\n           ),\n(\n           select Table3.ITMObjID as \"@ITMObjID\",\n                         Table3.Item_ID + ',' + Table3.[DESC] as \"@GrandChildOfFirstRow\"\n                  from Table3\n                  where Table1.AssetObjID = Table3.AssetObjID and \n                        Table2.ACIObjID &lt;&gt; Table3.ACIObjID\n                  for xml path('Table3'), type\n)\n    from Table1\n    where Table1.AssetType = 'xxxx'\n    for xml path('Table1'), root('xml')\n</code></pre>\n"},{"tags":["sql-server","tsql","coding-style","sql-azure"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12458292,"title":"How do you comment your db schema objects in SQL Azure database project?","body":"<p>As far as I understand <code>sp_addextendedproperty</code> is not available in SQL Azure databases as of now. So.. How do you comment your tables, columns, sprocs and other objects in your database project?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":62,"score":2,"question_id":12457363,"title":"How do I check the existence of a table using a variable as tablename","body":"<p>a) checks a table to find names of other tables that need to be created\nb) check if that table already exists\nc) if not, create it\nd) fill her up with new data</p>\n\n<p>Now, this all works fine up to the part that has to check whether the table exists:</p>\n\n<pre><code>set @NewTablename = (select NAME from SomeTable where ID= @i)\nset @Tabelexists = 'select case when exists(select * from sys.tables where name = ''' + @NewTabelname + ''') then 1 else 0 end'\n\ndeclare @check as int execute(@Tabelexists)\n\nIF    @check is NULL \nBEGIN\nCreate Table\nEND\nELSE\nBEGIN\nexecute('Delete from '+ @NewTableName)\nEND\n\n&lt;other stuff like inserts and so on)\n</code></pre>\n\n<p>But somehow, @check always seems to be NULL when the table does not exist, and to 1 if it does.</p>\n\n<p>If I check for <code>IF @check is null</code> only the TRUE part is executed if the table does not exist. If it <em>does</em> exist at that moment <em>nothing</em> is executed.....</p>\n\n<p>If I check for <code>IF @check =1</code>  only the ELSE is executed</p>\n\n<p>The value of @check  apparently is always either NULL or 1 or 0..........</p>\n\n<p>I am at a loss here! \nHow do I check the existence of a table using a variable as tablename?</p>\n\n<p>Damien, I understand what you are saying. But if I do it like this I still have no result I can test:</p>\n\n<p><code>declare  @check as int execute ('select case when exists(select * from sys.tables where name = ''' + @Tabelnaam + ''') then 1 else 0 end')</code></p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12454786,"title":"Should I use a partition or is there a better way?","body":"<p>I have a table structure, simplified like so:</p>\n\n<pre><code>period_id int\nsuite_id varchar(20)\nsuite_status varchar(50)\n</code></pre>\n\n<p>Each month is assigned to a period id. Each suite has a record for each month (period_id). Suite status's can be either 'Vacant' or 'Active Lease'. I'm trying to write a query that shows the top five deals that have been leased since the 1st of July 2011 that were vacant the longest before they became an active lease but I don't know how to approach this.</p>\n\n<p>My original approach was to rank each lease by the number of periods that it was vacant, like so:</p>\n\n<pre><code>;WITH cte_vacancy_periods AS\n(\n        SELECT  lp.suite_id ,\n                count(lp.period_id) AS 'Periods Vacant'\n        FROM    property.lease_period lp\n        WHERE   lp.suite_status = 'Vacant'\n                        OR\n                        (       isnull(lp.suite_status, '') = ''\n                                AND     lp.lease_id = 'No Lease'        )\n        GROUP BY\n                lp.suite_id\n        ORDER BY count(lp.period_id) desc\n)\n</code></pre>\n\n<p>I was then planning to cross-reference this with the leases made active since period 258 (the 01-July-2011).</p>\n\n<p>Unfortunately this doesn't work in cases where a lease was vacant for two months, then leased for a month then vacant for two more months (showing a total of four months vacant before being leased when it should really be two).</p>\n\n<p>I'm sure this could be done with a partition but I've come up short trying to do this and don't quite understand them. What am I missing in my knowledge for approaching this problem? If I've explained the data poorly so it's hard to understand what I'm trying to do please let me know and I'll elaborate where I can.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":361,"score":0,"question_id":12453592,"title":"Error converting data type varchar to numeric in SQL","body":"<p>I have spent the last 3 hours trying to figure this out but I have had not luck. When executing this SP I get the below error:</p>\n\n<pre><code>Msg 8114, Level 16, State 5, Procedure sp_SPLIT_CARTON, Line 28\nError converting data type varchar to numeric.\n</code></pre>\n\n<p>Here is the SP and help is really appreciated</p>\n\n<pre><code>USE [1_WMS]\n\nGO \n\nALTER PROCEDURE [dbo].sp_SPLIT_CARTON\n    @FROM_CARTON VARCHAR(20)\n    , @TO_CARTON VARCHAR(20)\n    , @SKU VARCHAR(20)\n    , @QTY DECIMAL\n    , @USER VARCHAR(20)\n\nAS\nDECLARE \n    @DATE VARCHAR(10)\n    , @TIME VARCHAR(8)\n    , @SYS_CONFIG_CODE VARCHAR(5)\n    , @SYS_CONFIG_VALUE INT\n    , @CN_STATUS INT\n    , @CN_STATUS_1 INT  --USE FOR BETWEEN STATEMENT\n    , @CN_STATUS_2 INT  --USE FOR BETWEEN STATEMENT\n    , @CN_STORE VARCHAR(10)\n\n    SET @DATE = CONVERT(VARCHAR(10), GETDATE(),101);\n    SET @TIME = CONVERT(VARCHAR(8), GETDATE(),114);\n    SET @SYS_CONFIG_CODE = 'SPLCN';\n    SET @CN_STATUS_1 = '10'; \n    --SET @CN_STATUS_2 = 20;\n\n    --THIS IS LINE 28\n/*CHECK FOR VALID CARTON STATUS BEFORE SPLITTING*/  \nSELECT  @CN_STATUS = cn_status \n        , @CN_STORE = cn_store\nFROM CARTON\n    WHERE cn_number = @FROM_CARTON    --I BELIEVE THIS IS THE PIECE OF CODE CAUSING THE ISSUE\n\n\nIF @CN_STATUS = @CN_STATUS_1\n    BEGIN\n\n        /*CHECK FOR SYSTEM CONFIGURATION*/  \n        SELECT @SYS_CONFIG_VALUE = sys_value FROM SYS_CONFIG\n            WHERE sys_code = @SYS_CONFIG_CODE\n\n        IF @SYS_CONFIG_VALUE = 1\n            BEGIN\n                /*REMOVE SKU FROM CURRENT CARTON*/\n                DELETE FROM CARTON_DETAIL \n                    WHERE cd_carton_number = @FROM_CARTON\n                        AND cd_barcode = @SKU\n\n                /*UPDATE THE CARTON HEADER*/\n                UPDATE CARTON\n                    SET cn_packed_qty = cn_packed_qty - @QTY\n                        , cn_modify_date = @DATE\n                        , cn_modify_time = @TIME\n                        , cn_modify_by = @USER\n                    WHERE cn_number = @FROM_CARTON\n                        AND cn_status BETWEEN @CN_STATUS_1 AND @CN_STATUS_2 \n\n                /*CREATE NEW CARTON HEADER*/                    \n                INSERT INTO CARTON\n                    (\n                        cn_number\n                    )\n                    VALUES\n                    (\n                        @FROM_CARTON\n                    )\n\n                /*CREATE CARTON DETAIL*/\n                INSERT INTO CARTON_DETAIL\n                    (\n                        cd_carton_number\n                    )\n                    VALUES\n                    (\n                        @TO_CARTON\n                    )                   \n\n            END\n\n        ELSE IF @SYS_CONFIG_VALUE = 0\n            BEGIN\n                /*REMOVE SKU FROM CURRENT CARTON*/\n                DELETE FROM CARTON_DETAIL \n                    WHERE cd_carton_number = @FROM_CARTON\n                        AND cd_barcode = @SKU\n\n                /*UPDATE THE CARTON HEADER*/\n                UPDATE CARTON\n                    SET cn_packed_qty = cn_packed_qty - @QTY\n                        , cn_modify_date = @DATE\n                        , cn_modify_time = @TIME\n                        , cn_modify_by = @USER\n                    WHERE cn_number = @FROM_CARTON\n                        AND cn_status BETWEEN @CN_STATUS_1 AND @CN_STATUS_2 \n\n                /*GET THE NEXT CARTON FROM COUNTERS*/\n                SELECT @TO_CARTON = counter_current FROM COUNTERS WHERE counter_name = (\n                SELECT DISTINCT so_counter_name FROM STORES WHERE SO_NUMBER = (\n                SELECT DISTINCT cn_store FROM CARTON WHERE cn_number = @FROM_CARTON))\n\n                /*UPDATE THE COUNTER AFTER GETTING THE NEXT CARTON NUMBER*/\n                UPDATE COUNTERS SET counter_current = counter_current + 1\n                                    , counter_next = counter_next + 1\n                    WHERE counter_name = (SELECT DISTINCT so_counter_name FROM STORES WHERE SO_NUMBER = (\n                                            SELECT DISTINCT cn_store FROM CARTON WHERE cn_number = @FROM_CARTON))\n\n                /*CREATE NEW CARTON HEADER*/\n                DECLARE \n                    @CN_NUMBER VARCHAR(20)              , @CN_PICKTICKET VARCHAR(20)        , @2ndCN_STORE VARCHAR(10)      , @CN_LOAD_NUMBER VARCHAR(20)\n                    , @CN_SHIPMENT_NUMBER VARCHAR(20)   , @CN_MANIFEST_NUMBER VARCHAR(20)   , @CN_PACKED_QTY DECIMAL        , @CN_TRACKING_NUMBER VARCHAR(20)\n                    , @CN_TYPE VARCHAR(5)               , @CN_PACK_TYPE VARCHAR(5)          , @CN_ROUTE VARCHAR(5)          , @CN_SHIP_VIA VARCHAR(5)\n                    , @CN_BOL VARCHAR(20)               , @CN_MBOL VARCHAR(20)              , @CN_PARCEL_NUMBER VARCHAR(10) , @CN_TRAILER_NUMBER VARCHAR(10)\n                    , @CN_AREA VARCHAR(10)              , @CN_ZONE VARCHAR(10)              , @CN_AISLE VARCHAR(10)         , @CN_LEVEL VARCHAR(10)\n                    , @CN_POSITION VARCHAR(10)          , @CN_HEIGHT DECIMAL                , @CN_WIDTH DECIMAL             , @CN_DIMENSION DECIMAL\n                    , @CN_WEIGHT DECIMAL                , @CN_VOLUME DECIMAL                , @2ndCN_STATUS INT             , @CN_ADDRESS VARCHAR(150)\n                    , @CN_ADDRESS_1 VARCHAR(150)        , @CN_CITY VARCHAR(50)              , @CN_STATE VARCHAR(50)         , @CN_ZIP_CODE VARCHAR(20)\n                    , @CN_COUNTRY VARCHAR(50)           , @CN_MISC7 VARCHAR(50)             , @CN_MISC8 VARCHAR(50)         , @CN_MISC9 VARCHAR(50)\n                    , @CN_MISC10 VARCHAR(50)                                    \n\n                SET @CN_NUMBER = @TO_CARTON         SET @2ndCN_STORE = @CN_STORE            SET @CN_LOAD_NUMBER = ''\n                SET @CN_SHIPMENT_NUMBER = ''        SET @CN_MANIFEST_NUMBER = ''            SET @CN_PACKED_QTY = ''\n                SET @CN_TRACKING_NUMBER = ''        SET @CN_TYPE = 'SPLIT'                  SET @CN_PACK_TYPE = 'SPLITTED'\n                SET @CN_ROUTE = ''                  SET @CN_SHIP_VIA = ''                   SET @CN_BOL = ''\n                SET @CN_MBOL = ''                   SET @CN_PARCEL_NUMBER = ''              SET @CN_TRAILER_NUMBER = ''\n                SET @CN_AREA = ''                   SET @CN_ZONE = ''                       SET @CN_AISLE = ''\n                SET @CN_LEVEL = ''                  SET @CN_POSITION = ''                   SET @CN_HEIGHT = ''\n                SET @CN_WIDTH = ''                  SET @CN_DIMENSION = ''                  SET @CN_WEIGHT = ''\n                SET @CN_VOLUME = ''                 SET @2ndCN_STATUS = '10'                SET @CN_MISC7 = ''\n                SET @CN_MISC8 = ''                  SET @CN_MISC9 = ''                      SET @CN_MISC10 = '' \n\n                /*GET STORE INFORMATION*/\n                SELECT @CN_ADDRESS = so_address\n                        , @CN_ADDRESS_1 = so_address_1\n                        , @CN_CITY = so_city\n                        , @CN_STATE = so_state\n                        , @CN_ZIP_CODE = so_zip_code\n                        , @CN_COUNTRY = so_country\n                    FROM STORES\n                    WHERE so_number = @CN_STORE\n\n                EXECUTE sp_CREATE_CARTON\n                    @CN_NUMBER              , @CN_PICKTICKET        , @CN_STORE             , @CN_LOAD_NUMBER       , @CN_SHIPMENT_NUMBER\n                    , @CN_MANIFEST_NUMBER   , @CN_PACKED_QTY        , @CN_TRACKING_NUMBER   , @CN_TYPE              , @CN_PACK_TYPE\n                    , @CN_ROUTE             , @CN_SHIP_VIA          , @CN_BOL               , @CN_MBOL              , @CN_PARCEL_NUMBER\n                    , @CN_TRAILER_NUMBER    , @CN_AREA              , @CN_ZONE              , @CN_AISLE             , @CN_LEVEL\n                    , @CN_POSITION          , @CN_HEIGHT            , @CN_WIDTH             , @CN_DIMENSION         , @CN_WEIGHT\n                    , @CN_VOLUME            , @CN_STATUS            , @CN_ADDRESS           , @CN_ADDRESS_1         , @CN_CITY\n                    , @CN_STATE             , @CN_ZIP_CODE          , @CN_COUNTRY           , @CN_MISC7         , @CN_MISC8\n                    , @CN_MISC9             , @CN_MISC10            , @USER\n\n\n\n                INSERT INTO CARTON\n                    (\n                        cn_number\n                    )\n                    VALUES\n                    (\n                        @TO_CARTON\n                    )\n\n                /*CREATE CARTON DETAIL*/\n                INSERT INTO CARTON_DETAIL\n                    (\n                        cd_carton_number\n                    )\n                    VALUES\n                    (\n                        @TO_CARTON\n                    )                   \n            END \n    END\n--ELSE\n--  BEGIN\n--      EXECUTE sp_CREATE_ERROR_MESSAGE\n--          @ER_TYPE\n--  END \n\nGO  \n</code></pre>\n"},{"tags":["sql-server-2008","tsql","encoding","replace"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":124,"score":0,"question_id":12455473,"title":"T-SQL Replace \"cyrillic symbols\" returns '????'","body":"<p>I have a function that converts CSV list to nvarchar(max) records in table. I have noticed it is not working with cyrillic and the problem is this replace here:</p>\n\n<pre><code>DECLARE @XML xml = N'&lt;r&gt;&lt;![CDATA[' + REPLACE(@List, ',', ']]&gt;&lt;/r&gt;&lt;r&gt;&lt;![CDATA[') + ']]&gt;&lt;/r&gt;'\n</code></pre>\n\n<p>How to make the replace to work with cyrillic symbols? For example ''.</p>\n\n<p>@List is NVARCHAR(MAX) and I am using SQL Server 2012.</p>\n"},{"tags":["sql-server","oracle","tsql","plsql"],"answer_count":3,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":9978,"score":7,"question_id":3523036,"title":"What is the Oracle equivalent of SQL Server's IsNull() function?","body":"<p>In SQL Server we can type <code>IsNull()</code> to determine if a field is null.  Is there an equivalent function in PL/SQL?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":67,"score":1,"question_id":12422248,"title":"Previous Monday & Previous Sundays date based on todays date","body":"<p>I need the correct syntax to give me :</p>\n\n<ol>\n<li>Previous weeks Mondays date based on the current date/time using <code>GETDATE()</code></li>\n<li>Previous weeks Sundays date based on the current date/time using <code>GETDATE()</code></li>\n</ol>\n\n<p>So, based on todays date (14/09/2012) I would want the following:</p>\n\n<ol>\n<li>Previous Mondays date = 03/09/2012</li>\n<li>Previous Sundays date = 09/09/2012</li>\n</ol>\n"},{"tags":["sql","tsql","select"],"answer_count":4,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":50,"score":5,"question_id":12455070,"title":"Behaviour of SELECT @Var and SET @Var in T-SQL when dealing with NULLs","body":"<p>Everyday I learn something new, it seems :) Can someone please explain to me the rationale behind the following code behavior:</p>\n\n<pre><code>DECLARE @A INT\n\nSET @A = 15\nSET @A = (SELECT ValueThatDoesntExist FROM dbo.MyTable WHERE MyColumn = 'notfound')\n\nSELECT @A\n-- Rsultset is NULL\n\nSET @A = 15\nSELECT @A = ValueThatDoesntExist FROM dbo.MyTable WHERE MyColumn = 'notfound'\n\nSELECT @A\n-- Resultset is 15\n</code></pre>\n\n<p>From what I see, SET changes the value of the variable if the resultset is NULL, while SELECT doesn't. Is this normal ANSI behavior or is it T-SQL specific?</p>\n\n<p>Of, course, if I do <code>SELECT @A = NULL</code>, the assignment happens correctly.</p>\n"},{"tags":["sql-server-2008","tsql","recursion","ssis","common-table-expression"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":104,"score":1,"question_id":12421386,"title":"Recursive Fill Calculations with CTE or anything efficient","body":"<p>Please help me with ideas (preferably CTE) to solve this as efficient as possible.</p>\n\n<p><img src=\"http://i.stack.imgur.com/KErdQ.jpg\" alt=\"enter image description here\"></p>\n\n<p>So... In the table shown, the cells in column \"Value\" which are red are the known values\nand the highlighted greens are values to be calculated with formulas shown next to them.\nI am trying to see if this is possible with CTEs at all.</p>\n\n<p>It's like the last known value and its respective interval; the next known value and the respective interval; and the interval for which the value is calculated for; all are used to find the value which then intern will be used the very same way for the next unknown value.</p>\n"},{"tags":["vb.net","linq","linq-to-sql","tsql","left-join"],"answer_count":5,"favorite_count":43,"up_vote_count":72,"down_vote_count":0,"view_count":51709,"score":72,"question_id":267488,"title":"Linq to Sql: Multiple left outer joins","body":"<p>I'm having some trouble figuring out how to use more than one left outer join using LINQ to SQL.  I understand how to use one left outer join.  I'm using VB.NET.  Below is my SQL syntax.</p>\n\n<p><strong>T-SQL</strong></p>\n\n<pre><code>SELECT\n    o.OrderNumber,\n    v.VendorName,\n    s.StatusName\nFROM\n    Orders o\nLEFT OUTER JOIN Vendors v ON\n    v.Id = o.VendorId\nLEFT OUTER JOIN Status s ON\n    s.Id = o.StatusId\nWHERE\n    o.OrderNumber &gt;= 100000 AND\n    o.OrderNumber &lt;= 200000\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":146,"score":2,"question_id":12430941,"title":"How to update all datetime records to UTC time in a SQL Server database?","body":"<p>I have a SQL Server database with ~1000 tables. Most of the tables have <code>datetime</code> columns with different name. Currently the value stored there is with offset because the code inserted it with the current date from the server. </p>\n\n<p><strong>The goal is to have all datetime records in UTC time.</strong> </p>\n\n<p>Now I want to do two things:</p>\n\n<ol>\n<li><p>Using some of these 3 functions (<code>SYSDATETIME, SYSDATETIMEOFFSET, SYSUTCDATETIME</code>) I can get the offset. Next step is to find all datetime records and update them. Can you help me with this?</p></li>\n<li><p>Some of the datetime columns have default value <code>GETTIME</code>. I want to update that with <code>SYSUTCDATETIME</code>. Any idea how?</p></li>\n</ol>\n\n<p>PS: I do not want to change the columns' type to <code>datetimeoffset</code> because the type is not supported in MSSQL Server 2005.</p>\n\n<p><strong>EDIT</strong>: Because there are so many comments about <code>datetime</code> and the topic of the question was shifted in different direction I suggest you not to think about <code>datetime</code> column type but for <code>int</code>. The problem is still the same. Updating many tables and changing the default value of columns.</p>\n\n<p>Best Regards\nmynkow</p>\n"},{"tags":["tsql","ntfs"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12448243,"title":"Do T-SQL MDF files have possibility to check its data integrity?","body":"<p>I have a huge mdf file on my SQL Server and doubt concerning its data integrity. I am performing manipulations with tables in this DB and noticed about many disk bad block reports in my Windows System Event Log (the File System is NTFS). I suspect that this errors may be connected to my operation with this DB. My questing is in the case some part of data in the mdf file is corrupted does SQL Server have possibility to detect this data integrity problem? Is there some error checking mechanism in the mdf: per-record or per-table crc, etc? In the case it is not performed automatically how could I test it manually?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-update"],"answer_count":5,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":2413,"score":2,"question_id":5500385,"title":"SQL Server: How to update table based on subquery in where clause?","body":"<p>I have a table (with data) like this:</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nSET ANSI_PADDING ON\nGO\nCREATE TABLE [dbo].[lTab](\n    [log_id] [int] IDENTITY(1,1) NOT NULL,\n    [JobName] [nvarchar](40) NULL,\n    [startTime] [datetime] NULL,\n    [endTime] [datetime] NULL,\n    [BatchId] [int] NULL,\n    [status] [varchar](10) NULL,\n    [messag] [varchar](255) NULL\n) ON [PRIMARY]\nGO\nSET ANSI_PADDING OFF\nGO\nSET IDENTITY_INSERT [dbo].[lTab] ON\nINSERT [dbo].[lTab] ([log_id], [JobName], [startTime], [endTime], [BatchId], [status], [messag]) VALUES (1, N'Job1', CAST(0x00009EB700FBF56F AS DateTime), NULL, 2, N'START', N'Test')\nINSERT [dbo].[lTab] ([log_id], [JobName], [startTime], [endTime], [BatchId], [status], [messag]) VALUES (2, N'Job2', NULL, CAST(0x00009EB700FBF975 AS DateTime), 2, N'START', N'Test')\nINSERT [dbo].[lTab] ([log_id], [JobName], [startTime], [endTime], [BatchId], [status], [messag]) VALUES (3, N'Job3', CAST(0x00009EB700FC287F AS DateTime), NULL, 2, N'START', N'Test')\nINSERT [dbo].[lTab] ([log_id], [JobName], [startTime], [endTime], [BatchId], [status], [messag]) VALUES (4, N'Job3', NULL, CAST(0x00009EB700FC2CC6 AS DateTime), 2, N'END', N'Test')\nSET IDENTITY_INSERT [dbo].[lTab] OFF\n</code></pre>\n\n<p>I'm trying to update endTime based on Jobname and max(log_id). </p>\n\n<pre><code>DECLARE @Jname VARCHAR(10)\nSET @Jname = 'Job3'\n\nUPDATE lTab\nSET endTime = GETDATE() \nWHERE log_id = (SELECT JobName, MAX(log_id) AS log_id FROM dbo.lTab WHERE jobname = @Jname GROUP BY JobName)\n</code></pre>\n\n<p>I get an error</p>\n\n<pre><code>sg 116, Level 16, State 1, Line 6\nOnly one expression can be specified in the select list when the subquery is not introduced with EXISTS.\n</code></pre>\n\n<p>How to get this work?</p>\n"},{"tags":["asp.net","sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":93,"score":0,"question_id":12431833,"title":"SQL Server connection-specific variables","body":"<p>I'm upgrading my application to use stored procedures rather than dynamic SQL as it is now. What I'd like to do is call some procedure, for example setUser(id), and then for that ID to be carried forward for the duration of the current connection. I have a UserVariables table which stores important data related to the current user (I'm not using the session to store this data as the session only lasts for so long; this way the users data is persisted across logins). I want to select data, such as the ID of the client they're currently viewing, without having to pass the user ID into each stored procedure. Call it laziness, if you like!</p>\n\n<p>I've searched for this quite a bit, and looked at various articles, but they're all about either global variables (which we can't change) or something unrelated.</p>\n\n<p>Basically what I want to do is set the user ID at the beginning of the page load (may even move this into the session_start method at some point) and then access this variable during all subsequent stored procedure calls or queries.</p>\n\n<p>Edit: What I'm after is like when you set a variable at the beginning of an asp page (my application is written in good ol' classic asp) and you then use it throughout the page and any includes. Think of the asp page representing the connection and the includes representing the stored procedures, if you like.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":5,"down_vote_count":2,"view_count":188,"score":3,"question_id":12435927,"title":"Select Columns Only if String length is greater than 2","body":"<p>Similar Question may be asked but I am unable to find anything that fits my needs.</p>\n\n<p>How can I select only columns where string length is greater than 2</p>\n\n<p>This is how much has done yet.</p>\n\n<pre><code>SELECT * FROM Table1\n\nWHERE (Table1.ID = @ID)\n</code></pre>\n\n<p>Or something like </p>\n\n<pre><code>WHERE (Table1.ID = @ID) AND (LEN(*) &gt; 2)\n</code></pre>\n\n<p>Thank for all of your help</p>\n\n<p>I have a Table, in which I have 35 columns and a User ID column, now I want to select and display information from only those columns which have > 2 string.</p>\n\n<p>I Like to Select only columns which have > 2 string and the defined ID by User not the Whole Row !!</p>\n\n<p>I hope I am making sense.</p>\n\n<p><strong>Table</strong>\n <img src=\"http://i.stack.imgur.com/G6Oiv.jpg\" alt=\"enter image description here\"></p>\n\n<p><strong>Desired Result</strong></p>\n\n<p><img src=\"http://i.stack.imgur.com/vJYSE.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["sql","sql-server","sql-server-2005","performance","tsql"],"answer_count":4,"favorite_count":4,"up_vote_count":11,"down_vote_count":0,"view_count":7194,"score":11,"question_id":1662902,"title":"When to use EXCEPT as opposed to NOT EXISTS in Transact SQL?","body":"<p>I just recently learned of the existence of the new \"EXCEPT\" clause in SQL Server (a bit late, I know...) thru reading code written by a coworker. It truly amazed me!</p>\n\n<p>But then I have some questions regarding its usage: when is it recommended to be employed? Is there a difference, performance-wise, between using it versus a correlated query employing \"AND NOT EXISTS...\"?</p>\n\n<p>After reading EXCEPT's article in the BOL I thought it was just a shorthand for the second option, but was surprised when I rewrote a couple queries using it (so they had the \"AND NOT EXISTS\" syntax much more familiar to me) and then checked the execution plans - surprise! The EXCEPT version had a shorter execution plan, and executed faster, also. Is this always so?</p>\n\n<p>So I'd like to know: what are the guidelines for using this powerful tool?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","case"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":81,"score":0,"question_id":12438769,"title":"Using CASE with DATE Type in WHERE clause","body":"<p>I want to use <code>CASE</code> with DATE Type in <code>WHERE</code> clause, so when <code>@birthFrom</code> or <code>@birthTo</code> is <code>NULL</code> return all record.</p>\n\n<pre><code>DECLARE @birthFrom DATE= NULL --'19941012'\nDECLARE @birthTo DATE= NULL --'20101012'\n\nSELECT  *\nFROM    dbo.bbmf\nWHERE   birth BETWEEN ( CASE @birthFrom\n                      WHEN NULL THEN birth\n                      ELSE @birthFrom\n                    END )\n          AND     ( CASE @birthTo\n                      WHEN NULL THEN birth\n                      ELSE @birthTo\n                    END )\n</code></pre>\n\n<p><strong>My problem is:</strong> when I execute the above code there is no record selected <br><br></p>\n\n<p>Any suggestion?</p>\n"},{"tags":["sql","tsql","view"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12430090,"title":"Conditional select on view","body":"<p>I have a view in my database (<code>MSSQL</code>) that takes more than 1 minute to output results. Since this is taking this long, I gave the user the ability to either see live data or cached data. I do this by generating the data from the view and inserting it into a table hourly and by defining a config variable on use_cached = 0 or 1.</p>\n\n<p>Lets say the view is called v_foo and the cache table is called t_bar. I want to create another view that selects from v_foo if <code>use_cached = 0</code> and select from t_bar if <code>use_cached = 1.</code></p>\n\n<p>I tried something like</p>\n\n<pre><code>Create view v_final as \nselect * from v_foo\nwhere (select count(*) from config where id = 'use_cache' and value = 1) = 0\nUNION ALL\nselect * from t_bar\nwhere (select count(*) from config where id = 'use_cache' and value = 1) = 1\n</code></pre>\n\n<p>But this causes both queries from the union all to be always calculated even if one of them does not return any rows.\nUsing a function is also a not so good solution because in order to return a table using IF conditions, I must declare a temporary table and just populating it is taking almost 17 seconds.</p>\n\n<p>Any Help?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":98,"score":4,"question_id":12436111,"title":"Using CASE with WHERE","body":"<p>I want to use CASE with WHERE, So if the countryId is -1 do not select any and if else select the value\nHere is my nonworking  code </p>\n\n<pre><code> DECLARE @countryId int=-1 --for example\n   SELECT * FROM dbo.bbmf WHERE status=1 \n AND countryId =\nCASE WHEN @countryId = -1 THEN \n --select any\nELSE\n countryId=@countryId\nEND\n</code></pre>\n\n<p>Thanks for your help</p>\n"},{"tags":["sql","sql-server","tsql","pivot","unpivot"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":114,"score":1,"question_id":12435193,"title":"T-sql pivot function","body":"<p>I need to convert the following table</p>\n\n<pre><code>quarter   cal_year  blue    green   yellow  red\n\nDEC 2011        +31%    25-30%  22-24%  -21%\n\nMAR 2012        +61%    50-60%  43-49%  -42%\n</code></pre>\n\n<p>into this. Is there a simple way to achieve it?</p>\n\n<pre><code>Color   DEC     MAR     \nblue    +31%    +61%    \ngreen   25-30%  50-60%  \nyellow  22-24%  43-49%  \nred     -21%    -42%    \n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":12436526,"title":"Email job scheduler query for generating daily report","body":"<blockquote>\n  <blockquote>\n    <p><strong>i have a job scheduler that is suppose to send a daily collection report to 20 different id's based on 20 different divisions. Each division will receive 1 report of that particular division only. This is the query i have come up with .</strong></p>\n  </blockquote>\n</blockquote>\n\n<pre><code>DECLARE @xml NVARCHAR(MAX)\nDECLARE @body NVARCHAR(MAX)\n\n\nSET @xml = CAST((select tm.name as 'td','',h.name as 'td','',h.account_number AS 'td','', \nSUM(bc.total_amount)  AS 'td'  \nFROM MJP.dbo.tbl_bank_collection bc,  \nMJP.dbo.tbl_div_type_master tm,  \nMJP.dbo.tbl_div_header h  \nwhere   bc.type_id = tm.id    \nand bc.header_id = h.id    \nand bc.transaction_date = '06-12-2012'   \nand bc.div_id in ( select d.id    \nfrom tbl_div d, tbl_bank_collection bc    \nwhere bc.div_id = d.id    \ngroup by d.id)    \ngroup by tm.name, h.name,h.account_number with rollup    \nhaving grouping(h.name) = 1 or    \nGROUPING(h.account_number) = 0     \nFOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))   \nSET @body ='&lt;html&gt;&lt;i&gt;Collection Report&lt;/i&gt;    \n&lt;body bgcolor=red&gt;&lt;table border = 1&gt;&lt;tr&gt;&lt;th&gt;Type Name    \n&lt;th&gt;Header Name&lt;/th&gt;&lt;th&gt;Account Number&lt;/th&gt;    \n&lt;th&gt;Total Amount&lt;/th&gt;&lt;/tr&gt;'     \nSET @body = @body + @xml +'&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;'   \nEXEC msdb.dbo.sp_send_dbmail    \n@profile_name='alkesh mail',    \n@body_format ='HTML',    \n@recipients='id.no1@yahoo.com;id.no2@yahoo.com',    \n@subject='Daily Report',    \n@body=@body    \n\n\n----------------------------------------------------------------------------------------\n</code></pre>\n\n<p>Now i want to split the report after a particular divison's final sum amount is calculated and the next report should be generated for the next division' id.</p>\n\n<p>Any suggestions or clarifications !!</p>\n"},{"tags":["sql-server","tsql","schema"],"answer_count":1,"favorite_count":5,"up_vote_count":37,"down_vote_count":0,"view_count":9043,"score":37,"question_id":1149159,"title":"How do I move a table into a schema in T-SQL","body":"<p>I want to move a table into a specific Schema using T-SQL? I am using SQL Server 2008.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":86,"score":-1,"question_id":12432515,"title":"T-SQL - changing datetime to date data type?","body":"<p>I have a column <code>BirthDate</code> in a table that is using the <code>datetime</code> data type. Currently, the values resemble the format <code>1987-12-30 00:00:00.000</code>.</p>\n\n<p>I would like to update all the rows of this table, changing them to the following format with the <code>date</code> data type: <code>1987-12-30</code></p>\n\n<p>I can run a SELECT...</p>\n\n<pre><code>SELECT CONVERT(date, BirthDate) FROM CUSTOMERLIST\n</code></pre>\n\n<p>But this is only affecting the display. I would like for it to update the entire column and also change the data type of that attribute as well. Any assistance would be greatly appreciated!</p>\n"},{"tags":["tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":147,"score":2,"question_id":12427142,"title":"MS SQL Server 2008/2012 Get Min Difference between any two values","body":"<p>Given a table with a single <code>money</code> column how do I calculate the smallest difference between any two values in that table using <code>TSQL</code>? I'm looking for the performance optimized solution, which will work with millions of rows.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":4,"view_count":111,"score":-2,"question_id":12429693,"title":"Group and count patient records based on date of last visit with a physician","body":"<p>Here's my data:</p>\n\n<pre><code>+----------+---------------+------------+---------------------+\n|  doctor  | received_date | patient_id | accession_daily_key |\n+----------+---------------+------------+---------------------+\n|  A       |  1/1/2011     |  ABC123    |                   1 |\n|  A       |  1/20/2011    |  AAA123    |                   2 |\n|  A       |  1/21/2011    |  AAA123    |                   3 |\n|          |               |            |                   4 |\n|  A       |  2/1/2011     |  ABC123    |                   5 |\n|  A       |  2/9/2011     |  BBBYYY    |                   6 |\n|          |               |            |                   7 |\n|  B       |  1/2/2011     |  ABC123    |                   8 |\n|  B       |  1/20/2011    |  AXA435    |                   9 |\n|  B       |  1/19/2011    |  AAA123    |                  10 |\n|          |               |            |                  11 |\n|  B       |  2/1/2011     |  ABC123    |                  12 |\n|  B       |  2/10/2011    |  BBBYYY    |                  13 |\n+----------+---------------+------------+---------------------+\n</code></pre>\n\n<p>Here's the result I want:</p>\n\n<pre><code>+--------+-------+--------------------+\n| doctor | month | count new patients |\n+--------+-------+--------------------+\n| A      |     1 |                  1 |\n| A      |     2 |                  1 |\n| B      |     1 |                  2 |\n| B      |     2 |                  0 |\n+--------+-------+--------------------+\n</code></pre>\n\n<p>I would like to count the new patients for a doctor every month. </p>\n\n<p>The business rules I've been given are:</p>\n\n<blockquote>\n  <ol>\n  <li>a patient can be associated with only one doctor</li>\n  <li>the doctor to which the patient is associated is the LAST doctor that saw him</li>\n  </ol>\n</blockquote>\n\n<p>Here's what I have so far:</p>\n\n<pre><code>select patient_id,max(month(RECEIVED_DATE)) AS Mnth, max(year(RECEIVED_DATE)) AS Yr, ACCESSION_DAILY_KEY\n    FROM [F_ACCESSION_DAILY] \n    where RECEIVED_MLIS_INFORMATION=1\n    GROUP BY patient_id,ACCESSION_DAILY_KEY\n</code></pre>\n\n<p>This query will give me the <code>primary key</code> <strong>accession_daily_key</strong> of the row which contains the doctor to which the patient is associated with. </p>\n\n<p>Can you please guide me on how I can get the number of patients every month that are NEW for each doctor in that specific month?</p>\n\n<hr>\n\n<p>Edit by jcolebrand:</p>\n\n<pre><code>CREATE TABLE F_ACCESSION_DAILY (\n    doctor VARCHAR(10) NOT NULL\n  , received_date DATETIME NOT NULL\n  , patient_id VARCHAR(10) NOT NULL\n  , accession_daily_key INT NOT NULL\n)\n\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('A','1/1/2011','ABC123','1')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('A','1/20/2011','AAA123','2')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('A','1/21/2011','AAA123','3')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('A','2/1/2011','ABC123','5')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('A','2/9/2011','BBBYYY','6')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('B','1/2/2011','ABC123','8')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('B','1/20/2011','AXA435','9')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('B','1/19/2011','AAA123','10')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('B','2/1/2011','ABC123','12')\nINSERT INTO F_ACCESSION_DAILY (doctor,received_date,patient_id,accession_daily_key) VALUES ('B','2/10/2011','BBBYYY','13')\n</code></pre>\n"}]}
{"total":16599,"page":15,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12429382,"title":"How to display the manager id,name subordinate id & name after manager record","body":"<p>How do I show manager id,manager name and subordinate detail under each manager record.</p>\n\n<pre><code>EMPNO  ENAME   JOB        MGR   HIREDATE   SAL   COMM  DEPTNO \n-----  ------  ---------  ----  ---------  ----  ----  ------\n7839   KING    PRESIDENT  -     17-NOV-81  5000  -     10 \n7698   BLAKE   MANAGER    7839  01-MAY-81  2850  -     30 \n7782   CLARK   MANAGER    7839  09-JUN-81  2450  -     10 \n7566   JONES   MANAGER    7839  02-APR-81  2975  -     20 \n7654   MARTIN  SALESMAN   7698  28-SEP-81  1250  1400  30 \n</code></pre>\n"},{"tags":["sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":356,"score":0,"question_id":6741926,"title":"Applying sp_msforeachtable for selected tables","body":"<p>I have a problem in updating some column values in a table. In my database there are many tables and out of which I have to update those tables which is having a column by the name \"Col1\".</p>\n\n<p>If I do</p>\n\n<pre><code>exec sp_msforeachtable 'UPDATE ? SET Col1=\n\ncase when Col1 = \"ppp\" then \"qqq\"\n     when Col1 = \"aaa\" then  \"xxx\" \nend\n' \n</code></pre>\n\n<p>It will report  an error message as</p>\n\n<p><strong>Msg 207, Level 16, State 1, Line 1\nInvalid column name 'col1'.</strong></p>\n\n<p>What to do?</p>\n"},{"tags":["sql-server","regex","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":86,"score":1,"question_id":12407529,"title":"Check if first characters of a string are alphabetical T-SQL","body":"<p>Is it possible, just using TSQL, to check if the first two characters of a varchar field are alphabetical.</p>\n\n<p>I need to select from <code>my_table</code> only the rows that have <code>my_field</code> beginning with two alphabetical chars. How can I achieve this?</p>\n\n<p>Is it possible to use regex?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12425112,"title":"Set timeout length of my query","body":"<p>How can I set the timeout length in my query ?</p>\n\n<p>I'm generate script from my database, but it fails because of timeout length.</p>\n\n<p>I tryied set on the Connect to Server window, pressing the Options button and there is an option for Execution time-out. That is 0.</p>\n\n<p>How can I solve this ?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":49,"score":2,"question_id":12425803,"title":"sql where against two columns","body":"<p>I have created a SP to return some customer data for one company. I am passing company id and the customer id in to the SP. There are two types of customer ids in the table I am querying. The two types are saved in different columns. </p>\n\n<p>For an example say I have the following columns in my table. </p>\n\n<p>ID,Comments,CustomerTypeAId,CustomerTypeBId</p>\n\n<p>Either of the customer IDs can be null in one row. The customer Id I am passing in to the SP could be a Type A customer or Type B customer. So in my WHERE clause I need to specify if the CustomerTypeAId is null then query the CustomerTypeBId. </p>\n\n<pre><code>@CusId int=0\nSELECT * FROM TEST\nWHERE (How to put this part?)\n</code></pre>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":7115,"score":3,"question_id":1175244,"title":"SQL Server error on update command - \"A severe error occurred on the current command\"","body":"<p>Running the following query in SQL Server Management Studio gives the error below.</p>\n\n<pre><code>update table_name set is_active = 0 where id  = 3\n</code></pre>\n\n<blockquote>\n  <p>A severe error occurred on the current command.  The results, if any, should be discarded.</p>\n</blockquote>\n\n<ul>\n<li>The logs have been truncated</li>\n<li>there is an update trigger but this isnt the issue</li>\n<li>the transaction count is zero  (@@trancount)</li>\n</ul>\n\n<p>I have tried the same update statement on a couple of other tables in the database and they  work fine.</p>\n\n<pre><code>DBCC CHECKTABLE('table_name');\n</code></pre>\n\n<p>gives</p>\n\n<pre><code>DBCC results for 'table_name'.\nThere are 13 rows in 1 pages for object \"table_name\".\nDBCC execution completed. If DBCC printed error messages, contact your system administrator.\n</code></pre>\n"},{"tags":["visual-studio","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12426480,"title":"T-SQL Error while DECLARING variables","body":"<pre><code>Declare @ID nvarchar(14) = '12345678912345'  \nDECLARE @Key int = (SELECT  key\n                           FROM    table\n                           WHERE   id = @ID) \n\nDeclare @indicator varchar(1) = 'A' \n\nDeclare @rdate Datetime = (SELECT LTRIM(RTRIM(Left(CAST(GetDate() AS Datetime2),23))))\n\n\nSELECT @ID \nGO\nSELECT @Key \nGO\nSELECT @indicator \nGO\nSELECT @date \nGO\n</code></pre>\n\n<p>I get error when I execute the above code. I see @ID print and it goes away and I get the following messages.</p>\n\n<p>\"Must declare the scalar variable \"@Key\"</p>\n\n<p>\"Must declare the scalar variable \"@indicator\"</p>\n\n<p>\"Must declare the scalar variable \"@date\"</p>\n\n<p>Datatypes in the table: ID = nvarchar(14), key = int, indicator = varchar(1), and date = timestamp</p>\n"},{"tags":["sql","tsql","where-clause","case-when"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":80,"score":4,"question_id":12424551,"title":"\"IN\" condition at CASE WHEN on WHERE CLAUSE?","body":"<p>I have an complex situation. I want to write an sql query including \"case when\" condition on \"where clause\".</p>\n\n<p>Just like that:</p>\n\n<pre><code>SELECT *\nFROM &lt;table&gt;\nWHERE\n&lt;Column1&gt; in\n   CASE &lt;Column2&gt;\n      WHEN 1 THEN ('OP', 'CL') \n      WHEN 0 THEN ('RE', 'ST')\nEND\n</code></pre>\n\n<p>Column1 must be \"in\", not \"=\". Because there is multiple value at condition for Column1.  That query returns \"Incorrect syntax near ','.\" error.</p>\n\n<p>Can you give me any suggestion? (Sorry for my bad English.)</p>\n\n<p>EDIT : I think I misunderstood. If Column2 is 1, condition must like that \"IN ('OP', 'CL')\" else Column1 is 2, condition must like that \"IN ('RE', 'ST')\".</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":527,"score":0,"question_id":8575159,"title":"Inserting large amount of data into SQL Server 2005 table","body":"<p>I am inserting around 2 million records into a SQL Server 2005 table. The table currently have clustered as well as non-clustered indexes. I want to improve the performance of the insert query in that table . Can anyone have idea about </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":105,"score":3,"question_id":12405026,"title":"\"Cluster\" Code Help in SQL","body":"<p>I am relative newcomer to SQL, but have gained many useful ideas through the site.  Now I'm stuck on a piece of code that seems simple enough, but for some reason I can't wrap my head around it.</p>\n\n<p>I am trying to create a third column (Column Z) based off of the first two columns below:</p>\n\n<pre><code>Column X   Column Y\n-------------------\n 1          a\n 1          b\n 1          c\n 2          a\n 2          d\n 2          e\n 2          f\n 4          b\n 5          i\n 5          c\n 3          g\n 3          h\n 6          j\n 6          k\n 6          l\n</code></pre>\n\n<p>What i need to have happen in Column Z:</p>\n\n<blockquote>\n  <ul>\n  <li>For each individual value found in Column Y, note the value of Column X</li>\n  <li>Likewise, for each individual value in Column X, note the value of Column Y</li>\n  <li>Then, cluster (RANK/ROW_NUMBER?) these into groups seen below:</li>\n  </ul>\n</blockquote>\n\n<pre><code>Column X   Column Y  Column Z\n-----------------------------\n 1          a         1\n 1          b         1\n 1          c         1\n 2          a         1\n 2          d         1\n 2          e         1\n 2          f         1\n 4          b         1\n 5          i         1\n 5          c         1\n 3          g         2\n 3          h         2\n 6          j         3\n 6          k         3\n 6          l         3\n</code></pre>\n\n<p>I hope I've been clear enough without over-complicating things.  My head has been spinning all morning.  Let me know if anyone needs any more info.</p>\n\n<p>Greatly appreciated in advance!</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12418743,"title":"tsql breadcrumb query","body":"<p><img src=\"http://i.stack.imgur.com/C7Tlq.jpg\" alt=\"enter image description here\">I have the following CTE Query</p>\n\n<pre><code>;WITH cte AS (\n    SELECT 0 AS lvl, id, catName, parent,\n        CAST(id AS VARCHAR(128)) AS Sort\n    FROM CategoriesMap WHERE id =2\n    UNION ALL\n    SELECT p.lvl + 1, c.id, c.catName, c.parent,\n        CAST(CAST(c.id AS VARCHAR) + '_' + p.Sort   AS VARCHAR(128))\n    FROM CategoriesMap c\n    INNER JOIN cte p ON p.parent = c.id\n)\nselect * from cte\n</code></pre>\n\n<p>The Sort(Tree) Column has output like this (for two rows)...</p>\n\n<pre><code>2\n1_2\n</code></pre>\n\n<p>Where, <code>2</code> is a Category TVs and <code>1_2</code> means this is tree map <code>(1: Internet Tv, 2 = Jadoo Tv)</code></p>\n\n<p>Now can I return the Category Name with the Category Code as well? </p>\n\n<p>something like</p>\n\n<pre><code>2:Jadoo Tc\n\n1_Internet Tv: 2_Jadoo Tv\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","pivot"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":209,"score":2,"question_id":12422901,"title":"Crosstab Query with Dynamic Columns in SQL Server 2005 up","body":"<p><br /><br />\nI'm having a problem with Crosstab query in SQL Server. </p>\n\n<p>Suppose that I have data as below: </p>\n\n<pre><code>| ScoreID | StudentID |      Name |    Sex | SubjectName | Score |\n------------------------------------------------------------------\n|       1 |         1 | Student A |   Male |           C |   100 |\n|       2 |         1 | Student A |   Male |         C++ |    40 |\n|       3 |         1 | Student A |   Male |     English |    60 |\n|       4 |         1 | Student A |   Male |    Database |    15 |\n|       5 |         1 | Student A |   Male |        Math |    50 |\n|       6 |         2 | Student B |   Male |           C |    77 |\n|       7 |         2 | Student B |   Male |         C++ |    12 |\n|       8 |         2 | Student B |   Male |     English |    56 |\n|       9 |         2 | Student B |   Male |    Database |    34 |\n|      10 |         2 | Student B |   Male |        Math |    76 |\n|      11 |         3 | Student C | Female |           C |    24 |\n|      12 |         3 | Student C | Female |         C++ |    10 |\n|      13 |         3 | Student C | Female |     English |    15 |\n|      14 |         3 | Student C | Female |    Database |    40 |\n|      15 |         3 | Student C | Female |        Math |    21 |\n|      16 |         4 | Student D | Female |           C |    17 |\n|      17 |         4 | Student D | Female |         C++ |    34 |\n|      18 |         4 | Student D | Female |     English |    24 |\n|      19 |         4 | Student D | Female |    Database |    56 |\n|      20 |         4 | Student D | Female |        Math |    43 |\n</code></pre>\n\n<p>I want to make query which show the result  as below: </p>\n\n<pre><code>| StuID| Name      | Sex    | C  | C++ | Eng | DB | Math | Total | Average |\n|  1   | Student A | Male   | 100|  40 | 60  | 15 |  50  |  265  |   54    |\n|  2   | Student B | Male   | 77 |  12 | 56  | 34 |  76  |  255  |   51    |\n|  3   | Student C | Female | 24 |  10 | 15  | 40 |  21  |  110  |   22    |\n|  4   | Student D | Female | 17 |  34 | 24  | 56 |  43  |  174  |   34.8  |\n</code></pre>\n\n<p>How could I query to show output like this? <br /><br />\n<strong>Note:</strong> </p>\n\n<p>Subject Name:</p>\n\n<ul>\n<li>C</li>\n<li>C++</li>\n<li>English</li>\n<li>Database</li>\n<li><p>Math</p>\n\n<p>will be changed depend on which subject student learn.</p></li>\n</ul>\n\n<p>Please go to <a href=\"http://sqlfiddle.com/#!6/2ba07/1\" rel=\"nofollow\">http://sqlfiddle.com/#!6/2ba07/1</a> to test this query.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12422000,"title":"T-sql Adding same amount to range of chars","body":"<p>I have a SQL SERVER database with a primary key (<code>compid</code>) which is a char but looks like a numbered ID . we have 20,000 computers in our DB each having it's own 8 digit code (<code>compid</code>)</p>\n\n<p>eg. my computer is <code>28154326</code>. This is in a char field.</p>\n\n<p>I have numbered 50 computers incorrectly and instead of <code>28184000 - 28184050</code> I have put <code>28154000 - 28154050</code>.</p>\n\n<p>Is there any way I can change this range of computers to have the correct compid without going through each one by one?</p>\n\n<p>These are in the <code>compconfig</code> table so to extract them it would be </p>\n\n<pre><code>select * from compconfig (nolock)\n</code></pre>\n"},{"tags":["c#",".net","sql","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":5,"down_vote_count":4,"view_count":174,"score":1,"question_id":11206641,"title":"Stored Procedure in C#","body":"<p>I want to use a stored procedure in c#. I create the stored procedure in sql server and I call it in the program. But when I use the breakpoint feature, I come to know that the data is not retrieved from the db as the breakpoint skips over the loop..</p>\n\n<p>.aspx code:</p>\n\n<pre><code>&lt;asp:Button ID=\"Button1\" runat=\"server\" Text=\"Button\" OnClick=\"store\" /&gt;\n&lt;asp:Label ID=\"Label9\" runat=\"server\" Text=\"Label\"&gt;&lt;/asp:Label&gt;\n</code></pre>\n\n<p>c# code:</p>\n\n<pre><code>public void store(object sender, EventArgs ser)\n{\n    try\n    {\n        // c reate and open a connection object\n        SqlConnection conn = Class3.GetConnection();\n\n        // 1. create a command object identifying the stored procedure\n        SqlCommand cmd = new SqlCommand(\"storeprocedure3\", conn);\n\n        // 2. set the command object so it knows to execute a stored procedure\n        cmd.CommandType = CommandType.StoredProcedure;\n\n        // 3. add parameter to command, which will be execute the command\n        SqlDataReader rdr = cmd.ExecuteReader();\n\n        // iterate through results, printing each to console\n        while (rdr.Read())\n        {\n            Label9.Text = rdr[\"menuename\"].ToString();\n        }\n    }\n    catch (Exception sa)\n    {\n        Console.WriteLine(sa);\n    }\n}\n</code></pre>\n\n<p>stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE procedure3     \nAS\nBEGIN\n    select menuename from menue;\n\nEND\nGO\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":4,"down_vote_count":1,"view_count":119,"score":3,"question_id":12389669,"title":"What are the dangers of BEGIN TRY DROP TABLE?","body":"<p>In a script used for interactive analysis of subsets of data, it is often useful to store the results of queries into temporary tables for further analysis.</p>\n\n<p>Many of my analysis scripts contain this structure:</p>\n\n<pre><code>CREATE TABLE #Results (\n  a INT NOT NULL,\n  b INT NOT NULL,\n  c INT NOT NULL\n);\n\nINSERT INTO #Results (a, b, c)\nSELECT a, b, c\nFROM ...\n\nSELECT *\nFROM #Results;\n</code></pre>\n\n<p>In SQL Server, temporary tables are connection-scoped, so the query results persist after the initial query execution. When the subset of data I want to analyze is expensive to calculate, I use this method instead of using a table variable because the subset persists across different batches of queries.</p>\n\n<p>The setup part of the script is run once, and following queries (<code>SELECT * FROM #Results</code> is a placeholder here) are run as often as necessary.</p>\n\n<p>Occasionally, I want to refresh the subset of data in the temporary table, so I run the entire script again. One way to do this would be to create a new connection by copying the script to a new query window in Management Studio, I find this difficult to manage.</p>\n\n<p>Instead, my usual workaround is to precede the create statement with a conditional drop statement like this:</p>\n\n<pre><code>IF OBJECT_ID(N'tempdb.dbo.#Results', 'U') IS NOT NULL\nBEGIN\n  DROP TABLE #Results;\nEND;\n</code></pre>\n\n<p>This statement correctly handles two situations:</p>\n\n<ol>\n<li>On the first run when the table does not exist: do nothing.</li>\n<li>On subsequent runs when the table does exist: drop the table.</li>\n</ol>\n\n<p>Production scripts written by me would always use this method because it raises no errors for in the two expected situations.</p>\n\n<p>Some equivalent scripts written by my fellow developers sometimes handle these two situations using exception handling:</p>\n\n<pre><code>BEGIN TRY DROP TABLE #Results END TRY BEGIN CATCH END CATCH\n</code></pre>\n\n<p>I believe in the database world it is better always to ask permission than seek forgiveness, so this method makes me uneasy.</p>\n\n<p>The second method swallows an error while taking no action to handle non-exceptional behavior (table does not exist). Also, it is possible that an error would be raised for a reason other than that the table does not exist.</p>\n\n<p>The <a href=\"http://www.wiseowl.co.uk/blog/s183/drop-temporary-tables.htm\" rel=\"nofollow\">Wise Owl</a> warns about the same thing:</p>\n\n<blockquote>\n  <p>Of the two methods, the [<code>OBJECT_ID</code> method] is more difficult to understand but\n  probably better: with the [<code>BEGIN TRY</code> method], you run the risk of trapping\n  the wrong error!</p>\n</blockquote>\n\n<p>But it does not explain what the practical risks are.</p>\n\n<p>In practice, the <code>BEGIN TRY</code> method has never caused problems in systems I maintain, so I'm happy for it to stay there.</p>\n\n<p>What possible dangers are there in managing temporary table existence using <code>BEGIN TRY</code> method? What unexpected errors are likely to be concealed by the empty catch block?</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","sql-server-2008"],"answer_count":4,"favorite_count":3,"up_vote_count":4,"down_vote_count":0,"view_count":3437,"score":4,"question_id":5599874,"title":"How can I check for duplicates before inserting into a table when inserting by select","body":"<p>How can I check for duplicates before inserting into a table when inserting by select:</p>\n\n<pre><code>insert into table1\nselect col1, col2 \nfrom table2\n</code></pre>\n\n<p>I need to check if table1 already has a row with table1.col1.value = table2.col1.value, and if yes, then exclude that row from the insert.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12421761,"title":"Assigning Value along with Data Retrieval","body":"<p>Is there a way to combine assigning a value to a variable and Selecting a column in sql. I need to compute and select a column in a table based on the variable. The variable's value changes based on another column in the table.</p>\n\n<p>var @BeginValue\nColumns in table :  ReducedBy</p>\n\n<p>My initial begin value is stored in @BeginValue. The table has reducedBy which is a factor by which my begin value should be reduced. So when i select, beginvalue for the first recored would be @BeginValue and the @EndValue should be @BeginValue = @BeginValue - reducedBy. It continues like this, as many times as the number of records in my table.</p>\n\n<p>Result set must be like this:\n@Begin = 10</p>\n\n<pre><code>Begin End ReducedBy \n10     8    2\n 8     6    2\n 6     5    1\n</code></pre>\n\n<p>Is there a way with which i can achieve this without using a cursor or with multiple update statements.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":56,"score":3,"question_id":12421113,"title":"How to pass different values of a certain column to an aggregate function conditionally?","body":"<p>Well the title of this question might not actually reflect what I want, I couldn't think of anything better. Maybe I should've appended a <em>'and then join two tables acquired this way'</em> to the end.</p>\n\n<p>Let's say I have this table. The scenario is, we pay loans with id <code>loan_id</code>, and we store payments of that in the table \"Payment\", each payment has its own <code>id</code>. When customer pays the payment, we change <code>paid</code> to <code>1</code>.</p>\n\n<pre><code>+---------+----+--------+------+\n| loan_id | id | amount | paid |\n+---------+----+--------+------+\n|       1 |  1 |   1000 |    1 |\n|       1 |  2 |   1000 |    1 |\n|       1 |  3 |   1000 |    0 |\n|       2 |  4 |  10000 |    0 |\n|       3 |  5 |  20000 |    1 |\n+---------+----+--------+------+\n</code></pre>\n\n<p>And now we need a report on loans. The output should look like this:</p>\n\n<pre><code>+---------+-------+-----------+\n| loan_id |  paid | remaining |\n+---------+-------+-----------+\n|       1 |  2000 |      1000 |\n|       2 |     0 |     10000 |\n|       3 | 20000 |         0 |\n+---------+-------+-----------+\n</code></pre>\n\n<p>The <code>paid</code> column is basically sum of all <code>amount</code> fields where pay = 1. And the <code>remaining</code> is sum of the <code>amount</code> rows for which pay = 0. They should be grouped by <code>loan_id</code>.</p>\n\n<h2>What I tried:</h2>\n\n<p>I tried different joins, products, etc but the best thing I could get out of my queries was this one:</p>\n\n<pre><code>SELECT loan_id, SUM(paid), SUM(remaining)\nFROM (\n    SELECT loan_id, 0 AS paid, SUM(amount) AS remaining\n    FROM Payment\n    WHERE paid = 0\n    GROUP BY loan_id\n\n    UNION\n\n    SELECT loan_id, SUM(amount) AS paid, 0 AS remaining\n    FROM Payment\n    WHERE paid = 1\n    GROUP BY loan_id\n)\nGROUP BY loan_id\n</code></pre>\n\n<p>But I guess there should be better ways than mine.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":90,"score":0,"question_id":12415590,"title":"Update the first row in sql server table if a condition is met","body":"<p>I have a table with the following rows.</p>\n\n<p><strong>tblPictures</strong></p>\n\n<ul>\n<li>picID </li>\n<li>picName</li>\n<li>galleryID</li>\n<li>isActive</li>\n</ul>\n\n<p>I want to run a query to select for example all the pictures with <code>galleryID=3</code> and <code>isActive=1</code></p>\n\n<p>If there are no pictures in this select with the isActive row being 1 (in other words, query returns no results) I want to make the first picture's <code>isActive=1</code> with the <code>galleryID=3</code></p>\n\n<p>Can anyone guide me on this?</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":12417894,"title":"Using criteria in T-SQL","body":"<p>Ok I searched through many different places unfortunately it might be easier to ask,</p>\n\n<p>I have to select some data then set salary to increase by 10 percent where my criteria is on another table this is my code</p>\n\n<pre><code> Select E.Lastname, E.Salary, J.EEO1Classification from Employee as E\n Join JobTitle as J\n on E.JobTitleID = J.JobTitleID \n Update Employee\n set Salary = (Salary * .10) + Salary\n where [JobTitle.EEO1Classification] = 'Office/Clerical'\n</code></pre>\n\n<p>Where am I going wrong?</p>\n"},{"tags":["tsql","ssis","odbc","oledb","ibm-midrange"],"answer_count":6,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":1071,"score":2,"question_id":6345212,"title":"Creating a connection from Microsoft SQL server to an AS/400","body":"<p>I'm trying to connect from Microsoft SQL server to as AS/400 so i can pull data from the AS/400 then flag the data as being pulled.</p>\n\n<p>I've successfully created and OLE DB \"IBMDASQL\" connection, and am able to pull data some data, but i'm running into an issue when i try to pull data from a very large table</p>\n\n<p>This runs fine, and returns a count of 170 million:</p>\n\n<pre><code>select count(*)\nfrom transactions\n</code></pre>\n\n<p>This query executed for 15 hours before i gave up on it.  (It should return zero since i haven't flagged anything as 'in process' yet)</p>\n\n<pre><code>select count(*) \nfrom transactions\nwhere processed = 'In process'\n</code></pre>\n\n<p>I'm a Microsoft guy, but my AS/400 guy says that there is an index on the 'processed' column and that locally, that query run instantaneously.</p>\n\n<p>Any thoughts on what i might be doing wrong?  I found a table with only 68 records in it, and was able to run this query in about a second:</p>\n\n<pre><code>select count(*)\nfrom smallTable\nwhere RandomColumn = 'randomValue'\n</code></pre>\n\n<p>So I know that the AS/400 is at least able to understand that type of query.</p>\n"},{"tags":["sql","tsql","sql-server-2005","linked-server"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":55,"score":3,"question_id":12418044,"title":"How to run T-SQL in another DB server?","body":"<p>I want to select some data form another database in another server.</p>\n\n<p>What I know is add a Linked Server, and run the T-SQL.</p>\n\n<p>Is this way is a good choice, or is there any other way to run SQL in other database servers?</p>\n\n<p>thanks.</p>\n"},{"tags":["sql","database","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":83,"score":1,"question_id":12415322,"title":"SQL Change format of datetime to specific style","body":"<p>I'm trying to convert a datetime value to a specific format, but noe of the style codes seem to do what I want.  I tried the SQLUSA post on style codes, but none of them are quite right.</p>\n\n<p>I have a column where the date/time is stored as <strong>yyyy-mm-dd hh:nn:ss (24 hour time)</strong></p>\n\n<p>I have a select statement were I want to take this column, but express the date as: <strong>mm/dd/yyyy hh:nn:ss AM/PM</strong></p>\n\n<p>The closest I've come is:</p>\n\n<pre><code>CONVERT(varchar,[datetimecolum],22) AS [newcolumnname]\n</code></pre>\n\n<p>but that only gives me a 2 digit year, not a century year (yyyy).</p>\n\n<p>Any ideas? I'm totally lost. :(</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":72,"score":1,"question_id":12415715,"title":"TSQL => Take the time from the datetime and convert it into seconds?","body":"<p>I am running SQL Server 2005.  Technically I know how to take the time from a tsql datetime.</p>\n\n<pre><code>CONVERT(VARCHAR(8),GETDATE(),108) AS HourMinuteSecond\n</code></pre>\n\n<p>The problem is that I have a datetime field and I need to essentially grab the time portion convert that to an integer specifically seconds.  Then I need to do a bunch of arithmetic on this integer that I won't discuss here.  I have searched on stackoverflow and haven't found a question that is specific to this question.  Any ideas?  I am really looking for best practices here, I am worried about creating a udf for this specific purpose as it completely throws the query optimizer out the window.</p>\n\n<p>I have seen this webpage so please don't paste this. :</p>\n\n<p><a href=\"http://forums.devx.com/showthread.php?171561-TSQL-Converting-HH-MM-SS-to-seconds\" rel=\"nofollow\">http://forums.devx.com/showthread.php?171561-TSQL-Converting-HH-MM-SS-to-seconds</a></p>\n"},{"tags":["sql","xml","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":12416958,"title":"how to prepend xml namespace in element during query?","body":"<p>With the following</p>\n\n<pre><code>DECLARE @t TABLE (Test nvarchar(50), Location_ID uniqueidentifier);\nINSERT INTO @t (Test,Location_ID ) \nSELECT Test,Location_ID \nfrom\ndbo.TEST;\nDECLARE @xml XML\n;WITH XMLNAMESPACES (\n'typens:GPCodedValueDomain2' as type,\n'http://www.esri.com/schemas/ArcGIS/10.0' as typens, \n'http://www.w3.org/TR/html4/' AS xs, \n'http://www.w3.org/2001/XMLSchema-instance' AS xsi )\nSELECT @xml = \n    (\n    SELECT \n    'typens:CodedValue' AS \"@xsi:type\", \n    TEST AS \"Name\", Location_ID  AS \"Code\"\n    FROM @t \n    order by Location_ID\n    FOR XML PATH\n    ('CodedValue'), ROOT\n    ('GPCodedValueDomain2'),TYPE\n    )\nSELECT @xml\n</code></pre>\n\n<p>it outputs </p>\n\n<pre><code>&lt;GPCodedValueDomain2 xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xs=\"http://www.w3.org/TR/html4/\" xmlns:typens=\"http://www.esri.com/schemas/ArcGIS/10.0\" xmlns:type=\"typens:GPCodedValueDomain2\"&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code&gt;B59D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code&gt;B69D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code&gt;B79D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n&lt;/GPCodedValueDomain2&gt;\n</code></pre>\n\n<p>I've been trying different iterations of namespace definition for hours, all fail. I'm looking for the output to be:</p>\n\n<pre><code>&lt;GPCodedValueDomain2 xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xs=\"http://www.w3.org/TR/html4/\" xmlns:typens=\"http://www.esri.com/schemas/ArcGIS/10.0\" xmlns:type=\"typens:GPCodedValueDomain2\"&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code xsi:type=\"xs:string\"&gt;B59D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code xsi:type=\"xs:string\"&gt;B69D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n  &lt;CodedValue xsi:type=\"typens:CodedValue\"&gt;\n    &lt;Name&gt;test update&lt;/Name&gt;\n    &lt;Code xsi:type=\"xs:string\"&gt;B79D3BEB-CBCE-E111-B5B0-002564D275D1&lt;/Code&gt;\n  &lt;/CodedValue&gt;\n&lt;/GPCodedValueDomain2&gt;\n</code></pre>\n\n<p>Any thoughts on how to implement this? Thanks</p>\n"},{"tags":["sql-server-2008","tsql","search"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12415832,"title":"SQL Query to return results if user entered \"ABCD-EFGH\" instead of \"ABCDEFGH\"","body":"<p>I am using SQL Server 2008 and need to write a query that should return a record of <code>ABCDEFGH</code> if a user enters a search string such as <code>ABCD-EFGH</code> or <code>ABDEFGH</code> etc (i.e. records that are similar to).  </p>\n\n<p>How would I accomplish that?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":66,"score":3,"question_id":12415608,"title":"getting new data per month","body":"<p>my data looks like this:</p>\n\n<pre><code>+--------+-----------+---------+\n| doctor | datefield | patient |\n+--------+-----------+---------+\n| A      | 1/1/2011  | ABC123  |\n| A      | 1/20/2011 | AAA123  |\n| A      | 1/21/2011 | AAA123  |\n|        |           |         |\n| A      | 2/1/2011  | ABC123  |\n| A      | 2/10/2011 | BBBYYY  |\n|        |           |         |\n| B      | 1/1/2011  | ABC123  |\n| B      | 1/20/2011 | AXA435  |\n| B      | 1/21/2011 | AAA123  |\n|        |           |         |\n| B      | 2/1/2011  | ABC123  |\n| B      | 2/10/2011 | BBBYYY  |\n+--------+-----------+---------+\n</code></pre>\n\n<p>I want to calculate the new patients per doctor <code>as compared to the entire date range for that specific doctor</code>. </p>\n\n<p>let's assume <strong>january 2011</strong> was the first month. </p>\n\n<p><strong>logic:</strong></p>\n\n<blockquote>\n  <ol>\n  <li>doctor A had 2 new patients for january 2011</li>\n  <li>doctor A had 1 new patient for feb 2011</li>\n  <li>doctor B had 3 new patients for January 2011</li>\n  <li>doctor B had 1 new patient for feb 2011</li>\n  </ol>\n</blockquote>\n\n<p>here's the result that i would like:</p>\n\n<pre><code>+--------+-------+------+----------------+\n| doctor | month | year | # new patients |\n+--------+-------+------+----------------+\n| A      |     1 | 2011 |              2 |\n| A      |     2 | 2011 |              1 |\n| B      |     1 | 2011 |              3 |\n| B      |     2 | 2011 |              1 |\n+--------+-------+------+----------------+\n</code></pre>\n\n<p>can you please help me to get started?</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12414918,"title":"Top 1 Row with Count","body":"<p>I have a Query with the following output</p>\n\n<pre><code>SELECT  BIN_NAME,ROW_NUMBER() Over(Order by BIN_NAME) C\nFROM USR_BINS_ITEMS I \nLEFT JOIN USR_BINS B ON I.BIN_COD=B.BIN_COD \nWHERE I.LOC_ID='6' \nAnd I.ITEM_NO = '364001' \n</code></pre>\n\n<p>And the  output is....</p>\n\n<pre><code>Bin     c\n--------------\nE1-03   1    \nE1-08   2    \nE2-01   3\n</code></pre>\n\n<hr>\n\n<p>However I would like my output to be </p>\n\n<pre><code>E1-03   ,  3\n</code></pre>\n\n<p>Which means, Select FIRST Row Bin Value only BUT show total row Count (or Max value from column C) as well. I am using MS SQL Server 2008.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":101,"score":1,"question_id":12394833,"title":"selecting 2nd and 3rd highest numbers for a group","body":"<p>i have a table:</p>\n\n<pre><code>CREATE TABLE [dbo].[TargettingReport](\n    [MLISNPI] [varchar](50) NULL,\n    [CLIENT_ID1] [varchar](50) NULL,\n    [Sum of count] [int] NULL\n) ON [PRIMARY]\n</code></pre>\n\n<p>i am trying to select the 2nd and third highest <code>SUM OF COUNT</code> based on <code>MLISNPI, CLIENT_ID1</code></p>\n\n<p>this is how i get the max for <strong>every unique occurrence</strong> of <code>MLISNPI, CLIENT_ID1</code>:</p>\n\n<pre><code>  select [MLISNPI],[CLIENT_ID1],MAX([Sum of count])\n  from [TargettingReport]\n  group by \n  [MLISNPI],[CLIENT_ID1]\n</code></pre>\n\n<p>the question is how do i get the 2nd and 3rd highest?</p>\n\n<p>here's some example data:</p>\n\n<pre><code>+---------+------------+--------------+\n| MLISNPI | CLIENT_ID1 | sum of count |\n+---------+------------+--------------+\n|  567890 |     214060 |           18 |\n|  678901 |     214060 |           58 |\n|  789012 |     214060 |           27 |\n|  891012 |     214060 |            1 |\n|  101112 |     214060 |           23 |\n|  003001 |     101596 |            0 |\n|  003001 |     101522 |          436 |\n|  003001 |     101597 |            0 |\n|  003002 |     102165 |           66 |\n|  003002 |     100062 |            1 |\n|  003002 |     211074 |         1229 |\n|  003006 |     102235 |           21 |\n|  003014 |     213926 |            5 |\n|  003016 |     213143 |            3 |\n|  003023 |     213801 |           55 |\n|  003023 |     212876 |           44 |\n|  003023 |     100218 |            0 |\n|  003028 |     211144 |          133 |\n|  003041 |     100236 |          346 |\n|  003041 |     103164 |           65 |\n|  003051 |     213402 |          157 |\n|  003058 |     100572 |           28 |\n|  003065 |     101632 |           29 |\n|  003071 |     213632 |            6 |\n|  003072 |     101506 |            4 |\n|  003081 |     100087 |          398 |\n|  003083 |     214311 |            7 |\n|  003117 |     210178 |          203 |\n|  003121 |     214008 |            9 |\n|  003139 |     102179 |         1635 |\n|  003147 |     216022 |           21 |\n|  003149 |     211425 |            1 |\n|  003186 |     215748 |            1 |\n+---------+------------+--------------+\n</code></pre>\n"},{"tags":["tsql","sql-server-2000"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":372,"score":0,"question_id":5095491,"title":"SQL Server 2000 - How do I alter a column from text to ntext?","body":"<p>I'm trying to do a <code>ALTER TABLE Signatures ALTER COLUMN HTML ntext;</code> but I get a <code>Cannot alter column 'HTML' because it is 'text'.</code></p>\n\n<p>How do I go about altering the column?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":35,"score":3,"question_id":12414552,"title":"TSQL: Returning customers by date descending?","body":"<p>Each time my user looks up a customer, I store the customer ID, Name and timestamp (timestamp = when the user performed the look up).</p>\n\n<p>Kinda like: </p>\n\n<pre><code>ID  Name      Timestamp\n1   CompanyA  2012-10-01 10:00\n2   ComapnyB  2012-10-01 10:11\n3   CompanyA  2012-10-01 10:22\n4   CompanyA  2012-10-01 10:25\n4   CompanyC  2012-10-01 10:32\n</code></pre>\n\n<p>My question is ...</p>\n\n<p>I want to return TOP 30 distinct customers sorted by date descending - how do I do that?</p>\n\n<p>I want to return this:</p>\n\n<pre><code>CompanyC\nCompanyA\nCompanyB\n</code></pre>\n\n<p>... only a single instance sorted by the date descending.</p>\n"},{"tags":["sql","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12413469,"title":"Syntax in this SQL Trigger to insert into another table mixing data from inserted rows and other data","body":"<p>For example, I am trying to do this: </p>\n\n<pre><code>INSERT INTO \n   [LNK_54SD_Reporting].[54_SD_Membership].[Users] (ApplicationId, UserId, UserName, IsAnonymous, LastActivityDate) \nVALUES \n   (@ApplicationId, @UserGuid, [inserted].[email], 0, 0)\n</code></pre>\n\n<p>but I get the error that <code>inserted.email</code> could not be bound.</p>\n\n<p>By suggestion, I have also tried this:</p>\n\n<pre><code>INSERT INTO \n    [LNK_54SD_Reporting].[54_SD_Membership].[Users] \n    (SELECT \n         ApplicationId, UserId, UserName, IsAnonymous, LastActivityDate) \nVALUES  \n    (@ApplicationId, @UserGuid, i.[email], 0, 0 FROM INSERTED)\n</code></pre>\n\n<p>which gives me an error on the SELECT</p>\n\n<p>What is the property syntax to get data from the inserted row on a insert trigger when I am trying to also insert other data as well?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12413448,"title":"how to not count 0 when doing row_number","body":"<p>I am doing a <code>row_number()</code> over some data.</p>\n\n<p>My problem is that I do not wnat to take into account data that is <code>0</code>.</p>\n\n<p>Here's my data sample:</p>\n\n<pre><code>+-----------+-----+\n| Alex      |   1 |\n| Liza      |   2 |\n| Harry     |   0 |\n| Marge     |  24 |\n| Bla       |   0 |\n| Something | 234 |\n+-----------+-----+\n</code></pre>\n\n<p>Here's what I want:</p>\n\n<pre><code>+-----------+--------+------------+\n|   name    | number | row_number |\n+-----------+--------+------------+\n| Harry     |      0 |          0 |\n| Bla       |      0 |          0 |\n| Something |    234 |          1 |\n| Marge     |     24 |          2 |\n| Liza      |      2 |          3 |\n| Alex      |      1 |          4 |\n+-----------+--------+------------+\n</code></pre>\n\n<p>as you can see the third column is <code>the row_number()</code></p>\n\n<p>this is what I have so far:</p>\n\n<pre><code>select name, number, row_number() over (partition by name order by name,number)\nfrom myTable\n</code></pre>\n\n<p>How do I get the query above to return <code>0</code> for all <code>0's</code> in the source data and <strong>not count the 0's at all towards the row_number sequence</strong>?</p>\n"},{"tags":["c#","entity-framework","tsql","linq-to-entities","datetime-comparison"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":81,"score":2,"question_id":12412231,"title":"How do I perform date-part comparison in EF","body":"<p>i heard people saying date time comparison do not work just due to time part because datetime has time part.</p>\n\n<p>in sql i always compare datetime like this way and it works fine</p>\n\n<pre><code>select * from employee\nwhere convert(varchar,dob,112) &gt; '20111201' // this yyyymmdd format.\n</code></pre>\n\n<p>how could i simulate this in a LINQ query?</p>\n"},{"tags":["sql","tsql","sql-server-2005","week-number","datepart"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12411185,"title":"convert week datepart number to date within week (week of...)","body":"<p>I am trying to figure out how to convert a datepart for a week to the Monday of that week.</p>\n\n<p>I am using this: </p>\n\n<pre><code>     datepart(ww, DateCompleted) as week \n</code></pre>\n\n<p>to group a set of orders in our system by week.  My goal is for this to say instead of 37, i want it to return the Monday of week 37, i.e.: 09-10-2012.  I am able to do this by defining each week per number but i would rather not spend so much time typing out each week when there is probably a better option out there, i have just been unable to find it anywhere online other than in MySQL and other programming languages (i need T-SQL please, or anything that will work on sql server 2005), and i do not know how to work with that.  Thanks for anyone that can help. Ill be checking back as often as possible to provide more info if needed.</p>\n"},{"tags":["sql","sql-server","tsql","check-constraints"],"answer_count":5,"favorite_count":2,"up_vote_count":31,"down_vote_count":0,"view_count":14788,"score":31,"question_id":529941,"title":"What's the difference between WITH CHECK ADD CONSTRAINT followed by CHECK CONSTRAINT and just ADD CONSTRAINT in SQL Server?","body":"<p>I'm looking at the AdventureWorks sample database for SQL Server 2008, and I see in their creation scripts that they tend to use the following:</p>\n\n<pre><code>ALTER TABLE [Production].[ProductCostHistory] WITH CHECK ADD \nCONSTRAINT [FK_ProductCostHistory_Product_ProductID] FOREIGN KEY([ProductID])\n  REFERENCES [Production].[Product] ([ProductID])\nGO\n</code></pre>\n\n<p>followed immediately by :</p>\n\n<pre><code>ALTER TABLE [Production].[ProductCostHistory] CHECK CONSTRAINT     \n[FK_ProductCostHistory_Product_ProductID]\nGO\n</code></pre>\n\n<p>I see this for foreign keys (as here), unique constraints and regular <code>CHECK</code> constraints; <code>DEFAULT</code> constraints use the regular format I am more familiar with such as:</p>\n\n<pre><code>ALTER TABLE [Production].[ProductCostHistory] ADD  CONSTRAINT  \n[DF_ProductCostHistory_ModifiedDate]  DEFAULT (getdate()) FOR [ModifiedDate]\nGO\n</code></pre>\n\n<p>What is the difference, if any, between doing it the first way versus the second?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":12409373,"title":"SQL - monthly average rather than daily average","body":"<p>I have a table called values that contains 3 columns - Location, value, date</p>\n\n<p>I want to work out the average value per month </p>\n\n<p>so far I have </p>\n\n<pre><code>SELECT Location, Avg(value), date  \nFROM Value  \nGROUP BY Location, date \n</code></pre>\n\n<p>This returns the average values but a value is entered on a daily basis so I have an average per day rather than per month, how can I achieve a monthly average?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12408804,"title":"Deriving a thousands or hundreds range from a number in T-SQL","body":"<p>We have several thousand job numbers stored in a SQL Server database, and I'd like to be able to derive what 1000's or 100's range they fall into for purposes of grouping in a third party application, which is integrated with our jobs list.</p>\n\n<p>How can I extract the 1000's group that each job number would belong to in a column in my query's result set?</p>\n\n<p>Examples:\nI would like for my output to be:</p>\n\n<pre><code>JOB_NUMBER      JOB_GROUP\n678             0-999\n679             0-999\n1517            1000-1999\n2011            2000-2999\n2150            2000-2999\n...etc.\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":58,"score":2,"question_id":12408599,"title":"T-SQL with IF logic not working with temp table","body":"<pre><code>IF OBJECT_ID('tempdb..#iftry') IS NOT NULL \nDROP TABLE #iftry\n\nIF OBJECT_ID('BIC_Analytics.dbo.AdjudicateAllDCCharteredClaims') IS  NULL\nbegin\nselect 'this is start of first block'\n SELECT 'this is first block' as blockid\n INTO #iftry\nselect 'this is end of first block'\nend\n\nELSE\n\nbegin\nselect 'this is start of 2nd block'\n SELECT 'this is 2nd block' as blockid\n    INTO #iftry\nselect 'this is end of 2nd block'\nend\n\nselect ':)'\n\nselect * from #iftry\n</code></pre>\n\n<p>Keeps giving me the error: </p>\n\n<pre><code>Msg 2714, Level 16, State 1, Line 18\nThere is already an object named '#iftry' in the database.\n</code></pre>\n\n<p>Now it works </p>\n\n<pre><code>IF OBJECT_ID('tempdb..#iftry') IS NOT NULL \nDROP TABLE #iftry\n\ncreate table #iftry (blockid varchar(20))\n\n\nIF OBJECT_ID('BIC_Analytics.dbo.AdjudicateAllDCCharteredClaims') IS NOT NULL\nbegin\n--select 'this is start of first block'\n insert into #iftry (blockid)\n select 'this is first block' \n--select 'this is end of first block'\nend\n\nELSE\n\nbegin\n--select 'this is start of 2nd block'\n insert into #iftry (blockid)\n select 'this is 2nd block' \n--select 'this is end of 2nd block'\nend\n\nselect ':)'\n\nselect * from #iftry\n</code></pre>\n"},{"tags":["tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12408119,"title":"Rename Table with an ]","body":"<p>I can't find the right syntax to rename a table in T-SQL when the table name contains an ']' character.</p>\n\n<p>It seems like the sp_rename procedure doesn't use the same escaping rules as T-SQL DDL.</p>\n\n<p>How can this be done?</p>\n\n<pre><code>CREATE SCHEMA MySchema\n\nCREATE TABLE [MySchema].[MyTab]]le5](\n    [Id] [bigint] IDENTITY(1,1) NOT NULL,\n    [SomeField] [bigint] NULL,\n    [MyField] [nvarchar](4000) NULL)\n\nEXEC sp_rename 'MySchema.MyTa]ble5', 'MyTable6'\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":48,"score":1,"question_id":12407554,"title":"Is there any way to insert and update records in one t-sql statement","body":"<p>I have a table BigTable and a table LittleTable. I want to move <strong>a copy</strong> of some records from BigTable into LittleTable and then (for these records) set BigTable.ExportedFlag to T (indicating that a copy of the record has been moved to little table).</p>\n\n<p>Is there any way to do this in one statement? </p>\n\n<p>I know I can do a transaction that (1) moves the records from big table based on a where clause (2) updates big table setting exported to T based on this same where clause. </p>\n\n<p>I've also looked into a <a href=\"http://msdn.microsoft.com/en-us/library/bb522522%28v=sql.105%29.aspx\" rel=\"nofollow\">merge statement</a>, which does not seem quite right, because I don't want to change values in little table, just move records to little table.  </p>\n\n<p>I've looked into an <a href=\"http://blog.sqlauthority.com/2007/10/01/sql-server-2005-output-clause-example-and-explanation-with-insert-update-delete/\" rel=\"nofollow\">output clause</a> after the update statement but can't find a useful exampple. In the one I link to I don't understand why Pinal Dave is using Inserted.ID, Inserted.TEXTVal, Deleted.ID, Deleted.TEXTVal instead of Updated.TextVal. Is the update considered an insertion or deletion?</p>\n\n<p>I found this post <a href=\"http://stackoverflow.com/questions/742540/tsql-update-with-insert-into-select-from\">TSQL: UPDATE with INSERT INTO SELECT FROM</a> on SO where a guy says \"AFAIK, you cannot update two different tables with a single sql statement.\"</p>\n\n<p>How should I do this? I am looking for a correct, maintainable sql statement. Maybe I just need to do two statements in a single transaction? Or is there a clean way to do this?</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":6593,"score":3,"question_id":6309541,"title":"How do I convert a number to a numeric, comma separated, formatted string?","body":"<p>Is there an easy way to convert a number (in my case an integer) to a comma separated <code>nvarchar</code> string?</p>\n\n<p>For instance, if I had an <code>int</code> value of 1000000 stored in a field, how can I convert to an <code>nvarchar</code> string, with the output value of \"1,000,000\"?</p>\n\n<p>I could easily write a function to do this but I wanted to be sure there wasn't an easier way involving a call to either <code>CAST</code> or <code>CONVERT</code>.</p>\n"},{"tags":["sql","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":47,"score":0,"question_id":12405684,"title":"What kind of JOIN statement do I need?","body":"<p>I have two tables PROCESS and STEP and some data inside as show below. (They have 1-N relationship.)</p>\n\n<pre><code>PROCESS -&gt;\n\nID START_TIME STARTED_BY STATUS\n1  31/08/2012 User1      FINISHED\n2  31/08/2012 User2      FINISHED\n3  05/09/2012 User3      ACTIVE\n\nSTEP -&gt;\n\nID PROCESS_ID START_TIME END_TIME   STATUS\n1  1          31/08/2012 02/09/2012 FINISHED  \n2  1          02/09/2012 03/09/2012 FINISHED    \n3  1          03/09/2012 10/09/2012 FINISHED  \n4  2          31/08/2012 04/09/2012 FINISHED  \n5  2          04/09/2012 06/09/2012 FINISHED  \n6  2          06/09/2012 09/09/2012 FINISHED  \n7  3          05/09/2012 06/09/2012 FINISHED    \n8  3          06/09/2012 NULL       ACTIVE\n</code></pre>\n\n<p>What I need is a JOIN, which will give me Start and End times of Finished processes like below:</p>\n\n<pre><code>PROCESS_ID START_TIME END_TIME  \n1          31/08/2012 10/09/2012  \n2          31/08/2012 09/09/2012\n</code></pre>\n\n<p>What kind of JOIN statement do I need to write to accomplish this?</p>\n"},{"tags":["query","tsql","ssms","common-table-expression"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12405498,"title":"Syntax for nested common-table-expression","body":"<p>I asked a question for a complex query yesterday, and I was offered an example. I really would like to get it to work but there was a syntax error in it that I can't figure out. Keep in mind that I was just introduced to CTE's earlier this week so hopefully this is an easy one.</p>\n\n<p>I don't think I need to post the full code on here, so I'll just summarize</p>\n\n<pre><code> with cte as (select dateadd(hour, 1, cast(cast(getdate() -1 as date) as datetime)) as midnnight),\n allhours as (\n select 0 as hour, midnight as timestart, dateadd(hour, 1, timestart) as timeend from cte union all\n select 1 as hour, dateadd(hour, 1, midnight), dateadd(hour, 2, midnight) from cte union all\n ....\n select 23 as hour, dateadd(hour, 23, midnight), dateadd(hour, 24, midnight) from cte union all\n) \nselect ah.hour,...\n</code></pre>\n\n<p>The (...) denotes unnecessary code that I omitted to make it less messy </p>\n\n<p>But I am getting a syntax error on the parenthesis between select 23 and select ah.hour\n\"Incorrect syntax near ')'. Expecting SELECT, or '('.</p>\n\n<p>Any help is greatly appreciated. </p>\n\n<p>-J</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12396634,"title":"transforming stacked data into horizontal data","body":"<p>this query:</p>\n\n<pre><code>; with numbered as\n(\n  select *,\n      -- Assign number to each record\n      -- Numbering is separate for each pair of MLISNPI and CLIENT_ID1\n      -- Highest [Sum of desc] will get number 1 and so forth\n         Rank() over (partition by [MLISNPI]\n                            order by [Sum of count] desc) rn\n    from [TargettingReport]\n),\nctemain as (\nselect [MLISNPI],\n       [CLIENT_ID1], \n       [Sum of count]\n  from numbered\n)\n\n\nselect * from ctemain\n</code></pre>\n\n<p>is returning this example data:</p>\n\n<pre><code>+----------+------------+--------------+\n| MLISNPI  | CLIENT_ID1 | Sum of count |\n+----------+------------+--------------+\n| 03001363 |     101522 |          436 |\n| 03001363 |     101596 |            0 |\n| 03001363 |     101597 |            0 |\n| 03002312 |     102165 |           66 |\n| 03002742 |     100062 |            1 |\n| 03002742 |     211074 |         1229 |\n| 03006958 |     102235 |           21 |\n| 03014986 |     213926 |            5 |\n| 03016270 |     213143 |            3 |\n| 03023284 |     212876 |           44 |\n| 03023284 |     213801 |           55 |\n| 03023821 |     100218 |            0 |\n| 03028812 |     211144 |          133 |\n| 03041666 |     100236 |          346 |\n| 03041666 |     103164 |           65 |\n| 03051731 |     213402 |          157 |\n| 03058777 |     100572 |           28 |\n| 03065509 |     101632 |           29 |\n| 03071952 |     213632 |            6 |\n| 03072059 |     101506 |            4 |\n| 03081449 |     100087 |          398 |\n| 03083205 |     214311 |            7 |\n| 03117698 |     210178 |          203 |\n| 03121302 |     214008 |            9 |\n| 03139502 |     102179 |         1635 |\n| 03147455 |     216022 |           21 |\n| 03149204 |     211425 |            1 |\n| 03186883 |     215748 |            1 |\n| 03186883 |     215749 |           10 |\n| 03190331 |     212289 |           26 |\n| 03800285 |     101108 |         8052 |\n| 03800285 |     101596 |            0 |\n| 03800285 |     101597 |            0 |\n| 03800350 |     212419 |            9 |\n| 03800616 |     110461 |            0 |\n| 03800616 |     213456 |            3 |\n| 03802018 |     103136 |           32 |\n| 03803412 |     201257 |            3 |\n+----------+------------+--------------+\n</code></pre>\n\n<p>but i actually need the data horizontally like this PER <code>MLISNPI</code>:</p>\n\n<pre><code>+----------+-----------+-------------+------------+-------------+-------------+----------+\n| MLISNPI  | clientid1 | sumofcount1 | clientid 2 | sumofcount2 | client id 3 | sum of 3 |\n+----------+-----------+-------------+------------+-------------+-------------+----------+\n| 03001363 |    101522 |         436 |     101596 |           0 |      101597 |        0 |\n| 03002312 |    102165 |          66 |            |             |             |          |\n| 03002742 |    100062 |           1 |     211074 |        1229 |             |          |\n| 03006958 |    102235 |          21 |            |             |             |          |\n| 03014986 |    213926 |           5 |            |             |             |          |\n| 03016270 |    213143 |           3 |            |             |             |          |\n| 03023284 |    212876 |          44 |     213801 |          55 |             |          |\n+----------+-----------+-------------+------------+-------------+-------------+----------+\n</code></pre>\n\n<p>how can i get the data in this format?</p>\n\n<p>here's the create table:</p>\n\n<pre><code>CREATE TABLE [dbo].[TargettingReport](\n    [MLISNPI] [varchar](50) NULL,\n    [IMS_PRESCRIBER_ID] [varchar](50) NULL,\n    [CLIENT_ID1] [varchar](50) NULL,\n    [Sum of count] [int] NULL\n) ON [PRIMARY]\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":12404561,"title":"Join where records dont match","body":"<p>I need to do a join on two tables, I need EVERYTHING from table A, and just the stuff from table B where the 'REF' for each row, is not already in table A's results.</p>\n\n<p>Key Facts:\nTable B contains the complete amount of ID's/Names however all the other information is blank. Its basically just a table with all employee's name's and id's but its a complete list.\nTable A contains a limited amount of results but all the other columns have data in them.</p>\n\n<p>What I need is to use Table B as a complete reference rather than just see what exists in table A so basically:</p>\n\n<blockquote>\n  <p>\"Show me everything from table A, and add the extra people's details\n  found in table B where they dont already exist in table A to give me a complete result set\"</p>\n</blockquote>\n\n<pre><code>select\nID,\nName,\nStartDate,\nEndDate,\nState,\nStatus,\nComment,\nIsComment\nfrom\ntableA\n\n\nselect\nID,\nName,\nStartDate,\nEndDate,\nState,\nStatus,\nComment,\nIsComment\nfrom\ntableB\n</code></pre>\n\n<p>Table A contents:</p>\n\n<pre><code>ID       Name     START_DATE       END_DATE      STATE    Status     Comment    Is_Comment\n6760    chris       2012-09-03      2012-09-09   4       Applied                   0\n6524     dave     2012-09-03        2012-09-09    4        Applied                 0\n4268     james    2012-09-03        2012-09-09    4        Applied    Friday-Off   1\n7851     rob      2012-09-03        2012-09-09    4       Applied                  0\n</code></pre>\n\n<p>Table B contents</p>\n\n<pre><code>    ID        Name     START_DATE       END_DATE      STATE    Status     Comment    Is_Comment\n    6760    Chris   \n    6524    dave    \n    4268    james   \n    7851    rob      \n    4521    ryan\n    5698   julie\n    4596    rory\n    1111     mary\n    5621     owain\n    9999     jacob\n</code></pre>\n\n<p>After the join what I want to see:</p>\n\n<pre><code>    ID       Name     START_DATE       END_DATE      STATE    Status     Comment    Is_Comment\n\n    6760    chris       2012-09-03      2012-09-09   4       Applied                   0\n    6524     dave     2012-09-03        2012-09-09    4        Applied                 0\n    4268     james    2012-09-03        2012-09-09    4        Applied    Friday-Off   1\n    7851     rob      2012-09-03        2012-09-09    4       Applied                  0   \n   4521    ryan\n   5698    julie\n   4596    rory\n  1111     mary\n  5621     owain\n  9999     jacob\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":63,"score":3,"question_id":12399152,"title":"rolling up data and getting SUM group by","body":"<p>I have two tables:</p>\n\n<pre><code>**OrgPhysicianMappingtbl**\norg varchar\nphysician varchar\n\n**PhysicianDatatbl**\nphysician varchar\nnames varchar\ndatapoint int\n</code></pre>\n\n<p>data from <code>OrgPhysicianMappingtbl</code>:</p>\n\n<pre><code>+---------+-----------+\n|   org   | physician |\n+---------+-----------+\n| ABC123  | B032      |\n| ABC123  | B023      |\n| ABC123  | A022      |\n| ABB443  | A32       |\n| ABB332  | F23       |\n| BVD222  | G23       |\n| BVD222  | GG2       |\n| BOS5223 | G4        |\n+---------+-----------+\n</code></pre>\n\n<p>data from <code>PhysicianDatatbl</code>:</p>\n\n<pre><code>+------------+----------------------------------+-----------+\n| physician  |              names               | datapoint |\n+------------+----------------------------------+-----------+\n| B032       | CASH                             | 68        |\n| B032       | MEDICAID                         | 89        |\n| B032       | ALL THIRD PARTY                  | 3,769     |\n| B032       | WORKERS COMP                     | 39        |\n| B032       | US SCRIPT (PROC-UNSP)            | 86        |\n| B032       | MEDCO HLTH SOLUTIONS (PROC-UNSP) | 79        |\n| B032       | BCBS WELLPOINT/ANTHEM/WEL UNSPEC | 76        |\n| B032       | KY EMPLOYEES HLTH PLN/KEHP (KY)  | 62        |\n| B032       | UHC/PAC/AARP MED PDP GENERAL(KY) | 52        |\n| B032       | WELLCARE OF KENTUCKY (KY)        | 42        |\n| B032       | CCRX MED PDP GENERAL (KY)        | 39        |\n| B032       | WORKERS COMP - EMPLOYER          | 37        |\n| B032       | HUMANA/CAREPLS MED D GENERAL(KY) | 27        |\n| B032       | CIGNA MEDICARE RX PDP GNRL (KY)  | 26        |\n| B023       | CASH                             | 167       |\n| B023       | MEDICAID                         | 34        |\n| B023       | ALL THIRD PARTY                  | 3,165     |\n| B023       | WORKERS COMP                     | 56        |\n| B023       | WORKERS COMP - EMPLOYER          | 50        |\n| B023       | BLUE CHOICE PPO (TX)             | 48        |\n| B023       | TRICARE HUMANA MILITARY SOUTH    | 47        |\n| B023       | MEDCO HLTH SOLUTIONS (PROC-UNSP) | 32        |\n| B023       | BROADSPIRE INC                   | 27        |\n| B023       | ADVANCEPCS (PROC-UNSP)           | 27        |\n| B023       | UNITED HLTHCARE-(TX) TEXAS       | 23        |\n| B023       | HEALTHSPRING PDP (TX)            | 18        |\n| B023       | AETNA INC.-(TX) HOUSTON          | 13        |\n| B023       | WELLCARE MEDICARE D GENERAL(TX)  | 12        |\n+------------+----------------------------------+-----------+\n</code></pre>\n\n<p>example of desired result:</p>\n\n<pre><code>+-----------+-----------------+-----------+\n| org       |      names      | sum(datapoints|\n+-----------+-----------------+-----------+\n| ABC123    | CASH            | 236       |\n| ABC123    | MEDICAID        | 123       |\n| ABC123    | ALL THIRD PARTY | 6,933     |\n| ABC123    | WORKERS COMP    | 94        |\n|          |                |          |\n+-----------+-----------------+-----------+\n</code></pre>\n\n<p>I need to roll up my data to the ORG level. There are multiple physicians per ORG. every physician has <code>names</code> and <code>datapoints</code> associated with it. The result that I want is the sum of all <code>datapoints</code> per <code>names</code> rolled up to the <code>org</code> level.</p>\n\n<p>Can someone please get me started on this?</p>\n\n<p>here's what i tried:</p>\n\n<pre><code>select o.org,p.names,sum(p.datapoint)\nfrom OrgPhysicianMappingtbl o\njoin PhysicianDatatbl p\non o.physician=p.physician\ngroup by o.org,p.names\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","cursor","dynamic-sql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":55,"score":1,"question_id":12397851,"title":"Big ugly cursor","body":"<p>I'm populating a table of about 15 columns from a table of about 1000 columns.  I need to grab the time from the big table.  That time is broken up into minutes and hours [rn-min] and [rn-hr] and I need them in an am/pm format in the new table. The table is populated by an outside company so I can't really change much about it, I did get them to put in a transferred column for me to check.  It's big and slow and I only need a few columns and there is a lot of duplicate/similar rows. In any case I'm making the smaller table from the bigger table.  I wrote a cursor, its slow and I was wondering if there was a better way to do it.  I can't just use a simple insert(select columns) because I want to change the way the time and date are stored.  Thanks, any help or advice is appreciated</p>\n\n<pre><code>declare data CURSOR READ_ONLY FORWARD_ONLY\nfor   \n    select [raID],\n            (otherfields),\n            CAST([RA-rent-mm] as varchar(2)) + '/' + CAST([RA-rent-dd] as varchar(2)) + '/' +\n            CAST([RA-Rent-CC] as varchar(2)) + CAST([RA-RENT-YY] as varchar(2)) [Date_Out],\n            CAST([RA-Rtrn-mm] as varchar(2)) + '/' + CAST([RA-Rtrn-dd] as varchar(2)) +\n            '/' + CAST([RA-Rtrn-CC] as varchar(2)) + CAST([RA-Rtrn-YY] as varchar(2)) [Date_In],\n            CAST([RA-RENTAL-HOURS] as varchar(2)),\n            CAST([RA-RENTAL-Minutes] as varchar(2)),\n            CAST([RA-RTRN-HOURS] as varchar(2)),\n            CAST([RA-RTRN-MINUTES] as varchar(2)),\n            (other fields)\n      from table_name\n     where Transfered is null\n       and [RA-rtrn-mm] != 0 --this keeps me from getting the duplicate/similar rows, once this doesn't equal 0 there aren't anymore rows so I just grab this one\n\ndeclare @sql as varchar(max)\ndeclare @raID int;\n    (other fields),\ndeclare @rentDate varchar(8);\ndeclare @rtrnDate varchar(8);\ndeclare @rentHours varchar(2);\ndeclare @rentMinutes varchar(2);\ndeclare @rtrnHours varchar(2);\ndeclare @rtrnMinutes varchar(2);\n    (other fields)\n\nopen data\n    fetch next from data into \n        @raID,\n        (other fields),\n        @rentDate ,\n        @rtrnDate ,\n        @rentHours ,\n        @rentMinutes ,\n        @rtrnHours ,\n        @rtrnMinutes ,\n        (other fields),\n    while @@FETCH_STATUS = 0\n    begin\n        set @rentMinutes = left('0' + @rentMinutes,2);--padding with 0 if minutes is 1-9\n        set @rtrnMinutes = left('0' + @rtrnMinutes,2);\n\n        --turning the varchar times into a time then back to varchar with correct am/pm notation\n        declare @rentT time = @rentHours + ':' + @rentMinutes;\n        declare @rtnT time = @rtrnHours + ':' + @rtrnMinutes;\n        declare @rentTime varchar(7) = convert(varchar(15),@rentT, 100);\n        declare @returnTime varchar(7) = convert(varchar(15),@rtnT, 100);\n\n        --print @rentTime;\n        set @sql = 'INSERT other_tbl_name(raID, (other fields), Date_Out, Date_In, Time_Out, Time_In,    (other fields))\n                values ('+cast(@raID as varchar(max))+', (other fields),'''+@rentDate+''',\n                            '''+@rtrnDate+''', '''+@rentTime+''', '''+@returnTime+''',\n                            (other fields))';\n\n        --exec(@sql)\n        print @sql\n\n        --need a way to make sure the insert worked before updating\n        --need to update transferred to keep from updating the same info\n\n        declare @update as varchar(max) = '\n        UPDATE Capture.icokc_data\n           SET Transfered = 1\n         WHERE [raID] = '+cast(@raID as varchar(10))\n\n        --exec(@update)\n        --print @update\n\n        fetch next from data into \n            @raID,\n            (other fields)\n            @rentDate ,\n            @rtrnDate ,\n            @rentHours ,\n            @rentMinutes ,\n            @rtrnHours ,\n            @rtrnMinutes ,\n            (other fields)\n    end\n\nclose data;\ndeallocate data;\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":49,"score":1,"question_id":12400428,"title":"SQL Use Variable to alter column length","body":"<p>I am exporting my data from a table T to CSV files, T has couple of varchar columns, at the time of processing, I don't know the length of data coming from data warehouse so I set the length to 500 (suppose), after exporting to csv file, I noticed that it put extra spaces after the data based on the length of the column.</p>\n\n<p>What I want to do is alter the column length to is max data. So there is two questions.</p>\n\n<ol>\n<li>Get the Max Length of the data inside a column in a table.</li>\n<li><p>Use Variable to alter a column, the following code doesn't work stating \"Incorrect syntax near '@l'.\"</p>\n\n<pre><code>DECLARE @l int\nSET @l = 12\n\nALTER TABLE Temp\nALTER COLUMN a VarChar(@l)\n</code></pre></li>\n</ol>\n"},{"tags":["sql-server-2008","tsql","table","hierarchical"],"answer_count":4,"favorite_count":3,"up_vote_count":4,"down_vote_count":0,"view_count":101,"score":4,"question_id":12322212,"title":"Create hierarchical formatted output from table","body":"<p>I have a SQL table like this</p>\n\n<pre><code>CC     Descr  C_NO     Vol   Wt\n\n2050   Des1   123      20    40\n2060   Des2   123      30    50\n2050   Des1   125      20    40\n2060   Des2   125      30    50\n2050   Des1   126      20    40\n</code></pre>\n\n<p>and I want output like this</p>\n\n<pre><code>2050\n    Des1\n\n 123\n    20\n    40\n 125\n    20\n    40   \n 126\n    20\n    40\n\n2060\n    Des2\n\n 123\n    30\n    50\n 125\n    30\n    50\n</code></pre>\n\n<p>How can I do that using TSQL code? </p>\n\n<p>For every similar CC value which always have similar Descr value, it shows all the C_No, Vol and Wt values related to that particular CC value in the sequence written in the output section.</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","dynamics-crm"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":70,"score":0,"question_id":12378534,"title":"Exporting Attachments from Dynamics 3.0 MSSQL Table to Local Folder","body":"<p>I am working on an ETL project, and part of the requirements is to extract email attachments from MS Dynamics CRM 3.0 for migration into Salesforce.com.</p>\n\n<p>The part where I'm stumped is in extracting (i.e., saving as files in a local folder), the documents which are stored as MS SQL 2005 \"Text\" (Base64) objects under the DocumentBody field.</p>\n\n<p>If you're familiar with MS Dynamics architecture, these are stored under the \"AnnotationsBase\" table. Here's an example of a query and a couple rows of output:</p>\n\n<pre><code>SELECT top 1\n   [AnnotationId]\n  ,[OwningUser]\n  ,[ObjectId]\n  ,[Subject]\n  ,[MimeType]\n  ,[DocumentBody]\n  ,[FileName]\nFROM [Manufacturing_Company_MSCRM].[dbo].[AnnotationBase]\nwhere isdocument = 1\norder by filesize\n</code></pre>\n\n<hr>\n\n<p><strong>AnnotationId:</strong> 02E5D4E3-5323-DC11-ADF9-0013726038EA</p>\n\n<p><strong>OwningUser:</strong> DC86BB76-0A74-DB11-8659-0013726038EA</p>\n\n<p><strong>ObjectId:</strong> ED0A7E57-4518-DC11-8EB4-0013726038EA</p>\n\n<p><strong>Subject:</strong> Note created on 03/31/2009 1:19 PM by Microsoft CRM </p>\n\n<p><strong>MimeType:</strong> text/plain</p>\n\n<p><strong>DocumentBody:</strong> Rmlyc3QgTmFtZSxMYXN0IE5hbWUsRS1tYWlsIEFkZHJlc3MNCkpvaG4sU21pdGgsanNtaXRoQG1pY3Jvc29mdC5jb20NCkZyYW5rLEpvbmVzLGZqb25lc0Bjb250b3NvLmNvbQ0KLCwNCiwsDQosLA0KLCwNCiwsDQosLA0KLCwNCiwsDQosLA0KLCwNCiwsDQo=</p>\n\n<p><strong>FileName:</strong> bmc_import.csv</p>\n\n<hr>\n\n<p>With many different mime types and thousands of attachments, How could I script a way to populate a folder (let's call it \"C:\\attachments\\\") with these files (like c:\\attachments\\bmc_import.csv, c:\\attachments\\budget.xls, etc.)?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":30,"score":1,"question_id":12394021,"title":"Select using where with multiple element in a subquery","body":"<p>The following code does not work but I am using is as an example of what I am trying to accomplish:</p>\n\n<pre><code>SELECT thing_id\nFROM table_of_things\nWHERE table_of_things.thing_color, table_of_things.thing_flavor IN \n                          ( SELECT good_color,good_flavor FROM good_things )\n</code></pre>\n\n<p>EDIT: So apparently it wasent apparent from my code to SOME people. I am trying to use to get the things_id from the table_of_things using two criteria from the subquery.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":238,"score":5,"question_id":12240612,"title":"Check if value was greater than x for y consecutive months period in changes history","body":"<p>I have table with members level changes. It has historical changes of level of all members and date when change happened. For example I can list changes for member number 5:</p>\n\n<pre><code>select * from memberlevelhistory where member = 5\n</code></pre>\n\n<p>result:</p>\n\n<pre><code>member  changedate  level\n5       2012-04-01  2\n5       2012-03-01  3\n5       2012-02-01  2\n5       2011-02-01  6\n5       2011-02-01  6\n5       2010-03-15  6\n5       2010-02-01  5\n5       2010-01-01  5\n5       2009-10-01  4\n5       2009-08-27  2\n5       2009-08-01  1\n</code></pre>\n\n<p>Last entry in history table is current level.</p>\n\n<p>QUESTION:\nHow to list all members that had level higher or equal to 3 for period of 3 months or more ?</p>\n\n<p>That is a simplified version of the question. To make it even more fun I need only members that didn't drop below the starting level during this 3 month period. So if a member started the 3 month period with level 4 and is only level 3 on the last month then that member is excluded from the list.</p>\n\n<p>Any help, even with the simplified question is much appreciated.</p>\n\n<p>EXTENDED VERSION:</p>\n\n<p>I also need this period of >=3 months of level >=3 happen inside last 6 months window.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":62,"score":1,"question_id":12394348,"title":"Deprecated T-SQL Syntax","body":"<p>Is quoting every part of a SELECT statement deprecated T-SQL syntax?</p>\n\n<pre><code>SELECT \"A\", \"B\", \"C\" FROM \"database\".\"table\" where \"column\" = @p2 \n</code></pre>\n\n<p>This is syntax being used by MS Access to query against a SQL Server instance.  I do not know what version of Access is being used.</p>\n"},{"tags":["sql","tsql","metaphone"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12394704,"title":"SQL for Querying MSSQL with Double Metaphone for First/Last Name Combos","body":"<p>I am using Double-Metaphone for fuzzy searching within my database.  I have a table of names, and both the first and last names have double metaphone entries already created (and updated, via a Trigger).  In my application, I am allowing the user to search by Lastname and/or Firstname.</p>\n\n<p>What is the best way to query the database, to get the best results from the Double-Metaphone indexes when dealing with both last AND first names ?  Querying just based on lastname is easy - generate the DM tags and query the database.  It's when querying by both first and last that I'd like to get some fine tuning.</p>\n\n<p>The database layout is similar to the following:</p>\n\n<pre><code>tblName\n  FirstName\n  LastName\n  MetaPhoneFN1\n  MetaPhoneFN2\n  MetaPhoneLN1\n  MetaPhoneLN2\n</code></pre>\n\n<p>Application:  [Lastname]   [FirstName]</p>\n\n<p>User inputs just a lastname, or a combination of lastname + [First initial, first name, part of first name].</p>\n\n<pre><code>Lastname:  SMITH\nFirstName:  J or Jo or John or Johnathan\n</code></pre>\n\n<p>If I pass in \"J\" as the firstname - I'd like all name entries matching \"J%\".</p>\n\n<p>If I pass in \"JO\" as the firstname - I'd like all name entries matching \"JO%\".</p>\n\n<p>If I pass in \"JOHN\" or \"JOHNATHAN\" as the firstname - I'd like to use DM</p>\n\n<p>or maybe also \"JOHN%\" ?</p>\n\n<p><em><strong></em> I'm really open to suggestions here, for the firstname.  I want the results to be as good as possible and return what the user wants.</strong></p>\n\n<p>What is the best way to query the database for last + any of those combinations of first name ?  Here's a sample of what I've gotten so far.. and I'm not completely thrilled with the results:</p>\n\n<pre><code>SELECT *\nFROM tblName\nWHERE\n--There will always be a last name\n    (MetaPhoneLN1 = @paramMetaPhoneLN1\nOR  (CASE WHEN @paramMetaPhoneLN2 IS NOT NULL AND MetaPhoneLN2 = @paramMetaPhoneLN2 THEN 1\n          WHEN @paramMetaPhoneLN2 IS NULL THEN 0\n     END) = 1)\n--  Match Firstname 1\nAND (CASE WHEN @paramMetaPhoneFN1 IS NULL THEN 1                      \n          WHEN @paramMetaPhoneFN1 IS NOT NULL AND MetaPhoneFN1 = @paramMetaPhoneFN1 THEN 1                \n          WHEN LEN(@paramMetaPhoneFN1) &gt; 1 AND LEN(@paramMetaPhoneFN1) &lt; 4 AND MetaPhoneFN1 LIKE @paramMetaPhoneFN1 + '%' THEN 1\n          WHEN LEN(@paramMetaPhoneFN1) = 1 THEN 1                                               \n      END) = 1  \n--  Match Firstname 2\nAND (CASE WHEN @paramMetaPhoneFN2 IS NULL THEN 1\n          WHEN @paramMetaPhoneFN2 IS NOT NULL AND MetaPhoneFN2 = @paramMetaPhoneFN2 THEN 1\n          WHEN LEN(@paramMetaPhoneFN2) &gt; 1 AND LEN(@paramMetaPhoneFN2) &lt; 4 AND MetaPhoneFN2 LIKE @paramMetaPhoneFN2 + '%' THEN 1\n          WHEN LEN(@paramMetaPhoneFN2) = 1 THEN 1           \n        --ELSE 0                    \n      END) = 1\nAND (CASE WHEN @paramFirstName IS NULL THEN 1\n          WHEN  FirstName LIKE @paramFirstName + '%' THEN 1                     \n        --WHEN LEN(@paramMetaPhoneFN1) = 1 AND @paramFirstName IS NOT NULL AND LEN(@paramFirstName) &gt; 1 AND FirstName LIKE @paramFirstName + '%' THEN 1\n      --ELSE 1\nEND) = 1\n</code></pre>\n\n<p>What I've tried to do is account for the different variations for firstname.  My results however, aren't exactly what I would want.</p>\n\n<p>I've been able to find lots of implementations of Double Metaphone in SQL/C#, etc. for /generating/ the Double-Metaphone values, but nothing on how to actually query the database effectively once you have those values.</p>\n\n<p><strong>SUMMARY:</strong></p>\n\n<p>When I search by both lastname and firstname -- I'd like to query the database for the Double Metaphone match only on Lastname, but I'd like a lot of flexibility when a firstname is also passed in.. first initial ? sounds like ? etc.  I am open to suggestions and SQL examples!</p>\n\n<p><strong>UPDATE 1:</strong>\nWhen I say that I'm not thrilled with the results.. what I'm saying is that I'm not sure how to formulate the Firstname part of the query, to maximize results.  If I search for \"WILL\" - what results should be returned ?  WILLIAM, WILL, WILBERT .. but not WALKER - though with what I have here, WALKER would be returned because WILL -> FL and WALKER IS [FLKR] but WILLIAM IS [FLM].  If I do only DM = DM then I wouldn't get WILLIAM even returned, which is why I'm doing a LIKE in the first place, if the DM length is &lt; 4.</p>\n\n<p>Basically, I'd like to know if anyone else has run into this issue, and see what solutions others have come up with.  </p>\n\n<p>First initial only - should show all firstnames starting with that initial\n - Here's where I'm uncertain:\nPartial name - should should all firstnames starting with the partial ?  [how do you know if it's just a partial name ?!]\nFull name - should use DM ?</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":48,"score":1,"question_id":12395277,"title":"How to use variable in t-sql query","body":"<p>Today I get my database name like that :</p>\n\n<pre><code>set @databaseNameTXT = 'NewStat1DB';\n</code></pre>\n\n<p>And then I insert the data to the right table like that:</p>\n\n<pre><code>IF @databaseNameTXT = 'NewStat1DB' \n    BEGIN\n        INSERT INTO [NewStat1DB] (wStat_id) values(@wStat_id)\n    END\n\nIF @databaseNameTXT = 'NewStat2DB'\n    BEGIN\n        INSERT INTO [NewStat2DB] (wStat_id) values(@wStat_id)\n    END\n</code></pre>\n\n<p>How can I use the variable inside the t-sql and run it, something like:</p>\n\n<p>INSERT INTO [@databaseNameTXT] (wStat_id) values(@wStat_id)</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql","null","rollup"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":85,"score":2,"question_id":12390142,"title":"Remove nulls from sub totals / grand totals in tsql rollup","body":"<p>I currently have a script below which aggregates some data using rollup:</p>\n\n<pre><code>SELECT \n        CASE \n            WHEN GROUPING(Custodian) = 1 \n                THEN 'Grand Total'\n            WHEN GROUPING(PortfolioID) = 1\n                THEN Custodian+''+'Total'\n            ELSE Custodian\n\n        END AS Custodian\n\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   SUM(AmountTotalBaseEquiv) AS AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD\n    ,   SUM(TotalCashPctNAV) AS TotalCashPctNAV \n\nFROM @ResultSet\nWHERE TotalCashPctNAV &gt; 5\nGROUP BY Custodian\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD \n    ,   TotalCashPctNAV WITH ROLLUP\n\nHAVING GROUPING_ID(Custodian\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD \n    ,   TotalCashPctNAV) IN (1,255,511)\n\nORDER BY CASE WHEN GROUPING(Custodian) = 1 THEN 2 ELSE 1 END, Custodian, TotalCashPctNAV DESC, PortfolioID\n</code></pre>\n\n<p>This returns data like as an example:</p>\n\n<pre><code>Custodian   PortfolioID PortfolioBaseCCY Date         AmountTotalBaseEquiv  ExchangeRate    AmountTotalBaseEquivUSD PortfolioNAVUSD TotalCashPctNAV\nXXXX        TEST        USD              11/09/2012   85708860.21           1               85708860.21             370253861.3     23.15\nXXXX  Total NULL        NULL             NULL         85708860.21           NULL            NULL                    NULL            23.15\nZZZZ        TEST1       GBP              11/09/2012   48427.91              0.6225          77795.84                77795.84        100\nZZZZ        TEST2       GBP              11/09/2012   7772.61               0.6225          12486.12                12486.12        100\nZZZZ        TEST3       USD              11/09/2012   1832627.81            1               1832627.81              17343500.68     10.56\nZZZZ  Total NULL        NULL             NULL         1888828.33            NULL            NULL                    NULL            210.56\nGrand Total NULL        NULL             NULL         310273031.4           NULL            NULL                    NULL            1051.71\n</code></pre>\n\n<p>What i would like is for the NULLS to become '' so that only the Total label and the two summed totals are the only bits of data on that particular line, is this possible?</p>\n"},{"tags":["tsql","sybase"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12393427,"title":"Why does SQL JOIN allow duplicates but IN does not","body":"<p>Example scenario:</p>\n\n<p>TABLE_A contains a column called ID and also contains duplicate rows. There is another table called ID_TABLE that contains IDs. Assuming no duplicates in ID_TABLE -</p>\n\n<p>If I do:</p>\n\n<pre><code>SELECT * FROM TABLE_A\nINNER JOIN ID_TABLE ON ID_TABLE.ID = TABLE_A.ID\n</code></pre>\n\n<p>There will be duplicates in the result set. However, if I do:</p>\n\n<pre><code>SELECT * FROM TABLE_A\nWHERE TABLE_A.ID IN (SELECT ID_TABLE.ID FROM ID_TABLE)\n</code></pre>\n\n<p>There will not be any duplicates in the result set.</p>\n\n<p>Does anyone know why the <code>JOIN</code> clause allows duplicates while the <code>IN</code> clause does not? I had thought they did the same thing.</p>\n\n<p>Thanks</p>\n"},{"tags":["entity-framework","tsql","entity-framework-4","udf"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":104,"score":0,"question_id":12393085,"title":"Entity Framework scalar function mapping","body":"<p>I have scalar function:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[CheckLocation]\n(\n    @locationId Int\n)\nRETURNS bit\nAS\nBEGIN\n    //code\nEND\n</code></pre>\n\n<p>I want to use it in Entity Framework context.</p>\n\n<p>I have added this in the *.edmx file:</p>\n\n<pre><code>&lt;Function Name=\"CheckLocation\" ReturnType=\"bit\" Aggregate=\"false\" BuiltIn=\"false\" NiladicFunction=\"false\" IsComposable=\"true\" ParameterTypeSemantics=\"AllowImplicitConversion\" Schema=\"dbo\" &gt;\n&lt;Parameter Name=\"locationId\" Type=\"int\" Mode=\"In\" /&gt;\n&lt;/Function&gt;\n</code></pre>\n\n<p>I have also created a partial class with method decorated with EdmFunctionAttribute:</p>\n\n<pre><code>public partial class MainModelContainer\n{\n    [EdmFunction(\"MainModel.Store\", \"CheckLocation\")]\n    public bool CheckLocation(int locationId)\n    {\n        throw new NotSupportedException(\"Direct calls not supported\");\n    }\n}\n</code></pre>\n\n<p>I try to use this function like this:</p>\n\n<pre><code>Context.CheckLocation(locationId);\n</code></pre>\n\n<p>And get NotSupportedException(\"Direct calls not supported\").\nIt works within Select method, but it does not suit me.\nHelp please!\nHow can I call this function without select method?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":113,"score":0,"question_id":12374616,"title":"sql Trigger: select the FK from another table before insert","body":"<p>I have two database tables. </p>\n\n<ol>\n<li><code>tblTeams</code>: <code>PK TeamID</code>,<code>TeamName</code> </li>\n<li><code>tblMatches</code>: <code>PK match id</code>,<code>FK HomeTeam</code>,<code>FK AwayTeam,Score</code>. </li>\n</ol>\n\n<p>I am using SQL Server 2008 and I am importing rows through the Wizard from a <code>.csv</code> file. The columns in the <code>csv</code> are <code>hometeam</code>,<code>awayteam</code>,<code>score</code>. Thus, before inserting in the <code>tblMatches</code>, I want a trigger that finds the FK of the team and inserts in the <code>tblMatches</code> the foreign key and not the name. </p>\n\n<p>Any help with that please. </p>\n\n<pre><code>CREATE TRIGGER tblmatches_BeforeInsert\nON tblmatches\nBEFORE INSERT\nAS \nBEGIN\n    INSERT  tblmatches\n    SELECT  teamName\n    FROM    tblmatches\n    WHERE   tblTeams.id = ?i dont know here what to insert? \nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2","greatest-n-per-group"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":405,"score":1,"question_id":7597995,"title":"SQL return max value from child for each parent row","body":"<p>I have 2 tables - 1 with parent records, 1 with child records.  For each parent record, I'm trying to return a single child record with the MAX(SalesPriceEach). </p>\n\n<p>Additionally I'd like to only return a value when there is more than 1 child record.</p>\n\n<pre><code>parent - SalesTransactions table:\n+-------------------+---------+\n|SalesTransaction_ID|   text  |\n+-------------------+---------+\n| 1                 |  Blah   |\n| 2                 |  Blah2  |\n| 3                 |  Blah3  |\n+-------------------+---------+\n\nchild - SalesTransactionLines table \n+--+-------------------+---------+--------------+\n|id|SalesTransaction_ID|StockCode|SalesPriceEach|\n+--+-------------------+---------+--------------+\n| 1|   1               |  123    | 99           |\n| 2|   1               |   35    | 50           |\n| 3|   2               |   15    | 75           |\n+--+-------------------+---------+--------------+\n\n\n desired results\n+-------------------+---------+--------------+\n|SalesTransaction_ID|StockCode|SalesPriceEach|\n+-------------------+---------+--------------+\n|   1               |  123    | 99           |\n|   2               |   15    | 75           |\n+-------------------+---------+--------------+\n</code></pre>\n\n<p>I found a very similar question <a href=\"http://stackoverflow.com/questions/1563148/one-to-many-query-selecting-all-parents-and-single-top-child-for-each-parent\">here</a>, and based my query on the answer but am not seeing the results I expect.</p>\n\n<pre><code>WITH max_feature AS (\n   SELECT c.StockCode,\n          c.SalesTransaction_ID,\n          MAX(c.SalesPriceEach)  as feature\n     FROM SalesTransactionLines c\n GROUP BY c.StockCode, c.SalesTransaction_ID)\n   SELECT p.SalesTransaction_ID,\n          mf.StockCode,\n          mf.feature\n     FROM SalesTransactions p\nLEFT JOIN max_feature mf ON mf.SalesTransaction_ID = p.SalesTransaction_ID\n</code></pre>\n\n<p>The results from this query are returning multiple rows for each parent, and not even the highest value first! </p>\n"},{"tags":["query","tsql","sql-management-studio"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":85,"score":1,"question_id":12387873,"title":"TSQL Query returns values for each hour for the past 24 hours","body":"<p>I have a query that I don't really know how to begin with. I'm hoping someone can help me out with it. I will start by explaining the table</p>\n\n<p>I have a device table with four columns: Device_Id, Device_Status, Begin_dt, End_dt\nthere are 6 different statuses where 3 (for simplicity lets say status 1, 4 and 5) mean the device is 'online'</p>\n\n<p>an example of this table could be</p>\n\n<pre><code>Id | Status| Begin                   |  End\n001|     1 | 2012-09-01 00:00:00.000 | 2012-09-01 01:00:00.000\n001|     2 | 2012-09-01 01:00:00.000 | 2012-09-01 01:35:00.000\n001|     1 | 2012-09-01 01:35:00.000 | 2012-09-01 02:05:00.000\n003|     1 | 2012-09-01 05:00:00.000 | 2012-09-01 07:02:00.000\n004|     1 | 2012-09-01 01:00:00.000 | 2012-09-01 01:35:00.000\n003|     2 | 2012-09-01 07:02:00.000 | NULL\n</code></pre>\n\n<p>My query needs to return the Sum of the TIME all the devices have a status that indicates 'online' for each hour in a 24 hour period.</p>\n\n<p>so my return should look like</p>\n\n<pre><code>Hour| Online_Time\n0   | 5:30:12.11\n1   | 3:30:12.11\n2   | 4:30:12.11\n3   | 5:30:12.11\n4   | 6:30:12.11\n5   | 4:00:00.00\n6   | 1:30:12.11\n7   | 3:30:12.11\n8   | 4:30:12.11\netc |\n</code></pre>\n\n<p>So for each hour of the day I can have more than 1 hour of online time (obviously) because for example if I have 5 devices all online for the whole hour I would have 5 hours of online time for that hour.</p>\n\n<p>This is kind of complex and I hope I did a good job of explaining it, anyone that can help or give a suggestion is greatly appreciated.</p>\n\n<p>-J</p>\n\n<hr>\n\n<pre><code>with const as (\n    select dateadd(hour, 1, cast(cast(getdate() -1 as date) as datetime)) as midnnight\n    ),\nallhours as (\n    select 0 as hour, midnight as timestart, dateadd(hour, 1, timestart) as timeend from const union all\n    select 1 as hour, dateadd(hour, 1, midnight), dateadd(hour, 2, midnight) from const union all\n    select 2 as hour, dateadd(hour, 2, midnight), dateadd(hour, 3, midnight) from const union all\n    select 3 as hour, dateadd(hour, 3, midnight), dateadd(hour, 4, midnight) from const union all\n    select 4 as hour, dateadd(hour, 4, midnight), dateadd(hour, 5, midnight) from const union all\n    select 5 as hour, dateadd(hour, 5, midnight), dateadd(hour, 6, midnight) from const union all\n    select 6 as hour, dateadd(hour, 6, midnight), dateadd(hour, 7, midnight) from const union all\n    select 7 as hour, dateadd(hour, 7, midnight), dateadd(hour, 8, midnight) from const union all\n    select 8 as hour, dateadd(hour, 8, midnight), dateadd(hour, 9, midnight) from const union all\n    select 9 as hour, dateadd(hour, 9, midnight), dateadd(hour, 10, midnight) from const union all\n    select 10 as hour, dateadd(hour, 10, midnight), dateadd(hour, 11, midnight) from const union all\n    select 11 as hour, dateadd(hour, 11, midnight), dateadd(hour, 12, midnight) from const union all\n    select 12 as hour, dateadd(hour, 12, midnight), dateadd(hour, 13, midnight) from const union all\n    select 13 as hour, dateadd(hour, 13, midnight), dateadd(hour, 14, midnight) from const union all\n    select 14 as hour, dateadd(hour, 14, midnight), dateadd(hour, 15, midnight) from const union all\n    select 15 as hour, dateadd(hour, 15, midnight), dateadd(hour, 16, midnight) from const union all\n    select 16 as hour, dateadd(hour, 16, midnight), dateadd(hour, 17, midnight) from const union all\n    select 17 as hour, dateadd(hour, 17, midnight), dateadd(hour, 18, midnight) from const union all\n    select 18 as hour, dateadd(hour, 18, midnight), dateadd(hour, 19, midnight) from const union all\n    select 19 as hour, dateadd(hour, 19, midnight), dateadd(hour, 20, midnight) from const union all\n    select 20 as hour, dateadd(hour, 20, midnight), dateadd(hour, 21, midnight) from const union all\n    select 21 as hour, dateadd(hour, 21, midnight), dateadd(hour, 22, midnight) from const union all\n    select 22 as hour, dateadd(hour, 22, midnight), dateadd(hour, 23, midnight) from const union all\n    select 23 as hour, dateadd(hour, 23, midnight), dateadd(hour, 24, midnight) from const union all\n   ) \nselect ah.hour,\n   sum(datediff(ms, (case when ah.timestart &gt;= dt.Begin_Dt then timestart else dt.Begin_Dt end),\n                    (case when ah.timeend &lt;= dt.End_Dt then ah.timeend else dt.End_Dt end))) as totalms,\n   cast(dateadd(ms, sum(datediff(ms, (case when ah.timestart &gt;= dt.Begin_Dt then timestart else dt.Begin_Dt end),\n                                 (case when ah.timeend &lt;= dt.End_Dt then ah.timeend else dt.End_Dt end))),0) as time\n                                 ) as totalTime\nfrom allhours as ah left outer join\n     dataTable as dt\n     on ah.timestart&lt; coalesce(dt.End_dt, getdate()) and\n        ah.timeend &gt;= dt.Begin_Dt\ngroup by ah.hour\norder by ah.hour\n</code></pre>\n\n<hr>\n\n<p>This is what I have right now, I'm getting an error on the ')'</p>\n\n<pre><code>select 23 as hour, dateadd(hour, 23, midnight), dateadd(hour, 24, midnight) from const union all\n   )  &lt;----- Incorrect syntax near ')'. Expecting SELECT, or '('.\nselect ah.hour,\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":8975,"score":4,"question_id":1764374,"title":"Convert number to varchar in SQL with formatting","body":"<p>Is there a way in T-SQL to convert a TINYINT to VARCHAR with custom number formatting?\nFor instance, my TINYINT has a value of 3 and I want to convert it to a VARCH of 03, so that it always shows a 2 digit number.</p>\n\n<p>I don't see this ability in the CONVERT function.</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":9562,"score":2,"question_id":898658,"title":"Format minutes into hours and minutes as a decimal number in T-SQL","body":"<p>Is there a clean and simple method of formatting an integer which is a count of a whole number of minutes into a decimal representation of hours and minutes. It's a great shame that there is not such thing as a Timespan in T-SQL to support this. </p>\n\n<p>Just to be clear what I mean by this is if I have 70 minutes, I want to covert it into a representation of 1 hour and 10 minutes i.e. <code>1.10</code>. I'll also want to keep it as a varchar or something to ensure that the trailing zero is kept in place.</p>\n\n<p>Is there anyway that this could be created as a custom function in SQL so that it can be resused from different queries?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":88,"score":0,"question_id":12391176,"title":"Matching multiple conditions in T-SQL stored procedure","body":"<p>I'm forced to work with a table with the following structure (ScheduledEmails) and am looking to find the most efficient way to deal with multiple variables being set to 1 (true)</p>\n\n<p>The script below will only return the correct value if only one is selected.</p>\n\n<p>Could anybody recommend a way to modify the bottom query to accomodate multiple conditions.</p>\n\n<blockquote>\n  <p>e.g. where @IsMonday and @IsTuesday is true etc.?</p>\n</blockquote>\n\n<p>I have tried multiple combinations of AND/OR but none seem to yield the desired result.</p>\n\n<pre><code>DECLARE @IsMonday bit\nDECLARE @IsTuesday bit\nDECLARE @IsWednesday bit\nDECLARE @IsThursday bit\nDECLARE @IsFriday bit\nDECLARE @IsSaturday bit\nDECLARE @IsSunday bit\nDECLARE @Is0000 bit\nDECLARE @Is0100 bit\nDECLARE @Is0200 bit\nDECLARE @Is0300 bit\nDECLARE @Is0400 bit\nDECLARE @Is0500 bit\nDECLARE @Is0600 bit\nDECLARE @Is0700 bit\nDECLARE @Is0800 bit\nDECLARE @Is0900 bit\nDECLARE @Is1000 bit\nDECLARE @Is1100 bit\nDECLARE @Is1200 bit\nDECLARE @Is1300 bit\nDECLARE @Is1400 bit\nDECLARE @Is1500 bit\nDECLARE @Is1600 bit\nDECLARE @Is1700 bit\nDECLARE @Is1800 bit\nDECLARE @Is1900 bit\nDECLARE @Is2000 bit\nDECLARE @Is2100 bit\nDECLARE @Is2200 bit\nDECLARE @Is2300 bit\n\nDECLARE @dayOfWeek VARCHAR(20)\nDECLARE @hourOfDay int\n\nSET @dayOfWeek = datename(dw,GETDATE()) -- Monday to Sunday\nSET @hourOfDay = datepart(hh, GETDATE()) -- Single digit 0 - 23\n\nSET @IsMonday = CASE WHEN @dayOfWeek = 'Monday' THEN 1 ELSE 0 END\nSET @IsTuesday = CASE WHEN @dayOfWeek = 'Tuesday' THEN 1 ELSE 0 END\nSET @IsWednesday = CASE WHEN @dayOfWeek = 'Wednesday' THEN 1 ELSE 0 END\nSET @IsThursday = CASE WHEN @dayOfWeek = 'Thursday' THEN 1 ELSE 0 END\nSET @IsFriday = CASE WHEN @dayOfWeek = 'Friday' THEN 1 ELSE 0 END\nSET @IsSaturday = CASE WHEN @dayOfWeek = 'Saturday' THEN 1 ELSE 0 END\nSET @IsSunday = CASE WHEN @dayOfWeek = 'Sunday' THEN 1 ELSE 0 END\nSET @Is0000 = CASE WHEN @hourOfDay = 0 THEN 1 ELSE 0 END\nSET @Is0100 = CASE WHEN @hourOfDay = 1 THEN 1 ELSE 0 END\nSET @Is0200 = CASE WHEN @hourOfDay = 2 THEN 1 ELSE 0 END\nSET @Is0300 = CASE WHEN @hourOfDay = 3 THEN 1 ELSE 0 END\nSET @Is0400 = CASE WHEN @hourOfDay = 4 THEN 1 ELSE 0 END\nSET @Is0500 = CASE WHEN @hourOfDay = 5 THEN 1 ELSE 0 END\nSET @Is0600 = CASE WHEN @hourOfDay = 6 THEN 1 ELSE 0 END\nSET @Is0700 = CASE WHEN @hourOfDay = 7 THEN 1 ELSE 0 END\nSET @Is0800 = CASE WHEN @hourOfDay = 8 THEN 1 ELSE 0 END\nSET @Is0900 = CASE WHEN @hourOfDay = 9 THEN 1 ELSE 0 END\nSET @Is1000 = CASE WHEN @hourOfDay = 10 THEN 1 ELSE 0 END\nSET @Is1100 = CASE WHEN @hourOfDay = 11 THEN 1 ELSE 0 END\nSET @Is1200 = CASE WHEN @hourOfDay = 12 THEN 1 ELSE 0 END\nSET @Is1300 = CASE WHEN @hourOfDay = 13 THEN 1 ELSE 0 END\nSET @Is1400 = CASE WHEN @hourOfDay = 14 THEN 1 ELSE 0 END\nSET @Is1500 = CASE WHEN @hourOfDay = 15 THEN 1 ELSE 0 END\nSET @Is1600 = CASE WHEN @hourOfDay = 16 THEN 1 ELSE 0 END\nSET @Is1700 = CASE WHEN @hourOfDay = 17 THEN 1 ELSE 0 END\nSET @Is1800 = CASE WHEN @hourOfDay = 18 THEN 1 ELSE 0 END\nSET @Is1900 = CASE WHEN @hourOfDay = 19 THEN 1 ELSE 0 END\nSET @Is2000 = CASE WHEN @hourOfDay = 20 THEN 1 ELSE 0 END\nSET @Is2100 = CASE WHEN @hourOfDay = 21 THEN 1 ELSE 0 END\nSET @Is2200 = CASE WHEN @hourOfDay = 22 THEN 1 ELSE 0 END\nSET @Is2300 = CASE WHEN @hourOfDay = 23 THEN 1 ELSE 0 END\n\nINSERT INTO ScheduledEmailQueue (ScheduledEmailId, Created)\nSELECT Id, GETDATE() FROM ScheduledEmails WHERE \n(SendMonday = @IsMonday AND\nSendTuesday = @IsTuesday AND\nSendWednesday = @IsWednesday AND\nSendThursday= @IsThursday AND\nSendFriday = @IsFriday AND\nSendSaturday = @IsSaturday AND\nSendSunday = @IsSunday AND\nSend0000 = @Is0000 AND\nSend0100 = @Is0100 AND \nSend0200 = @Is0200 AND \nSend0300 = @Is0300 AND \nSend0400 = @Is0400 AND \nSend0500 = @Is0500 AND \nSend0600 = @Is0600 AND \nSend0700 = @Is0700 AND \nSend0800 = @Is0800 AND \nSend0900 = @Is0900 AND \nSend1000 = @Is1000 AND \nSend1100 = @Is1100 AND \nSend1200 = @Is1200 AND \nSend1300 = @Is1300 AND \nSend1400 = @Is1400 AND \nSend1500 = @Is1500 AND \nSend1600 = @Is1600 AND \nSend1700 = @Is1700 AND \nSend1800 = @Is1800 AND \nSend1900 = @Is1900 AND \nSend2000 = @Is2000 AND \nSend2100 = @Is2100 AND \nSend2200 = @Is2200 AND \nSend2300 = @Is2300)\n\nSELECT Id, GETDATE() FROM ScheduledEmails WHERE \nSendMonday= @IsMonday AND\nSendTuesday = @IsTuesday AND\nSendWednesday = @IsWednesday AND\nSendThursday= @IsThursday AND\nSendFriday = @IsFriday AND\nSendSaturday = @IsSaturday AND\nSendSunday = @IsSunday AND\nSend0000 = @Is0000 AND\nSend0100 = @Is0100 AND \nSend0200 = @Is0200 AND \nSend0300 = @Is0300 AND \nSend0400 = @Is0400 AND \nSend0500 = @Is0500 AND \nSend0600 = @Is0600 AND \nSend0700 = @Is0700 AND \nSend0800 = @Is0800 AND \nSend0900 = @Is0900 AND \nSend1000 = @Is1000 AND \nSend1100 = @Is1100 AND \nSend1200 = @Is1200 AND \nSend1300 = @Is1300 AND \nSend1400 = @Is1400 AND \nSend1500 = @Is1500 AND \nSend1600 = @Is1600 AND \nSend1700 = @Is1700 AND \nSend1800 = @Is1800 AND \nSend1900 = @Is1900 AND \nSend2000 = @Is2000 AND \nSend2100 = @Is2100 AND \nSend2200 = @Is2200 AND \nSend2300 = @Is2300\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12389643,"title":"osql.exe can't read special characters","body":"<p>Hi I am trying to make some update using osql.exe against a sql file which has some special characters.\nBut the actual update ends up having some funny characters instead of the special characters.\nSample sql is below:</p>\n\n<pre><code>  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'CA', 3, N'Automtic')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'CS', 3, N'Automatick')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'DA', 3, N'Automatgear')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'DE', 3, N'Automatik')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'EL', 3, N'')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'EN', 3, N'Automatic')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'ES', 3, N'Automtico')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'FR', 3, N'Automatique')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'HU', 3, N'Automata')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'IT', 3, N'Cambio automatico')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'NL', 3, N'Automatisch')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'PL', 3, N'Automatyczna')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'PT', 3, N'Automtico')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'A', N'TR', 3, N'Otomatik')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'CA', 2, N'2 portes')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'CS', 2, N'2dveov')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'DA', 2, N'2-drs')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'DE', 2, N'2-Tren')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'EL', 2, N'2-')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'EN', 2, N'2-Door')\n  INSERT [dbo].[TableName] ([Code], [Culture], [Position], [CodeDescription]) VALUES (N'B', N'ES', 2, N'2-puertas')\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":169,"score":3,"question_id":12387559,"title":"SELECT from 3rd comma in string","body":"<p>I have the following string:</p>\n\n<pre><code>bzip2,1,668,sometext,foo,bar\n</code></pre>\n\n<p>How can I SELECT only <code>sometext,foo,bar</code>? The length of the string preceding the 3rd comma may differ and there may be commas within <code>sometext,foo,bar</code>.</p>\n\n<p>I'd like this in as concise code as possible, i.e. preferably 1 line of code, no loops. But feel free to post any solution you think of.</p>\n"},{"tags":["sql","tsql","variables"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":20,"score":0,"question_id":12390168,"title":"How do assign a value to a variable from the result of a select statement?","body":"<pre><code>SELECT TOP 1 [FirstName], [LastName]\nFROM [table]\n\nDECLARE @firstName VARCHAR(25)\n</code></pre>\n\n<p>After I run the query above, I want to assign [FirstName] that is brought back from the query to @firstName.</p>\n\n<p>How do I do this?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":66,"score":0,"question_id":12389284,"title":"Inner join returning more rows then exist in tables","body":"<p>Till today my thoughts about the inner join were it will return the minimum number of rows that exist in tables satisfying a joining condition.</p>\n\n<p><strong>Ex.</strong> if <strong>table A</strong> contains 4 rows and <strong>table B</strong> contains 7 rows . i was expecting that 4 rows can be the maximum output if they satisfy the joining condition.</p>\n\n<p>I just wrote an sp in which i was creating two temporary tables and was populating them. then i took an inner join of them but returning more rows (In my case 29 rows were returned i was expecting 4)\nAfter some search i found this \n<a href=\"http://blog.sqlauthority.com/2012/02/09/sql-server-inner-join-returning-more-records-than-exists-in-table/\" rel=\"nofollow\"> link</a></p>\n\n<p>which confirms that i can happen but i still wonder what are <strong>my options</strong> to limit the returned result.</p>\n\n<p>Below is my stored procedure.</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[GetDDFDetailOnSiteCol]\n@siteId int,\n@colNum int\nAS\nBEGIN\nSET NOCOUNT ON;\n\ncreate Table #portDetail\n(\nddfId int,\nportDetail nvarchar(50),\nsiteId int\n)\nInsert into #portDetail SELECT  ddf.id,  ddf.portDetail, site.Site_ID  from site\n        inner join ddf ON site.Site_ID = ddf.siteCodeID \n        where ddf.siteCodeID = @siteId and ddf.colNo= @colNum\n        order by colNo,blockNum,portRowNum,portColNum\n\ncreate Table #portAllocationDetail\n(\nassigned_slot nvarchar(50),\nsiteId int\n)\nInsert into #portAllocationDetail \nSELECT  dbo.portList.assigned_slot, dbo.site.Site_ID\nFROM dbo.portList INNER JOIN\n dbo.site ON dbo.portList.siteCodeID = dbo.site.Site_ID\n where dbo.site.Site_ID = @siteId\n\n--select * from #portAllocationDetail   \nSelect #portDetail.ddfId,#portDetail.portDetail,#portAllocationDetail.siteId,#portAllocationDetail.assigned_slot FROM #portDetail \nINNER JOIN #portAllocationDetail \nON\n#portDetail.siteId = #portAllocationDetail.siteId\nEND\n</code></pre>\n"},{"tags":["sql-server","xml","tsql","sql-server-2000"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12386447,"title":"SQL Server 2000 - extract data from XML stored in VARCHAR","body":"<p>Similar to <a href=\"http://stackoverflow.com/questions/8254778/getting-xml-data-stored-in-a-varchar-out-of-sql\">Getting xml data stored in a varchar out of SQL</a> I need extract a value from an XML string stored in a <code>VARCHAR</code> column.</p>\n\n<p>However, the data is on SQL Server 2000 and therefore the XML type cannot be used.</p>\n\n<p>Is this possible in SQL Server 2000?</p>\n\n<p>e.g. for the following XML, how can I select the values in the <code>&lt;status&gt;</code> nodes:</p>\n\n<pre><code>&lt;entities&gt;\n    &lt;entity&gt;\n        &lt;name&gt;foo&lt;/name&gt;\n        &lt;status&gt;1&lt;/status&gt;\n    &lt;/entity&gt;\n    &lt;entity&gt;\n        &lt;name&gt;bar&lt;/name&gt;\n        &lt;status&gt;2&lt;/status&gt;\n    &lt;/entity&gt;\n&lt;/entities&gt;\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":12387156,"title":"BZip decompress","body":"<p>Is there a way to decompress a BZip2 compressed string in MS SQL? Other than using <code>xp_cmdshell</code> and running it through bzip2.exe?</p>\n\n<p>I have a string like <code>BZh41AY&amp;SY3 !]B@/&gt;</code> this is simply 'test'</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":21,"score":0,"question_id":12386607,"title":"Test for rows on linked Oracle server from SQL Server","body":"<p>I get a syntax error with this TSQL:</p>\n\n<pre><code>if exists ( exec('select * from mytable') at LinkedOracleServer ) begin\n    print 'rows exist'\nend\n</code></pre>\n\n<p>I can't use INSERT EXEC into a temp table because the calling proc also uses INSERT EXEC and I get the error \"An INSERT EXEC statement cannot be nested.\"</p>\n\n<p>Is there another way to test for existing rows on a linked server?</p>\n"},{"tags":["tsql","table","triggers","metadata"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":19,"score":0,"question_id":12386363,"title":"Is it possible to determine the source table from the inserted table in a trigger?","body":"<p>If I wanted to write one trigger that would record and insert, update or delete on any table in our database, how would I determine the source table of the event?</p>\n\n<p>Can it be determined from the meta data of the inserted table or is there another way to do the same thing?</p>\n"},{"tags":["sql","sql-server","tsql","distinct"],"answer_count":4,"favorite_count":16,"up_vote_count":37,"down_vote_count":2,"view_count":28969,"score":35,"question_id":966176,"title":"SELECT DISTINCT on one column","body":"<p>Using SQL Server, I have...</p>\n\n<pre><code>ID  SKU\tPRODUCT\n=======================\n1   FOO-23\tOrange\n2   BAR-23\tOrange\n3   FOO-24\tApple\n4   FOO-25\tOrange\n</code></pre>\n\n<p>I want </p>\n\n<pre><code>1   FOO-23\tOrange\n3   FOO-24\tApple\n</code></pre>\n\n<p>This query isn't getting me there. How can I SELECT DISTINCT on just one column?</p>\n\n<pre><code>SELECT \n[ID],[SKU],[PRODUCT]\nFROM [TestData] \nWHERE ([PRODUCT] = \n(SELECT DISTINCT [PRODUCT] FROM [TestData] WHERE ([SKU] LIKE 'FOO-%')) \nORDER BY [ID]\n</code></pre>\n"},{"tags":["xml","tsql","xml-dml"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":12384418,"title":"Can't modify XML node's value in T-SQL (ms sql)","body":"<p>I would like to modify my xml's node value in mssql, but my approach doesn't seem to work.</p>\n\n<p><strong>Here is an xml sample:</strong></p>\n\n<pre><code>&lt;xml&gt;\n  &lt;ProjectManager&gt;\n    &lt;People&gt;\n      &lt;DisplayNames&gt;John Smith&lt;/DisplayNames&gt;\n      &lt;LoginNames&gt;ABC\\jsmith&lt;/LoginNames&gt;\n    &lt;/People&gt;\n  &lt;/ProjectManager&gt;\n&lt;/xml&gt;\n</code></pre>\n\n<p><strong>The part of my function:</strong></p>\n\n<pre><code>CREATE FUNCTION [dbo].[MyFunc](\n    @properties xml, \n    @key nvarchar(50),\n    @newvalue nvarchar(max), \n    @datatype nvarchar(50) = null,\n    @node nvarchar(50) = null) \n    RETURNS xml\nWITH SCHEMABINDING\nAS BEGIN \n    DECLARE @temp XML = @properties\n\n    IF LOWER(@datatype) = 'people' \n        SET @temp.modify('replace value of (/xml/*[local-name() = sql:variable(\"@key\")][1]/People/*[local-name() = sql:variable(\"@node\")]/text())[1] with sql:variable(\"@newvalue\")')\n\nRETURN @temp;\nEND\n</code></pre>\n\n<p><strong>Calling the function:</strong></p>\n\n<pre><code>set @result = dbo.MyFunc(@myXML,'ProjectManager','Somebody','People','DisplayName')\n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12382613,"title":"Unable to select 'n' records in each item category with paging","body":"<p>I am trying to select 5 records in each ItemCategoryID with paging, with the query below I am able to get 5 records in each category but paging is not working, as i have declared page size 10, but i am getting 19 records and @ItemCounter TotalCount is coming as 45... i m not getting how to solve it..here is the query:</p>\n\n<pre><code>DECLARE @PageIndex int = 1\nDECLARE @PageSize int = 10\nDECLARE @StartRow int\nDECLARE @EndRow int\nSET @StartRow = (@PageSize * (@PageIndex - 1))  + 1  \nSET @EndRow = @PageSize * @PageIndex + 1\nDECLARE @ItemCounter int\nSELECT @ItemCounter = Count(*)FROM dbo.Auctions WHERE AuctionStatus=1;\nWITH Auctions AS\n    (\n        SELECT  ROW_NUMBER() OVER \n        (PARTITION BY ItemCategoryID  ORDER BY AuctionID) AS RowNumber,                 \n            AuctionID, \n            ItemCategoryID  ,                             \n            @ItemCounter TotalCount                         \n            FROM Auctions                 \n            WHERE                 \n            AuctionStatus=1 \n     )\n\n    SELECT a.* FROM Auctions a  \n    WHERE  a.RowNumber &lt;=3 AND a.RowNumber \n    BETWEEN @StartRow AND @EndRow - 1\n</code></pre>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":134,"score":0,"question_id":12379466,"title":"SQL - Seconds to Day, Hour, Minute, Second","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/2316288/efficient-way-to-convert-second-to-minute-and-seconds-in-sql-server-2005\">Efficient way to convert second to minute and seconds in sql server 2005</a>  </p>\n</blockquote>\n\n\n\n<p>I have a query which needs to return the second in Day, Hour, Minute, Second format.</p>\n\n<p>The below code works fine when its less than a day, but does not work, when the value in second is greater than a day</p>\n\n<pre><code>PRINT Convert(VarChar, DateAdd(S, 86400, 0), 108)\n</code></pre>\n\n<p>86400 is exactly a day and it returns 00:00:00</p>\n\n<p>Can someone modify it and show me the result something like this</p>\n\n<pre><code>1:00:00:00.\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","tsql","loops"],"answer_count":11,"favorite_count":10,"up_vote_count":42,"down_vote_count":0,"view_count":120697,"score":42,"question_id":61967,"title":"Is there a way to loop through a table variable in TSQL without using a cursor?","body":"<p>Let's say I have the following simple table variable:</p>\n\n<pre><code>declare @databases table\n(\n    DatabaseID    int,\n    Name        varchar(15),   \n    Server      varchar(15)\n)\n-- insert a bunch rows into @databases\n</code></pre>\n\n<p>Is declaring and using a cursor my only option if I wanted to iterate through the rows? Is there another way?</p>\n"},{"tags":["sql","tsql","select"],"answer_count":5,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":93,"score":3,"question_id":12375486,"title":"How do I SELECT TOP X where it INCLUDES records based on a criteria?","body":"<p>I have a table, with multiple columns, including a column named \"PolicyNumber\"</p>\n\n<p>Here's a sample:</p>\n\n<pre><code>PolicyNumber\n\nNYH1111\nNYD2222\nSCH3333\nSCS4444\nLUH5555\nLUS6666\nALH7777\nALW8888\nVAH9999\nAKH0000\n...\nNYH1010\nNYD2318\n</code></pre>\n\n<p>There are 1,000+ records in this table and records contain several of each policy number types. For example, multiple policies starting with \"NYH\" or multiple policies starting with \"VAH.\"</p>\n\n<p>The possible policy types are here:</p>\n\n<pre><code>NYH\nNYD\nSCH\nSCS\nLUH\nLUS\nALH\nALW\nVAH\nAKH\n</code></pre>\n\n<p>How do I do a SELECT TOP 300 where it'll INCLUDE at least one of each Policy Type? Remember, a policy type is the first 3 letters of a policy number.</p>\n\n<p>Is this even possible? The purpose of this is that I have to grab 300 records from production to dump into a test environment and I need to include at least 1 of each policy. After I have at least one of each, it can be completely randomized. </p>\n"},{"tags":["sql-server","sql-server-2008","tsql","recursion"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12364022,"title":"Recursive SQL Query","body":"<p>I have a bit of a messy dataset and I am needing to get all child accounts for a particular parent account. </p>\n\n<p>The table is as follows </p>\n\n<blockquote>\n  <p>Code (PK),  Name, ParentCode</p>\n</blockquote>\n\n<p>There are no foreign keys </p>\n\n<p>From what I can see if an account does not have a parent, the ParentCode is an empty string or it is set to be the same as the Code. </p>\n\n<p>I have been trying to follow <a href=\"http://msdn.microsoft.com/en-us/library/ms186243(v=sql.105).aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms186243(v=sql.105).aspx</a> but it seems to be returning all the data, plus I cannot work out how I can get the children for just one account. </p>\n\n<pre><code>WITH DirectReports (ParentCus, Code, Name, Level)\nAS\n(\n    SELECT ParentCode, Code, Name, 0 AS Level\n    FROM Customers\n      WHERE Code = ParentCode OR Code = ''\n    UNION ALL\n\n    SELECT c.ParentCode, c.Code, c.Name, level + 1\n    FROM Customers AS C\n    INNER JOIN DirectReports AS d\n        ON c.ParentCode = d.Code\n        where c.Code != d.Code\n)\nSELECT ParentCus, Code, Name, Level\nFROM DirectReports\n</code></pre>\n\n<p><em><strong>EDIT</em></strong>\nTo be clear I need to be able pass my function a Code and return all (recursively) that's accounts child accounts.</p>\n\n<p><em><strong>Final Code</em></strong>\nI had to make a slight change to the answer but here is the final working code </p>\n\n<pre><code>declare @t table(code varchar(10), name varchar(10), parentcode varchar(10))\ninsert @t values(1, 'navn1', '1')\ninsert @t values(2, 'navn2', '')\ninsert @t values(3, 'navn3', 1)\ninsert @t values(4, 'navn4', 3)\ninsert @t values(5, 'navn5',4)\ninsert @t values(6, 'navn6', 2)\ninsert @t values(7, 'navn7', 3)\n\ndeclare @code varchar(10) -- or however code/parentcode is declared\nset @code = '1'           -- the parentcode you are trying to isolate\n\n;WITH DirectReports (ParentCus, Code, Name, Level)\nAS\n(\n    SELECT ParentCode, Code, Name, 0 AS Level\n    FROM @t Customers\n    -- this picks the chosen code\n      WHERE Code = @code and (Code = ParentCode OR PARENTCode = '')\n    UNION ALL\n    SELECT c.ParentCode, c.Code, c.Name, level + 1\n    FROM\n        (select * from @t where  code !=  parentcode) --had to do this to account for an infinate loop\n        as C\n    INNER JOIN DirectReports AS d\n        ON c.ParentCode = d.Code\n\n)\nSELECT ParentCus, Code, Name, Level\nFROM DirectReports\n-- level &gt; 0: to ensure child accounts only\nwhere level &gt; 0\n</code></pre>\n"},{"tags":["xml","tsql","sql-server-2008-r2","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":130,"score":1,"question_id":12379236,"title":"How to query xml across multiple rows in SQLServer 2008R2","body":"<p>In a table, I have multiple rows, each containing xml based on common schema. An example of the XML might be:</p>\n\n<pre><code>&lt;Items&gt;\n    &lt;Item&gt;Item 1&lt;/Item&gt;\n    &lt;Item&gt;Item 2&lt;/Item&gt;\n&lt;/Items&gt;\n</code></pre>\n\n<p>If I have multiple rows in a table, all containing similar xml, is it possible to write a query that returns all values in the <code>Item</code> node for all rows, in a single resultset? We're using SQL Server 2008 R2</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":3,"view_count":78,"score":-2,"question_id":12377816,"title":"Using a select statement as one of the columns","body":"<p>I have a query:</p>\n\n<pre><code>select \n      index_imsid\n    , SUM(weighted_value) sumWeightedValue\n    , (\n        select \n              top 1 percentof\n            , [Plan_Name_OR_Payment_Type] \n        from [v_PlanPerProvider1] \n        where [PLAN_RANK]=1\n      ) plan1\nfrom [v_PlanPerProvider1]\nwhere plan_rank between 1 and 10\ngroup by index_imsid\norder by 1\n</code></pre>\n\n<p>and I am getting this error:</p>\n\n<blockquote>\n  <p><em>Msg 116, Level 16, State 1, Line 3<br>\n  Only one expression can be specified in the select list when the subquery is not introduced with EXISTS.</em></p>\n</blockquote>\n\n<p>Can you please help me to understand why I am getting this error?</p>\n\n<p>It appears that it does not like the select statement as one of the columns?</p>\n"},{"tags":["sql","tsql","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":138,"score":0,"question_id":12378825,"title":"T-SQL query to select last 3 months of data, last years month, averages of this month and average of all months","body":"<p>I have a table with columns <code>Category, Date, Monthly_Revenue</code>.  </p>\n\n<p>I need a query that will select <code>Todays_Month</code>, <code>Last_Month</code>, 2 months prior, <code>Last_years_Month</code>, average of today's month, average of all months.  </p>\n\n<p>This query is needed grouped by category.</p>\n\n<p>Example :   </p>\n\n<pre><code>Category | Sept, 2012 | Aug, 2012| Jul, 2012 | Sept, 2011 | Average of Sept | Avg all Mo\n</code></pre>\n\n<p>Being fairly new to SQL I still haven't got it yet. I figured see if somebody out there could take a crack at it. Thanks.</p>\n\n<p><strong>Sample data</strong> </p>\n\n<pre><code>'Burger'  '9/1/2012'   '500'\n'Fries'  '10/1/2012    '300'\n'Burger'  '6/1/2011'   '250'\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":5,"down_vote_count":0,"view_count":2773,"score":5,"question_id":2316288,"title":"Efficient way to convert second to minute and seconds in sql server 2005","body":"<p>Suppose I have 90 seconds. If I want to display the result in terms of minutes and second, I do it by using</p>\n\n<pre><code>select Time= '0' + CAST( 90/60 as varchar(2)) + ':' +  CAST( 90%60 as varchar(2)) \n</code></pre>\n\n<p>The output is</p>\n\n<blockquote>\n  <p>Time<br>\n   01:30</p>\n</blockquote>\n\n<p>I have appended 0(zero) because if you do a <code>select getdate()</code> the output will be </p>\n\n<blockquote>\n  <p>yyyy-mm-dd hh:mm:ss:ms</p>\n</blockquote>\n\n<p>What is the standard way and recommended practice to do such a conversion?</p>\n\n<p>Thanks</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":34,"score":1,"question_id":12377770,"title":"Calling a function on distinct values from table","body":"<p>I've got a SQL Server 2005 database.  I need to get distinct values in addition to calling a function on those distinct values.  I'm not sure how the distinct works when there is a function call involved.  For example, I have this query:</p>\n\n<pre><code>SELECT DISTINCT a, b, c, fcn_DoSomething(a, b, c) AS z FROM users\n</code></pre>\n\n<p>I'm guessing that the function (fcn_DoSomething) is being called for all of the values in the table, not the distinct values.  Am I correct?  If so, how can I write the query to call the function only on distinct values of a,b,c?  I know one option is to use a temporary table, but if anyone has better ideas that would be great.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3761,"score":1,"question_id":2150507,"title":"Is there any simple way to format decimals in T-SQL?","body":"<p>I know it could be done trivially in a non-SQL environment [post-data processing, frontend, what have you], but that's not possible at the moment. Is there a way to take a <code>decimal(5,2)</code> and convert it to a <code>varchar</code> without the trailing zeroes/decimal points? For example:</p>\n\n<pre><code>declare @number decimal(5,2)\nset @number = 123.00\nselect cast(@number as varchar) as FormattedNumber\n</code></pre>\n\n<p>And the result is '123.00'. Is there a (simple) way to get '123' instead? And likewise, instead of '123.30', '123.3'? Could do it by figuring out whether or not the hundredths/tenths places were 0 and manually trimming characters, but I wanted to know if there was a more elegant solution.</p>\n"},{"tags":["tsql","sql-server-2012"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12374115,"title":"find first row based on a cycle size","body":"<p>I have a table of cards and a table of moves (on a card), like:</p>\n\n<pre><code>declare @cards table\n(\n    id_card int,\n    cycle int\n)\n\ninsert into @cards (id_card, cycle) values (1, 10)\n\ndeclare @moves table\n(\n    id_move int,\n    id_card int,\n    quantity int\n)\n\ninsert into @moves (id_move, id_card, quantity) values (1, 1, 2)\ninsert into @moves (id_move, id_card, quantity) values (2, 1, 4)\ninsert into @moves (id_move, id_card, quantity) values (3, 1, 2)\ninsert into @moves (id_move, id_card, quantity) values (4, 1, 8)\ninsert into @moves (id_move, id_card, quantity) values (5, 1, 2)\n</code></pre>\n\n<p>The problem: each card gets a cycle size, and each move gets a quantity. So, a card cycle size 10 and 18 moves means 1 full cycle plus 8 moves. I have to find the last cycle first move (the move id 4 in the given example). The problem sounds (at first) trivial, but I'm getting so many troubles to find the move that I think I'm doing something very wrong.</p>\n\n<p>I came up with a query that gives where the last cycle first move starts position, but I'm not finding anywhere to go from there.</p>\n\n<pre><code>select\n    id_card,\n    case\n        when value &gt; quantity then value - quantity\n        else value\n    end value\nfrom\n(\n    select\n        f.id_card,\n        f.quantity,\n        f.quantity - f.quantity % cards.cycle + 1 value\n    from\n    (\n        select\n            id_card,\n            sum(quantity) quantity\n        from @moves\n        group by\n            id_card\n    ) f\n    join @cards cards on\n        cards.id_card = f.id_card\n) f\n</code></pre>\n\n<p>Expected output:</p>\n\n<pre><code>id_move\n4\n</code></pre>\n\n<p>Any ideas? I can make any modifications to make the problem easier.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":2,"view_count":80,"score":-2,"question_id":12377583,"title":"Referring to an alias instead of repeating the calculation","body":"<p>I have a query:</p>\n\n<pre><code>SELECT   [outer].*,\n         (total_pain_patients / NULLIF ((SELECT Sum(total_pain_patients)\n             FROM   [topplansperprovider]\n             WHERE  [outer].[INDEX_IMSID] = [INDEX_IMSID]\n             AND plan_rank BETWEEN 1 AND 10), 0)) * 100 AS PercentOf,\n         pm.*,\n         percentof * pm.score\nFROM     [topplansperprovider] AS [outer]\nleft JOIN [payer Mapping] pm\non lower([outer].Plan_Name_OR_Payment_Type)=lower(pm.[ims payer name])\nWHERE    INDEX_IMSID = '1753841'\nORDER BY 6 ASC\n</code></pre>\n\n<p>My problem is with selecting this:</p>\n\n<pre><code>percentof * pm.score\n</code></pre>\n\n<p>Since <code>percentof</code> is the alias of a derived column, I don't know how to use it in other columns.</p>\n\n<ol>\n<li>How do I select <code>percentof * pm.score</code>?</li>\n<li>If that is too difficult, how can I just add <code>percentof</code> as a permanent column to my table?</li>\n</ol>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":37,"score":-2,"question_id":12377163,"title":"How can I update a column in a table based on the result set of a different table?","body":"<p>This is along the lines of what I want to do:</p>\n\n<pre><code>UPDATE [table1]\nSET FirstName IN (SELECT [FirstName] FROM [table2]) \n</code></pre>\n\n<p>There are 300 names that I need to update on [table1] with and the names are in [table2]. The names are NULLS. They need to be names from [table2].</p>\n\n<p>The record set CAN be random. So no relationship needed between the tables.</p>\n\n<p>How would I go about doing this?</p>\n"},{"tags":["sql","tsql","temp"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":59,"score":1,"question_id":12376873,"title":"T-Sql getting data from tempdb table","body":"<p>I'm using Microsoft SQL Server 2008 R2 (RTM) - 10.50.1600.1 (X64) and I'm trying to make a <em>SELECT</em> statement to a table that have been created like this:</p>\n\n<pre><code>DECLARE @Sql AS VARCHAR(1500)\n\nSET @Sql = 'SELECT 1 AS id, ''123'' AS value INTO #tmp_prueba'\n\nEXECUTE ( @Sql )\n\nSELECT * FROM #tmp_prueba\n</code></pre>\n\n<p>But I'm noticed that the table not exists</p>\n\n<p>How can I get the data from the table?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","date"],"answer_count":6,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12371416,"title":"Working out a date from a single month number SQL","body":"<p>Got 2 parameters <code>@yr</code> and <code>@period</code>, <code>@period</code> is just the month number so July would equal 7 for example.</p>\n\n<p>In my stored procedure table I've got a column called <code>Date</code> which is just a standard <code>datetime</code> field. I need a <code>where</code> clause to work out all dates greater than the current period minus 1 year so if <code>@period = 7 and @yr = 2012</code> I want the <code>where</code> clause to return all dates greater than '01-07-2011' (UK date format) how can I achieve this with just the 2 numbers from <code>@period</code> and <code>@yr</code>.</p>\n\n<pre><code>WHERE &lt;br&gt;\nDate &gt;= '01-07-2011'\n</code></pre>\n"},{"tags":["tsql","ssis-data-transformations"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":12373868,"title":"Is There an SSIS Component that can perform dynamic updates during insertion?","body":"<p>I have a table with potentially billions of records. The requirement is to set certain fields for a group of records within the table to a previous value until that value changes, then replace the previous value with the new value.</p>\n\n<p>Consider the following as an example of the records being retrieved from the original source:</p>\n\n<p>EventSeqNo\n&nbsp;&nbsp;&nbsp;&nbsp;EventDesc\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DescId\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc2Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc3Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc4Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc5Id\n<br/>\n1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventOne\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n<br/>\n2\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventTwo\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2862\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n3\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventThree\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n<br/>\n6\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n<br/>\n1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventOne\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;105\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n<br/>\n2\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventTwo\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2873\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n3\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventThree\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;101\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;106\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n<br/>\n6\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>\n<br/>\nThe desired output after insertion into the final table would be:</p>\n\n<p>EventSeqNo\n&nbsp;&nbsp;&nbsp;&nbsp;EventDesc\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DescId\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc2Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc3Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc4Id\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desc5Id\n<br/>\n1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventOne\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n<br/>\n2\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventTwo\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2862\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n3\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventThree\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2862\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n6\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2862\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventOne\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;105\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n<br/>\n2\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventTwo\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2873\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;105\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n3\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventThree\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2873\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;101\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;106\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;131\n<br/>\n6\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2873\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;101\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 106\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;102\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  131\n<br/></p>\n\n<p>As you can see, each field should acquire the value of the previous field's record unless it is a value of one. Also, the range of records that repeat this rule are grouped and range from 1 through 6 as the Event value.</p>\n\n<p>Is there an SSIS component that can gracefully accomplish this task during the initial record insertions with minimal complexity as opposed to performing complex SQL updates to the table after it's population?</p>\n\n<p>It was suggested to me that the Cache Transform task may be the solution but after reading up on how to implement it, it doesn't seem to be the appropriate solution for the problem.</p>\n\n<p>If there isn't any SSIS package task that could accomodate as a solution, what are some other possible alternatives? I am open to any reasonable suggestions.</p>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","tsql","asp-classic"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12373911,"title":"Select distinct year from date fields in MSSQL","body":"<p>I'm doing some updates to an old Classic ASP website.  There is a table which contains several columns of text data and a datetime field.  I need to get a list of unique years from all of the values in the table.  I've tried this:</p>\n\n<pre><code>set objConnection = Server.CreateObject(\"ADODB.Connection\")\nobjConnection.ConnectionString = \"Provider=SQLNCLI10;Server=localhost;Database=mydb;Uid=myuser;Pwd=something;\"\nobjConnection.Open\n\nset objRst = objConnection.execute(\"SELECT DISTINCT(YEAR(report_date)) AS report_year FROM report;\")\nif not objRst.eof then\n    do while not objRst.eof\n        response.write objRst(\"report_year\")\n        objRst.movenext\n    loop\nend if\n</code></pre>\n\n<p>But when I run this script in the page it just does nothing - eventually the script times-out.</p>\n\n<p>Can anyone suggest how to accomplish this?  Thanks!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":12372914,"title":"Using ANY operator together with string functions","body":"<p>I want to build a query like this:</p>\n\n<pre><code>SELECT * FROM T1 WHERE Charindex(ANY(SELECT City FROM Cities),T1ADDRESS)&gt;0\n</code></pre>\n\n<p>As i understand, the <code>ANY</code> operator cannot stay as SQL functions argument. So, what is the alternative?</p>\n\n<p>Suppose I want to write a UDF that returns 1 or 0 dependent on one input argument <em>Address</em>. How do I do this without <code>for</code> loop operator and without accessing to <code>SELECT City FROM Cities</code> array by index, as it can be done easily in the procedural languages?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":124,"score":1,"question_id":12368893,"title":"SQL match function written by me taking too much time. Optimization required","body":"<p>This is the sample test data for which the function should return 1 for anything else it should return 0:</p>\n\n<pre><code>Inventor: Raj Patel\nAttorney: Raj Patel\n\nInventor: Patel; Raj\nAttorney: Patel\n\nInventor: Patel; R\nAttorney: Patel; Raj\n\nInventor: Patel; Raj, Madnani; Raj\nAttorney: Patel; Raj\n\nInventor: Patel; Raj\nAttorney: Patel; R\n\n\n**Eg.** Select dbo.Match('Patel; R','Patel; Raj')\n</code></pre>\n\n<p><strong>All these executions should return 1:</strong></p>\n\n<pre><code>Select dbo.Match('Raj Patel','Raj Patel')\nSelect dbo.Match('Patel; Raj','Patel')\nSelect dbo.Match('Patel; R',' Patel; Raj')\nSelect dbo.Match('Patel; Raj, Madnani; Raj','Patel; Raj')\nSelect dbo.Match('Patel; Raj','Patel; R')\n</code></pre>\n\n<p>should return 1</p>\n\n<p>This is my match function using too many cursors:</p>\n\n<pre><code>ALTER FUNCTION [dbo].[Match]\n(\n    @Subj1      varchar(8000),\n    @Subj2      varchar(8000)\n)\nRETURNS bit\nAS\nBEGIN\n    Set @Subj1 = IsNull(@Subj1,'')\n    Set @Subj2 = IsNull(@Subj2,'')\n\n    If @Subj1 = '' Or @Subj2 = ''\n    Begin\n        Return 0\n    End\n\n    If Lower(@Subj1) = Lower(@Subj2)\n    Begin\n        Return 1\n    End\n\n    Declare Subj1NamesCurr Cursor For --all separate names\n        Select * From dbo.Split(@Subj1,',')\n\n    Declare Subj2NamesCurr Cursor SCROLL For --all separate names\n        Select * From dbo.Split(@Subj2,',')\n\n    Open Subj1NamesCurr\n    Open Subj2NamesCurr\n\n    Declare @Sub1Names  varchar(8000)\n    Declare @Sub2Names  varchar(8000)\n    Declare @Sub1NamePart   varchar(8000)\n    Declare @Sub2NamePart   varchar(8000)\n    Declare @Sub1PartCount  tinyint = 0\n    Declare @Sub2PartCount  tinyint = 0\n    Declare @Sub1NamesPart  TABLE(Data varchar(8000))\n    Declare @Sub2NamesPart  TABLE(Data varchar(8000))\n    Declare @MatchCount int = 0\n    Declare @TempCount int = 0\n\n    Fetch From Subj1NamesCurr INTO @Sub1Names --fetch 1st name from 1st subject\n\n    Insert into @Sub1NamesPart\n            Select * From dbo.Split(@Sub1Names,';') --get names part from 1st subject's row\n\n    Select @Sub1PartCount = Count(*) From @Sub1NamesPart\n\n\n    While @@Fetch_Status = 0 --each names of 1st subject\n    Begin\n\n        Fetch First From Subj2NamesCurr into @Sub2Names\n\n        While @@Fetch_Status = 0 --each names of 1st subject\n        Begin\n            Declare Sub1NameCurr Cursor For\n                Select * From @Sub1NamesPart --name parts of 1st subject\n\n            OPEN Sub1NameCurr\n\n            Fetch From Sub1NameCurr into @Sub1NamePart\n\n            Insert into @Sub2NamesPart\n                Select * From dbo.Split(@Sub2Names,';') \n\n            Select @Sub2PartCount = Count(*) From @Sub2NamesPart\n            Set @MatchCount = 0\n\n            While @@Fetch_Status = 0 --splitted name of 1st subject\n            Begin\n\n                Declare Sub2NameCurr Cursor For\n                    Select * From @Sub2NamesPart  --name parts of 2nd subject\n\n                OPEN Sub2NameCurr\n\n                Fetch From Sub2NameCurr into @Sub2NamePart\n\n                Set @TempCount = 0\n\n                While @@Fetch_Status = 0 --splitted name of 2nd subject\n                Begin\n                    Set @TempCount = @TempCount + 1\n                    If dbo.Trim(Lower(@Sub1NamePart)) = dbo.Trim(Lower(@Sub2NamePart))\n                    Begin\n\n                        Set @MatchCount = @MatchCount + 1\n\n                        If @Sub2PartCount = 1\n                        Begin\n                            Return 1\n                        End\n                    End\n                    Else If Lower(Left(dbo.Trim(@Sub1NamePart),1)) = Lower(dbo.Trim(@Sub2NamePart)) Or \n                        Lower(Left(dbo.Trim(@Sub2NamePart),1)) = Lower(dbo.Trim(@Sub1NamePart))\n                    Begin\n\n                        Set @MatchCount = @MatchCount + 1\n                    End\n\n                    Fetch Next From Sub2NameCurr into @Sub2NamePart\n\n                    Delete from @Sub2NamesPart\n                    Insert into @Sub2NamesPart\n                        Select * From dbo.Split(@Sub2Names,';') \n                End\n\n                If @MatchCount = @Sub2PartCount\n                Begin\n                    Return 1\n                End\n\n                CLOSE Sub2NameCurr\n                DEALLOCATE Sub2NameCurr\n\n                Fetch Next From Sub1NameCurr into @Sub1NamePart\n\n                Delete from @Sub1NamesPart\n                Insert into @Sub1NamesPart\n                    Select * From dbo.Split(@Sub1Names,';') --get names part from 1st subject's row\n\n                Select @Sub1PartCount = Count(*) From @Sub1NamesPart                \n            End\n\n            CLOSE Sub1NameCurr\n            DEALLOCATE Sub1NameCurr\n\n        End\n    End\n\n    Close Subj1NamesCurr\n    Deallocate Subj1NamesCurr\n\n    Close Subj2NamesCurr\n    Deallocate Subj2NamesCurr   \n    Return 0\n\nEND\n</code></pre>\n\n<p><strong>Edit:</strong> To create no confusions, Trim is just a function that does a LTrim and RTrim over your string. That's about it.</p>\n"},{"tags":["tsql","grouping","rollup"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":33,"score":0,"question_id":12355433,"title":"Multiple Groupings inside a case statement & ordering","body":"<p>I'm currently working on an aggregation stored proc and my final select looks like this:</p>\n\n<pre><code>SELECT \n        CASE \n            WHEN GROUPING(Custodian) = 1 \n                THEN 'Grand Total'\n            ELSE Custodian\n\n        END AS Custodian\n\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   SUM(AmountTotalBaseEquiv) AS AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD\n    ,   SUM(TotalCashPctNAV) AS TotalCashPctNAV \n\nFROM @ResultSet\nWHERE TotalCashPctNAV &gt; 5\nGROUP BY Custodian\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD \n    ,   TotalCashPctNAV WITH ROLLUP\n\nHAVING GROUPING_ID(Custodian\n    ,   PortfolioID\n    ,   PortfolioBaseCCY\n    ,   [Date]\n    ,   AmountTotalBaseEquiv\n    ,   ExchangeRate\n    ,   AmountTotalBaseEquivUSD\n    ,   PortfolioNAVUSD \n    ,   TotalCashPctNAV) IN (1,255,511)\n\nORDER BY ABS(TotalCashPctNAV) DESC\n</code></pre>\n\n<p>However i would like to add another grouping to the CASE statement, ie:</p>\n\n<pre><code>        CASE \n            WHEN GROUPING(Custodian) = 1 \n                THEN 'Grand Total'\n            WHEN GROUPING(PortfolioID) = 1\n                THEN Custodian+''+'Total'\n            ELSE Custodian\n</code></pre>\n\n<p>However it does not work as the second case doesn't return a value, why is this?</p>\n\n<p>Also i would like to order the TotalCashPctNAV in the above select by:</p>\n\n<pre><code>ORDER BY ABS(TotalCashPctNAV) DESC\n</code></pre>\n\n<p>However this does not seem to be working.  I would like it ordered so that it orders the ABS value descending between each portfolioID sub total.  </p>\n\n<p>Any help would be appreciated.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":3,"view_count":41,"score":-3,"question_id":12372045,"title":"How To create a jointure between more than 2 tables SqlServer","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/5781078/how-to-join-three-tables\">How to Join three tables</a>  </p>\n</blockquote>\n\n\n\n<p>I have 4 tables :</p>\n\n<ul>\n<li>folder (id_folder,name)</li>\n<li>subfolder(id_subfolder,id_folder,name,othercolumn,...)</li>\n<li>piece(id_piece,id_subfolder,id_folder)</li>\n<li>image(id_image,id_piece,name,..)</li>\n</ul>\n\n<p>How can I get all the contents of one folder (\"id_folder=1\" for example)?</p>\n"},{"tags":["sql","tsql","replace","substring"],"answer_count":4,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":73,"score":5,"question_id":12371701,"title":"How do I replace a substring of a string before a specific character?","body":"<p>Table <code>Email</code>:</p>\n\n<p>Values:</p>\n\n<pre><code>josh@yahoo.com\ncarmine32@hotmail.com\nzehmaneh@yahoo.com\n</code></pre>\n\n<p>I want to replace the string before <code>@</code> with <code>test</code>.</p>\n\n<p>Result:</p>\n\n<pre><code>test@yahoo.com\ntest@hotmail.com\ntest@yahoo.com\n</code></pre>\n\n<p>How do I use substringing and replace based on a character in the string?</p>\n"},{"tags":["sql","sql-server-2005","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":951,"score":2,"question_id":3752942,"title":"How to check when autogrowth is done last?","body":"<p>In sql server 2005, the autogrowth is enabled by size. \nIs there any way to check when autogrowth on data and log file happened last?</p>\n"},{"tags":["tsql","sql-server-2000"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":3777,"score":2,"question_id":1324120,"title":"First Day of Next Year for SQL Server?","body":"<p>This should not be this hard.  I simply need the following: </p>\n\n<pre><code>SET @DueDate = CONVERT (DATETIME, '01/01/2010')\n</code></pre>\n\n<p>However, I need it pragmatically so that if it were March of 2010, the date given would be '01/01/2011'.  </p>\n\n<p>I know it's simple, but my brain isn't coming up with it.  I'm sure it's with a DateAdd and <code>getdate()</code>. </p>\n"}]}
{"total":16599,"page":16,"pagesize":100,"questions":[{"tags":["tsql","data","import","export","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3376,"score":1,"question_id":11356911,"title":"SQL Server Management Studio 2012 - Export/Import data from/to table","body":"<p>I have table with more than 3 000 000 rows. I have try to export the data from it manually and with SQL Server Management Studio <code>Export data</code> functionality to Excel but I have met several problems:</p>\n\n<ul>\n<li><p>when create .txt file manually copying and pasting the data (this is several times, because if you copy all rows from the SQL Server Management Studio it throws out of memory error) I am not able to open it with any text editor and to copy the rows;</p></li>\n<li><p>the <code>Export data</code> to Excel do not work, because Excel do not support so many rows</p></li>\n</ul>\n\n<p>Finally, with the <code>Export data</code> functionality I have created a <code>.sql</code> file, but it is 1.5 GB, and I am not able to open it in SQL Server Management Studio again. </p>\n\n<p>Is there a way to import it with the <code>Import data</code> functionality, or other more clever way to make a backup of the information of my table and then to import it again if I need it?</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":40,"score":3,"question_id":12371249,"title":"Creating query with case statement in where clause","body":"<p>I have a large stored procedure that pulls data for a report. I am trying to use one of two different values in a <code>WHERE</code> clause depending on certain criteria. I cannot figure out how to use a <code>CASE</code> statement to get this done, I keep getting errors in the <code>THEN</code> part. Below is what I'm trying to do, it's a small portion of the larger stored procedure. So what I am looking for is where <code>dlp(DATETIME)</code> is newer than <code>dlc(DATETIME)</code> I want to use <code>dlp</code> to evaluate with the <code>@AgeStart</code> and <code>@AgeEnd</code> parameter, if not then use <code>dlc</code> to evaluate with <code>@AgeStart</code> and <code>@AgeEnd</code>.</p>\n\n<pre><code>@AgeStart INT\n@AgeEnd INT\n\nSET @Recovery = (\nSELECT SUM(ISNULL(M.Paid1, 0))\nFROM Master AS M\nWHERE M.Status IN ('xxx','yyy')\n  AND CASE\n    WHEN COALESCE(M.dlp, '2000-01-01 00:00:00') &gt; \n         COALESCE(M.dlc, '2000-01-01 00:00:00') \n    THEN DATEDIFF(dd,M.Received,M.dlp) \n      &gt;= @AgeStart AND DATEDIFF(dd,M.Received,M.dlp) &lt;= @AgeEnd\n    ELSE DATEDIFF(dd, M.dlc, M.Received) \n      &gt;= @AgeStart AND DATEDIFF(dd, M.dlc, M.Received) &lt;= @AgeEnd\n  END\n  AND M.Balance &gt;= @OrigBalanceMin AND M.Balance &lt;= @OrigBalanceMax\n)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","rank","with-statement"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":117,"score":1,"question_id":12369703,"title":"T-sql rank for max and min value","body":"<p>I need help with a t-sql query.</p>\n\n<p>I have a table with this structure:</p>\n\n<pre><code>id  |  OverallRank  |  FirstRank  |  SecondRank  |  Nrank..\n1   |       10      |    20       |     30       |    5\n2   |       15      |    24       |     12       |    80\n3   |       10      |    40       |     37       |    12\n</code></pre>\n\n<p>I need a query that produces this kind of result:</p>\n\n<p>When id: 1</p>\n\n<pre><code>id  |  OverallRank  |  BestRankLabel  |  BestRankValue  |  WorstRankLabel  | WorkRankValue\n1   |     10        |    SecondRank   |        30       |     Nrank        |       5\n</code></pre>\n\n<p>When id: 2</p>\n\n<pre><code>id  |  OverallRank  |  BestRankLabel  |  BestRankValue  |  WorstRankLabel  | WorkRankValue\n1   |     15        |    FirstRank    |        24       |     SecondRank   |       12\n</code></pre>\n\n<p>How can I do it?</p>\n\n<p>Thanks in advance</p>\n"},{"tags":["tsql","sql-server-2008-r2","attach"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":12371240,"title":"How can I test with Transact-SQL and SQL Server 2008 R2 if a database is already attached?","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/679000/how-to-check-if-a-database-exists-in-sql-server\">How to check if a database exists in SQL Server?</a>  </p>\n</blockquote>\n\n\n\n<p>I'm using Transact-SQL to attach a SQL Server 2008 R2 database with the following code, but I'd like to do this only if the database is not already attached, because trying to attach an already attached database returns an error.  </p>\n\n<p>Is there a way using Transact-SQL to test if the database is already attached?</p>\n\n<pre><code>USE [MASTER]\nGO\n#I'd like to test here if database is already attached\nCREATE DATABASE ASPNETDB\n    ON (FILENAME = 'C:\\Program Files\\Microsoft SQL Server\\MSSQL10_50.SQLEXPRESS\\MSSQL\\Data\\ASPNETDB.MDF')\nFOR ATTACH ;\nGO\n</code></pre>\n"},{"tags":["python","database","tsql","database-connection","pyodbc"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1384,"score":1,"question_id":9723656,"title":"What's causing 'unable to connect to data source' for pyodbc?","body":"<p>I'm trying to connect to an MSSQL database from python on Linux (SLES).</p>\n\n<p>I have installed pyodbc and Free TDS. From the command line:</p>\n\n<pre><code>tsql -H server -p 1433 -U username -P password\n</code></pre>\n\n<p>Connects to the server without a problem, however, from Python:</p>\n\n<pre><code>import pyodbc\npyodbc.connect(driver='{FreeTDS}', server='server', database='database', uid='username', pwd='password')\n</code></pre>\n\n<p>Yields an error:</p>\n\n<pre><code>pyodbc.Error: ('08001', '[08001] [unixODBC][FreeTDS][SQL Server]Unable to connect to data source (0) (SQLDriverConnect)')\n</code></pre>\n\n<p>I'm finding this error unhelpfully vague. Even a suggestion to narrow down the issue would be helpful right now.</p>\n\n<p>Edit:\n    Looking at the TDS log dump it looks like this is where the whole thing falls apart:</p>\n\n<pre><code>token.c:328:tds_process_login_tokens()\nutil.c:331:tdserror(0x87bbeb8, 0x8861820, 20017, 115)\nodbc.c:2270:msgno 20017 20003\nutil.c:361:tdserror: client library returned TDS_INT_CANCEL(2)\nutil.c:384:tdserror: returning TDS_INT_CANCEL(2)\nutil.c:156:Changed query state from IDLE to DEAD\ntoken.c:337:looking for login token, got  0()\ntoken.c:122:tds_process_default_tokens() marker is 0()\ntoken.c:125:leaving tds_process_default_tokens() connection dead\nlogin.c:466:login packet accepted\nutil.c:331:tdserror(0x87bbeb8, 0x8861820, 20002, 0)\nodbc.c:2270:msgno 20002 20003\nutil.c:361:tdserror: client library returned TDS_INT_CANCEL(2)\nutil.c:384:tdserror: returning TDS_INT_CANCEL(2)\nmem.c:615:tds_free_all_results()\nerror.c:412:odbc_errs_add: \"Unable to connect to data source\"\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2","greatest-n-per-group"],"answer_count":6,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":158,"score":1,"question_id":12368313,"title":"SQL select multiple distinct records from one Table","body":"<p>I've a Table as below</p>\n\n<pre><code>ID  |FromId |ToId   |Message|DateTime\n------------------------------------------\n1   |1      |2      |a      |15:00\n2   |1      |2      |b      |15:01\n3   |1      |2      |c      |15:02\n4   |2      |1      |d      |15:03\n5   |3      |1      |e      |15:04\n6   |3      |1      |f      |15:05\n7   |1      |3      |g      |15:06\n</code></pre>\n\n<p>what I want  to get  is Every last message of Peers.</p>\n\n<p><strong>For example:</strong> User 1 and user 2 has 4 messages (ID:1,2,3,4) and user 1 and user 3 has 3 messages (ID:5,6,7)</p>\n\n<p>I want to get only latest Message record from users, I need a SQL query which will give the result like this:</p>\n\n<pre><code>*sql code here ? -- I need this.\n</code></pre>\n\n<p>result (for: where UserID=1) : </p>\n\n<pre><code>ID  |FromId |ToId   |Message|DateTime\n------------------------------------------\n4   |2      |1      |d      |15:03\n7   |1      |3      |g      |15:06\n</code></pre>\n\n<p>Any Ideas ? I've tried with Distinct etc. but it didn't worked somehow.  Please help. </p>\n\n<p><strong>Sorry Guys I guess I  forgot to mention that I need the latest record from Peer, not the latest record from one user, for example for user 1 and user 2 I need the latest record from them, no mather which one is From or which one is To.. I need the latest record from both which is ID 4 in our case no other records.</strong> </p>\n"},{"tags":["tsql","null","where"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":44,"score":1,"question_id":12369088,"title":"T-SQL WHERE NOT IN not catching NULL values","body":"<p>This is my code:</p>\n\n<pre><code>DECLARE @TABLE TABLE\n(\n    RecordID BIGINT,\n    RecordValue NVARCHAR(10)\n)\n\nINSERT INTO @TABLE(RecordID,RecordValue)\nVALUES  (1,'100')\n       ,(2,NULL)\n       ,(3,'200')\n       ,(4,NULL)\n       ,(5,'200')\n\nSELECT RecordID,RecordValue\nFROM @TABLE\nWHERE RecordValue NOT IN ('200') \n</code></pre>\n\n<p>OUTPUT:</p>\n\n<p>1  100</p>\n\n<p>Desire OUTPUT:</p>\n\n<p>1 100</p>\n\n<p>2 NULL</p>\n\n<p>4 NULL</p>\n\n<p>How can I get the 'NULL' values too?</p>\n\n<p>Actually, my the sql statement is generated by a lot of procedures and functions, I am limited in doing operations like using ISNULL function. The final statement is in the following format:</p>\n\n<pre><code>WHERE RecordValue NOT IN ('CSV...') \nWHERE RecordValue IN ('CSV...') \nor combinatnation from both \nRecordValue NOT IN ('CSV...') AND RecordValue IN ('CSV...') \n</code></pre>\n\n<p>Is there a way to get NULL values too in this way?</p>\n"},{"tags":["sql","sql-server-2008","tsql","cursor"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":80,"score":0,"question_id":12359610,"title":"Nasty SQL query: is there a way I can find first and last rows in a grouped set without a cursor?","body":"<p>I have data that looks like this:</p>\n\n<p><img src=\"http://i.stack.imgur.com/TN8zh.jpg\" alt=\"data sample\"></p>\n\n<p>What I need to do is, for records having the same <code>ClientId</code>, I need to group consecutive rows (using CpId) where <code>PlaceId</code> is not null, and find the first and last row in each group so that I can retrieve the <code>DateAdmitted</code> value from the first row and the <code>DateDischarged</code> value from the last row.  So, the above data needs to be organized like this and then filtered for the values I need:</p>\n\n<p><img src=\"http://i.stack.imgur.com/XEBPm.jpg\" alt=\"enter image description here\"></p>\n\n<p>Using the above example, I would want the following based on <code>ClientId</code>:</p>\n\n<pre><code>ClientId    FirstCpIdInSet    DateAdmitted    LastCpIdInSet    DateDischarged\n-----------------------------------------------------------------------------\n1967        NULL              NULL            NULL             NULL\n1983        45                1986-12-29      45               1987-10-09\n1983        47                1990-10-01      49               2009-04-12\n1983        52                2009-08-31      52               2009-11-30\n1988        62                1997-12-15      65               2000-01-07\n</code></pre>\n\n<p><code>ClientId</code> 1967 could be excluded from the result set, since it never has a row where <code>PlaceId</code> is not null.  A couple of other things to note:</p>\n\n<ul>\n<li>This is taken from a temp table that is created with <code>CpId</code> as the <code>IDENTITY</code>, and the table is populated with a strict <code>ORDER BY</code>, so <code>CpId</code> is sequential in the order needed.</li>\n<li>For those rows that have <code>PlaceId</code> and are consecutive for a single <code>ClientId</code>, the <code>DateAdmitted</code> should equal the <code>DateDischarged</code> in the previous row.</li>\n</ul>\n\n<p>I'd really like to be able to do this without a cursor, if possible, but after puzzling on it for two days I just can't figure it out.  This is on SQL Server 2008 R2.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","union"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":98,"score":2,"question_id":12359652,"title":"INSERT INTO SELECT strange order using UNION","body":"<p>I had a typical non-normalized table (<code>tempTable</code>) with multiple numbered columns (<code>rep1</code>,<code>rep2</code>,...). \nSo i wrote a script to insert the non-normalized data into a normalized table (<code>myTable</code>):</p>\n\n<pre><code>insert into myTable\nselect idRep,rep FROM\n(\n    select idRep, ISNULL(rep1,'') as rep FROM tempTable\n    union\n    select idRep, ISNULL(rep2,'') as rep FROM tempTable\n    union\n    select idRep, ISNULL(rep3,'') as rep FROM tempTable\n    union\n    select idRep, ISNULL(rep4,'') as rep FROM tempTable\n    union\n    select idRep, ISNULL(rep5,'') as rep FROM tempTable\n) as t\n</code></pre>\n\n<p>Note: The table <code>myTable</code> also contains an auto-incremented <code>IDENTITY</code> column as its <code>PRIMARY KEY</code>.</p>\n\n<p>The order rep1, rep2, rep3, rep4, rep5 is important in my scenario. Strangely, when I executed the script, the data wasn't inserted in the correct order such as the auto-generated id '1000' had the value from 'rep3' and the id '1001' had the value from 'rep1'.</p>\n\n<p>Why is that? How was the script executed?</p>\n"},{"tags":["c#","sql","tsql","database-restore"],"answer_count":4,"favorite_count":4,"up_vote_count":14,"down_vote_count":0,"view_count":4583,"score":14,"question_id":4046708,"title":"Exclusive access could not be obtained because the database is in use","body":"<p>I'm using following code to restore databases,</p>\n\n<pre><code>void Restore(string ConnectionString, string DatabaseFullPath, string backUpPath)\n{\n    string sRestore =\n        \"USE [master] RESTORE DATABASE [\" + DatabaseFullPath + \"] FROM DISK = N'\" + backUpPath + \"' WITH  FILE = 1,  NOUNLOAD,  STATS = 10\";\n\n    using (SqlConnection con = new SqlConnection(ConnectionString))\n    {\n        con.Open();\n        SqlCommand cmdBackUp = new SqlCommand(sRestore, con);\n        cmdBackUp.ExecuteNonQuery();\n    }\n}\n</code></pre>\n\n<p>but I receive below exception </p>\n\n<pre><code>\"Exclusive access could not be obtained because the database is in use.\nRESTORE DATABASE is terminating abnormally.\nChanged database context to 'master'.\"\n</code></pre>\n\n<p>How can I fix it ?</p>\n"},{"tags":["sql-server-2008","tsql","stored-procedures","ssis","business-intelligence"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":12359240,"title":"How to automatically execute stored procedures in a particular sequence, or use an SSIS package to execute stored procedures","body":"<p>I have created 2 stored procedures that need to be executed in a specific sequence. </p>\n\n<p>I just do not know how to do this. I also want to do it automatically everyday with GETDATE() as the parameters to both procedures. </p>\n\n<p>Is there an SSIS package I can create to execute these two procedures in the proper sequence for me?</p>\n\n<p>Please help me out, this is urgent! </p>\n\n<p>Thank You In advance! </p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":57,"score":-2,"question_id":12325230,"title":"Build a string in an sql table and insert into another table","body":"<p>Say I have a table <code>Name_Address</code> as follows:</p>\n\n<pre><code>CREATE TABLE [dbo].[Name_Address](\n[First_Name] [nvarchar] (50)  NULL,\n[Last_Name] [nvarchar] (50)  NULL,\n[Address] [nvarchar] (50)  NULL,\n[City] [nvarchar] (50)  NULL,\n[State] [nvarchar] (50)  NULL,\n[Zip] [nvarchar] (50)  NULL,\n[Phone] [nvarchar] (50)  NULL,\n[Cell] [nvarchar] (50)  NULL\n) ON [PRIMARY]\n</code></pre>\n\n<p>Is there a way in SQL that I can build a string:</p>\n\n<p><code>&lt;First Name&gt;John&lt;Last Name&gt;Smith&lt;Address&gt;1233 Your Street&lt;City&gt;Home Town&lt;State&gt;NY&lt;Zip&gt;123456-1234&lt;Phone&gt;111-111-1111&lt;Cell&gt;222-222-222</code></p>\n\n<p>and insert it into another table?</p>\n\n<p><strong>Note:</strong></p>\n\n<p>Original post did not show the xml tags as part of the desired result: without code formatting the tags were interpreted literally and were not displayed.</p>\n"},{"tags":["sql","tsql","sql-server-2008"],"answer_count":3,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":2385,"score":4,"question_id":4556397,"title":"SQL: Is it possible to add a dummy column in a select statement?","body":"<p>I need to add a dummy column to a simple select statement in certain circumstances:</p>\n\n<p><code>Select Id, EndOfcol default '~' from Main where id &gt; 40</code></p>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12358435,"title":"SQL Select Puzzle","body":"<p>Ok..here's what I want to do.  I've oversimplified the example below:-</p>\n\n<p>I have a table (Table1) with references in like this:</p>\n\n<p><strong>Table1_ID (PK)</strong></p>\n\n<p><strong>Table1_ID Description</strong></p>\n\n<p>There's another table (Table2):-</p>\n\n<p><strong>Table2_ID (PK)</strong></p>\n\n<p><strong>Table2_LinkedID (FK)</strong></p>\n\n<p><strong>Table2_Status &lt;--value is \"open\" or \"complete\"</strong></p>\n\n<p>Table2_LinkedID is linked to Table1_ID.</p>\n\n<p>Ok.  Now I have three queries that I want to connect together.  Here is what I need.</p>\n\n<p>First query:-</p>\n\n<pre><code>SELECT * FROM Table1\n</code></pre>\n\n<p>This works fine.</p>\n\n<p>I want to add two additional columns to the query.  The first is the total number of records in Table2 where the foreign key equals the primary key of table1 (ie SELECT *).</p>\n\n<p>The second will be a count of records where Table2_Status = 'completed'</p>\n\n<p>Does this make sense?  </p>\n"},{"tags":["sql-server","sql-server-2008","tsql","stored-procedures","alter-table"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":69,"score":1,"question_id":12358412,"title":"adding a column in stored procedure","body":"<p>Can I have one single stored procedure to add a new column to a table and work on the column afterwords? For example, I have following stored procedure:</p>\n\n<pre><code>...\n\nalter table tb1\nadd col1 varchar(1) null\n\ninsert into tb1(col1)\nvalues ('Y')\n</code></pre>\n\n<p>I got an error saying </p>\n\n<blockquote>\n  <p>col1 is invalid.</p>\n</blockquote>\n"},{"tags":["sql","string","tsql","format"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":51,"score":-1,"question_id":12358492,"title":"How do I re-arrange letters in a string?","body":"<p>I have a table that has a column called <code>Name.</code></p>\n\n<p>It has data:</p>\n\n<pre><code>John\nJack\nJosh\nBob\n...\n</code></pre>\n\n<p>I want to run a query to re-arrange the letters for the names.</p>\n\n<pre><code>UPDATE [table]\nSET [name] = ?\n</code></pre>\n\n<p>Result:</p>\n\n<pre><code>hnoJ\nckJa\nshoJ\nboB\n</code></pre>\n\n<p>Is it possible to do this?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","gaps-and-islands"],"answer_count":2,"favorite_count":2,"up_vote_count":6,"down_vote_count":0,"view_count":1228,"score":6,"question_id":2693171,"title":"Finding gaps (missing records) in database records using SQL","body":"<p>I have a table with records for every consecutive hour. Each hour has some value. I want a T-SQL query to retrieve the missing records (missing hours, the gaps). So for the DDL below, I should get a record for missing hour 04/01/2010 02:00 AM (assuming date range is between the first and last record). Using SQL Server 2005. Prefer a set based query.</p>\n\n<pre><code>DDL:\nCREATE TABLE [Readings](\n    [StartDate] [datetime] NOT NULL,\n    [SomeValue] [int] NOT NULL\n)\nINSERT INTO [Readings]([StartDate], [SomeValue])\nSELECT '20100401 00:00:00.000', 2 UNION ALL\nSELECT '20100401 01:00:00.000', 3 UNION ALL\nSELECT '20100401 03:00:00.000', 45\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","local-variables"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":69,"score":2,"question_id":12355395,"title":"Need help condensing sql server query using local variables. Also need hints for accounting for leap year","body":"<p>I recently switched jobs and therefore also switched from oracle to sql server. I'm attempting to write a stored procedure that will generate a report on demand. The report will show monthly amounts and the sum of these amounts. I am mostly having trouble with the summing part of this. The full query is at the very bottom of this post.\n As you will see from my super-long query, I've basically written it twice to get the sum amount in the Total_Current_Plus_Archived column. I was thinking of using a local variable for this (@totalReportSum). I wanted to update this variable each time a total column is calculated but get errors no matter what syntax I use. Here are a couple of the things I've tried: </p>\n\n<p>Attempt 1.</p>\n\n<pre><code>--March total   \n                     (SELECT @totalReportSum  =@totalReportSum + Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-03-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-03-31' )) \n                     AS March_Total_Reports, \n</code></pre>\n\n<p>Attempt 2.</p>\n\n<pre><code>--March total   \n                 @totalReportSum = (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-03-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-03-31' )) \n                     AS March_Total_Reports, \n</code></pre>\n\n<p>If possible, I would also like suggestions as to how I can account for leap years. </p>\n\n<p>Any help or hints are greatly appreciated. Thanks.</p>\n\n<pre><code>CREATE PROCEDURE Sp_get_ram_report @year NCHAR(4) \nAS \nBEGIN--declare variable to hold total sum of reports \n  DECLARE @totalReportSum INT; \n\n  --initialize sum \n  SET @totalReportSum = 0; \nEND \n\nSELECT TOP (100) PERCENT r.ramid \n                     AS Ram_ID, \n                     r.ram_fname \n                     AS RAM_First_Name, \n                     r.ram_lname \n                     AS RAM_Last_Name, \n                     Count(*) \n                     AS Number_of_Agencies, \n                     Isnull(Sum(m.yearly_avg_reports), 0) \n                     AS Yearly_Avg#_of_reports, \n                     Round(Isnull(Sum(m.yearly_avg_reports), 0) / 12, 2) \n                     AS Monthly_Reports_Expected, \n                     --January \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-01-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-01-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS January, \n                     --January total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-01-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-01-31' )) \n                     AS January_Total_Reports, \n                     --February \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-02-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-02-28' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS February, \n                     --February total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-02-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-02-28' )) \n                     AS February_Total_Reports, \n                     --March \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-03-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-03-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS March, \n                     --March total   \n                 (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-03-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-03-31' )) \n                     AS March_Total_Reports, \n                     --April \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-04-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-04-30' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS April, \n                     --April total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-04-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-04-30' )) \n                     AS April_Total_Reports, \n                     --May \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-05-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-05-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS May, \n                     --May total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-05-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-05-31' )) \n                     AS May_Total_Reports, \n                     --June \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-06-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-06-30' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS June, \n                     --June total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-06-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-06-30' )) \n                     AS June_Total_Reports, \n                     --July \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-07-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-07-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS July, \n                     --July total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-07-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-07-31' )) \n                     AS July_Total_Reports, \n                     --august \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-08-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-08-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS August, \n                     --august total   \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-08-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-08-31' )), \n                     --september \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-09-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-09-30' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS September, \n                     --September Total \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-09-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-09-30' )) \n                     AS September_Total_Reports, \n                     --October \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-10-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-10-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS October, \n                     --october total \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-10-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-10-31' )) \n                     AS October_Total_Reports, \n                     --november \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-11-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-11-30' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS November, \n                     --november total \n                     (SELECT Count(*) \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-11-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-11-30' )) \n                     AS November_Total_Reports, \n                     --December \n                     (SELECT Count(*) AS Expr1 \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-12-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-12-31' ) \n                             AND ( ai.insert_datetime - ai.crash_date &lt; 35 ) \n                     ) AS December, \n                     --December Total \n                     (SELECT Count(*) \n                      FROM   dbo.accident_information AS ai \n                             INNER JOIN dbo.municipality AS mx \n                                     ON mx.agency_ori = ai.agency_ori \n                      WHERE  ( mx.ram = m.ram ) \n                             AND ( ai.crash_date &gt;= @year + '-12-01' ) \n                             AND ( ai.crash_date &lt;= @year + '-12-31' )) \n                     AS December_Total_Reports, \n      --Total Current +archived: Would like to replace this huge chunk w/ something a lot smaller \n                     ( (SELECT Count(*) AS Expr1 \n                        FROM   dbo.accident_information AS ai \n                               INNER JOIN dbo.municipality AS mx \n                                       ON mx.agency_ori = ai.agency_ori \n                        WHERE  ( mx.ram = m.ram ) \n                               AND ( ai.crash_date &gt;= @year + '-01-01' ) \n                               AND ( ai.crash_date &lt;= @year + '-01-31' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-02-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-02-28' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-03-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-03-31' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-04-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-04-30' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-05-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-05-31' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-06-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-06-30' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-07-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-07-31' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-08-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-08-31' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-09-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-09-30' )) \n                       + (SELECT Count(*) AS Expr1 \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-10-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-10-31' )) \n                       + (SELECT Count(*) \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-11-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-11-30' )) \n                       + (SELECT Count(*) \n                          FROM   dbo.accident_information AS ai \n                                 INNER JOIN dbo.municipality AS mx \n                                         ON mx.agency_ori = ai.agency_ori \n                          WHERE  ( mx.ram = m.ram ) \n                                 AND ( ai.crash_date &gt;= @year + '-12-01' ) \n                                 AND ( ai.crash_date &lt;= @year + '-12-31' )) \n                     ) AS \n                     Total_Current_Plus_Archived \nFROM   dbo.municipality AS m \n   INNER JOIN dbo.ram AS r \n           ON m.ram = r.ramid \nGROUP  BY m.ram, \n      r.ramid, \n      r.ram_fname, \n      r.ram_lname \nORDER  BY ram_last_name \n</code></pre>\n"},{"tags":["c#","visual-studio-2010","tsql","syntax-highlighting"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":160,"score":0,"question_id":11023881,"title":"Is it possible to syntax-highlight in-line SQL?","body":"<p>Often times I write some SQL like this:</p>\n\n<pre><code>string sql = @\"\n   -- Multi-line SQL\n\";\n</code></pre>\n\n<p>Without getting into a debate on whether this approach is good or bad, can someone tell me what is the best way to get this SQL to be highlighted inside Visual Studio? </p>\n\n<p>One approach I can think of is to create separate <code>.sql</code> files and then consume that as a string here so that when editing the original SQL, Visual Studio recognizes that this is a SQL file and syntax-highlights it. </p>\n\n<p>This seems to be a tedious approach to solve a simple problem. Is there a simpler solution?</p>\n"},{"tags":["tsql","division"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":88,"score":1,"question_id":12347091,"title":"T-SQL elegant solution to divide a numeric value to multiple accounts","body":"<p>I have a problem that I believe has a perfectly elegant solution, but would like some help.</p>\n\n<p>So I have a table of persons and a numerical value. Besides that, there is a table with the rules of division of that value (per person) to multiple accounts, rule can be either a max value or a percentage of the value.</p>\n\n<p>This is a simplified version of these tables.</p>\n\n<pre><code>Persons(PersonID int, Value decimal)\n\nAccount(AccountID int, PersonID int)\n\nDistribution(AccountID int, MaxValue decimal Null, Percentage decimal null)\n</code></pre>\n\n<p>At some point I need to divide those numerical values to a third table - that holds the account and value divided to that account.</p>\n\n<pre><code>AccountValues(AccountID int, AccountValue decimal)\n</code></pre>\n\n<p>The count of the accounts (per person) is not fixed. In the distribution table - if both of the distribution values are null - all the left over value goes to that account.\nThe order of distribution is by their ID's.</p>\n\n<p>The data could look something like this.</p>\n\n<pre><code>Persons  table\nPersonID    Value\n    1            1000,00\n    2            2000,00\n    3            5000,00\n    4            500,00\n\nAccounts table\nAccountID   PersonID\n1            1\n2            1\n3            2\n4            2\n5            2\n6            3\n7            3\n8            4\n9            4\n10           4\n\nDistribution table\nAccountID    MaxValue    Percentage\n1            500,00          null\n2            null            null\n3            null            0,5\n4            null            0,2\n5            null            null\n6            1000,00         null\n7            null            null\n8            2000,00         null\n9            null            0,2\n10           null            null\n</code></pre>\n\n<p>Still a bit new to T-SQL so need help with the simplest and most efficient solution.</p>\n\n<p>So for now I'm thinking of 3 possible solutions.\n1. The least elegant - count the max number of accounts per person and do a loop that many times.\n2. Cursors - the best way perhaps?\n3. CTE recursion (about which I know nothing about)</p>\n"},{"tags":["tsql","table","optimization","delete","records"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":93,"score":1,"question_id":12352042,"title":"T-SQL Optimize DELETE of many records","body":"<p>I have a table that can grew to millions records (50 millions for example). On each 20 minutes records that are older then 20 minutes are deleted.</p>\n\n<p>The problems is that if the table has so many records such deletion can take a lot of time and  I want to make it faster.</p>\n\n<p>I can not do \"truncate table\" because I want to remove only records that are older then 20 minutes. I suppose that when doing the \"delete\" and filtering the information that need to be delete, the server is creating log file or something and this take much time?</p>\n\n<p>Am I right?Is there a way to stop any flag or option to optimize the delete, and then to turn on the stopped option?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":12354419,"title":"Get elements of same name from XML using XQuery in SQL server","body":"<p>I am having following XML</p>\n\n<pre><code>DECLARE @ruleXML XML\nSET @RuleXML = '&lt;questionnaire xmlns:xsi=\"http://schema1\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns=\"http://schem2\" title=\"Sample\"&gt;\n  &lt;sections&gt;\n    &lt;section id=\"24\" title=\"Section Title\" help=\"\" url=\"\"&gt;\n      &lt;questions /&gt;\n    &lt;/section&gt;\n    &lt;section id=\"23\" title=\"Information\" help=\"\" url=\"\"&gt;\n      &lt;questions /&gt;\n    &lt;/section&gt;\n    &lt;section id=\"25\" title=\"Section Title1\" help=\"\" url=\"\"&gt;\n      &lt;questions&gt;\n        &lt;question id=\"3\" title=\"Question Text\"&gt;\n          &lt;display-rules /&gt;\n          &lt;questions /&gt;\n        &lt;/question&gt;\n        &lt;question id=\"4\" title=\"Question Text\" &gt;\n          &lt;response-set type=\"inline\" /&gt;\n          &lt;display-rules /&gt;\n          &lt;questions /&gt;\n        &lt;/question&gt;\n      &lt;/questions&gt;\n    &lt;/section&gt;\n  &lt;/sections&gt;\n&lt;/questionnaire&gt;'\n</code></pre>\n\n<p>How to get a table with question id and title from all the question nodes regardless of their level using XQUERY in SQL server?</p>\n"},{"tags":["xml","tsql","recursion"],"answer_count":2,"favorite_count":4,"up_vote_count":3,"down_vote_count":0,"view_count":2481,"score":3,"question_id":2409228,"title":"generate structured (xml) document from hierarchical table data (T-SQL)","body":"<p>I have a table like this (simplified):</p>\n\n<pre><code>ID   |   Name  |   Parent\n---------------------------------\n1    |  IND    |   NULL\n2    |  INS    |   5\n3    |  CON    |   NULL\n4    |  AUT    |   1\n5    |  FIN    |   NULL\n6    |  PHA    |   1\n7    |  CFIN   |   5\n8    |  CMRKT  |   7\n</code></pre>\n\n<p>DDL:</p>\n\n<pre><code>CREATE TABLE [dbo].[tblIndustryCodes](\n        [IdIndustry] [int] IDENTITY(1,1) NOT NULL,\n        [IndustryCode] [nvarchar](5) NULL,\n        [IndustryName] [nvarchar](50) NULL,\n        [ParentId] [int] NULL,\n CONSTRAINT [PK_tblIndustryCodes] PRIMARY KEY CLUSTERED (       [IdIndustry] ASC))\n</code></pre>\n\n<p>INSERTS:</p>\n\n<pre><code>INSERT INTO [tblIndustryCodes]\n           ([IndustryCode]\n           ,[IndustryName]\n           ,[ParentId])\n     VALUES\n           ('IND','Industry',NULL),\n           ('PHARM','Pharmacy',1),\n           ('FIN','Finance',NULL),\n           ('CFIN','Corporate Finance',3),\n           ('CMRKT','Capital Markets',4)\n</code></pre>\n\n<p>And I'd like to generate a xml file from it which is structured according to the parent IDs</p>\n\n<p>like this (simplified)</p>\n\n<pre><code>&lt;IND&gt;\n   &lt;AUT&gt;\n   &lt;PHA&gt;\n&lt;CON&gt;\n&lt;FIN&gt;\n   &lt;CFIN&gt;\n      &lt;CMRKT&gt;\n</code></pre>\n\n<p>I believe its done maybe with some kinda recursion or something like that, but I don't know how. Any help is greatly appreciated!</p>\n\n<p>edit: Its a SQL Server Express 2008</p>\n\n<p>I don't really care if it's valid XML or not, because I only use it to populate a treeview control.</p>\n\n<p>edit2: I would probably use \"FOR XML EXPLICIT\" but I don't really understand the syntax when <strong>there is no fixed maximum depth of the tree.</strong> </p>\n\n<p>edit3: for easier understanding of the task, I added the DDL for the table</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2","median"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":70,"score":0,"question_id":12349426,"title":"SQL Server : Finding medians of multiple columns in the same table","body":"<p>I have a table with the following structure.</p>\n\n<pre><code>create table FindMedians \n( GroupByColumn varchar(100) \n, TimeInterval_1 int \n, TimeInterval_2 int \n, TimeInterval_3 int \n);\n</code></pre>\n\n<p>I need to find the medians of each of the time intervals for each group.\nI've been calculating the medians for each column separately and UNIONing them, and then PIVOTing to get a final result as:</p>\n\n<p>GroupByColumn &nbsp;&nbsp;&nbsp; Median1 &nbsp;&nbsp;&nbsp; Median2 &nbsp;&nbsp;&nbsp; Median3</p>\n\n<p>using a query given in solution to <a href=\"http://stackoverflow.com/questions/1342898/function-to-calculate-median-in-sql-server\">Function to Calculate Median in Sql Server</a></p>\n\n<p>Note: I'm just using the query, I haven't created a function.</p>\n\n<p>The original table has close 500K rows, and trying to calculate the medians separately for each column is slow.\nIs there a well performing way that would give me the medians of all the columns in a single query, without having to calculate separately for each column?</p>\n\n<p>Thanks</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":54,"score":2,"question_id":12353040,"title":"Find top n average values","body":"<p>I have a table that looks like this:</p>\n\n<pre><code>UID DATE GROUP VALUE\n</code></pre>\n\n<p>The data types are:</p>\n\n<pre><code> VARCHAR DATE VARCHAR NUMERIC\n</code></pre>\n\n<p>Example:</p>\n\n<pre><code>abc1000 2012-09-01 1205 1000.0000\nabc1000 2012-09-01 1210 1010.0000\nabc1000 2012-09-02 1205 1100.0000\nabc1000 2012-09-02 1210 1020.0000\ndef1010 2012-09-01 1205 2000.0000\n</code></pre>\n\n<p>I need to find the top N(15) values (VALUE) for each unique \"UID+GROUP\" and AVERAGE them so the output looks like this:</p>\n\n<pre><code>abc1000 1205 1050.0000\nabc1000 1210 1015.0000\ndef1010 1205 2000.0000\n</code></pre>\n"},{"tags":["tsql","xquery-sql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12350299,"title":"Performance issue in retriving data from XMLAttribute using Xquery","body":"<p>I have one history table which has information of transaction record of master table, in this table I have used XML column to store that transaction information. Table structure with data look like.</p>\n\n<p><img src=\"http://i.stack.imgur.com/m5dPJ.png\" alt=\"Table information\"></p>\n\n<p>In Content XML data are stored as xml like below.</p>\n\n<pre><code>        &lt;Answers&gt;\n      &lt;AnswerSet&gt;\n        &lt;Answer questionId=\"ProductCode\"&gt;S3404&lt;/Answer&gt;\n        &lt;Answer questionId=\"ProductName\"&gt;Parabolic Triple&lt;/Answer&gt;\n        &lt;Answer questionId=\"LegacyOptionID\" selectedvalue=\"1389\"&gt;1389&lt;/Answer&gt;\n        &lt;Answer questionId=\"LegacyContentID\" selectedvalue=\"624\"&gt;624&lt;/Answer&gt;\n        &lt;Answer questionId=\"LegacyPageID\" selectedvalue=\"355\"&gt;355&lt;/Answer&gt;\n        &lt;Answer questionId=\"LegacyParentID\" selectedvalue=\"760\"&gt;760&lt;/Answer&gt;\n     &lt;/AnswerSet&gt;\n    &lt;/Answers&gt;\n</code></pre>\n\n<p>In all rows structure is same but data is different in answer node, I want to get data which has ProductCode=\"S3404\" and CreatedDate is New.</p>\n\n<p>I have created query like </p>\n\n<pre><code>select n2.* from nodehistory n2 CROSS APPLY n2.content.nodes('Answers/AnswerSet') T(c) WHERE c.value('./Answer[@questionId=\"ProductCode\"][1]','varchar(100)') ='J154'\n</code></pre>\n\n<p>ProductCode have unique data for every nodeid, but this is returning more than one row for same nodeid because this is transaction table so same XML can be store multiple time, for this require condition like order by Createddate desc, but execution of this query is taking more time due to XML processing I think.</p>\n\n<p>Can we do like first get Select Top 1 nodeid from NodeHistory order by CreatedDate desc then search for XML part.</p>\n\n<p>Please suggest you suitable views for better performance</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12351699,"title":"TSQL Syntax Error","body":"<p>I'm wirting a tsql procedure to recreate all the views in one database onto a different dtabase.  I'm receiving the error \"Incorrect syntax near +\"  When I look  at the code though the syntax appears correct to me.  Can anyone tell me what is wrong with this query?</p>\n\n<pre><code>USE [SOURCEDB]   \nBEGIN  \nDECLARE @SQL NVARCHAR(MAX)  \nDECLARE CUR_V CURSOR FOR  \nSELECT sc.text     \nFROM sys.views av          \nJOIN sys.syscomments sc ON sc.id = av.object_id  \nOPEN CUR_V  \nFETCH NEXT FROM CUR_V INTO @SQL  \nWHILE @@FETCH_STATUS = 0  \nBEGIN    \nEXEC sp_executesql N'USE [DESTINATIONDB] EXEC sp_executesql ' + @SQL + ''       \nFETCH NEXT FROM CUR_V INTO @SQL  END  CLOSE CUR_V  DEALLOCATE CUR_V  END\n</code></pre>\n\n<p>Thanks in advance</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12348102,"title":"Sql Query throwing error","body":"<pre><code>SELECT pmc.[month]                                    AS 'Month',\n       pmc.pd_name_of_project                         AS 'Name of Project',\n       tbl_div.name                                   AS 'Name of Advisory Services Division',\n       TBL_PMC_UNIT.UNIT_NAME                         AS 'Name of Unit',\n       pmc.staff_engineers,\n       pmc.staff_clerical,\n       pmc.staff_peons,\n       pmc.pd_project_type                            AS 'Project Type',\n       pmc.accepted_tender_cost                       AS 'Accepted Tender Cost',\n       pmc.work_order_date                            AS 'Work Order Date',\n       pmc.tender_period_months                       AS 'Tender Period',\n       pmc.project_completion_date                    AS 'Project Completion Date',\n       pmc.per_pmc_charges                            AS '% Of PMC Charges',\n       pmc.total_pmc_charges_scheme                   AS 'Total PMC amount   of the Scheme',\n       pmc.bill_amount_certified_upto_previous_month  AS 'Bill amount certified upto previous Month',\n       pmc.total_PMC_charges_upto_previous_month      AS 'Total PMC charges  upto previous Month',\n       pmc.receipt_PMC_charges_upto_previous_month    AS 'Receipt of PMC Charges upto previous Month',\n       pmc.balance_of_PMC_charges_upto_previous_month AS 'Balance of PMC charges upto previous Month',\n       pmc.bill_amount_certified_current_month        AS 'Bill amount certified During Current Month',\n       pmc.PMC_charges_for_current_month              AS ' PMC charges  During Current Month',\n       pmc.receipt_PMC_charges_current_month          AS 'Receipt of PMC Charges During Current Monthh',\n       pmc.balance_of_PMC_charges_current_month       AS 'Balance of PMC charges During Current Month',\n       SUM(pmc.salary_allowance)                      AS 'Salary Allowance'\nFROM   TBL_PMC pmc\n       INNER JOIN TBL_DIV\n         ON TBL_DIV.ID = pmc.DIV_ID\n       LEFT OUTER JOIN TBL_PMC_UNIT\n         ON TBL_PMC_UNIT.ID = pmc.UNIT_ID\nWHERE  pmc.div_id = 17\nGROUP  BY pmc.[month]; \n</code></pre>\n\n<p>This query is giving me the error :- </p>\n\n<blockquote>\n  <p>Column 'TBL_PMC.pd_name_of_project' is invalid in the select list because it is not contained in either an aggregate function or the GROUP BY clause.</p>\n</blockquote>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":4006,"score":4,"question_id":3947453,"title":"override identity column","body":"<p>How do I override the identity column in MSSQL?\nI tried </p>\n\n<pre><code>set identity_insert GeoCountry on\nupdate GeoCountry\nset CountryID = 18\nwhere CountryID = 250\n</code></pre>\n\n<p>but I get back a </p>\n\n<pre><code> Line 2: Cannot update identity column 'CountryID'.\n</code></pre>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12348100,"title":"Ms Sql repetitive rows","body":"<p><a href=\"http://postimage.org/delete/pwnan1ud4/\" rel=\"nofollow\">http://postimage.org/delete/pwnan1ud4/</a></p>\n\n<p>there are repetitive rows <strong>(column Name : aracId)</strong> in the picture as linked above. How can i modify query for the unique row.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":63,"score":-1,"question_id":12347826,"title":"Special characters in LIKE statement","body":"<p>I am looking to perform the following in SQL Server 2005 but I guess due to the character '#' the <code>LIKE</code> statement does not seem to be returning any result.</p>\n\n<pre><code>SELECT * FROM Table WHERE keyword LIKE '%C#%'\n</code></pre>\n\n<p>Please advice.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":12346969,"title":"Return records of last 6 months","body":"<p>Below is my SQL statement</p>\n\n<pre><code>DECLARE @dStart datetime ,\n    @dEnd  datetime\n\nSET @dEnd = GETDATE()\nSET @dStart = DATEADD(mm, -6, @dEnd)\n\nSelect * from MyTable\nWhere TheDate Between @dStart AND @dEnd\n</code></pre>\n\n<p>This will return all the records from today minus 6 months data.</p>\n\n<p>But I want this months data plus only the previous 5 months data.</p>\n\n<p>Currently it will return records from March as well.</p>\n"},{"tags":["sql","sql-server","tsql","floating-point","equality"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":84,"score":1,"question_id":12343971,"title":"Is it safe comparing tSQL's dates for equality?","body":"<p>Say, if 'dtIn' is of type DATETIME2, is it safe to do the following comparison using SQL Server 2008?</p>\n\n<pre><code>--my concern is about equality part, \n-- or will it pick ALL 2012-09-09 22:30:00 dates?\nSELECT * FROM tbl WHERE [dtIn] &lt;= '2012-09-09 22:30:00'\n</code></pre>\n\n<p>The reason I'm asking is a possible situation when such comparison can be \"bad\" in a programming language where dates are stored as 'double's, or number of milliseconds since midnight of 1980, or something like that. Such value is stored as a floating point number, that is always a bad idea to compare for equality.</p>\n"},{"tags":["mysql","sql","tsql","inner-join"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":81,"score":-1,"question_id":12318865,"title":"Inner join on null id select row","body":"<p>We have two tables one with ids and one with names. Some id's are not required (are nullable) for example :</p>\n\n<pre><code>rowId item1Id, item2Id, item3Id (item3Id can be null)\n</code></pre>\n\n<p>After we join this two tables we get id's and names. But if item3 Id is null that row is not shown.</p>\n\n<p>Some data:</p>\n\n<blockquote>\n  <p>Table1</p>\n  \n  <p>rowId, item1Id, item2Id, item3Id</p>\n  \n  <p>1, 2, 3, 4</p>\n  \n  <p>2, 1, 5, NULL</p>\n</blockquote>\n\n<p>In our case we get as result one row ( 1 row) </p>\n\n<p>So if it's null than it doesnt exists in Table2 and the row is not shown, but we would like to display null. \nSo when we left join these two tables the result should have 2 rows.</p>\n\n<p>This is the sql :</p>\n\n<pre><code>SELECT Recipes.recipeId, Recipes.userId,Users.firstName + ' ' + Users.lastName as userName,  servingTypeId,\nCodings.coding as servingType, categoryId, Codings_2.coding as healthAspects, continentId,\nCodings_3.coding as continent, countryId, CodingsAssociated.coding as country, typeOfPreparationId,\nCodings_4.coding as typeOfPreparation, flavourId, Codings_5.coding as flavour, preparationSkillId,\nCodings_6.coding as preparationSkill, seasonId,  activePreparationTime,\noverallPreparationTime, isLocalDelight, servings, Codings_7.coding as season ,\ncalories, youTubeId, datePosted, isComposite, Recipes.isApproved, Recipes.timestamp, title,\nlocalDelightRegion, otherFeatures, cookingInstructions \n      FROM Recipes LEFT OUTER JOIN\n\n      Codings ON Recipes.servingTypeId = Codings.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_2 ON Recipes.categoryId = Codings_2.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_3 ON Recipes.continentId = Codings_3.codingKeyId LEFT OUTER JOIN\n      CodingsAssociated ON Recipes.countryId = CodingsAssociated.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_4 ON Recipes.typeOfPreparationId = Codings_4.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_5 ON Recipes.flavourId = Codings_5.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_6 ON Recipes.preparationSkillId = Codings_6.codingKeyId LEFT OUTER JOIN\n      Codings as Codings_7 ON Recipes.seasonId = Codings_7.codingKeyId  LEFT OUTER JOIN\n      RecipesTranslations ON Recipes.recipeId = RecipesTranslations.recipeId LEFT OUTER JOIN\n      Users ON Recipes.userId = Users.userId\n\n      WHERE CodingsAssociated.languageId = @languageId AND Codings.languageId = @languageId\n      AND Codings_2.languageId = @languageId AND Codings_3.languageId = @languageId\n      AND Codings_4.languageId = @languageId AND\n      Codings_5.languageId = @languageId AND Codings_6.languageId = @languageId AND RecipesTranslations.languageId = @languageId\n      AND Codings_7.languageId = @languageId\n</code></pre>\n\n<p>For example because seasonId is sometimes null the join for Codings_7.coding is not shown, but I won`t to show also these rows where ids are null that the name also be null.</p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":66,"score":2,"question_id":12315703,"title":"Count references to specific row from all referencing tables","body":"<p>Right now I have code that lists all referencing tables and than I can count references from tables one by one.</p>\n\n<p>Query 1:</p>\n\n<pre><code>SELECT t.NAME AS TableWithForeignKey,\n    c.NAME AS ForeignKeyColumn\nFROM sys.foreign_key_columns AS fk\nINNER JOIN sys.tables AS t\n    ON fk.parent_object_id = t.object_id\nINNER JOIN sys.columns AS c\n    ON fk.parent_object_id = c.object_id\n        AND fk.parent_column_id = c.column_id\nWHERE fk.referenced_object_id = (\n        SELECT object_id\n        FROM sys.tables\n        WHERE NAME = 'MAIN_TABLE'\n        )\n</code></pre>\n\n<p>Query 2:</p>\n\n<pre><code>SELECT COUNT(MAIN_ID)\nFROM MAIN_TABLE\nINNER JOIN REF_TABLE_1\n    ON MAIN_TABLE.ID = REF_TABLE_1.MAIN_ID\n</code></pre>\n\n<p>Query 3:</p>\n\n<pre><code>SELECT COUNT(MAIN_ID)\nFROM MAIN_TABLE\nINNER JOIN REF_TABLE_2\n    ON MAIN_TABLE.ID = REF_TABLE_2.MAIN_ID\n</code></pre>\n\n<p>etc.</p>\n\n<p>Is it possible to have it in one query?</p>\n"},{"tags":["sql","sql-server","tsql","gaps-and-islands"],"answer_count":6,"favorite_count":4,"up_vote_count":4,"down_vote_count":3,"view_count":1084,"score":1,"question_id":808356,"title":"How to Determine Values for Missing Months based on Data of Previous Months in T-SQL","body":"<p>I have a set of transactions occurring at specific points in time:</p>\n\n<pre><code>CREATE TABLE Transactions (\n    TransactionDate Date NOT NULL,\n    TransactionValue Integer NOT NULL\n)\n</code></pre>\n\n<p>The data might be:</p>\n\n<pre><code>INSERT INTO Transactions (TransactionDate, TransactionValue)\nVALUES ('1/1/2009', 1)\nINSERT INTO Transactions (TransactionDate, TransactionValue)\nVALUES ('3/1/2009', 2)\nINSERT INTO Transactions (TransactionDate, TransactionValue)\nVALUES ('6/1/2009', 3)\n</code></pre>\n\n<p>Assuming that the TransactionValue sets some kind of level, I need to know what the level was between the transactions. I need this in the context of a set of T-SQL queries, so it would be best if I could get a result set like this:</p>\n\n<pre><code>Month   Value\n1/2009  1\n2/2009  1\n3/2009  2\n4/2009  2\n5/2009  2\n6/2009  3\n</code></pre>\n\n<p>Note how, for each month, we either get the value specified in the transaction, or we get the most recent non-null value.</p>\n\n<p>My problem is that I have little idea how to do this! I'm only an \"intermediate\" level SQL Developer, and I don't remember ever seeing anything like this before. Naturally, I could create the data I want in a program, or using cursors, but I'd like to know if there's a better, set-oriented way to do this.</p>\n\n<p>I'm using SQL Server 2008, so if any of the new features will help, I'd like to hear about it.</p>\n\n<p>P.S. If anyone can think of a better way to state this question, or even a better subject line, I'd greatly appreciate it. It took me quite a while to decide that \"spread\", while lame, was the best I could come up with. \"Smear\" sounded worse.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000","gaps-and-islands"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":7755,"score":1,"question_id":1490566,"title":"How to display all the dates between two given dates in SQL","body":"<p>Using SQL server 2000. If the Start date is <code>06/23/2008</code> and End date is <code>06/30/2008</code></p>\n\n<p>Then I need the Output of query as</p>\n\n<pre><code>06/23/2008\n06/24/2008\n06/25/2008\n.\n.\n.\n06/30/2008\n</code></pre>\n\n<p>I Created a Table names as Integer which has 1 Column, column values are 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 then I used the below mentioned query</p>\n\n<p>Tried Query</p>\n\n<pre><code>SELECT DATEADD(d, H.i * 100 + T .i * 10 + U.i, '\" &amp; dtpfrom.Value &amp; \"') AS Dates \n  FROM integers H \nCROSS JOIN integers T \nCROSS JOIN integers U \norder by dates\n</code></pre>\n\n<p>The above query is displaying 999 Dates only. 999 Dates means (365 + 365 + 269) Dates Only.  Suppose I want to select more than 3 Years (01/01/2003 to 01/01/2008). The above query should not suitable. </p>\n\n<p>How to modify my query? Or any other query is available for the above condition.   </p>\n\n<p>Please kindly provide me the Query.</p>\n"},{"tags":["sql","tsql","sql-server-2005","gaps-and-islands"],"answer_count":2,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":638,"score":3,"question_id":3609687,"title":"Iterating through dates in SQL","body":"<p>I have a table of data that looks a bit like this:</p>\n\n<pre><code>Name    StartTime              FinishTime              Work\nBob     2010-08-03 08:00:00    2010-08-03 12:00:00     4\nBob     2010-08-03 13:00:00    2010-08-03 16:00:00     3\nPete    2010-08-04 08:00:00    2010-08-04 12:00:00     4\nMark    2010-08-04 10:00:00    2010-08-04 12:00:00     2\n</code></pre>\n\n<p>None of these date ranges should ever span over midnight.<br>\nI want to write SQL that will give me the following output, given an input Start Date of 2010-08-02 and a Finish Date of 2010-08-05</p>\n\n<pre><code>Date          Name   TotalWork\n2010-08-03    Bob    7\n2010-08-03    Pete   3\n2010-08-04    Pete   4\n2010-08-04    Mark   2 \n</code></pre>\n\n<p>I could live with, and in fact may ultimately need, to have any days that do not have work associated also be represented in the results set, maybe as a row like this:</p>\n\n<pre><code>2010-08-05     NULL   0\n</code></pre>\n\n<p>I'm not quite sure how to iterate through dates in SQL in the same way that I would with other languages.</p>\n\n<p>To give this some context, the output of this will ultimately plug into a Stacked Chart .Net control.</p>\n\n<p>Could someone give me a clue, a link to a tutorial or some other help?  Otherwise I think I'll be fiddling with this for days!</p>\n\n<p>Thank you!</p>\n\n<p>Jonathan</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","gaps-and-islands"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":764,"score":0,"question_id":1659580,"title":"Generate missing dates + Sql Server (SET BASED)","body":"<p>I have the following </p>\n\n<pre><code>id eventid  startdate enddate\n\n1 1     2009-01-03 2009-01-05\n1 2     2009-01-05 2009-01-09\n1 3     2009-01-12 2009-01-15\n</code></pre>\n\n<p>How to generate the missing dates pertaining to every eventid?</p>\n\n<p>Edit:\n<strong>The missing gaps are to be find out based on the eventid's. e.g. for eventid 1 the output should be 1/3/2009,1/4/2009,1/5/2009.. for eventtype id 2 it will be 1/5/2009, 1/6/2009... to 1/9/2009 etc</strong></p>\n\n<p>My task is to find out the missing dates between two given dates.</p>\n\n<p>Here is the whole thing which i have done so far</p>\n\n<pre><code>declare @tblRegistration table(id int primary key,startdate date,enddate date)\ninsert into @tblRegistration \n    \tselect 1,'1/1/2009','1/15/2009'\ndeclare @tblEvent table(id int,eventid int primary key,startdate date,enddate date)\ninsert into @tblEvent \n    \tselect 1,1,'1/3/2009','1/5/2009' union all\n    \tselect 1,2,'1/5/2009','1/9/2009' union all\n    \tselect 1,3,'1/12/2009','1/15/2009'\n\n;with generateCalender_cte as\n(\n    select cast((select  startdate from @tblRegistration where id = 1 )as datetime) DateValue\n       union all\n        select DateValue + 1\n        from    generateCalender_cte   \n        where   DateValue + 1 &lt;= (select enddate from @tblRegistration where id = 1)\n)\nselect DateValue as missingdates from generateCalender_cte\nwhere DateValue not between '1/3/2009' and '1/5/2009'\nand DateValue not between '1/5/2009' and '1/9/2009'\nand DateValue not between '1/12/2009'and'1/15/2009'\n</code></pre>\n\n<p>Actually what I am trying to do is that, I have generated a calender table and from there I am trying to find out the missing dates based on the id's</p>\n\n<p>The ideal output will be</p>\n\n<pre><code>eventid                    missingdates\n\n1             2009-01-01 00:00:00.000\n\n1             2009-01-02 00:00:00.000\n\n3             2009-01-10 00:00:00.000\n\n3            2009-01-11 00:00:00.000\n</code></pre>\n\n<p>and also it has to be in SET BASED and the start and end dates should not be hardcoded</p>\n\n<p>Thanks in adavnce</p>\n"},{"tags":["tsql","sql-azure"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12333931,"title":"Get used/unused database capacity in SQL Azure Federation","body":"<p>How could I retrieve the size (in MB or GB) of all federated databases in SQL Azure Federation? What's the TSQL for getting the used space and unused space across all members? </p>\n"},{"tags":["sql-server","database","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":49,"score":2,"question_id":12338697,"title":"Can't execute a COMPUTE statement","body":"<p>I am trying to execute this simple statement on Northwind database</p>\n\n<pre><code>USE Northwind\nSELECT  productid, orderid,quantity \nFROM [order details]\nORDER BY productid, orderid\nCOMPUTE SUM(quantity)\nGO\n</code></pre>\n\n<p>But I this can't execute , I got this error</p>\n\n<blockquote>\n  <p><em>Msg 156, Level 15, State 1, Line 5<br>\n  Incorrect syntax near the keyword 'COMPUTE'.</em></p>\n</blockquote>\n"},{"tags":["tsql","nant"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12339825,"title":"Why is NAnt executing my sql scripts in the wrong order?","body":"<p>Here is my Script:</p>\n\n<pre><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;project name=\"createAndPopulateDB\" default=\"deploy\"&gt;\n    &lt;property name=\"sql.connstring\" value=\"Provider=SQLOLEDB;Server=G-PC\\sqlexpress;Integrated Security=SSPI\" /&gt;\n    &lt;property name=\"createDB\" value=\"BuildTestDatabase.sql\" /&gt;\n    &lt;property name=\"populateDB\" value=\"CreateTables.sql\"/&gt;\n&lt;target name=\"deploy\"&gt;\n    &lt;echo message=\"* Connecting to ${sql.connstring}\"/&gt;\n    &lt;foreach item=\"File\" property=\"sql.script\"&gt;\n        &lt;in&gt;\n            &lt;items&gt;\n                &lt;include name=\"${createDB}\" /&gt; \n                &lt;include name=\"${populateDB}\" /&gt;\n            &lt;/items&gt;\n        &lt;/in&gt;\n        &lt;do&gt;\n            &lt;echo message=\"* Executing ${path::get-file-name(sql.script)}\"/&gt;\n            &lt;sql connstring=\"${sql.connstring}\" delimiter=\"go\" delimstyle=\"Line\" batch=\"false\" source=\"${sql.script}\"/&gt;\n        &lt;/do&gt;\n    &lt;/foreach&gt;\n&lt;/target&gt;\n&lt;/project&gt;\n</code></pre>\n\n<p>The NAnt script is supposed to call two tsql programs.  The first tsql is designed to drop a database if it is present, and if it isn't, create it.  The second checks to see if a table is present, and if so, delete it.  Similarly if it isn't, it populates the created database with a simple table.</p>\n\n<p>My question is why does it run the populateDB script first?  </p>\n"},{"tags":["c#","asp.net","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":80,"score":0,"question_id":12332434,"title":"how to mark records that are read in mssql","body":"<p>I have created a system that sends some information by SMS daily to our customers. as the procedure of sending SMS can take a while this is done by multiple processes that each process sends a limited number of SMSs. when a Process reads a number of records of pohne nubers (lets say 1000 of them) to send sms. I want to mark these 1000 records that the other process wouldn't read these records too.</p>\n\n<pre><code>Select Top(1000) ID, Number from Phones where isactive = 1 and isverified = 1\n</code></pre>\n\n<p>I need some code that does something like this:</p>\n\n<p><code>update Phones, set ReadTime = getdate() where</code> (selected above)</p>\n\n<p>now I want to update the column <code>ReadTime</code> of these records to <code>getdate()</code> to make sure that other schduled processes won't read them again (the reason i'm setting a datetime flag instead of a Bit flag is that some SMS sending might fail and this way I can understand which ones are read long ago but not updated the sent time)</p>\n\n<p>marking them after sending the sms (that should be done anyway to write sent time) wouldn't help as the the scheduled taks that will process the sending SMSs will read all 1000 records at once and there might be records that are read by other processes but not flaged yet (as the SMS hasn't been sent yet).</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","inner-join"],"answer_count":1,"favorite_count":5,"up_vote_count":13,"down_vote_count":0,"view_count":393,"score":13,"question_id":5901791,"title":"Is having an 'OR' in an INNER JOIN condition a bad idea?","body":"<p>In trying to improve the speed of an immensely slow query (several <em>minutes</em> on two tables with only ~50,000 rows each, on SQL Server 2008 if it matters), I narrowed down the problem to an <code>OR</code> in my inner join, as in:</p>\n\n<pre><code>SELECT mt.ID, mt.ParentID, ot.MasterID\n  FROM dbo.MainTable AS mt\n  INNER JOIN dbo.OtherTable AS ot ON ot.ParentID = mt.ID\n                                  OR ot.ID = mt.ParentID\n</code></pre>\n\n<p>I changed this to (what I hope is) an equivalent pair of left joins, shown here:</p>\n\n<pre><code>SELECT mt.ID, mt.ParentID,\n   CASE WHEN ot1.MasterID IS NOT NULL THEN\n      ot1.MasterID ELSE\n      ot2.MasterID END AS MasterID\n  FROM dbo.MainTable AS mt\n  LEFT JOIN dbo.OtherTable AS ot1 ON ot1.ParentID = mt.ID\n  LEFT JOIN dbo.OtherTable AS ot2 ON ot2.ID = mt.ParentID\n  WHERE ot1.MasterID IS NOT NULL OR ot2.MasterID IS NOT NULL\n</code></pre>\n\n<p>.. and the query now runs in about a second!</p>\n\n<p>Is it generally a bad idea to put an <code>OR</code> in a join condition?  Or am I just unlucky somehow in the layout of my tables?</p>\n"},{"tags":["c#","linq","entity-framework","tsql","linq-to-entities"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":100,"score":4,"question_id":12337670,"title":"Conditional WHERE in LINQ","body":"<p>Hi any suggestions on building a LINQ statement based on search criteria?</p>\n\n<p>I'll be passing in an instance of a 'SearchCriteria' class with all parameters nullable.</p>\n\n<p>I then want to </p>\n\n<pre><code>if (sc.a != null)\n    // add to where\n\nif (sc.b != null)\n    // add to where\n</code></pre>\n\n<p>The key thing is these are to be ORs not ANDs.</p>\n\n<p>Any tips?</p>\n\n<p>And for bonus points I'd like to use 'contains' on an int? but I can only get equals or not equals.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":283,"score":1,"question_id":12266518,"title":"SQL Server date format MM/DD/YYYY","body":"<p>How do I check if a date string is in the MM/DD/YYYY format in SQL Server?</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12332395,"title":"How to initiate a THROW on a stored procedure if there are 0 results?","body":"<p>I was wondering what I would have to do to throw an exception on the following stored procedure if there were 0 results so it could select the NULL row? This is for MSSQL, thanks so much.</p>\n\n<pre><code>...\n\nBEGIN TRY\n    -- SET NOCOUNT ON added to prevent extra result sets from\n    -- interfering with SELECT statements.\n    SET NOCOUNT ON;\n\n    SELECT\n        NoteId,\n        Url,\n        Subject,\n        Content,\n        ExpiresAt,\n        RemindAt\n    FROM dbo.browsingnotes_Notes\n    WHERE UserId = @UserId\n        AND Hash = @Hash\nEND TRY\nBEGIN CATCH\n    SELECT\n        NULL AS 'NoteId',\n        NULL AS 'Url',\n        NULL AS 'Subject',\n        NULL AS 'Content',\n        NULL AS 'ExpiresAt',\n        NULL AS 'RemindAt'\nEND CATCH\n</code></pre>\n"},{"tags":["c#","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":128,"score":1,"question_id":12317109,"title":"SQL Table valued parameters from C#","body":"<p>Just a few years behind, but I discovered table valued parameters for stored procedures/UDFs today.  They are the ideal solution to a problem I'm having, but I can't get them to work from C#.</p>\n\n<p>I have a UDF:</p>\n\n<pre><code>CREATE FUNCTION GetSurveyScores\n    @Survey     bigint, \n    @Question   nvarchar(max),\n    @Area       StringList      READONLY,\n    @JobCode    StringList      READONLY\nAS BEGIN\n\n    SELECT * FROM SurveyResults WHERE RespondentArea IN (Select val from @Area) AND RespondentJobCode IN (select val from @JobCodes)\nEND\n</code></pre>\n\n<p>(StringList is the type I created, it's just a table valued type with a single column called val, defined as nvarchar(256))</p>\n\n<p>Then from SQL Server Management Studio, I can do this:</p>\n\n<pre><code>declare @area StringList;\ninsert into @area(val) values('NW'),('NE'),('SW');\n// Get all survey respondent job codes from the SurveyRespondent table.\ndeclare @jobcodes StringList;\ninsert into @jobcodes select distinct jobcode from dbo.SurveyRespondent;\n\nselect * from dbo.GetSurveyScores(3, 'Q3', @area, @jobcodes)\n</code></pre>\n\n<p>That works brilliantly.</p>\n\n<p>From C#, I get no results (no exceptions), using this code: (I'm using DataTables because the actual code I intend to drop this into uses DataTables already)</p>\n\n<pre><code>DataTable areas = new DataTable(\"StringList\");\nareas.Columns.Add(\"val\");\nareas.Rows.Add(\"NW\"); areas .Rows.Add(\"NE\"); areas .Rows.Add(\"SW\");\n\nDataTable jobcodes = new DataTable(\"StringList\");\njobcodes.Columns.Add(\"val\");\njobcodes.Rows.Add(\"JC1\"); jobcodes .Rows.Add(\"JC2\");    \n\nSqlCommand cmd = new SqlCommand(\"SELECT * FROM dbo.GetSurveyScores(3, 'Q3', @area, @jc)\", connection);\ncmd.Parameters.AddWithValue(\"@area\", areas);\ncmd.Parameters[\"@area\"].SqlDbType = SqlDbType.Structured;\ncmd.Parameters[\"@area\"].TypeName = \"StringList\";\n\ncmd.Parameters.AddWithValue(\"@jc\", jobcodes);\ncmd.Parameters[\"@jc\"].SqlDbType = SqlDbType.Structured;\ncmd.Parameters[\"@jc\"].TypeName = \"StringList\";\n\nDataTable results = new DataTable();\nusing (SqlDataAdapter da = new SqlDataAdapter(cmd)) {\n\n    da.Fill(results);\n\n}\n\nConsole.WriteLine(results.Rows.Count);\n</code></pre>\n\n<p>The final line prints 0.  I'm sure I must be missing something simple, but after 6 hours of trying, I think I need a new set of eyes to look at it.</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":108,"score":4,"question_id":11768587,"title":"ON is part of syntax","body":"<p>Is it possible to write inner join or outer join without specfying the condition?\nIs <code>ON condition</code> is part of the syntax of join condition?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12326863,"title":"Do I need to use the dreaded sql server loop/ cursor for the result set I need?","body":"<p>I need a sql server result set that \"breaks\" on a column value, but if I order by this column in a ranking function, the order I really need is lost. This is best explained by example. The query I'm currently experimenting with is:</p>\n\n<pre><code>select RANK() over(partition by Symbol, Period order by TradeDate desc) \n    SymbSmaOverUnderGroup, Symbol, TradeDate, Period, Value, Low, LowMinusVal,\n    LMVSign\nfrom #smasAndLow3\n</code></pre>\n\n<p>and it returns:</p>\n\n<pre><code>Rnk Symbol TradeDate Period Value  Low    LowMinusVal LMVSign\n1   A      9/6/12    5      37.09  36.71  -.38        U\n2   A      9/5/12    5      37.03  36.62  -.41        U\n3   A      9/4/12    5      37.07  36.71  -.36        U\n4   A      8/31/12   5      37.15  37.30   .15        O\n5   A      8/30/12   5      37.22  37.40   .18        O\n6   A      8/29/12   5      37.00  36.00  -1.00       U\n7   A      8/28/12   5      37.10  37.00  -.10        U\n</code></pre>\n\n<p>The rank I need here is: <code>1,1,1,2,2,3,3</code>. So I need to partition by Symbol, Period, and I need to start a new partition on LMVSign (which only contains the values U, O, and E), but it's essential that I order by TradeDate desc. Unless I'm mistaken, partitioning or ordering by LMVSign will make it impossible to sort on the date column. I hope this makes sense. I'm working like mad to do this without a cursor, but I can't get it to work.. thanks in advance.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":1,"view_count":82,"score":-1,"question_id":12325958,"title":"I want to order by alternating numbers in MS SQL like 1, 2, 3, 1, 2, 3 etc","body":"<p>I have a table in an MS SQL database with a column containing the value 1 or 2 or 3</p>\n\n<p>Now I would like to do an ORDER BY where I get the records like this 1,2,3,1,2,3,1,2,3</p>\n\n<p>This looks harder then it is.. I've been programming for like 10 years and this one got me stuck ;-)</p>\n\n<p>Anyone have any good ideas? </p>\n"},{"tags":["tsql","azure","sql-azure"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12325538,"title":"SQL Azure: Get Table Name on CREATE TABLE TRIGGER","body":"<p>In SQL Server 2008, I had a DDL Trigger that was getting the table name of a table being created with the following trigger:</p>\n\n<pre><code>CREATE TRIGGER [tr_getName] ON DATABASE FOR CREATE_TABLE \nAS \n\nDECLARE @xmlEventData XML\nDECLARE @TableName varchar(128)\n-- Capture the event data that is created\nSET @xmlEventData = eventdata()\n\nIF OBJECT_ID('dbo.tNames', 'U') IS NOT NULL\nBEGIN\n    DeAllocate tNames\nEND \n\nDECLARE tNames CURSOR Read_Only\nFOR SELECT CONVERT(VARCHAR(128), @xmlEventData.query('data(/EVENT_INSTANCE/ObjectName)'))\nOPEN tNames\n\nFETCH Next FROM tNames\n    INTO @TableName\n...\n...\n</code></pre>\n\n<p>However, in SQL Azure eventdata() is no longer supported. Is there a way to accomplish the equivalent in SQL Azure?\nThank you</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12325373,"title":"Is public void Execute(string sql) considered dangerous?","body":"<p>Is it considered dangerous if I implement a method like this in my assembly?</p>\n\n<pre><code> public void Execute(string sql)\n        {\n            using (SqlConnection connection = new SqlConnection(\"MyConnectionString.....\"))\n            {\n                SqlCommand command = new SqlCommand(sql, connection);\n                connection.Open();\n                command.ExecuteNonQuery();                \n            }\n        }\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":68,"score":3,"question_id":12323529,"title":"How can I get a row count from all tables based on specific criteria","body":"<p>I can get the row count of all tables using this query.</p>\n\n<pre><code>    SELECT '[' + SCHEMA_NAME(t.schema_id) + '].[' + t.name + ']' AS fulltable_name, SCHEMA_NAME(t.schema_id) AS schema_name, t.name AS table_name,\n    i.rows\n    FROM sys.tables AS t INNER JOIN\n    sys.sysindexes AS i ON t.object_id = i.id AND i.indid &lt; 2\n\n**AND\nt.name.programID = 4**\n</code></pre>\n\n<p>but I need to count all rows where programID = n\nI keep getting the following error when adding the bolded line to the where clause</p>\n\n<p>Cannot call methods on nvarchar.\nAny help is greatly needed an appreciated\nAndy</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":89,"score":0,"question_id":12322874,"title":"How to delete duplicate record where PK is uniqueidentifier field","body":"<p>I want to know the way we can remove duplicate records where PK is uniqueidentifier.\nI have to delete records on the basis of duplicate values in a set of fields.we can use option to get temptable using Row_Number() and except row number one we can delete rest or the records.\nBut I wanted to build one liner query. Any suggestion?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":93,"score":0,"question_id":12322627,"title":"if more than 1 match, do not return 'unknown'","body":"<p>I composed a monster query. I'm certain that it can be optimized, and I would more than appreciate any comments/guidance on the query itself; however, I have a specific question:</p>\n\n<p>The data I am returning is sometimes duplicated on multiple columns:</p>\n\n<pre><code>+-------+------+----------+------+-------+--------+----------+-------+------+\n| first | last |  deaID   | cert | count |  npi   | clientid | month | year |\n+-------+------+----------+------+-------+--------+----------+-------+------+\n| Alex  | Jue  | UNKNOWN  | MD   |    11 | 123123 |   102889 |     7 | 2012 |\n| Alex  | Jue  | BJ123123 | MD   |    11 | 123123 |   102889 |     7 | 2012 |\n+-------+------+----------+------+-------+--------+----------+-------+------+\n</code></pre>\n\n<p>as you can see all of the fields are equal except for <code>deaID</code></p>\n\n<p>in this case, I would like to only return:</p>\n\n<pre><code>+------+-----+----------+----+----+--------+--------+---+------+\n|      |     |          |    |    |        |        |   |      |\n+------+-----+----------+----+----+--------+--------+---+------+\n| Alex | Jue | BJ123123 | MD | 11 | 123123 | 102889 | 7 | 2012 |\n+------+-----+----------+----+----+--------+--------+---+------+\n</code></pre>\n\n<p>however, if there are no duplicates:</p>\n\n<pre><code>+-------+------+---------+------+-------+--------+----------+-------+------+\n| first | last |  deaID  | cert | count |  npi   | clientid | month | year |\n+-------+------+---------+------+-------+--------+----------+-------+------+\n| Alex  | Jue  | UNKNOWN | MD   |    11 | 123123 |   102889 |     7 | 2012 |\n+-------+------+---------+------+-------+--------+----------+-------+------+\n</code></pre>\n\n<p>then i would like to keep it!</p>\n\n<p><strong>summary</strong>\nif there are duplicates remove all records with <code>'deaID=unknown'</code>; however, if there is only 1 match then return that match</p>\n\n<p><strong>question</strong>\nhow do i return <code>unknown</code> records IFF there is 1 match?</p>\n\n<p>here is the monster query in case anybody is interested :)</p>\n\n<pre><code>with ctebiggie  as (\n\nselect distinct\np.[IMS_PRESCRIBER_ID],\np.PHYSICIAN_NPI as MLISNPI,\na.CLIENT_ID,\np.MLIS_FIRSTNAME,\np.MLIS_LASTNAME,\np_address.IMS_DEA_NBR,\np.IMS_PROFESSIONAL_ID_NBR,\np.IMS_PROFESSIONAL_ID_NBR_src,\np.IMS_CERTIFICATION_CODE,\ndatepart(mm,a.RECEIVED_DATE) as [Month],\ndatepart(yyyy,a.RECEIVED_DATE) as [Year]\n\nfrom\n\nMILLENNIUM_DW_dev..D_PHYSICIAN p\nleft outer join\nMILLENNIUM_DW_dev..F_ACCESSION_DAILY a\non a.REQUESTOR_NPI=p.PHYSICIAN_NPI\nleft outer join MILLENNIUM_DW_dev..D_PHYSICIAN_ADDRESS p_address\non p.PHYSICIAN_NPI=p_address.PHYSICIAN_NPI\n\nwhere \na.RECEIVED_DATE is not null\n--and p.IMS_PRESCRIBER_ID is not null\n--and p_address.IMS_DEA_NBR !='UNKNOWN'\nand p.REC_ACTIVE_FLG=1\nand p_address.REC_ACTIVE_FLG=1\nand DATEPART(yyyy,received_date)=2012\n  and DATEPART(mm,received_date)=7\n\n\ngroup by \np.[IMS_PRESCRIBER_ID],\np.PHYSICIAN_NPI,\np.IMS_PROFESSIONAL_ID_NBR,\np.MLIS_FIRSTNAME,\np.MLIS_LASTNAME,\np_address.IMS_DEA_NBR,\np.IMS_PROFESSIONAL_ID_NBR,\np.IMS_PROFESSIONAL_ID_NBR_src,\np.IMS_CERTIFICATION_CODE,\ndatepart(mm,a.RECEIVED_DATE),\ndatepart(yyyy,a.RECEIVED_DATE),\na.CLIENT_ID\n\n)\n,\nctecount as \n(select\n COUNT (Distinct f.ACCESSION_ID) [count],\n f.REQUESTOR_NPI,f.CLIENT_ID,\n datepart(mm,f.RECEIVED_DATE) mm,\ndatepart(yyyy,f.RECEIVED_DATE)yyyy\nfrom MILLENNIUM_DW_dev..F_ACCESSION_DAILY f\n\nwhere \n f.CLIENT_ID not in (select * from SalesDWH..TestPractices)\n\n and DATEPART(yyyy,f.received_date)=2012\n  and DATEPART(mm,f.received_date)=7\n\n\ngroup by f.REQUESTOR_NPI,\nf.CLIENT_ID,\ndatepart(mm,f.RECEIVED_DATE),\ndatepart(yyyy,f.RECEIVED_DATE)\n)\n\nselect ctebiggie.*,c.* from\nctebiggie\nfull outer join\nctecount c\non c.REQUESTOR_NPI=ctebiggie.MLISNPI\nand c.mm=ctebiggie.[Month]\nand c.yyyy=ctebiggie.[Year]\nand c.CLIENT_ID=ctebiggie.CLIENT_ID\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sum"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":73,"score":2,"question_id":12322682,"title":"Obtaining Sums from Multiple Tables","body":"<p>I'm having an issue extracting Sums from multiple tables in a single SQL statement.</p>\n\n<p>I have three tables tblCases, tblTimesheetEntries and tblInvoices\nThere is a one to many relationship between tblCases and each of the other two tables.</p>\n\n<p>I am using the following SQL statement at the moment</p>\n\n<pre><code>SELECT c.CaseNo, SUM(i.InvFees), SUM(t.Fees)\nFROM tblCases AS c\nINNER JOIN tblInvoices AS i ON c.CaseNo = i.CaseNo\nINNER JOIN tblTimesheetEntries AS t ON c.CaseNo = t.CaseNo\nGROUP BY c.CaseNo\nORDER BY c.CaseNo;\n</code></pre>\n\n<p>However, this seems to duplicate the invoice amounts.  For example if there is only one invoice on a case, but say 4 timesheet entries, it calculates 4 x the invoice amount as the Sum for that table.</p>\n\n<p>If I take the grouping out and run the following SQL instead:</p>\n\n<pre><code>SELECT c.CaseNo, i.InvFees, t.Fees\nFROM tblCases AS c\nINNER JOIN tblInvoices AS i ON c.CaseNo = i.CaseNo\nINNER JOIN tblTimesheetEntries AS t ON c.CaseNo = t.CaseNo    \nORDER BY c.CaseNo;\n</code></pre>\n\n<p>I can see that this is happening because the invoice amount is repeated in all 4 lines e.g.</p>\n\n<pre><code>Case 1001,  Inv 001  950.00,  TimeFees  250.00\nCase 1001,  Inv 001  950.00,  TimeFees  175.00\nCase 1001,  Inv 001  950.00,  TimeFees  225.00\nCase 1001,  Inv 001  950.00,  TimeFees  190.00\n</code></pre>\n\n<p>So the total of the invoices is four times the amount of Invoice 001.</p>\n\n<p>What I would like returning from the above data is a single summation line:</p>\n\n<pre><code>Case 1001,  Total Invoices 950.00,  Total TimeFees 840.00\n</code></pre>\n\n<p>How do I avoid this duplication in the summations?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":71,"score":1,"question_id":12321021,"title":"Is there a better way to do this WHERE?","body":"<p>My SQL is a little rusty and was just curious if there is a better way to do this WHERE clause? Assuming that there is a way, which I'm sure there is. It's runs pretty quick as it is, but I just don't like it and would like to know if it can be improved upon.</p>\n\n<pre><code>SELECT DISTINCT p.firstname              ,\n            p.middlename             ,\n            p.lastname               ,\n            p.gender                 ,\n            p.dob                    ,\n            p.id      AS patientid   ,\n            pr.id     AS practiceid  ,\n            pr.[name] AS practicename,\n            pr.parentaco             ,\n            pp.encounterdate\nFROM            ((aco.patients_practices patients_practices\n            LEFT OUTER JOIN aco.patients p\n            ON              (\n                             patients_practices.patientid = p.id\n                            )\n            )\n            LEFT OUTER JOIN aco.practices pr\n            ON              (\n                             patients_practices.practiceid = pr.id\n                            )\n            )\n            INNER JOIN aco.patientpreferences pp\n            ON              (\n                             pp.patientid = p.id\n                            )\nWHERE           (\n                            pr.parentaco =\n                            (SELECT parentaco\n                            FROM    aco.practices\n                            WHERE   master_companyid = 763\n                            )\n            OR              pr.id =\n                            (SELECT parentaco\n                            FROM    aco.practices\n                            WHERE   master_companyid = 763\n                            )\n            )\nAND             pp.encounterdate IS NOT NULL\n</code></pre>\n"},{"tags":["tsql","ssrs-2008","expression"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":162,"score":0,"question_id":12290772,"title":"SSRS Variable Expression - Sum, Sum, Scope?","body":"<p>I'm trying to write an expression for a variable (not parameter), so that I can use/reference it to do a calculation in another textbox. I have multiple datasets, and I need the SUM(SUM(Fields!amount.Value)) for each of these datasets. I am then going to use these numbers in another textbox, adding them with each other.  I need some assistance with the syntax. I am able to use SUM by itself, without an issue.  For example, this works fine:</p>\n\n<pre><code>=SUM(Fields!Amount.Value, \"DataSet1\")\n</code></pre>\n\n<p>But I get an error when trying to amend it to the following (which is what I actually need):</p>\n\n<pre><code>=SUM(SUM(Fields!amt.Value, \"Acctrange_90300_90399_InterestExpenses\"))\n</code></pre>\n\n<p>I get an error saying \"The variable expression for the report 'body' uses an aggregate expression without a scope.  A scope is required for all aggregates used outside of a data region unless the report contains exactly one dataset.\"  I have a hunch that there's a problem with my syntax/parantheses placement.  Any suggestions?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","join"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":5,"view_count":99,"score":-3,"question_id":12318452,"title":"SQL Server - Join Query","body":"<p>Here are my tables </p>\n\n<pre><code>  StudentID    Name\n    ----------   ------\n      1          Mary\n      2          John\n      3          Peter\n      4          Edwards\n\n   ClassID      StudentIDs\n    --------    -----------\n      1          1,2\n      2          3,4\n\n    **Output Expected**\n\n    ClassID   Names\n    -------   -------\n\n        1      Mary,John\n        2      Peter,Edwards\n</code></pre>\n"},{"tags":["c#","tsql","stored-procedures","datatable"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":70,"score":0,"question_id":12318050,"title":"Merge tables(add, update and delete records from different sources)","body":"<p>I have three tables tb1,tb2 and tbTotal. They have the same schemas. The tables have three columns, MetricID, Descr and EntryDE.</p>\n\n<p>What I want is to merge tb1 with tbTotal. I have done this and it works fines.\nMy stored procedure is:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[Admin_Fill] \n-- Add the parameters for the stored procedure here\n@MetricId INT,\n@Descr VARCHAR(100),\n@EntryDE VARCHAR(20)\n AS\n\n BEGIN\n-- SET NOCOUNT ON added to prevent extra result sets from\n-- interfering with SELECT statements.\nSET NOCOUNT ON;\n--SET IDENTITY_INSERT dbo.tbTotal ON\n-- Insert statements for procedure here\n;WITH cte AS (SELECT MetricId=@MetricId,Descr=@Descr,EntryDE=@EntryDE)\n MERGE tbTotal d\n USING cte s\n ON s.EntryDE = d.EntryDE\n AND s.MetricId=d.MetricId\n WHEN matched THEN UPDATE\n set MetricId=s.MetricId,\n     Descr=s.Descr,\n     EntryDE=s.EntryDE\n WHEN not matched BY TARGET THEN\n INSERT(MetricId,Descr,EntryDE)\n VALUES (s.MetricId,s.Descr,s.EntryDE);\n END\n</code></pre>\n\n<p>My C# code:</p>\n\n<pre><code>        foreach (DataRow row in dt.Rows) // pass datatable dt1\n        {\n            MetricId = Convert.ToInt32(row[\"MetricId\"]);\n            Descr = row[\"Descr\"].ToString();\n            EntryDE = row[\"EntryDE\"].ToString();\n            parameters.Add(\"@MetricId\", MetricId);\n            parameters.Add(\"@Descr\", Descr);\n            parameters.Add(\"@EntryDE\", EntryDE);\n            dbaccess.ExecuteNonQuery(strStoredProcedure, parameters); //cmd.ExecuteNonQuery(); \n            parameters.Clear();\n        }\n</code></pre>\n\n<p>Also I want to remove all records in dt2 from dtTotal. I am not sure how to modify the stored procedure.</p>\n\n<p>Thanks for help.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":72,"score":1,"question_id":12306870,"title":"Drop databases on a server conditionally from a List ","body":"<p>I have created a list of databases I want to drop based on a set of conditions and have titled it <code>delete_table</code> in the master database (this already excludes master, tempdb, model and msdb). The only column in this table is <code>name</code> which contain the exact database names that should be deleted.</p>\n\n<p>How would I go about writing the script that would drop the databases on the server based on this list?</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008","constraints"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":88,"score":0,"question_id":1026441,"title":"How do I specify a column to be unique in the scope of a relationship in SQL Server 2008?","body":"<p>It's easier with an example. I have two tables: Books and Chapters. Both have Title and Id columns. Chapters also has a Book column which is a foreign key to Books.Id. Books.Title is unique (I don't want two books with the same title).</p>\n\n<p>Now my problem is defining Chapter.Title uniqueness. I want it to be unique as long as Books.Id is the same. So that one book may not have two chapters with the same title but two different books may have the same title in a chapter.</p>\n\n<p>Is this possible on SQL Server 2008? How?</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12320008,"title":"T-SQL RETURN is not working","body":"<p>I have Problem with My T-SQL to see if the item EXISTS on the table but I have the error message  </p>\n\n<blockquote>\n  <p>Msg 178, Level 15, State 1, Line 2 A RETURN statement with a return\n  value cannot be used in this context. Msg 178, Level 15, State 1, Line\n  4 A RETURN statement with a return value cannot be used in this\n  context.</p>\n</blockquote>\n\n<pre><code>IF EXISTS(SELECT COUNT(timesheetID)\nFROM [TaskManagementSystem_DB].[dbo].[Timesheet_entry]\nWHERE userID ='12'  AND CONVERT(date, startTimeStamp)=CONVERT(date, getdate())) \n    RETURN 1\nelse\nRETURN 0\n</code></pre>\n\n<p>The whole code:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[CheckTimesheetIsEXISTS_forUser]  @UserID uniqueidentifier\n\nAS \nBEGIN    \n-- SET NOCOUNT ON added to prevent extra result sets from   \n-- interfering with SELECT statements.  SET NOCOUNT ON;\n\nIF EXISTS(SELECT COUNT(timesheetID) FROM \n [TaskManagementSystem_DB].[dbo].[Timesheet_entry] \n WHERE userID\n  ='3fd971f7-e6e8-40fe-a90d-a7c9df8bf7b5'  \n AND CONVERT(date, startTimeStamp)=CONVERT(date, getdate()))\n\n\n\n  RETURN 1 \nelse \n RETURN 0 \nEND\n</code></pre>\n"},{"tags":["tsql","while-loop","exists"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":64,"score":0,"question_id":12318188,"title":"TSQL loop WHERE NOT EXISTS","body":"<p>I have tables for roles and permissions with a join table called role_permissions.</p>\n\n<p>For every role, I want to insert a new permission if that role does not already possess the permission. The problem with my loop is that only a single row (role) is ever updated. The loop does not appear to properly re-evaluate the subquery (which finds the first role that does not have the permission) on each loop</p>\n\n<pre><code>DECLARE @role_id INT\n\nSET @role_id = (SELECT TOP 1 role_id FROM p_role_permissions WHERE NOT EXISTS (SELECT NULL FROM p_role_permissions WHERE permission_id = 57))\n\nWHILE @role_id IS NOT NULL\nBEGIN\n\nINSERT INTO p_role_permissions (role_id, permission_id) VALUES(@role_id, 57)\n-- does not appear to evaluate correctly (works only on the first loop)\nSET @role_id = (SELECT TOP 1 role_id FROM p_role_permissions WHERE NOT EXISTS (SELECT NULL FROM p_role_permissions WHERE permission_id = 57))\n\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12319419,"title":"Best way to get Count as field in Sql select statement","body":"<p>Best way to get Count as field in Sql select statement </p>\n\n<p>I have 2 tables: Person and Orders</p>\n\n<p>Person </p>\n\n<hr>\n\n<pre><code> Id            Name            Age\n 1            name1           1\n 2            name2           2\n</code></pre>\n\n<p>Order </p>\n\n<hr>\n\n<pre><code>Id            Amount           PersonId\n 1              30               1\n2              40               2\n3              30               2\n4              40               2\n5              30               1\n6              40               2\n7              30               1\n8              40               2\n</code></pre>\n\n<p>And i want users details with total number of orders , So for this purpose I have 2 solutions:</p>\n\n<pre><code> 1. select p.Name,p.Age,(select count(1) form orders o where o.personId= p.Id as       cntVal \n    from Person p\n\n 2. select p.Name,p.Age,cntVal \n    from Person p\n    inner join (select personId,count(1) as cntVal from orders o group by PersonId) cnt\n     on cnt.personId=p.Id\n</code></pre>\n\n<p>We have around 200K records in Person and 15K in Order table.\n I wanted to know which one is better approach ? \n Or you can suggest me a faster query</p>\n"},{"tags":["sql","database","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12277319,"title":"transport stored procedure securely","body":"<p>I am working on a project that has versions. If a new version is ready to publish, I prepare stored procedures to update the database by the DBA. I sent him the SPs and he executes them. However, I don't want the DBA to see my SP codes. Is it possible transport stored procedure without showing the code to the DBA.</p>\n"},{"tags":["sql","sql-server","performance","tsql","index"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12306856,"title":"Does it matter for DB efficiency what number is SQL Server's index column?","body":"<p>I'm creating a new SQL Server 2008 database and I was always wondering, efficiency-wise, does it matter where I place the index column?</p>\n\n<p>For instance, this:</p>\n\n<pre><code>--ID is primary key\nCREATE TABLE tbl (ID INT, dtIn DATETIME2, dtOut DATETIME2, Type INT)\nINSERT tbl VALUES\n(1, '01:30', '02:00', 1),\n(2, '02:30', '03:00', 1),\n(3, '10:30', '11:00', 2)\n\nCREATE INDEX idx_Type ON tbl(Type)\n</code></pre>\n\n<p>versus this:</p>\n\n<pre><code>--ID is primary key\nCREATE TABLE tbl (ID INT, Type INT, dtIn DATETIME2, dtOut DATETIME2)\nINSERT tbl VALUES\n(1, 1, '01:30', '02:00'),\n(2, 1, '02:30', '03:00'),\n(3, 2, '10:30', '11:00')\n\nCREATE INDEX idx_Type ON tbl(Type)\n</code></pre>\n"},{"tags":["c#",".net","sql-server","database","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":41,"score":1,"question_id":12312232,"title":"How to return a field from MSSQL based on the value of two other fields","body":"<p>I'm a MySQL guy these days and have a .NET project that I'm working on and can't figure out how to dynamically generate and return a field(column) from a table, based on two fields in the table.</p>\n\n<p>There are two fields bRentable and bRented in the Units table and I need to return a field called reserved if bRentable and bRented are equal to zero.</p>\n\n<p>Here is the SQL I have so far</p>\n\n<pre><code>/* Units Query */\nSELECT Units.UnitID, Units.dcWidth, Units.dcLength, Units.dcPushRate, \n       Units.dcStdRate, Units.UnitTypeID, UnitTypes.sTypeName, Units.bRentable     \nFROM Units\nINNER JOIN UnitTypes ON Units.UnitTypeID = UnitTypes.UnitTypeID\n</code></pre>\n\n<p>Any help would be greatly appreciated. </p>\n"},{"tags":["sql","sql-server","oracle","tsql","plsql"],"answer_count":8,"favorite_count":24,"up_vote_count":35,"down_vote_count":1,"view_count":83298,"score":34,"question_id":2322260,"title":"Basic differences between Oracle and SQL Server?","body":"<p>I am going on a job interview and have zero experience with MS SQL Server. However I have 1 year with Oracle. Is there such a huge difference between the two? What programming questions can I expect?</p>\n"},{"tags":["visual-studio","tsql","reporting-services","mdx","business-intelligence"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":214,"score":0,"question_id":12307183,"title":"SSRS/MDX - Parameter value as a Column Header","body":"<p>Using SSRS and MDX</p>\n\n<p>Goal: pull parameter value and show it as the header text for a column</p>\n\n<p>Specs: parameter value is in MDX format.Only one parameter value at a time report generation. This value is populated based on what the person clicked in previous report. </p>\n\n<p>i.e. \nIf the person clicks on Did You Get Proper Help? Hyperlink, the next report will have the following value for TextName parameter</p>\n\n<p>[Questionnaire].[Question Hierarchy].[Question Name].&amp;[Did You Get Proper Help?] </p>\n\n<p>I want to show just Did You Get Proper Help? as the name of the header in one of the columns without the other stuff.</p>\n\n<p>The Did You Get Proper Help? is just an example of many options the user can click on in previous report. Based on what text hyperlink they click, the parameter value will be populated and that is what I need to show as the header name of one of the columns.</p>\n\n<p>I am not sure how to tackle this problem. </p>\n\n<p>Thank you</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12308174,"title":"CTE not working with extra join clause","body":"<p>Can someone tell me why this returns 0 records when I add the extra join information for [PropertyId]? I know this is something simple but, I'm at a loss.</p>\n\n<pre><code>declare @ViewId as int;\n\nset @ViewId = 11;\n\nwith Views\nas\n(\n    select [LiveWireView].[Id], [LiveWireView].[Name], [LiveWireView].[ParentId], [PropertyToViewMap].[PropertyId]\n    from [LiveWireView]\n    inner join [PropertyToViewMap] on [PropertyToViewMap].[ViewId] = [LiveWireView].[Id]\n    where [LiveWireView].[Id] = @ViewId\n    union all\n    select [v].[Id], [v].[Name], [v].[ParentId], [p].[PropertyId]\n    from [LiveWireView] v\n    inner join [PropertyToViewMap] p on [p].[ViewId] = [v].[Id]\n    inner join Views on Views.Id = v.ParentId\n)\n\nselect [PropertyId] from Views;\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":4,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":183,"score":3,"question_id":12100566,"title":"sort results by column not row","body":"<p>is it possible in SQL to sort by column and not by row? i do not need a basic ORDER BY statement, i know how those work (ie: order by column1, column2, etc).  </p>\n\n<p>basically trying to sort something like this:</p>\n\n<pre><code>column 1    column 2    column 3\n   1            0           3 \n</code></pre>\n\n<p>trying to sort to this:</p>\n\n<pre><code>column 3    column 1    column 2\n   3           1           0 \n</code></pre>\n\n<p>Is this even possible in SQL? preferably t-sql or anything that will run on sql server 2005</p>\n\n<p>ive been searching online for hours on this and no one even seems to want to ask this question. or i suck at searching.</p>\n\n<pre><code>   ; with numbered as\n   (\n     select SUM(OrderReceived) as c1, SUM(OrderOnHold) as c2, SUM(OrderConfirmed) as     c3,\n     row_number() over (order by employee) RecordNumber\n     from( SELECT \n\n\ne.FirstName+' '+e.LastName AS Employee\n,CASE WHEN oim.MilestoneID = 10 THEN 1 ELSE 0 END as OrderReceived\n,CASE WHEN oim.MilestoneID = 15 THEN 1 ELSE 0 END as OrderOnHold\n,CASE WHEN oim.MilestoneID = 20 THEN 1 ELSE 0 END as OrderConfirmed\nFROM OrderItems oi\n    JOIN Orders o on o.orderid = oi.orderid\n    JOIN OrderItemMilestones oim on oim.orderid = oi.orderid and oim.orderitemid     =     oi.orderitemid\n    JOIN Milestones m on m.milestoneid = oim.milestoneid\n    JOIN Employees e on e.username = oim.recordedbyuser\n    JOIN Clients cl on cl.clientid = o.clientid\nWHERE oim.MilestoneDate Between '2012-08-01' and '2012-08-05'\n    and e.terminationdate is null\n),\n\nordered as\n(\n select SUM(OrderReceived) as c1, SUM(OrderOnHold) as c2, SUM(OrderConfirmed) as c3,\n         row_number() over (partition by RecordNumber\n                           order by employee desc) rn\n    from numbered\n\n  unpivot (v for c in (c1, c2, c3)) u\n)\nselect RecordNumber,\n     [1] c1,\n     [2] c2,\n     [3] c3\n from \n (\n select RecordNumber,\n         v,\n         Rn\n    from ordered\n  ) o\n pivot (min(employee) for Rn in ([1], [2], [3])) p\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":116,"score":3,"question_id":12303795,"title":"How can I spread a value across multiple rows without a cursor?","body":"<p>Is there an easy way to spread a value across multiple rows?</p>\n\n<p>For example, my table contains</p>\n\n<pre>\nType      Invoiced    Paid    Current\nCharge    100         0       100\nCharge    100         0       100\nCharge    100         0       100\nPayment   0         250       0\nPayment   0          25       0\n</pre>\n\n<p>The data is imported this way, but I need to populate the <code>Current</code> and <code>Paid</code> columns with whatever they should be for that transaction based on the payment transactions that were also imported.</p>\n\n<p>Is there an easy way to write a query to determine the balance for the <code>Current</code> column for each record?</p>\n\n<p>For example, the 250 would apply 100 for the first two records and 50 to the next two, and the 25 would get applied to the last one, so the end result after updating the <code>Current</code> balance in my table should be:</p>\n\n<pre>\nType      Invoiced    Paid    Current\nCharge    100         100     0\nCharge    100         100     0\nCharge    100          75     25\nPayment   0           250     0\nPayment   0            25     0\n</pre>\n\n<p>I'd ideally like to do this with a single query instead of using a cursor to process each item individually. I've been trying to do it by using the <a href=\"http://msdn.microsoft.com/en-us/library/ms186734.aspx\" rel=\"nofollow\">Row_Number()</a> function and joining two subqueries, but I know I'm missing something here</p>\n\n<p>Here was my first attempt, which resulted in getting the running total of the current balance</p>\n\n<pre><code>;with cte(invoiced, paid, current)\nas (\n    select invoiced, paid, current\n        , row_number() over (order by datecreated)\n    from mytable\n)\n\nselect t1.invoiced, t1.paid, sum(t2.invoiced - t2.paid) as [current]\nfrom cte as t1\njoin cte as t2 on t1.number = t2.number and t2.rownum &lt;= t1.rownum\ngroup by t1.uid, t1.number, t1.rownum\norder by t1.rownum\n</code></pre>\n\n<p>Result:</p>\n\n<pre>\nInvoiced    Paid    Current\n100         0       100\n100         0       200\n100         0       300\n0         250       50\n0          25       25\n</pre>\n\n<p>I'm sure there's a way to do this, but right now my brain seems on strike and is refusing to come up with a solution.</p>\n"},{"tags":["sql","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":62,"score":1,"question_id":12301494,"title":"Use Select to Join two tables, Show only a few columns and also have a between criteria","body":"<p>I googled and searched this place but not an answer I could Find because what others have was different. </p>\n\n<pre><code>USE TestDatabase\nSelect Firstname,Lastname,Salary From Employee as E \nJoin JobTitle as J\non E.JobTitleID = J.JobTitleID\n\nWHERE Salary \nBETWEEN $25000.00 AND $50000.00\n</code></pre>\n\n<p>This works but I am trying to show two columns from JobTitle Table and I don't either know what words to search or Google and can't not find a simple answer. Can anyone help must be simple for some but I am confused. I am using server 2008 t-sql for school</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","count"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":126,"score":2,"question_id":12298011,"title":"Count rows in more than one table with tSQL","body":"<p>I need to count rows in more than one table in SQL Server 2008. I do this:</p>\n\n<pre><code>select count(*) from (select * from tbl1 union all select * from tbl2)\n</code></pre>\n\n<p>But it gives me an error of incorrect syntax near ). Why?</p>\n\n<p>PS. The actual number of tables can be more than 2.</p>\n"},{"tags":["sql-server-2008","tsql","reporting-services","catalog","reportserver"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12286154,"title":"SSRS : Updating CreatedbyID in reportserver db in the catalog table","body":"<p>A number of reports at our company, that can be found under the catalog table in the reportserver db, has one of our previous report developers userid as the <code>createdbyid</code>.</p>\n\n<p>When she left, we tried deleting her AD account and everything, which were linked to the reports via the users table in the reportserver db. However, when we deleted her AD account, her userid under the users table also got thrown out and we ended up with a number of reports where the <code>createdbyid</code> (i.e. the userid in the users table) doesnt exist. This broke all the reports scheduled via reportserver.</p>\n\n<p>Here is how I identified what reports have her as the <code>createdbyid</code>:</p>\n\n<pre><code>USE ReportServer\n\nselect *\nfrom Catalog with (nolock)\nwhere CreatedByID in ('X','Y');\n</code></pre>\n\n<p>Here is what I'd like to do:</p>\n\n<pre><code>USE ReportServer\n\nupdate Catalog\nset CreatedByID = 'Z'\nwhere CreatedByID in ('X','Y');\n</code></pre>\n\n<p>I would like to know if it is possible to update her userid in all the associated tables to a different userid, so they remain functional, without breaking anything else? We'll probably update it to the RS service account so we wont have to deal with this situation again. But I want to be aware of all the issues that might pop up as a result of updating the <code>createdbyid</code> in the catalog as well as the subscriptions table.</p>\n\n<p>Any advise will be greatly appreciated.</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql-server","tsql","aggregate-functions","average"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":76,"score":1,"question_id":12301164,"title":"T-SQL query that can sum up expenses for the current month, what that sumed average is for all months","body":"<p>I have a table with <code>Month_Id(int), Year(nvarchar), Expenses(money)</code>.</p>\n\n<p>I need a report that shows the sum of a current month, and what the average of that month would be.</p>\n\n<p>This is what I got so far.</p>\n\n<pre><code>SELECT     dt.Date, dt.Other_Revenue, dt.Month_Id, dt.Date_Year\nFROM         S1_Rpt_Daily_Totals \nWHERE     (dt.Month_Id = MONTH(GETDATE()))\n</code></pre>\n\n<p>Logic -  To add up the sum of expenses in Sept 2012, 2011, 2010, ect and divide by the number of years to get my Average.</p>\n\n<p>BUT how do I do this in a SQL query. Is it possible?</p>\n\n<p>Disclaimer - I am pretty new at SQL.</p>\n"},{"tags":["tsql","powershell"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":141,"score":0,"question_id":12296905,"title":"Escape sequence for $ (dollar sign) in T-sql script","body":"<p>I am running a T-SQL script, called from a powershell script, that contains a text row which includes a sequence containing $(MV). </p>\n\n<p>When I run the script I get the error \"'MV' scripting variable not defined.\" which I assume is because it interpretates the $(MV) string as a variable instead of being a part of the text string. </p>\n\n<p>How can I write the dollar sign as an escape sequence? Is that possible in a string?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":14,"down_vote_count":0,"view_count":30890,"score":14,"question_id":4377352,"title":"How do I format a number with commas in T-SQL?","body":"<p>I'm running some administrative queries and compiling results from <code>sp_spaceused</code> in SQL Server 2008 to look at data/index space ratios of some tables in my database.  Of course I am getting all sorts of large numbers in the results and my eyes are starting to gloss over.  It would be really convenient if I could format all those numbers with commas (987654321 becomes 987,654,321).  Funny that in all the many years I've used SQL Server, this issue has never come up since most of the time I would be doing formatting at the presentation layer, but in this case the T-SQL result in SSMS <strong>is</strong> the presentation.</p>\n\n<p>I've considered just creating a simple CLR UDF to solve this, but it seems like this should be do-able in just plain old T-SQL.  So, I'll pose the question here - how do you do numeric formatting in vanilla T-SQL?</p>\n"},{"tags":["sql-server","tsql","treeview","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":126,"score":1,"question_id":12296869,"title":"TSQL query for tree view control  and remove empty elements from an xml file","body":"<p>Query for treeview control, sometimes contains empty elements which throws an exception (when there are no attributes in an element)  due to data-binding of the control the text values is set to \"GrandChildOfFirstRow\"</p>\n\n<p>I did get rid of them in my query via xquery but is there an alternative way to doing this or a better smarter way to get rid of those empty elements, (I need the left outer join for proper records for this query) or is it possible to combine the xquery code into shorter code:</p>\n\n<p>Query:  </p>\n\n<pre><code>        declare @x as xml\n     set @x =\n    (\n    SELECT distinct  \n    Table1.AssetObjID, Table1.Asset_ID , Table1.FromLR, Table1.AssetType + ', ' + Table1.StreetName + ', ' +  Table1.FromMunicNo   as FirstRow,\n    Table2.ACIObjID ,Table2.PAssetObjID, Table2.Feature_ID + ', ' + Table2.FeatureName   AS ChildOfFirstRow,\n    Table3.ITMObjID  ,Table3.Item_ID + ',' + Table3.[DESC] as GrandChildOfFirstRow\n    FROM  Table1 left outer join \n    Table2 ON Table1.AssetObjID = Table2.PAssetObjID left outer join \n    Table3 ON Table1.AssetObjID = Table3.AssetObjID AND Table2.ACIObjID = Table3.ACIObjID\n    where Table1.AssetType ='xxxx' \n\n    for xml auto,root('xml')\n    )    \n\n--what it does is it only grabs one empty element and deletes only occurrences of that           \n\n--specific element for the whole file \n--so If I have 2 or more elements which are empty in an xml file \n--I will have to repeat that code each time\n\n    SET @x.modify('delete //*[not(node()) and not(./@*)]')\n    SET @x.modify('delete //*[not(node()) and not(./@*)]')\n</code></pre>\n"},{"tags":["tsql","crystal-reports"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":41,"score":2,"question_id":12296634,"title":"crystal report, tsql","body":"<p>I am working on crystal report with backend as sql server 2005.\nReport is used to display tenant details with a flat in which he is residing. On filter screen i have filter Sort By tenant or unit.</p>\n\n<p>When I sort by tenant, details appear as shown below,</p>\n\n<pre><code>Tenant name   tenant_unit tenant_rent\nA             160         1000\n              180         1000\nB             170         2000 \n</code></pre>\n\n<p>When sort by Unit, details appear as shown below,</p>\n\n<pre><code>Tenant name   tenant unit tenant rent\nA             160         1000\nB             170         2000\nA             180         1000\n</code></pre>\n\n<p>My question is, Is there any way to bring details in one line instead of two lines when sorting by unit?</p>\n\n<p>FYI: On crystal I have group of tenant with sort order original.</p>\n"},{"tags":["sql-server","tsql","string"],"answer_count":4,"favorite_count":4,"up_vote_count":21,"down_vote_count":2,"view_count":43113,"score":19,"question_id":1246365,"title":"Check if string contains another string","body":"<p>In T-SQL, how would you check if a string doesn't contain another string?</p>\n\n<p>I have an <code>nvarchar</code> which could be \"Oranges Apples\".</p>\n\n<p>I would like to do an update where, for instance, a columm <em>doesn't</em> contain \"Apples\". </p>\n\n<p>How can this be done?</p>\n"},{"tags":["c#","sql","sql-server","query","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":105,"score":1,"question_id":11453711,"title":"Error message in INSERT Statement","body":"<p>I believe there is something wrong with my INSERT statement here. When I run my code, the error message shows:</p>\n\n<blockquote>\n  <p>Line: 5<br>\n  Error: Sys.WebForms.PageRequestManagerServerErrorException: Incorrect syntax near ','.</p>\n</blockquote>\n\n<p>Is is something wrong in my where clause?</p>\n\n<p>Here is my <code>INSERT</code> statement:</p>\n\n<pre><code>INSERT into AppointmentDetails (SelectedApptDate, SelectedApptStartTime, \n                                SelectedApptEndTime, SelectedWeddingPlanner) \n   SELECT \n       ApptID \n   from \n       Appointment \n   INNER JOIN \n       Appointment ON Appointment.ApptID = AppointmentDetails.ApptID \n   WHERE \n       SelectedApptDate = @SelectedApptDate, \n       SelectedApptStartTime = @SelectedApptStartTime, \n       SelectedApptEndTime = @SelectedApptEndTime, \n       SelectedWeddingPlanner = @SelectedWeddingPlanner\n</code></pre>\n\n<p>This is how I call it from C#:</p>\n\n<pre><code>    command.CommandText = \"INSERT into AppointmentDetails (SelectedApptDate, SelectedApptStartTime, SelectedApptEndTime, SelectedWeddingPlanner) SELECT ApptID from Appointment INNER JOIN Appointment ON Appointment.ApptID = AppointmentDetails.ApptID WHERE SelectedApptDate = @SelectedApptDate, SelectedApptStartTime = @SelectedApptStartTime, SelectedApptEndTime = @SelectedApptEndTime, SelectedWeddingPlanner = @SelectedWeddingPlanner\";\n\n    command.Connection = connection;\n    command.Parameters.AddWithValue(\"@SelectedApptDate\", dateSelected);\n    command.Parameters.AddWithValue(\"@SelectedApptStartTime\", timeStart);\n    command.Parameters.AddWithValue(\"@SelectedApptEndTime\", timeEnd);\n    command.Parameters.AddWithValue(\"@SelectedWeddingPlanner\", weddingplanner);\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12296688,"title":"TimeSpan calculation based on login status in T-SQL","body":"<p>I have a temporary table whose structure is a below. </p>\n\n<pre><code>create table #temptime\n(\n   logtime datetime,\n   [status] varchar(3)\n)\n</code></pre>\n\n<p>As you can see from above , I have logintime and status. I need to partition this table based on status , ordered by date. I will need to calculate time span between these two created partition and consolidate to find how long user is in the premise. </p>\n\n<p>For example let's say we have 4 records</p>\n\n<pre><code>Partition based on status IN        Partition based in status OUT\n\n8:45 AM                                 10:45 AM\n11:00 AM                                15:00 PM\n</code></pre>\n\n<p>Now program should find time span </p>\n\n<pre><code>10:45 AM - 8:45 AM = 2 Hours + 11:00 Am - 15:00 PM = 4 Hours\n</code></pre>\n\n<p>Whats the best way to accomplish this task?</p>\n\n<p>Thanks</p>\n"},{"tags":["c#","sql","database","tsql","c#-4.0"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12294417,"title":"Get specific values from text boxes into Grid View?","body":"<p>I am new in Databases so please ignore my way asking !</p>\n\n<p>I have two text boxes named from date and To date having calendar within them  and now i want to get data from them in grid view against specific dates selected in those text boxes.</p>\n\n<p>I have Created Stored Procedure for this operation but i am not sure much about my stored procedure.</p>\n\n<p>here is my stored procedure </p>\n\n<pre><code>select * from cor_leave \nwhere dt_from &gt;= @dt_from and dt_from &lt;= @dt_to\n</code></pre>\n\n<p>i am going on right way or if i am doing any wrong please help me out?\nor is there any way that can solve my issue???</p>\n"},{"tags":["sql","sql-server","tsql","select","index"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12296328,"title":"Do I need to set up a column with just a few possible values as an index for tSQL?","body":"<p>I'm creating an SQL Server 2008 database that may contain millions of records and I was wondering if I need to define the following as indexes:</p>\n\n<ol>\n<li><p>TINYINT column that may contain only 0 and 1?</p></li>\n<li><p>TINYINT column that may contain only: 0, 5, and 6?</p></li>\n</ol>\n\n<p>PS. Both of these columns will be used in the WHERE clause for selection.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":66,"score":3,"question_id":12297062,"title":"Pick distinct rows based on two tables T-SQL","body":"<p>Consider the tables in image</p>\n\n<blockquote>\n  <p><img src=\"http://i.stack.imgur.com/DV7MN.png\" alt=\"enter image description here\"></p>\n</blockquote>\n\n<p>How to select rows from Table1 excluding items from Table2 with same ReferenceId?</p>\n\n<p>The result should be</p>\n\n<blockquote>\n  <p><img src=\"http://i.stack.imgur.com/WVGwU.png\" alt=\"enter image description here\"></p>\n</blockquote>\n"},{"tags":["xml","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":291,"score":0,"question_id":9912344,"title":"T-SQL XML Value/Nodes functions + XML Cast","body":"<p>I have a column in table which contains XML text, but it is not XML type and its type should not be changed.</p>\n\n<p>I have write the following SQL query to get some information from its </p>\n\n<pre><code>DECLARE @TempXML XML=(SELECT TOP 1 XMLColumn FROM TableOne)\n\nSELECT  T.c.query('.').value('(/question/@id)[1]','BIGINT') AS [QuestionID]\n       ,T.c.query('.').value('(/question/@comment)[1]','NVARCHAR(100)') AS [Comment]\n       ,T.c.query('.').value('(/question/answer/@pos)[1]','TINYINT') AS [AnswerPosition]\nFROM   @TempXML.nodes('/submission/question') T(c)\n</code></pre>\n\n<p>The problem I have net is that I have to create a view in which for each row the query above will be executed, but I am not able to concatenated the query and the xml conversion.</p>\n\n<p>I have try to create CTE in which to do the conversion but then met some difficulties \n in implementing my query.</p>\n\n<pre><code>WITH CTEview(CurrentXML) AS \n(\n    SELECT CAST(XMLColumn AS XML) AS [CurrentXML]\n    FROM TableOne\n)\n--My SQL goes here\n</code></pre>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12282726,"title":"Using variables in a large number of places for table names in a stored procedure in Sybase","body":"<p>I have a procedure that archives records from a source database into a destination database, where the tables in the source database are mirrored in the destination database. Therefore, when I specify a table name, I must also specify the database name in full, as the following:</p>\n\n<pre><code>DB_NAME.dbo.TABLE_NAME\n</code></pre>\n\n<p>However, I must also move this stored procedure between environments, where the corresponding databases are named differently.</p>\n\n<p>For example:</p>\n\n<p>Dev:</p>\n\n<pre><code>DEV_DB_NAME.dbo.TABLE_NAME\n</code></pre>\n\n<p>QA:</p>\n\n<pre><code>QA_DB_NAME.dbo.TABLE_NAME\n</code></pre>\n\n<p>I can obtain these DB names from environment variables using a SHELL script and pass them into the SPROC. However, TSQL does not allow variables for database names.</p>\n\n<p>I have a solution where I basically just turn the entire script into a string and run with <code>exec</code> using dynamic SQL.</p>\n\n<p>Is my solution recommended? Are there any other solutions?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":87,"score":0,"question_id":11330767,"title":"Saving image in database field to file on server","body":"<p>I am trying to save data from a table directly to the servers file system using this t-sql:</p>\n\n<pre><code>DECLARE @ID int\nDECLARE @command varchar(1000)\nDECLARE @Name varchar(100)\nDECLARE @FileName varchar(100)\nDECLARE MyCursor CURSOR FOR \nSELECT Id, [FileName] FROM FilesTable\nOPEN MyCursor \n\nFETCH NEXT FROM MyCursor \nINTO @ID, @Name\n\nWHILE @@FETCH_STATUS = 0\nBEGIN\n\nSELECT @FileName = 'd:\\Temp\\' + convert(varchar(200), @Name)\n\nSET @command = 'bcp \"SELECT FileBytes FROM FilesTable WHERE ID = ' + convert(varchar(18),     @Id) + '\" queryout \"' + @FileName + '\" -T -n'\n\nEXEC master..xp_cmdshell @command, no_output\n\nFETCH NEXT FROM MyCursor \nINTO @Id, @Name\n\nEND\n\nCLOSE MyCursor \nDEALLOCATE MyCursor \n</code></pre>\n\n<p>The table is filled with solid data. accessing this data with a C# program works.\nI did configure advanced options gave permission to use xp_cmdshell\nWhen I run this query i don't get any error but no file was written.\nI also don't see anything in the logs, (maybe I am looking in the wrong location?)</p>\n\n<p>What am I doing wrong? Or what can I do to checdk 'under the hood'?</p>\n"},{"tags":["tsql","asp-classic","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":11967200,"title":"T-SQL CTE + classic asp - which CommandType to use?","body":"<p>I have a CTE statement. When I try to execute in with classic asp the parameter is not replaced correctly:</p>\n\n<pre><code>Set cmd=Server.CreateObject(\"ADODB.Command\")\ncmd.ActiveConnection = objConnection\ncmd.CommandText =   \" my CTE is here\"\n\ncmd.CommandType = adCmdText\n\n'adCmdUnspecified,adCmdText,adCmdTable,adCmdStoredProc,adCmdUnknown,adCmdFile,adCmdTableDirect\n\nSet objParam = cmd.CreateParameter(, adBigInt , adParamInput ,8,CLng(MyParameter))\ncmd.Parameters.Append objParam\n</code></pre>\n\n<p>When I get the final statement the \"?\" is not replace in the statement and it gives me error.</p>\n\n<p>I try with each command type but no results.</p>\n"},{"tags":["tsql","datetime","sql-server-2008-r2","varchar"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":104,"score":1,"question_id":12269646,"title":"Extract portion of date string and convert to datetime in T-SQL","body":"<p>I'm running SQL Server Standard 2008 R2 on a 64 bit version of Windows Server 2008 R2 standard (sp1)</p>\n\n<p>I've imported a log file as a flat file source. One of the columns from the import called <code>col2</code> in the table called <code>big</code> holds values like this: <code>16/Mar/2007:11:30:17</code> as <code>varchar(50)</code>.</p>\n\n<p>I want to convert that column (<code>col2</code>) to a <code>datetime</code> datatype.  </p>\n\n<p>One method I was trying was to extract each part of the date string and then recombine and convert them.</p>\n\n<p>The problem I ran into is that each column has different widths since the log file couldn't be neatly delimited, making using something like <code>CHARINDEX</code> return a single digit or sometimes NULL.  </p>\n\n<p>I've been attempting to set up using regex using CLR integration but can't get it to work (I can't create a C# project in Visual Studio, there's no option for it) and Master Data Services won't install because SQL Server 2008 R2 Standard doesn't support it.  </p>\n\n<p>What is my best method to do this? Using <code>CASE</code>, <code>SUBSTRING</code> and <code>CHARINDEX</code>?  </p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":98,"score":1,"question_id":12290733,"title":"Inserting values into a table based on column values of another table","body":"<p>I would like to insert data into a table based on all the values of a secondary table's column. For example</p>\n\n<p>I have two tables </p>\n\n<pre><code>CREATE TABLE Table1 (\nid int identity(1, 1) not null,\nFullName varchar(100),\nAge int,\nCourseID int\n</code></pre>\n\n<p>)</p>\n\n<pre><code>CREATE TABLE Table2 (\nid int identity(1, 1) not null,\nCourses int\n</code></pre>\n\n<p>)</p>\n\n<p>I would like to perform something like this .. </p>\n\n<pre><code>insert into Table1 ('Auser',20,'And the list of Courses that I get from Table2')\n</code></pre>\n\n<p>Is there a way I can do this in sql server ? </p>\n"},{"tags":["tsql","parameters","ssrs-2008"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":67,"score":1,"question_id":12285984,"title":"SSRS - Using the LEFT() function on a multi-valued parameter?","body":"<p>I'm having some issues trying to use the LEFT() function with a multi-valued parameter that allows users to select all values. In my dataset, I use the following code:</p>\n\n<pre><code> SELECT * FROM TABLE WHERE AccountValue BETWEEN 10000 and 50000\n AND CodeValue IN ('',100,LEFT(@Parameter,3))\n</code></pre>\n\n<p>Basically, the results that should be pulled in the matrix are all accounts between 10000 and 50000, that have a code value of blank, 100, or the left 3 characters of the values the user selects in the parameter.  The values in the parameter are as follows: '200 - Finance', '300 - Admin', '400 - HR', etc.  Code column values in the table are 100, 200, 300, 400, etc. So I use the LEFT function to split the string values of the parameter. This works fine if the user only selects one parameter. But when they select more than one or all, then it messes up the syntax of the query, returning the error \"The left function requires 2 argument(s).\" Any suggestions?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":73,"score":0,"question_id":12290389,"title":"Query to show specific values from related tables","body":"<p>In my case i have three tables. The Contracts table, the agreements table and the payments table. What i have is a table with contracts which represents the value in debt, another table with the agreements of the conditions to pay off the debt, and another table related to the agreements table who has the debt split in parcels.</p>\n\n<pre><code>ContractsTable\n(Id | Number |  Name  |    Debt   | ...)\n 1  |  1234  | AAAAAA | 1250,00  | ...\n 2  |  1235  | BBBBBB | 5000,20  | ...\n 3  |  1236  | CCCCCC | 500,00   | ...\n\nAgreementsTable\n(Id | ContractId |    Debt   | IsValid | ...)\n 1  |     1      | 1250,00  |    1    | ...\n 2  |     2      | 5000,20  |    0    | ...\n 3  |     2      | 5000,20  |    1    | ...\n 4  |     3      | 500,00   |    0    | ...\n\nPaymentsTable\n(Id  | AgreementId |    Date    |  Amount   | IsPaid | ...)\n  1  |      1      | 01/08/2012 | 500,00   |   1    | ...\n  2  |      1      | 01/09/2012 | 500,00   |   1    | ... -&gt; Last payment\n  3  |      1      | 01/10/2012 | 250,00   |   0    | ... -&gt; Next Payment\n  4  |      3      | 01/08/2012 | 1000,00  |   1    | ...\n  5  |      3      | 01/09/2012 | 1000,00  |   1    | ...\n  6  |      3      | 01/10/2012 | 1000,00  |   0    | ...\n  7  |      3      | 01/11/2012 | 1000,00  |   0    | ...\n  8  |      3      | 01/12/2012 | 1000,20  |   0    | ...\n</code></pre>\n\n<p>So when i execute the stored procedure to get the table with the contracts, i want to somehow see a column with the date of last payment that was done and the date of next payment to be done too. But i will only be able to see the date of the last payment done and the date of the next payment to be done if the contract has a valid agreement related with and in the case of the next payment only if the agreement is valid.</p>\n\n<p>I am working with MS Sql Server.</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":55,"score":0,"question_id":12289944,"title":"SQL to find activity between dates","body":"<p>I am using the following script to try and count the number of new comments and new discussions created in a group on our system between the last time you visited the group and now.  I have written the following but cant get it to work:</p>\n\n<pre><code>SELECT TOP(6) a.GroupID , a. GroupName, sbuser.sf_NewGroupActivity( a.GroupID ,b.LastVisited) AS NumberUpdates\nFROM Groups a\nINNER JOIN GroupMembers b ON b .GroupID = a.GroupID\nWHERE b. MemberID = 102\nGROUP BY a.GroupID , a.GroupName, b.LastVisited\nORDER BY NumberUpdates ASC\n</code></pre>\n\n<p>and the sf script is as follows:</p>\n\n<pre><code>RETURNS INT\nAS\n    BEGIN\n    DECLARE @OUTSTR INT\n    DECLARE @OUT1 INT\n    DECLARE @OUT2 INT\n    SET @OUT1 = (SELECT CAST(COUNT(GroupDiscussionsID) AS INT) FROM GroupDiscussions\n            WHERE MemberID = @GroupID AND CreateDate BETWEEN @LastVisited AND GetDate())\n    SET @OUT2 = (SELECT CAST(COUNT(GroupCommentID) AS INT) FROM GroupComments\n            WHERE MemberID = @GroupID AND CreateDate BETWEEN @LastVisited AND GetDate())\n    SET @OUTSTR = @OUT1 + @OUT2\n    RETURN @OUTSTR\n    END\n</code></pre>\n\n<p>I am at a loss as to how to get this to list the top 6 groups that have updates order by number of updates.  Any ideas, suggestions, or solutions would be greatly appreciated.  Many thanks</p>\n\n<p>neojakey</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","join"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":85,"score":1,"question_id":12251446,"title":"Storing a set of criteria in another table","body":"<p>I have a large table with sales data, useful data below:</p>\n\n<pre><code>RowID   Date        Customer  Salesperson   Product_Type    Manufacturer   Quantity   Value\n1       01-06-2004  James     Ian           Taps            Tap Ltd        200        850\n2       02-06-2004  Apple     Fran          Hats            Hats Inc       30         350\n3       04-06-2004  James     Lawrence      Pencils         ABC Ltd        2000       980\n...\nMany rows later...\n...\n185352  03-09-2012  Apple     Ian           Washers         Tap Ltd        600        80\n</code></pre>\n\n<p>I need to calculate a large set of targets from table containing values different types, target table is under my control and so far is like:</p>\n\n<pre><code>TargetID  Year   Month    Salesperson    Target_Type   Quantity\n1         2012   7        Ian            1             6000\n2         2012   8        James          2             2000\n3         2012   9        Ian            2             6500\n</code></pre>\n\n<p>At present I am working out target types using a view of the first table which has a lot of extra columns:</p>\n\n<pre><code>    SELECT YEAR(Date)\n         , MONTH(Date)\n         , Salesperson\n         , Quantity\n         , CASE WHEN Manufacturer IN ('Tap Ltd','Hats Inc') AND Product_Type = 'Hats' THEN True ELSE False END AS IsType1\n         , CASE WHEN Manufacturer = 'Hats Inc' AND Product_Type IN ('Hats','Coats') THEN True ELSE False END AS IsType2\n    ...\n    ...\n         , CASE WHEN Manufacturer IN ('Tap Ltd','Hats Inc') AND Product_Type = 'Hats' THEN True ELSE False END AS IsType24\n         , CASE WHEN Manufacturer IN ('Tap Ltd','Hats Inc') AND Product_Type = 'Hats' THEN True ELSE False END AS IsType25\nFROM SalesTable\nWHERE [some stuff here]\n</code></pre>\n\n<p>This is horrible to read/debug and <strong>I hate it</strong>!!</p>\n\n<p>I've tried a few different ways of simplifying this but have been unable to get it to work.\nThe closest I have come is to have a third table holding the definition of the types with the values for each field and the type number, this can be joined to the tables to give me the full values but I can't work out a way to cope with multiple values for each field.</p>\n\n<p><strong>Finally the question:</strong></p>\n\n<p>Is there a standard way this can be done or an easier/neater method other than one column for each type of target?</p>\n\n<p>I know this is a complex problem so if anything is unclear please let me know.</p>\n\n<p><strong>Edit - What I need to get:</strong></p>\n\n<p>At the very end of the process I need to have targets displayed with actual sales:</p>\n\n<pre><code>Type    Year    Month   Salesperson   TargetQty   ActualQty\n2       2012    8       James         2000        2809\n2       2012    9       Ian           6500        6251\n</code></pre>\n\n<p>Each row of the sales table could potentially satisfy 8 of the types.</p>\n\n<p>Some more points:</p>\n\n<ol>\n<li>I have 5 different columns that need to be defined against the targets (or set to NULL to include any value)</li>\n<li>I have between 30 and 40 different types that need to be defined, several of the columns could contain as many as 10 different values</li>\n</ol>\n\n<p>For point 2, if I am using a row for each permutation of values, 2 columns with 10 values each would give me 100 rows for each sales person for each month which is a lot but if this is the only way to define multiple values I will have to do this.</p>\n\n<p>Sorry if this makes no sense!</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12287744,"title":"Stored procedure results in CSV format","body":"<p>I have a stored procedure that does a select and returns the results. I would like thos results to be in .csv format. NOT a csv file, a string in csv format. Also, I am not looking for any menu clicks or selections from management studio. This must be done inside the stored procedure call. What is the correct way to do this?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","stored-procedures","transactions"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":135,"score":1,"question_id":12286931,"title":"BEGIN TRAN and COMMIT TRAN in a stored procedure","body":"<p>I have a procedure that looks like the below</p>\n\n<pre><code>BEGIN\n    SET NOCOUNT ON\n\n    IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'X')\n        UPDATE TABLE X \n        SET ROW = 4\n        WHERE NAME = 'STEVE'\n\n    IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Y')\n        UPDATE TABLE Y\n        SET ROW = 5\n        WHERE NAME = 'ART'\nEND\n</code></pre>\n\n<p>Would I need to add a BEGIN TRAN and COMMIT TRAN encapsulation if I wanted the two IF statements to be evaluated in atomicity?</p>\n"}]}
{"total":16599,"page":17,"pagesize":100,"questions":[{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":2,"view_count":106,"score":0,"question_id":12285598,"title":"SQL Server 2008 inconsistent results","body":"<p>I just released some code into production that is randomly causing errors.  I already fixed the problem by totally changing the way I was doing the query.  However, it still bothers me that I don't know what was causing the problem in the first place so was wondering if someone might know the answer.  I have the following query inside of a stored procedure.  I'm not looking for comments about that's not a good practice to make queries with nested function calls and things like that :-).  Just really want to find out why it doesn't work consistently.  Randomly the function in the query will return a non-numeric value and cause an error on the join.  However, if I immediately rerun the query it works fine.</p>\n\n<pre><code>SELECT      cscsf.cloud_server_current_software_firewall_id,\n                dbo.fn_GetCustomerFriendlyFromRuleName(cscsf.rule_name, np.policy_name) as rule_name,\n                cscsf.rule_action,\n                cscsf.rule_direction,\n                cscsf.source_address,\n                cscsf.source_mask,\n                cscsf.destination_address,\n                cscsf.destination_mask,\n                cscsf.protocol,\n                cscsf.port_or_port_range,\n                cscsf.created_date_utc,\n                cscsf.created_by\n    FROM        CLOUD_SERVER_CURRENT_SOFTWARE_FIREWALL cscsf\n    LEFT JOIN   CLOUD_SERVER cs\n    ON          cscsf.cloud_server_id = cs.cloud_server_id\n    LEFT JOIN   CLOUD_ACCOUNT cla\n    ON          cs.cloud_account_id = cla.cloud_account_id\n    LEFT JOIN   CONFIGURATION co\n    ON          cla.configuration_id = co.configuration_id\n    LEFT JOIN   DEDICATED_ACCOUNT da\n    ON          co.dedicated_account_id = da.dedicated_account_id\n    LEFT JOIN   CORE_ACCOUNT ca\n    ON          da.core_account_number = ca.core_account_id\n    LEFT JOIN   NETWORK_POLICY np \n    ON          np.network_policy_id = (select dbo.fn_GetIDFromRuleName(cscsf.rule_name))\n    WHERE       cs.cloud_server_id = @cloud_server_id\n    AND         cs.current_software_firewall_confg_guid = cscsf.config_guid\n    AND         ca.core_account_id IS NOT NULL\n    ORDER BY    cscsf.rule_direction, cscsf.cloud_server_current_software_firewall_id\n</code></pre>\n\n<p>if you notice the join </p>\n\n<pre><code>ON          np.network_policy_id = (select dbo.fn_GetIDFromRuleName(cscsf.rule_name))\n</code></pre>\n\n<p>calls a function.</p>\n\n<p>Here is that function:</p>\n\n<pre><code>ALTER FUNCTION [dbo].[fn_GetIDFromRuleName]\n(\n    @rule_name              varchar(100)\n)\nRETURNS varchar(12)\nAS\nBEGIN\n    DECLARE     @value      varchar(12)\n\n        SET @value = dbo.fn_SplitGetNthRow(@rule_name, '-', 2)\n        SET @value = dbo.fn_SplitGetNthRow(@value, '_', 2)\n        SET @value = dbo.fn_SplitGetNthRow(@value, '-', 1)\n\n    RETURN      @value\nEND\n</code></pre>\n\n<p>Which then calls this function:</p>\n\n<pre><code>ALTER FUNCTION [dbo].[fn_SplitGetNthRow]\n(\n    @sInputList     varchar(MAX),\n    @sDelimiter     varchar(10) = ',',\n    @sRowNumber     int = 1\n)\nRETURNS varchar(MAX)\nAS\nBEGIN\n    DECLARE     @value      varchar(MAX)\n\n    SELECT      @value = data_split.item\n                        FROM\n                        (\n                            SELECT *, ROW_NUMBER() OVER (ORDER BY (SELECT 1)) as row_num FROM dbo.fn_Split(@sInputList, @sDelimiter)\n                        ) AS data_split\n                        WHERE\n                        data_split.row_num = @sRowNumber\n\n    IF          @value IS NULL\n        SET     @value = ''\n\n    RETURN      @value  \nEND\n</code></pre>\n\n<p>which finally calls this function:</p>\n\n<pre><code>ALTER FUNCTION [dbo].[fn_Split] (\n    @sInputList VARCHAR(MAX),\n    @sDelimiter VARCHAR(10) = ','\n) RETURNS @List TABLE (item VARCHAR(MAX))\nBEGIN\n    DECLARE @sItem VARCHAR(MAX)\n    WHILE CHARINDEX(@sDelimiter,@sInputList,0) &lt;&gt; 0\n        BEGIN\n            SELECT @sItem=RTRIM(LTRIM(SUBSTRING(@sInputList,1,CHARINDEX(@sDelimiter,@sInputList,0)-1))), @sInputList=RTRIM(LTRIM(SUBSTRING(@sInputList,CHARINDEX(@sDelimiter,@sInputList,0)+LEN(@sDelimiter),LEN(@sInputList))))\n            IF LEN(@sItem) &gt; 0\n                INSERT INTO @List SELECT @sItem\n        END\n\n    IF LEN(@sInputList) &gt; 0\n        INSERT INTO @List SELECT @sInputList -- Put the last item in\n    RETURN\nEND\n</code></pre>\n"},{"tags":["tsql","tdd","sql-server-2008-r2","tsqlt"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12285130,"title":"TSQLT unit test - The data types text and text are incompatible in the equal to operator","body":"<p>I am getting this error from AssertEqualsTable \"The data types text and text are incompatible in the equal to operator.\"</p>\n\n<p>then</p>\n\n<p>\"The 'TableCompare' procedure attempted to return a status of NULL, which is not allowed. A status of 0 will be returned instead.\"</p>\n\n<pre><code>select   *\n    into #Actual\n    from [dbo].[InvoiceOut];\n\n--make expected table an empty table of #actual's structure because we truncate so it should be empty.\n    SELECT TOP(0) *\n    INTO #Expected\n    FROM #Actual;\n\nEXEC tSQLt.AssertEqualsTable '#Expected', '#Actual';\n</code></pre>\n\n<p>--part of the relevant table info</p>\n\n<pre><code>CREATE TABLE [dbo].[InvoiceOut](\n...\n    [InsertField] [text] NULL,\n    [DeductibleText] [text] NULL,\n    [BarcodeText] [text] NULL\n) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12283990,"title":"SQL Server 2008 Script to Drop PK Constraint that has a System Generated Name","body":"<p>I am trying to add a clustered index to an existing table in SQL Server 2008, and it needs to be an automated script, because this table exists on several databases across several servers. </p>\n\n<p>In order to add a clustered index I need to remove the PK constraint on the table, and then re-add it as unclustered. The problem is the name of the PK constraint is auto-generated, and there is a guid appended to the end, so it's like \"PK_<em>[Table]</em>_D9F9203400.\" </p>\n\n<p>The name is different across all databases, and I'm not sure how to write an automated script that drops a PK constraint on a table in which I don't know the name of the constraint. Any help is appreciated!</p>\n\n<p>UPDATE:</p>\n\n<p>Answer below is what I used. Full script:</p>\n\n<pre><code>Declare @Val varchar(100)\nDeclare @Cmd varchar(1000)\n\nSet @Val = (\n    select name\n    from sysobjects\n    where xtype = 'PK'\n    and parent_obj = (object_id('[Schema].[Table]'))\n)\nSet @Cmd = 'ALTER TABLE [Table] DROP CONSTRAINT ' + @Val\nExec (@Cmd)\nGO\n\nALTER TABLE [Table] ADD CONSTRAINT PK_Table\n    PRIMARY KEY NONCLUSTERED (TableId)\nGO\n\nCREATE UNIQUE CLUSTERED INDEX IX_Table_Column\n    ON Table (Column)\nGO\n</code></pre>\n"},{"tags":["sql","tsql","numberformat"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12285545,"title":"How do I display a number as $#,### in SQL?","body":"<p>The field is set to MONEY.</p>\n\n<p>I want to select [field_name] as $#,###.</p>\n\n<p>I tried </p>\n\n<pre><code>SELECT CAST([field_name] AS DECIMAL (1, 3))\nFROM ...\n</code></pre>\n\n<p>but no luck.</p>\n"},{"tags":["tsql","ssas","mdx"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":102,"score":0,"question_id":12281383,"title":"MDX - DATE Format","body":"<p>I have defined</p>\n\n<pre><code>SET [Days] AS\n    STRTOMEMBER(\"[Survey Date].[Date].&amp;[\" + Format( Now(), \"yyyy-MM-dd\" ) + \"T00:00:00]\")\n</code></pre>\n\n<p>and I use [Days] on Rows.</p>\n\n<p>Instead of that, I need the following in the above format.</p>\n\n<pre><code>WITH MEMBER MEASURES.[STARTOFWEEK] AS\n    DATEADD(\"M\", DATEDIFF(\"M\",cdate(2),DATEADD(\"M\",-1,CDATE(Now()))),2)\n</code></pre>\n\n<p>The above query will give me 1st day of last month. I need the first day of the last month in <code>yyyy-MM-dd T00:00:00</code> format.</p>\n\n<p>I can't seem to get it to work.</p>\n"},{"tags":["query","tsql","sql-server-2012"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12205105,"title":"Join tables query in SQL Server 2012 ","body":"<p>I have two tables like below:</p>\n\n<pre><code>TableA --&gt; categoryId(pk), categoryParentId, catName\nTableB --&gt; empId(pk), categoryId, empName, empDesignation\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/Ru5cy.jpg\" alt=\"enter image description here\"></p>\n\n<p>I want to get all <code>catName</code> with respective categoryId from <code>TableA</code> where <code>categoryId=2</code> of <code>TableB</code> is equal to <code>categoryParentId=2</code> of <code>TableA</code>. Please help.</p>\n\n<p>Result:</p>\n\n<pre><code>1002   SE\n1003   MD\n</code></pre>\n"},{"tags":["sql","vb.net","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":46,"score":0,"question_id":12283104,"title":"Getting a sql exception due to a fk constraint for unknown reasons","body":"<p>SO the exact error message I'm getting is:</p>\n\n<blockquote>\n  <p>The INSERT statement conflicted with the FOREIGN KEY constraint\n  \"FK_featuredtype_featured\". The conflict occurred in database\n  \"docphin\", table \"dbo.featured\", column 'featuredID'. The statement\n  has been terminated.\"</p>\n</blockquote>\n\n<p>The part of my vb code that calls the sp that has the insert statement is: </p>\n\n<pre><code>If isChanged1.Checked Then\n    lq.admin_RemoveFeatured(isChanged.featuredID1)\n    lq.admin_AddFeatured(title1.Text, text1.Text, imageURL1.Text, login1.Checked, index1.Checked, mobile1.Checked, Integer.Parse(priority1.Text))\n\nEnd If\n\nIf isChanged2.Checked Then\n    lq.admin_RemoveFeatured(isChanged.featuredID2)\n    lq.admin_AddFeatured(title2.Text, text2.Text, imageURL2.Text, login2.Checked, index2.Checked, mobile2.Checked, Integer.Parse(priority2.Text))\n\nEnd If\n</code></pre>\n\n<p>Now the odd thing is when I execute admin_AddFeatured in sql server it works fine.</p>\n\n<p>admin_RemoveFeatured:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[admin_RemoveFeatured] \n    -- Add the parameters for the stored procedure here\n    @featuredID int\nAS\nBEGIN\n    -- SET NOCOUNT ON added to prevent extra result sets from\n    -- interfering with SELECT statements.\n    SET NOCOUNT ON;\n\n    -- Insert statements for procedure here\n    delete from featuredtype where featuredID= @featuredID\n    delete from featured where featuredID= @featuredID\n\n\nEND\n\nGO\n</code></pre>\n\n<p>admin_AddFeatured:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[admin_AddFeatured] \n    -- Add the parameters for the stored procedure here\n    @title varchar(500) , \n    @text varchar(MAX),\n    @imageURL varchar(200),\n    @loginPage bit,\n    @indexPage bit,\n    @mobilePage bit,\n    @priority int\nAS\nBEGIN\n    -- SET NOCOUNT ON added to prevent extra result sets from\n    -- interfering with SELECT statements.\n    SET NOCOUNT ON;\n\n         -- Insert statements for procedure here\n        insert into featured\n        (title,text,imageURL, priority )\n        values\n        (@title,@text,@imageURL, @priority)\n\n        insert into featuredtype\n        (loginPage, indexPage, mobilePage)\n        values\n        (@loginPage, @indexPage, @mobilePage)\n\n\nEND\n\nGO\n</code></pre>\n\n<p>I've been at this testing different solutions but I can't really seem to grasp what might be wrong here. My only thought is that ic could be related to how I get the ID field for each \"feature\" items that i'm inserting of deleting. For that I made a module:</p>\n\n<pre><code>Public Module isChanged\n    Public featuredID1 As Integer\n    Public featuredID2 As Integer\n    Public featuredID3 As Integer\n    Public featuredID4 As Integer\n    Public featuredID5 As Integer\n    Public featuredID6 As Integer\nEnd Module\n</code></pre>\n\n<p>Then, in the page load sub I use an sp and read in the ID, like: </p>\n\n<pre><code>   Dim lq2 As New lqDFDataContext\n        Dim var = lq2.admin_GetFeatured().ToList()\n        Dim i As Integer = 1\n\n        For Each f In var\n            If i = 1 Then\n                isChanged.featuredID1 = f.featuredID\n                title1.Text = f.title\n                text1.Text = f.text\n                imageURL1.Text = f.imageURL\n                login1.Checked = f.loginPage\n                index1.Checked = f.indexPage\n                mobile1.Checked = f.mobilePage\n                priority1.Text = Str(f.priority)\n            End If\n\netc...\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12280921,"title":"Distributing Values SQL","body":"<p>I'm trying to find a more efficient way of doing this, as I have gone the cursor route and hate the performance hit I get with using cursors in SQL.  I'm trying to distribute payments across items with value and keep track of any remaining amounts.  For instance...</p>\n\n<pre><code>Payments             \n--------\n10,\n20\n\nItems\n------\n5,\n5,\n10\n</code></pre>\n\n<p>In essence would return that the first payment (10) applied to the first two items and was exhausted.  The second payment (20) applied to the third item and there was 10 left over.  I'm able to accomplish this fine using cursors.  Just curious if anyone had some thoughts on how to do this more efficiently.</p>\n\n<p>Cheers!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":10,"favorite_count":7,"up_vote_count":18,"down_vote_count":0,"view_count":84694,"score":18,"question_id":770579,"title":"How to calculate percentage with a SQL statement","body":"<p>I have a SQL Server table that contains users &amp; their grades. For simplicity's sake, lets just say there are 2 columns - <code>name</code> &amp; <code>grade</code>. So a typical row would be Name: \"John Doe\", Grade:\"A\".</p>\n\n<p>I'm looking for one SQL statement that will find the percentages of all possible answers. (A, B, C, etc...) Also, is there a way to do this without defining all possible answers (open text field - users could enter 'pass/fail', 'none', etc...)</p>\n\n<p>The final output I'm looking for is A: 5%, B: 15%, C: 40%, etc...</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["database","tsql","types"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":50,"score":0,"question_id":12065028,"title":"Which data type do I use in T-SQL if the field can be very small or very large?","body":"<p>Suppose I have a column in a table which may hold information as short as a single char <code>'a'</code> or as big as a huge binary chunk which translates to a jpg, png, mp3, whatever.</p>\n\n<p>Which data type should I use for this?</p>\n\n<p>I thought <code>varbinary(max)</code> or <code>varchar(max)</code>, but will it occupy unused space if I just store a single char or a short string?</p>\n\n<p>How is data stored when a field has a data-type that may have variable lengths?</p>\n\n<p>According to this qa, <a href=\"http://dba.stackexchange.com/questions/1767/how-do-too-long-fields-varchar-nvarchar-impact-performance-and-disk-usage-ms\">http://dba.stackexchange.com/questions/1767/how-do-too-long-fields-varchar-nvarchar-impact-performance-and-disk-usage-ms</a>, it shouldn't matter, except for this:</p>\n\n<p><strong>Memory</strong></p>\n\n<p><code>If the client application allocates memory using the maximum size, the application would allocate significantly more memory than is necessary. Special considerations would have to be done to avoid this.</code></p>\n\n<p>How do I know this? Sorry if I'm being dumb but it seems too vague.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","aggregate"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":129,"score":0,"question_id":12040875,"title":"Query to return aggregate based on two unique dimensions?","body":"<p>Consider the following scenario:<br>\nI have the following tables that contain customer and purchase data in SQL Server 2008 R2:</p>\n\n<p><strong>Customers</strong>  </p>\n\n<pre><code>CustId   Last    First    Phone\n   1     Doe     John    555-5555  \n   2     Smith   Sally   444-4444\n   3     Smith   Greg    222-1212\n</code></pre>\n\n<p><strong>Order_Header</strong>  </p>\n\n<pre><code>OrderId  CustId  Date  \n 1001       3   07/08/2011\n 1002       2   07/19/2011\n 1003       2   03/12/2012\n 1004       1   03/14/2012\n 1005       3   03/20/2012\n 1006       1   04/17/2012\n 1007       2   06/04/2012\n 1008       1   08/04/2011\n</code></pre>\n\n<p><strong>Order_Lines</strong>  </p>\n\n<pre><code>OrderId     Sequence    Item      Type    Manufacturer   Price\n 1001          1        WIDGET     C         WidgCo      12.00\n 1001          2        SWITCH     C        SwitchCo     10.00\n 1002          1        RADIO      A        RadSupply    30.00\n 1002          2        CRT        A        CRT&amp;More     31.00\n 1002          3        NCARD      G        iNetwork      5.00\n 1003          1        SENSOR     E        Sensora       7.50\n 1004          1        SENSOR     D        Sensora       6.00\n 1005          1        WIDGET     C         WidgInc     11.50\n 1006          1        RADIO      A        RadSupply    30.00\n 1006          2        SCREEN     A        ScreensInc    2.00\n 1007          1        ANTENNA    G       AntennasPlus   5.50\n 1008          1        SWITCH     B       SwitchOutlet   6.00\n</code></pre>\n\n<p>I'm trying to create a query that will list each customer, their contact information, and the total they've spent on each Type AND the total they've spent with each Manufacturer.  So far, I've tried a variety of different JOINS, but I can't seem to get it to work.<br>\nI'm looking to return something like this:  </p>\n\n<pre><code>CustomerId  Last  First  Phone     TYPE  TOT_TYPE  \n   1        Doe   John  555-5555    A      32.00\n   1        Doe   John  555-5555    B      6.00  \n   1        Doe   John  555-5555    D      6.00    \n</code></pre>\n\n<p>I'm also unsure of how to incorporate the Manufacturer totals.  How can I return both datasets in the same query?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":121,"score":3,"question_id":12271951,"title":"Calculation in stored procedure (TSQL)","body":"<p>I have to write  a calculation for the below scenario in the stored procedure .I have written the below code, Please let me know if it is correct or is there any other better way to write it.</p>\n\n<p>There is a NetWorth amount of some 'x' value and I need to calculate the commission for this 'x' value in the following conditions</p>\n\n<ol>\n<li>Total NetWorth up to 5,000 - 30%</li>\n<li>Total NetWorth up to 5,000.01 to 20,000 - 35%</li>\n<li>Total NetWorth up to 20,000.01 to 50,000 - 40%</li>\n<li>Total NetWorth up to 50,000.01 +  - 45%</li>\n</ol>\n\n<p>For example </p>\n\n<p>If the <code>NetWorth</code> is 100000, the calculation goes like this </p>\n\n<ol>\n<li>For the first 5000 of 100000 the commission is 30% i.e., 5000 * 0.30 = 1500  left out(95000)</li>\n<li>For the next 20000 of 95000 the commission is 35% i.e., 20000 * 0.35 = 7000 left out(75000)</li>\n<li>For the next 50000 of 75000 the commission is 40% i.e., 50000 * 0.40 = 20000 left out(25000)</li>\n<li>For the left out 25000 the commission is 45% i,e., 25000 * 0.45 = 11250</li>\n</ol>\n\n<p>and the total of all this commissions = point1 + point2 + point3 + point4 = 1500 + 7000 + 20000 + 11250 = 39750</p>\n\n<p>Below is the code in stored procedure I have written. Please let me know if this can be improved or there is any other way to write it.</p>\n\n<pre><code>DECLARE @NetWorth DECIMAL(18, 2) \nDECLARE @InterMediateTier1Value DECIMAL(18, 2) \nDECLARE @InterMediateTier2Value DECIMAL(18, 2) \nDECLARE @InterMediateTier3Value DECIMAL(18, 2) \nDECLARE @InterMediateTier1Commission DECIMAL(18, 2) \nDECLARE @InterMediateTier2Commission DECIMAL(18, 2) \nDECLARE @InterMediateTier3Commission DECIMAL(18, 2) \nDECLARE @RemainderCommission DECIMAL(18, 2) \nDECLARE @RemainderValue DECIMAL(18, 2) \n\nSET @NetWorth = 40000 \n\nDECLARE @TotalCommission DECIMAL(18, 2) \n\nIF @NetWorth &lt;= 5000 \n  BEGIN \n      SET @InterMediateTier1Commission = @NetWorth * 0.30 \n      SET @TotalCommission = @InterMediateTier1Commission \n  END \nELSE IF @NetWorth &gt; 5000 \n   AND @NetWorth &lt;= 20000 \n  BEGIN \n      SET @InterMediateTier2Value = @NetWorth - 5000 \n      SET @InterMediateTier1Commission = 5000 * 0.30 \n      SET @InterMediateTier2Commission = @InterMediateTier2Value * 0.35 \n      SET @TotalCommission = @InterMediateTier1Commission \n                             + @InterMediateTier2Commission \n  END \nELSE IF @NetWorth &gt; 20000 \n   AND @NetWorth &lt;= 50000 \n  BEGIN \n      SET @InterMediateTier1Value = @NetWorth - 5000 \n      SET @InterMediateTier1Commission = 5000 * 0.30 \n\n      IF @InterMediateTier1Value &gt; 20000 \n        SET @RemainderValue = @InterMediateTier1Value - 20000 \n\n      SET @RemainderCommission = @RemainderValue * 0.40 \n      SET @InterMediateTier2Commission = 20000 * 0.35 \n      SET @TotalCommission = @InterMediateTier1Commission \n                             + @InterMediateTier2Commission \n                             + @RemainderCommission \n  END \nELSE IF @NetWorth &gt; 50000 \n  BEGIN \n      SET @InterMediateTier1Value = @NetWorth - 5000 \n      SET @InterMediateTier1Commission = 5000 * 0.30 \n\n      IF @InterMediateTier1Value &gt; 20000 \n        SET @RemainderValue = @InterMediateTier1Value - 20000 \n\n      SET @InterMediateTier2Commission = 20000 * 0.35 \n\n      IF @RemainderValue &gt; 50000 \n        SET @InterMediateTier4Value = @RemainderValue - 50000 \n\n      SET @InterMediateTier3Commission = 50000 * 0.40 \n      SET @RemainderCommission = @RemainderValue * 0.45 \n      SET @TotalCommission = @InterMediateTier1Commission \n                             + @InterMediateTier2Commission \n                             + @InterMediateTier3Commission \n                             + @RemainderCommission \n  END \n\nSELECT @TotalCommission AS TotalCommission \n</code></pre>\n"},{"tags":["sql","tsql","datetimeoffset"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":105,"score":2,"question_id":12272945,"title":"SQL Server DateTimeOffset matching same \"day\"","body":"<p>My application needs to collect \"Tuesday's\" purchases for all locations world wide, where \"Tueday\" is the location's Tuesday (regardless of time zone). And if the user needs to re-run the report next week, I need to still get \"Last Tuesday's\" data. All of our data is stored using DateTimeOffset.</p>\n\n<p>So \n9/4/12 00:00:00 -7 through 9/4/12 23:59:59 -7 \nmust MATCH\n9/4/12 00:00:00 +11 through 9/4/12 23:59:59 +11\nwhen I am executing my WHERE clause.</p>\n\n<p>I can't convert to UTC in the WHERE clause because that will pick up the data for \"Tuesday\" in London (depending on DST), not the location's Tuesday. </p>\n\n<p>I tried converting from DateTimeOffset to DateTime, but that seems to convert to UTC. (In my tests, passing 9/1/12 through 9/30/12 picked up 8/31/12 data.)</p>\n\n<p>Is there a trick to doing something like this with TSQL?</p>\n\n<p>Thanks!</p>\n"},{"tags":["tsql","sql-server-2005","merge"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12269817,"title":"Update any column in target table with corresponding non-null source field","body":"<p>This is probably a familiar problem but i didn't find an answer in searches.  I do have a solution (shown below) that involves COALESCE on every non-key column, I'm wondering if there's a Dynamic TSQL routine, or perhaps a different way of forumulating the query that doesn't involve explicitly naming all the columns.  </p>\n\n<p>I have two tables, \"targetTable\" and \"deltaTable\", that have a the same field names and types.  Both have a unique key, \"id\". </p>\n\n<p>Deltatable has data that has changed for a corresponding row in targetTable.  Any column where the value hasn't changed is null.  I want to update the columns in the targetTable that have non-null values in the corresponding row of the deltaTable.  DetlaTable.id is guaranteed to exist in TargetTable.id, and I never want to update a field to NULL.</p>\n\n<p>I'm using SQL Server 2005 (which doesn't have the merge statement, not that I know it would help).</p>\n\n<p>So if a targetTable row looks like</p>\n\n<pre><code>  id | name    |  dob        | next_appt\n  5    Bill       1-1-2012   | 3-3-2015\n</code></pre>\n\n<p>and a deltaTable row looks like</p>\n\n<pre><code>  id | name     | dob        | next_appt\n  5  | NULL     | NULL       | 4-4-2015\n</code></pre>\n\n<p>I want targetTable updated to </p>\n\n<pre><code>  id | name    |  dob        | next_appt\n  5    Bill       1-1-2012   | 4-4-2015\n</code></pre>\n\n<p>What I have now that I want to improve on is:</p>\n\n<pre><code>UPDATE target\nSET target.colA = COALESCE(delta.colA, target.colA),\n    target.colN = COALESCE(delta.colN, target.colN)\nFROM  delta JOIN target on delta.id = target.id\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12270737,"title":"TSQL - ROUND price to .05 and .09. UPDATE is producing NULLs?","body":"<p>I have a table, PriceTable, </p>\n\n<p>columns UPC (int), Price (money)</p>\n\n<p>I am trying to round all of the cents in the Price column, to end in either .x5 or .x9. </p>\n\n<p>If the last digit of the price is 0-5, then the last digit should be a 5.<br>\nIf the last digit of the price is 6-9, then the last digit should be a 9. \n<br>\nExamples<br><ul><li>1.00 goes to 1.05</li><li>1.21 goes to 1.25</li><li>1.26 goes to 1.29</li></ul></p>\n\n<p>I am using the following, but after the update, I am getting some records where the price is being updated to NULL and I can't figure out why. It is working correctly for 95% of the data, but I can't see anything different with the data where it isn't. </p>\n\n<p>My thinking was the (Round(Price,1,2) gives me the dollar in the Price. Subtract that from the overall Price to get the cents and then use the CASE statement add the correct .05 or .09 back to the Price. </p>\n\n<pre><code>UPDATE PriceTable\nSET Price = ROUND(Price,1,2) + \nCASE \nWHEN Price -(ROUND(Price,1,2)) BETWEEN .00 AND .05 THEN .05\nWHEN Price -(ROUND(Price,1,2)) BETWEEN .06 AND .09 THEN .09\nEND;\n</code></pre>\n\n<p>Is there a better way to do this? I can't wrap my head around why I would get a NULL for Price when all cent scenarios should be accounted for and even if they weren't, I should still get the dollar amount of price with the ROUND(Price,1,2). I shouldn't need an ELSE as there shouldn't be any other conditions. </p>\n\n<p>Thanks, </p>\n\n<p>Marshall</p>\n"},{"tags":["sql-server-2008","tsql","hierarchy"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":73,"score":1,"question_id":12269471,"title":"SQL hierarchyid depth first vs breadth first: using one over the other?","body":"<p>I know about <code>Breadth First Search</code> and <code>Depth First Search</code>. I read <a href=\"http://www.sqlservercentral.com/articles/SQL+Server+2008/62204/\" rel=\"nofollow\">this page</a>, and also on SO, I found <a href=\"http://stackoverflow.com/questions/687731/breadth-first-vs-depth-first\">this question</a> and <a href=\"http://stackoverflow.com/questions/1657174/what-is-breadth-first-search-useful-for\">this question</a> too.</p>\n\n<p>What I wanna know is some practical scenerio where I would use depth first over breadth search. Though I third question link I provided is kinda similar, my question is more geared toward <code>t-sql</code> and <code>SQL Server 2008/2012</code> performance.</p>\n\n<p>Also, if I use one over other can anyone show me an example how much (worst case scenario) performance impact can I have? Say, if I adopt a <code>dfs</code>, and I have 50 children in first node, and I am searching for 2nd node, the <code>dfs</code> would be about 50 times slow from what I can think, because it would first have to transverse 50 children then it will come to second node. Is this so or not? I mean is it just like this direct relation btw the performance or otherwise?</p>\n\n<p>Lastly, to repeat my question again, although it may (most likely will be) application and requirement specific, I would like to know some practical scenario where I would use one over the other, and what might be the performance cost of choosing one over the other? Also, I am am maintain a category catalog what should I choose? Say, I am maintaining a books category catalog something like : <code>science =&gt; physics =&gt; astronomy</code> and so on, which one would be the best? <code>dfs</code> or <code>bfs</code>?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":69,"score":2,"question_id":12269919,"title":"What's the deal with trailing white space in TSQL queries?","body":"<p>For example, if I have this data:</p>\n\n<pre><code>CREATE TABLE FooBar ( Name varchar(16) )\n\nINSERT FooBar SELECT 'test@test.com'\n</code></pre>\n\n<p>The following queries don't return what I would expect:</p>\n\n<pre><code>SELECT * FROM FooBar WHERE Name = 'test@test.com       '  -- Returns the row\n\nSELECT * FROM FooBar WHERE Name LIKE 'test@test.com '  -- Nothing Returned\n\nSELECT * FROM FooBar WHERE Name = ' test@test.com' -- Nothing Returned\n</code></pre>\n\n<p>Why does <code>=</code> (which I assume means exactly equals) with extra space at the end return data, while a <code>LIKE</code> does not? </p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":41,"score":1,"question_id":12269132,"title":"How to display rows that don't meet criteria","body":"<p>I have two linked tables:</p>\n\n<pre><code>    Case_Table:                 Case_Clients\n                                Client_ID (int, identity)\n    Case_ID (int, identity) --- Case_ID (int)\n    Conference_ID (int)         Relationship_ID (int)\n    Other Stuff\n</code></pre>\n\n<p>Below is the SQL statement to list all records that has a head of household:</p>\n\n<pre><code>    SELECT Case_Table.Case_ID, \n           Case_Table.Conference_ID, \n           Case_Clients.Client_ID, \n           Case_Clients.Relationship_ID\n    FROM   Case_Clients INNER JOIN\n           Case_Table ON Case_Clients.Case_ID = Case_Table.Case_ID\n    WHERE  (Case_Clients.Relationship_ID = 1)\n</code></pre>\n\n<p>The company requires that each case has a head of household, and we have taken steps to enforce this, but we still have the existing cases that do not have a head of household.  I know that I have over 100 cases without a Head of Household (Relationship_ID = 1).  </p>\n\n<p>Moving on...  what I am trying to do is to list the Conference_ID and Case_ID for each record in Case_Table that does not have a head of household in Case_Clients.</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12268624,"title":"ISNULL in SQL subquery not returning anything","body":"<p>Below is part of a SQL triggered that uses a subquery to return a value in the column TableString. The subquery will return the first two value and the \"marker\" for Fname, however nothing after that (not even the semicolon). The TableString column is an nvarchar that is set to 255 characters and captures all similar data during an insert or an update. </p>\n\n<pre><code>INSERT INTO TransactionLog (TransactionDate, Operator, TableName, Action\n                           , TableString, UserId)\nSELECT LastChangeDate\n     , 'Op'\n     , @tableName\n     , @action\n     , CAST('sNum:' + CAST(sNumber as nvarchar(10)) + ' entType:' + EntityType \n            + ' Fname:' + ISNULL(FirstName, 'NULL') \n            + ' Lname:' + ISNULL(LastName, 'NULL') \n            + ' suff:' + ISNULL(NameSuffix, 'NULL') \n            + ' corpName:' + ISNULL(CorporateName, 'NULL' ) \n            + ' ctrlId:' + ISNULL(CAST(ControlId as nvarchar(3)), 'NULL') \n            AS nvarchar(30)) as TableString\n     , LastChangeOperator\nFROM deleted\n</code></pre>\n\n<p>Returned values in TableString:</p>\n\n<pre><code>sNum:1000024 entType:S Fname\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-administration"],"answer_count":8,"favorite_count":2,"up_vote_count":6,"down_vote_count":0,"view_count":4295,"score":6,"question_id":896810,"title":"SQL Batched Delete","body":"<p>I have a table in SQL Server 2005 which has approx 4 billion rows in it.  I need to delete approximately 2 billion of these rows.  If I try and do it in a single transaction, the transaction log fills up and it fails.  I don't have any extra space to make the transaction log bigger.  I assume the best way forward is to batch up the delete statements (in batches of ~ 10,000?).</p>\n\n<p>I can probably do this using a cursor, but is the a standard/easy/clever way of doing this?</p>\n\n<p>P.S. This table does not have an identity column as a PK. The PK is made up of an integer foreign key and a date.</p>\n"},{"tags":["query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":12264868,"title":"query for a range of records in result","body":"<p>I am wondering if there is some easy way, a function, or other method to return data from a query with the following results. </p>\n\n<p>I have a SQL Express DB 2008 R2, a table that contains numerical data in a given column, say col T.</p>\n\n<p>I am given a value X in code and would like to return up to three records. The record where col T equals my value X, and the record before and after, and nothing else. The sort is done on col T. The record before may be beginning of file and therefore not exist, likewise, if X equals the last record then the record after would be non existent, end of file/table.</p>\n\n<p>The value of X may not exist in the table. </p>\n\n<p>This I think is similar to get a range of results in numerical order.</p>\n\n<p>Any help or direction in solving this would be greatly appreciated.</p>\n\n<p>Thanks again,</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12266459,"title":"SELECT exact table records from a comma-delimited array using T-SQL","body":"<p>This I can't get my simple brain around. A comma-delimited array of products ordered is passed to a procedure like so:</p>\n\n<pre><code>set @array = 'productID_47, productID_4'\n\nselect productID, price from Products \nwhere @array like '%' + productID + '%'\n</code></pre>\n\n<p>Two records are returned. Great.\nBut then if I have:</p>\n\n<pre><code>set @array = 'productID_47'\n\nselect productID, price from Products \nwhere @array like '%' + productID + '%'\n</code></pre>\n\n<p>Again, two records are returned which is NOT what I want.\nThe product codes are fixed, sadly.</p>\n\n<p>Any help would be appreciated, thanks</p>\n"},{"tags":["tsql","reporting-services"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12264882,"title":"SSRS 2005 Many to Many select","body":"<p>I have customers and programs. A customer can be in many programs and I have the CustomerPrograms table for the many to many data. I of course also have the Customers table and the Programs table. In SSRS the client wants to be able to Multi Select the programs parameter (query loaded from Programs table). They also want to see a comma delimited list of the programs in the grid. I wrote a UDF to handle the grid part but I am baffeled about how to handle the Multi Select parameter filtering customers who can be in none, one or many of the programs. </p>\n"},{"tags":["sql","tsql","resultset","multiple-resultsets"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":105,"score":3,"question_id":12265705,"title":"How to prevent SQL from returning multiple resultsets","body":"<p>The issue I'm facing is that I have a stored procedure (lets call it sp_one), which during it's run calls another stored procedure (lets call it sp_two). </p>\n\n<p>I'd only like the resultset from sp_one to be returned at the end, and not those from sp_two. I imagine there is a way to capture the results from sp_two that will prevent them from also being returned but haven't been able to figure the syntax for this. </p>\n\n<p>Any ideas?</p>\n\n<p>Some pseudo code which captures the essence of what is going on (not my actual code):</p>\n\n<pre><code>CREATE PROCEDURE sp_two AS \nBEGIN\n  update Users\n  set is_valid = 0\n\n  select * from Users\nEND\n\n\nCREATE PROCEDURE sp_one\nAS\nBEGIN\n  exec sp_two\n  select * from Users\nEND\n\nexec sp_one\n</code></pre>\n\n<p>The result of running exec sp_one is the resultset from sp_two, then the results from sp_one. (eg. the users table twice).</p>\n"},{"tags":["tsql","correlated-subquery"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":12264585,"title":"T-SQL Subquery Return Column Results","body":"<p>I need to return information from a column that is specified in a subquery.\nIn the subquery below,  I am trying to return info from the PaymentDate column.\nWhen I try to Select Order.PaymentDate in my query I get an error <code>Invalid object name</code> for the <code>Order.PaymentDate</code>.  I tried to specify this as Payment.PaymentDate but I get the same error. \nAny idea on how I can fix this? </p>\n\n<pre><code>(SELECT ID, SUM(amount) AS purchase FROM Order\nWHERE Order.PaymentDate BETWEEN '2012-09-01' AND '2012-09-04'\nAND Order.amount &gt;=0\n    GROUP BY ID)Payment\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12264581,"title":"Issue with SQL query when using DISTINCT and ORDER BY","body":"<p>Given a database table named Messages with the following columns:-</p>\n\n<pre><code>MessageID, FromUser, ToUser, Message, DateTime\n</code></pre>\n\n<p>I want to write an SQL query which selects the distinct values for the \"FromUser\" column, but I would also like the values ordered by DateTime.</p>\n\n<p>Essentially, a query such as:</p>\n\n<pre><code>SELECT * FROM Messages WHERE ToUser='1' ORDER BY DateTime DESC\n</code></pre>\n\n<p>And then, to select the distinct FromUser with something such as:</p>\n\n<pre><code>SELECT DISTINCT FromUser FROM Messages WHERE ToUser='1'\n</code></pre>\n\n<p>At the same time, maintaining the ordering from the previous query.</p>\n\n<p>I have tried using a nested query and ran into an issue as you're unable to use ORDER BY in the inner query.</p>\n\n<p>Essentially, I want the syntax for the query to represent (this is invalid but...):</p>\n\n<pre><code>SELECT DISTINCT FromUser FROM Messages WHERE ToUser=1 AND FromUser IN \n(SELECT * FROM Messages WHERE ToUser=1 ORDER BY DateTime DESC)\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":67,"score":1,"question_id":12261566,"title":"How to avoid duplicated FETCH in T-SQL when using a cursor?","body":"<p>In T-SQL, when iterating results from a cursor, it seems to be common practice to repeat the <code>FETCH</code> statement before the <code>WHILE</code> loop. The below example from <a href=\"http://msdn.microsoft.com/en-us/library/ms178642.aspx\" rel=\"nofollow\">Microsoft</a>:</p>\n\n<pre><code>DECLARE Employee_Cursor CURSOR FOR\nSELECT EmployeeID, Title FROM AdventureWorks2012.HumanResources.Employee\n    WHERE JobTitle = 'Marketing Specialist';\nOPEN Employee_Cursor;\n\nFETCH NEXT FROM Employee_Cursor;\nWHILE @@FETCH_STATUS = 0\n    BEGIN\n        FETCH NEXT FROM Employee_Cursor;\n    END;\nCLOSE Employee_Cursor;\nDEALLOCATE Employee_Cursor;\nGO\n</code></pre>\n\n<p>(Notice how <code>FETCH NEXT FROM Employee_Cursor;</code> appears twice.)</p>\n\n<p>If the <code>FETCH</code> selects into a long list of variables, then we have a large duplicated statement which is both ugly and of course, \"non-DRY\" code.</p>\n\n<p>I'm not aware of a post-condition control-of-flow T-SQL statement so it seems I'd have to resort to a <code>WHILE(TRUE)</code> and then <code>BREAK</code> when <code>@@FETCH_STATUS</code> is not zero. This feels clunky to me.</p>\n\n<p>What other options do I have?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":2,"up_vote_count":5,"down_vote_count":0,"view_count":1536,"score":5,"question_id":3593582,"title":"Database Naming Conventions by Microsoft?","body":"<p>I found <a href=\"http://msdn.microsoft.com/en-us/library/ms229045.aspx\">Naming Guidelines</a> from MSDN, but is it any guideline for MSSQL database from Microsoft? </p>\n"},{"tags":["sql-server-2008","tsql","full-text-search","table-valued-parameters"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":45,"score":0,"question_id":12249043,"title":"Full Text search with 'non-static' searchterm (from joined table variable)","body":"<p>hope (and actually think :) ) that some one already had similar problem and solved it ..</p>\n\n<p>the basic issue in short terms .. as the use of a 'wordsearch' feature and the related data will grow rapidly in near future we (in that case means me) need to change to using fulltext search ..</p>\n\n<p>so its all setup now .. but i'm unable to make the querysyntax work (simplified version below)</p>\n\n<pre><code>declare @searchTerm varchar(256)\nset @searchTerm = 'test'\n\ndeclare @searchValues table (code varchar(900), searchterm varchar(256))\n-- this is just for testing, usually the table is prefilled with different codes and values\nif(@searchTerm is not null) \ninsert into @searchValues\n    select code, @searchTerm from dbo.base_question where question_type_id = 'text'\n\nselect distinct(a.item_id) \nfrom dbo.answer_text as a with (nolock)\njoin dbo.base_question as bqt with (nolock) on bqt.id = a.base_question_id\njoin @searchValues as st on bqt.code = st.code\nwhere a.value is not null\nand not LTRIM(RTRIM(a.value)) = ''\nand CONTAINS(a.value, st.searchterm)\n</code></pre>\n\n<p>the where clause is part of a much larger one\n.. just guessing i would think the 'CONTAINS'-clause needs a kind of 'static' searchterm input and can't handle a row-dependent value ..</p>\n\n<p>couldn't find anything in the msdn nor here ..</p>\n\n<p>one of the major problems is that the 'base_questions' are not fixed and may change and the search-conditions (which question to search for what term) are completely dynamic .. so no switch-case or something like that .. and i think dynamic sql is also not really an option (for different reasons but that would go far beyond the scope of this question :) .. )</p>\n\n<p>however all searches to this database are done via stored procedures with scalar and table-valued parameters (like @searchValues ) .. i would like to keep it that way if somehow possible</p>\n\n<p>so <strong>any hints, tips &amp; suggestions</strong> are appreciated </p>\n\n<p>and FYI and completeness\nshort version of the simplified db-structure:</p>\n\n<p><strong>answer</strong> (<strong>id</strong> bigint (PK), <strong>item_id</strong> uniqueidentifier (FK), <strong>base_question_id</strong> uniqueidentifier (FK), <strong>value</strong> nvarchar(max))</p>\n\n<p><strong>base_question</strong> (<strong>id</strong> uniqueidentifier (PK), <strong>code</strong> varchar(900), <strong>question_type_id</strong> (FK), <em>.. descriptive content ..</em>) </p>\n\n<p><strong>item</strong> (<strong>id</strong> uniqueidentifier (PK), <em>.. descriptive content ..</em>)</p>\n\n<p>.. even open to changing the db-structure to make the searches somewhat performant and working again ;) ..\n(right now we have around 120k item_ids and around 2.5 mio answers for them but that will increase easily by 10 times and more)</p>\n"},{"tags":["sql","sql-server","tsql","ssms","ssms2008"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":12260062,"title":"How can I view a list of syntax errors in a script without running the script on the database?","body":"<p>Simple question:</p>\n\n<p>Does running Debug in SSMS actually execute the script on the server?</p>\n\n<p>How can I view a list of syntax errors in a script without running the script on the database?</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql-server","tsql","parameter-spoofing"],"answer_count":6,"favorite_count":22,"up_vote_count":42,"down_vote_count":0,"view_count":14000,"score":42,"question_id":211355,"title":"Parameter Sniffing (or Spoofing) in SQL Server","body":"<p>A while ago I had a query that I ran quite a lot for one of my users. It was still being evolved and tweaked but eventually it stablised and ran quite quickly, so we created a stored procedure from it. </p>\n\n<p>So far, so normal. </p>\n\n<p>The stored procedure, though, was dog slow. No material difference between the query and the proc, but the speed change was massive. </p>\n\n<p>[Background, we're running SQL Server 2005.]</p>\n\n<p>A friendly local DBA (who no longer works here) took one look at the stored procedure and said \"parameter spoofing!\" (<strong>Edit:</strong> although it seems that it is possibly also known as 'parameter sniffing', which might explain the paucity of Google hits when I tried to search it out.) </p>\n\n<p>We abstracted some of the stored procedure to a second one, wrapped the call to this new inner proc into the pre-existing outer one, called the outer one and, hey presto, it was as quick as the original query. </p>\n\n<p>So, what gives? Can someone explain parameter spoofing? </p>\n\n<p>Bonus credit for </p>\n\n<ul>\n<li>highlighting how to avoid it </li>\n<li>suggesting how to recognise possible cause</li>\n<li>discuss alternative strategies, e.g. stats, indices, keys, for mitigating the situation</li>\n</ul>\n"},{"tags":["sql","sql-server-2008","tsql","pivot","pivot-without-aggregate"],"answer_count":3,"favorite_count":2,"up_vote_count":1,"down_vote_count":0,"view_count":112,"score":1,"question_id":12259207,"title":"data in multiple rows into single row (values not standard)","body":"<p>here's my problem:</p>\n\n<p>I have a table with Names and Addresses, e.g.</p>\n\n<pre><code>Name  |  Address       | Updated\n----------------------------------\na     |  12 lane       | 1/1/2011\nb     |  34 avenue     | 1/1/2011\nc     |  56 district   | 1/1/2011\na     |  78 avenue     | 8/8/2011\nb     |  90 lane       | 8/8/2011\na     |  83 district   | 9/9/2011\na     |  39 road       | 10/10/2011\n</code></pre>\n\n<p>As you can see, it's possible for people to have multiple addresses. Let's say the maximum number of addresses one person has is 5.</p>\n\n<p>I'm only interested in getting the newest 3 addresses for each person, such that the table would look like:</p>\n\n<pre><code>Name  |  Address_1      |   Address_2       |  Address_3\n--------------------------------------------------------------\na     | 78 avenue       |   83 district     | 39 road\nb     | 34 avenue       |   90 lane         | NULL\nc     | 56 district     |   NULL            | NULL\n</code></pre>\n\n<p>Note that a's first entry \"12 lane\" doesn't appear</p>\n\n<p>I've been reading other examples shown on stackoverflow, but i'm not sure if Pivot tables are suitable for what I need, since the addresses are all different</p>\n\n<p>Thanks in advance for any help rendered!</p>\n"},{"tags":["sql","sql-server","tsql","information-schema"],"answer_count":9,"favorite_count":2,"up_vote_count":24,"down_vote_count":0,"view_count":19830,"score":24,"question_id":141682,"title":"How do I find a default constraint using INFORMATION_SCHEMA?","body":"<p>I'm trying to test if a given default constraint exists. I don't want to use the sysbojects table, but the more standard INFORMATION_SCHEMA.</p>\n\n<p>I've used this to check for tables and primary key constraints before, but I don't see default constraints anywhere.</p>\n\n<p>Are they not there? (I'm using MS SQL Server 2000).</p>\n\n<p>EDIT: I'm looking to get by the name of the constraint.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","indexed-view"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":192,"score":1,"question_id":1846509,"title":"Error creating indexed view","body":"<p>I have problem with a counting column in my view.</p>\n\n<pre><code>SELECT ColumnC, ColumnA % ColumnB AS ModuloColAColB, COUNT_BIG(*) AS cBig FROM dbo.T1\nGROUP BY ColumnC, ModuloColAColB \n</code></pre>\n\n<p>Query is similar to this MSDN example:\n<a href=\"http://msdn.microsoft.com/en-us/library/ms191432.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms191432.aspx</a></p>\n\n<p>When I try to compile view I received error message like: \n\"invalid column name ModuloColAColB\" </p>\n\n<p>So I change group by column names: </p>\n\n<pre><code>SELECT ColumnC, ColumnA % ColumnB AS ModuloColAColB,\nCOUNT_BIG(*) AS cBig FROM dbo.T1\nGROUP BY ColumnC, ColumnA, ColumnB\n</code></pre>\n\n<p>View is compiling correctly but when I try to add index I receive the error: </p>\n\n<pre><code>\"Cannot create the clustered index 'px_test' on view 'l' because the select list of the view contains an expression on result of aggregate function or grouping column.\nConsider removing expression on result of aggregate function or grouping column from select list\"\n</code></pre>\n\n<p>When I remove \" ColumnA % ColumnB AS ModuloColAColB\" all works fine.</p>\n\n<p>Database version: SQL server 2005 Enterprise Edition. </p>\n"},{"tags":["c#","asp.net","tsql","sql-server-2012"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":184,"score":2,"question_id":12251027,"title":"ASP.Net SQL Query Input Controls","body":"<p>Schema</p>\n\n<pre><code>    CREATE TABLE \"Rooms\"(\n\n    RoomNo int NOT NULL,\n    RoomType nvarchar(20) NULL,\n    PricePerNight money NULL,\n    MaximumOccupancy int NULL,\n    NoOfBeds int NULL,\n    NoOfBathrooms int NULL,\n    Entertainment bit NULL,\n    RoomService bit NULL,\n    Gym bit NULL,\n\n    CONSTRAINT PK_Rooms PRIMARY KEY(RoomNo)\n)\n\nCREATE TABLE \"Reservation\"(\n\n    ReservationID int IDENTITY (1,1) NOT NULL,\n    CustomerID int NOT NULL,\n    RoomNo int NOT NULL,\n    CheckInDate date NOT NULL,\n    CheckOutDate date NOT NULL,\n    NoOfDays int NOT NULL,\n\n    CONSTRAINT PK_Reservation PRIMARY KEY(ReservationID),\n\n    CONSTRAINT FK_Reservation_Customers_CustID FOREIGN KEY(CustomerID)  \n        REFERENCES dbo.Customers(CustomerID),\n\n    CONSTRAINT FK_Reservation_Rooms_RoomNo FOREIGN KEY(RoomNo)\n        REFERENCES dbo.Rooms(RoomNo)\n)\n</code></pre>\n\n<p>I had in mind to create a query for Sql Server that when the user would enter in 2 dates it would query the Room and Reservation table to bring back all the rooms which are currently available ( available: meaning there is no reservation entry which has/or is in between the dates the user inputs.</p>\n\n<pre><code>Sql-Server-Code\n\n SELECT dbo.Rooms.RoomNo\n FROM dbo.Rooms JOIN dbo.Reservation\n ON (dbo.Rooms.RoomNo = dbo.Reservation.RoomNo)\n WHERE '2012-02-01' NOT BETWEEN dbo.Reservation.CheckInDate AND dbo.Reservation.CheckOutDate\n AND '2012-02-05' NOT BETWEEN dbo.Reservation.CheckInDate AND dbo.Reservation.CheckOutDate;\n</code></pre>\n\n<p>^ i tested this and in the test i carried it, it yielded the results i wanted. So i need to now test this in my ASP.Net website. On my page i have a search box where the users enters in 2 dates, checkin and checkout. This again will return all the rooms which are available so i thought.</p>\n\n<pre><code>ASP.Net Code Search Box\n\n&lt;div id=\"searchContainer\"&gt;\n    &lt;form id=\"searchForm\"&gt;\n    &lt;ul id=\"searchBox\"&gt;\n        &lt;li&gt;Search&lt;/li&gt;\n        &lt;hr /&gt;\n        &lt;li&gt;Check In Date&lt;/li&gt;\n        &lt;li class=\"CiMenu\"&gt;\n            &lt;asp:TextBox ID=\"txtBoxCheckIn\" runat=\"server\" /&gt;\n            &lt;ajaxtoolkit:CalendarExtender ID=\"CalendarExtender2\" runat=\"server\" TargetControlID=\"txtBoxCheckIn\"\n                Format=\"yyyy-MM-dd\" /&gt;\n        &lt;/li&gt;\n        &lt;li&gt;Check Out Date&lt;/li&gt;\n        &lt;li class=\"CoMenu\"&gt;\n            &lt;asp:TextBox ID=\"txtBoxCheckOut\" runat=\"server\" /&gt;\n            &lt;ajaxtoolkit:CalendarExtender ID=\"CalendarExtender1\" runat=\"server\" TargetControlID=\"txtBoxCheckOut\"\n                Format=\"yyyy-MM-dd\" /&gt;\n        &lt;/li&gt;\n        &lt;li&gt;\n            &lt;asp:Button ID=\"searchButton\" runat=\"server\" Text=\"Search\" \n                PostBackUrl=\"~/Rooms.aspx\" /&gt;\n        &lt;/li&gt;\n    &lt;/ul&gt;\n    &lt;/form&gt;\n&lt;/div&gt;\n\nASP.Net Code For my query.\n\n    &lt;asp:SqlDataSource ID=\"RoomDataSource\" runat=\"server\" ConnectionString=\"&lt;%$ ConnectionStrings:HotelProjectConnectionString %&gt;\"\n        SelectCommand=\"SELECT * FROM Rooms JOIN Reservation\n        ON (Rooms.RoomNo = Reservation.RoomNo)\n        WHERE (@CheckIn NOT BETWEEN Reservation.CheckInDate AND Reservation.CheckOutDate)\n        AND ( @CheckOut NOT BETWEEN Reservation.CheckInDate AND Reservation.CheckOutDate)\"&gt;\n        &lt;SelectParameters&gt;\n            &lt;asp:ControlParameter ControlID=\"txtBoxCheckIn\" Name=\"CheckIn\" PropertyName=\"Text\"\n                Type=\"DateTime\" /&gt;\n            &lt;asp:ControlParameter ControlID=\"txtBoxCheckOut\" Name=\"CheckOut\" PropertyName=\"text\"\n                Type=\"DateTime\" /&gt;\n        &lt;/SelectParameters&gt;\n    &lt;/asp:SqlDataSource&gt;\n</code></pre>\n\n<p>I created 9 different rooms room 101-109 and 1 reservation entry.</p>\n\n<pre><code>INSERT Reservation(CustomerID,RoomNo,CheckInDate,CheckOutDate,NoOfDays)\n    VALUES(1,101,'2012-01-01','2012-01-30', DATEDIFF(day,'2012-01-01','2012-01-30'))\n</code></pre>\n\n<ol>\n<li><p>So now if i do a search on my website where the \"checkindate\" is '2012-09-01' and \"checkoutdate\" is '2012-09-05'. It returns room101 row which it should do as theres no reservation entry with those dates for that room, however it doesn't return all the other 8 rooms.</p></li>\n<li><p>If i do a search where the checkindate is '2012-01-01' and checkoutdate is '2012-01-30' &lt; there is already a reservation for this for room101. Meaning it should bring back all the room rows except 101. However it doesn't return anything.</p></li>\n</ol>\n\n<p>Could someone please help me with this, can you see where i am going wrong.</p>\n\n<p>UPDATE: </p>\n\n<p>This new Query is what i'm looking for cept it has a minor problem</p>\n\n<pre><code>SELECT *\nFROM dbo.Rooms\nWHERE NOT EXISTS\n  (select *\n    from dbo.Reservation\n    where dbo.rooms.RoomNo = dbo.Reservation.RoomNo\n    AND '2012-01-01' BETWEEN dbo.Reservation.CheckInDate AND dbo.Reservation.CheckOutDate\n    AND '2012-01-30' BETWEEN dbo.Reservation.CheckInDate AND dbo.Reservation.CheckOutDate\n    );\n</code></pre>\n\n<p>This will show results between room102-109 which is correct however if we change the 2012-01-30 to 2012-01-32 it adds room101 to the result which it shouldn't. Any solution?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":41,"score":2,"question_id":12258412,"title":"T-SQL What does the error message Msg 10709,","body":"<p>This is my code and I added up the same rows so it matched how come it still saying the error?</p>\n\n<pre><code>Use KudlerFineFoods\nINSERT INTO Employee (Lastname,Firstname,[Address],City,[State],TelephoneAreaCode,TelephoneNumber,EmployerInformationReport,HiredDate,Salary,Gender,Age,JobTitleID)\n\nVALUES \n('Edelman','Glenn','175 Bishop Lane','La    Jolla','CA','619','5550199','https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudl er2/intranet/docs/Glenn%20Edelman%202004.pdf','07/10/2003','$21,500','m','1979/12/01',4),\n ('McMullen','Eric', '763 Church Street','Lemon Grove','CA','619','5550135', 'https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/Eric%20McMullen%202004.pdf',\n  '2002/11/01','13,500.00','m','1992/01/01',3),\n('Slentz','Raj', '123 Torrey Drive','North Clairmont','CA','619','5550123','https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/Raj%20Slentz%202004.pdf','2001/06/01','48,000.00','m','1978/02/04',2),\n ('Broun','Erin', '2045 Parkway Apt 2BY','Encinitas' ,'CA','760','555','5550100', 'https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/Erin%20Broun%202004.pdf','2003/12/03','$10,530.00','f','19880201',3),\n ('Carpenter','Donald', '927 Seond Street', 'Encinitas','CA', '927','5550154','https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/Donald%20Carpenter%202004.pdf','2003/11/01','$15,000.00','m','1995/01/01',9),\n ('Esquivez','David','1083 N. Coast HWY Apt 902','Encinitas','CA','760','5550108','https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/David%20Esquivez%202004.pdf','2003/07/25','$18,500.00','m','1991/01/01',8),\n ('Sharp','Nancy', '10793 Montecino Road','Domona','CA','858','5550135', 'https://ecampus.phoenix.edu/secure/aapd/CIST/VOP/Business/Kudler2/intranet/docs/Nancy%20Sharp%202004.pdf','2003/07/12','$21,000.00','f','1992/07/07',4);\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":160,"score":1,"question_id":12216866,"title":"Can't Kill SPID \"Transaction Rollback in Progress\"","body":"<p>I have an uncommitted statement in perptual rollback mode in my database. When I try to kill the SPID associated with this statement, I get the following error:</p>\n\n<blockquote>\n  <p>transaction rollback in progress. Estimated rollback completion: 0%.\n  Estimated time remaining: 0 seconds.</p>\n</blockquote>\n\n<p>This uncommitted statement is causing users to not be able to view the DB's table, view, and procedure trees. How do I stop this SPID? </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":116,"score":4,"question_id":12160599,"title":"Update field by reordering date from all records within the table","body":"<p>Currently, I have this records</p>\n\n<p><strong>InvoiceList Table</strong></p>\n\n<pre><code>InvoiceID   StoreCustomerID IssuedDate Amount      IsPenalty   EmployeeID\n----------- --------------- ---------- ----------- ----------- -----------\n1           13              2007-01-12 244         0           41\n2           31              2007-04-05 81          0           34\n3           23              2007-01-09 184         0           46\n4           28              2007-11-21 231         0           17\n5           36              2006-09-19 121         0           22\n6           28              2006-10-24 240         0           17\n7           15              2006-12-11 193         0           47\n8           21              2007-01-15 172         0           4\n</code></pre>\n\n<p><code>InvoiceID</code> is auto-incremented. What I want to do is to update <code>IssuedDate</code> by increment the date of the previous row. I want to update it like this</p>\n\n<pre><code>InvoiceID   StoreCustomerID IssuedDate Amount      IsPenalty   EmployeeID\n----------- --------------- ---------- ----------- ----------- -----------\n1           13              2007-01-12 244         0           41\n2           31              2007-01-13 81          0           34\n3           23              2007-01-14 184         0           46\n4           28              2007-01-15 231         0           17\n5           36              2007-01-16 121         0           22\n6           28              2007-01-17 240         0           17\n7           15              2007-01-18 193         0           47\n8           21              2007-01-19 172         0           4\n</code></pre>\n\n<p>Currently I have this select statement and is working well. But how can i used this to update the <code>IssuedDate</code>?</p>\n\n<pre><code>WITH SequenceDate AS\n(\n    SELECT  *, ROW_NUMBER() OVER (ORDER BY IssuedDate) RowNumber\n    FROM    Invoice\n)\nSELECT RowNumber, DATEADD(d, RowNumber - 1, b.IssuedDate)\nFROM SequenceDate\nORDER BY RowNumber\n</code></pre>\n\n<p><strong>UPDATE 1</strong></p>\n\n<p>I'm terribly sorry for the first post as the instruction given to me was not correct. The dates shouldn't be incremented since we are not allowed to alter the records in the table except that we can only rearrange the dates in ascending order. So it should be.</p>\n\n<pre><code>InvoiceID   StoreCustomerID IssuedDate Amount      IsPenalty   EmployeeID\n----------- --------------- ---------- ----------- ----------- -----------\n1           13              2006-09-19 244         0           41\n2           31              2006-10-24 81          0           34\n3           23              2006-12-11 184         0           46\n4           28              2007-01-09 231         0           17\n5           36              2007-01-12 121         0           22\n6           28              2007-01-15 240         0           17\n7           15              2007-04-05 193         0           47\n8           21              2007-11-21 172         0           4\n</code></pre>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":122,"score":0,"question_id":12254715,"title":"SQL query to count number of records within a given timeframe, filling in the gaps","body":"<p>I am trying to count the number of records that fall between a given time period, generally 15 minutes, but I'd like to have this interval a variable. My table has a datetime column and I need to get a count of the number of records for every 15 minute interval between two dates and when there aren't any records for the 15-minute window, I need that time period with a zero. I've tried using CTE in different combinations and couldn't get it to work. I can generate the date series using a CTE, but haven't been able to get the actual data in the result. I have a working solution using a stored procedure with a WHILE loop. I was hoping to avoid this if possible in favor or a more elegant solution. </p>\n\n<p>Here is my working loop using a temporary table:</p>\n\n<pre><code>declare @record_count int = 0\ndeclare @end_date_per_query datetime\ncreate table #output (\n    SessionIdTime datetime,\n    CallCount int)\nwhile @date_from &lt; @date_to\nbegin   \n    set @end_date_per_query = DATEADD(minute, @interval, @date_from)\n    select @record_count = COUNT(*) from tbl WHERE SessionIdTime between @date_from and @end_date_per_query\n    insert into #output values (@date_from, @record_count)\n    set @date_from = @end_date_per_query\nend\nselect * from #output order by sessionIdTime\ndrop table #output\n</code></pre>\n\n<p>Hopefully someone can help with a more elegant solution. Any help is appreciated. </p>\n"},{"tags":["sql","sql-server-2008","tsql","datetime"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":155,"score":1,"question_id":10305172,"title":"Issues with T-SQL function to round time to earliest hour","body":"<p>I need to write a function that rounds time in one column to start at its original hour (ex: 23:33:00.0000000 would be 23:00) and time in another column to round up to the next hour (ex: 23:33:00.0000000 would be 24:00) and then insert these new values into new columns.  I found this function on Stack Overflow at <a href=\"http://stackoverflow.com/q/249794/61754\">How to Round a Time in T-SQL</a>, but I can't get the function to run.  I keep getting this error message: 'Msg 156, Level 15, State 1, Procedure RoundTime, Line 11 Incorrect syntax near the keyword 'SELECT'.'</p>\n\n<pre><code>CREATE FUNCTION [dbo].[RoundTime] (@Time datetime, @RoundTo float)\nRETURNS datetime\nAS\nBEGIN\n   DECLARE @RoundedTime smalldatetime\n   DECLARE @Multiplier float\n   SET @Multiplier= 24.0/@RoundTo\n   SET @RoundedTime= ROUND(CAST(CAST(CONVERT(varchar,@Time,121) AS datetime) AS float) * @Multiplier,0)/@Multiplier\n   RETURN @RoundedTime\nEND\nSELECT [dbo].[RoundTime] ('23:33',0.0)\n</code></pre>\n\n<p>I've also tried running it with SELECT dbo.roundtime('23:33',0.0) and still no joy.</p>\n\n<p>So I was hoping to try and figure out how to round the time via getting this function to run, but I can't even run it.  And I don't know the best way to approach getting the hour to round back to its earliest point anyway.  Would I just need to extract the hour from the timestamp and then do my insertion of that hour into its new column?  Or is there a way to convert it on the fly and then insert it into a new column?  I'm using Sql Server 2008.</p>\n"},{"tags":["tsql","query-optimization","indexes","sql-server-2012","filtered-index"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":81,"score":1,"question_id":12252597,"title":"Is it possible to optimize a SELECT COUNT(*) query using a filtered index as a hint to achieve constant speed?","body":"<p>I'd like to count all the Orders that are not urgent and whose order status = 1 (shipped).</p>\n\n<p>This should be a very simple query to optimize. I'd like to put a simple filtered index on the Orders table to cover this query to make it a constant time/O(1) operation. However, when I look at the query plan, it looks like it's using a Index Scan which doesn't make sense. Ideally, this query should just returning the number of items in the index. </p>\n\n<p>The table look like this (simplified to get to the essence):</p>\n\n<pre><code>CREATE TABLE [dbo].[Orders](\n    [Id] [int] IDENTITY(1,1) NOT NULL,\n    [IsUrgent] [bit] NOT NULL,\n    [Status] [tinyint] NOT NULL\n CONSTRAINT [PK_Orders] PRIMARY KEY CLUSTERED ( [Id] ASC )\n</code></pre>\n\n<p>I've created this filtered index:</p>\n\n<pre><code>CREATE INDEX IX_Orders_ShippedNonUrgent ON Orders(Id) WHERE IsUrgent = 0 AND Status = 1;\n</code></pre>\n\n<p>Now, when I do this query:</p>\n\n<pre><code>SELECT COUNT(*) FROM Orders WHERE IsUrgent = 0 AND Status = 1\n</code></pre>\n\n<p>I see that the query plan is using IX_Orders_ShippedNonUrgent, but it's doing an Index Scan and performing around 200 reads across the ~150,000 rows in Orders.</p>\n\n<p>Is it possible to always have this query run in constant time assuming the filtered index is kept up to date? Ideally, it should only perform 1 read to get the size of the index.</p>\n\n<p>If I switch to a non-filtered index like this:</p>\n\n<pre><code>CREATE INDEX IX_Orders_IsUrgentStatus ON Orders(IsUrgent, Status);\n</code></pre>\n\n<p>The query plan uses an Index Seek, but still performs many more reads than should be necessary to answer this simple query.</p>\n\n<p><strong>UPDATE</strong></p>\n\n<p>I'm able to do this</p>\n\n<pre><code>SELECT TOP 1 rows FROM sys.partitions p\nINNER JOIN sys.indexes i\nON i.name = 'IX_Orders_ShippedNonUrgent'\nAND i.object_id = p.object_id\nAND i.index_id = p.index_id\n</code></pre>\n\n<p>and get the result in 9 reads but it seems like there should be a much easier and less brittle way of using the simple COUNT(*) query. </p>\n"},{"tags":["sql","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":23,"score":0,"question_id":12252449,"title":"How to create a History table from the given data in SQL? Please let me know the possible ways step by step","body":"<p>Creating History Tables for the  Database</p>\n\n<p>The  Database will need many history tables.  Some of them will track a single data element and others will track multiple related fields.  All history tables will contain TcId, ProgSolNbr, StartDate, EndDate, and the fields that are being tracked.  History tables will have a foreign key relationship to the main table (usually Accounts) based on the TcId.  The current record for each account will be identified by an EndDate of 9991231.  Any errors that occur during the process of updating history tables will be automatically tracked in the HistLog table.  Below is a list of history tables that are needed and a sample of a stored procedure to update a history table.</p>\n\n<p>HistExtStatInd</p>\n\n<pre><code>            ExtStatInd\n</code></pre>\n\n<p>HistIntStatInd</p>\n\n<pre><code>            IntStatInd\n</code></pre>\n\n<p>HistStatus</p>\n\n<pre><code>            Status\n</code></pre>\n\n<p>HistCycle</p>\n\n<pre><code>            Cycle\n</code></pre>\n\n<p>HistCreditBureauInd</p>\n\n<pre><code>            CreditBureauInd\n</code></pre>\n\n<p>HistPhone</p>\n\n<pre><code>            Phone   Phone2    Phone3\n</code></pre>\n\n<p>HistPricingStrategy</p>\n\n<pre><code>            PricingStrategy\n</code></pre>\n\n<p>HistBal</p>\n\n<p>BalAmt  BalPrinAmt   BalFeeAmt   BalTransferAmt   BalMiscAmt   BalDisputeAmt</p>\n\n<p>HistNameAddress</p>\n\n<pre><code>            Name   Name2   Address   Address2   City   State   Zip   Zip4   \n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":30,"score":0,"question_id":12251247,"title":"Converting string with am/pm in date","body":"<p>I have a varchar field in where I have the following value:\n03/09/2012 11:40:25 a.m.</p>\n\n<p>I need to convert this string in datetime. When I try to apply CONVERT but I get error.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["tsql","ssis","snapshot","msdtc","distributed-transactions"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12249229,"title":"SSIS DTC Transaction Snapshot Isolation","body":"<p>i tried to use in my SSIS Package (2005/2008) the DTC Transaction-SnapShot and it doesn't work. When I use Read Commited it works fine.</p>\n\n<p>My SSIS-Package:</p>\n\n<p>The whole package: IsolationLevel - Snapshot and TransactionOption - Not Supported <br/>\nFirst Execute SQL Task: IsolationLevel - Snapshot and TransactionOption - Not Supported <br/>\nSequence Container: IsolationLevel - Snapshot and TransactionOption - Required <br/>\nExecute task in the Sequence Container: IsolationLevel - Snapshot and TransactionOption - Supported <br/></p>\n\n<p>If I execute the package with this settings the package crashes with the following Error-Massage:<br/>\n<br/>\n[SignalQueue [16]] Error: SSIS Error Code DTS_E_CANNOTACQUIRECONNECTIONFROMCONNECTIONMANAGER.  The AcquireConnection method call to the connection manager \"MyDatabase\" failed with error code 0xC0202009.  There may be error messages posted before this with more information on why the AcquireConnection method call failed. </p>\n\n<p>If I set the whole settings to Read Commited or to Sirializable, the process ends succesfully and the transactions works fine.</p>\n\n<p>Can anybody help me??</p>\n\n<p>Thanks in advance!!</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":12249062,"title":"Pulling another bit of data from delimited string for query results","body":"<p>I use the code below to extract a piece of data that is so many along in the delimited string after a certain character or number appears, I wish to pull another piece of data to appear before each of these values being pulled. \nI do not fully understand how the code works, although I do understand elements of it. I just wish to repeat the process of pulling and integrate it into the query results.</p>\n\n<pre><code>USE RUG_Data \n\nIF OBJECT_ID('tempdb..#splitoutdata','U') IS NOT NULL DROP TABLE #SPLITOUTDATA;\nCREATE TABLE #SPLITOUTDATA (\n    INDEX1 INT,\n    ROWNUM INT,\n    BITOFDATA VARCHAR(max));\n\n\nIF OBJECT_ID(N'dbo.Split_XML', N'TF') IS NOT NULL DROP FUNCTION dbo.Split_XML\nGO\nSET QUOTED_IDENTIFIER ON\nSET ANSI_NULLS ON\nGO\nCREATE FUNCTION dbo.Split_XML\n    (\n     @Parameter VARCHAR(MAX)\n    ,@Delimiter VARCHAR(1)\n    )\nRETURNS @Result TABLE\n    (\n     ItemNumber INT\n    ,ItemValue VARCHAR(MAX)\n    )\nAS \n    BEGIN\n        DECLARE @XML XML ;\n        SET @Parameter = ( SELECT   @Parameter\n                         FOR XML PATH('')\n                         ) ;\n        SELECT  @XML = '&lt;r&gt;' + REPLACE(@Parameter, @Delimiter, '&lt;/r&gt;&lt;r&gt;') + '&lt;/r&gt;' ;\n\n        INSERT  INTO @Result\n                (\n                 ItemNumber\n                ,ItemValue\n                )\n                SELECT  ROW_NUMBER() OVER ( ORDER BY ( SELECT NULL) ) AS ItemNumber\n                ,       Item.value('text()[1]', 'VARCHAR(MAX)') AS ItemValue\n                FROM    @XML.nodes('//r') R ( Item ) ;\n        RETURN ;\n    END ;\nGO\n\n\n;WITH\nREFORMATTEDDATA AS\n(\nSELECT  \n    row_number()over(order by (select null)) as INDEX1,\n\n    REPLACE(REPLACE(CAST(DATA AS VARCHAR(MAX)),CHAR(13),''),CHAR(10),'')AS RAWCLOB2\nFROM\n    RUG_CLOB\nWHERE\n    CAST(DATA AS VARCHAR(MAX)) LIKE 'ZHV|FS0000%%%|D0003001%'\n)\n\n\n\nINSERT INTO #SPLITOUTDATA \nSELECT \n      INDEX1, \n      ROW_NUMBER()OVER(PARTITION BY INDEX1 ORDER BY split.ItemNumber) AS ROWNUM,\n      split.ItemValue AS BITOFDATA \n FROM REFORMATTEDDATA\n CROSS APPLY dbo.Split_XML(reformatteddata.RAWCLOB2,'|') SPLIT\n\n\nCREATE CLUSTERED INDEX idx1 ON #SPLITOUTDATA (INDEX1,ROWNUM)\n\n\nSELECT\n\n    [Date], [MPAN],\n    [1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],\n    [20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],[41],[42],[43],[44],[45],[46],[47],[48],[49],[50] \n\nFROM\n( \n    SELECT \n    INDEX1, \n    (SELECT BITOFDATA FROM #SPLITOUTDATA so2 WHERE so2.INDEX1 = so1.INDEX1 and so2.ROWNUM = 8) AS [Date] ,\n    (SELECT BITOFDATA FROM #SPLITOUTDATA so2 WHERE so2.INDEX1 = so1.INDEX1 and so2.ROWNUM = 14) AS [MPAN] ,\n\n    ROW_NUMBER()OVER(PARTITION BY INDEX1 ORDER BY ROWNUM) AS ROWNUM, \n\n\n\n\n    (SELECT BITOFDATA FROM #SPLITOUTDATA so4 WHERE so4.INDEX1 = so1.INDEX1 AND so4.ROWNUM = so1.ROWNUM +3) AS BITOFDATA \n    FROM #SPLITOUTDATA so1 \n    WHERE BITOFDATA = '012' \n\n\n        --  AND \n        --(SELECT BITOFDATA FROM #SPLITOUTDATA so5 WHERE so5.DC_INDEX_FK = so1.DC_INDEX_FK AND so5.ROWNUM = 10) NOT IN ('TR01')\n    ) p \n    PIVOT \n        (MAX (BITOFDATA) \n    FOR ROWNUM IN ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],[41],[42],[43],[44],[45],[46],[47],[48],[49],[50]) \n) AS PVT\n\n\n\nIF OBJECT_ID('tempdb..#splitoutdata','U') IS NOT NULL DROP TABLE #SPLITOUTDATA;\nIF OBJECT_ID(N'dbo.Split_XML', N'TF') IS NOT NULL DROP FUNCTION dbo.Split_XML\n</code></pre>\n\n<p>At the moment my query results show as </p>\n\n<pre><code>[Date], [MPAN],\n[1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],\n[20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],[41],[42],[43],[44],[45],[46],[47],[48],[49],[50] \n</code></pre>\n\n<p>I wish to have </p>\n\n<pre><code>[Date], [MPAN],\n[E/A],[1], [E/A], [2], [E/A], [3], [E/A], [4], [E/A], [5], [E/A], [6], [E/A], [7], [E/A], [8], [E/A], [9], [E/A], [10], [E/A], [11], [E/A], [12], [E/A], [13], [E/A], [14], [E/A], [15], [E/A], [16], [E/A], [17], [E/A], [18], [E/A], [19], [E/A],[20], [E/A], [21], [E/A], [22], [E/A], [23], [E/A], [24], [E/A], [25], [E/A], [26], [E/A], [27], [E/A],[28], [E/A], [29], [E/A], [30], [E/A], [31], [E/A], [32], [E/A], [33], [E/A], [34], [E/A],[35], [E/A],[36], [E/A], [37], [E/A], [38], [E/A], [39], [E/A], [40], [E/A], [41], [E/A], [42], [E/A], [43], [E/A], [44], [E/A], [45], [E/A], [46], [E/A], [47], [E/A], [48], [E/A],[49], [E/A], [50] \n</code></pre>\n\n<p>The E/A value is also within the delimited string and features one piece before the value I am pulling every time so I assume in some way I will use this bit of code to pull it:</p>\n\n<pre><code>(SELECT BITOFDATA FROM #SPLITOUTDATA so4 WHERE so4.INDEX1 = so1.INDEX1 AND so4.ROWNUM = so1.ROWNUM +2) AS BITOFDATA \nFROM #SPLITOUTDATA so1 \nWHERE BITOFDATA = '012' \n</code></pre>\n\n<p>I just cant get it to work for some reason as Im fairly new at this but I assume its fairly simple. </p>\n\n<p>Sorry if I haven't explained it very well.</p>\n"},{"tags":["sql","sql-server","tsql","like-operator"],"answer_count":4,"favorite_count":2,"up_vote_count":4,"down_vote_count":0,"view_count":122,"score":4,"question_id":12246156,"title":"Repeating characters in T-SQL LIKE condition","body":"<p>Problem:<br>\nLimit the value of a <code>VARCHAR</code> variable (or a column) to digits and ASCI characters, but allow variable length.<br>\nThis script will not yield required result:</p>\n\n<pre><code>declare @var as VARCHAR (150)\nselect @var = '123ABC'\n\nif (@var LIKE '[a-zA-Z0-9]{0,150}')\n    print 'OK'\nelse\n    print 'Not OK'  \n</code></pre>\n\n<p>Anyone have idea how to do this?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":23,"score":1,"question_id":12245773,"title":"Choose the greater of either left or right side of 2 queries","body":"<p>I have the following union query that queries for the most recent date of a column if it exists:</p>\n\n<pre><code>SELECT TOP 1 m.sentdate AS 'calltreelastsignedoff' \nFROM Incidents i \nINNER JOIN Plans p ON i.planuid = p.uid \nINNER JOIN IncidentMessages im ON i.uid = im.incidentuid \nINNER JOIN Messages m ON im.messageuid = m.uid \nWHERE p.uid = '031E3346-2921-426E-9494-1111111111' \nUNION\nSELECT TOP 1 m.sentdate AS 'calltreelastsignedoff' \nFROM Incidents i\nINNER JOIN PlanExercises pe ON i.planexerciseuid = pe.uid\nINNER JOIN IncidentMessages im ON i.uid = im.incidentuid \nINNER JOIN Messages m ON im.messageuid = m.uid \nWHERE pe.planuid = '031E3346-2921-426E-9494-1111111111' \n</code></pre>\n\n<p>This will return 2 values if each query returns a top 1 result.</p>\n\n<p>What I really want is to select the top 1 of the combined query.</p>\n\n<p>How can I perform a select on the unioned query?</p>\n"},{"tags":["c#","asp.net","sql-server","tsql","ado.net"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12243930,"title":"Web Application does not update database at all","body":"<p>I have the following table:</p>\n\n<pre><code>|   product_no    |   product_name   |   price  |\n=================================================\n|    10000        |   teapot         |   5.00   |\n|    10001        |   grasspot       |   2.00   |\n|    10002        |   glasspot       |  10.00   |\n|    10003        |   jackpot        |  15.00   |\n</code></pre>\n\n<p>I have two text field - <code>m_pname</code> and <code>m_pprice</code>.</p>\n\n<p>These two field will display the product name and price when a user select the product name from a drop down list - <code>dropdownlist1</code></p>\n\n<p>Both text field are editable such that when a user edit them and click on a <code>Modify</code> button <code>Button4</code>, the button will update the database.</p>\n\n<p>However, here come the problem - the database is <strong>not</strong> updated and also, the <code>dropdownlist1</code> still reflect the old value.</p>\n\n<p>The <code>dropdownlist1</code> have the <code>Autopostback</code> checkbox checked.</p>\n\n<p>So, I was wondering if this is caused by the <code>Autopostback</code> checkbox.</p>\n\n<p>Some of the code is as follows:</p>\n\n<pre><code>protected void Page_Load(object sender, EventArgs e)\n{\n    SqlConnection conn = ConnectDB(\"Data Source=WR2\\\\SQLEXPRESS;Initial Catalog=testbase;Integrated Security=True\");\n\n    try\n    {\n        conn.Open();\n\n        SqlDataReader testtable = SQLReadCommand(conn, \"Select * from testtable where product_no='\" + DropDownList1.SelectedValue + \"'\");\n\n        if (testtable.HasRows)\n        {\n            while (testtable.Read())\n            {\n                m_pname.Text = testtable[\"product_name\"].ToString();\n                m_pprice.Text = testtable[\"price\"].ToString();\n\n                modify_status.Text = modify_status.Text + \"[ Name: \" + m_pname.Text + \" Price: \" + m_pprice.Text + \" ]\";\n            }\n        }\n        testtable.Close();\n\n        //modify_status.Text = \"\";\n        conn.Close();\n    }\n    catch (Exception err)\n    {\n       modify_status.Text = err.Message;\n    }\n}\n\nprotected void Button4_Click(object sender, EventArgs e)\n{\n    SqlConnection conn = ConnectDB(\"Data Source=WR2\\\\SQLEXPRESS;Initial Catalog=testbase;Integrated Security=True\");\n\n    try\n    {\n        conn.Open();\n        String vpname = m_pname.Text;\n\n        SQLWriteCommand(conn, \"UPDATE testtable SET product_name = '\" + m_pname.Text + \"', price = \" + m_pprice.Text + \" WHERE product_no = \" + DropDownList1.SelectedValue);\n\n        modify_status.Text = \"Changed \" + DropDownList1.SelectedValue + \" to \" + vpname;\n        conn.Close();\n    }\n    catch (Exception err)\n    {\n        modify_status.Text = err.Message;\n    }\n}\n</code></pre>\n"},{"tags":["c#","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":63,"score":-1,"question_id":12193818,"title":"SQLCommand doesn't return anything","body":"<p>I'm trying to execute parameterized SQLCommand, which should return 1 value. Instead, it return an empty set, no exception is thrown, the program just keeps going. </p>\n\n<p>This is the query:</p>\n\n<pre><code>SELECT SUM(s.cost) AS cost\nFROM Spending s JOIN Date d ON s.dateID = d.dateID \n    JOIN [Service category] sc ON s.[service categoryID] = sc.[service categoryID]\nWHERE sc.category1 = 'Phone' AND s.personID = @person\n    AND d.month = @month AND d.year = @year\n</code></pre>\n\n<p>C# code is as follows:</p>\n\n<pre><code>        SqlCommand commandSelect = new SqlCommand(query, conn);\n        foreach (string[] p in pars)\n        {\n            commandSelect.Parameters.AddWithValue(\"@\" + p[0], p[2]);\n        }\n        SqlDataReader res = commandSelect.ExecuteReader();\n</code></pre>\n\n<p>where there are 3 parameters passes and when I check SQLcommand in the debugger, they are passed correctly. @person is a string and the other two are integers.</p>\n\n<p>Any help would be appreciated.</p>\n\n<p>EDIT: \nI probably should also add the stucture of pars array:</p>\n\n<pre><code>pars[0][0] = \"person\"\npars[0][2] = \"'IDString here'\"\npars[1][0] = \"month\"\npars[1][2] = \"2\"\npars[2][0] = \"year\"\npars[2][2] = \"2012\"\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":3,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":75,"score":2,"question_id":12242131,"title":"How to make dynamic column","body":"<p>I have some data as under</p>\n\n<pre><code>Declare @t table (Id int identity,CommaSeperatedValue varchar(100))\nInsert Into @t \nSelect 'Somalia,Vietnam' Union All \nSelect 'apple,banana,guava,India,Australia'\n</code></pre>\n\n<p>There is no limit in the CommaSeperated value. The desired output for the sample provided will be</p>\n\n<pre><code>Id  Col1    Col2    Col3    Col4    Col5\n1   Somalia Vietnam Null    Null    Null\n2   apple   banana  guava   India   Australia\n</code></pre>\n\n<p>That means , the columns will  be generated dynamically. Let us take another example</p>\n\n<pre><code>Declare @t table (Id int identity,CommaSeperatedValue varchar(100))\nInsert Into @t \nSelect 'Somalia,Vietnam,Honolulu,Spain' Union All \nSelect 'apple,banana,guava,India,Australia,Smart,Bus' Union All\nSelect 'Mango'\n</code></pre>\n\n<p>The desired output</p>\n\n<pre><code>Id  Col1    Col2    Col3    Col4    Col5        Col6    Col7    \n1   Somalia Vietnam Honolulu Spain  Null        Null    Null\n2   apple   banana  guava   India   Australia   Smart   Bus\n3   Mango   Null    Null    Null    Null        Null    Null\n</code></pre>\n\n<p>How to do this query?</p>\n\n<p>My attempt so far(after this I am lost) </p>\n\n<pre><code>SELECT \n    X.id,\n    X.CommaSeperatedValue,\n    Y.splitdata \nFROM\n (\n    SELECT *,\n    CAST('&lt;X&gt;'+REPLACE(F.CommaSeperatedValue,',','&lt;/X&gt;&lt;X&gt;')+'&lt;/X&gt;' AS XML) AS xmlfilter \n    FROM @t F\n )X\n CROSS APPLY\n ( \n    SELECT fdata.D.value('.','varchar(50)') as splitdata \n    FROM X.xmlfilter.nodes('X') as fdata(D)\n )Y\n</code></pre>\n\n<p>Thanks in advance</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12242451,"title":"Integrated Security with username and password","body":"<p>Is it possible to use Integrated Security with username and password \nfor connection to SQL Server database because I am using one feature called as Filestream which uses only Integrated Security.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12241661,"title":"using name value pair to update record in database - sql server","body":"<p>Have been looking this up in Google but could not find anything.</p>\n\n<p>Wanted to know if there is a way in SQL Server 2005 that I could use Name Value pairs to update records in the db.</p>\n\n<p>I have a list of Name Value pairs and want to update all the records where Name could be found as a columm value (something that you would specify in where clause) and if the record is found ... update the record with the Value paired with the name</p>\n\n<p>For instance, something like</p>\n\n<pre><code>update X set column_value = &lt;Value paired with the Name&gt; where column_name = &lt;Name from the list&gt;\n</code></pre>\n\n<p>P.S. I have a list of more than 1000 records and this could be more.</p>\n"},{"tags":["tsql","substring"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12240629,"title":"T-SQL substring() behavior","body":"<p>I encountered a bit of code within the book I've been reading that has me questioning the <code>SUBSTRING()</code> function's behavior.   The code is supposed to search a NYSIIS Replacement table (phonetic encoding example) and replace the middle 'N-gram' of an input string based on the location 'End' 'Mid' or 'Start' in the table. an excerpt is provided below:</p>\n\n<p>NYSIIS Replacement Table:</p>\n\n<pre>\nLocation NGram Replacement\n\nMid      A     A\nMid      AW    AA\nMid      E     A\nMid      EV    AF\nMid      EW    AA\nMid      I     A\n</pre>\n\n<pre><code>USE [AdventureWorks]\n\nDECLARE @Result NVARCHAR(100) = N'NEVADA';\n\nDECLARE @Replacement NVARCHAR(10);\n\nDECLARE @i INT;\n\nSET @i = 1;\n\nWHILE @i &lt;= LEN (@Result)\n\nBEGIN\n\n    SET @Replacement = NULL;\n\n    -- Grab the middle-of-name replacement n-gram\n\n    SELECT TOP(1)  @Replacement = Replacement                   \n    FROM dbo.NYSIIS_Replacements                         \n    WHERE Location = N'Mid'\n        AND SUBSTRING(@Result, @i, LEN(NGram)) = NGram\n    ORDER BY LEN(NGram) DESC;\n\n\n    SET @Replacement = COALESCE(@Replacement, SUBSTRING(@Result, @i, 1));   \n\n\n    -- If we found a replacement, apply it\n\n    SET @Result = STUFF(@Result, @i, LEN(@Replacement), @Replacement) \n\n    -- Move on to the next n-gram\n\n    SET @i = @i + COALESCE(LEN(@Replacement), 1);\n\n\nEND;\n\nSELECT @Result;\n</code></pre>\n\n<p>When the <code>SUBSTRING()</code> function encounters 2 possible matches using 'NEVADA' as an example ('E' and 'EV' in the table) how does it 'know' to use the 2 letter string as opposed to the one?  Is this the expected behavior for <code>SUBSTRING()</code>?  </p>\n\n<p>I would assume the <code>@Replacement</code> variable would contain both 'A' and 'AF' but when debugging it only appears to contain 'N' in the first iteration and 'AF' in the second.</p>\n\n<p>Also I could not understand why <code>TOP</code> and <code>ORDER BY</code> were included in this example.  Commenting them out produces the same results.</p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":2,"view_count":191,"score":-1,"question_id":11726107,"title":"User GETDATE() to put current date into SQL variable","body":"<p>I'm trying to get the current date into a variable inside a SQL stored procedure using the following commands</p>\n\n<pre><code>DECLARE @LastChangeDate as date\nSET @LastChangeDate = SELECT GETDATE()\n</code></pre>\n\n<p>This gives me the following error: \"Incorrect Syntax near 'SELECT'\"</p>\n\n<p>This is the first stored procedure I've ever written, so I'm unfamiliar with how variables work inside SQL.  </p>\n"},{"tags":["sql","tsql","binary-tree"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":98,"score":2,"question_id":12234876,"title":"T-SQL Count child node in Binary Tree?","body":"<p>I made a table to store a Binary Tree like below:</p>\n\n<pre><code>- NodeID\n- NodeLeft\n- NodeRight\n</code></pre>\n\n<p>NodeLeft store the ID of the left node. And Node right store the ID of the right node.</p>\n\n<p>I need to write a Procedure that if i pass a NodeID, it'll count how many child node on the left and how many child node on the right. Can separate to 2 Procedure.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12206696,"title":"Using for XML in T-sql to pivot data","body":"<p>I am attempting to use the for XML function to pivot some data.  My data is as follows:</p>\n\n<pre><code>VenNum_A   VenNum_B\n0001       0002\n0001       0003\n0001       0004\n0005       0006\n0005       0007\n0005       0008\n</code></pre>\n\n<p>I am attempting to get the following result:</p>\n\n<pre><code>venNum_A   VenNum_B\n0001       0002,0003,0004\n0005       0006,0007,0008\n</code></pre>\n\n<p>My Code so far: </p>\n\n<pre><code>; with t as\n        (\n        select Distinct \n            A_VenNum, B_VenNum, SUM(1) as Cnt\n        From \n            #VenDups_Addr\n        Group by \n            A_VenNum, B_VenNum\n        )\n        select distinct\n            B_Vennum,\n             A_Vennum =cast(substring((\n            select distinct \n                  [text()] =  ', ' + t1.A_Vennum \n            from \n                  t as t1\n            where \n                t.A_Vennum =t1.A_VenNum\n            for XML path('')\n                ),3,99) as Varchar(254))\n\n        From t  \n</code></pre>\n\n<p>Currently my results are no different than slecting both original fields. </p>\n\n<p>Any help will be greatly appreciated. </p>\n\n<p>Also if this is not the best method of reaching my end goal I am totaly open to an alternate solution, This is the only way I know of doing this. </p>\n\n<p>Also excuse my poor formating</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":90,"score":0,"question_id":12235305,"title":"TSql script for deleting all foreign key constraints and unique constraints?","body":"<p>Is there any TSQL script for deleting all foreign key constraints and unique constraints <strong>in a SQLServer 2008 database</strong>?</p>\n"},{"tags":["c#","asp.net","sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":168,"score":1,"question_id":12230507,"title":"How to restrict users from inputting duplicate values in a table?","body":"<p>I have a table with item names. In asp.net i have a textbox where users may enter new item to add in the table. I need to restrict the users to entering duplicate item name in the table. When user enter a text(item name) in the textbox, which is already present in the table and click on a save button, i need to display a message/validation that the item already exists. How do i do this??</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":93,"score":0,"question_id":12231439,"title":"Need faster concat of columns in sql server table","body":"<p>In a sqlserver table of 200,000 plus records, i need help with faster concat of some columns data grouped by other columns. For example, <strong>sample data and expected results is shown below</strong>. </p>\n\n<p>Here i need to concat the last columns <code>ColumnA, ColumnB, ColumnC</code> as pipe-delimited string, for the combination of these four like : </p>\n\n<pre><code>where KeyNumber=@strKeyNumber  and  Action=@strAction  and  Type=@strType  and  Code=@strCode\n</code></pre>\n\n<p>These four are the distinct combination. </p>\n\n<p>I coded for this using t-sql STUFF function, but it is too slow. I also coded differently with while loop, but even that is too slow. </p>\n\n<p>So i need help with getting a faster result. </p>\n\n<p>The data in those columns A, B, C are long strings, so the concatenated string should be of type <code>nvarchar(max)</code>.</p>\n\n<p><strong>Original data in table (duplicates can be there in some columns):</strong></p>\n\n<pre><code>ID  KeyNumber   Action  Type    Code    ColumnA     ColumnB     ColumnC  \n1   1111111111  AC1     TYPE1   CODE1   ValueA1     ValueB1     ValueC1 \n2   1111111111  AC1     TYPE1   CODE1   ValueA2     ValueB2     ValueC2 \n3   1111111111  AC1     TYPE1   CODE1   ValueA2     ValueB2     ValueC3 \n4   1111111111  AC1     TYPE1   CODE1   ValueA3     ValueB3     ValueC4\n5   2222222222  AC2     TYPE2   CODE2   ValA1       ValB1       ValC1   \n6   2222222222  AC2     TYPE2   CODE2   ValA2       ValB2       ValC2\n7   2222222222  AC2     TYPE2   CODE2   ValA3       ValB3       ValC3\n8   2222222222  AC2     TYPE2   CODE2   ValA4       ValB4       ValC4\n9   2222222222  AC2     TYPE2   CODE2   ValA4       ValB5       ValC4   \n</code></pre>\n\n<p><strong>Need the result data into a new  table like below (duplicate values in above table should not be repeated here):</strong>    </p>\n\n<pre><code>ID  KeyNumber   Action  Type    Code    ColumnA                 ColumnB                         ColumnC  \n1   1111111111  AC1     TYPE1   CODE1   ValueA1|ValueA2|ValueA3 ValueB1|ValueB2|ValueB3         ValueC1|ValueC2|ValueC3|ValueC4 \n2   2222222222  AC2     TYPE2   CODE2   ValA1|ValA2|ValA3|ValA4 ValB1|ValB2|ValB3|ValB4|ValB5   ValC1|ValC2|ValC3|ValC4 \n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":199,"score":1,"question_id":12225563,"title":"comma separated result multiple columns sql server","body":"<p>I have a table with values:</p>\n\n<pre><code>Key1     Key2     ColumnKey \n============================\n1        idx1      here\n2        idx2      there\n</code></pre>\n\n<p>I need to return, for more than one column result seperated by commas.</p>\n\n<p>Example: </p>\n\n<pre><code>1,2   idx1,idx2,      here,there\n</code></pre>\n"},{"tags":["sql","sql-server","vb.net","tsql","datatable"],"answer_count":4,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":11654,"score":3,"question_id":1533139,"title":"Is it possible to insert an entire VB.NET DataTable into a SQL Server at once","body":"<p>I have a SQLClient.DataSet in VB.NET, and I want to insert the entire thing into a SQL Server table without having to do the following:</p>\n\n<pre><code>For Each dr as Datarow in MyDataset\n  Dim sc As New SqlCommand(\"INSERT INTO MyNewTable \" &amp; _\n                            \"VALUES (@column1, @column2)\", MyDBConnection)\n  sc.Parameters.AddWithValue(\"@column1\", dr.Item(0))\n  sc.Parameters.AddWithValue(\"@column2\", dr.Item(1))\n  sc.ExecuteNonQuery()\nNext\n</code></pre>\n\n<p>Since I've got close to a million rows (all pretty skinny, so it's not much space), I obviously don't want to run this loop and generate a million INSERT statements.</p>\n\n<p>I know that one option is to use a linked server when I initially fetch the data, since it's coming from another SQL Server, and just have it to the INSERT from there. However, if I already have the data in my application, is there a more efficient way to bulk insert it? Can I somehow pass the DataTable as a parameter to SQL Server and have it sort it out and insert the rows?</p>\n"},{"tags":["sql","sql-server","tsql","join","isnull"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":77,"score":1,"question_id":12228377,"title":"Combine two SQL Server table results to pull latest data where exists","body":"<p>I have two tables a main table and a work in progress table.  Any inserts/updates are inserted into the WIP table while the record is being manipulated, this allows for validation checks and the like.  I want to create a view that combines the two tables showing the WIP table data whenever it exists and the main table data when there is no WIP data.</p>\n\n<p>I have figured out a way to do this but it seems that it's not the most elegant solution.  I would like to know if there are other ideas or better solutions?</p>\n\n<p>Example illustrating the situation:</p>\n\n<pre><code>select mt.id, wt.id wip_id, isnull(wt.name,mt.name) name, \n       isnull(wt.address, mt.address) address\nfrom main_table mt full outer join\n       wip_table wt on mt.id = wt.orig_id;\n</code></pre>\n\n<p>So that will pull results from the WIP table when they exist, if they dont it will pull results from the main table.  This was a simple example but the tables could have many rows.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":902,"score":2,"question_id":6034488,"title":"Current executing procedure name","body":"<p>Is it possible to get the name of current Stored Procedure in MS SQL Server? May be there is any system variable or function like <code>GETDATE()</code> ?</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":0,"favorite_count":1,"up_vote_count":3,"down_vote_count":1,"view_count":236,"score":2,"question_id":12180854,"title":"TSQL - divide rows into groups based on one field","body":"<p>This is modified version of my earlier question: <a href=\"http://stackoverflow.com/questions/12059119/tsql-equally-divide-resultset-to-groups-and-update-them\">TSQL equally divide resultset to groups and update them</a> </p>\n\n<p>I have my database with 2 tables like so:</p>\n\n<p>Orders table has data like below:</p>\n\n<pre><code>OrderID    OperatorID    GroupID        OrderDesc    Status    Cash    ...\n--------------------------------------------------------------------------\n      1             1          1      small_order         1     300 \n      2             1          1    another_order         1       0 \n      3             1          2      xxxxxxxxxxx         2    1000 \n      5             2          2      yyyyyyyyyyy         2     150 \n      9             5          1      xxxxxxxxxxx         1      50 \n     10          NULL          2      xxxxxxxxxxx         1     150 \n     11          NULL          3      xxxxxxxxxxx         1     -50 \n     12             4          1      xxxxxxxxxxx         1     200 \n</code></pre>\n\n<p>Operators table:</p>\n\n<pre><code>OperatorID    Name    GroupID    Active\n---------------------------------------\n      1       John          1         1\n      2       Kate          1         1\n      4       Jack          2         1\n      5       Will          1         0\n      6        Sam          3         0\n</code></pre>\n\n<p>I'm able to equally divide my recordset into equally groups using below query:</p>\n\n<pre><code>SELECT o.*, op.operatorName AS NewOperator, op.operatorID AS NewOperatorId\nFROM (SELECT o.*, (ROW_NUMBER() over (ORDER BY newid()) % numoperators) + 1 AS randseqnum\n      FROM Orders o CROSS JOIN\n     (SELECT COUNT(*) AS numoperators FROM operators WHERE operators.active=1) op\n      WHERE o.status in (1,3)\n     ) o JOIN\n     (SELECT op.*, ROW_NUMBER() over (ORDER BY newid()) AS seqnum\n      FROM Operators op WHERE op.active=1\n     ) op\n     ON o.randseqnum = op.seqnum ORDER BY o.orderID\n</code></pre>\n\n<p>Demo available at: <a href=\"http://sqlfiddle.com/#!3/ff47b/1\" rel=\"nofollow\">http://sqlfiddle.com/#!3/ff47b/1</a></p>\n\n<p>Using script from above I can divide Orders to (almost) equal groups but based on number or Orders for Operator, but I need to modify it so that it will assign Operators to Orders based on sum or <code>Cash</code> for orders.</p>\n\n<p>For example:</p>\n\n<p>If I have 6 Orders with <code>Cash</code> values: 300, 0, 50, 150, -50, 200 they sum gives 650.<br />\nMy script should assign to 3 Operators random 2 Orders with random sum of <code>Cash</code> for Orders.<br />\nWhat I would like to get is to assign for example 300,-50 to operator1, 200, 0 to second and 150, 50 to third.<br />\nHope this sound clear :)</p>\n\n<p>Here is example output that I expect to get:</p>\n\n<pre><code>ORDERID  OPERATORID  GROUPID    DESCRIPTION  STATUS  CASH  NEWOPERATORID\n------------------------------------------------------------------------\n      1           1        1    small_order       1   300              2\n      2           1        1  another_order       1     0              1\n      9           5        1    xxxxxxxxxxx       1    50              4\n     10      (null)        2    xxxxxxxxxxx       1   150              4\n     11      (null)        3    xxxxxxxxxxx       1   -50              2\n     12           4        1    xxxxxxxxxxx       1   200              1\n</code></pre>\n\n<p><strong>How can I (if I can at all) assign Operators to my Orders so that sum or <code>Cash</code> will be closest to average</strong></p>\n"},{"tags":["tsql","cursor","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12221857,"title":"TSQL variables and cursor scope","body":"<p>I would like to create a cursor on a conditional variable, the following is a short snippet:</p>\n\n<pre><code>DECLARE\n  @my_var VARCHAR(8)\n\nSET @my_var = (some value is obtained and set for @myvar)\n\nDECLARE my_cursor CURSOR FOR\n  SELECT\n    my_cols\n  FROM\n    my_table\n  WHERE\n    some_col &lt; @my_var\n</code></pre>\n\n<p>I need the condition obtained from the variable <code>@my_var</code> before declaring the cursor, but Sybase complains that <code>DECLARE CURSOR</code> must be in it's own batch. However, if I place a <code>GO</code> before <code>DECLARE CURSOR</code> then the variable <code>@my_var</code> will be out of scope.</p>\n\n<p>How can I resolve this scoping issue?</p>\n\n<p>Portion of code causing the problem:</p>\n\n<pre><code>DECLARE\n  @threshold_date VARCHAR(8),\n  @retain_period INT\n\nSET @retain_period =\n(\n  SELECT\n    RETAIN_PERIOD\n  FROM\n    ARCHIVE_RETAIN_PERIOD\n)\nIF(@retain_period &gt; 0)\n  SET @retain_period = @retain_period * -1\n\nSET @threshold_date = CONVERT(VARCHAR(8), DATEADD(DAY, @retain_period, GETDATE()), 112)\n\nDECLARE archive_cursor CURSOR FOR\n  SELECT\n    TIMESTAMP,\n    TIMESTAMP_GRP,\n    CL_ORDER_ID,\n    CL_ORDER_GROUP_ID,\n    CL_PARENT_CHILD,\n    CL_PARENT_ORDER_ID,\n    CL_NUM_CHILDREN,\n    CL_PRIMARY_STATE,\n    CL_SECONDARY_STATE,\n    CL_PENDING_CHANGE,\n    CL_QUANTITY_FILLED,\n    CL_QUANTITY_FILLED_HOUSE,\n    CL_QUANTITY_FILLED_BROKER,\n    CL_QUANTITY_FILLED_CLIENT,\n    CL_QUANTITY_REMAINING,\n    CL_NUM_EXECUTIONS,\n    CL_CHILD_QUANTITY,\n    CL_CHILD_QUANTITY_REMAINING,\n    CL_GROSS_AVG_PRICE,\n    CL_GROSS_AVG_PRICE_HOUSE,\n    CL_GROSS_AVG_PRICE_BROKER,\n    CL_QUANTITY_BOOKED,\n    CL_BOOKING_PRICE,\n    COMPLETION_REASON,\n    COMMISSION,\n    SALES_CREDIT,\n    MARKUP,\n    ROUTED_COUNTERPARTY_ID,\n    CURRENT_EXECUTOR_ID,\n    LAST_EXECUTOR_ID,\n    RETAINED_EXECUTOR_ID,\n    ROUTED_TO,\n    RETAINED_SERVICE_ID,\n    UPDATE_COUNT,\n    UPDATE_USER,\n    UPDATE_DATE,\n    TRADER_MANAGED\n  FROM\n    my_db\n  WHERE\n    TIMESTAMP &lt; @threshold_date\n  AND\n    CL_PRIMARY_STATE = \"C\"\nGO\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":43,"score":1,"question_id":12219655,"title":"Matching up tables to group properly","body":"<p>Im having a lot of trouble counting the amount of vendors per county, per state in our database.  Was hoping someone could help me out.  </p>\n\n<p>I have one table called vendors which lists the vendors id (key) and their current assignments.  </p>\n\n<p>the next table is called postal codes and the columns i need from it are postalcode, FIPS (this is a code for counties in the US) and state. this is simply a list of possible states, postal codes and fips</p>\n\n<p>my third table is vendoraddresses, which lists the addresses of each vendor but does not have a county or fips column or else this would be very easy. this is linked to the vendor table through the vendorid key</p>\n\n<p>the final table is counties, which has the county name for each fips code lined up in rows (ie: 12345 = county name) </p>\n\n<p>im having trouble working with all of these tables together to accurately count the vendors per county per state.  i feel like this really shouldn't be so hard but i hit a mental block i guess.  Below is what i have so far, but its not what i need. Im wondering if a union or something like that would be a better choice to get all these tables together.</p>\n\n<pre><code>SELECT\n\nva.state\n,pc.fips\n,count(v.vendorid) as vendors\n\n\nFROM \nVendors v\njoin vendoraddresses va on va.vendorid = v.vendorid\njoin postalcodes pc on pc.postalcode = va.postalcode\ngroup by va.state, fips\norder by va.state, fips\n</code></pre>\n\n<p>so with some help ive tried to make some progress:</p>\n\n<pre><code>SELECT \nState1\n,County\n,COUNT(Vendor) as Vendors\nFROM\n(\nSELECT\nc.name as County, pc.State as State1, v.VendorID as Vendor\nFROM \nVendors v\njoin vendorserviceareas vsa on vsa.vendorid = v.vendorid\njoin vendorserviceareaentries vsae on vsae.vendorserviceareaid =     vsa.vendorserviceareaid \njoin counties c on c.fips = vsae.fips\njoin postalcodes pc on pc.fips = c.fips\n\nunion \n\nselect c.name as county, s.name as state1, vsa.Vendorid as Vendor from states s\njoin counties c on c.fips = s.fips\njoin vendorserviceareaentries vsae on vsae.fips = c.fips\njoin vendorserviceareas vsa on vsae.vendorserviceareaid = vsa.vendorserviceareaid \n\n\n)a\nGROUP BY State1, County\nOrder BY State1, County\n</code></pre>\n\n<p>the additional tables i have added have the following columns (using abbreviations from query) vsa column 1 = serviceareaid (numerical ID), column 2 = vendorid (numerical id) column 3 =  description(text to describe area of service) (varchar(50)) </p>\n\n<p>the other table vsae has the following columns, column 1 = serviceareaid - same as above table, fips = county code (FK char (5)), and postal code (char (5))</p>\n\n<p>and for some more info each service are could be called \"california\" or somehting like that, the system then has each state, then county, then postal codes within each county listed for a service area, this is where most of my issue is lying because i can get any number of postal codes per county so im getting a false count for what im trying to do.</p>\n\n<p>My ultimate goal is to find out per county how many vendors i have without taking into account the postal codes of a county.</p>\n"},{"tags":["sql-server","tsql","sql-server-2012","spatial-index","spatial-query"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":97,"score":0,"question_id":11376445,"title":"Spatial Index slows down query with STContains","body":"<p>I'm testing if I can use spatial indices on SQL Server 2012.</p>\n\n<p>So, I've got a table</p>\n\n<pre><code>CREATE TABLE [dbo].[Records]\n(\n [ID] [uniqueidentifier] PRIMARY KEY NOT NULL,\n [Value] [nvarchar](256) NOT NULL,\n [Padding] [nvarchar](max) NOT NULL,\n [Bounds] [geometry] NOT NULL\n)\n</code></pre>\n\n<p>and an index</p>\n\n<pre><code>CREATE SPATIAL INDEX [RecordsSpatialIndex]\nON [Records]([Bounds])\nUSING GEOMETRY_GRID\nWITH\n(\n    BOUNDING_BOX = (0, 0, 2000, 2000) -- all coordinates are within this range\n);\n</code></pre>\n\n<p>[Bounds] column contains 5-point polygons, actually rectangles (x1 y1, x1 y2, x2 y2, x2 y1, x1 y1).</p>\n\n<p>@bounds variable contains the same type of rectangle. Strange thing is that the following query</p>\n\n<pre><code>SELECT\n    [ID], [Value], [Padding]\nFROM\n    [Records]\nWHERE\n    ([Bounds].STContains(@Bounds) = 1)\n</code></pre>\n\n<p>runs more than three times faster without the spatial index.</p>\n\n<p>With the index 65% of time is Clustered Index Seek over Records table and 29% is Filter. Totally 65 seconds.</p>\n\n<p>Without the index 92% of time is Filter and 8% is Clustered Index Scan over Records table. Totally 19 seconds.</p>\n\n<p>So, what am I doing wrong here?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12208892,"title":"Use SELECT result for another query","body":"<p>Is there any way other than using a cursor that I can use <code>SELECT</code> results for a subsequent <code>INSERT/UPDATE</code> query?</p>\n\n<p>Something like:</p>\n\n<pre><code>DECLARE @SELECTRESULT;\n\nSELECT Something into @SELECTRESULT\nFROM Somewhere\n\nINSERT INTO SomewhereElse (X, XX, XXX)\nSELECT Something, GETDATE(), 'XXX'\nFROM @SELECTRESULT\n\nUPDATE Somewhere\nSet SomethingElse = 'ABC'\nWHERE\nSomething in\n(SELECT Something FROM @SELECTRESULT) \n</code></pre>\n\n<p>The reason is that I have a relatively complex query from multiple tables and I don't want duplicate this code, once for the insert and second time for the update.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":92,"score":-1,"question_id":12219972,"title":"How to collate rows to a delimited string in SQL2008R2","body":"<p>We are currently upgrading a current data import process we have written in C#.</p>\n\n<p>As part of the upgrade process, we need to check the results of the import process from the rewrite against the results of the old system.</p>\n\n<p>One of the changes we made was breaking comma-delimited lists into rows in another table. This will enable us to filter results using a simple join.</p>\n\n<p>This is the old schema:</p>\n\n<pre><code>FormNumber      MainCategories\n1               blue,green,red\n2               yellow,red,blue\n3               white\n</code></pre>\n\n<p>Which we normalized to:</p>\n\n<pre><code>FormNumber      AttributeId      Value\n1               1                blue\n1               1                green\n1               1                red\n2               1                yellow\n2               1                red\n2               1                blue\n3               1                white\n</code></pre>\n\n<p>Now, our next step is to confirm that the results from the two processes are the same. One of these checks is to compare the MainCategories field of the old process with the results from the normalized tables.</p>\n\n<p>This leads us, finally, to the question: How do I create a comma-delimited list of the new schema to compare to the value of the old.</p>\n\n<p>We have tried the XMLPath solution proposed by @Ritesh here: <a href=\"http://stackoverflow.com/questions/194852/concatenate-many-rows-into-a-single-text-string\">Concatenate many rows into a single text string?</a></p>\n\n<p>Here is the adapted sql statement:</p>\n\n<pre><code>Select distinct ST2.FormNumber, \n           (Select ST1.Value + ',' AS [text()]\n            From cache.ArtifactAttribute ST1\n            Where ST1.FormNumber= ST2.FormNumber\n            ORDER BY ST1.FormNumber\n            For XML PATH ('')) [Values]\n     From cache.ArtifactAttribute ST2\n</code></pre>\n\n<p>The problem is the results are not correct. Even though FormNumber 1 only has three entries in the table, the Values column (the dynamically built delimited string) shows incorrect results. Obviously we are not implementing the sql code correctly.</p>\n\n<p>What are we doing wrong?</p>\n"},{"tags":["sql","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":12217309,"title":"SQL INSERT Calculate NoOfDays Between A Date","body":"<pre><code>    CREATE TABLE \"Reservation\"(\n\n    ReservationID int IDENTITY (1,1) NOT NULL,\n    CustomerID int NOT NULL,\n    RoomNo int NOT NULL,\n    CheckInDate date NULL,\n    CheckOutDate date NULL,\n    NoOfDays int NULL,\n\n    CONSTRAINT PK_Reservation PRIMARY KEY(ReservationID),\n\n    CONSTRAINT FK_Reservation_Customers_CustID FOREIGN KEY(CustomerID)  \n        REFERENCES dbo.Customers(CustomerID),\n\n    CONSTRAINT FK_Reservation_Rooms_RoomNo FOREIGN KEY(RoomNo)\n        REFERENCES dbo.Rooms(RoomNo)\n)\n\n\nINSERT Reservation(CustomerID,RoomNo,CheckInDate,CheckOutDate,NoOfDays)\n        VALUES(1,101,'2012-01-01','2012-01-30',DATEDIFF(NoOfDays,'CheckInDate','CheckOutDate'))\n</code></pre>\n\n<p>Can someone please tell me how i can calculate the number of days between \"CheckInDate\" and \"CheckOutDate\" then have this value in the insert statement for NoOfDays. It's hard to explain i hope you understood what i'm trying to achieve here.</p>\n"},{"tags":["tsql","blob","filestream"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":231,"score":0,"question_id":12218079,"title":"How to convert varbinary(max) with filestream to actual varbinary(max) in T-SQL","body":"<p>I have a database that was setup to use a blob FileStream for audio files on a varbinary(max) field. It's since grown in size in upwards of 80GB and I'm facing performance issues. </p>\n\n<p>After doing some looking around I discovered my average blob size is about 180k. And since according to <a href=\"http://msdn.microsoft.com/en-us/library/bb933993%28v=sql.105%29.aspx\" rel=\"nofollow\">MSDN</a> filestreams should be used for objects over 1MB, I'm re-evaluating how I store these blobs. MSDN also states, \"For smaller objects, storing varbinary(max) BLOBs in the database often provides better streaming performance.\" So I'm considering moving from varbinary(max) with filestream to just using varbinary(max) fields.</p>\n\n<p>So my question is, is there a great way using an sql script to move each filestream blob from the filestream into the actual varbinary field itself? The alternative, which I've been working on before deciding to ask is to have a c# app query the database for the blobs and write each blob to the file system. Then manually remove the filestream stuff from the database. Then have the c# app read the blobs from the file system and write back into the database. I figured there has to be an easier way.</p>\n"},{"tags":["sql-server-2008","tsql","iis","ssrs-2008"],"answer_count":0,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12219121,"title":"Changing matrix column headings by group SSRS 2008","body":"<p>Here is the situation.  I am working in MSSQL Server 2008 and SSRS 2008 and I need to extract all sales by supplier for each branch.  That seems easy enough, the problem comes in trying to display it the way that management wants to see it.  My company has 6 branches that they are interested in this information for.  Each branch is a dealer for different suppliers, well some are the same and some are different.  I know this may be confusing and longwinded but bear with me please.  For instance lets say that:</p>\n\n<pre><code>    Branch1: supp1, supp2, supp3\n    Branch2: supp4, supp1, supp5\n    Branch3: supp3, supp5, supp6\n</code></pre>\n\n<p>Given that sample, what the management wants to see is:</p>\n\n<pre><code>    Branch   Customer  Supp1    Supp2    Supp3    Other    Total\n\n    1        1         Amount   Amount   Amount   Amount   Amount\n    1        n         Amount   Amount   Amount   Amount   Amount\n\n\n    Branch   Customer  Supp4    Supp1    Supp5    Other    Total\n\n    2        1         Amount   Amount   Amount   Amount   Amount\n    2        n         Amount   Amount   Amount   Amount   Amount\n\n\n    Branch   Customer  Supp3    Supp5    Supp6    Other    Total\n\n    3        1         Amount   Amount   Amount   Amount   Amount\n    3        n         Amount   Amount   Amount   Amount   Amount\n</code></pre>\n\n<p>Initially I thought that I could write the SQL and assign a column in the result set as an ordering value as follows:</p>\n\n<pre><code>    select c.name, \n           l.supp,\n           l.qty * l.price as amt,\n           h.branch,\n           case\n                when h.branch = 1 and l.supp in (supp1, supp2, supp3) then l.supp\n                when h.branch = 2 and l.supp in (supp4, supp4, supp5) then l.supp\n                when h.branch = 3 and l.supp in (supp3, supp5, supp6) then l.supp\n                else 'Other'\n           end as mfg,\n           case\n                when h.branch = 1 then\n                     case \n                          when l.supp = supp1 then 1\n                          when l.supp = supp2 then 2\n                          when l.supp = supp3 then 3\n                          else 4\n                     end\n                when h.branch = 2 then\n                     case\n                          when l.supp = supp4 then 1\n                          when l.supp = supp1 then 2\n                          when l.supp = supp5 then 3\n                          else 4\n                     end\n                else\n                     case\n                          when l.supp = supp3 then 1\n                          when l.supp = supp5 then 2\n                          when l.supp = supp6 then 3\n                          else 4\n                     end\n           end as ordering\n    from header h inner join line l on h.h_id = l.h_id\n                  inner join cust c on l.c_id = c.c_id\n    where &lt;some conditions&gt;\n</code></pre>\n\n<p>What that gets me is a result set like:</p>\n\n<pre><code>name   supp        amt    branch   mfg     ordering\n\n a     supp1       3.01     1     supp1       1\n b     supp2       6.23     1     supp2       2\n c     supp3      13.25     1     supp3       3\n d     supp4      75.16     1     Other       4\n e     supp1     103.51     2     supp1       2\n f     supp2      82.36     2     Other       4\n g     supp4      18.82     2     supp4       1\n h     supp5       4.02     2     supp5       3\n i     supp6      26.13     3     supp6       3\n j     supp2      98.12     3     Other       4\n k     supp3        .27     3     supp3       1\n l     supp5      18.02     3     supp5       2\n</code></pre>\n\n<p>What I want from SSRS is this:</p>\n\n<pre><code>Branch   Customer   Supp1     Supp2    Supp3    Other     Total\n\n  1         a        3.01      0.00     0.00     0.00      3.01\n  1         b        0.00      6.23     0.00     0.00      6.23\n  1         c        0.00      0.00    13.25     0.00     13.25\n  1         d        0.00      0.00     0.00    75.16     75.16\n\n\nBranch   Customer   Supp4     Supp1    Supp5    Other     Total\n\n  2         e        0.00    103.51     0.00     0.00    103.51\n  2         f        0.00      0.00     0.00    82.36     82.36\n  2         g       18.82      0.00     0.00     0.00     18.82\n  2         h        0.00      0.00     4.02     0.00      4.02\n\n\nBranch   Customer   Supp3     Supp5    Supp6    Other     Total\n\n  3         i        0.00      0.00    26.13     0.00     26.13\n  3         j        0.00      0.00     0.00    98.12     98.12\n  3         k         .27      0.00     0.00     0.00       .27\n  3         l        0.00     18.02     0.00     0.00     18.02\n</code></pre>\n\n<p>What I get for a header row is:</p>\n\n<pre><code>Branch   Customer   Supp1   Supp2   Supp3   Supp4   Supp5   Supp6   Other   Total\n\n &lt;Insert all of the data here&gt;\n</code></pre>\n\n<p>What I always try to do is to take care of as much as possible in SQL, in part because I really do not know much about VB, and between learning in school and learning at work I don't really have the time to learn yet another something, and if I ever need to change something in the data I can just go to the SQL and re-import the data set.  Is there a way to set the column headings to change with a group in a matrix?  I have tried using a table and filling rows with if statements but couldn't seem to get it to work right.  I think I have included enough information and possibly too much.  For those without the patience to read this I understand, and for those with the patience, I thank you.  If I need to clarify any of this I will be more than happy to.  It is barely possible that I am trying to do too much with one data set and one tablix and making this more difficult than it actually is.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12213872,"title":"List of items which were not updated in the last 24 hours","body":"<p>Morning,\nThis is similar to a question i asked yesterday [question]: <a href=\"http://stackoverflow.com/questions/12198572/sql-query-to-get-latest-prices-depending-on-the-date\">SQL query to get latest prices, depending on the date</a></p>\n\n<p>I need to return a list of ASIN's which are have not been updated within 24 hours from the last update date from the lowest price table. I can get a list of ASIN's, however it returns all of them. Could someone pleas help me with the SQL to get this list please?</p>\n\n<pre><code>SELECT     asin\nFROM       dbo.aboProducts\nWHERE     (asin NOT IN\n               (SELECT    aboProducts_1.asin\n                FROM      dbo.aboProducts AS aboProducts_1 INNER JOIN\n                          dbo.LowestPrices ON aboProducts_1.asin = dbo.LowestPrices.productAsin\n                WHERE    (dbo.aboProducts.amzLive = 'true') AND \n                         (dbo.LowestPrices.priceDate &lt; DATEADD(day, - 1, GETDATE()))))\n</code></pre>\n"},{"tags":["tsql","string"],"answer_count":8,"favorite_count":3,"up_vote_count":22,"down_vote_count":0,"view_count":23587,"score":22,"question_id":159554,"title":"String.Format like functionality in T-SQL?","body":"<p>I'm looking for a built-in function/extended function in T-SQL for string manipulation similar to the String.Format method in .NET.</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","sql-update"],"answer_count":6,"favorite_count":13,"up_vote_count":37,"down_vote_count":0,"view_count":71658,"score":37,"question_id":982919,"title":"SQL update query using joins","body":"<p>I have to update a field with a value which is returned by a join of 3 tables.</p>\n\n<p>Example: </p>\n\n<pre><code>select\n    im.itemid\n    ,im.sku as iSku\n    ,gm.SKU as GSKU\n    ,mm.ManufacturerId as ManuId\n    ,mm.ManufacturerName\n    ,im.mf_item_number\n    ,mm.ManufacturerID\nfrom \n    item_master im, group_master gm, Manufacturer_Master mm \nwhere\n    im.mf_item_number like 'STA%'\n    and im.sku=gm.sku\n    and gm.ManufacturerID = mm.ManufacturerID\n    and gm.manufacturerID=34\n</code></pre>\n\n<p>I want to update the mf_item_number field values of table master with some  other value which is joined in the above condition.</p>\n\n<p>How to frame the SQL ?</p>\n"},{"tags":["sql","sql-server","tsql","limits"],"answer_count":4,"favorite_count":5,"up_vote_count":11,"down_vote_count":0,"view_count":23428,"score":11,"question_id":1869753,"title":"Maximum size for a SQL Server Query? IN clause? Is there a Better Approach","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/1069415/t-sql-where-col-in\">T-SQL WHERE col IN (&hellip;)</a>  </p>\n</blockquote>\n\n<p>What is the maximum size for a SQL Server query? (# of characters)</p>\n\n<p>Max size for an IN clause? I think I saw something about Oracle having a 1000 item limit but you could get around this with ANDing 2 INs together. Similar issue in SQL Server?</p>\n\n<p><strong>UPDATE</strong>\nSo what would be the best approach if I need to take say 1000 GUIDs from another system (Non Relational Database) and do a \"JOIN in code' against the SQL Server? Is it to submit the list of 1000 GUIDs to an IN clause?\nOr is there another technique that works more efficiently?</p>\n\n<p>I haven't tested this but I wonder if I could submit the GUIDs as an XML doc. For example </p>\n\n<pre><code>&lt;guids&gt;\n    &lt;guid&gt;809674df-1c22-46eb-bf9a-33dc78beb44a&lt;/guid&gt;\n    &lt;guid&gt;257f537f-9c6b-4f14-a90c-ee613b4287f3&lt;/guid&gt;\n&lt;/guids&gt;\n</code></pre>\n\n<p>and then do some kind of XQuery JOIN against the Doc and the Table. Less efficient than 1000 item IN clause?</p>\n"},{"tags":["sql-server","tsql","reporting-services","business-intelligence"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12201260,"title":"SSRS - Report Website Error processing Dataset","body":"<p>After adding a T-SQL query-based dataset to a report and deploying it, the report stopped working because of the following error.</p>\n\n<blockquote>\n  <p>An error has occurred during report processing. (rsProcessingAborted)\n  Query execution failed for dataset 'NewDataset'.\n  (rsErrorExecutingCommand) For more information about this error\n  navigate to the report server on the local server machine, or enable\n  remote errors</p>\n</blockquote>\n\n<p>Datasource : Cube + SQL DB\nDataset: Cube + SQL DB</p>\n\n<p>Table on the report: Most columns filled from Cube DB. Added one more column connected T-SQL DB.</p>\n\n<p>Before adding T-SQL dataset, report was showing perfectly on the site. The SSRS previews report perfectly.</p>\n\n<p>The report uses a shared dataset that connects to a SQL shared datasource. </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":75,"score":0,"question_id":12200864,"title":"tsql -group by by max datetime in rows","body":"<p>I have a table and it's data looks like this:</p>\n\n<pre><code> id         name       date\n ---------  ---------  ----------\n 1           a          2012-08-30 10:36:27.393\n 1           b          2012-08-30 14:36:27.393\n 2           c          2012-08-30 13:36:27.393\n 2           d          2012-08-30 16:36:27.393\n</code></pre>\n\n<p>I retrieve the max datetime with this query:</p>\n\n<pre><code>SELECT id,Max(date) as mymaxdate\nFROM table1\ngroup by id\n</code></pre>\n\n<p>This query givse me two rows like this:</p>\n\n<pre><code>1     2012-08-30 14:36:27.393\n2     2012-08-30 16:36:27.393\n</code></pre>\n\n<p>It's correct, but how can i change it to retrieve this result?</p>\n\n<pre><code>1   b  2012-08-30 14:36:27.393\n2   d  2012-08-30 16:36:27.393\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","indexing","index"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":100,"score":1,"question_id":12214029,"title":"SQL Server Indexes of DateTime Parts such as YEAR, MONTH","body":"<p>Is it possible to have indexes on <code>DateTime</code> parts such as <code>DATEPART(YEAR, bp.[CreatedOn])</code> and <code>DATEPART(MONTH, bp.[CreatedOn])</code>? For example, I have the following T-SQL query:</p>\n\n<pre><code>DECLARE @year AS INT = 2012;\nDECLARE @month AS INT = 8;\n\nSELECT bp.Title, bp.CreatedOn FROM BlogPosts bp\nWHERE (DATEPART(YEAR, bp.[CreatedOn]) = @year) AND (DATEPART(MONTH, bp.[CreatedOn]) = @month)\nORDER BY bp.CreatedOn;\n</code></pre>\n\n<p>And this is the execution plan I have: <a href=\"https://gist.github.com/3551450\" rel=\"nofollow\">https://gist.github.com/3551450</a></p>\n\n<p>Currently, there are not many records so it is not a big problem in terms of perf but the records will grow over the time.</p>\n"},{"tags":["sql-server","tsql","query-optimization"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":109,"score":0,"question_id":12208188,"title":"Find gaps in number range spanning multiple columns","body":"<p>I'm trying to identify the gaps in a range of numbers (SQL Server). My scenario is below...</p>\n\n<pre><code>ID   Start   End\n1      1      4\n2      1      6\n3      2      4\n4      8     10\n5     13     14\n\nVisual\n-------------------------------\n1-2-3-4\n1-2-3-4-5-6\n  2-3-4\n           - -8-9-10\n                    - - -13-14\n</code></pre>\n\n<p>The result of this could be something along the lines of:</p>\n\n<pre><code>Table\n-------------------------------\nID   Start   End   Gap\n4      8     10    -1\n5     13     14    -2\n</code></pre>\n\n<p>Ultimately, I want to have the gap ranges, but I should be able to figure that out from above...</p>\n\n<pre><code>Missing\n7\n11-12\n</code></pre>\n\n<p>I came up with solutions that are either too slow or don't account for the overlap in ranges (ex ID 2)</p>\n\n<pre><code>CREATE TABLE #Docs (\n  [Rank] INT, --DENSE_RANK () OVER(ORDER BY BegProd)\n  ControlNumber BIGINT,\n  BegProd INT,\n  EndProd  INT\n)\n\nSELECT\n  T1.ControlNumber,\n  T1.BegProd,\n  T1.EndProd,\n  MAX(T2.EndProd) AS [PreviousEndProd],\n  [Gap] = T1.BegProd - MAX(T2.EndProd) - 1\nFROM #Docs T1\nINNER JOIN #Docs T2\n  ON T1.[Rank] = T2.[Rank] + 1\n  AND T1.EndProd &gt; T2.EndProd\nGROUP BY T1.ControlNumber, T1.BegProd, T1.EndProd\nHAVING T1.BegProd - MAX(T2.EndProd) &gt; 1\n</code></pre>\n\n<p>There is over 2 million rows in this table and a range span of 1 to 1 billion</p>\n\n<p><em>EDIT</em>\nFixed 'Missing' table.\nThe gap column indicates how much of a gap there is before that start number. (ex missing #7 is 1 number)</p>\n"},{"tags":["tsql","reporting-services","where-clause"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":37,"score":0,"question_id":12214048,"title":"T-SQL not executing 2nd part of WHERE clause SSRS","body":"<p>I have a SSRS report which runs from a stored procedure. I've got 2 parameters that must be chosen. My first parameter works perfectly, but when the 2nd parameter is chosen (Rep) it gets ignored by the report and returns all the Reps.</p>\n\n<pre><code>@Town Varchar(100)\n,@Rep Varchar(100)\n\n    select \n    a.Customer\n    ,a.CustName\n    ,a.Rep\n    ,a.Town\n    ,a.Qty\n    ,a.SalesType\n    ,b.Qty1\n    ,c.Qty2\n    ......\n    from #1 a\n    left join #2 b\n    on a.Rep = b.Rep\n    and a.Town = b.Town\n    and a.Customer = b.Customer\n    and a.SalesType = b.SalesType\n    left join #3 c\n    ..........\n    WHERE ('ALL' IN (@Town))    OR     (a.Town IN (@Town)) \n    and ('ALL' IN (@Rep))    OR     (a.Rep IN (@Rep))\n</code></pre>\n"},{"tags":["sql-server","tsql","full-text-search"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":102,"score":0,"question_id":12213585,"title":"TSQL FullText Search with part-word matches","body":"<p>I have a full text index that i'm querying with CONTAINSTABLE()\nThis is working correctly so far when typing in full words.</p>\n\n<p>I however would like to add auto-complete functionality into the text input field being used for searching.\nI understand I can change the search term to include an \"*\" at the end to do a prefix search.</p>\n\n<p>This however breaks a number of queries. eg.</p>\n\n<pre><code>\"foo\" returns the correct results\n\"fo*\" returns the correct results\n\"foo*\" doesn't return anything because it's looking for longer terms.\n\n\"foo bar\" returns the correct results\n\"foo ba*\" doesn't return anything as the asteresk applies to all words eg foo* ba*\n\"foo bar*\" doesn't return anything as above\n</code></pre>\n\n<p>What is my best bet for encompasing all options?</p>\n\n<p>I know i could use 2 separate queries to solve the single word issue (with and without prefix serch). But that doesn't solve searching multiple words.</p>\n\n<p>Thanks in advance</p>\n\n<p>Ben</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":4,"down_vote_count":1,"view_count":78,"score":3,"question_id":12211968,"title":"sql - replace argument not valid","body":"<p>I would like to replace the text of a column in a table</p>\n\n<p>I tried out:</p>\n\n<pre><code>select replace([article], '&lt;p&gt;&amp;nbsp;&lt;/p&gt;', '') from Articles\n\nupdate Articles\nset article = replace(article, '&lt;p&gt;&amp;nbsp;&lt;/p&gt;', '')\nwhere article like '&lt;p&gt;&amp;nbsp;&lt;/p&gt;'\n\nor \n\nUPDATE [AJA].[dbo].[Articles]\n   SET [article] = ' '\n WHERE [article] = '&lt;p&gt;&amp;nbsp;&lt;/p&gt;'\nGO\n</code></pre>\n\n<p>and everytime it comes out with the error:</p>\n\n<blockquote>\n  <p>argument 1 not valid in replace</p>\n</blockquote>\n\n<p>What's wrong with it?</p>\n\n<p>Thanks for your help</p>\n"},{"tags":["sql","database","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":523,"score":1,"question_id":10796449,"title":"Script to list the SQL Server Databases, Size and Utilisation by Specific Application or Service","body":"<p>I am not sure if its possible, but would really appreciate any assistance.</p>\n\n<p>I am looking for a script which can generate the complete list of SQL Server databases with the following details for each database of a SQL Server instance:</p>\n\n<ul>\n<li>Name</li>\n<li>Sizes</li>\n<li>Utilisation by specific application or service </li>\n<li>Hardware Utilisation (CPU, memory, I/O, etc.) </li>\n</ul>\n"},{"tags":["sql-server","query","tsql","dynamic-sql"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":110,"score":3,"question_id":12201023,"title":"Extract value returned from dynamic SQL","body":"<p>I have a stored procedure which generates and executes a piece of dynamic T-SQL which, once built up, looks like this</p>\n\n<pre><code>SELECT \n    tblUsers.strUserName AS [Username]\n    ,tblUsers.strEmail AS [Email]\n    ,tblUserAuditLog.strIpAddress AS [IP Address]\n    ,tblUserAuditLog.dtAuditTimeStamp AS [Timestamp]\n    ,tblUserAuditLog.strAuditLogAction AS [Action]\n    ,tblUserAuditLog.strLogDetails AS [Details]\nFROM         \n    tblUserAuditLog \n        LEFT OUTER JOIN tblUsers \n        ON tblUserAuditLog.intUserIdFK = tblUsers.intUserId\nWHERE \n    tblUsers.strUserName = 'a12jun'\n    AND tblUserAuditLog.dtAuditTimeStamp &gt;= '2012-08-10'\n</code></pre>\n\n<p>This query can return several thousand rows in the dev environment and will return considerably more in live.</p>\n\n<p>I want to find out how many rows the dynamic query returns before I actually return the results, so that if the number is more than some limit, I can return a 'narrow your query' error message.</p>\n\n<p>I have tried generating another piece of SQL like this:</p>\n\n<pre><code>DECLARE @sqlrowcount NVARCHAR(MAX);\nSET @sqlrowcount = 'SELECT COUNT(*) FROM (' + @sql + ') AS TEMP';\nEXEC(@sqlrowcount);\n\nIF @@ROWCOUNT &gt; @limit BEGIN .... END\n</code></pre>\n\n<p>where <code>@sql</code> is the dynamic query.  I then embarrassingly realised that <code>EXEC(@sqlrowcount)</code> will always return <code>1</code>, because it returns one record whose <em>value</em> is the number of records.</p>\n\n<p>Is there a (relatively) elegant way of doing this, e.g. without writing the result to a temporary table?</p>\n"},{"tags":["sql","sql-server","query","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12209345,"title":"How can I make the code inside a WHILE LOOP in SQL execute only once per LOOP?","body":"<p>Question, how can I make the insert execute only 9 time? I say 9 because that's the value of @CN_COUNT. Instead this is executing 9*9. Any help will be really appreciate it. </p>\n\n<pre><code>DECLARE @CN_COUNT INT\n, @DATE VARCHAR(10) = CONVERT(VARCHAR(10), GETDATE(),101)\n, @TIME VARCHAR(10) = CONVERT(VARCHAR(8), GETDATE(),114)\n\n\nSELECT @CN_COUNT = COUNT(*) FROM CARTON_HEADER\n\nDECLARE @CN INT\nSET @CN = 1\nWHILE (@CN  &lt;= @CN_COUNT)\nBEGIN\nSET @CN = @CN + 1\n\nINSERT INTO TM_CARTON(\n    CN_NUMBER, CN_PICKTICKET, CN_LOAD_NUMBER, CN_SHIPMENT_NUMBER,         CN_PACKED_QTY, CN_TRACKING_NUMBER, \n    CN_ROUTE, CN_BOL, CN_MBOL, CN_PARCEL_NUMBER, CN_TRAILER_NUMBER, CN_CREATED_DATE, CN_CREATED_TIME)\nSELECT \n    CN_NUMBER, CN_PICKTICKET, CN_LOAD_NUMBER, CN_SHIPMENT_NUMBER, CN_PACKED_QTY, CN_TRACKING_NUMBER, \n    CN_ROUTE, CN_BOL, CN_MBOL, CN_PARCEL_NUMBER, CN_TRAILER_NUMBER, @DATE, @TIME \n    FROM CARTON_HEADER WHERE CN_LOAD_NUMBER = '1000000002'\n\nEND\nGO\n</code></pre>\n\n<p>Here is the example data:</p>\n\n<pre><code>  CN_NUMBER      CN_STATUS  CN_LOAD_NUMBER\n  1001333311111 85  1000000002\n  1001333311112 85  1000000002\n  1001333311114 85  1000000002\n  1001333311113 85  1000000002\n  1001333311115 85  1000000002\n  1001333311116 85  1000000002\n  1001333311117 85  1000000002\n  1001333311118 85  1000000002\n  1001333311119 85  1000000002\n</code></pre>\n\n<p>The above data is on table A, I would like to get this copied to table B where CN_LOAD_NUMBER is something I declare in the statement</p>\n\n<p>Sorry guys, I made this more complicated than what it was the solution is just a simple INSERT statement with NO loop. </p>\n\n<pre><code>INSERT INTO TM_CARTON(\nCN_NUMBER, CN_PICKTICKET, CN_LOAD_NUMBER, CN_SHIPMENT_NUMBER,         CN_PACKED_QTY, CN_TRACKING_NUMBER, \nCN_ROUTE, CN_BOL, CN_MBOL, CN_PARCEL_NUMBER, CN_TRAILER_NUMBER, CN_CREATED_DATE, CN_CREATED_TIME)\nSELECT \nCN_NUMBER, CN_PICKTICKET, CN_LOAD_NUMBER, CN_SHIPMENT_NUMBER, CN_PACKED_QTY, CN_TRACKING_NUMBER, \nCN_ROUTE, CN_BOL, CN_MBOL, CN_PARCEL_NUMBER, CN_TRAILER_NUMBER, @DATE, @TIME \nFROM CARTON_HEADER WHERE CN_LOAD_NUMBER = '1000000002'\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","dynamic","pivot"],"answer_count":5,"favorite_count":2,"up_vote_count":3,"down_vote_count":0,"view_count":115,"score":3,"question_id":12210692,"title":"T-SQL dynamic pivot","body":"<p>Ok I have a table that looks like this</p>\n\n<pre><code>ItemID | ColumnName | Value\n1      | name       | Peter\n1      | phone      | 12345678\n1      | email      | peter@host.com\n2      | name       | John\n2      | phone      | 87654321\n2      | email      | john@host.com\n3      | name       | Sarah\n3      | phone      | 55667788\n3      | email      | sarah@host.com\n</code></pre>\n\n<p>Now I need to turn that into this:</p>\n\n<pre><code>ItemID | name  | phone    | email\n1      | Peter | 12345678 | peter@host.com\n2      | John  | 87654321 | john@host.com\n3      | Sarah | 55667788 | sarah@host.com\n</code></pre>\n\n<p>I have been looking at dynamic pivot examples, but it seems Im not able to fit them into my scenario.</p>\n\n<p>Can anyone help?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":8,"up_vote_count":22,"down_vote_count":0,"view_count":2222,"score":22,"question_id":2009694,"title":"is there an advantage to varchar(500) over varchar(8000)?","body":"<p>I've read up on this on MSDN forums and here and I'm still not clear. I think this is correct: Varchar(max) will be stored as a text datatype, so that has drawbacks. So lets say your field will reliably be under 8000 characters. Like a BusinessName field in my database table. In reality, a business name will probably always be under (pulling a number outta my hat) 500 characters. It seems like plenty of varchar fields that I run across fall well under the 8k character count. </p>\n\n<p>So should I make that field a varchar(500) instead of varchar(8000)? From what I understand of SQL there's no difference between those two. So, to make life easy, I'd want to define all my varchar fields as varchar(8000). Does that have any drawbacks? </p>\n\n<p>Related: <a href=\"http://stackoverflow.com/questions/177354/size-of-varchar-columns\">http://stackoverflow.com/questions/177354/size-of-varchar-columns</a> (I didn't feel like this one answered my question). </p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":2677,"score":2,"question_id":4324912,"title":"How would I determine if a varchar field in SQL contains any numeric characters?","body":"<p>I'm working on a project where we have to figure out if a given field is potentially a company name versus an address.  </p>\n\n<p>In taking a very broad swipe at it, we are going under the assumption that if this field contains no numbers, odds are it is a name vs. a street address (we're aiming for the 80% case, knowing some will have to be done manually).</p>\n\n<p>So now to the question at hand.  Given a table with, for the sake of simplicity, a single varchar(100) column, how could I find those records who have no numeric characters at any position within the field?</p>\n\n<p>For example:</p>\n\n<pre><code>\"Main Street, Suite 10A\" --Do not return this.\n\"A++ Billing\" --Should be returned\n\"XYZ Corporation\" --Should be returned\n\"100 First Ave, Apt 20\" --Should not be returned\n</code></pre>\n\n<p>Thanks in advance!</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":73,"score":0,"question_id":12205585,"title":"Extracting values from a string into multiple columns","body":"<p>I have a table called Types and the data is like:</p>\n\n<pre><code>Item_Name \n\nHardware \\ Hardware Laptop \\ Display\nApplication \\ Application Configuration Request\nApplication \\ Application File Request\nApplication\n</code></pre>\n\n<p>I am trying to split them into 3 different columns. So tried doing it by the following query:</p>\n\n<pre><code>select parsename(replace([Item_Name],'\\','.'),3) as First,\n parsename(replace([Item_Name],'\\','.'),2) as Second,\n parsename(replace([Item_Name],'\\','.'),1) as third\nfrom dbo.Types\n</code></pre>\n\n<p>But i am not getting the exact result the output i want is:</p>\n\n<pre><code>First          Second                                      Third\nHardware       Hardware Laptop                             Display\nApplication    Application Configuration Request           NULL\nApplication    Application File Request                    NULL\nApplication    NULL                                        NULL\n</code></pre>\n\n<p>But I am getting output as:</p>\n\n<pre><code>First          Second                          Third\nHardware       Hardware Laptop                 Display\nNULL           Application                     Application Configuration Request           \nNULL           Application                     Application File Request                    \nNULL           NULL                            Application\n</code></pre>\n"},{"tags":["sql","performance","tsql","sql-server-2008-r2"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12202091,"title":"SQL Server performance: full index on a table worth it?","body":"<p>Today I just read some comments and I made some experiment. I imagined a system which storing some coordinates.</p>\n\n<p>Here is the situation:</p>\n\n<p>I have two tables, the first is:</p>\n\n<pre><code>CREATE TABLE Points\n(\nID int IDENTITY(1,1) PRIMARY KEY,\nX int,\nY int,\nName varchar(20),\nCreated datetime\n)\n</code></pre>\n\n<p>It is just storing coordinates (1 million rows). The second one is a helper table storing some let's say often used points for a select (around 1100 rows)</p>\n\n<pre><code>CREATE TABLE PointSearchHelper\n(\nX int,\nY int\n)\n</code></pre>\n\n<p>So far so fine. </p>\n\n<p>I would like to make an easy select:</p>\n\n<pre><code>SELECT p.* FROM Points p \nINNER JOIN PointSearchHelper h\nON p.X = h.X AND p.Y = h.Y\n</code></pre>\n\n<p>I run the script, it gets the 1100 rows in around <strong>280 ms</strong> on average. </p>\n\n<p>When I check the execution plan I see, that the SQL Server 2008 R2 recommends an index (who would have thought? ;) ) :</p>\n\n<pre><code>CREATE NONCLUSTERED INDEX [&lt;Name of Missing Index, sysname,&gt;]\nON [dbo].[Points] ([X], [Y])\nINCLUDE ([ID], [Name], [Created])\n</code></pre>\n\n<p>This one is a <strong>full index</strong> on the table, contains each column. It's size is \"huge\" comparing, that I'm storing the data now two times!</p>\n\n<p>So the query no is much faster! It is around <strong>75 ms</strong>(!) Very great improvement <strong>BUT</strong> I need almost <em>double space</em> for this improvement. </p>\n\n<p><strong>My question</strong> is simple: Is there any way to tell the SQL Server on the columns how to store the values or any other trick to save yourself from a double storage?</p>\n\n<p>UPDATE:</p>\n\n<p>With other words: is there any trick to avoid the \"full index\" with the same performance?</p>\n"},{"tags":["tsql","datetime","dateadd"],"answer_count":1,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":203,"score":5,"question_id":11779438,"title":"Don't understand why DATEADD is not incrementing datatime","body":"<p>Migrating data from Access into SQL Server.  SQL Server table defines inst_id, cons_code, and eff_date_time column as primary key.  The eff_date_time data coming from access is not unique so I was attempting to increment the seconds field by one second so I would have a unique datetime.  I can't get DATEADD to increment the date by 1 second.  Attached is my code.  What am I doing wrong???</p>\n\n<pre><code>USE [CON-INST]  \nGO\n\nDECLARE  \n@cv_InstId      VARCHAR(25),  \n@cv_ConsCode    VARCHAR(10),  \n@cv_EffDateTime DATETIME,  \n@lv_count INT  \n\nDECLARE BumpDate_Cursor CURSOR  \nSTATIC  \nFOR  \n          SELECT inst_id, cons_code, eff_date_time  \n            FROM [CON-INST].[dba].[constants_temp]  \n           ORDER BY inst_id  \n\nOPEN BumpDate_Cursor\n\nFETCH FIRST FROM BumpDate_Cursor  \n INTO @cv_InstId, @cv_ConsCode, @cv_EffDateTime\n\nSET @lv_count = 1\n\n// Debug statements  \nPRINT '@cv_InstId = ' + @cv_InstId  \nPRINT '@cv_ConsCode = ' + @cv_ConsCode  \nPRINT '@cv_EffDateTime = ' + CONVERT(VARCHAR, @cv_EffDateTime)  \nPRINT '@lv_count = ' + CONVERT(VARCHAR, @lv_count)  \n\n-- Loop to iterate thru instruments identifying the various constant\ntypes that are needed, i.e. the column names - constant 1, constant 2,\nconstant 3, station, offset, etc.  \nWHILE @@FETCH_STATUS = 0  \n-- do processing  \nBEGIN  \n  PRINT '@lv_count before = ' + CONVERT(VARCHAR, @lv_count)  \n  PRINT CONVERT(VARCHAR, @cv_EffDateTime, 121)  \n  IF (CONVERT(VARCHAR, @cv_EffDateTime,121) = '1901-01-01 17:00:00.000')  \n     BEGIN  \n        UPDATE [CON-INST].[dba].[constants_temp]  \n           SET eff_date_time = DATEADD(second, @lv_count, eff_date_time)  \n         WHERE inst_id = @cv_InstId and cons_code = @cv_ConsCode;  \n        PRINT CONVERT(VARCHAR, @cv_EffDateTime, 121)  \n     END  \n\n  FETCH NEXT FROM BumpDate_Cursor  \n   INTO @cv_InstId, @cv_ConsCode, @cv_EffDateTime  \n\n  SET @lv_count = @lv_count + 1  \n  PRINT '@lv_count after = ' + CONVERT(VARCHAR, @lv_count)  \nEND\n\nCLOSE BumpDate_Cursor\n\nDEALLOCATE BumpDate_Cursor\n</code></pre>\n\n<p><strong>Data in table prior to update</strong> \ninst_id cons_code       eff_date_time   constant        entry_user      enter code entry_date      update_user     update_date<br>\n1       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 821.6   dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 8       dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 2251    dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 2251    dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 22      dba     2012-08-02 11:07:33.770 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 820.9   dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 821.5   dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 8       dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 2095    dba     2012-08-02 11:07:33.773 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 2095    dba     2012-08-02 11:07:33.777 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 22      dba     2012-08-02 11:07:33.777 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 820.5   dba     2012-08-02 11:07:33.777 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:07:33.777 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:07:33.777 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 816.8   dba     2012-08-02 11:07:33.777 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 120.5   dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 2255    dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 1492    dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 986.48  dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 986.48  dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 1857    dba     2012-08-02 11:07:33.780 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 1896    dba     2012-08-02 11:07:33.783 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 986.5   dba     2012-08-02 11:07:33.783 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:07:33.783 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:07:33.783 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 986.5   dba     2012-08-02 11:07:33.783 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 1936    dba     2012-08-02 11:07:33.783 NULL    NULL  </p>\n\n<p><strong>Output from PRINT statements during execution</strong>    </p>\n\n<p>@cv_InstId = 1    </p>\n\n<p>@cv_ConsCode = PU    </p>\n\n<p>@cv_EffDateTime = Jan  1 1901  5:00PM   </p>\n\n<p>@lv_count = 1    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 2    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 3    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 4    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 5    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000   </p>\n\n<p>@lv_count = 6    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 7    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000  </p>\n\n<p>@lv_count = 8    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000 </p>\n\n<p>@lv_count = 9    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000  </p>\n\n<p>@lv_count = 10  </p>\n\n<p>Before update: 1901-01-01 17:00:00.000  </p>\n\n<p>@lv_count = 11    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000  </p>\n\n<p>@lv_count = 12    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 13    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000 </p>\n\n<p>@lv_count = 14    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000   </p>\n\n<p>@lv_count = 15    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000  </p>\n\n<p>@lv_count = 16    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 17    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000   </p>\n\n<p>@lv_count = 18    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 19    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 20    </p>\n\n<p>Before update: 1901-01-01 17:00:00.000    </p>\n\n<p>@lv_count = 21    </p>\n\n<p>Before update: 1972-07-01 00:00:00.000    </p>\n\n<p>@lv_count = 22    </p>\n\n<p>Before update: 1972-07-01 00:00:00.000    </p>\n\n<p>@lv_count = 23    </p>\n\n<p>Before update: 1972-07-01 00:00:00.000<br>\n@lv_count = 24    </p>\n\n<p>Before update: 1972-07-01 00:00:00.000  </p>\n\n<p>@lv_count = 25    </p>\n\n<p>Before update: 1972-07-01 00:00:00.000  </p>\n\n<p><strong>Table Output after Execution</strong><br>\ninst_id cons_code       eff_date_time   constant        entry_user      entry_date      update_user     update_date<br>\n1       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:28:27.287 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 821.6   dba     2012-08-02 11:28:27.287 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 8       dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n1       PU      1901-01-01 17:00:00.000 2251    dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 2251    dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 22      dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 820.9   dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n2       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 821.5   dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 8       dba     2012-08-02 11:28:27.290 NULL    NULL<br>\n3       PU      1901-01-01 17:00:00.000 2095    dba     2012-08-02 11:28:27.293 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 2095    dba     2012-08-02 11:28:27.293 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 22      dba     2012-08-02 11:28:27.293 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 820.5   dba     2012-08-02 11:28:27.293 NULL    NULL<br>\n4       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:28:27.293 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 833.2   dba     2012-08-02 11:28:27.293 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 816.8   dba     2012-08-02 11:28:27.293 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 120.5   dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA       PU      1901-01-01 17:00:00.000 2255    dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 1492    dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 986.48  dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA-1     AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.297 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 986.48  dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-10    AS      1972-07-01 00:00:00.000 1857    dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 1896    dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 986.5   dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-11    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 986.5   dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-12    AS      1972-07-01 00:00:00.000 1936    dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-13    AS      1972-07-01 00:00:00.000 1976    dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-13    AS      1972-07-01 00:00:00.000 986.46  dba     2012-08-02 11:28:27.300 NULL    NULL<br>\nA-13    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.303 NULL    NULL<br>\nA-14    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.303 NULL    NULL<br>\nA-14    AS      1972-07-01 00:00:00.000 986.48  dba     2012-08-02 11:28:27.303 NULL    NULL<br>\nA-14    AS      1972-07-01 00:00:00.000 2016    dba     2012-08-02 11:28:27.303 NULL    NULL<br>\nA-15    AS      1972-07-01 00:00:00.000 0       dba     2012-08-02 11:28:27.303 NULL    NULL  </p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":4,"view_count":128,"score":-4,"question_id":12192471,"title":"T/SQL - how to select first 10 (or less) rows with maximum total sum","body":"<p>I need to select 10 or less rows with the SUM(FileSize) &lt; 1000000. Results need to be ordered by AttachmentId. Let's say that if a single FileSize exceeds the limit it's okay just for that row (and no other) to be selected.</p>\n\n<p>Ideally I'd like it to be just a select query with no more statements.</p>\n\n<p>The table is:</p>\n\n<pre><code>CREATE TABLE [Attachment](\n    [AttachmentId] [int] NOT NULL,\n    [FileSize] [int] NOT NULL\n)\n</code></pre>\n\n<p>Please help.</p>\n\n<p><strong>Updated</strong>. Sorry to hear that the requirements are unclear for most of the readers. There is no requirement to do any grouping. All I need to get is just plain first 10 rows or less. It will be less than 10 if their total on FileSize exceeds 1000000. It will be only 1 row if its FileSize equals 1000000 or more. The server is SQL 2008.</p>\n\n<p><strong>Updated</strong>. Many thanks to Nikola. We are getting there, but I'm still not sure how to implement the case when the first row exceeds FileSize of 1000000. </p>\n\n<pre><code>SELECT TOP 10 a.AttachmentId, rt.runningTotal \nFROM Attachment a\nCROSS APPLY (SELECT SUM(aa.FileSize) AS runningTotal\n   FROM Attachment aa\n   WHERE aa.AttachmentId &lt;= a.AttachmentId\n) AS rt\nGROUP BY a.AttachmentId, rt.runningTotal\nHAVING rt.runningTotal &lt; 1000000\nORDER BY a.AttachmentId  \n</code></pre>\n\n<p><strong>Solution</strong>. This is the code (slightly modified) from Stuart which I accept as answer. Many thanks to Stuart!:</p>\n\n<pre><code>WITH CTE\n  AS ( SELECT TOP 10 AttachmentId, FileSize\n, RunningID = ROW_NUMBER() OVER (ORDER BY AttachmentId)\n   FROM Attachment\n  )\nSELECT AttachmentId, FileSize\nFROM CTE AS a\nWHERE (SELECT SUM(FileSize)\n       FROM CTE\n       WHERE RunningID &lt;= a.RunningID\n       ) &lt;= 10000000\n       OR a.RunningID = 1\n</code></pre>\n"},{"tags":["sql-server","tsql","table"],"answer_count":8,"favorite_count":8,"up_vote_count":31,"down_vote_count":0,"view_count":66787,"score":31,"question_id":175415,"title":"How do I get list of all tables in a database using TSQL?","body":"<p>What is the best way to get the names of all of the tables in a specific database on SQL Server?</p>\n"},{"tags":["sql","mysql","sql-server","tsql","sha1"],"answer_count":6,"favorite_count":0,"up_vote_count":25,"down_vote_count":3,"view_count":10832,"score":22,"question_id":184456,"title":"Is there an equivalent to SHA1() in MS-SQL?","body":"<p>Converting a couple stored procedures from MySQL to Microsoft SQL server. Everything is going well, except one procedure used the MySQL <code>SHA1()</code> function. I cannot seem to find an equivalent to this in MS-SQL.</p>\n\n<p>Does anyone know a valid equivalent for <code>SHA1()</code> on MS-SQL?</p>\n"},{"tags":["sql-server-2008","tsql","gaps-and-islands"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":182,"score":2,"question_id":12177951,"title":"How to identify the first gap in multiple start and end date ranges for each distinct member in T-SQL","body":"<p>I have been working on the below but getting no results and the deadline is fast approaching. Also, there are over a million rows as the below. Appreciate your help on the below.</p>\n\n<p>Objective: Group results by MEMBER and build Continuous Coverage Ranges for each Member by combining individual Date Ranges which either overlap or run consecutive to each other with no breaks between the Start &amp; End day of the range.</p>\n\n<p>I have data in the below format: </p>\n\n<pre><code>MemberCode  -----   ClaimID   -----       StartDate   -----       EndDate\n00001   -----       012345   -----       2010-01-15   -----       2010-01-20\n00001   -----       012350   -----       2010-01-19   -----       2010-01-22\n00001   -----       012352   -----       2010-01-20   -----       2010-01-25\n00001   -----       012355   -----       2010-01-26   -----       2010-01-30\n00002   -----       012357   -----       2010-01-20   -----       2010-01-25\n00002   -----       012359   -----       2010-01-30   -----       2010-02-05\n00002   -----       012360   -----       2010-02-04   -----       2010-02-15\n00003   -----       012365   -----       2010-02-15   -----       2010-02-30\n</code></pre>\n\n<p>...</p>\n\n<p>In the above the member (<strong>00001</strong>) is a valid member as there is a <strong>continuous date range</strong> from <strong>2010-01-15</strong> to <strong>2010-01-30</strong> (with no gaps). Please note that the Claim ID <strong>012355</strong> for this member starts immediately next to the End Date of Claim ID <strong>012352</strong>. This is still valid as it forms a continuous range.</p>\n\n<p>However, the member (<strong>00002</strong>) should be an Invalid member as there is a gap of 5 days between Enddate of Claim ID <strong>012357</strong> and Start Day for Claim ID <strong>012359</strong> </p>\n\n<p>What I am trying to do is get a list of ONLY those members who have claims for every single day of the continuous date range (for each member) with no gaps between the MIN(Start-date) and Max(End Date) for each Distinct member. Members who have gaps are discarded.</p>\n\n<p>Thanks in advance.</p>\n\n<p><strong>UPDATE:</strong></p>\n\n<p>I have reached until here.\nNote: <code>FILLED_DT  = Start Date &amp; PresCoverEndDT = End Date</code></p>\n\n<pre><code>SELECT PresCoverEndDT, FILLED_DT \n\nFROM \n\n(\n\n    SELECT DISTINCT FILLED_DT, ROW_NUMBER() OVER (ORDER BY FILLED_DT) RN\n\n    FROM Temp_Claims_PRIOR_STEP_5 T1\n\n    WHERE NOT EXISTS \n\n            (SELECT * FROM Temp_Claims_PRIOR_STEP_5 T2\n\n            WHERE T1.FILLED_DT &gt; T2.FILLED_DT AND T1.FILLED_DT&lt; T2.PresCoverEndDT \n\n            AND T1.MBR_KEY = T2.MBR_KEY )\n\n) T1\n\n    JOIN (SELECT DISTINCT PresCoverEndDT, ROW_NUMBER() OVER (ORDER BY PresCoverEndDT) RN\n\n        FROM Temp_Claims_PRIOR_STEP_5 T1\n\n        WHERE NOT EXISTS \n\n            (SELECT * FROM Temp_Claims_PRIOR_STEP_5 T2\n\n             WHERE T1.PresCoverEndDT &gt; T2.FILLED_DT AND T1.PresCoverEndDT &lt; T2.PresCoverEndDT AND T1.MBR_KEY = T2.MBR_KEY )\n) T2\n\n     ON T1.RN - 1 = T2.RN\n\nWHERE   PresCoverEndDT &lt; FILLED_DT \n</code></pre>\n\n<p>The above code seems to have error as I am getting only one row and that too it is incorrect. My desired output is only 1 column as below:</p>\n\n<p><strong>Valid_Member_Code</strong></p>\n\n<p>00001</p>\n\n<p>00007</p>\n\n<p>00009</p>\n\n<p>... etc.,</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":65,"score":1,"question_id":12160642,"title":"Select Query in T Sql","body":"<p>Need one help in formulating select query.</p>\n\n<p>I have a table with 50 columns in it, now i want to retrieve not all the columns from this table.</p>\n\n<p>i.e, say i have col like: a,b,c,d &amp; i want a select query without column c,d. I know using simply <code>select a, b from table</code> will serve the purpose, but think when there are 50 columns and you want to retrieve only 40 from them.</p>\n\n<p>Is there any specific T-SQL in sql server syntax available that will full fill the requirement.</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":70,"score":1,"question_id":12205130,"title":"sql one to many","body":"<p>I just want to make sure this is a one to many relationship.  </p>\n\n<p>I have a survey which has a checkboxlist where the user can select multiple Problems in the checkbox list.  So I set up three tables</p>\n\n<pre><code>SurveyResults             SurveyProblems                 ProblemTypes                   \n-------------             --------------                 -------------\nSurveyResultID            SurveyProblemsID               ProblemTypeID\n                          SurveyResultID                 ProblemName\n                          ProblemTypeID\n</code></pre>\n\n<p>is this the correct way to create the database tables if a survey can have multiple problem types?  And this is a one to many relationship, correct?</p>\n"},{"tags":["sql-server","tsql","merge","sql-server-2008-r2","deadlock"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":149,"score":0,"question_id":12201789,"title":"SQL Server 2008 merge statement deadlocking itself","body":"<p>I have the following procedure (SQL Server 2008r2):</p>\n\n<pre><code>create procedure usp_SaveCompanyUserData\n    @companyId bigint,\n    @userId bigint,\n    @dataTable tt_CoUserdata readonly\nas\nbegin\n\n    set nocount, xact_abort on;\n\n    merge CompanyUser with (holdlock) as r\n    using (\n        select \n            @companyId as CompanyId, \n            @userId as UserId, \n            MyKey, \n            MyValue\n        from @dataTable) as newData\n    on r.CompanyId = newData.CompanyId\n        and r.UserId = newData.UserId\n        and r.MyKey = newData.MyKey\n    when not matched then\n        insert (CompanyId, UserId, MyKey, MyValue) values\n        (@companyId, @userId, newData.MyKey, newData.MyValue);\n\nend;\n</code></pre>\n\n<p>CompanyId, UserId, MyKey form the composite key for the target table.\nCompanyId is a foreign key to a parent table.</p>\n\n<p>It is called from many different threads, and I am consistently getting deadlocks between different processes calling this same statement.  My understanding was that the \"with (holdlock)\" was necessary to prevent insert/update race condition errors.  </p>\n\n<p>I assume that two different threads are locking rows (or pages) in different orders when they are validating the constraints, and thus are deadlocking.</p>\n\n<p>Is this a correct assumption?</p>\n\n<p>What is the best way to resolve this situation (i.e. no deadlocks, minimum impact on multi-threaded performance)?</p>\n\n<p>Thank you for any help.</p>\n\n<p>Edit: I was looking at the table, and there is also a non-clustered index on <code>CompanyId asc, UserId asc</code>.</p>\n\n<p>As requested, here is the definition for the underlying table:</p>\n\n<pre><code>CREATE TABLE [dbo].[CompanyUser](\n    CompanyId [bigint] NOT NULL,\n    UserId [bigint] NOT NULL,\n    MyKey [nvarchar](128) NOT NULL,\n    MyValue [nvarchar](256) NULL,\n CONSTRAINT [pk_CompanyUser] PRIMARY KEY CLUSTERED \n(\n    CompanyId ASC,\n    UserId ASC,\n    MyKey ASC\n)WITH (\n    PAD_INDEX  = OFF, \n    STATISTICS_NORECOMPUTE  = OFF, \n    IGNORE_DUP_KEY = OFF, \n    ALLOW_ROW_LOCKS  = ON, \n    ALLOW_PAGE_LOCKS  = ON)\n)\n\nGO\n\nALTER TABLE [dbo].[Company]  WITH NOCHECK ADD  \n    CONSTRAINT [fk_CompanyUser_Company] FOREIGN KEY([CompanyId])\n    REFERENCES [dbo].[Company] ([CompanyId])\n    ON DELETE CASCADE\nGO\n\nALTER TABLE [dbo].[Company] CHECK CONSTRAINT [fk_CompanyUser_Company]\nGO\n</code></pre>\n"},{"tags":["sql","tsql","python-2.7"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":38,"score":1,"question_id":12184702,"title":"Python counting sums of unique items in database","body":"<p><strong>Here is what I have:</strong></p>\n\n<p>A MSSQL DB and table with lets say 200 rows</p>\n\n<h2>Python 2.7 and pyodbc</h2>\n\n<p>There is a column, we will call type, and in the rows under it contain an unknown quantity of unique values. For instance, right now there is the possibility of <strong>a,b,c,d,e</strong> and <strong>f</strong> for the values <em>but</em> in the future, <strong>a</strong> may go away or we might add <strong>g</strong>.</p>\n\n<p>Therefore I do not believe I can have a predefined set of variables or a dictionary of some sorts to reference.</p>\n\n<p>My goal is to have python/sql look at the table, determine how many unique items there are and then count up the totals of each unique item, giving me an output like: <em>there are 50 a's and 23 b's and 5 c's</em></p>\n\n<p>Is there some function out there that accomplishes this or is there something in SQL that would do this for me? Would I have to determine the amount of unique items and then run sql statements for each item?</p>\n"}]}
{"total":16599,"page":18,"pagesize":100,"questions":[{"tags":["tsql","sybase"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":35,"score":0,"question_id":12203598,"title":"How to export custom data types from one Sybase DB and import to another?","body":"<p>There are several hundred custom data types in a source Sybase DB need to be in a new, freshly created destination Sybase DB.</p>\n\n<p>Through some fidgeting, I was able to create a script to extract and add all the custom data types from the source DB into the destination DB. However, I keep getting the following error:</p>\n\n<p><code>Number (257) Severity (16) State (1) Server (ASED052) Implicit conversion from datatype 'NUMERIC' to 'VARCHAR' is not allowed.  Use the CONVERT function to run this query.</code></p>\n\n<p>I checked and double checked that all the types matched (though types of <code>CHAR</code> in source is made to be <code>VARCHAR</code> in destination, I think this is an OKAY implicit conversion?)</p>\n\n<p>Is there a way to create a script that would allow me to export all custom data types from the source DB and import them into a destination DB such that the types will match and there will be no conversion issues?</p>\n"},{"tags":["sql","sql-server","tsql","datetime","case-when"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":1,"view_count":95,"score":1,"question_id":12202501,"title":"Need to replace datetime field in SQL query when it equals 9999-12-31 00:00:00","body":"<p>I have a datetime field called ACTUALCLOSEDATE and this field is equal to 9999-12-31 00:00:00 when a corresponding field called STATUSNUM = 0.  When STATUSNUM is changed to 1 (when the record is closed) the value of ACTUALCLOSEDATE is changed to current datetime.</p>\n\n<p>In my query, I want to replace the value of ACTUALCLOSEDATE when it = 9999-12-31 00:00:00 with 'Still Open' when it dosen't I just want the date.</p>\n\n<p>I have tried code below with errors.  Ideas?  I don't IIF is available SQL 2008 r2, is it? and if so can I use it?</p>\n\n<pre><code>/* This is what I need but it dosen't work in SQL 2008 R2 */\nSELECT\nIIF (YEAR(ACTUALCLOSEDATE)=9999, \"Still Open\", ACTUALCLOSEDATE) AS ActCloseDate,\nFROM OPPORTUNITY\n\n/* This dosen't work either */\nSELECT\nCAST YEAR(ACTUALCLOSEDATE)\n    WHEN 9999 THEN 'Still Open'\n    ELSE ACTUALCLOSEDATE\n    END AS Act_Close,\nFROM OPPORTUNITY\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","optimization"],"answer_count":12,"favorite_count":8,"up_vote_count":14,"down_vote_count":0,"view_count":11046,"score":14,"question_id":2273815,"title":"IF EXISTS before INSERT, UPDATE, DELETE for optimization","body":"<p>There is quite often situation when you need to execute INSERT, UPDATE or DELETE statement based on some condition. And my question is whether the affect on the performance of the query add IF EXISTS before the command.</p>\n\n<p>Example</p>\n\n<pre><code>IF EXISTS(SELECT 1 FROM Contacs WHERE [Type] = 1)\n    UPDATE Contacs SET [Deleted] = 1 WHERE [Type] = 1\n</code></pre>\n\n<p>What about INSERTs or DELETEs?</p>\n"},{"tags":["sql","query","tsql","multiple","aggregation"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":72,"score":1,"question_id":12200913,"title":"Aggregate Query returning multiple records","body":"<p>I have the following table (<em>simplified</em>):</p>\n\n<pre><code>RecordID       bigint         IDENTITY\nItemID         bigint\nConfigID       varchar\nStatus         varchar\nStatusDate     date\n</code></pre>\n\n<p><strong>Sample Data</strong>:</p>\n\n<pre><code>001  04  1E  10    2007-08-14 13:57:54\n002  04  1E  12    2007-08-21 16:10:21\n003  04  1D  10    2007-09-27 17:14:13\n004  04  1D  43    2011-01-10 13:44:50\n005  04  1B  50    2008-06-20 09:09:51\n006  05  1A  17    2007-12-18 14:04:56\n007  05  1A  11    2007-10-17 08:23:52\n008  05  1A  12    2007-10-19 12:54:18\n009  05  1B  12    2007-11-02 09:23:54\n010  05  1B  40    2010-06-17 09:34:33\n011  07  1A  12    2007-11-19 14:48:06\n012  07  1A  12    2007-11-19 15:02:48\n013  07  1B  40    2011-01-10 14:36:16\n014  08  1B  10    2009-05-22 11:14:42\n015  08  1B  12    2007-11-20 17:02:44\n016  08  1A  12    2007-12-12 16:11:57\n017  08  1A  10    2009-11-12 11:12:45\n018  08  1C  35    2011-01-10 18:30:10\n019  08  1D  12    2009-10-14 14:34:47\n020  08  1D  10    2009-10-14 14:35:09\n</code></pre>\n\n<p>Herein lies my problem:</p>\n\n<p>I need to be able to have end-users query this data to return records that will display the latest status and statusdate for each unique combination of itemid and config.  So, using the above sample I want to return a record set matching the following:</p>\n\n<pre><code>002  04  1E  12    2007-08-21 16:10:21\n004  04  1D  43    2011-01-10 13:44:50\n005  04  1B  50    2008-06-20 09:09:51\n006  05  1A  17    2007-12-18 14:04:56\n010  05  1B  40    2010-06-17 09:34:33\n012  07  1A  12    2007-11-19 15:02:48\n013  07  1B  40    2011-01-10 14:36:16\n017  08  1A  10    2009-11-12 11:12:45\n018  08  1C  35    2011-01-10 18:30:10\n020  08  1D  10    2009-10-14 14:35:09\n</code></pre>\n\n<p>In plain english:  I need to be able to return the latest status and status date for each item's configuration(s).</p>\n\n<p>Any help in this regard would be extremely appreciated.  Thank you in advance.</p>\n"},{"tags":["c#","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":106,"score":1,"question_id":12200175,"title":"How to pass convert expression in parameter using c#?","body":"<p>I had an adhoc insert statement created in c# code using string builder. </p>\n\n<pre><code>var str = new StringBuilder(string.Empty);\nstr.Append(\" INSERT INTO Table_01 ( ID,\");\n        str.Append(\"Comment,\");\n        str.Append(\"DateTimeStamp,\");\nstr.Append(\" ) VALUES( \");\n        str.Append(\"'\" + Guid.NewGuid() + \"',\");\n        str.Append(\"'\" + CaseComment + \"',\");\n        str.Append(\"CONVERT(DATETIME, '\" + DateTime.Now.Year + \"/\" + DateTime.Now.Month + \"/\" + DateTime.Now.Day + \"',120)\");\n</code></pre>\n\n<p>I have converted this code to SqlParameter:-</p>\n\n<pre><code>var str = INSERT INTO Table_01(ID,Comment,DateTimeStamp)     \nVALUES(@ID,@Comment,@DateTimeStamp)\nusing (var cmd = new SqlCommand(str, con))\n{\ncmd.Parameters.Add(new SqlParameter(\"@ID\", Guid.NewGuid()));\ncmd.Parameters.Add(new SqlParameter(\"@Comment\", CaseComment));\ncmd.Parameters.Add(new SqlParameter(\"@DateTimeStamp\", ?????));\ncmd.ExecuteNonQuery();\n}\n</code></pre>\n\n<p>Before passing DateTime, I have to make sure that format is equal to \"<strong>convert(varchar, getdate(), 120) -- 2016-10-23 06:10:55(24h)</strong>\" as in TSQL. \nHow will i pass @datetime parameter using TSQL Convert expression?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":11,"favorite_count":19,"up_vote_count":23,"down_vote_count":0,"view_count":18036,"score":23,"question_id":133081,"title":"Most efficient way in SQL Server to get date from date+time?","body":"<p>In MS SQL 2000 and 2005, given a datetime such as '2008-09-25 12:34:56' what is the most efficient way to get a datetime containing only '2008-09-25'?</p>\n\n<p>Duplicated <a href=\"http://stackoverflow.com/questions/2775/whats-the-best-way-to-remove-the-time-portion-of-a-datetime-value-sql-server\">here</a>.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":76,"score":1,"question_id":12163260,"title":"How to display data in different rows when joining two tables","body":"<p>I have 2 Temp. tables that look something like this</p>\n\n<p><code>@t1(p_ssn,p_fname,p_lname,Gender,.............)</code>  -> this table has the employee records and has about <strong>30 columns</strong></p>\n\n<p><code>@t2(p_ssn,benefit,medical_premium,dental_premium,..............)</code> -> this table  has the employee benefits and has about <strong>60 columns</strong></p>\n\n<p>Every record in <code>@t1</code> will have 1 or more corresponding records in <code>@t2</code></p>\n\n<p>How do I do a join between the tables to get a display like this (join on p_ssn)\nI want the each employee record, followed by all their benefits records- <strong>each on a different line as shown</strong></p>\n\n<pre><code>p_fname,p_lname,Gender etc...      -&gt; 1st employee\nbenefit1,medical_premium1,dental_premium_1     -&gt; all the benefit records for this employee\np_fname,p_lname,Gender etc...      -&gt; 2nd  employee\nbenefit1,medical_premium1,dental_premium_1 \n</code></pre>\n\n<p>Right now, I am using a loop. But due to the large size of the each record, it just hangs up after going halfway through.</p>\n\n<hr>\n\n<p>@Tim - This is where I am stuck. @t1 has only 30 columns, but @t2 has 60 columns</p>\n\n<p>-- Actual query </p>\n\n<pre><code>    select col1, col2 from \n(     -- Get employees     \n select 10 as ordinal, p_ssn, p_fname as col1, p_lname as col2,**there are only 30 columns here**     \n from @t1     \nunion all    \n -- Get benefits     \nselect 20 as ordinal, a.p_ssn, cast(b.benefit as varchar(50)), cast(b.premium as varchar(50)) ,**I want to display more columns here like b.col1,b.col2,b.col3 etc...60 columns**    \nfrom @t1 a         \n join @t2 b on a.p_ssn = b.p_ssn ) as a order by p_ssn, ordinal \n</code></pre>\n\n<p>I know that I can do the following</p>\n\n<pre><code>  select 10 as ordinal, p_ssn, p_fname as col1, p_lname as col2,'','',''\nfrom @t1\n union all\nselect 20 as ordinal, a.p_ssn, cast(b.benefit as varchar(50)), cast(b.premium as varchar(50)),b.col1,b.col2,n.col3\n</code></pre>\n\n<p>But this is a file feed and blanks are not allowed. In fact, I wont be able to use the cast because the lenghths and data types are defined and cannot be changed</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":94,"score":0,"question_id":12187560,"title":"SQL Server trigger - Get variable from the first Insert stored procedure?","body":"<p>I have an insert stored procedure with incremented Id (<code>int</code>). I'll like to take that <code>Id</code> and insert it to another table and also one of variable from the insert stored procedure. </p>\n\n<p>I know you can do <code>select from inserted</code> but if I'm not mistaking that allowed you to select values from the <code>inserted</code> row. </p>\n\n<p>Is there anyway to persevere the variable after executed the stored procedure and pass it to trigger?</p>\n\n<p>edit: sorry, let me included the store proc that I'm using. Table foo have a Id that is auto incremented and I want a trigger to insert the foo's Id and the @mid to another table after this store proc is run. However as you can see that @mid is not being insert to table foo.</p>\n\n<pre><code> ALTER PROCEDURE [dbo].[foo]\n    @userName varchar(50),\n    @somefoo varbinary(max),\n    @mid int\nAS\nBEGIN\n    SET NOCOUNT ON;\n    insert into fooTable(UserName,SomeFoo)values(@userName,@somefoo);\n\nEND\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":126,"score":2,"question_id":12179007,"title":"Given Letter, Get Next Letter in Alphabet","body":"<p>I have letter \"a\", \"b\", \"c\".  I would like my results to be \"b\", \"c\", \"d\" in TSQL respectively.  Would what I use to achieve this?</p>\n"},{"tags":["sql-server","query","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":81,"score":0,"question_id":12196146,"title":"SQL Server stored procedure for getting rows from table","body":"<p>I am trying to create a stored procedure to retrieve rows from my database table... but it looks like I am missing some thing while typing query.</p>\n\n<p>Here is my stored procedure:</p>\n\n<pre><code>CREATE PROCEDURE [dbo].[p_GetLeaveRecord_LMS]\n    -- Add the parameters for the stored procedure here\n    @LeaveType varchar(50),\n    @IdEmployee int,\n    @DateFrom date,\n    @DateTo date,\n    @Reason nvarchar(MAX)\nAS\nBEGIN\n    -- SET NOCOUNT ON added to prevent extra result sets from\n    -- interfering with SELECT statements.\n    SET NOCOUNT ON;\n\n    SElECT * FROM cor_leave\n    (\n    id_leave_type,\n    id_employee,\n    dt_from,\n    dt_to,\n    txt_reason\n    )\n    Values \n    (\n    @LeaveType,\n    @IdEmployee,\n    @DateFrom,\n    @DateTo,\n    @Reason\n    )      \nEND\n</code></pre>\n\n<p>If anyone can give me better answer to make procedure correct.</p>\n\n<p>I am very beginner of database.</p>\n\n<p>thanks</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12198572,"title":"SQL query to get latest prices, depending on the date","body":"<p>I am trying to retrieve a list of products which have been updated, the table contains multiple updates of the products as it records the price changes.</p>\n\n<p>I need to get the latest price changes for all products, but only return the the last update. I have the below code so far, but it only returns the very last update and only 1 product. </p>\n\n<pre><code>SELECT dbo.twProducts.title, dbo.LowestPrices.productAsin, dbo.twProducts.sku, \n       dbo.LowestPrices.tweAmzPrice, dbo.LowestPrices.price, dbo.LowestPrices.priceDate\nFROM   dbo.aboProducts INNER JOIN\n       dbo.LowestPrices ON dbo.aboProducts.asin = dbo.LowestPrices.productAsin \n       INNER JOIN dbo.twProducts ON dbo.aboProducts.sku = dbo.twProducts.sku\nWHERE  (dbo.LowestPrices.priceDate =\n        (SELECT MAX(priceDate) AS Expr1\n         FROM   dbo.LowestPrices AS LowestPrices_1))\n</code></pre>\n\n<p>I hope this makes sense, i am not sure if i have explained it in a way thats easy to understand.</p>\n\n<p>Any questions please feel free to ask.</p>\n"},{"tags":["sql","tsql","random","range","unique"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":73,"score":1,"question_id":12198729,"title":"Assign a unique number in a range randomly","body":"<p>I need to assign a list of employees a unique number from 1 to 1000 (or however many employees there are). The numbers can't repeat and need to be in a random order against the employee list. The numbers also need to be regenerated each week so the employee is assigned a new number.</p>\n\n<p>I have tried to use the following, however the script is slow and it returns the same number for all employees.</p>\n\n<pre><code>DECLARE @Random INT;\nDECLARE @Upper INT;\nDECLARE @Lower INT\n\nSET @Lower = 1 \nSET @Upper = 1000 \nSELECT @Random = ROUND(((@Upper - @Lower -1) * RAND() + @Lower), 0)\nselect personnum, firstnm, lastnm, (SELECT @Random)\nfrom person\n</code></pre>\n\n<p>Can anyone shed any light on how to do this?\nThanks </p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":4858,"score":0,"question_id":1611574,"title":"Select only integers from char column using SQL Server","body":"<p>How can I write a select statement to select only integers (and nothing more) from a char column in SQL Server. For example, my table name is POWDER with 2 columns, ID (int) and Name(char (5)) </p>\n\n<pre><code>ID     Name\n-- ----------\n1     AXF22\n2     HYWWW\n3     24680\n4     8YUH8\n5     96635\n</code></pre>\n\n<p>I want to be able to select only those rows that contain an integer and nothing more (ID 3 and ID 5 in this example)</p>\n\n<p>If I try:</p>\n\n<pre><code>SELECT * \n  FROM POWDER\n WHERE Name LIKE '[0-9]%'\n</code></pre>\n\n<p>...it will return:</p>\n\n<pre><code>ID     Name\n--    ----------\n3      24680\n4      8YUH8\n5      96635\n</code></pre>\n\n<p>Any ideas how to get the rows containing just integers?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":80,"score":1,"question_id":12196384,"title":"SQL Server query join several tables","body":"<p>I have a query that I don't think should be that hard to make, however, I've spent a lot of time on it now and still can't get it the way I want, so I hope someone here can help me.</p>\n\n<p>Basically, I need to create a report that will give a value for each month, for each area. However, not all areas deliver data each month; in that case the view should return NULL for that month and area. So, the view need to look something like this:</p>\n\n<pre><code>Month      Area    Value\n2012-08-01 Area1   2\n2012-08-01 Area2   3\n2012-09-01 Area1   3\n2012-09-01 Area2   NULL\n</code></pre>\n\n<p>My data table looks something like this</p>\n\n<pre><code>Date       Area    Value\n2012-08-01 Area1   2\n2012-08-01 Area2   3\n2012-09-01 Area1   3 -- Notice that Area2 is not present for September here\n</code></pre>\n\n<p>I have a table with all the available areas\nFurthermore, I have created a table-valued function that returns all dates from a given date until now. </p>\n\n<p>For example this statement</p>\n\n<pre><code>SELECT * FROM Periods_Months('2012-01-01')\n</code></pre>\n\n<p>would return 8 records like:</p>\n\n<pre><code>DateValue           Year    Month   YearMonth\n2012-01-01 00:00:00.000 2012    1   20121\n2012-02-01 00:00:00.000 2012    2   20122\n2012-03-01 00:00:00.000 2012    3   20123\n2012-04-01 00:00:00.000 2012    4   20124\n2012-05-01 00:00:00.000 2012    5   20125\n2012-06-01 00:00:00.000 2012    6   20126\n2012-07-01 00:00:00.000 2012    7   20127\n2012-08-01 00:00:00.000 2012    8   20128\n</code></pre>\n\n<p>Based on the suggestions, my query now looks like this:</p>\n\n<pre><code>WITH months AS (\n    SELECT DateValue, YearMonth FROM Periods_Months('2011-01-01')\n)\nselect m.DateValue\n       ,CAST(DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,m.DateValue)+1,0)) AS Date) AS DateReported -- Get last day in month\n       ,ResponseTime AS Value\n       ,g.ExternalId \nfrom GISDB.dbo.GisObjects g\nCROSS JOIN months m\nLEFT OUTER JOIN\n( -- SELECT data from data table, grouped by area and month\nSELECT dbo.YearMonth(CloseDate) AS YearMonth\n       ,MAX(CloseDate) AS LastDate\n       ,GisObjectId\n       ,SUM(DATEDIFF(HH,RegDate,CloseDate)) AS ResponseTime -- calculate response time between start and end data (the value we need)\nFROM DataTable \nWHERE   CloseDate IS NOT NULL\nAND     GisObjectId IS NOT NULL\nGROUP BY GisObjectId, dbo.YearMonth(CloseDate)  -- group by area and month\n) c\nON g.ObjectId = c.GisObjectId AND c.YearMonth = m.YearMonth \nWHERE g.CompanyId = 3 AND g.ObjectTypeId = 1 -- reduce the GIS objects that we compare to\nORDER BY m.DateValue, g.ObjectId \n</code></pre>\n\n<p>But the result is this (Value is always NULL):</p>\n\n<pre><code>DateValue                   DateReported    Value   ExternalId\n2011-01-01 00:00:00.000 31-01-2011  NULL    9994\n2011-01-01 00:00:00.000 31-01-2011  NULL    9993\n2011-01-01 00:00:00.000 31-01-2011  NULL    9992\n2011-01-01 00:00:00.000 31-01-2011  NULL    9991\n2011-01-01 00:00:00.000 31-01-2011  NULL    2339\n2011-01-01 00:00:00.000 31-01-2011  NULL    2338\n2011-01-01 00:00:00.000 31-01-2011  NULL    2337\n2011-01-01 00:00:00.000 31-01-2011  NULL    2336\n2011-01-01 00:00:00.000 31-01-2011  NULL    2335\n2011-01-01 00:00:00.000 31-01-2011  NULL    2334\n2011-01-01 00:00:00.000 31-01-2011  NULL    2327\n2011-01-01 00:00:00.000 31-01-2011  NULL    2326\n2011-01-01 00:00:00.000 31-01-2011  NULL    2325\n2011-01-01 00:00:00.000 31-01-2011  NULL    2324\n2011-01-01 00:00:00.000 31-01-2011  NULL    2323\n2011-01-01 00:00:00.000 31-01-2011  NULL    2322\n</code></pre>\n\n<p>etc.</p>\n"},{"tags":["tsql","slug"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":589,"score":1,"question_id":3082588,"title":"T-SQL function for generating slugs?","body":"<p>Quick check to see if anyone has or knows of a T-SQL function capable of generating slugs from a given nvarchar input. i.e;</p>\n\n<blockquote>\n  <p>\"Hello World\" > \"hello-world\"<br />\n  \"This is a test\" > \"this-is-a-test\"</p>\n</blockquote>\n\n<p>I have a C# function that I normally use for these purposes, but in this case I have a large amount of data to parse and turn into slugs, so it makes more sense to do it on the SQL Server rather than have to transfer data over the wire. </p>\n\n<p>As an aside, I don't have Remote Desktop access to the box so I can't run code (.net, Powershell etc) against it</p>\n\n<p>Thanks in advance. </p>\n\n<p>EDIT: \nAs per request, here's the function I generally use to generate slugs: </p>\n\n<pre><code>public static string GenerateSlug(string n, int maxLength)\n{\n    string s = n.ToLower();                \n    s = Regex.Replace(s, @\"[^a-z0-9s-]\", \"\");              \n    s = Regex.Replace(s, @\"[s-]+\", \" \").Trim();             \n    s = s.Substring(0, s.Length &lt;= maxLength ? s.Length : maxLength).Trim();             \n    s = Regex.Replace(s, @\"s\", \"-\"); \n    return s;\n}\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","parsing"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":12195504,"title":"Splitting a string then pivoting result","body":"<p>If have a string passed from a .Net application that looks like the below </p>\n\n<pre><code>2023|F66451,1684|648521,1684|600271,2137|019592\n</code></pre>\n\n<p>I have started to parse out the string using the method below but I need to Pivot the data returned from the Split ( surrounded by *'s) function in order to insert into the #tmpExceptions table</p>\n\n<pre><code>DECLARE @ExceptionsList as nvarchar(MAX)\n\nSET @ExceptionsList = '2023|F66451,1684|648521,1684|600271,2137|019592'\n\nSET NOCOUNT ON;\n\nDECLARE @CurrentLineItem as nvarchar(255)\n\nCREATE TABLE #ParsePassOne\n(\n    LineItem nvarchar(255)\n)\n\nCREATE TABLE #tmpExceptions\n(\n    AccountNumber int,\n    ClaimNumber nvarchar(50)\n)\n\nINSERT INTO #ParsePassOne\n    SELECT value FROM Split( ',' ,@ExceptionsList)\n\nWHILE EXISTS(SELECT LineItem FROM #ParsePassOne)\n    BEGIN\n        SELECT TOP 1 @CurrentLineItem = LineItem FROM #ParsePassOne\n\n        *******\n            SELECT value FROM Split( '|' ,@CurrentLineItem) \n            *******\n\n        DELETE FROM #ParsePassOne WHERE LineItem = @CurrentLineItem\n    END\n\nSELECT * FROM #tmpExceptions\n\nDROP TABLE #ParsePassOne\nDROP TABLE #tmpExceptions\n</code></pre>\n\n<p>So far the data returned looks as below. I just need to pivot the data to columns so I can insert it. How do I go about this?</p>\n\n<p><img src=\"http://i.stack.imgur.com/xAHL8.png\" alt=\"enter image description here\"></p>\n\n<p><strong>Split Function</strong></p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n--Creates an 'InLine' Table Valued Function (TVF)\nALTER FUNCTION [dbo].[Split] \n   (  @Delimiter varchar(5), \n      @List      varchar(8000)\n   ) \n   RETURNS @TableOfValues table \n      (  RowID   smallint IDENTITY(1,1), \n         [Value] varchar(50) \n      ) \nAS \n   BEGIN\n\n      DECLARE @LenString int \n\n      WHILE len( @List ) &gt; 0 \n         BEGIN \n\n            SELECT @LenString = \n               (CASE charindex( @Delimiter, @List ) \n                   WHEN 0 THEN len( @List ) \n                   ELSE ( charindex( @Delimiter, @List ) -1 )\n                END\n               ) \n\n            INSERT INTO @TableOfValues \n               SELECT substring( @List, 1, @LenString )\n\n            SELECT @List = \n               (CASE ( len( @List ) - @LenString ) \n                   WHEN 0 THEN '' \n                   ELSE right( @List, len( @List ) - @LenString - 1 ) \n                END\n               ) \n         END\n\n      RETURN \n\n   END \n</code></pre>\n"},{"tags":["sql-server","tsql","sql-server-2008"],"answer_count":7,"favorite_count":0,"up_vote_count":8,"down_vote_count":0,"view_count":2339,"score":8,"question_id":6471210,"title":"Is there anyway to reset the identity of a Table Variable?","body":"<p>Say I have a table variable:</p>\n\n<pre><code>DECLARE @MyTableVar TABLE (ID INT IDENTITY(1,1), SomeData NVARCHAR(300))\n</code></pre>\n\n<p>After I have inserted 250 rows, I need to \"Start Over\" with the table.  I do this:</p>\n\n<pre><code>DELETE FROM @MyTableVar\n</code></pre>\n\n<p>Is there anything I can do to the table variable so that this:</p>\n\n<pre><code>insert into @MyTableVar Values(\"TestData\")\nselect * from @MyTableVar\n</code></pre>\n\n<p>will return this:</p>\n\n<pre>\n_______________________________\n|    ID     |    SomeData     |\n|___________|_________________|\n|           |                 |   \n|     1     |    TestData     |        \n|___________|_________________|</pre>\n\n<p>instead of this:</p>\n\n<pre>\n_______________________________\n|    ID     |    SomeData     |\n|___________|_________________|\n|           |                 |   \n|    251    |    TestData     |        \n|___________|_________________|</pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":28,"score":0,"question_id":12193445,"title":"Get rows with IDs retrieved from other table, in the right order","body":"<p>I have two tables, <code>Posts</code> and <code>Cache</code>.</p>\n\n<p><code>Cache</code> tables saves that with Posts should I show. Posts IDs are saved in a column (<code>PostIDs</code> in <code>Cache</code> table, separated by a comma (<code>,</code>).</p>\n\n<p>And this is my code:</p>\n\n<pre><code>SELECT * FROM Posts a\nWHERE ID IN \n(\n  SELECT item FROM Cache AS b\n  CROSS APPLY dbo.fnSplit(b.postIDs, ',') \n  WHERE ((b.ownerID = 1) AND (b.magID = 8))\n)\n</code></pre>\n\n<p>Also <code>fnSplit</code> is working correctly.</p>\n\n<p>But the problem is, the order of posts is not correct.</p>\n\n<p>For example, if We have this string in <code>Cache</code> : <code>5,1,9,4,10,3</code>, I want to get posts from <code>Posts</code> with that order. (First row should be the post with ID 5, then 1, then 9, then 4, ...)</p>\n\n<p>But my code returns posts in another order: <code>1,3,4,5,9,10</code> (The order of rows in <code>Posts</code> table)</p>\n\n<p>What should I do (pure SQL) to get items in the order specified in <code>Cache</code> table? (In that example, I want to get posts in this order: <code>5,1,9,4,10,3</code>)</p>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12191105,"title":"How to sort a Union All","body":"<p>I can't get this to sort.  I want the entire result set ordered by DateId then productName and can't get it to work.</p>\n\n<pre><code>SELECT  d.DateId,\n    s.product_name1 as productName\nFROM    dbo.SaleDates d\nINNER JOIN dbo.Sale s ON s.saleId = d.saleId\n\nUNION ALL\n\nSELECT  d.DateId,\n    s.product_name2 as productName\nFROM    dbo.SaleDates d\nINNER JOIN dbo.Sale s ON s.saleId = d.saleId\n\nUNION ALL\n\nSELECT  d.DateId,\n    s.product_name3 as productName\nFROM    dbo.SaleDates d\nINNER JOIN dbo.Sale s ON s.saleId = d.saleId\norder by d.DateId, productName\n</code></pre>\n\n<p>Not sure where and how to add this order by basically.  I don't want to add an order by to each select because then I'd have subsets of orderings.  I want to order the -entire- ending result set...</p>\n"},{"tags":["tsql","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":57,"score":0,"question_id":12185209,"title":"How to purposely return a NULL from TSQL query","body":"<p>Is there a method to purposely return <code>NULL</code> from a TSQL query?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12189450,"title":"How to trim first name to a single character?","body":"<p>I have a column that has data stored in full name format, for example:</p>\n\n<blockquote>\n  <p>Tom Smith</p>\n  \n  <p>Andrew Smith</p>\n</blockquote>\n\n<p>Is there a function (or combination of functions) I can use to turn this into the following:</p>\n\n<blockquote>\n  <p>T. Smith </p>\n  \n  <p>A. Smith</p>\n</blockquote>\n"},{"tags":["tsql","sequence"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":4569,"score":2,"question_id":593755,"title":"Sequence Generators in T-SQL","body":"<p>We have an Oracle application that uses a standard pattern to populate surrogate keys. We have a series of extrinsic rows (that have specific values for the surrogate keys) and other rows that have intrinsic values.\nWe use the following Oracle trigger snippet to determine what to do with the Surrogate key on insert:</p>\n\n<pre><code>IF :NEW.SurrogateKey IS NULL THEN\n\n SELECT SurrogateKey_SEQ.NEXTVAL INTO :NEW.SurrogateKey FROM DUAL;\n\nEND IF;\n</code></pre>\n\n<p>If the supplied surrogate key is null then get a value from the nominated sequence, else pass the supplied surrogate key through to the row.</p>\n\n<p>I can't seem to find an easy way to do this is T-SQL. There are all sorts of approaches, but none of which use the notion of a sequence generator like Oracle and other SQL-92 compliant DBs do.</p>\n\n<p>Anybody know of a really efficient way to do this in SQL Server T-SQL?  By the way, we're using SQL Server 2008 if that's any help.</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12191486,"title":"Get a grand total from several counts","body":"<p>I just need the grand total which is adding each count below and this is not working for me, I get \"Incorrect syntax near the keyword 'SELECT'.\":</p>\n\n<pre><code>DECLARE @total int\n\nSET @total = Count(some select statement)\n\n@total = @total + Count(some select statement)\n@total = @total + Count(some select statement)\n@total = @total + Count(some select statement)\n.. and so on\n\n-- now return the grand total\nselect @total\n</code></pre>\n\n<p>or if you think there is even an easier or more efficient way to do this, I'm all ears too.</p>\n"},{"tags":["sql","sql-server","tsql","full-text-search"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":66,"score":1,"question_id":12180267,"title":"SQL: transform full-text search into like construction","body":"<p>I've got stored procedure that performs search using full-text indexes in general case. But I can't build full-text index for one field, and I need to use LIKE construction.</p>\n\n<p>So, the problem is: parameter could be</p>\n\n<blockquote>\n  <p>\"a*\" or \"b*\"</p>\n</blockquote>\n\n<p>like parameter for <code>CONTAINS</code> command.</p>\n\n<p>an anyone give a good solution, how to transform this parameter for <code>LIKE</code> construction.</p>\n\n<p>Thank you.</p>\n\n<p>P.S: I use <code>MSSQL Server</code></p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":66,"score":-2,"question_id":12188455,"title":"How to get the Sum from three tables?","body":"<p>I have three table first \"<code>products</code>\" second \"<code>items</code>\" third \"<code>sales</code>\" <br />\nThe first and second tables have the same columns('<code>code</code>','<code>quantity</code>') but the third table has ('<code>code</code>','<code>name</code>') now I want sum quantity from first and second but want also want get name from third table which code is equal.\ncheck my code </p>\n\n<pre><code>Select code, sum(qtd),name\nfrom (           select a.code, a.qtd from product a\n       union all select b.code, b.qtd from items   b\n       union all select c.name        from sales   c where b.code=c.code\n     )\ngroup by code\n</code></pre>\n\n<p>first two giving me perfect values but third fiction giving error not showing also names.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":56,"score":1,"question_id":12189651,"title":"another way to write this sql","body":"<p>Environment: Sql Server 2008</p>\n\n<p>have rows of a column that contains comma separated values.</p>\n\n<p>what to get the row even if a single product exists in that csv.</p>\n\n<p>this is how i can do it but was just wondering if another way to write it? </p>\n\n<pre><code>SELECT * FROM REWARDS\nWHERE ProductCsv like '%banana%' \n   or ProductCsv like '%strawberry%' \n   or ProductCsv like '%orange%'\n</code></pre>\n"},{"tags":["html","tsql","sql-server-2008-r2","sp-send-dbmail"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":158,"score":1,"question_id":12161771,"title":"sp_send_dbmail - formatting row in table as red for an alert","body":"<p>I'm using something similar to example C on this MSDN page: \n<a href=\"http://msdn.microsoft.com/en-us/library/ms190307.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms190307.aspx</a> </p>\n\n<pre><code>DECLARE @tableHTML  NVARCHAR(MAX) ;\n\nSET @tableHTML =\n    N'&lt;H1&gt;Work Order Report&lt;/H1&gt;' +\n    N'&lt;table border=\"1\"&gt;' +\n    N'&lt;tr&gt;&lt;th&gt;Work Order ID&lt;/th&gt;&lt;th&gt;Product ID&lt;/th&gt;' +\n    N'&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Order Qty&lt;/th&gt;&lt;th&gt;Due Date&lt;/th&gt;' +\n    N'&lt;th&gt;Expected Revenue&lt;/th&gt;&lt;/tr&gt;' +\n    CAST ( ( SELECT td = wo.WorkOrderID,       '',\n                    td = p.ProductID, '',\n                    td = p.Name, '',\n                    td = wo.OrderQty, '',\n                    td = wo.DueDate, '',\n                    td = (p.ListPrice - p.StandardCost) * wo.OrderQty\n              FROM AdventureWorks.Production.WorkOrder as wo\n              JOIN AdventureWorks.Production.Product AS p\n              ON wo.ProductID = p.ProductID\n              WHERE DueDate &gt; '2004-04-30'\n                AND DATEDIFF(dd, '2004-04-30', DueDate) &lt; 2 \n              ORDER BY DueDate ASC,\n                       (p.ListPrice - p.StandardCost) * wo.OrderQty DESC\n              FOR XML PATH('tr'), TYPE \n    ) AS NVARCHAR(MAX) ) +\n    N'&lt;/table&gt;' ;\n\nEXEC msdb.dbo.sp_send_dbmail @recipients='danw@Adventure-Works.com',\n    @subject = 'Work Order List',\n    @body = @tableHTML,\n    @body_format = 'HTML' ;\n</code></pre>\n\n<p>I have a column called Rating that is set to 'Good' or 'Bad' according to my own logic. \nI would like to make all lines that have a rating of 'Bad' have a red background.  I know how to do it in HTML, but not sure how to do it with the \"FOR XML\" query being demonstrated in this example.  Seems like I would have to add an attribute to some TD statements, and not others. </p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":0,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":73,"score":2,"question_id":12188811,"title":"Update statement in trigger takes longer to execute than executing it outside of trigger","body":"<p>I have a trigger for <code>After Update</code> </p>\n\n<p>This trigger works on a server which is going to update 2 tables on a linked server</p>\n\n<p>See code </p>\n\n<pre><code>ALTER TRIGGER [dbo].[tgAfterUpdate] ON  [dbo].[KS_3EToVision]\n   AFTER UPDATE\nAS \nBEGIN\n\n  BEGIN TRY\n  BEGIN TRANSACTION    -- Start the transaction\n\n  DECLARE @MatterNumber varchar(15);\n  SELECT @MatterNumber = i.MatterNumber FROM inserted i; \n\n    IF EXISTS(SELECT * FROM [FSSQLDEV01].[collnab].[dbo].[collection_header] WHERE         Ch_file_number COLLATE DATABASE_DEFAULT = @MatterNumber COLLATE DATABASE_DEFAULT)\n       --UPDATE\n        IF (SELECT Ch_matter_status FROM [FSSQLDEV01].[collnab].[dbo].[collection_header] WHERE Ch_file_number COLLATE DATABASE_DEFAULT = @MatterNumber COLLATE DATABASE_DEFAULT ) = 'Current'\n             BEGIN \n                --Parent table \n                UPDATE [FSSQLDEV01].[collnab].[dbo].[collection_header]\n                SET \n                    Ch_start_date = i.OpenDate \n                FROM \n                    Inserted i \n                WHERE ch_file_number COLLATE DATABASE_DEFAULT = @MatterNumber COLLATE DATABASE_DEFAULT  \n\n                ----Child table \n                UPDATE [FSSQLDEV01].[collnab].[dbo].[collections] \n                SET \n                    Defendant_1 = i.Description \n                    , Loan_Number_1 = i.Comments \n                    , Client = i.KS_BookName \n                    , Date_Instructed = i.OpenDate \n                    , Person_Responsible_name = i.ResponsibleFeeEarnerName \n                    , Person_Responsible_Email = i.ResponsibleFeeEarnerEmail \n                    , Person_Acting_name = i.BillingFeeEarnerName \n                    , Person_Acting_email = i.BillingFeeEarnerEmail \n                    , Agent_Acting_name = i.BillingFeeEarnerName \n                    , Agent_Acting_email = i.BillingFeeEarnerEmail \n                    , CBA_Panel_Service_Area = i.KS_ServiceCat \n                    , HBN_Number = i.KS_ClientAcctRef \n                    , St_George_Contact = i.KS_Instructor \n                FROM \n                    Inserted i \n                WHERE Left(Collections.file_number,6) COLLATE DATABASE_DEFAULT = @MatterNumber COLLATE DATABASE_DEFAULT\n             END\n\n--If we reach here, success!\n   COMMIT\nEND TRY\nBEGIN CATCH\n  -- Whoops, there was an error\n  IF @@TRANCOUNT &gt; 0\n     ROLLBACK\n\n  -- Raise an error with the details of the exception\n  DECLARE @ErrMsg nvarchar(4000), @ErrSeverity int\n  SELECT @ErrMsg = ERROR_MESSAGE(),\n     @ErrSeverity = ERROR_SEVERITY()\n\n  RAISERROR(@ErrMsg, @ErrSeverity, 1)\nEND CATCH\n\nEND \n</code></pre>\n\n<p>if i try the update statement with the same criteria outside of the trigger it will only take 1 second but inside the trigger it can take upto 45 seconds.</p>\n\n<p>I have narrowed it down to the second update statement being the problem, because if i remove  the second update statement it will execute quickly.</p>\n\n<p>I have also attached an image the shows </p>\n\n<p>I also have a Trigger for Insert and this works quickly within a second And one for Deleting which will take an extended period with in the trigger but functions fine if i remove the 2 delete statements outside of the trigger.</p>\n\n<pre><code>USE [TE_3E_TRG]\nGO\n/****** Object:  Trigger [dbo].[tgAfterDelete]    Script Date: 08/30/2012 11:24:33 ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nALTER TRIGGER [dbo].[tgAfterDelete] ON  [dbo].[KS_3EToVision]\n   AFTER DELETE\nAS \n\nbegin\n\nBEGIN TRY\n   BEGIN TRANSACTION    -- Start the transaction\n            Begin\n                --Parent table \n                DELETE FROM [FSSQLDEV01].[collnab].[dbo].[collection_header] WHERE ch_file_number COLLATE DATABASE_DEFAULT = (SELECT d.MatterNumber FROM deleted  d) COLLATE DATABASE_DEFAULT\n\n                --Child table \n                DELETE FROM [FSSQLDEV01].[collnab].[dbo].[collections] WHERE Left(file_number,6) COLLATE DATABASE_DEFAULT = (SELECT d.MatterNumber FROM deleted  d) COLLATE DATABASE_DEFAULT            \n\n            END\n   -- If we reach here, success!\n   COMMIT\nEND TRY\nBEGIN CATCH\n  -- Whoops, there was an error\n  IF @@TRANCOUNT &gt; 0\n     ROLLBACK\n\n  -- Raise an error with the details of the exception\n  DECLARE @ErrMsg nvarchar(4000), @ErrSeverity int\n  SELECT @ErrMsg = ERROR_MESSAGE(),\n         @ErrSeverity = ERROR_SEVERITY()\n\n  RAISERROR(@ErrMsg, @ErrSeverity, 1)\nEND CATCH\n</code></pre>\n\n<p>Does anyone know why this drastic difference in execution time may occur between executing the statements within the trigger and out side of the trigger?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":57,"score":2,"question_id":12185753,"title":"How to duplicate a record set spread over multiple tables in MSSQL?","body":"<p>I have a database which holds Quotations and Product Configurations, there is one header table for a Quotation under which there may be one or more Configurations. Within a configuration there are tables which define products and hardware in shades of one to one and one to many. If a customer wishes to alter any aspect of a quotation the current quotation must be frozen and another produced with a different quotation number. The quotation number is an auto ident field in the header table.</p>\n\n<p>I wrote a long winded cloning script that worked at the start but as additional columns were required the cloning script quickly got out of date. This leaves sales support with the job of having to clone the quotation by hand which can often lead to mistakes.</p>\n\n<p>How would you approach this in such a manner as to easily define the relationships, propogate the new id whilst not having to explicity specify all the columns in each table?</p>\n"},{"tags":["visual-studio-2010","tsql","reporting-services","business-intelligence"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":820,"score":0,"question_id":12186762,"title":"SSRS - T-SQL - Concatenate multiple rows","body":"<p>I have T-SQL query that joins multiple tables. I am using that in SSRS as Dataset query. I am only selecting two columns, ID and Names. I have three records with same \"ID\" values but three different \"Names\" values. In SSRS, I am getting the first \"Names\" value and I need to concatonate all three values with same ID and have it in one cell on a table.</p>\n\n<p>How would I go about doing that? </p>\n\n<p>I am using lookup to combine cube + sql\nPulling ID straight from a table but using Case statement for Names to define alias.</p>\n"},{"tags":["tsql","login","user","sql-server-2000","roles"],"answer_count":4,"favorite_count":2,"up_vote_count":11,"down_vote_count":0,"view_count":275,"score":11,"question_id":11996170,"title":"SQL Server 2000 Transfer Logins and Associated Server Roles and Access to Specific Databases","body":"<p>I work for a relatively small company less than 50 people and I'm probably the closest thing we have to a DBA...I'm actually a programmer but that's beside the point.  We have a <code>SQL Server 2000</code> with about <strong>100 different databases</strong>.  Almost all of those have an associated SQL Login and that Login is tied to a <code>DB_OWNER</code> database role for a particular database.  We also have some logins that are set to the <code>DB_DATAREADER</code> database role.</p>\n\n<p>We have purchased a brand new machine (current one 12 years old and worried about a hardware failure that may take our business down for an unacceptable amount of time).  We are NOT upgrading the SQL Server Version.  We are going to stick with 2000.</p>\n\n<p>My question is what is the easiest way to do this.  My thoughts are to detach all of the databases, copy them over to the new machine, and then reattach each of the databases.  I'm going to keep the machine name and IP's the same and just remove old server when done so no connection strings anywhere have to be modified.  That doesn't seem so bad and can easily get that done on a weekend.  My problem with this method is that after I do that I need to delete User from the database, then recreate the <code>login</code> with username/password, and then assign the appropriate role for each user.  I've only been here 5 years and I don't have all of possible usernames/passwords that each particular database and program is using.  I don't want to break any existing programs or have to go to every single machine and update this...or possibly even have to find old source code and recompile...yes some of our legacy stuff has the username/password hardcoded in the source :(. </p>\n\n<p>So I guess the main question is their a <code>script</code> that I can run on the existing server that will generate a script to run on the new machine to setup the existing <code>logins</code>, <code>users</code>, <code>roles</code> with same username/password as before?</p>\n\n<p>If there is an easier way of transfering a sql server instance from one machine to another; I'm all ears.  </p>\n\n<p>FYI we have tried creating a VHD from the existing server to use in a virtual machine but have exausted that route.  We never were able to get the machine to boot into windows.  Think that was driver issues.</p>\n"},{"tags":["c#","linq","entity-framework","tsql","ef-code-first"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":78,"score":1,"question_id":12188130,"title":"Entity Framework Code First - Get blog posts which have certain tags","body":"<p>I a missing something here but I am not sure what is that. So I need a pair of eyes. I want to get blog posts which has certain tags associated with it. My model structure looks like as below:</p>\n\n<pre><code>public partial class BlogPost : IEntity {\n\n    public BlogPost() {\n\n        this.BlogPostComments = new HashSet&lt;BlogPostComment&gt;();\n        this.BlogPostUrls = new HashSet&lt;BlogPostUrl&gt;();\n        this.TagsForBlogPosts = new HashSet&lt;TagsForBlogPost&gt;();\n    }\n\n    public System.Guid Key { get; set; }\n    public System.Guid LanguageKey { get; set; }\n    public Nullable&lt;int&gt; SecondaryKey { get; set; }\n    public string Title { get; set; }\n\n    //...\n\n    public virtual ICollection&lt;BlogPostComment&gt; BlogPostComments { get; set; }\n    public virtual Language Language { get; set; }\n    public virtual ICollection&lt;BlogPostUrl&gt; BlogPostUrls { get; set; }\n    public virtual ICollection&lt;TagsForBlogPost&gt; TagsForBlogPosts { get; set; }\n}\n\npublic partial class Tag : IEntity {\n\n    public Tag() {\n\n        this.TagsForBlogPosts = new HashSet&lt;TagsForBlogPost&gt;();\n        this.TagsForDynamicPages = new HashSet&lt;TagsForDynamicPage&gt;();\n    }\n\n    public System.Guid Key { get; set; }\n    public System.Guid LanguageKey { get; set; }\n    public string TagName { get; set; }\n\n    //...    \n\n    public virtual Language Language { get; set; }\n    public virtual ICollection&lt;TagsForBlogPost&gt; TagsForBlogPosts { get; set; }\n    public virtual ICollection&lt;TagsForDynamicPage&gt; TagsForDynamicPages { get; set; }\n}\n\npublic partial class TagsForBlogPost : IEntity {\n\n    public System.Guid Key { get; set; }\n    public System.Guid BlogPostKey { get; set; }\n    public System.Guid TagKey { get; set; }\n\n    public virtual BlogPost BlogPost { get; set; }\n    public virtual Tag Tag { get; set; }\n}\n</code></pre>\n\n<p>As input I have <code>string[]</code> tags which I need for a blog posts to have. For now, I can have the following code working:</p>\n\n<pre><code>public void Get(string[] tags) {\n\n    var posts = dbConxtext.BlogPosts.Where(x =&gt; \n        x.TagsForBlogPosts.Any(y =&gt; tags.Contains(y.Tag.TagName)));\n\n    //\n\n}\n</code></pre>\n\n<p>But it generates an IN Clause which is not what I want. Here is the T-SQL which the above code generates:</p>\n\n<pre><code>SELECT \n[Extent1].[Key] AS [Key], \n[Extent1].[LanguageKey] AS [LanguageKey], \n[Extent1].[SecondaryKey] AS [SecondaryKey], \n[Extent1].[Title] AS [Title], \n[Extent1].[BriefInfo] AS [BriefInfo], \n[Extent1].[Content] AS [Content], \n[Extent1].[ImagePath] AS [ImagePath], \n[Extent1].[IsApproved] AS [IsApproved], \n[Extent1].[CreationIp] AS [CreationIp], \n[Extent1].[CreatedOn] AS [CreatedOn], \n[Extent1].[LastUpdateIp] AS [LastUpdateIp], \n[Extent1].[LastUpdatedOn] AS [LastUpdatedOn]\nFROM [dbo].[BlogPosts] AS [Extent1]\nWHERE  EXISTS (SELECT \n    1 AS [C1]\n    FROM  [dbo].[TagsForBlogPosts] AS [Extent2]\n    INNER JOIN [dbo].[Tags] AS [Extent3] ON [Extent2].[TagKey] = [Extent3].[Key]\n    WHERE ([Extent1].[Key] = [Extent2].[BlogPostKey]) AND ([Extent3].[TagName] IN (N'nuget',N'mvc'))\n)\n</code></pre>\n\n<p>What I want is to exact match to those tags. Any idea how I can achieve that?</p>\n\n<p><strong>Edit:</strong></p>\n\n<p>What I need is as below:</p>\n\n<p>The Post A has <strong>tag1</strong>, <strong>tag2</strong> and <strong>tag3</strong>. The post B has <strong>tag1</strong>, <strong>tag3</strong>. If the string array includes <strong>tag1</strong> and <strong>tag2</strong>, only the Post A should be selected because it has both <strong>tag1</strong> and <strong>tag2</strong>.</p>\n\n<p><strong>Answer:</strong></p>\n\n<p>I managed to get it working thanks to @msarchet. Here is the LINQ query:</p>\n\n<pre><code>public void Get(string[] tags) {\n\n    var posts = dbConxtext.BlogPosts\n        .Where(x =&gt; tags.All(t =&gt; x.TagsForBlogPosts.Any(y =&gt; y.Tag.TagName == t)));\n\n    //\n\n}\n</code></pre>\n\n<p>And generated T-SQL:</p>\n\n<pre><code>SELECT \n[Extent1].[Key] AS [Key], \n[Extent1].[LanguageKey] AS [LanguageKey], \n[Extent1].[SecondaryKey] AS [SecondaryKey], \n[Extent1].[Title] AS [Title], \n[Extent1].[BriefInfo] AS [BriefInfo], \n[Extent1].[Content] AS [Content], \n[Extent1].[ImagePath] AS [ImagePath], \n[Extent1].[IsApproved] AS [IsApproved], \n[Extent1].[CreationIp] AS [CreationIp], \n[Extent1].[CreatedOn] AS [CreatedOn], \n[Extent1].[LastUpdateIp] AS [LastUpdateIp], \n[Extent1].[LastUpdatedOn] AS [LastUpdatedOn]\nFROM [dbo].[BlogPosts] AS [Extent1]\nWHERE  NOT EXISTS (SELECT \n    1 AS [C1]\n    FROM  (SELECT \n        N'nuget' AS [C1]\n        FROM  ( SELECT 1 AS X ) AS [SingleRowTable1]\n    UNION ALL\n        SELECT \n        N'razor' AS [C1]\n        FROM  ( SELECT 1 AS X ) AS [SingleRowTable2]) AS [UnionAll1]\n    WHERE ( NOT EXISTS (SELECT \n        1 AS [C1]\n        FROM  [dbo].[TagsForBlogPosts] AS [Extent2]\n        INNER JOIN [dbo].[Tags] AS [Extent3] ON [Extent2].[TagKey] = [Extent3].[Key]\n        WHERE ([Extent1].[Key] = [Extent2].[BlogPostKey]) AND ([Extent3].[TagName] = [UnionAll1].[C1])\n    )) OR (CASE WHEN ( EXISTS (SELECT \n        1 AS [C1]\n        FROM  [dbo].[TagsForBlogPosts] AS [Extent4]\n        INNER JOIN [dbo].[Tags] AS [Extent5] ON [Extent4].[TagKey] = [Extent5].[Key]\n        WHERE ([Extent1].[Key] = [Extent4].[BlogPostKey]) AND ([Extent5].[TagName] = [UnionAll1].[C1])\n    )) THEN cast(1 as bit) WHEN ( NOT EXISTS (SELECT \n        1 AS [C1]\n        FROM  [dbo].[TagsForBlogPosts] AS [Extent6]\n        INNER JOIN [dbo].[Tags] AS [Extent7] ON [Extent6].[TagKey] = [Extent7].[Key]\n        WHERE ([Extent1].[Key] = [Extent6].[BlogPostKey]) AND ([Extent7].[TagName] = [UnionAll1].[C1])\n    )) THEN cast(0 as bit) END IS NULL)\n)\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12186356,"title":"Convert Column to Row","body":"<p>I know how to do this one way but the query i have created takes about 1:30 to run and i need to optimize this to be faster due to system limitations.  Ive used multiple joins of the same table to do this but was wondering if there is a shorter query or more efficient query i could use.</p>\n\n<p>Ive given a sample of the query but it does have about 100 columns pulled from a rows on the OrderItemFormDateFields table referenced below. Ive created columns and i get the results i need, but again, its slow. Let me know if you need any more detailed info about the tables. </p>\n\n<p>I guess im basically looking for a way to dynamically populate rather than list out each column.  Ive seen a few different ways with pivots and case statements but im not very good with pivots yet and case seemed like it would be even more inefficient.  Thanks!</p>\n\n<pre><code>SELECT\nOrderNumber\n,Product\n,OrderDate\n,   oifd1.value as  'ADD_SUBJ_ADDRESS'\n,   oifd2.value as  'ADD_SUBJ_BATHS'\n,   oifd3.value as  'ADD_SUBJ_BEDROOMS'\n,   oifd4.value as  'ADD_SUBJ_DATE'\n,   oifd5.value as  'ADD_SUBJ_GLA'\nFROM(\nSELECT CAST(oi.orderid as VARCHAR(MAX))+'.'+CAST(oi.orderitemid as VARCHAR(MAX))     as      OrderNumber\n,p.abbreviation as product, o.orderdate\nFROM OrderItems oi\njoin products p on p.productid = oi.productid\njoin orders o on o.orderid = oi.orderid)x\nleft    join    orderitemformdatafields     oifd1   on      oifd1.orderreference    =   OrderNumber and oifd1.fieldname in  (     'SUBJ_STREET_ADDR')\nleft    join    orderitemformdatafields     oifd2   on      oifd2.orderreference    =   OrderNumber and oifd2.fieldname in  (      'ADD_SUBJ_BATHS')\n left   join    orderitemformdatafields     oifd3   on      oifd3.orderreference    =   OrderNumber and oifd3.fieldname in  (      'ADD_SUBJ_BEDROOMS')\n left   join    orderitemformdatafields     oifd4   on     oifd4.orderreference =   OrderNumber and oifd4.fieldname in  (     'ADD_SUBJ_DATE')\nleft    join    orderitemformdatafields     oifd5   on      oifd5.orderreference    =   OrderNumber and oifd5.fieldname in  (     'ADD_SUBJ_GLA')\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql","stored-procedures","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":48,"score":2,"question_id":12186693,"title":"How to do an inline if-then in SQL statement syntax","body":"<p>I am trying to append my email to my @email string a bad @status is passed in.  It works without the line I commented out.  I think I'm close, but the syntax is wrong.  @override_email is null.</p>\n\n<pre><code>DECLARE @retval INT\nDECLARE @email nvarchar(200)\nDECLARE @override_email nvarchar(200) = null\nDECLARE @status INT = 2\nDECLARE @in_customer_id INT = 160308\n\nSET @email = COALESCE(@override_email, (\n                      SELECT\n                        COALESCE(CustomerDetail.Email, '')\n                        /*+ (if @status NOT IN (3,4,5) ', alex@email.com')*/\n                      FROM\n                        tbl_customer_detail     CustomerDetail\n                      WHERE\n                        CustomerDetail.customer_id = @in_customer_id))                      \nselect @email\n</code></pre>\n"},{"tags":["sql","database","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":63,"score":0,"question_id":12185951,"title":"T-SQL: Build New Table from Result Set","body":"<p>First off: total SQL newbie here. I unfortunately had this thrust on me on a deadline. :/ My apologies if this is a dumb question.</p>\n\n<p>So I have a DB with a view that has various columns.  It has two columns I'm interested in: <strong>UserID</strong> and <strong>Age</strong>. </p>\n\n<ul>\n<li><strong>Age</strong> stores the age of a report in days from the day it was created.</li>\n<li><strong>UserID</strong> is the user that created the report.</li>\n</ul>\n\n<p>The view lists all reports for a user.</p>\n\n<p>We I need to do is create a new table/view from the existing view that lists each unique user, and then breaks down their total documents into various age groups.  So the columns would look something like:</p>\n\n<p>User || # rprts &lt;14 days || # rprts 14-17 days || # rprts 18-28 days || # rprts 29-44 days || # rprts 45+ days</p>\n\n<p>I know I can get the set of all the users I want with:</p>\n\n<pre><code>SELECT DISTINCT [UserID] FROM [DB].[dbo].[DB_View]\n</code></pre>\n\n<p>And I can run the following and get one row of what I want for the new table/view by hardcoding a UserID #:</p>\n\n<pre><code>SELECT DISTINCT \n\n    [UserID],\n    (SELECT COUNT(*) FROM [DB].[dbo].[DB_View] WHERE (Age &lt; 14) AND UserID = '9999') AS \"Less Than 14 Days\",\n    (SELECT COUNT(*) FROM [DB].[dbo].[DB_View] WHERE (Age BETWEEN 14 AND 17) AND UserID = '9999') AS \"14 to 17 Days\",\n    (SELECT COUNT(*) FROM [DB].[dbo].[DB_View] WHERE (Age BETWEEN 18 AND 28) AND UserID = '9999') AS \"18 to 28 Days\",\n    (SELECT COUNT(*) FROM [DB].[dbo].[DB_View] WHERE (Age BETWEEN 29 AND 44) AND UserID = '9999') AS \"29 to 44 Days\",\n    (SELECT COUNT(*) FROM [DB].[dbo].[DB_View] WHERE (Age &gt;= 45) AND UserID = '9999') AS \"Over 45 Days\"\n\nFROM [DB].[dbo].[DB_View]\nWHERE UserID = '9999'\n</code></pre>\n\n<p>The result set of users is about ~600 rows, and the view usually has about 6,000-15,000 rows.  My initial thought was just get my result set of users, then store each user to a parameter, and then pass that into the query where I've hardcoded a User ID.  Sadly, I can't even figure out the SQL to do that.  (And I'm guessing there's a much more efficient way to do this if you know your SQL....) I've seen stuff on using cursors and stuff, but I don't really understand it that well.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["sql-server-2008","tsql","excel"],"answer_count":1,"favorite_count":3,"up_vote_count":7,"down_vote_count":0,"view_count":9009,"score":7,"question_id":9086880,"title":"T-SQL: Export to new Excel file","body":"<p>I have a script that does various things and the end result is one large table. I was wondering how I could export this final table to a new Excel file (with column headers as well).</p>\n\n<p>I would need to do this within the script.</p>\n"},{"tags":["algorithm","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":111,"score":0,"question_id":12114783,"title":"T-SQL Custom Function (SQL Server 2000)","body":"<p>I have a 15 digit customer number that I need to calculate a check digit for that value.\nIn order to come up with the check digit I use Excel (formula is below).  </p>\n\n<p>This formula is based on something called the Luhn Algorithm (I think that is the correct spelling). \nThe 15 digit customer number is stored in a SQL Server 2000 database.  </p>\n\n<p>I would like to be able to get this calculation using a T-SQL function rather than Excel. Does anyone know how this can be done with T-SQL on a SQL Server 2000 database?</p>\n\n<p>Excel formula that will give me a check digit from a 15 digit number is this:</p>\n\n<pre><code>=MOD(SUMPRODUCT(-MID(TEXT(MID(A2,ROW(INDIRECT(\"1:\"&amp;LEN(A2))),1)*(MOD(ROW(INDIRECT(\"1:\"&amp;LEN(A2)))+LEN(A2)+1,2)+1),\"00\"),{1,2},1)),10)\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":60,"score":-1,"question_id":12183260,"title":"T-SQL get months from ranges of date","body":"<p>I have a Table with id and start date and end date. i want insert into another table, end of each month between the start data and end date and the ID, e.g.</p>\n\n<pre><code>ID  Start Date  End Date\n1   2012-01-01  2012-03-31\n2   2012-10-01  2012-12-31\n</code></pre>\n\n<p>Results</p>\n\n<pre><code>ID  MONTH END\n1   2012-01-31\n1   2012-02-29\n1   2012-03-31\n2   2012-10-31\n2   2012-11-30\n2   2012-12-31\n</code></pre>\n"},{"tags":["sql","tsql","count","left-join"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":889,"score":1,"question_id":4334099,"title":"SQL COUNT() / LEFT JOIN?","body":"<p>I have three tables: calls, attachments and notes and I want to display everything that's in the calls table, but also display whether a call has attachments and whether the call has notes. - by determining if there is an attachment or note record with a call_id in it. There could be notes and attachments, or there may not be but I would need to know.</p>\n\n<p>Tables structure:</p>\n\n<p>calls:</p>\n\n<pre><code>call_id  |  title  |  description  \n</code></pre>\n\n<p>attachments:</p>\n\n<pre><code>attach_id  |  attach_name  |  call_id  \n</code></pre>\n\n<p>notes:</p>\n\n<pre><code>note_id  |  note_text  |  call_id  \n</code></pre>\n\n<p>If I write:</p>\n\n<pre><code>SELECT c.call_id\n     , title\n     , description\n     , count(attach_id) \nFROM calls c \nLEFT JOIN attachments a ON c.call_id = a.call_id \nGROUP BY c.call_id\n       , title\n       , description\n</code></pre>\n\n<p>to give me a list of all calls and the number of attachments.</p>\n\n<p>How can I also add in a column with the number of notes or a column which indicates that there is notes?</p>\n\n<p>Any ideas?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","aggregate-functions"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":127,"score":3,"question_id":3553336,"title":"select in sql server 2005","body":"<p>I have a table follow:</p>\n\n<pre><code>ID  |  first  |  end\n--------------------\na   |      1  |    3\nb   |      3  |    8\nc   |      8  |   10\n</code></pre>\n\n<p>I want to select follow:</p>\n\n<pre><code> ID  |  first  |  end\n---------------------\na-c  |      1  |   10   \n</code></pre>\n\n<p>But i can't do it. Please! help me. Thanks!</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":778,"score":1,"question_id":1529225,"title":"SQL Server query to group sequential date data","body":"<p>I have got a bit of 'brain fade' going on this afternoon, so if anyone can help with this mssql query it would be fantastic.</p>\n\n<p>I have a table called 'seasons' with three columns (there are more but not relevant to the example): seasonId, date, tariffId</p>\n\n<p>SeasonId is a unique key.\nA date can only have one tariffid, but a tariffId can have many different dates.</p>\n\n<p>For example:</p>\n\n<pre><code>seasonId  |  date      |  tariffId\n----------------------------------\n       1  | 1 jan 2009 |         1\n       2  | 2 jan 2009 |         1\n       3  | 3 jan 2009 |         2\n       4  | 4 jan 2009 |         3\n       5  | 5 jan 2009 |         3\n</code></pre>\n\n<p>I'd like to have a query return the sequence/range of dates against a particular tariffId</p>\n\n<p>Eg using the data above, it would return the following:</p>\n\n<pre><code>FromDate  |  ToDate    |  TariffId\n-----------------------------------\n       1  | Jan 2009 2 | Jan 2009 1\n       3  | Jan 2009 3 | Jan 2009 2\n       4  | Jan 2009 5 | Jan 2009 3\n</code></pre>\n\n<p>Is this possible?</p>\n\n<p><strong>EDIT</strong>\nThanks for all the answers so far! I am always amazed how far you get a response!</p>\n\n<p>However, my example data probably wasn't complex enough as a tariff can have 1 or more date ranges</p>\n\n<pre><code>seasonId  |  date      |  tariffId\n----------------------------------\n       1  | 1 jan 2009 |         1\n       2  | 2 jan 2009 |         1\n       3  | 3 jan 2009 |         2\n       4  | 4 jan 2009 |         3\n       5  | 5 jan 2009 |         3\n       6  | 6 jan 2009 |         1\n       7  | 7 jan 2009 |         1\n       8  | 8 jan 2009 |         3\n</code></pre>\n\n<p>Would give:</p>\n\n<pre><code>FromDate   |     ToDate  |  TariffId\n------------------------------------\n1 Jan 2009 | 2 Jan 2009  |         1\n3 Jan 2009 | 3 Jan 2009  |         2\n4 Jan 2009 | 5 Jan 2009  |         3\n6 Jan 2009 | 7 Jan 2009  |         1\n8 Jan 2009 | 8 Jan 2009  |         3\n</code></pre>\n\n<p>Ideas?</p>\n\n<p>Thanks everyone for their help on this! This site is AWESOME!</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":220,"score":0,"question_id":4937902,"title":"How to display the time with condition","body":"<p>Using SQL Server</p>\n\n<p>Table1</p>\n\n<pre><code>ID  |  Intime  |   Outtime\n--------------------------\n001 | 00:21:00 |  00:48:00\n002 | 08:14:00 |  13:45:00\n003 | 00:34:00 |  00:18:00\n</code></pre>\n\n<p>Time format: HH:MM:SS</p>\n\n<p>Tried Code.</p>\n\n<pre><code>SELECT dateadd(mi, datediff(mi,0, Intime)/30*30, 0) AS 'Intime'\n  FROM Table1\n</code></pre>\n\n<p>Above Query giving the result for 30 minutes or 1 hours, which means minutes less than 30 then it is displaying 30 minutes, minutes greater than 30 then it is displaying 1 Hours </p>\n\n<p>I need to display the time like 15 minutes, 30 minutes or 1 Hours, it should display a roundoff time with condition</p>\n\n<p>Conditions are</p>\n\n<pre><code>If minutes is less than 15 minutes then it should display exactly 15 Minutes, for example 03:15:00\nIf minutes is greater than 15 minutes and less than 45 minutes then it should display exactly 30 Minutes, for example 03:30:00\nIf minutes is greater than 45 minutes then it should display exactly 1 hour, for example 04:00:00\n</code></pre>\n\n<p>Expected Output from the table1</p>\n\n<h2>    ID  |  Intime  |  Outtime</h2>\n\n<pre><code>001 | 00:30:00 | 01:00:00\n002 | 08:15:00 | 14:00:00\n003 | 00:30:00 | 00:30:00\n</code></pre>\n\n<p>How to make a query for the roundoff time with condition.</p>\n\n<p>Need Query Help</p>\n"},{"tags":["query","tsql","sql-server-2005","stored-procedures","foreign-keys"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":60,"score":0,"question_id":10278116,"title":"How to fetch two column value in one colume based on boolean field","body":"<p>I am working with SQL Server 2005.\nI am having 3 table </p>\n\n<p><strong>Product</strong></p>\n\n<pre><code>PId   |   PName\n</code></pre>\n\n<p><strong>Service</strong></p>\n\n<pre><code>SId   |   SName\n</code></pre>\n\n<p><strong>Bill</strong></p>\n\n<pre><code>BId   |   TypeId   |   IsService\n</code></pre>\n\n<p>TypeId is PId or SId. based on IsService Field.<br /><br />\nIf <code>IsService</code> is 1 then TypeId is SId and If <code>IsService</code> is 0 then TypeId is PId</p>\n\n<p>I want to fetch PName and SName with Bill so how can I?</p>\n\n<p>I am thinking of to Write stored Procedure for this..\nand Adding Dynamic Column to Stored Procudure that column contain Either SName or PName as per IsService.</p>\n\n<p>But don't know how to write this also? </p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":205,"score":2,"question_id":1131085,"title":"Removing duplicate records","body":"<p>I am using the following query </p>\n\n<pre><code>SELECT SS.sightseeingId AS 'sID'\n     , SS.SightseeingName\n     , SS.displayPrice AS 'Price'\n     , SST.fromDate \nFROM tblSightseeings SS INNER JOIN \n     tblSightseeingTours SST ON SS.sightseeingId =  SST.sightseeingId\nWHERE SS.isActive = 1 AND SS.isDisplayOnMainPage = 1 \n</code></pre>\n\n<p>and getting result like this </p>\n\n<pre><code>sID | SightseeingName                        | Price | fromDate \n------------------------------------------------------------------------------\n  2 | Dinner Cruise Bateaux London (Premier) |    40 | 2009-04-01 00:00:00.000\n  2 | Dinner Cruise Bateaux London (Premier) |    40 | 2009-12-29 00:00:00.000\n 30 | Jack The Ripper, Ghosts and Sinister   |  35.1 | 2009-04-01 00:00:00.000\n 30 | Jack The Ripper, Ghosts and Sinister   |  35.1 | 2009-10-01 00:00:00.000\n 40 | Grand Tour of London                   |     0 | 2009-05-01 00:00:00.000\n 40 | Grand Tour of London                   |     0 | 2010-05-01 00:00:00.000\n 87 | Warwick, Stratford, Oxford and The     |    25 | 2009-04-01 00:00:00.000\n 87 | Warwick, Stratford, Oxford and The     |    25 | 2009-11-01 00:00:00.000\n</code></pre>\n\n<p>I want to display the unique records 2 one time 30 one time 40 one time. The duplicate records are due to <code>SST.fromDate</code>. </p>\n\n<p>How do I correct my query??</p>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":12181571,"title":"Forcing the use of an index can improve performance?","body":"<p>Imagine that we have a query like this:</p>\n\n<pre><code>select a.col1, b.col2\nfrom t1 a\ninner join t2 b on a.col1 = b.col2\nwhere a.col1 = 'abc'\n</code></pre>\n\n<p>Both <code>col1</code> and <code>col2</code> don't have any index.</p>\n\n<hr>\n\n<p>If I add another restriction on the where clause, one that is always correct but with a column with an index:</p>\n\n<pre><code>select a.col1, b.col2\nfrom t1 a\ninner join t2 b on a.col1 = b.col2\nwhere a.col1 = 'abc'\nand a.id &gt;= 0  -- column always true and with index\n</code></pre>\n\n<p><strong>May the query perform faster since it may use the index on <code>id</code> column?</strong></p>\n"},{"tags":["sql","sql-server","tsql","insert"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":368,"score":0,"question_id":1481334,"title":"SQL Server Insert Query problem","body":"<p>I want to execute this query :</p>\n\n<pre><code>INSERT INTO [Order] (FactorId, ProductId, Entity) \nVALUES((SELECT Top 1 FactorId FROM Factor WHERE UserId = @UserId AND Status = -1), @ProductId, @Entity)\n</code></pre>\n\n<p>but the following error occurs :</p>\n\n<blockquote>\n  <p>Subqueries are not allowed in this\n  context. Only scalar expressions are\n  allowed.</p>\n</blockquote>\n"},{"tags":["sql-server","sql-server-2008","tsql","query-optimization"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":57,"score":1,"question_id":11911009,"title":"Optimising query","body":"<p>This view query is taking 2min to load 500 000 lines.\nI'm using EF 4.0 and thread load this view on a DataGrid.\nHow can I optimize it so it can load in shorter time ?\n<br/><strong>Update</strong> : I updated the query to this and now it takes 55 seconds but still too long !</p>\n\n<pre><code>SELECT  ROW_NUMBER() OVER ( ORDER BY ss.IDStore_CardStore DESC ) AS Id_PK ,\n        SC.IDStockCardIndex ,\n        SC.Designation ,\n        ISNULL(P.PMP, 0) PMP ,\n        ISNULL(SS.Quantity, 0) Quantity ,\n        SS.UnitePrice * SS.Quantity AS SubTotalStockCard ,\n        S.StoreName ,\n        SS.IDPurchaseInvoice\nFROM    dbo.Stores S\n        INNER JOIN dbo.StockCardsStores ss ON S.IDStore = ss.IDStore\n        RIGHT OUTER JOIN dbo.StockCard SC ON ss.IDStockCardIndex = SC.IDStockCardIndex\n        LEFT OUTER JOIN ( SELECT    SUM(UnitePrice * Quantity) / SUM(Quantity) AS PMP ,\n                                    IDStockCardIndex\n                          FROM      dbo.StockCardsStores AS SCS\n                          GROUP BY  IDStockCardIndex\n                        ) AS P ON P.IDStockCardIndex = SC.IDStockCardIndex\n</code></pre>\n"},{"tags":["sql","query","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":311,"score":0,"question_id":12179942,"title":"SQL Server: A severe error occurred on the current command. The results, if any, should be discarded","body":"<p>I get this error when trying to execute my SQL Server Stored procedure: A severe error occurred on the current command.  The results, if any, should be discarded.</p>\n\n<p>This is the part that breaks. Any ideas why? Thank you!</p>\n\n<pre><code>IF  @Supervisor = 1 \nAND @Calc = 1\n    BEGIN\n        INSERT INTO @Employees\n        SELECT [Employee_No]\n        FROM \n            dbo.fx_DetermineEmployeesBase\n            (\n                @Employee_ID\n              , NULL\n              , @Employee_ID\n              , 2\n            )\n\n    ;WITH Applications AS\n    (\n         SELECT TOP 25\n            ROW_NUMBER() OVER (ORDER BY vw.[Fullname] ASC, vw.[Submission_Date] DESC) AS [Row]\n          , ((ROW_NUMBER() OVER (ORDER BY vw.[Fullname] ASC, vw.[Submission_Date] DESC) - 1) / @Page_Size) + 1 AS [Page_Number]\n          , vw.[Employee_No]\n          , CASE \n                WHEN fx.[New_Balance] &gt; vw.[Balance] THEN vw.[Balance]\n                ELSE fx.[New_Balance]\n            END AS [Predicted_Balance]\n        FROM vw_Employee_Leave_Application vw\n            FULL OUTER JOIN @Employees e ON\n                vw.[Employee_No] = e.[Employee_No]\n            --This causes the error:\n            --A severe error occurred on the current command.  The results, if any, should be discarded.\n            CROSS APPLY dbo.fx_Employee_Leave_Type_Balance_Predict_LastRow\n                (\n                    NULL \n                  , COALESCE\n                    (\n                        CASE\n                            WHEN vw.[Start_Date] &lt;= \n                                (\n                                    SELECT TOP 1 [End_Date]\n                                    FROM vw_Employee_Leave_Planner\n                                    WHERE\n                                        [Employee_No] = vw.[Employee_No]\n                                    AND [Leave_Type_No] = vw.[Leave_Type_No]\n                                    AND \n                                    [Accepted] = 1\n                                    AND [End_Date] &gt; GETDATE()\n                                    ORDER BY [End_Date] DESC\n                                )\n                            THEN\n                                (\n                                    SELECT TOP 1 [End_Date]\n                                    FROM vw_Employee_Leave_Planner\n                                    WHERE\n                                        [Employee_No] = vw.[Employee_No]\n                                    AND [Leave_Type_No] = vw.[Leave_Type_No]\n                                    AND [Accepted] = 1\n                                    AND [End_Date] &gt; GETDATE()\n                                    ORDER BY [End_Date] DESC\n                                )\n                            ELSE vw.[Start_Date]\n                        END\n                      , GETDATE()\n                    )\n                  , vw.[Employee_No]\n                  , vw.[Leave_Type_No]\n                ) fx\n        WHERE\n            (\n                vw.[Employee_No] = e.[Employee_No]\n            AND vw.Approver_No IS NULL\n            )\n        OR  vw.[Approver_No] =  @Approver_ID\n    ),\n    PageSettings AS\n    (\n        SELECT TOP 1\n            [Row] AS [Item_Count]\n          , [Page_Number] AS [Page_Count]\n        FROM Applications\n        ORDER BY [Row] DESC\n    )\n\n    SELECT\n        [Row] AS [Row_Number]\n      , [Page_Number]\n      , @Page_Size AS [Page_Size]\n      , [Item_Count]\n      , [Page_Count]\n    FROM Applications, PageSettings\n    WHERE\n        [Page_Number] = @Page_No\n    OR  @Page_No IS NULL  \n    END\n</code></pre>\n"},{"tags":[".net","sql-server","vb.net","tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":48,"score":1,"question_id":12179135,"title":"Composite Key exceptions on dynamic TSQL","body":"<p>I have a couple of dynamically built query's with a composite primary key on the <code>tblWarr_SWH_WarrCLHD_35</code> and <code>[Account No]</code>, <code>tblWarr_SWH_WarrCLHD_35.[Claim No]</code> columns. </p>\n\n<p>A new requirement has recently come out asking us to provide exceptions on the results, so the users can ask to filter out each row by <code>[Account No]</code> and <code>[Claim No]</code>. There will be an indeterminate number of row exceptions.</p>\n\n<p>What would be the best method for the client to pass in the exceptions list <code>[Account No]</code> and <code>[Claim No]</code> combinations?</p>\n\n<p>Do I need to pass in a string and parse it within the T-SQL? I could build it like this</p>\n\n<pre><code>AND NOT ([Account No] = 'abc' AND [Claim No] = 'cde') \nAND NOT ([Account No] = 'fgh' AND [Claim No] = 'ijk')\n</code></pre>\n\n<p>The results are displayed to the client software via a typed data set with two tables.</p>\n\n<p><strong>Raw Data</strong></p>\n\n<pre><code>DECLARE @SQL nvarchar(4000)\nDECLARE @SQLWhere nvarchar(4000) \nDECLARE @SQLOrder nvarchar(MAX)\n\nSET @SQL = 'SELECT tblWarr_SWH_WarrCLHD_35.[Account No], tblWarr_SWH_WarrCLHD_35.[Claim No], tblWarr_SWH_WarrCLHD_35.ClaimCost, \n                      tblWarr_SWH_WarrCLHD_35.[Serial No], tblWarr_SMT_MCType_47.[Machine Type], tblWarr_SMH_MCHist_34.[Date Built], \n                      tblWarr_SMH_MCHist_34.[Date Sold], tblWarr_SVC_ServiceCodes.[Service Code], tblWarr_DefectCodes.Code AS [Defect Code], \n                      tblWarr_SPN_PartNo_01.[Part No], tblWarr_SPN_PartNo_01.[Part Description], tblWarr_SWH_WarrCLHD_35.[Failed Part No Qty], \n                      tblWarr_MachineHours.[Machine Hours At Failure], tblWarr_SWH_WarrCLHD_35.[Claim Date], tblWarr_SNA_WarNar_77.Narrative, \n                      tblWarr_SSU_Supplier_09.[Supplier Name],tblWarr_SWH_WarrCLHD_35.[ClaimStateID]\n                FROM tblWarr_SMH_MCHist_34 INNER JOIN\n                      tblWarr_SWH_WarrCLHD_35 ON tblWarr_SMH_MCHist_34.[Serial No] = tblWarr_SWH_WarrCLHD_35.[Serial No] INNER JOIN\n                      tblWarr_SMT_MCType_47 ON tblWarr_SMH_MCHist_34.MachineTypeID = tblWarr_SMT_MCType_47.ID INNER JOIN\n                      tblWarr_SVC_ServiceCodes ON tblWarr_SWH_WarrCLHD_35.ServiceCodeFullID = tblWarr_SVC_ServiceCodes.ID INNER JOIN\n                      tblWarr_DefectCodes ON tblWarr_SWH_WarrCLHD_35.DefectCodeID = tblWarr_DefectCodes.ID INNER JOIN\n                      tblWarr_SPN_PartNo_01 ON tblWarr_SWH_WarrCLHD_35.FailedPartNoID = tblWarr_SPN_PartNo_01.ID INNER JOIN\n                      tblWarr_MachineHours ON tblWarr_SWH_WarrCLHD_35.MachineHoursID = tblWarr_MachineHours.ID INNER JOIN\n                      tblWarr_SNA_WarNar_77 ON tblWarr_SWH_WarrCLHD_35.NarrativeID = tblWarr_SNA_WarNar_77.ID INNER JOIN\n                      tblWarr_SSU_Supplier_09 ON tblWarr_SWH_WarrCLHD_35.SupplierID = tblWarr_SSU_Supplier_09.ID'\nSET @SQLWhere = ' WHERE ((tblWarr_SPN_PartNo_01.[Part No] = @_PartNumber) AND '\nSET @SQLOrder = ' ORDER BY CAST(tblWarr_SMH_MCHist_34.[Date Built] AS smalldatetime) DESC'\n\nIF (@ClaimDateFrom IS NOT NULL AND @ClaimDateTo IS NOT NULL)AND (LEN(@ClaimDateFrom) &gt; 0 AND LEN(@ClaimDateTo) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(tblWarr_SWH_WarrCLHD_35.[Claim Date] BETWEEN @_ClaimDateFrom AND @_ClaimDateTo) AND '\n\nIF (@BuildDateFrom IS NOT NULL AND @BuildDateTo IS NOT NULL)AND (LEN(@BuildDateFrom) &gt; 0 AND LEN(@BuildDateTo) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(CAST(tblWarr_SMH_MCHist_34.[Date Built] AS SmalldateTime) BETWEEN @_BuildDateFrom AND @_BuildDateTo) AND '\n\nIF (@ClaimStates IS NOT NULL)AND (LEN(@ClaimStates) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(tblWarr_SWH_WarrCLHD_35.[ClaimStateID] IN (SELECT value FROM Split(''' + ',' + ''',@_ClaimStates))) AND '\n\nIF LEN(@SQLWhere) &gt; 0\n    SET @SQL = @SQL + LEFT(@SQLWhere, LEN(@SQLWhere)-4) + ')' + @SQLOrder\n\nEXEC sp_executesql @SQL,\n    N'@_PartNumber nvarchar(20), @_ClaimDateFrom smalldatetime, @_ClaimDateTo smalldatetime, @_BuildDateFrom smalldatetime, @_BuildDateTo smalldatetime, @_ClaimStates nvarchar(50)',\n    @_PartNumber = @PartNumber, @_ClaimDateFrom = @ClaimDateFrom, @_ClaimDateTo = @ClaimDateTo, @_BuildDateFrom = @BuildDateFrom, @_BuildDateTo = @BuildDateTo, @_ClaimStates = @ClaimStates\n</code></pre>\n\n<p><strong>Aggregate Data</strong></p>\n\n<pre><code>DECLARE @SQL nvarchar(4000)\nDECLARE @SQLWhere nvarchar(4000) \nDECLARE @SQLOrder nvarchar(MAX)\nDECLARE @Date1 as nvarchar(5)   \n\nSET @Date1 = '01/'\n\nSET @SQL = 'SELECT CAST(@_Date1 + CAST(DATEPART(mm,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(2)) + ''' + '/' + ''' + CAST(DATEPART(yyyy,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(4)) as smalldatetime) AS ClaimDate , COUNT(tblWarr_SWH_WarrCLHD_35.[Claim No]) As FaultCount\n                FROM tblWarr_SMH_MCHist_34 INNER JOIN\n                      tblWarr_SWH_WarrCLHD_35 ON tblWarr_SMH_MCHist_34.[Serial No] = tblWarr_SWH_WarrCLHD_35.[Serial No] INNER JOIN\n                      tblWarr_SMT_MCType_47 ON tblWarr_SMH_MCHist_34.MachineTypeID = tblWarr_SMT_MCType_47.ID INNER JOIN\n                      tblWarr_SVC_ServiceCodes ON tblWarr_SWH_WarrCLHD_35.ServiceCodeFullID = tblWarr_SVC_ServiceCodes.ID INNER JOIN\n                      tblWarr_DefectCodes ON tblWarr_SWH_WarrCLHD_35.DefectCodeID = tblWarr_DefectCodes.ID INNER JOIN\n                      tblWarr_SPN_PartNo_01 ON tblWarr_SWH_WarrCLHD_35.FailedPartNoID = tblWarr_SPN_PartNo_01.ID INNER JOIN\n                      tblWarr_MachineHours ON tblWarr_SWH_WarrCLHD_35.MachineHoursID = tblWarr_MachineHours.ID INNER JOIN\n                      tblWarr_SNA_WarNar_77 ON tblWarr_SWH_WarrCLHD_35.NarrativeID = tblWarr_SNA_WarNar_77.ID INNER JOIN\n                      tblWarr_SSU_Supplier_09 ON tblWarr_SWH_WarrCLHD_35.SupplierID = tblWarr_SSU_Supplier_09.ID'\nSET @SQLWhere = ' WHERE ((tblWarr_SPN_PartNo_01.[Part No] = @_PartNumber) AND '\nSET @SQLOrder = ' GROUP BY CAST(@_Date1 + CAST(DATEPART(mm,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(2)) + ''' + '/' + ''' + CAST(DATEPART(yyyy,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(4)) as smalldatetime) ORDER BY CAST(@_Date1 + CAST(DATEPART(mm,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(2)) + ''' + '/' + ''' + CAST(DATEPART(yyyy,CAST(tblWarr_SMH_MCHist_34.[Date Built] as smalldatetime)) as nvarchar(4)) as smalldatetime)'\n\nIF (@ClaimDateFrom IS NOT NULL AND @ClaimDateTo IS NOT NULL)AND (LEN(@ClaimDateFrom) &gt; 0 AND LEN(@ClaimDateTo) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(CAST(tblWarr_SWH_WarrCLHD_35.[Claim Date] AS SmalldateTime) BETWEEN @_ClaimDateFrom AND @_ClaimDateTo) AND '\n\nIF (@BuildDateFrom IS NOT NULL AND @BuildDateTo IS NOT NULL)AND (LEN(@BuildDateFrom) &gt; 0 AND LEN(@BuildDateTo) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(CAST(tblWarr_SMH_MCHist_34.[Date Built] AS SmalldateTime) BETWEEN @_BuildDateFrom AND @_BuildDateTo) AND '\n\nIF (@ClaimStates IS NOT NULL)AND (LEN(@ClaimStates) &gt; 0)\n    SET @SQLWhere = @SQLWhere + '(tblWarr_SWH_WarrCLHD_35.[ClaimStateID] IN (SELECT value FROM Split(''' + ',' + ''',@_ClaimStates))) AND '\n\nIF LEN(@SQLWhere) &gt; 0\n    SET @SQL = @SQL + LEFT(@SQLWhere, LEN(@SQLWhere)-4) + ')' + @SQLOrder\n\nEXEC sp_executesql @SQL,\n    N'@_PartNumber nvarchar(20), @_ClaimDateFrom smalldatetime, @_ClaimDateTo smalldatetime, @_BuildDateFrom smalldatetime, @_BuildDateTo smalldatetime, @_Date1 nvarchar(5), @_ClaimStates nvarchar(50) ',\n    @_PartNumber = @PartNumber, @_ClaimDateFrom = @ClaimDateFrom, @_ClaimDateTo = @ClaimDateTo, @_BuildDateFrom = @BuildDateFrom, @_BuildDateTo = @BuildDateTo, @_Date1 = @Date1, @_ClaimStates = @ClaimStates\n</code></pre>\n"},{"tags":["sql","sql-server","query","tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":7,"view_count":172,"score":-7,"question_id":12179331,"title":"SQL How to convert number (integer) to date?","body":"<p>I'm working with small commerce software and importing to SQL Server. But there are numbers:</p>\n\n<pre><code>75739\n76910\n73105\n75821\n75245\n75605\n77169\n73265\n75611\n74073\n77012\n</code></pre>\n\n<p>which represent the date I think.</p>\n\n<p>How to convert these numbers to date <code>YYYY-MM-DD</code> and <code>YYYYMMDD</code>?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":2651,"score":0,"question_id":3682956,"title":"T-SQL How to select rows without duplicate values from one column?","body":"<p>I have a table with 2 columns <code>ID, ID_PROJ_CSR</code></p>\n\n<p>The content of that table is:</p>\n\n<pre><code>ID     ID_PROJ_CSR\n------------------\n747    222   &lt;\n785    102\n786    222   &lt;\n787    223\n788    224\n</code></pre>\n\n<p>I want to select the ID, but if any value from ID_PROJ_CSR is a duplicate, I need to select any ID of the rows that contains that duplicate value (in that example, select ID <strong>747</strong> OR <strong>786</strong></p>\n\n<p>I try:</p>\n\n<pre><code>SELECT * FROM my_table tab \nWHERE tab.id_proj_csr = (SELECT TOP 1 id_proj_csr\n                         FROM my_table mt\n                         WHERE mt.id_proj_csr = tab.id_proj_csr)\n</code></pre>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":5813,"score":3,"question_id":1048209,"title":"Concatenating Column Values into a Comma-Separated List","body":"<p>What is the TSQL syntax to format my output so that the column values appear as a string, seperated by commas.</p>\n\n<p>Example, my table CARS has the following:</p>\n\n<pre><code>CarID    CarName  \n----------------\n    1    Porsche  \n    2    Mercedes  \n    3    Ferrari  \n</code></pre>\n\n<p>How do I get the car names as : <strong>'Porsche, Mercedes, Ferrari'</strong></p>\n\n<p>Thanks,\nMurali</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":41,"score":1,"question_id":12178537,"title":"SQL Server get Chinese text from a string","body":"<p>I have a column that contains the part name in both English and Chinese. </p>\n\n<p>For example \"Screw with washer-\" </p>\n\n<p>How do I extract the Chinese name from that string in SQL Server? Is it even possible?</p>\n\n<p>Thank you for your help.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12161091,"title":"SQL tool for mirroring data from live database to test?","body":"<p>Currently, we have a several environments, but mainly we have a live environment and a test environment as most do.  </p>\n\n<p>It seems our test environment we are always having issues with having good data in our test environment.  Largely because our test sql environment is maintained by a bunch of loose scripts that are not maintained very well.  Obviously, one course of action is to maintain these more efficiently, that is not going to happen we have found.</p>\n\n<p>So, I am looking for a tool that would help with this.  Has anyone found or used such a tool?</p>\n\n<p>Any advice or direction would be greatly appreciated.  This is really a thorn in our developer's sides.</p>\n\n<p>*<em>Update</em>*Our main issue is that test structures often differ from live and we need an automated solution that handles this, i.e. when a table has more columns in test than in live.  Updating question to reflect this thank you for your answer.</p>\n"},{"tags":["c#","sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":142,"score":3,"question_id":12175932,"title":"Initializing stored procedure output parameter","body":"<p>I have a simple SQL Server stored procedure:</p>\n\n<pre><code>ALTER PROCEDURE GetRowCount\n\n(\n@count int=0 OUTPUT\n)\n\nAS\nSelect * from Emp where age&gt;30;\nSET @count=@count+@@ROWCOUNT;\n\nRETURN\n</code></pre>\n\n<p>I am trying to initialize and access the output parameter in the following C# code:</p>\n\n<pre><code>SqlConnection con = new SqlConnection();\ncon.ConnectionString = \"Data Source=localhost\\\\SQLEXPRESS;Initial Catalog=answers;Integrated Security=True\";\n\nSqlCommand cmd = new SqlCommand();\ncmd.Connection = con;\n\ncmd.CommandText = \"GetRowCount\";\ncmd.Parameters.Add(new SqlParameter(\"@count\", SqlDbType.Int));\ncmd.Parameters[\"@count\"].Direction = ParameterDirection.Output;\ncon.Open();\ncmd.Parameters[\"@count\"].Value=5;\ncmd.ExecuteNonQuery();\n\nint ans = (int)(cmd.Parameters[\"@count\"].Value);\nConsole.WriteLine(ans);\n</code></pre>\n\n<p>But on running the code, an <code>InvalidCastException</code> is being thrown at the second last line of the code (I debugged and checked that nothing is being returned in the Value attribute). </p>\n\n<p>How can I properly initialize the output parameter in code? Thanks in advance!</p>\n"},{"tags":["sql","sql-server","tsql","unit-testing","tsqlunit"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":58,"score":0,"question_id":12171283,"title":"SQL Unit Testing with TSQLUNIT","body":"<p>I noticed something weird while unit testing an update/insert stored procedure using TSQLUNIT on SQL Server 2012. when I call <strong>Exec tsu_RunTests</strong>, my test procedure runs but with unexpected behaviour. the line in the code that calls my original stored procedure is executed but no actual updates or inserts made to the database table as expected. Is there a valid reason for this behaviour? Or is this a bug I need to pay much attention to? I notice that when I execute the same original stored procedure outside of the test procedure, it works fine. </p>\n"},{"tags":["sql-server-2008","tsql","tfs2010"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":12171636,"title":"Is it possible to change TSQL Script based on the DB it is being deployed to?","body":"<p>In c# projects there is the concept of Preprocessor Directives that allow you to change what code is compiled depending on whether you are building a debug or release version of the app/dll/etc.  Is there a similar option for TSQL scripts and DB projects?  Specifically, a few of the TSQL scripts I have create dynamic sql statements that do work a remote DB.  There is a different remote DB for development and production so the dynamic SQL needs to be different between the two builds.  It would be nice to not have to manually update the code every time I switch between deploying to dev and deploying to prod.</p>\n\n<p>Cheers,\nJoe</p>\n"},{"tags":["c#","sql-server","tsql","stored-procedures"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":129,"score":1,"question_id":12174399,"title":"Accessing SQL Server stored procedure output parameter in C#","body":"<p>I have a simple SQL Server stored procedure:</p>\n\n<pre><code>ALTER PROCEDURE GetRowCount\n\n(\n@count int=0 OUTPUT\n)\n\nAS\nSelect * from Emp where age&gt;30;\nSET @count=@@ROWCOUNT;\n\nRETURN\n</code></pre>\n\n<p>I am trying to access the output parameter in the following C# code:</p>\n\n<pre><code>SqlConnection con = new SqlConnection();\ncon.ConnectionString = \"Data Source=localhost\\\\SQLEXPRESS;Initial Catalog=answers;Integrated Security=True\";\n\nSqlCommand cmd = new SqlCommand();\ncmd.Connection = con;\n\ncmd.CommandText = \"GetRowCount\";\ncmd.CommandType=CommandType.StoredProcedure;\ncmd.Parameters.Add(new SqlParameter(\"@count\", SqlDbType.Int));\ncmd.Parameters[\"@count\"].Direction = ParameterDirection.Output;\ncon.Open();\nSqlDataReader reader=cmd.ExecuteReader();\nint ans = (int)cmd.Parameters[\"@count\"].Value;\nConsole.WriteLine(ans);\n</code></pre>\n\n<p>But on running the code, a NullReferenceException is being thrown at the second last line of the code. Where am I going wrong? Thanks in advance!</p>\n\n<p>P.S. I am new to SQL Procedures, so I referred <a href=\"http://support.microsoft.com/kb/306574/nl\" rel=\"nofollow\">this article</a>. </p>\n"},{"tags":["sql","sql-server","xml","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":78,"score":0,"question_id":12173091,"title":"TSQL - Query XML","body":"<p>Maybe some can help me, i have got an sql table with nRows with an XML-Column.\nThe XML structure looks like this:</p>\n\n<pre><code>&lt;DynamicResults&gt;\n  &lt;RegQuery xmlns:xsi=\"http://www.w3.o.....\" xmlns:xsd=\"http://.....\" REGServer=\"localhost\" REGHive=\"HKEY_LOCAL_MACHINE\" REGSubKey=\"SOFTWARE\\Microsoft\\Windows\\BlaBla\" /&gt;\n&lt;/DynamicResults&gt;\n</code></pre>\n\n<p>my question: how can i query into the xml, i'd like to know if an /DynamicResults/RegQuery with an specified value in the attribute 'REGSubKey' has subnodes...</p>\n\n<p>thanks a lot</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12168554,"title":"Comparing two varchar fields for likeness","body":"<p>I am attempting to write a piece of code that will compare two varchar columns where the amount of characters that match in each are weighted and assigned a value and I can use this value later on to determine if they are a \"fuzzy\" match or not. So far I have a function that strips numerics and spaces, I figure that I can use this as a starting off point.  Does anyone have any direction they can push me in or some advice?\nThanks\nBrian</p>\n"},{"tags":["sql-server-2008","tsql","pivot-table"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12169016,"title":"Simple Pivot sample","body":"<p>I need the a report of all masterid's but it may only be one on a row.. I know that's a simple thing to do but I can't figure out the syntax correctly.</p>\n\n<p>I attached the data how its stored in SQL server and the output how I want it to be.</p>\n\n<p>Data:</p>\n\n<p><img src=\"http://i.stack.imgur.com/geyV4.png\" alt=\"Data\"></p>\n\n<p>Required Output:</p>\n\n<p><img src=\"http://i.stack.imgur.com/E9Gjz.png\" alt=\"Required Output\"></p>\n\n<pre><code>CREATE TABLE [dbo].[Services]\n    ([ServiceID] [int] IDENTITY(1,1) NOT NULL,\n    [MasterID] [nvarchar](10) NOT NULL,\n    [Type] [nvarchar](50) NOT NULL,\n    [Status] [nvarchar](50) NOT NULL)\n\nInsert Into Services (MasterID, Type , Status) values (123, 'Basic Phone', 'Open')\nInsert Into Services (MasterID, Type , Status) values (123, 'BlackBerry', 'Open')\nInsert Into Services (MasterID, Type , Status) values (123, 'Pixi', 'Closed')\n</code></pre>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":40,"score":0,"question_id":12169279,"title":"Is it possible to refactor this statement to remove the subquery?","body":"<p>I'm trying to take data from one column, <code>MyTable.SSN</code>, and copy it to another in the same table, <code>MyTable.SSNWithDashes</code>, just formatted differently.  If <code>MyTable.SSN</code> doesn't have exactly 9 digits, I don't care to process it at all.</p>\n\n<p>I've tried this:</p>\n\n<pre><code>IF( SELECT LEN( [SSN] ) FROM [MyTable] ) = 9\nUPDATE [MyTable] SET [SSNWithDashes] = LEFT( [SSN], 3 ) + '-' + SUBSTRING( [SSN], 4, 2 ) + '-' + RIGHT( [SSN], 4 ) \nELSE\nUPDATE [MyTable] SET [SSNWithDashes] = NULL\n</code></pre>\n\n<p>While this works, it throws an error:</p>\n\n<p><code>Subquery returned more than 1 value. This is not permitted when the subquery follows =, !=, &lt;, &lt;= , &gt;, &gt;= or when the subquery is used as an expression.</code></p>\n\n<p>While I do understand what the warning is saying, I'm not really sure how to go about this differently.</p>\n\n<p>How can I refactor this to remove that warning (and perhaps read a little cleaner)?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":70,"score":1,"question_id":12169032,"title":"Union, Join, Or GroupBy","body":"<p>I have procedures pulling data from various sources to give me 3 VERY similar tables.</p>\n\n<pre><code>Metric          | Tickets   |Band\n______________________________________\nAcknowledgement | 45        | New\nAcknowledgement | 23        | Within\nAcknowledgement | 16        | Near\nAcknowledgement | 2         | Very Near\n</code></pre>\n\n<p>And</p>\n\n<pre><code>Metric     | Tickets   |Band\n___________________________________\nEscalation | 10        | New\nEscalation | 43        | Within\nEscalation | 81        | Near\nEscalation | 6         | Very Near\n</code></pre>\n\n<p>And</p>\n\n<pre><code>Metric| Tickets   |Band\n___________________________________\nFixed | 34        | New\nFixed | 52        | Within\nFixed | 36        | Near\nFixed | 4         | Very Near\n</code></pre>\n\n<p>Now, I would like to combine them together in some way to have one table output like this</p>\n\n<pre><code>Metric          | New   | Within | Near | Very Near\n_____________________________________________________\nAcknowledgement | 45    | 23     | 16   | 2\nEscalation      | 10    | 43     | 81   | 6\nFixed           | 34    | 52     | 36   | 4\n</code></pre>\n\n<p>How can I achieve this in MS SQLServer, please ?</p>\n"},{"tags":["sql-server","tsql","scalability","sql-azure","horizontal-scaling"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":32,"score":0,"question_id":12165897,"title":"Architecture requirements to scale SQL Azure Tables/Schemas","body":"<p>I am setting up a schema/some tables in SQL Azure and wanted to know if there were any things i need to do architecturally in order to promote scalability, especially horizontal scalability. Should IDs be of a certain type? Primary keys be of a certain type?</p>\n\n<p>I am looking to avoid risk/issues down the road... let me know.</p>\n\n<p>Thanks,</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12145239,"title":"getting a combination of column values in TSQL","body":"<p>I have a database structure like this</p>\n\n<pre><code>rowid   deltaValue  Applicable\n1        r            n/d\n1        w            n/d\n1        m            n/d\n2        r            n/d\n2        w            n/d\n2        m            n/d\n3        r            n/d\n3        w            n/r\n3        m            n/d\n</code></pre>\n\n<p>so basically I want to only select the last group of 'rowid', ie <code>rowid=3</code>. This is because it is the only group that has a combination of <code>n/d, n/r</code></p>\n\n<p>is there a tsql query that will just look at the combination and pull the group (ie, the rowid). \nHere is what I have so far:</p>\n\n<pre><code>select  *\nfrom table\nwhere 1=1\nand deltaValue in ('r','w','m')\nand ((   1=(case when [DeltaValue] = 'r' and [Applicable]='n/r' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'w' and [Applicable]='n/d' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'm' and [Applicable]='n/d' then 1 else 0 end)\n     ) OR\n     (   1=(case when [DeltaValue] = 'r' and [Applicable]='n/d' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'w' and [Applicable]='n/r' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'm' and [Applicable]='n/d' then 1 else 0 end)\n     ) OR\n     (   1=(case when [DeltaValue] = 'r' and [Applicable]='n/d' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'w' and [Applicable]='n/d' then 1 else 0 end)\n     and 1=(case when [DeltaValue] = 'm' and [Applicable]='n/r' then 1 else 0 end)\n     )\n    )\n</code></pre>\n\n<p>Output:</p>\n\n<pre><code>3        r            n/d\n3        w            n/r\n3        m            n/d\n</code></pre>\n"},{"tags":["javascript","tsql","minify"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12159778,"title":"using TSQL to \"minify\" javascript code?","body":"<p>This may seem like an unusual request, but does anyone have T-SQL (MSSQL2008) code to \"minify\" javascript code?</p>\n\n<p>I have a MVC site that uses a series of stored procs to generate the contents of a *.js file, and preferably after the SPs built the javascript, it could use a UDF/SP to 'minify' it. \nI thought about creating a second SP set that would contain the minified version, but that would be a maintainance nightmare (doubling the current 10 SP's that build the javascript code).</p>\n\n<p>I didn't know if the logic used to minify was simple enough that an SP/UDF could do it, and if lucky someone had already written it and was willing to share :)</p>\n\n<p>Thanks in advance!</p>\n"},{"tags":["sql","tsql","postgresql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":75,"score":0,"question_id":12164336,"title":"SQL group by not equal results","body":"<p>I am using postgres but I know T-SQL too so any answer anyone can give me ill be grateful and able to make the conversion. I am trying to run a query for my company that's a car sales company. they sell cars all over the US primarily in OR and WA. I need to come up with a report that will allow me to return sales that are new for OR and new for Wa and then the problem I'm having is the sales for all the other states that are not OR or Wa. So right now im running a union with group by where one query is for WA and the other statement is for OR. I want the results to look really simple and just have 3 rows. 1 OR 1 WA and the 3rd row all the other states combined. I cant figure out how to combine the not equal to OR or WA into one single value. Is this even possible?</p>\n\n<p>Thank you for taking the time to look at this</p>\n\n<p>my query will also include used sale cars but I can integrate that once I figure out how to get this problem figured out so that's why the query has multiple unions</p>\n\n<p>Here's my query I have now:</p>\n\n<pre><code>SELECT buyerstate        AS \"State\", \n       Count(buyerstate) AS \"Acura\", \n       saletype          AS \"N/U\" \nFROM   lydeal \nWHERE  stocklocationid = '8' \n       AND buyerstate = 'OR' \n       AND saledate &gt; '8/01/12' \n       AND saletype = 'N' \nGROUP  BY buyerstate, \n          stocklocationid, \n          saletype \nUNION \nSELECT buyerstate        AS \"State\", \n       Count(buyerstate) AS \"Acura\", \n       saletype          AS \"N/U\" \nFROM   lydeal \nWHERE  stocklocationid = '8' \n       AND buyerstate = 'OR' \n       AND saledate &gt; '8/01/12' \n       AND saletype = 'U' \nGROUP  BY buyerstate, \n          stocklocationid, \n          saletype \nUNION \nSELECT buyerstate        AS \"State\", \n       Count(buyerstate) AS \"Acura\", \n       saletype          AS \"N/U\" \nFROM   lydeal \nWHERE  stocklocationid = '8' \n       AND buyerstate = 'WA' \n       AND saledate &gt; '8/01/12' \n       AND saletype = 'N' \nGROUP  BY buyerstate, \n          stocklocationid, \n          saletype \nUNION \nSELECT buyerstate        AS \"State\", \n       Count(buyerstate) AS \"Acura\", \n       saletype          AS \"N/U\" \nFROM   lydeal \nWHERE  stocklocationid = '8' \n       AND buyerstate = 'WA' \n       AND saledate &gt; '8/01/12' \n       AND saletype = 'U' \nGROUP  BY buyerstate, \n          stocklocationid, \n          saletype \n</code></pre>\n"},{"tags":["tsql","stored-procedures","temptables"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":85,"score":0,"question_id":12163902,"title":"TSQL - Passing fields from table into stored procedure then storing result in temp table","body":"<p>I'm working with a client who has a stored procedure with about a dozen parameters.</p>\n\n<p>I need to get the parameter values from tables in the database, then feed these into the stored procedure to get a number value.  I then need to join this value to a SELECT statement.</p>\n\n<p>I know that I have to build a temp table in order to join the SP results with my select statement, but this is all new to me and could use some help.  Mostly focusing on how to feed field values into the SP. I would also like the Temp table to contain a couple of the parameters as fields so I can join it to my select statement.</p>\n\n<p>any and all help is appreciated.</p>\n\n<p>Thank You</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":7,"view_count":178,"score":-7,"question_id":12163433,"title":"Inserting a multiple records in a table with while loop ","body":"<p>I want to insert couple of hundred rows into a table that points to pk in other table. I have been trying to use while loops for inserting multiple records in the table. I am actually setting up my test data.</p>\n\n<p>This is what I am doing :</p>\n\n<pre><code>declare @count int;\nset @count = 4018;\n\nwhile @count &lt;= 5040 \nbegin\n    INSERT INTO [MY_TABLE]\n               ([pk_from_other_table]\n               ,[..]\n               ,[...]\n               ,[..]\n               ,[..]\n               ,[...]\n               ,[...]\n               ,[..])\n        select\n               (pk_from_other_table,\n               ,[..]\n               ,[...]\n               ,[..]\n               ,[..]\n               ,[...]\n               ,[...]\n               ,[..])\n    @count = @count + 1;\nend\n</code></pre>\n\n<p>but this does not seems to work ! can anyone help please... all I want to do is insert number of records = number of records that exist in primary table.</p>\n\n<p>? any idea on how can I achieve this ?</p>\n\n<p>I either get incorrect sytax near count </p>\n\n<p>or </p>\n\n<p>Msg 102, Level 15, State 1, Line 17\nIncorrect syntax near ','.</p>\n"},{"tags":["sql-server","xml","tsql","xquery"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":86,"score":1,"question_id":12161164,"title":"Retrieve a value from XML using T-SQL","body":"<p>Can anyone please help me to retrieve a value <code>&lt;QuoteId&gt;</code> from the attached XML file using T-SQL and XQuery?</p>\n\n<p>I am trying to use this T-SQL but no luck</p>\n\n<pre><code>declare @QuoteResponse XML\nselect @QuoteResponse =gQuoteResponse FROM AutoRenew where policyid= '454544'\n\nSELECT b.value('(OverallResultStatus)[1]', 'varchar(100)')  as status\nFROM\n@QuoteResponse.nodes('GetQuoteResponse/OperationResult') as a(b) \n</code></pre>\n\n<p>This is I am using to retrieve the <code>QuoteId</code></p>\n\n<pre><code>DECLARE @QuoteResponse XML\n\nSELECT @QuoteResponse = gQuoteResponse FROM [dbo].[AutoRenew] WHERE policyid = '454544'\n\nSELECT\n    @QuoteResponse.value('(GetQuoteResponse/QuoteResults/QuoteResult/QuoteId)[1]', 'bigint')\n</code></pre>\n\n<p>Thanks</p>\n\n<pre><code>&lt;GetQuoteResponse xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"&gt;\n  &lt;OperationResult&gt;\n    &lt;OverallResultStatus&gt;xxxx&lt;/OverallResultStatus&gt;\n    &lt;Results&gt;\n      &lt;Result&gt;\n        &lt;ResultStatus&gt;xxxx&lt;/ResultStatus&gt;\n        &lt;ResultCode&gt;ddf&lt;/ResultCode&gt;\n        &lt;ResultMessage&gt;xxxxx&lt;/ResultMessage&gt;\n      &lt;/Result&gt;\n    &lt;/Results&gt;\n  &lt;/OperationResult&gt;\n  &lt;QuoteResults&gt;\n    &lt;QuoteResult&gt;\n      &lt;OperationResult&gt;\n        &lt;OverallResultStatus&gt;xxx&lt;/OverallResultStatus&gt;\n        &lt;Results&gt;\n          &lt;Result&gt;\n            &lt;ResultStatus&gt;xx&lt;/ResultStatus&gt;\n            &lt;ResultCode&gt;xxxx&lt;/ResultCode&gt;\n            &lt;ResultMessage&gt;xx&lt;/ResultMessage&gt;\n          &lt;/Result&gt;\n        &lt;/Results&gt;\n      &lt;/OperationResult&gt;\n      &lt;MainData&gt;\n        &lt;StartDate&gt;2012-08-14T00:00:00&lt;/StartDate&gt;\n        &lt;ReturnDate&gt;2013-08-13T00:00:00&lt;/ReturnDate&gt;\n        &lt;TripType&gt;xxx&lt;/TripType&gt;\n        &lt;Area&gt;xxx&lt;/Area&gt;\n        &lt;Relationship&gt;Individual&lt;/Relationship&gt;\n        &lt;Product&gt;\n          &lt;ProductId&gt;xxx&lt;/ProductId&gt;\n          &lt;Name&gt;xxxx&lt;/Name&gt;\n        &lt;/Product&gt;\n        &lt;Endorsements&gt;\n          &lt;Endorsement&gt;\n            &lt;EndorsementCode&gt;xx&lt;/EndorsementCode&gt;\n            &lt;Selected&gt;xx&lt;/Selected&gt;\n            &lt;Name&gt;xxx&lt;/Name&gt;\n          &lt;/Endorsement&gt;\n          &lt;Endorsement&gt;\n            &lt;EndorsementCode&gt;xxx&lt;/EndorsementCode&gt;\n            &lt;Selected&gt;xxx&lt;/Selected&gt;\n            &lt;Name&gt;xxxx&lt;/Name&gt;\n          &lt;/Endorsement&gt;\n        &lt;/Endorsements&gt;\n        &lt;Promotion&gt;\n          &lt;PromotionCode /&gt;\n        &lt;/Promotion&gt;\n        &lt;Travellers&gt;\n          &lt;Traveller requestedMedicalScreening=\"false\"&gt;\n            &lt;TravellerId&gt;xxxx&lt;/TravellerId&gt;\n            &lt;Title&gt;xxx&lt;/Title&gt;\n            &lt;FirstName&gt;xxx &lt;/FirstName&gt;\n            &lt;LastName&gt;xxxx&lt;/LastName&gt;\n            &lt;Age&gt;xxx&lt;/Age&gt;\n          &lt;/Traveller&gt;\n        &lt;/Travellers&gt;\n      &lt;/MainData&gt;\n      &lt;Price&gt;\n        &lt;NetToParentAgent&gt;xxx&lt;/NetToParentAgent&gt;\n        &lt;NetPrice&gt;xxx&lt;/NetPrice&gt;\n        &lt;Tax&gt;edew&lt;/Tax&gt;\n        &lt;GrossPriceWithAllSurchargesAndMedicalScreenings&gt;103.02&lt;/GrossPriceWithAllSurchargesAndMedicalScreenings&gt;\n      &lt;/Price&gt;\n      &lt;QuoteId&gt;322423234&lt;/QuoteId&gt;\n      &lt;QuoteExpiryDate&gt;xxx&lt;/QuoteExpiryDate&gt;\n      &lt;SummaryOfCover /&gt;\n    &lt;/QuoteResult&gt;\n  &lt;/QuoteResults&gt;\n&lt;/GetQuoteResponse&gt;\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","insert"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":313,"score":0,"question_id":1471995,"title":"SQL: What is INSERT INTO #table?","body":"<p>I wanted to know what does the # symbol mean? Why is it being used?</p>\n\n<p>Example:</p>\n\n<pre><code>INSERT INTO #tmpContracts (sym, contractCount)\nSELECT sym, \n       COUNT(DISTINCT(fulloptionsym)) AS contractCount\n</code></pre>\n"},{"tags":["query","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12162973,"title":"T-SQL Query / Count Rows by Partial Date Grouping","body":"<p>I have a table (in SQL Server 2008 R2, in case that matters), defined with the following rows. The <code>DateAdded</code> column is a <code>SmallDateTime</code> data type.</p>\n\n<pre><code> ID    DateAdded\n  1    2012-08-01 12:34:02\n  2    2012-08-01 12:48:25\n  3    2012-08-05 08:50:22\n  4    2012-08-05 11:32:01\n  5    2012-08-26 09:22:15 \n  6    2012-08-26 13:42:02\n  7    2012-08-27 08:22:12\n</code></pre>\n\n<p>What I need to do is count the rows that occur on the same YYYY/MM/DD value.  So the results I need to obtain would look like this...</p>\n\n<pre><code>DateAdded   QTY\n2012-08-01  2  \n2012-08-05  2  \n2012-08-26  2  \n2012-08-27  1\n</code></pre>\n\n<p>I can't figure out the syntax/expression to get this to work. Can someone point me in the right direction?  Thank you!</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":82,"score":2,"question_id":9562665,"title":"Which one is more effective to do","body":"<p><br/></p>\n\n<p>\nI have a table with large amount of data and want to take too much inquiry for checking the existence of a specific row. If that row exist then increase value of inquiry_count column. \nWe have tow different approach to do this please tell me which one is better.\n</p>\n\n<p>\n<b>first :</b>\nwe can select that row and check it with \"Exists\" function, If that row exists then Execute update command to increase inquiry_count column.\n</p>\n\n<p>\n<b>Second:</b>\nwe can only execute update command. if the number of affected rows are more than 0 then that row exists.\n</p>\n"},{"tags":["tsql","count"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":29,"score":1,"question_id":12161471,"title":"Count valid values per user","body":"<p>I have a table with a list of values. -1 is a blank value:</p>\n\n<pre><code> ID    FieldType1A FieldType1B FieldType2A FieldType2B Person\n  1             15          14          10          -1      1\n  2             16          -1          12          10      1\n  3             17          -1           5           6      1\n  4              6          -1           7          -1      2\n ...\n</code></pre>\n\n<p>So the result should be:</p>\n\n<pre><code> Person      FieldType1     FieldType2\n      1               4              5\n      2               1              1\n</code></pre>\n\n<p>there is a users table with a list of user IDs, would there be a way of iterating over that list of values to generate the person list in the result set (0 for the field types being perfectly valid as it is merely counts)? I think the answer to <a href=\"http://stackoverflow.com/questions/9085756/t-sql-column-values-count\">T-SQL Column Values Count</a> is a step in the direction I'm attempting to go, but unsure how to combine columns that are the same (the A/Bs allow for a list of answers). That and I'm interested in combining all valid values as not attempting to count the number of each valid response.</p>\n"},{"tags":["sql-server","tsql","case","isnull","case-when"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":57,"score":0,"question_id":12161362,"title":"How to ignore a TSQL Where condition when the value of a filter is null in one statement?","body":"<p>How to ignore a where condition when the value of a filter is null in one statement?</p>\n\n<pre><code>-- if @filter1LowerBound is null then\nselect * from MyTable\n\n-- if @filter1LowerBound is not null then\nselect * from MyTable\nwhere column1 &gt; @filter1LowerBound\n</code></pre>\n\n<p>Would that be possible to write one single where condition to handle the above situations?</p>\n\n<p>I know I can <code>CASE WHEN</code> statement when my column is using \"=\".</p>\n\n<p>or like:</p>\n\n<pre><code>select * from MyTable\nwhere column1 = ISNULL(@filter1LowerBound, column1) \n</code></pre>\n\n<p>But I am having greater than and less than operators.</p>\n\n<p>I have more greater than and less than filters like that so I'd need to make it work.</p>\n\n<p>How would that be achieved?</p>\n\n<p>Thanks</p>\n"},{"tags":["c#","asp.net","linq","tsql","dynamic-linq"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":147,"score":0,"question_id":12160701,"title":"Scott Gu Dynamic Linq Convert Datetime to ShortDatetime","body":"<p>I am using the Scott Gu Dynamic <code>Linq</code> class and I am trying to convert a datetime to return a short datetime before databinding the result set to a gridview in <code>ASP.net</code>.  Now, I know that I can go through the gridview row databound event and check each cell to see if it is a date, and if it is, convert the date to the shortdate, however that is very cumbersome and I do not feel it is very efficient.</p>\n\n<p>I am building my select statement in DynamicLinq as follows:</p>\n\n<p>Filter gets its information as follows:</p>\n\n<pre><code> foreach (KeyValuePair&lt;string,string&gt; kvp in dictFilters)\n        {\n            filter += kvp.Key + \" as \" + kvp.Value.Replace(\"-\", \"_\").Replace(\" \", \"_\") + \",\";\n        }\n\n\n        var result = db.ViewADHOCContractInfos.Select(\"new(\" + filter + \")\");\n</code></pre>\n\n<p>which gives me the result set of:</p>\n\n<pre><code>    {SELECT [t0].[dtmAward] AS [Award_Date], [t0].[guidFromId],  [t0].[strFundingNumber] AS [Funding_Number], [t0].[dtmCertified] AS [Certified_Date], [t0].[strFundingNumberStatus] AS [Funding_Status]\nFROM [dbo].[ViewADHOCInfo] AS [t0]\n}\n</code></pre>\n\n<p>Now what I want is this:</p>\n\n<pre><code>   {SELECT Convert(VarChar, [t0].[dtmAward], 101) AS [Award_Date], [t0].[guidFromId],  [t0].[strFundingNumber] AS [Funding_Number], [t0].[dtmCertified] AS [Certified_Date], [t0].[strFundingNumberStatus] AS [Funding_Status]\nFROM [dbo].[ViewADHOCInfo] AS [t0]\n}\n</code></pre>\n\n<p>Is it possible to add a SQL convert to by select statement using Dynamic Linq?</p>\n"},{"tags":["sql","sql-server-2005","tsql","min"],"answer_count":10,"favorite_count":2,"up_vote_count":10,"down_vote_count":1,"view_count":22853,"score":9,"question_id":368351,"title":"What's the best way to select the minimum value from multiple columns?","body":"<p>Given the following table in SQL Server 2005:</p>\n\n<pre><code>ID   Col1   Col2   Col3\n--   ----   ----   ----\n1       3     34     76  \n2      32    976     24\n3       7    235      3\n4     245      1    792\n</code></pre>\n\n<p>What is the best way to write the query that yields the following result (i.e. one that yields the final column - a column containing the minium values out of Col1, Col2, and Col 3 <strong>for each row</strong>)?</p>\n\n<pre><code>ID   Col1   Col2   Col3  TheMin\n--   ----   ----   ----  ------\n1       3     34     76       3\n2      32    976     24      24\n3       7    235      3       3\n4     245      1    792       1\n</code></pre>\n\n<p><strong><em>UPDATE:</em></strong></p>\n\n<p>For clarification (as I have said in the coments) in the real scenario the database is <strong>properly normalized</strong>. These \"array\" columns are not in an actual table but are in a result set that is required in a report. And the new requirement is that the report also needs this MinValue column. I can't change the underlying result set and therefore I was looking to T-SQL for a handy \"get out of jail card\".</p>\n\n<p>I tried the CASE approach mentioned below and it works, although it is a bit cumbersome. It is also more complicated than stated in the answers because you need to cater for the fact that there are two min values in the same row.</p>\n\n<p>Anyway, I thought I'd post my current solution which, given my constraints, works pretty well. It uses the UNPIVOT operator:</p>\n\n<pre><code>with cte (ID, Col1, Col2, Col3)\nas\n(\n    select ID, Col1, Col2, Col3\n    from TestTable\n)\nselect cte.ID, Col1, Col2, Col3, TheMin from cte\njoin\n(\n    select\n    \tID, min(Amount) as TheMin\n    from \n    \tcte \n    \tUNPIVOT (Amount for AmountCol in (Col1, Col2, Col3)) as unpvt\n    group by ID\n) as minValues\non cte.ID = minValues.ID\n</code></pre>\n\n<p>I'll say upfront that I don't expect this to offer the best performance, but given the circumstances (I can't redesign all the queries just for the new MinValue column requirement), it is a pretty elegant \"get out of jail card\".</p>\n"},{"tags":["sql","sql-server","tsql","max"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":3052,"score":2,"question_id":611011,"title":"SQL MAX of column including its primary key","body":"<h3>Short:</h3>\n\n<p>From below sql select I get the cart_id and the value of the maximum valued item in that cart.</p>\n\n<pre>select CartItems.cart_id, max(ItemValues.value)\nfrom CartItems inner join ItemValues on CartItems.item_id=ItemValues.item_id\ngroup by CartItems.cart_id\n</pre>\n\n<p>but I also need item_id for that item (ItemValues.item-id).<br><br></p>\n\n<h3>Long:</h3>\n\n<p>Two tables, CartItems, ItemValues (and their respective Carts, Items, irrelevant here).<br>\nEach cart can have several items wheras each item has one value defined in ItemValues.<br>\nEach item belongs to one cart.<br>\nThe value of a cart is the value of the item with maximum value within its cart.<br>\nHow do I select cart-id, max(item-value) and it's corresponding item-id?<br><br>\nFor instance cart-id A contains item-id X with value 10 and item-id Y with value 90.<br>\nWith above sql select I get, <pre>A, 90</pre>\nWhat I need is</p>\n\n<pre>\nA, Y, 90\n</pre>\n\n<p><br>\nplatform: MS SQL</p>\n"},{"tags":["linq","entity-framework","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":55,"score":1,"question_id":12137587,"title":"How can I avoid Entity Framework issuing repeated queries?","body":"<p>SQL profiler shows EF issuing the same query up to 8 times from the following LINQ query:</p>\n\n<pre><code>var query = (from wtv in _context.WorkTypeVersions\n               join rc in _context.RateCategories on wtv.WTVID equals rc.WTVID\n               join rsc in _context.RateSubCategories on rc.RCID equals rsc.RCID\n               where (wtv.Composite == (ckCompositePreambles.Checked ? \"Y\" : \"N\")\n                      &amp;&amp; rc.CatCode == catCode)\n\n               select new pRateSubCategory()\n                {\n                  WTVID = wtv.WTVID,\n                  RSCID = rsc.RSCID,\n                  WTVersionName = wtv.WTVersionName,\n                  SubCatCode = rsc.SubCatCode,\n                  PCode = rsc.Preamble.SectionCode,\n                  RateCategoryName = rc.RateCategoryName,\n                  RateSubCategoryName = rsc.RateSubCategoryName,\n                  FullSubCatName = rsc.FullSubCatName,\n                  PMBID = rsc.PMBID,\n                  Preamble = rsc.Preamble\n                });\n\n  dgvRateSubCategories.AutoGenerateColumns = false;\n  lblSubSectionCount.Text = \"SubSections: \" + bsRateSubCategories.Count;\n  dgvRateSubCategories.DataSource = bsRateSubCategories;\n\n  bsRateSubCategories.DataSource = query;\n</code></pre>\n\n<p>The TSQL query (produced up to 8 times, although others are interspersed) is this:</p>\n\n<pre><code>    exec sp_executesql N'SELECT \n    [Project1].[WTVID] AS [WTVID], \n    [Project1].[RSCID] AS [RSCID], \n    [Project1].[WTVersionName] AS [WTVersionName], \n    [Project1].[SubCatCode] AS [SubCatCode], \n    [Project1].[SectionCode] AS [SectionCode], \n    [Project1].[RateCategoryName] AS [RateCategoryName], \n    [Project1].[RateSubCategoryName] AS [RateSubCategoryName], \n    [Project1].[FullSubCatName] AS [FullSubCatName], \n    [Project1].[PMBID] AS [PMBID], \n    [Project1].[PMBID1] AS [PMBID1], \n    [Project1].[PMB_Level] AS [PMB_Level], \n    [Project1].[PMB_Text] AS [PMB_Text], \n    [Project1].[Composite] AS [Composite], \n    [Project1].[PMB_XPS] AS [PMB_XPS]\n    FROM ( SELECT \n        [Extent1].[WTVID] AS [WTVID], \n        [Extent1].[WTVersionName] AS [WTVersionName], \n        [Extent2].[RateCategoryName] AS [RateCategoryName], \n        [Extent3].[RSCID] AS [RSCID], \n        [Extent3].[PMBID] AS [PMBID], \n        [Extent3].[RateSubCategoryName] AS [RateSubCategoryName], \n        [Extent3].[SubCatCode] AS [SubCatCode], \n        [Extent3].[FullSubCatName] AS [FullSubCatName], \n        [Extent4].[PMBID] AS [PMBID1], \n        [Extent4].[PMB_Level] AS [PMB_Level], \n        [Extent4].[SectionCode] AS [SectionCode], \n        [Extent4].[Composite] AS [Composite], \n        [Extent4].[PMB_Text] AS [PMB_Text], \n        [Extent4].[PMB_XPS] AS [PMB_XPS]\n        FROM    [dbo].[WorkTypeVersions] AS [Extent1]\n        INNER JOIN [dbo].[RateCategories] AS [Extent2] ON [Extent1].[WTVID] = [Extent2].[WTVID]\n        INNER JOIN [dbo].[RateSubCategories] AS [Extent3] ON [Extent2].[RCID] = [Extent3].[RCID]\n        LEFT OUTER JOIN [dbo].[Preambles] AS [Extent4] ON [Extent3].[PMBID] = [Extent4].[PMBID]\n        WHERE ([Extent1].[Composite] = (CASE WHEN (@p__linq__0 = 1) THEN N''Y'' ELSE N''N'' END)) AND ([Extent2].[CatCode] = @p__linq__1)\n    )  AS [Project1]\n    ORDER BY [Project1].[SubCatCode] ASC, [Project1].[WTVersionName] ASC',N'@p__linq__0 bit,@p__linq__1 varchar(8000)',@p__linq__0=0,@p__linq__1='A'    \n</code></pre>\n\n<p>Versions of EF are currently: System.Data.Entity: 4.0.0.0, EntityFramework: 4.3.1</p>\n\n<p>What am I missing here?</p>\n"},{"tags":["sql-server","tsql","select","group-by"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":42,"score":1,"question_id":12159162,"title":"sql: group by bases on computed column?","body":"<p>I have this data that shows consolidated report grouped by year. What I have used is a simple \n<code>GROUP BY YEAR(BookingDate)</code> clause and everything works fine. But what I want is the year to be financial year (<code>1 April</code> to <code>31 May</code>) and not the normal calender year, so how can I do this? The query is..</p>\n\n<pre><code>SELECT \n    CONVERT(VARCHAR(25), c.Duration) AS Duration, \n    COALESCE(c.totalbookings, 0) AS totalbookings\nFROM\n    (SELECT \n               YEAR(bookingdate) AS Duration, \n               COUNT(*) AS totalbookings \n           FROM \n               entbookings\n            WHERE BranchId=@Branchid\n           GROUP BY YEAR(bookingdate)\n    ) AS c \nLEFT OUTER JOIN \n    (SELECT \n               Duration, \n               SUM(totalitems) 'bkdqty'\n           FROM \n               [yrItemWISeTotalQty] (@BranchId) AS BkdQty\n           GROUP BY Duration\n    ) AS d \nON c.Duration = d.Duration\n</code></pre>\n\n<p>The <code>yrItemWISeTotalQty</code> is defined as</p>\n\n<pre><code>CREATE FUNCTION [dbo].[yrItemWiseTotalQty]\n(\n@BrachId VARCHAR(MAX)\n) \n\nRETURNS TABLE AS\n    RETURN\nSELECT \n    YEAR(EntBookings.BookingDate) AS Duration, \n    Sum(dbo.EntBookings.ItemCost) AS totalcost,\nWHERE   EntBookings.BranchId = @BrachId\nGROUP BY Year(EntBookings.BookingDate)\n</code></pre>\n\n<p>Again, I am using <code>GROUP BY Year()</code> that does the work great, but I need to modify it to take the fy i.e. (1 April to 31 March). How can I do it?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":12156716,"title":"Sql script syntax and grammar issues","body":"<p>Can someone help please I dont know what I am doing wrong:</p>\n\n<pre><code>IF EXISTS ( SELECT  name\n        FROM    sys.tables\n        WHERE   name = N'MemberIdsToDelete' ) \nDROP TABLE [MemberIdsToDelete];\nGO\n\nSELECT  mm.memberid ,\n        mm.aspnetuserid ,\n        mm.email ,\n        mm.RowNum AS RowNum\nINTO    #MemberIdsToDelete\nFROM    membership.members AS mm\n        LEFT JOIN aspnet_membership AS asp ON mm.aspnetuserid = asp.userid\n        LEFT JOIN trade.tradesmen AS tr ON tr.memberid = mm.memberid\nWHERE   asp.isapproved = 0\n        AND tr.ImportDPN IS NOT NULL\n    AND tr.importDPN &lt;&gt; ''\nORDER BY mm.memberid\n\nDECLARE @MaxRownum INT\nSET @MaxRownum = ( SELECT   MAX(RowNum)\n                   FROM     #MemberIdsToDelete\n                 )\n\nDECLARE @Iter INT\nSET @Iter = ( SELECT    MIN(RowNum)\n              FROM      #MemberIdsToDelete\n            )\n\nDECLARE @MemberId INT\nDECLARE @TrademId INT\nDECLARE @UId UNIQUEIDENTIFIER\nDECLARE @Successful INT\nDECLARE @OutputMessage VARCHAR(200)\nDECLARE @Email VARCHAR(100)\nDECLARE @Username VARCHAR(100)\n\nSELECT  @MemberId = memberId ,\n        @UId = AspNetUserId\nFROM    MemberIdsToDelete\nSELECT  @TrademId = TradesManId\nFROM    trade.TradesMen\nWHERE   memberId = @MemberId;\n\nWHILE @Iter &lt;= @MaxRownum \n  BEGIN\n    SELECT  *\n    FROM    #MemberIdsToDelete\n    WHERE   RowNum = @Iter\n  --more code here\n    SET @Iter = @Iter + 1\n  END\n</code></pre>\n\n<p>I just want to check if my table MemberIdsToDelete exists, if so drop it,\ncreate MemberIdsToDelete with the results set from the select\nloop through MemberIdsToDelete table and perform operations</p>\n\n<p>I am getting error that RowNum does not exist</p>\n"},{"tags":["sql-server","tsql","select"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":62,"score":1,"question_id":12154150,"title":"sql: how to select a row, if the input can be in any field/column of a table?","body":"<p>If I have this table <code>TableABC</code> and it has some fields/columns, rather say it has many fields/columns <code>col1, col2, col3.....</code> say upto <code>10</code> or <code>20</code>, the count doesn't matter right now.\nThe point is, I wanna know, if we ask a user for input, say <code>@input varchar(max)</code> or something like this, what I wanna know is that..</p>\n\n<p>How can I select a row, if this input occurs in any column in that row, I mean the row would be selected if <code>col1=@input</code> also if <code>col2=@input</code> and so on..</p>\n\n<p>Now as I said the count of column doesn't matter, what matters is we don't know ahead of time the columns so that we may do something like </p>\n\n<pre><code>where\ncol1 = @input\nor\ncol2 = @input\n</code></pre>\n\n<p>we can't do that. I got as far as getting the names of column from table by say</p>\n\n<pre><code>SELECT [name] FROM sys.Columns WHERE [Object_id]=Object_id(N'TableABC')\n</code></pre>\n\n<p>This would give us names of col in the required table, now I don't know what can we do with them, or is this even useful in the scenario I am describing? So, what's the solution?</p>\n\n<p>Lastly, in case someone might ask, where am I gonna use it, or what's my requirement or something, let me clear its not for (at least as of now!) practical implementation, I just wanna know if its possible, and if so, how? I hope I made myself clear.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":43,"score":0,"question_id":12149996,"title":"Computing a field to identify chronological order of datapoints that share the same ID","body":"<p>I using Microsoft SQL Server 2008 to try and identify the chronological order of data points in order to create a filter field that will allow me to create a query that only includes the first and last record for each ID number, where multiple rows represent different data points from the same ID</p>\n\n<p>Here is an example of my current data and desired data to give a better idea of what I mean:</p>\n\n<p><strong>Current Data</strong></p>\n\n<pre><code>ID    Indicator        Date\n1       1           1988-02-11\n1       1           1989-03-9\n1       1           1993-04-3\n1       1           2001-05-4\n2       1           2000-01-01\n2       1           2001-02-03\n2       1           2002-04-22\n3       1           1990-02-01\n3       1           1998-02-01  \n3       1           1999-03-02\n3       1           2000-04-02\n4       0               NA\n</code></pre>\n\n<p><strong>Desired Data</strong></p>\n\n<pre><code>ID    Indicator    Date        Order_Indicator\n1       1       1988-02-11        1\n1       1       1989-03-9         2\n1       1       1993-04-3         3\n1       1       2001-05-4         4\n2       1       2000-01-01        1\n2       1       2001-02-03        2\n2       1       2002-04-22        3\n3       1       1990-02-01        1\n3       1       1998-02-01        2\n3       1       1999-03-02        3\n3       1       2000-04-02        4\n4       0       NULL             NULL\n</code></pre>\n\n<p>The field I want to create is the \"Order_Indicator\" field in the \"Desired Data\" table and with the only relevant records are records with Indicator = 1. With this information I would create a query where I only select the rows where Order_Indicator = 1 and Order_Indicator = MAX(Order_Indicator) for each \"row group\" that share the same ID. Does anyone have any idea about how I might go about this? I know I could do this very easily in Excel but I need to do it on SQL server in order for it to be reproducible with my colleagues.</p>\n\n<p>Thank you so much in advance!</p>\n"},{"tags":["sql","tsql","testing","transactions"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12138602,"title":"Is it enough to test a stored-procedure safely just by running it in a transaction?","body":"<p>I have a sp called MoveSomeItems which gets some rows from tableA from Foo Db. and moves them to tableA in Bar Db.</p>\n\n<p>I want to test this sp if it really moves the items.</p>\n\n<p>Is it enough to run this sp in a transaction and select the rows to see if they are moved OR I should approach it in a different way?</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":193,"score":7,"question_id":12059119,"title":"TSQL equally divide resultset to groups and update them","body":"<p>I have my database with 3 tables like so:</p>\n\n<p><img src=\"http://i.stack.imgur.com/uPj06.jpg\" alt=\"enter image description here\"></p>\n\n<p>Orders table has data like below:</p>\n\n<pre><code>OrderID    OperatorID    GroupID        OrderDesc    Status    Cash    ...\n--------------------------------------------------------------------------\n      1             1          1      small order         1     100 \n      2             1          1    another order         2       0 \n      3             1          2      xxxxxxxxxxx         2    1000 \n      5             2          2      yyyyyyyyyyy         2     150 \n      9             5          1      xxxxxxxxxxx         1       0 \n     10          NULL          2      xxxxxxxxxxx         1      10 \n     11          NULL          3      xxxxxxxxxxx         1     120 \n</code></pre>\n\n<p>Operators table:</p>\n\n<pre><code>OperatorID    Name    GroupID    Active\n---------------------------------------\n      1       John          1         1\n      2       Kate          1         1\n      4       Jack          2         1\n      5       Will          1         0\n      6        Sam          3         1\n</code></pre>\n\n<p>Group table:</p>\n\n<pre><code>GroupID    Name\n---------------\n      1      G1\n      2      G2\n      3      X1\n</code></pre>\n\n<p>As You can see John has 3 orders, Kate 1, Will 1, Jack and Sam none.<br /></p>\n\n<p>Now I would like to assign operators to orders base on some conditions:</p>\n\n<ul>\n<li>order must have cash>0</li>\n<li>order must have status=1</li>\n<li>order must be in group 1 or 2</li>\n<li>operator must be active (active=1)</li>\n<li>operator must be in group 1 or 2</li>\n</ul>\n\n<p>This is the result that I would like to get:</p>\n\n<pre><code>OrderID    OperatorID    GroupID        OrderDesc    Status    Cash    ...\n--------------------------------------------------------------------------\n      1             1          1      small order         1     100       &lt; change\n      2             1          1    another order         2       0 \n      3             2          2      xxxxxxxxxxx         2    1000       &lt; change\n      5             4          2      yyyyyyyyyyy         2     150       &lt; change\n      9             5          1      xxxxxxxxxxx         1       0 \n     10             4          2      xxxxxxxxxxx         1      10       &lt; change\n     11          NULL          3      xxxxxxxxxxx         1     120 \n</code></pre>\n\n<p>I would like to shuffle orders and update operatorID so that every time I call this script I get randomly assigner operatorID, but every operator will have equal number or orders (close to equal, because if I have 7 orders one person will have 3 and rest 2).</p>\n\n<p>I can use <code>NTILE</code> to distribute orders into groups, but I need to assign operatorID to that group.</p>\n\n<p>I think that I need to do something like this:</p>\n\n<pre><code>SELECT NTILE(2) OVER( order by orderID desc) as newID,* \nFROM\n    orders(NOLOCK)\n</code></pre>\n\n<p>This will give me my orders table grouped into equal parts. What I need to know is length of operators table (to add it as parameter to NTILE), after that I could join my results with operators (using <code>row_number()</code>)</p>\n\n<p>Is there a better solution?</p>\n\n<p>My question again: <strong>How to equally divide result set into groups and update that record set using another table data?</strong></p>\n\n<p><strong>EDIT:</strong>\nThis is my code so far: <a href=\"http://sqlfiddle.com/#!3/39849/25\" rel=\"nofollow\">http://sqlfiddle.com/#!3/39849/25</a></p>\n\n<p><strong>EDIT 2</strong>\nI've updated my question and added more conditions.</p>\n\n<p>I would like to assign operators to orders based on some conditions:</p>\n\n<ul>\n<li>order must have cash>0</li>\n<li>order must have status=1</li>\n<li>order must be in group 1 or 2</li>\n<li>operator must be active (active=1)</li>\n<li>operator must be in group 1 or 2</li>\n</ul>\n\n<p>I'm building this query as stored procedure.<br />\nSo the first step will be to generate data with new assignments into temporary table and after final approval in second step to update main table based on that temp table.</p>\n\n<p>I have 2 more questions:</p>\n\n<ol>\n<li><p>Will it be better to first select all all orders  and all operators that meets the conditions to temporary table and then do the shuffling or to do it all in one big query?</p></li>\n<li><p>I would like to pass array or groups as a parameter to my procedure. Which option would be the best to pass array to stored procedure (SQL Server 2005).<br /><br />\nI know this was asked many times but I would like to know if it is better to create a separate function that will cut comma separated string into table (<a href=\"http://www.sommarskog.se/arrays-in-sql-2005.html\" rel=\"nofollow\">http://www.sommarskog.se/arrays-in-sql-2005.html</a>) or to put everything inside one big fat procedure? :)</p></li>\n</ol>\n\n<hr>\n\n<p><strong>FINAL ANSWER:</strong> avilable at <a href=\"http://sqlfiddle.com/#!3/afb48/2\" rel=\"nofollow\">http://sqlfiddle.com/#!3/afb48/2</a></p>\n\n<pre><code>SELECT o.*, op.operatorName AS NewOperator, op.operatorID AS NewOperatorId\nFROM (SELECT o.*, (ROW_NUMBER() over (ORDER BY newid()) % numoperators) + 1 AS randseqnum\n      FROM Orders o CROSS JOIN\n     (SELECT COUNT(*) AS numoperators FROM operators WHERE operators.active=1) op\n      WHERE o.cash&gt;0 and o.status in (1,3)\n     ) o JOIN\n     (SELECT op.*, ROW_NUMBER() over (ORDER BY newid()) AS seqnum\n      FROM Operators op WHERE op.active=1\n     ) op\n     ON o.randseqnum = op.seqnum ORDER BY o.orderID\n</code></pre>\n\n<p>Answer based on Gordon's Linoff answer. Thanks!</p>\n"},{"tags":["sql-server","database","query","tsql","index"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":80,"score":0,"question_id":12155363,"title":"How to perform nonclustered index seek instead of clustered index scan","body":"<p>I test the benefits of nonclustered indexes.</p>\n\n<p>I use db AdventureWorks\nWhen i execute the query:</p>\n\n<pre><code>SELECT [address].City, [address].[AddressLine1] \nFROM [AdventureWorks].[Person].[Address] as [address]\nWHERE [address].City = 'Seattle'\n</code></pre>\n\n<p>I see in execution plan tab </p>\n\n<pre><code>/*\nMissing Index Details from SQLQuery3.sql - \nThe Query Processor estimates that implementing the following index could improve the query cost by 97.9636%.\n*/\n\n/*\nUSE [AdventureWorks]\nGO\nCREATE NONCLUSTERED INDEX [&lt;Name of Missing Index, sysname,&gt;]\nON [Person].[Address] ([City])\n\nGO\n*/\n</code></pre>\n\n<p>And  i see in the execution plain tab icon \"Clustered index scan\" and i know that it is bad because index seek is better</p>\n\n<p>But when i execute query </p>\n\n<pre><code>USE [AdventureWorks]\nGO\nCREATE NONCLUSTERED INDEX CityIdx\nON [Person].[Address] ([City])\n\nGO\n</code></pre>\n\n<p><strong>I still see the in execution plain tab \"Clustered index scan\". WHY not \"Clustered index seek\" ? Does it should be \"Clustered index seek\" ? IN which cases it should be \"Clustered index seek\".</strong></p>\n"},{"tags":["sql","sql-server-2008","tsql","group-by","group-by-time-interval"],"answer_count":5,"favorite_count":2,"up_vote_count":9,"down_vote_count":0,"view_count":8606,"score":9,"question_id":5002661,"title":"How to group time by hour or by 10 minutes ","body":"<p>like when I do </p>\n\n<pre><code>SELECT [Date]\n  FROM [FRIIB].[dbo].[ArchiveAnalog]\n  GROUP BY [Date]\n</code></pre>\n\n<p>how can I specify the group period ?</p>\n\n<p>MS SQL 2008</p>\n\n<p><strong>2nd Edit</strong></p>\n\n<p>I'm trying </p>\n\n<pre><code>SELECT MIN([Date]) AS RecT, AVG(Value)\n  FROM [FRIIB].[dbo].[ArchiveAnalog]\n  GROUP BY (DATEPART(MINUTE, [Date]) / 10)\n  ORDER BY RecT\n</code></pre>\n\n<p>changed %10 to / 10. is it possible to make Date output without milliseconds ?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":97,"score":0,"question_id":12151107,"title":"TSQL - Update table from itself","body":"<p>Table <strong>Item</strong> (4 columns, simplified for the sake of clarity)</p>\n\n<pre>Record | Item | Price | Zone</pre>\n\n<p><strong>Data</strong></p>\n\n<pre>1 | 100  | 10.00 | A\n2 | 100  | NULL | B\n3 | 100  | NULL | C\n4 | 200  | 25.00 | A\n5 | 200  | NULL | B</pre>\n\n<p>Trying to update the <code>NULL</code>s with the corresponding values from the non-<code>NULL</code>s based on <code>Item</code>. So all Item 100s would read 10.00 and both Item 200s would read 25.00. </p>\n\n<p>I feel like this should be super easy, but can't figure out the self reference. </p>\n\n<p>Thanks</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12138133,"title":"Calculate difference between dates returning datetime result","body":"<p>I need to get the difference between two dates in datetime format: <code>HH:mm:ss</code>. Is it possible using some T-SQL function? I always used <code>DATEDIFF</code> but it returns only <code>int</code>.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":49,"score":-2,"question_id":12154152,"title":"Performance of xml path","body":"<p>I have a query below:</p>\n\n<pre><code>select col1,\n       col2,\n       .\n       .\n       .\n       coln\n  from table1\n  left join table2\n  on some condition\n  .\n  .\n  left  join tablen\n  on some condition\n  left join (\n              select t1.col1,\n              (\n                select t2.col2 + ';' as [data()]\n                  from SomeTable t2\n                 where t2.col1 = t1.col1\n                 for xml path('')\n              ) value\n              from SomeTable t1\n              group by t1.Col1\n            )MyTable\n         on some condition\n</code></pre>\n\n<p>The above query will return about 4000 rows. The inline select statement using xml path will also result in about 4000 records.</p>\n\n<p>I wish to know if there will be any performance impact with this query due to the use of xml path.</p>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql","tsql","sql-server-2008","ssis"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2772,"score":1,"question_id":7281504,"title":"How to proceed to the next task only if no records exist for a given query?","body":"<p>I have the following piece of SQL that will check if any duplicate records exist. How can I check to see if no records are returned? I'm using this in an SSIS package. I only want it to proceed to the next step if no records exist, otherwise error.</p>\n\n<pre><code>SELECT      Number\n        ,   COUNT(Number) AS DuplicateCheckresult\nFROM        [TelephoneNumberManagement].[dbo].[Number]\nGROUP BY    Number\nHAVING      COUNT(Number) &gt; 1\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":36,"score":0,"question_id":12151849,"title":"Data from 3 tables with a primary key in common","body":"<p>I have three tables <code>Invoice</code>, <code>Account</code> and <code>Visits</code></p>\n\n<p>Each has a primary key in common (<code>AccountID</code>). I need to draw data for accounts that have not had a visit in the month of july and had a valid account to allow a visit in that month (drawn from <code>Invoice</code> - <code>scheduletype</code> and <code>Account</code> - <code>startdate</code>)</p>\n\n<p>I have tried using several joins but am not able to get the data out as I need it and am fairly new to SQL. Would anyone be able to help me out with some pointers please?</p>\n"},{"tags":["tsql","sms","sp-send-dbmail"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":59,"score":0,"question_id":12148694,"title":"T-SQL Convert multiples rows into short SMS text string/message","body":"<p>I'm trying to create a short SMS message and a full formatted email from the same data. \nHow can I convert 2 rows from at able into a SQL string for purposes of the text email. </p>\n\n<p>I have only 4 rows in my table, and I assign them a rating of \"Good\" or \"Bad\" using my own criteria. The fully formatted email will show all four rows, but the SMS needs to show just the bad ones. </p>\n\n<p>I'll probably send two emails using sp_send_dbmail and some people might want to use Outlook route the SMS one to their phones vs SMS text, and others will use a different alerting system on their phones and just read the email on their device. </p>\n\n<p>Here's an example of what I'd like to do.  The @htmlEmailText is working fine, because it uses the \"FOR XML\" clause. </p>\n\n<pre><code>if @format = 'EMAIL' \n    begin \n        SET @SMSEmailText = \n            'BizTalk Feed Alert ' + \n            CAST (( \n            SELECT Airline, 'Feed=' + ST.Feed, 'MinutesSinceLastMessage=' + MinutesSinceLastMessage \n               where Rating = 'BAD') \n                ) AS NVARCHAR(MAX) )\n                ;\n        SET @htmlEmailText =\n            N'&lt;H1&gt;BizTalk Feed Alert&lt;/H1&gt;' +\n            N'&lt;table border=\"1\"&gt;' +\n            N'&lt;tr&gt;' + \n            N'&lt;th&gt;Rating&lt;/th&gt;' +\n            N'&lt;th&gt;Airline&lt;/th&gt;' +\n            N'&lt;th&gt;Feed&lt;/th&gt;' +\n            N'&lt;th&gt;MinutesSinceLastMessage&lt;/th&gt;' +\n            N'&lt;th&gt;AlertMinutes&lt;/th&gt;' +\n            N'&lt;th&gt;LocalDateTimeLastMsgRcvd&lt;/th&gt;' +\n            N'&lt;th&gt;CountMessageInLastHour&lt;/th&gt;' +\n            N'&lt;th&gt;AvgCountPerSameHour&lt;/th&gt;' +\n            CAST ( ( SELECT td = Rating,       '',\n                            td = Airline, '',\n                            td = ST.Feed, '',\n                            td = MinutesSinceLastMessage, '',\n                            td = AlertMinutes, '',\n                            td = LocalDateTimeLastMsgRcvd, '', \n                            td = CountMessageInLastHour, '', \n                            td = AvgCountPerSameHour, ''\n                      from @StatsTable ST \n                      left outer join @CountTable CT on ST.Feed = CT.Feed \n                      left outer join @AvgTable AT on ST.Feed = AT.Feed \n                      FOR XML PATH('tr'), TYPE \n            ) AS NVARCHAR(MAX) ) +\n            N'&lt;/table&gt;' \n            ;\n    end \n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","join"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":69,"score":1,"question_id":12145305,"title":"Is there documentation on/can someone explain a nested join in TSQL?","body":"<p>I'm not quite sure how to describe this, and I'm not quite sure if it's just syntactical sugar. This is the first time I've seen it, and I'm having trouble finding a reference or explanation as to the why and what of it.</p>\n\n<p>I have a query as follows:</p>\n\n<pre><code>select * from\n     table1\n          join table2 on field1 = field2\n          join (\n               table3 \n                    join table4 on field3 = field4\n                    join table5 on field5 = field6\n               ) on field3 = field2 \n               -- notice the fields in the parens and outside the parens \n               -- are part of the on clause\n</code></pre>\n\n<p>Are the parentheses necessary? Will removing them change the join order? I'm in a SQL Server 2005 environment in this case. Thanks!</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":127,"score":0,"question_id":12148314,"title":"Rowcount in multiple select queries in stored procedure - T-SQL","body":"<p>Following Stored procedure doesn't return anything even if DB has matching record.Is the <code>Rowcount</code> is problem?\nAnyone please help?</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[Usp_get_product_rates]\n  -- Add the parameters for the stored procedure here\n  @pcat1 CHAR(3),\n  @pcat2 CHAR(3),\n  @pcat3 CHAR(1)\nAS\n  BEGIN\n      -- SET NOCOUNT ON added to prevent extra result sets from\n      -- interfering with SELECT statements.\n      SET NOCOUNT ON\n\n      SELECT b.pcat1,\n             b.pcat2,\n             pcat3,\n             rate1,\n             rate2\n      FROM   Product_Rates AS a\n             JOIN Master_Rates AS b\n               ON a.pon = b.pon\n      WHERE  b.pcat1 = @pcat1\n             AND b.pcat2 = @pcat2\n             AND pcat3 = 'P'\n\n      IF @@RowCount = 0\n        BEGIN\n            SELECT b.npa,\n                   b.nxx,\n                   blockid,\n                   Inter_state_rate,\n                   Intra_state_rate\n            FROM   Rates_STF2 AS a\n                   JOIN TPM AS b\n                     ON a.pon = b.pon\n            WHERE  b.pcat1 = @pcat1\n                   AND b.pcat2 = @pcat2\n                   AND pcat3 = '@pcat3'\n        END\n  END \n</code></pre>\n"},{"tags":["sql","sql-server","tsql","statistics"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":35,"score":1,"question_id":12148653,"title":"Ad hoc 2x2 contingency tables SQL Server 2008","body":"<p>I'm looking at ways of creating <a href=\"http://en.wikipedia.org/wiki/Contingency_tables\" rel=\"nofollow\">contingency tables</a> in SQL Server 2008. They don't necessarily have to appear in the 2x2 typical matrix.  I'd just like to know if anyone out there can see a better solution than mine. </p>\n\n<p><img src=\"http://i.stack.imgur.com/H85Ih.jpg\" alt=\"enter image description here\">\nPlease refer to the picture for clarity.  The red letters are names of the squares for simplicity's sake.  The label X+ means X is present in that cell and the opposite is true as well.</p>\n\n<p>I will label my queries with the letter of box in the table that they represent</p>\n\n<pre><code>A\n\n       select count(*) from \n    (\n\n    select distinct p.patientid\n        from Patient as p\n        inner join icdpatient as picd on picd.patientid = p.patientid\n        and picd.admissiondate = p.admissiondate\n        and picd.dischargedate = p.dischargedate\n        inner join tblicd as t on t.icd_id = picd.icd_id\n        where t.icdText like '%x%' \n    ) as t\n    inner join \n    (\n    select distinct p.patientid\n        from Patient as p\n        inner join icdpatient as picd on picd.patientid = p.patientid\n        and picd.admissiondate = p.admissiondate\n        and picd.dischargedate = p.dischargedate\n        inner join tblicd as t on t.icd_id = picd.icd_id\n        where t.icdText like '%y%'\n    ) as s on s.patientid=t.patientid\n</code></pre>\n\n<hr>\n\n<pre><code>B\nselect count(*) from \n(\n\nselect distinct p.patientid\n    from Patient as p\n    inner join icdpatient as picd on picd.patientid = p.patientid\n    and picd.admissiondate = p.admissiondate\n    and picd.dischargedate = p.dischargedate\n    inner join tblicd as t on t.icd_id = picd.icd_id\n    where t.icdText like '%x%' \n) as t\nleft join \n(\nselect distinct p.patientid\n    from Patient as p\n    inner join icdpatient as picd on picd.patientid = p.patientid\n    and picd.admissiondate = p.admissiondate\n    and picd.dischargedate = p.dischargedate\n    inner join tblicd as t on t.icd_id = picd.icd_id\n    where t.icdText like '%y%'\n) as s on s.patientid=t.patientid\nwhere s.patientid is null\n</code></pre>\n\n<hr>\n\n<pre><code>C\nselect * from \n(\n\nselect distinct p.patientid\n    from Patient as p\n    inner join icdpatient as picd on picd.patientid = p.patientid\n    and picd.admissiondate = p.admissiondate\n    and picd.dischargedate = p.dischargedate\n    inner join tblicd as t on t.icd_id = picd.icd_id\n    where t.icdText like '%x%' \n) as t\nright join \n(\nselect distinct p.patientid\n    from Patient as p\n    inner join icdpatient as picd on picd.patientid = p.patientid\n    and picd.admissiondate = p.admissiondate\n    and picd.dischargedate = p.dischargedate\n    inner join tblicd as t on t.icd_id = picd.icd_id\n    where t.icdText like '%y%'\n) as s on s.patientid=t.patientid\nwhere t.patientid is null\n</code></pre>\n\n<p>D\nThis one I'm a little iffy about but I think I'm going to do something like</p>\n\n<pre><code>declare @d int\nset @d = (select count(distinct p.patientid) from Patient as p) - b -c\n</code></pre>\n\n<p>This aims to find the entire population and subtracting those ONLY with X and ONLY with y</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":12112428,"title":"Scalable approach to splitting and validating a fixed width or CSV datarow in SQL A.K.A. How can I avoid SSIS?","body":"<p>I'm currently playing with different ways of getting data into SQL and yesterday hit a problem using BCP which although I solved reminded me of working with SSIS packages because of the not very useful error information.  I feel that for the way I like to work I would be much happier loading entire datarows whether fixed-width or delimited into a staging table (using BCP or Bulk Insert) and then operating on the data rows rather than trying to force them into typed columns on the way in to SQL.</p>\n\n<p>As such I would like to find an approach that would allow me to split and validate (check datatype) the data before I insert it into its destination and also write out any bad datarows to another table so I can then decide what to do with them.</p>\n\n<p>I've knocked together a script to simulate the scenario, the importedData table would be the output of my BCP or BULK INSERT. All the data from ImportedData needs to end up either in the Presenters or the RejectedData tables.</p>\n\n<p>I need an approach that could scale reasonably well, a real life situation might me more like 40 columns across with 20 million rows of data so I'm thinking I'll have to do something like process 10,000 rows at a time.</p>\n\n<p>SQL Server 2012 has the new try_parse function which would probably help but I need to be able to do this on 2005 and 2008 machines.</p>\n\n<pre><code>IF OBJECT_ID (N'ImportedData', N'U') IS NOT NULL DROP TABLE dbo.ImportedData\nCREATE TABLE dbo.ImportedData (RowID INT IDENTITY(1,1), DataRow VARCHAR(MAX))\n\nIF OBJECT_ID (N'Presenters', N'U') IS NOT NULL DROP TABLE dbo.Presenters\nCREATE TABLE dbo.Presenters (PresenterID INT, FirstName VARCHAR(10), LastName VARCHAR(10))\n\nIF OBJECT_ID (N'RejectedData', N'U') IS NOT NULL DROP TABLE dbo.RejectedData\nCREATE TABLE dbo.RejectedData (DataRow VARCHAR(MAX))\n\n-- insert as fixed-width\nINSERT INTO dbo.ImportedData(DataRow)\nSELECT           '1  Bruce     Forsythe  '                               \nUNION ALL SELECT '2  David     Dickinson '\nUNION ALL SELECT 'X  BAD       DATA'                                  \nUNION ALL SELECT '3  Keith     Chegwin   '                        \n\n-- insert as CSV\n/*INSERT INTO dbo.ImportedData(DataRow)\nSELECT '1,Bruce,Forsythe'                               \nUNION ALL SELECT '2,David,Dickinson'                                  \nUNION ALL SELECT 'X,BAD,DATA'\nUNION ALL SELECT '3,Keith,Chegwin' \n*/\n---------- DATA PROCESSING -------------------------------\n\nSELECT\n    SUBSTRING(DataRow,1,3) AS ID,\n    SUBSTRING(DataRow,4,10) AS FirstName,\n    SUBSTRING(DataRow,14,10) AS LastName\nFROM\n    ImportedData\n\n\n---------- DATA PROCESSING -------------------------------\nSELECT * FROM ImportedData\nSELECT * FROM Presenters\nSELECT * FROM RejectedData\n</code></pre>\n"},{"tags":["sql-server","tsql","sql-server-2008"],"answer_count":4,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":3871,"score":4,"question_id":5424465,"title":"get only last row in each day's multiple entries in TSQL","body":"<p>I have a table, something like: </p>\n\n<pre><code>Id        Name        EnteredOn                    Percentage\n`````````````````````````````````````````````````````````````\n01        person1     2011-03-09 17:29:35.683      56.29\n02        person1     2011-03-09 17:29:35.731      76.29\n03        person1     2011-03-09 18:15:78.683      56.29\n04        person1     2011-03-10 17:29:35.683      56.29\n05        person1     2011-03-10 16:29:31.683      56.29\n06        person1     2011-03-11 17:29:35.683      56.29\n</code></pre>\n\n<p>To summarize the above table, there are <strong>three</strong> rows for day <strong>09</strong>, and <strong>two</strong> rows for day <strong>10</strong>.</p>\n\n<p>Now, I just want to select the latest row - <strong>one single row</strong> - per day.<br>\n <em>(one row for 9, one for 10 and the one for 11)</em> </p>\n\n<p>I cannot use distinct because of the timestamp. I cant group and use:  </p>\n\n<pre><code>CAST(CONVERT(FLOAT, EnteredOn) AS INT)\n</code></pre>\n\n<p>because when I select EnteredOn field, it complaints that its not grouped. I cant combine <code>distinct(cast..date...)</code> because I cant get the right syntax.</p>\n\n<p>How can I select - only <strong>Name, EnteredOn, Percentage</strong> fields with distinct to each day? </p>\n\n<p>many thanks in advance.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":68,"score":0,"question_id":12143166,"title":"How to pull out the employees who have 'first name,lastname and date of birth' as same from Employee table","body":"<p>I need to pull out the records whose First name,lastname and date of birth are of same.\nPlease find the below example.</p>\n\n<pre><code>Employeeid   firstname lastname DOB\n00010         ravi      sagi     22/01/1990\n00035         ravi      sagi     22/01/1990\n00060         vasanth   guptha   20/01/1987\n00115         vasanth   guptha   20/01/1987\n</code></pre>\n\n<p>Can you please help in writing the query.</p>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":3,"favorite_count":2,"up_vote_count":2,"down_vote_count":0,"view_count":231,"score":2,"question_id":12140768,"title":"Transpose rows and columns without aggregate","body":"<p>I have the following dataset </p>\n\n<pre><code>Date            Field1        Col1  Col2    Col3\n2012/07/02      Customer1      CL   DS      RT\n2012/07/03      Customer1      DS   RT      700\n2012/07/04      Customer1      DS   RT      700\n2012/07/02      Customer2      CL   DS      RT\n2012/07/03      Customer2      DS   RT      1500\n2012/07/04      Customer2      DS   RT      1500\n2012/07/02      Customer3      CL   DS      RT\n2012/07/03      Customer3      DS   RT      6000\n2012/07/04      Customer3      DS   RT      6000\n2012/07/02      Customer4      CL   RC      RT\n2012/07/03      Customer4      RC   RT      4900\n2012/07/04      Customer4      RC   RT      4900\n</code></pre>\n\n<p>I'd like output as follows: </p>\n\n<pre><code>Field1  2012/07/02  2012/07/03  2012/07/04\nCol1    Customer1   CL  DS  DS\nCol2    Customer1   DS  RT  RT\nCol3    Customer1   RT  700 700\nCol1    Customer2   CL  DS  DS\nCol2    Customer2   DS  RT  RT\nCol3    Customer2   RT  1500    1500\nCol1    Customer3   CL  DS  DS\nCol2    Customer3   DS  RT  RT\nCol3    Customer3   RT  6000    6000\nCol1    Customer4   CL  RC  RC\nCol2    Customer4   RC  RT  RT\nCol3    Customer4   RT  4900    4900\n</code></pre>\n\n<p>The problem is also that I have an unfixed amount of Customers (Field1) &amp; unfixed amount of Dates.</p>\n"}]}
{"total":16599,"page":19,"pagesize":100,"questions":[{"tags":["sql-server-2008","tsql","table","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12137423,"title":"SQL Server 2008 SP","body":"<p>Hi friends I have two tables <code>actual</code> and <code>forecast</code></p>\n\n<p><strong>Actual</strong></p>\n\n<pre><code>  month    actual \n  6          20\n  7          60\n  8          70\n</code></pre>\n\n<p>and <strong>Forecast</strong></p>\n\n<pre><code> month        forecast\n   9             50\n  10             150\n  11             85\n</code></pre>\n\n<p>I have to update it in same column, i.e till the data is available it should be updated from actual table and when data is not available there it should be updated from forecast table.</p>\n\n<pre><code>  month      actual/forecast\n   6                20\n   7                60\n   8                70\n   9                50\n  10                150\n  11                85\n</code></pre>\n\n<p>Thanks in advance.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":131,"score":4,"question_id":12139110,"title":"UPDATE if column is not null, if null then leave at null","body":"<p>I have the following SQL:    </p>\n\n<pre><code>UPDATE TableA\nSET first_name = 'AAA',\n    last_name = 'BBB',\n    address1 = '123',\n    address2 = 'Fake St.,',\n    phone = '1234567',\n    id = '11223344'\n</code></pre>\n\n<p>What should I use to only update each column if it is not null?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":3,"up_vote_count":5,"down_vote_count":0,"view_count":234,"score":5,"question_id":12136546,"title":"ISNULL function in SQL Server 2008 not working properly","body":"<p>Assume this script:</p>\n\n<pre><code>DECLARE @result TABLE(Id BIGINT);\n\nDELETE FROM [Products].[Product]\nOUTPUT DELETED.[Id] INTO @result\nWHERE [Products].[Product].[Id] = 1589;\n</code></pre>\n\n<p>So in continues I try : </p>\n\n<p><strong>1</strong></p>\n\n<pre><code>SELECT CAST(ISNULL([Id], -1) AS BIGINT) AS N'RetValId' FROM @result;\n</code></pre>\n\n<p>When <code>[Id]</code> is null returned null (nothing), but this one returned -1:</p>\n\n<p><strong>2</strong></p>\n\n<pre><code>DECLARE @mi BIGINT;\nSET @mi = (SELECT [Id] FROM @result)\nSELECT CAST(ISNULL(@mi, -1) AS BIGINT) AS N'RetValId'\n</code></pre>\n\n<p>Why? where is the problem with first script?</p>\n\n<p><strong>Update</strong></p>\n\n<p>So is there any way to check if the Deleted Id is null returned -1 And if not Returned Id without declare another variable? what is the simplest way?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","query-execution-plans"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":109,"score":2,"question_id":12106855,"title":"Select columns affect execution plan?","body":"<p>I have a query something like this.  It has an execution plan using an index that I expect, up until the amount of data (i.e. the number of characters) returned by the SELECT goes over a boundary. At that point, the plan no longer uses the index and the query gets 100+ times slower.  </p>\n\n<p>If I use <code>NVARCHAR(203)</code>, it is fast. <code>NVARCHAR(204)</code> is slow.  Also, when it does not use the index, it totally burns up the CPU.  At least it seems to me to be a data size problem, but I am looking for any insight.</p>\n\n<p>I have changed oldValueString and newValueString to NVARCHAR(255) and things are a little better, but I still can't query all of the columns w/o losing the index in the plan.</p>\n\n<pre><code>SELECT\n   [Lx_AuditColumn].[auditColumnPK],\n   CONVERT(NVARCHAR(204), [Lx_AuditColumn].[newValueString])\nFROM\n   [dbo].[Lx_AuditColumn] [Lx_AuditColumn],\n   [dbo].[Lx_AuditTable] [Lx_AuditTable]\nWHERE\n   [Lx_AuditColumn].[auditTableFK] = [Lx_AuditTable].[auditTablePK]\nAND\n   [Lx_AuditTable].[createdDate] &gt;=  @P1\nAND\n   [Lx_AuditTable].[createdDate] &lt;=  @P2\nORDER BY\n   [Lx_AuditColumn].[auditColumnPK] DESC\n</code></pre>\n\n<p>This is the basic structure of tables (I eliminated some indexes and FK constraints).</p>\n\n<pre><code>CREATE TABLE [dbo].[Lx_AuditTable]\n(\n   [auditTablePK] [int] NOT NULL IDENTITY(1, 1) ,\n   [firmFK] [int] NOT NULL ,\n   [auditMasterFK] [int] NOT NULL ,\n   [codeSQLTableFK] [int] NOT NULL ,\n   [objectFK] [int] NOT NULL ,\n   [projectEntityID] [int] NULL ,\n   [createdByFK] [int] NOT NULL ,\n   [createdDate] [datetime] NOT NULL ,\n   CONSTRAINT [Lx_PK_AuditTable_auditTablePK] PRIMARY KEY CLUSTERED\n   (\n      [auditTablePK]\n   ) WITH FILLFACTOR = 90\n)\nGO\n\nCREATE INDEX [Lx_IX_AuditTable_createdDatefirmFK]\n   ON [dbo].[Lx_AuditTable]([createdDate], [firmFK])\n   INCLUDE ([auditTablePK], [auditMasterFK])\n   WITH (FILLFACTOR = 90, ONLINE = OFF)\nGO\n\nCREATE TABLE [dbo].[Lx_AuditColumn]\n(\n   [auditColumnPK] [int] NOT NULL IDENTITY(1, 1) ,\n   [firmFK] [int] NOT NULL ,\n   [auditTableFK] [int] NOT NULL ,\n   [accessorName] [nvarchar] (100) NOT NULL ,\n   [dataType] [nvarchar] (20) NOT NULL ,\n   [oldValueNumber] [int] NULL ,\n   [oldValueString] [nvarchar] (4000) NULL ,\n   [newValueNumber] [int] NULL ,\n   [newValueString] [nvarchar] (4000) NULL ,\n   [newValueText] [ntext] NULL ,\n   CONSTRAINT [Lx_PK_AuditColumn_auditColumnPK] PRIMARY KEY CLUSTERED\n   (\n      [auditColumnPK]\n   ) WITH FILLFACTOR = 90 ,\n   CONSTRAINT [Lx_FK_AuditColumn_auditTableFK] FOREIGN KEY\n   (\n      [auditTableFK]\n   ) REFERENCES [dbo].[Lx_AuditTable] (\n      [auditTablePK]\n   )\n)\nGO\n\nCREATE INDEX [Lx_IX_AuditColumn_auditTableFK]\n   ON [dbo].[Lx_AuditColumn]([auditTableFK])\n   WITH (FILLFACTOR = 90, ONLINE = OFF)\nGO\n</code></pre>\n\n<p>Good:</p>\n\n<p><img src=\"http://i.stack.imgur.com/5tVi9.jpg\" alt=\"enter image description here\"></p>\n\n<p>Bad:</p>\n\n<p><img src=\"http://i.stack.imgur.com/oTyV7.jpg\" alt=\"enter image description here\"></p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":61,"score":1,"question_id":12135480,"title":"Convert hierarchyid to a string whose lexical order is the same as the hierarchyid depth-first order","body":"<p>I'm wondering if there's a reasonable, performant way to convert a hierarchyid value to a string whose lexical ordering maintains its natural depth-first ordering.</p>\n\n<p>Thanks!</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":78,"score":1,"question_id":12136088,"title":"T-SQL Average of Table Subset","body":"<p>I have a table (in SQL Server 2005) of daily weather data for a single location which includes these columns:</p>\n\n<pre><code>LogDate                 DATETIME  \nHighTemp                INT  \nTemp6MonthHighAverage   INT  \n</code></pre>\n\n<p><code>LogDate</code> and <code>HighTemp</code> have data. <code>HighTemp6MonthAverage</code> will be populated with, as the name suggests, the average high temperature for the 6 months ending in <code>LogDate</code>.</p>\n\n<p>There are similar requirements for LowTemp, as well as humidity and several other items, for data spanning decades.</p>\n\n<p>I find myself thinking in circles.  Can I derive this average for each row in an UPDATE statement using set operations, or do I need to implement a solution with cursors? I will appreciate any suggestions.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":155,"score":1,"question_id":12134944,"title":"Issue with converting varchar to money back to varchar in sql server","body":"<p>I've got a column in my database which contains a price, stored as a <code>varchar(10)</code>. The format that I need to pull it out as has a comma, but no decimal. So, if the price is <code>1500.00121</code>, it should come out as \"1,500\", with comma intact. So here is what I have so far:</p>\n\n<pre><code>CONVERT(varchar, CAST(p.Price1 AS money), 1)\n</code></pre>\n\n<p>This still has the decimal place to <code>\".xx\"</code> in it. How can I remove the decimal and trailing numbers while retaining the comma?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005","indexing"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":36,"score":1,"question_id":12134940,"title":"Need help on indexing using SQL server 2005","body":"<p>I have a table, <code>paymentdetails</code>, with a column <code>paymentstatus</code> (has a check constraint restricting values to either paid or pending). Also, a table <code>patientdetails</code>, that holds patientid, address......columns</p>\n\n<p>I want to create an index that speeds up the execution of extracting the patient details for each patient whose initial payment is pending.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":109,"score":0,"question_id":12111708,"title":"SQL Server CONFIG statement cannot be used inside a user transaction","body":"<p>I got </p>\n\n<blockquote>\n  <p><em>CONFIG statement cannot be used inside a user transaction</em></p>\n</blockquote>\n\n<p>when running procedure 2 below. Any resolution? Thanks.</p>\n\n<p>Procedure #1:</p>\n\n<pre><code>CREATE PROC [dbo].[nz_test1]\nas\n   EXEC sp_configure 'show advanced option', 1\n   RECONFIGURE WITH OVERRIDE\n   EXEC sp_configure 'xp_cmdshell', 1\n   EXEC sp_configure 'ad hoc distributed queries', 1  \n   RECONFIGURE WITH OVERRIDE\n\nselect 1\n</code></pre>\n\n<p>Procedure #2: </p>\n\n<pre><code>create proc [dbo].[test_nz_tb3]\nas\n    create table #t (a varchar(2))\n\n    insert into #t\n           exec nz_test1\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":233,"score":4,"question_id":12134305,"title":"Combine multiple rows into one in SQL","body":"<p>In sql server 2008, I have a table that has the columns [a],[b],[c],[sort] and it has 4 records:</p>\n\n<pre><code>1,      NULL,  NULL    0\nNULL,   2,     NULL    1\nNULL,   NULL,  3       2\n10,     NULL,  NULL    3\n</code></pre>\n\n<p>I need to combine all the rows in a way that i get one row as a result, and for each column I get the first (ordered by sort column) non-null value. So my result should be:</p>\n\n<pre><code>1,      2,     3\n</code></pre>\n\n<p>Can anyone suggest how to do this?\nThanks</p>\n"},{"tags":["c#","sql","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":120,"score":1,"question_id":12133389,"title":"Transaction Foreign Key Causes: \"INSERT statement conflicted with the FOREIGN KEY constraint\"","body":"<p>How can I prevent the below error when executing a SQL Server transaction?</p>\n\n<p>I'm trying to add a <code>SupplierOrder</code> and a <code>VehicleRecord</code> into a set of two database tables. I'm using the following:</p>\n\n<h3>Table SQL Structure:</h3>\n\n<pre><code>CREATE TABLE VSI_VehicleRecords\n(\n    VehicleRecordID INT IDENTITY(1,1) PRIMARY KEY,\n    StockNumber INT NOT NULL,\n    Status INT NOT NULL,\n    Make VARCHAR(50) NOT NULL,\n    Model VARCHAR(50) NOT NULL,\n    Colour VARCHAR(50) NOT NULL,\n    Spefication VARCHAR(255) NOT NULL\n)\n\nCREATE TABLE VSI_SupplierOrders\n(\n    SupplierOrderID INT IDENTITY(1,1) PRIMARY KEY,\n    VehicleRecordID INT FOREIGN KEY REFERENCES VSI_VehicleRecords(VehicleRecordID) UNIQUE,\n    Timestamp\n)\n</code></pre>\n\n<p>I've written a utility method which runs a set of Sql queries as a transaction:</p>\n\n<h3>C# Execution of a transaction:</h3>\n\n<pre><code>    SqlTransaction _Transaction;\n    OpenConnection();\n\n    _Transaction = __Connection.BeginTransaction();\n\n    try\n    {\n        for (int i = 0; i &lt; Commands.Length; i++)\n        {\n            Commands[i].Connection = __Connection;\n            Commands[i].Transaction = _Transaction;\n            Commands[i].ExecuteNonQuery();\n        }\n        _Transaction.Commit();\n        return true;\n    }\n    catch (SqlException e)\n    {\n        _Transaction.Rollback();\n    }\n</code></pre>\n\n<h3>SQL commands to be executed by the above function:</h3>\n\n<pre><code>    SqlCommand[] _Commands = new SqlCommand[2];\n\n    string _InsertVehicleQuery = \"INSERT INTO VSI_VehicleRecords(StockNumber,Status,Make,Model,Colour,Spefication) VALUES (@StockNumber, @Status, @Make, @Model, @Colour, @Specification);\";\n\n    SqlCommand _InsertVehicleCommand = new SqlCommand(_InsertVehicleQuery);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@StockNumber\", __StockNumber);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@Status\", __Status);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@Make\", Make);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@Model\", Model);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@Colour\", Colour);\n    _InsertVehicleCommand.Parameters.AddWithValue(\"@Specification\", Specification);\n\n    _Commands[0] = _InsertVehicleCommand;\n\n    string _InsertSupplierOrderQuery = \"INSERT INTO VSI_SupplierOrders(VehicleRecordID) VALUES (@VehicleRecordID);\";\n    SqlCommand _InsertSupplierOrderCommand = new SqlCommand(_InsertSupplierOrderQuery);\n    _InsertSupplierOrderCommand.Parameters.AddWithValue(\"@VehicleRecordID\", _VehicleRecordID);\n\n    _Commands[1] = _InsertSupplierOrderCommand;\n\n    DataUtility.NonQueryTransaction(_Commands);   \n</code></pre>\n\n<p>However I get the following error:</p>\n\n<blockquote>\n  <p>*The INSERT statement conflicted with the FOREIGN KEY constraint \"FK__VSI_Suppl_<em>Vehic</em>_5165187F\". The conflict occurred in database\n  \"jack_test\", table \"dbo.VSI_VehicleRecords\", column 'VehicleRecordID'.*</p>\n</blockquote>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":75,"score":5,"question_id":12110836,"title":"Update with CTE and row-numbers as sequence","body":"<p>I have a table named <code>Site</code> with columns <code>Name</code>, <code>SiteId</code> and <code>Sequence</code>. I would like to fill the <code>Sequence</code> field with the rownumber. I've tried the following query, but it just doesn't update the records:</p>\n\n<pre><code>WITH RowNumbers AS \n(\n    select   SiteId,\n             RowNum = row_number() OVER ( order by SiteId )\n    from     [Site] \n)\nUPDATE  s\nSET     s.[Sequence] = r.RowNum\nFROM    [Site] as s INNER JOIN RowNumbers as r ON s.SiteId = r.Row\n</code></pre>\n\n<p>What am I doing wrong?</p>\n"},{"tags":["sql","sql-server","database","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":121,"score":0,"question_id":12129520,"title":"How to run SQL Server stored procedure query for each value of a CSV","body":"<p>I am having following stored procedure in my SQL Server 2008 R2 database</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[usp_send_email] \n    @pStatus Int Out,\n    @pEMailId Int Out,\n    @pSenderUserName varchar(MAX),  \n    @pReceivers VarChar(50),         **-- this column can have csv values**\n    @pSub NVarChar(100),\n    @pCon NVarchar(MAX),\n    @pHasAttachments Bit\nAS\nBEGIN\n   --SET NOCOUNT ON;\n\n   Insert Into MessagingMessage\n      (\n       CreatedBy,\n       [Subject],\n       Body,\n       HasAttachments\n      )\n     Values\n     (    \n      @pSenderUserName,\n      @pSub,\n      @pCon,\n      @pHasAttachments\n      )\n    SET @pEMailId = SCOPE_IDENTITY()  \n\n     Insert Into MessagingMessageReceipient\n      (\n       MessageId,\n       ReceipientId,\n       ReceipientType\n      )\n     Values\n     (    \n      @pEMailId,\n      @pReceivers,\n      1\n      )\n     SET @pStatus  = SCOPE_IDENTITY() \n\nEND\n</code></pre>\n\n<p>In above code I want to run the first statement only one time but second insert statements in loop for each comma separated username.CSV value coming as a parameter is already validated by C# code so no need to validate it.</p>\n"},{"tags":["sql-server","tsql","random"],"answer_count":3,"favorite_count":4,"up_vote_count":14,"down_vote_count":0,"view_count":6984,"score":14,"question_id":191342,"title":"Random record from a database table (T-SQL)","body":"<p>Is there a succinct way to retrieve a random record from a sql server table?  </p>\n\n<p>I would like to randomize my unit test data, so am looking for a simple way to select a random id from a table.  In English, the select would be \"Select one id from the table where the id is a random number between the lowest id in the table and the highest id in the table.\"  </p>\n\n<p>I can't figure out a way to do it without have to run the query, test for a null value, then re-run if null.</p>\n\n<p>Ideas?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":51,"score":0,"question_id":12123211,"title":"Function returning table. Want to compare each row with different table","body":"<p>I have one table named <code>Document</code>. I have 2 columns inside that: <code>Inventor</code> and <code>Attorney</code>. I want to find out rows that have Attorney = Inventor.</p>\n\n<p>Sample data that fit the \"definition\" of Attorney = Inventor are:</p>\n\n<pre><code>Inventor: Tom Kaufmann\nAttorney: Tom Kaufmann\n\nInventor: Kaufmann\nAttorney: Kaufmann; Tom\n\nInventor: Kaufmann; T\nAttorney: Kaufmann; Tom\n\nInventor: Kaufmann; Tom\nAttorney: Kaufmann; T\n\nInventor: Kaufmann; Tom, Somi; Jack\nAttorney: Kaufmann; Tom\n\nInventor: Kaufmann; Tom,\nAttorney: Kaufmann; Tom, Somi; Jack\n</code></pre>\n\n<p>For all of the above cases we can say attorney = inventor. How do I compare it? I do have a split function (Table valued function) that can basically split data based on delimeter and return. I am thinking I should split the names and then create cursors to process each row and compare it with other row. But that would result in too many cursors and can get messy. Does anybody have any better way of comparing these data? I hope you got my question. If not, please let me know.</p>\n"},{"tags":["tsql","variables","ssas","dataview"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":86,"score":1,"question_id":12116748,"title":"SSAS Data Source View Variable","body":"<p>I'm trying to use \"New Named Query\" to add a table in Data Source View in SSAS. The script is shown as follows:</p>\n\n<pre><code>Declare @AvgInvestment float;\nSELECT  @AvgInvestment=SUM(Investment)/COUNT(distinct meta_ID)\nFROM AAAA\n\n\n\nSELECT        Player, Investment, \n              InvestmentRange=\n              Case When Investment &gt;=0 AND  Investment &lt;(@AvgInvestment/3)                       THEN 1\n                   When Investment &gt;=(@AvgInvestment/3) AND  Investment &lt;(4*@AvgInvestment/3)    THEN 2                           \n                   When Investment &gt;=(4*@AvgInvestment/3) AND  Investment &lt;(6*@AvgInvestment/3)  THEN 3                         \n                   When Investment &gt;=(2*@AvgInvestment)                                          THEN 4\n             END                              \nFROM  AAAA \n</code></pre>\n\n<p>However, SSAS does not allow declare variables in SQL Query for DVS.  Is there any possible way to modify the SQL statement to have no variables?  I tried to replace @AvgInvestment as \"SELECT SUM(Investment)/COUNT(distinct meta_ID) FROM AAAA\" , but it's not working. </p>\n\n<p>Thanks for any possible solutions!</p>\n"},{"tags":["sql-server-2008","excel","tsql","text","import"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":90,"score":1,"question_id":12117738,"title":"how to import 2 row from txt or EXCEL into the same ROW in SQL server","body":"<p>I need to extract information from a page I have access to.</p>\n\n<p>Just in this module, I have no means to export, but just to copying and pasting the information</p>\n\n<p>Looks like this in the same l</p>\n\n<p><pre>1. MANUF   MODEL   YEAR MFG    SERIAL      REG     OS DATE     DESC        LISTED</pre><pre>1.                 YEAR DLV                    </pre>\n<pre>2. monster 4r25    1988        23547248    Waka001 7/23/2012   For sale    7/22/2009</pre><pre>2.                 1989                 </pre>\n<pre>3. FORD    12SE    1994        6262552     DBZRLZ0 7/26/2012   For sale    7/9/2009</pre><pre>3.                 1994                  </pre></p>\n\n<p>I'm getting my data in rows, but the year mfg and year dlv is in 2 rows within one row (or 2 rows in the same field). When pasted on excel it makes 2 rows first with all the data in the row including year mng and a second row just for year dlv (in the same column).</p>\n\n<p>I can parse this information in excel by adding extra column and coping that extra field and deleting blanks and so on. But I want to omit the excel part and import this from a TXT file which when pasted creates 2 rows per row as well and using tabs as delimiter (like txt text tab delimited).</p>\n\n<p>When I import with bulk insert, it imports twice as much rows, but I can't imagine a way to parse this second row into a new column. </p>\n\n<p>Can someone help with this? In t-sql (every row has only one row of info, but in the column year mfg /year dlv, comes with two rows).\nOr point me on what to read or which would be a better approach? Maybe importing 2 rows at once ETC.</p>\n"},{"tags":["sql-server","tsql","select"],"answer_count":6,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":140,"score":0,"question_id":10940444,"title":"SQL Server - Nested query takes 40 minutes to run","body":"<p>I have a very large web forum application (about 20 million posts since 2001) running from a SQL Server 2012 database. The data files are about 40GB in size.</p>\n\n<p>I added indexes to the tables for appropriate fields, however this query (which reveals the date range of posts in each forum) takes about 40 minutes to run:</p>\n\n<pre><code>SELECT\n    T2.ForumId,\n    Forums.Title,\n    T2.ForumThreads,\n    T2.ForumPosts,\n    T2.ForumStart,\n    T2.ForumStop\n\nFROM\n    Forums\n    INNER JOIN (\n\n    SELECT\n        Min(ThreadStart) As ForumStart,\n        Max(ThreadStop) As ForumStop,\n        Count(*) As ForumThreads,\n        Sum(ThreadPosts) As ForumPosts,\n        Threads.ForumId\n    FROM\n        Threads\n        INNER JOIN (\n\n            SELECT\n                Min(Posts.DateTime) As ThreadStart,\n                Max(Posts.DateTime) As ThreadStop,\n                Count(*) As ThreadPosts,\n                Posts.ThreadId\n            FROM\n                Posts\n            GROUP BY\n                Posts.ThreadId\n\n        ) As P2 ON Threads.ThreadId = P2.ThreadId\n\n    GROUP BY\n        Threads.ForumId\n\n) AS T2 ON T2.ForumId = Forums.ForumId\n</code></pre>\n\n<p>How could I speed it up?</p>\n\n<p>UPDATE: </p>\n\n<p>This is the Estimated Execution Plan, from right-to-left:</p>\n\n<pre><code>[Path 1]\n\nClustered Index Scan (Clustered) [Posts].[PK_Posts], Cost: 98%\nHash Match (Partial Aggregate), Cost: 2%\nParallelism (Repartition Streams), Cost: 0%\nHash Match (Aggregate), Cost 0%\nCompute Scalar, Cost: 0%\nBitmap (Bitmap Create), Cost: 0%\n\n[Path 2]\n\nIndex Scan (NonClustered) [Threads].[IX_ForumId], Cost: 0%\nParallelism (Repartition Streams), Cost: 0%\n\n[Path 1 and 2 converge into Path 3]\n\nHash Match (Inner Join), Cost: 0%\nHash Match (Partial Agregate), Cost: 0%\nParallelism (Repartition Streams), Cost: 0%\nSort, Cost: 0%\nStream Aggregate (Aggregate), Cost: 0%\nCompute Scalar, Cost: 0%\n\n[Path 4]\nClustered Index Seek (Clustered) [Forums].[PK_Forums], Cost: 0%\n\n[Path 3 and 4 converge into Path 5]\n\nNested Loops (Inner Join), Cost: 0%\nParalleism (Gather Streams), Cost: 0%\nSELECT, Cost: 0%\n</code></pre>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":767,"score":2,"question_id":2918623,"title":"How to check dates don't overlap in a table using TSQL","body":"<p>I have a table with start and finish datetimes that I need to determine if any overlap and not quite sure the best way to go.</p>\n\n<p>Initially I was thinking of using a nested cursor as shown below which does work, however I'm checking the same records against each other twice and I'm sure it is not very efficient.</p>\n\n<p>eg: this table would result in an overlap.</p>\n\n<pre><code>id  start                       end\n-------------------------------------------------------\n1   2009-10-22 10:19:00.000     2009-10-22 11:40:00.000\n2   2009-10-22 10:31:00.000     2009-10-22 13:34:00.000\n3   2009-10-22 16:31:00.000     2009-10-22 17:34:00.000\n\nDeclare @Start datetime, @End datetime, @OtherStart datetime, @OtherEnd datetime, @id int, @endCheck bit\n\nSet @endCheck = 0\n\nDECLARE Cur1 CURSOR FOR\n        select id, start, end from table1 \n\nOPEN Cur1\nFETCH NEXT FROM Cur1 INTO @id, @Start, @End\nWHILE @@FETCH_STATUS = 0 AND @endCheck = 0\nBEGIN\n    -- Get a cursor on all the other records\n    DECLARE Cur2 CURSOR FOR\n            select start, end from table1 \n                and id != @id AND start &lt; @end\n    OPEN Cur2\n    FETCH NEXT FROM Cur2 INTO @OtherStart, @OtherEnd\n    WHILE @@FETCH_STATUS = 0 AND @endCheck = 0\n    BEGIN\n\n            if ( @Start &gt; @OtherStart AND @Start &lt; @OtherEnd    OR\n                 @End &gt; @OtherStart AND @End &lt; @OtherEnd )\n                or\n               ( @OtherStart &gt; @Start AND @OtherStart &lt; @End    OR\n                 @OtherEnd &gt; @Start AND @OtherEnd &lt; @End )\n\n            BEGIN\n                SET @endCheck = 1\n            END\n\n            FETCH NEXT FROM Cur2 INTO @OtherStart, @OtherEnd\n    END\n    CLOSE Cur2\n    DEALLOCATE Cur2\n\n    FETCH NEXT FROM Cur1 INTO @id, @Start, @End\nEND\nCLOSE Cur1\nDEALLOCATE Cur1\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":1824,"score":0,"question_id":10921400,"title":"T-SQL substring - separating first and last name","body":"<p>I have a column which has FirstName and LastName together. I'm writing a report to separate the FirstName And LastName. How do I get the FirstName and LastName separated in T-SQL?</p>\n"},{"tags":["visual-studio-2010","tsql","code-snippets"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":42,"score":0,"question_id":12116447,"title":"Snippet Designer that allows for keyword replacement Visual Studio 2010 SQL","body":"<p>I am currently trying to use <a href=\"http://snippetdesigner.codeplex.com/\" rel=\"nofollow\">Snippet Designer</a> to speed up my development. I am either missing how to best leverage it or missing a feature that I need. I am looking for assistance accomplishing the following through a snippet.</p>\n\n<p>I create many Tables that follow a pattern and want to somewhat automate it.</p>\n\n<p><em>Example SP</em></p>\n\n<pre><code>CREATE TABLE [dbo].[ObjectTable]\n(\n    ObjectID [int] IDENTITY NOT NULL,\n    ObjectName [nvarchar](256) NOT NULL\n)\n</code></pre>\n\n<p>What I'd like to be able to do is replace <code>Object</code> with the name of the table.</p>\n\n<p><em>Example</em> </p>\n\n<p><img src=\"http://i.stack.imgur.com/KTSYf.png\" alt=\"Create Table Dialog\"></p>\n\n<p><img src=\"http://i.stack.imgur.com/k78wI.png\" alt=\"Using snippet\"></p>\n\n<p><img src=\"http://i.stack.imgur.com/1BysB.png\" alt=\"After Snippet Replacement\"></p>\n\n<p>So I would like to pull the tables name, or even if I can just select <code>Person</code> text and then insert the snippet and use the selected text. Is this possible at all?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":61,"score":0,"question_id":12116134,"title":"Trigger on insert","body":"<p>How to create trigger with possibility ROUND value on insert?</p>\n\n<p>This trigger do not work :(</p>\n\n<pre><code>CREATE TRIGGER test\n   ON repaymentevents\n   AFTER INSERT\nAS\nBEGIN\n    SELECT round(value, 2) FROM Inserted \nEND\n</code></pre>\n"},{"tags":["c#","sql","winforms","tsql","maskedtextbox"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":144,"score":0,"question_id":11992418,"title":"Masked text box search and sql query","body":"<p>I have a masked textbox in c# winform.</p>\n\n<p>The masking would be like </p>\n\n<pre><code> - (two numbers on the front and 4 number on the right after the dash).\n\nfor ex: 12-3456\n</code></pre>\n\n<p>There are more permutations like</p>\n\n<pre><code>   - (3 spaces on the front and 5 on the right)\n\nfor ex: 123-34567\n</code></pre>\n\n<blockquote>\n  <p>When a user types 123-34567, the select sql query should return only</p>\n  \n  <p>123-34567</p>\n  \n  <p>When a user types 12-3456, the select sql query should return only</p>\n  \n  <p>12-3456</p>\n  \n  <p>When a user types &nbsp;&nbsp;-, the select sql query should return\n  only</p>\n  \n  <p>12-3456 (ie. two spaces typed)</p>\n  \n  <p>When a user types &nbsp;&nbsp;&nbsp;-, the select sql query should\n  return only</p>\n  \n  <p>123-34567 (ie. three spaces typed)</p>\n  \n  <p>In other words, a user can search without entering anything and have\n  only mask enabled text box and\n  search(empty - empty) - only dash mask , type number(s) on the\n  mask and search (for ex: 12- ).</p>\n</blockquote>\n\n<p>The query am using is </p>\n\n<pre><code>select column1,column2 from table1 where column2 like '%__-%';\n</code></pre>\n\n<p>(the underscores are dymanically calculated) and how do i get this in any other optimum approach (say like in a single query) ?</p>\n\n<p>Consider this table1 and having a column \"MaskedInfo\" in the database.</p>\n\n<pre><code>Table1:\n\nMaskedInfo  \n\n1234567\n12-34567\n123-4567\n123-45678\n</code></pre>\n\n<blockquote>\n  <p>User can type anything to search like 12-34567 or 123-4567 or simply\n  1234567 and if the text box is empy load everything in the result.</p>\n</blockquote>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":61,"score":2,"question_id":12113705,"title":"I'm having trouble coming up with a SQL query","body":"<p>I have 2 tables: Media and Galleries. Media contains thousands of records of different types of viral media like videos, pictures, games, etc...Galleries contains a list of gallery id's that are associated with groups of picture records from the media table.</p>\n\n<p><img src=\"http://i.stack.imgur.com/FXq57.jpg\" alt=\"My Tables\"></p>\n\n<p>Currently I have a query that will return a list of Gallery records from the Gallery table and associate a MediaThumb from that corresponding group of GalleryIds in the Media table. Here is that query:</p>\n\n<pre><code>SELECT a.GalleryID, a.GalleryTitle, a.GalleryDate, MAX(b.MediaThumb) AS MediaThumb\nFROM Galleries a\nINNER JOIN Media b\nON a.GalleryID = b.GalleryID\nGROUP BY a.GalleryID, a.GalleryTitle, a.GalleryDate\norder by a.GalleryID desc\n</code></pre>\n\n<p>What I would like to come up with now is a query that returns that list of gallery records along with all records from the Media Table where MediaTypeID = 1 or 2 or 3.</p>\n\n<p>I'm not very good at complex SQL and could use some sort of direction/help. I'm not even sure if what I want is possible. I need the previous query above to be intertwined with the records from the Media table. Hopefully some of you SQL guru's can lend a hand!</p>\n\n<p>Thx!</p>\n"},{"tags":["sql-server","tsql","sql-server-2005"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12111560,"title":"Doing self join to hide duplicates - getting error message","body":"<p>Ok, I'm doing a self query to suppress duplicates for a view. The code I'm using is:</p>\n\n<pre><code>    USE BILLING\n\n    SELECT Provider_Code,\n           Provider_LName,\n           Provider_Fname,\n           Provider_Title,\n           AGENCY_LOCATION_NAME_LINE_1,\n           CostCenter_AbbrName\n    FROM   dbo.ServiceProfiler prov1\n           INNER JOIN\n           dbo.ServiceProfiler prov2\n           ON prov1.Provider_Code = prov2.Provider_Code\n    WHERE  0 = (SELECT COUNT(s1.Provider_Code)\n                FROM   prov1\n                WHERE  prov2.Provider_Code = prov1.Provider_Code\n                       AND prov2.Provider_Code &lt; prov1.Provider_Code);\n</code></pre>\n\n<p>When executing the query on SQL Server 2005 I get the message:</p>\n\n<blockquote>\n  <p><em>Msg 208, Level 16, State 1, Line 3<br>\n  Invalid object name 'prov1'.</em></p>\n</blockquote>\n\n<p>I cannot for the life of me understand why the alias names are invalid. I think I found a similar question <a href=\"http://stackoverflow.com/questions/9762390/converting-a-self-subquery-to-a-self-join\">here</a>. But it's very generic and doesn't show a full 'real' query using the aliases.</p>\n\n<p>TIA for any help you can give.</p>\n"},{"tags":["sql-server-2008","tsql","local-variables","temp-table"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12114802,"title":"Local variable versus One-row Table","body":"<p>Is there any significant decrease in performance, or other adverse effect by using 1-row tables instead of local variables?</p>\n\n<p>instead of:</p>\n\n<pre><code>Declare @DT date = getdate()\n</code></pre>\n\n<p>use:</p>\n\n<pre><code>Select convert(date, getdate()) as DT into #DT\n</code></pre>\n\n<p>The reason I would want to do this is for code testing. When I want to run just a chunk of code, it is annoying if the code is say 100 lines down but needs several of my declarations to run.</p>\n\n<p>instead of:</p>\n\n<pre><code>Line 104     select\nLine 105        somecolumn\nLine 106     where datadate = @DT\n\n-- MUST DECLARE SCALAR @DT, EVEN THOUGH LINES 1-103 WERE PREVIOUSLY RUN\n</code></pre>\n\n<p>use:</p>\n\n<pre><code>Line 104     select\nLine 105        somecolumn\nLine 106     where datadate = (select DT from #DT)\n\n-- NO ISSUE EXECUTING ONLY THESE 3 LINES, SINCE LINES 1-103 WERE PREVIOUSLY RUN\n</code></pre>\n\n<p>I just need to know if this is the same as far as execution time, and accuracy go. I know that the subquery will run over and over, but since #DT is one-row (and 1 column) when would things begin to lag?</p>\n"},{"tags":["sql-server","tsql","powershell","azure"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":65,"score":2,"question_id":12107588,"title":"Bulk import users into SQL Azure","body":"<p>I am looking for an easy way to create logins and associated users into SQL Azure.</p>\n\n<p>The thing is that, with Azure, one first needs to create a login in the master database.\nBased on that login I need  a user to be created in a specific database  (<code>DATABASE1</code>)</p>\n\n<p>After that roles need to be assigned:</p>\n\n<pre><code>CREATE LOGIN login1 WITH password='&lt;ProvidePassword&gt;';\nCREATE USER login1User FROM LOGIN login1;\nEXEC sp_addrolemember 'dbmanager', 'login1User';\nEXEC sp_addrolemember 'somerole';\n</code></pre>\n\n<p>The thing is, since one cannot use the <code>USE</code> command to switch databases, this seems to become quite a tedious task. More so because the number of accounts per database can range from ten to a few hundred, databases and users are being added all the time.</p>\n\n<p>So I need a solution that can be easily reused.</p>\n\n<p>I would like to have a script of some sorts (powershell?) that will read a file (containing username, password and databasename) and then create the appropriate logins, users and rights.....</p>\n\n<p>Icing on the cake would be some sort of job that would regularly check whether there are (new) files present in a certain folder and if so, read those files and create new accounts where needed.</p>\n\n<p>I must admit that I do have TSQL knowledge, basic programming knowledge but no Powershell experience at all. How would you advise that I go about? Is powershell the way to go? Or are there any other mechanisms I could use? </p>\n\n<p>Greetings, Henro</p>\n"},{"tags":["sql","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":31,"score":0,"question_id":12113635,"title":"Averaging a Column Twice in One Query","body":"<p>I have a table that contains the following:</p>\n\n<pre><code>ID   Node   LoadTime   DateTimeCST   Failed\n-----------------------------------------\n</code></pre>\n\n<p>I am trying to write a query that will return the following table (Node is DISTINCT).</p>\n\n<pre><code>Node    TodaysAverageLoadTime    HistoricalLoadTime\n----------------------------------------------------\n</code></pre>\n\n<p>So, I am basically trying to take an average of LoadTime for the past 24 hours, then another average of LoadTime that averages all the data that is in the table for LoadTime.  This is the query I was using to just get today's average.</p>\n\n<pre><code>SELECT DISTINCT Node, AVG(LoadTime)\nFROM dbo.Table\nWHERE Failed != 1\nAND DATEDIFF(day, DateTimeCST, GETDATE()) = 0 \nGROUP BY Node\n</code></pre>\n\n<p>What would I need to add to this query to also average LoadTime for all records?  Any help would be greatly appreciated.  Thanks. </p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","if-statement"],"answer_count":2,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":526,"score":4,"question_id":10248217,"title":"IF / ELSE depending on result of stored procedure","body":"<p>I've the following stored procedure:</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[CheckAdminExists]\n    @SID NVARCHAR(50),\n    @AdminName NVARCHAR(MAX)\nAS \n    SELECT\n        Administrator.ID\n    FROM\n        Administrator\n    WHERE\n        Administrator.SID = @SID\n        AND Administrator.Name = @AdminName\nGO\n</code></pre>\n\n<p>Now I would like to create another SP with a code like that:</p>\n\n<pre><code>IF NOT NULL (EXECUTE CheckAdminExists 'S-1','Admin')\n--do something\nELSE\n--do something else\n</code></pre>\n\n<p>What's the right syntax for doing it?</p>\n"},{"tags":["tsql","analysis"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":39,"score":0,"question_id":12112834,"title":"Isolating JOIN predicates from syscomments","body":"<p>In order to better understand all of the relationships in a database (physical and logical), I am looking to the stored procedures in order to extract the join predicates. I've got something I can work with, but its not complete. </p>\n\n<p>The goal is to have 3 columns in the result: </p>\n\n<ol>\n<li>The object name</li>\n<li>The first join predicate</li>\n<li>The second join predicate</li>\n<li><p>The join type (inner, right, left)</p>\n\n<pre><code>declare @Schema varchar(50),@SearchString   VARCHAR (10)\n\nset @SearchString = 'join';\n\nset  @Schema = 'dbo'\n\n\ndeclare @TextBuffer table \n(\nSchemaName varchar(50) NOT NULL,\nObjectName varchar(100) NOT NULL,\nOccurance int NOT NULL, \nTxt varchar(4000) NOT NULL,\nColid int\n)\n\ndeclare @Occurance table\n(\nSchemaName varchar(50)   NULL,\nObjectName varchar(100)   NULL,\nOccurance  varchar(500) \n)\n\n\n\nINSERT INTO @TextBuffer\n\nSELECT   DISTINCT SCHEMA_NAME(o.schema_id),\n                  o.name,\n                  (LEN(text) - LEN(REPLACE(text, @SearchString, ''))) / LEN(@SearchString),\n                  [text],\n                  colid\nFROM     syscomments AS c\n         INNER JOIN\n         sys.objects AS o\n         ON c.id = o.[object_id]\n         INNER JOIN\n         sys.schemas AS s\n         ON o.schema_id = s.schema_id\nWHERE    text LIKE '%' + @SearchString + '%'\n         AND SCHEMA_NAME(o.schema_id) = @Schema\nORDER BY colid, 3 DESC;\n\n\n\nDECLARE @Txt varchar(4000), @ObjectName varchar(100), @Occ int, @SchemaName varchar(100)\n\n\ndeclare @count int, @position int\nset @count = 0\nset @position = 0\n\nDECLARE my_cursor CURSOR FAST_FORWARD FOR \n\nSELECT Txt,ObjectName, Occurance, SchemaName from @TextBuffer\nOPEN my_cursor\n\nFETCH NEXT FROM my_cursor INTO @Txt,@ObjectName,@Occ,@SchemaName\n\nWHILE @@FETCH_STATUS = 0\nBEGIN\n\n    set @count =  @Occ\n\n\n    while(@count &gt; 0)\n        begin \n\n        set @position =  charindex(@SearchString,@Txt) \n\n        insert into @Occurance select @SchemaName, @ObjectName, cast(substring(@Txt, @position, len(@Txt)) as varchar(500))\n\n        set @Txt =  substring(substring(@Txt,len(@SearchString),len(@Txt)), @position, len(@Txt))\n\n\n        set @count = @count -1\n\n        end\n\n\n\nFETCH NEXT FROM my_cursor INTO @Txt,@ObjectName,@Occ,@SchemaName\nEND\n\nCLOSE my_cursor \nDEALLOCATE my_cursor \n\n\nselect * from @Occurance\n</code></pre></li>\n</ol>\n"},{"tags":["sql","sql-server","tsql","stored-procedures","lines-of-code"],"answer_count":4,"favorite_count":9,"up_vote_count":10,"down_vote_count":0,"view_count":26838,"score":10,"question_id":291574,"title":"Query to list SQL Server stored procedures along with lines of code for each procedure","body":"<p>I want a query that returns a list of all the (user) stored procedures in a database by name, with the number of lines of code for each one.</p>\n\n<p>i.e.</p>\n\n<pre><code>sp_name     lines_of_code\n--------    -------------\nDoStuff1    120\nDoStuff2    50\nDoStuff3    30\n</code></pre>\n\n<p>Any ideas how to do this?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","while-loop"],"answer_count":3,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":259,"score":6,"question_id":12110029,"title":"TSQL - While loop within select?","body":"<p>In SQL server</p>\n\n<p>Ok, so I'm working with a database table in which rows can have parent rows, which can then have parent rows of their own.  I need to select the root 'row'.  I don't know the best way to do this.</p>\n\n<p>There is a field called ParentId, which links the row to the row with that ID.  When the ParentId = 0, it is the root row.</p>\n\n<p>This is my query now:</p>\n\n<pre><code>SELECT Releases.Name,WorkLog.WorkLogId \n\nFROM WorkLog,Releases\nWHERE\nReleases.ReleaseId = WorkLog.ReleaseId\nand WorkLogDateTime &gt;= @StartDate\nand WorkLogDateTime &lt;= @end\n</code></pre>\n\n<hr>\n\n<p>I don't really need the Release Name of the child releases, I want only the root Release Name, so I want to select the result of a While loop like this:</p>\n\n<pre><code>WHILE (ParentReleaseId != 0)\nBEGIN\n@ReleaseId = ParentReleaseId\nEND\n\nSelect Release.Name\nwhere Release.RealeaseId = @ReleaseId\n</code></pre>\n\n<p>I know that syntax is horrible, but hopefully I'm giving you an idea of what I'm trying to acheive.</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12100924,"title":"How do I do merge of two tables where two dates are closest?","body":"<p>I have two tables A and B like the following. I would like to merge them by Items but only in the place where the return date is after the order date and the return date is closest to the corresponding order date for the item. The resulted table is C below. Could you please help to see how I can realize this merge in SQL code? </p>\n\n<p>The return dates are not necessary to be in the same year as the order date, but it should be assigned to the closest order date given that the return date is after the order date. For example, for item 1, return date 9/15/2009 is closest to 8/14/2009 among the three order dates for item 1, so it is assigned to 8/14/2009. Again for item 1, return date 9/15/2011 is after all the three order dates for item 1, but it is closest to 8/16/2011, so it is assigned to 8/16/2011.</p>\n\n<p>Thanks a lot!</p>\n\n<p>Table A:</p>\n\n<pre><code>Items    Order_Date\n1        8/14/2009\n1        8/15/2010\n1        8/16/2011\n2        9/10/2009\n2        9/8/2010\n2        9/12/2011\n</code></pre>\n\n<p>Table B:</p>\n\n<pre><code>Items    Return_Date\n1        9/15/2009\n1        9/15/2011\n2        10/15/2010\n2        11/15/2011\n</code></pre>\n\n<p>Final results table C:</p>\n\n<pre><code>Items        Order_Date    Return_Date\n1            8/14/2009     9/15/2009\n1            8/15/2010     NULL\n1            8/16/2011     9/15/2011\n2            9/10/2009     NULL\n2            9/8/2010      10/15/2010\n2            9/12/2011     11/15/2011\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005","unpivot"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":101,"score":0,"question_id":12108680,"title":"TSQL Select all columns without first n from function/procedure","body":"<p>I know this may sounds silly but I would like to create function that will process data from tables with different size.</p>\n\n<p>Lets say I have first table like so:</p>\n\n<pre><code>ID    IRR     M0    M1\n----------------------\n 1      0    -10     5\n 2      0    -20    10\n 3      0   -100   100\n 4      0    -10     0\n</code></pre>\n\n<p>And second table like so:</p>\n\n<pre><code>ID    IRR     M0    M1    M2\n----------------------------\n 1      0    -10     5    60\n 2      0    -20    10     0\n 3      0   -100   100   400\n 4      0    -10     0    10\n</code></pre>\n\n<p>I would like to create function that will be able to process data from both tables.</p>\n\n<p>I know that first column contains ID, second IRR, rest of columns will hold cash flow for specific month.</p>\n\n<p>Function should be able to process all columns instead of first 2 and store result in second column.</p>\n\n<p>I know that I can get all columns from specific table with:</p>\n\n<pre><code>SELECT COLUMN_NAME \nFROM INFORMATION_SCHEMA.columns \nWHERE TABLE_NAME = 'First_Table'\n</code></pre>\n\n<p>Problems begin when I would like to create function that will return those columns as rows. </p>\n\n<p>I can create function like so:</p>\n\n<pre><code>CREATE FUNCTION UnpivotRow (@TableName  varchar(50), @FromWhichColumn int, @Row int)\nRETURNS @values TABLE\n(\n    id INT IDENTITY(0, 1),\n    value DECIMAL(30, 10)\n)\n...\n</code></pre>\n\n<p>But how this function should look?</p>\n\n<p>I think that ideal for this kind of processing table should look like so:</p>\n\n<pre><code>ProjectID    TimePeriod    Value\n--------------------------------\n        1             0      -10\n        1             1        5\n        2             0      -20\n        2             1       10\n        3             0     -100\n        3             1      100\n        4             0      -10\n        4             1        0\n</code></pre>\n\n<p><strong>I need to unpivot whole table without knowing number of columns.</strong> </p>\n\n<hr>\n\n<p><strong>EDIT:</strong>\nIf this can't be done inside function, then maybe inside a procedure?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":11,"favorite_count":9,"up_vote_count":31,"down_vote_count":0,"view_count":75602,"score":31,"question_id":783726,"title":"How do I delete from multiple tables using INNER JOIN in SQL server","body":"<p>In MySQL you can use the syntax</p>\n\n<pre><code>DELETE t1,t2 \nFROM table1 AS t1 \nINNER JOIN table2 t2 ...\nINNER JOIN table3 t3 ...\n</code></pre>\n\n<p>How do I do the same thing in SQL Server?</p>\n"},{"tags":["sql-server","database","tsql","user-roles"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":4668,"score":1,"question_id":8471124,"title":"T-SQL to list all the user mappings with database roles/permissions for a Login","body":"<p>I am looking for a t-sql script which can list the databases and and the respective roles/privileges mapped for a particular user. Using SQL Server 2008 R2.</p>\n"},{"tags":["c#",".net","sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":71,"score":0,"question_id":12107685,"title":"Escape single apostrophe when using SELECT from SQL, into an array in C# then UPDATE","body":"<p>In my C# code I read in all id's of a table into a string array <code>ids[i]</code>, then update a different column in the table WHERE user_id = id[i].</p>\n\n<p>The problem occurs when the id being read(also passed back into the <code>UPDATE</code>) contains an apostrophe - '</p>\n\n<pre><code>       while (rdr.Read()\n       {\n          ids[i] = rdr.GetValue(0).ToString().Trim();\n          ids[i].Replace(\"'\", \"''\");\n          ....\n</code></pre>\n\n<p>I have also tried <code>ids[i].Replace(\"'\", \"\\'\");</code><br>\nand <code>ids[i].Replace(\"'\", \"-\");</code> but I'm sure this will throw off my WHERE as it will look for user_id \"O-Test\" as opposed to \"O'Test\".</p>\n\n<p>My UPDATE SQL is along the lines of:  </p>\n\n<pre><code> UPDATE [User]\n SET first_name = '{1}'\n WHERE [user_id] = '{2}'\n</code></pre>\n\n<p>Any ideas?</p>\n\n<p>Thanks.</p>\n"},{"tags":["c#","sql-server","tsql","ado.net","ssms"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":91,"score":0,"question_id":12103842,"title":"Executing SQL scripts via Ado.NET with the results like in SSMS","body":"<p>I have one batch file with contents like:  </p>\n\n<pre><code>@Echo Off    \ngoto skipcomments\nrem  \n:skipcomments\n\ncall setup-CIpatch-db.bat\nif not \"%UserName%\"==\"\" goto ok\n\necho You must edit setup-CIpatch-db.bat to set variables.  \necho This script no longer takes command line arguments.\ngoto end\n:ok\n\n\nif exist *.out  del *.out\n\necho CoreIssue FleetOne Maintenance Release\necho working... DO NOT CLOSE\nREM ************************************************\nREM Script in which Print Statement has been removed\nREM ************************************************\n\n\nREM ************************************************\nREM Create Scripts for Tables\nREM ************************************************\n\n\nREM ************************************************\nREM Alter Scripts for Tables\nREM ************************************************\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i AlterTablecardBacktable07312012.sql -o AlterTablecardBacktable07312012.out\n\n\n\n\n\nREM ************************************************\nREM Data Updates\nREM ************************************************\n\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i AlterDrpandCrePrimKeyCardback.sql -o AlterDrpandCrePrimKeyCardback.out\n\nREM ************************************************\nREM Performance Updates\nREM ************************************************\n\n\n\n\nREM ************************************************\nREM Security Update Scripts\nREM ************************************************\n\n\nREM ************************************************\nREM Reports scripts\nREM ************************************************\n\n\n\nREM ************************************************\nREM New or Altered Stored Procedures\nREM ************************************************\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i sp_RejectAccounts_qsel.sql -o sp_RejectAccounts_qsel.out\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i sp_RejectAccounts_sel.sql -o sp_RejectAccounts_sel.out\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i sp_GetCompanyRecordCardRequest_01Aug2012.sql -o sp_GetCompanyRecordCardRequest_01Aug2012.out\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i SPGetCreditTransactions.sql -o SPGetCreditTransactions.out\n\n\n\n\nREM ************************************************\nREM Grant.sql for new or altered SP\nREM ************************************************\n\n\nREM ************************************************\nREM Platform TranID Change Scripts\nREM ************************************************\n\n\nREM ************************************************\nREM Version number update\nREM ************************************************\nosql -S %ServerName% -d %DBName% -U %sql_login% -P %sql_passwd% -n -i version.sql -o version.out\n\n\necho All Scripts have been started \n:end\npause\n</code></pre>\n\n<p>The script executes SQL files in the same folder and generates files with the extension of '.out'. These just contain the result; the same as when we execute any query in SSMS messages window, like 1 row affected etc. After the batch file has finished executing all scripts (via ADO.net/C#), we have to check the out files for keywords like \"error\" etc.  </p>\n\n<p>Now I have been given task to automate this and here is what I am doing:<br>\nFetch the .SQL file name in tha batch file and execute them using SqlConnection, SqlCommand etc. The problem is that when the query has any error in it, an exception is thrown. What I need is that the query should execute whatsoever and I should be able to get the results. (like 1 row affected etc). Like in SSMS, when we execute any bad query, it executes and show the error in the Messages Pane.  </p>\n\n<p>Can anyone guide me ?</p>\n"},{"tags":["tsql","sql-server-2005"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":69,"score":1,"question_id":12104893,"title":"Transaction for sql query stored in temp table","body":"<p>I have a stored procedure build update query and store in temp table each time in loop. </p>\n\n<p>Total query built UNKNOWN (2 to 4)</p>\n\n<p>How can I put multi query in a transaction?</p>\n\n<p>For example, temp table contains following rows in column <code>EXPSQL</code> (<code>nvarchar</code>)</p>\n\n<pre><code>id   EXPSQL\n1    Update tableA SET Name = 'Test' WHERE id=1\n2    Update tableB SET Name = 'Test2' WHERE id=10\n</code></pre>\n\n<p>How can I begin a transaction for a loop to exec above query? or is there any other way?</p>\n\n<pre><code>while @id &lt; total\nbegin\n    set @id = @id +1\n    select @SQL = EXPSQL FROM #TEMPTABLE WHERE id=@id\n    EXEC (@SQL)\nend\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["tsql","sybase","ibatis"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":82,"score":1,"question_id":12075748,"title":"Sybase view query - hardcoded value works but variable fails","body":"<p>Does anyone know why this works in approx 1 sec:</p>\n\n<pre><code>select Q.USR_LOAD_NBR from QUAD0066..QTS_LOAD_INFO Q where Q.KY_TO_STP = 2142870\n</code></pre>\n\n<p>but this takes more than 10 secs (and up to 5 minutes):</p>\n\n<pre><code>declare @groupId int\nset @groupId = 2142870\nselect Q.USR_LOAD_NBR from QUAD0066..QTS_LOAD_INFO Q where Q.KY_TO_STP = @groupId\n</code></pre>\n\n<p>I'm having the exact same problem with ibatis with this query, except ibatis is timing out in like 15 seconds and causing my code to fail. ( less than 1 sec hard-coded, time-out with int parameter)</p>\n"},{"tags":["tsql","sql-server-2008-r2"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":44,"score":0,"question_id":12103565,"title":"Composing SQL insert statement into another insert statement","body":"<p>I know that in T-SQL (Server 2008 R2) I can use the 'Output' keyword to get the Id of a row I just inserted. For example, I can do</p>\n\n<pre><code>insert into [Membership].[dbo].[User] (EmailAddress) \noutput Inserted.UserId \nvalues('testUser1@test.com')\n</code></pre>\n\n<p>Is there any way of composing this into another insert? For example, lets say I want to add a new user and immediately add that user to a <code>UserRole</code> table which maps the <code>UserId</code> to a <code>RoleId</code>.</p>\n\n<p>Basically, I would like to do something like below.</p>\n\n<pre><code>insert into UserRole (RoleId, UserId) \nvalues \n(\n    1, \n    insert into [Membership].[dbo].[User] (EmailAddress) \n    output Inserted.UserId values('testUser1@test.com')\n)\n</code></pre>\n\n<p>But I can't seem to get this to work. I tried wrapping the internal insert in brackets () or using a select * from () etc.</p>\n\n<p>What am I missing? Is this composition even possible?</p>\n\n<p>Thanks for the help.</p>\n\n<p>Regards,</p>\n"},{"tags":["sql-server-2008","tsql","script","jobs","sql-server-agent"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12093438,"title":"scheduled execution of all TSQL scripts in a folder","body":"<p>I have a bunch of TSQL scripts that need to be executed on a daily basis.\nI know I can use Job Agent to execute them but that requires me to change the actual job.</p>\n\n<p>What I would like to do is create a job that simply says: </p>\n\n<pre><code>execute all TSQL-scripts in &lt;some folder&gt;\n</code></pre>\n\n<p>A bonus would be if a filter could be used based on the filename of the script: So that one job would execute all the files whose name start with a 'd', another job would execute all those with a 'w' in the name.</p>\n\n<p>Can this be done? How can this be done? </p>\n\n<p>I read some things that spoke of using the Windows-scheduler to run the SQLCMD-utility.\nI'd rather have the SQL Server do the scheduling and executing. Is Powershell the way to go? If so, where and how to start? (Never had to use it so never gave it much attention :/)</p>\n\n<p>Thanks for thinking with me!</p>\n\n<p>Henro</p>\n"},{"tags":["mysql","sql","tsql","sybase","sybase-ase"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":312,"score":1,"question_id":8230712,"title":"MYSQL group_concat equivalent in Sybase ASE?","body":"<p>Is there a equivalent function in Sybase ASE to the group_concat of MYSQL?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":95,"score":0,"question_id":12098281,"title":"Dynamic insert procedure","body":"<p>I have a dynamic insert procedure. Actually im trying to create all procedures with one button with C#. Anyway, I created that insert procedure but if isActive is null it look like that. So sql server gives an error. Is there any way to replace this coma(,) char? Or any suggestion?</p>\n\n<pre><code>INSERT INTO category (  mainCatId,  catname, isActive, ) VALUES (  @mainCatId,  @catname, @isActive,  )\n</code></pre>\n\n<p>It looks like that.</p>\n\n<pre><code>declare @mainCatId int = 1, @catname nvarchar (50) = NULL, @isActive bit = NULL\n\nDECLARE @sqlQuery nvarchar(4000); \nSET @sqlQuery =     'INSERT INTO category ( ';\n\nIF ( @mainCatId IS NOT NULL )\n SET @sqlQuery = @sqlQuery + ' mainCatId, ';\n\nIF ( @isActive IS NOT NULL )\n SET @sqlQuery = @sqlQuery + ' isActive, ';\n\nSET @sqlQuery = @sqlQuery + ' )';\n\nSET @sqlQuery = @sqlQuery + ' VALUES ( ';\n\nIF ( @mainCatId IS NOT NULL )\n SET @sqlQuery = @sqlQuery + ' @mainCatId, ';\n\nIF ( @catname IS NOT NULL )\n SET @sqlQuery = @sqlQuery + ' @catname, ';\n\nIF ( @isActive IS NOT NULL )\n SET @sqlQuery = @sqlQuery + ' @isActive, ';\n\nSET @sqlQuery = @sqlQuery + ' )';\nSET @sqlQuery = @sqlQuery;\n</code></pre>\n"},{"tags":["tsql","sql-server-2008-r2","sp-send-dbmail"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":88,"score":0,"question_id":12096572,"title":"dbo.sp_send_dbmail and HTML when one email SPROC calls existing SPROC","body":"<p>I want to build HTML and use sp_send_dbmail to send it. \nOption C on this page explain how to do that. \n<a href=\"http://msdn.microsoft.com/en-us/library/ms190307.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms190307.aspx</a></p>\n\n<p>But here's my catch. I have created a stored proc called AbcStats. Quite often, I go to SSMS and just do \"exec ABCStats\" with no email, and just want to see the result set in the datagrid on the screen.  I have set some of my own criteria that rates the results as \"Good\" or \"Bad\", and that stored proc returns 1 when anything is Bad and 0 when all is Good. </p>\n\n<p>I then created a SQL agent job that runs Sproc JobAbcAlert as shown below: </p>\n\n<pre><code>ALTER Procedure \n[dbo].[JobAbcAlert] \n(\n   @SendEmailOnlyOnError bit = 1 \n   )\nas\nbegin\n\n\nDECLARE @Status int \nDECLARE @BoolSendEmail bit = 0 \nDECLARE @emailSubject varchar(100) = 'BizTalk Feed Status - Good' \n\n-- Call Stored Proc first time to find out if status is \"GOOD\" or \"BAD\"\n-- which is used to determine if email is sent, and what is subject of email \n\nEXEC @status = AbcStats @report='short'  -- faster to run with \"short\" report option \n\nif @status = 1  -- (0=all good, 1=at least one \"BAD\" encountered)  \n   Begin\n      print 'BAD status, setting email subject' \n      SET @emailSubject = 'QT PRODUCTION ISSUE: BizTalk Feed Status - CRITICAL - contact BizTalk team ' \n   End \n\nif @status = 1 or @SendEmailOnlyOnError = 0  \n   Begin\n      SET @BoolSendEmail = 1 \n   End \n\nif @BoolSendEmail = 1 \n   Begin\n        print 'sending email' \n        EXEC msdb.dbo.sp_send_dbmail \n            @profile_name = 'DoNotReply@SomeCompany.com',     \n            @recipients = 'MyPeeps@SomeCompany.com',     \n            @subject = @emailSubject,\n            @query = 'exec abcStats @report=''full'';',\n            @append_query_error = 1,\n            @query_result_separator = ' ' \n\n        /* SMS not yet working */ \n        /*\n       TODO Send a short text email that can be forwarded to SMS        \n        */ \n    End \n\n\nend     \n</code></pre>\n\n<p>I'm trying to not rewrite code.  The abcStats is 300 lines of code and may grow to contain other useful alerts. </p>\n\n<p>If I create the HTML in abcStats, then running it SMS will not be as useful. \nCan I take the result set and wrap it in HTML in the jobAbcStats? \nWhat if I rewrite abcStats to be a Table Function, then I could put the HTML in jobAbcStats?  The HTML formatting only needs to be done for the email. </p>\n\n<p>My previous post somewhat related: \n<a href=\"http://stackoverflow.com/questions/12075592/alternative-and-best-ways-to-format-sql-query-for-phone-alert-messages\">Alternative and Best ways to format SQL query for phone alert messages</a> </p>\n"},{"tags":["sql","query","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12059154,"title":"Merging a temp table with select query","body":"<p>I want to add the TempTable column 'Rad' into the select query shown below:</p>\n\n<p>Table : TempTable</p>\n\n<pre><code>Date        Rad.\n----------------------\n2012-08-09  610.345802\n2012-08-10  589.090580\n2012-08-11  525.193952\n2012-08-12  518.484953\n2012-08-13  251.790038\n2012-08-14  461.892979\n</code></pre>\n\n<p>Table : Daily</p>\n\n<pre><code>Date        Time      Precipitation   WindChill  DewPoint\n----------------------------------------------------------\n2012-08-09  00:00:00  0.000273        27.844708  19.1826\n2012-08-09  00:10:00  0.697821        25.311829  19.2645\n2012-08-09  00:20:00  2.097455        27.968444  19.4142\n2012-08-09  00:30:00  1.033763        25.705078  19.3842\n2012-08-09  00:40:00  1.008760        26.343726  19.4563\n2012-08-09  00:50:00  0.973456        26.869532  19.5293\n.\n.\n.        \n</code></pre>\n\n<p>Table : Expected Result</p>\n\n<pre><code>Date        Rad.        Precipitation  WindChill  DewPoint\n----------------------------------------------------------\n2012-08-09  610.345802  0.005789       28.903764  19.9802\n2012-08-10  589.090580  0.763590       27.903685  19.7265\n2012-08-11  525.193952  0.998734       24.574824  19.4351\n2012-08-12  518.484953  0.334567       29.909372  20.4865\n2012-08-13  251.790038  0.789032       27.902474  18.7653\n2012-08-14  461.892979  0.123567       26.987688  18.9876\n</code></pre>\n\n<p>with this query,</p>\n\n<pre><code>SELECT Daily.[Date],    \n       AVG(Daily.[Precipitation]) as [Precipitation],\n\n       ##TempTable.[Rad.],\n\n       AVG(Daily.[Wind Chill]) as [Wind Chill], \n       AVG(Daily.[Dew Point]) as [Dew Point]\nFROM Daily\nINNER JOIN ##TempTable\nON DAY(Daily.[Date]) = DAY(##TempTable.[Date])\nGROUP BY Daily.[Date], ##TempTable.[Rad.]\n</code></pre>\n\n<p><strong>The problem is that the query result is not 'matching' or synchronized correctly with both tables. Thus, is throwing me 14 rows instead of 6.</strong></p>\n\n<p>Current Result:</p>\n\n<pre><code>Date    Rad.            Date            Precipitation   Wind Chill  Dew Point\n------------------------------------------------------------------------------------\n2012-08-18  541.917573  2012-08-18  0.000000    1.460818    NULL\n2012-08-12  518.484953  2012-08-12  0.000273    1.854153    NULL\n2012-08-17  327.291210  2011-08-17  0.000000    0.000000    18.453193\n2012-08-15  428.649430  2012-08-15  0.000536    1.170602    NULL\n2012-08-09  610.345802  2012-08-09  0.000014    1.008784    NULL\n2012-08-10  589.090580  2012-08-10  0.000000    1.402685    NULL\n2012-08-13  251.790038  2012-08-13  0.000882    0.691585    NULL\n2012-08-18  541.917573  2011-08-18  0.000000    0.000006    17.041953\n2012-08-16  536.200291  2012-08-16  0.000028    1.120068    NULL\n2012-08-19  597.631053  2011-08-19  0.000000    0.000006    16.056780\n2012-08-19  597.631053  2012-08-19  0.000000    1.565405    NULL\n2012-08-14  461.892979  2012-08-14  0.000390    1.196409    NULL\n2012-08-17  327.291210  2012-08-17  0.001301    0.886275    NULL\n2012-08-11  525.193952  2012-08-11  0.000000    2.076477    NULL\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":7,"down_vote_count":0,"view_count":2902,"score":7,"question_id":1167885,"title":"Update SQL with consecutive numbering","body":"<p>I want to update a table with consecutive numbering starting with 1. The update has a where clause so only results that meet the clause will be renumbered.  Can I accomplish this efficiently without using a temp table?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":54,"score":1,"question_id":12097391,"title":"What tables were accessed last","body":"<p>I want to know the top N tables that were accessed. I only got for databases and most of the links in google address last date access for a particular table.</p>\n\n<pre><code>SELECT DatabaseName, MAX(LastAccessDate) LastAccessDate\nFROM\n    (SELECT\n        DB_NAME(database_id) DatabaseName\n        , last_user_seek\n        , last_user_scan\n        , last_user_lookup\n        , last_user_update\n    FROM sys.dm_db_index_usage_stats) AS PivotTable\nUNPIVOT \n    (LastAccessDate FOR last_user_access IN\n        (last_user_seek\n        , last_user_scan\n        , last_user_lookup\n        , last_user_update)\n    ) AS UnpivotTable\nGROUP BY DatabaseName\nHAVING DatabaseName NOT IN ('master', 'tempdb', 'model', 'msdb')\nORDER BY 2\n</code></pre>\n\n<p>Now I need this for tables. Any idea or link, please?</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":80,"score":2,"question_id":12076332,"title":"Interleaving values in single column of resultset","body":"<p>Suppose we have values like this in 2 columns of the SQL table</p>\n\n<pre><code>HM        BOX_NO\n\nA          1\nA          2\nB          2\nB          3\nC          3\n</code></pre>\n\n<p>I would like to output these table values like written below\nHow can I do that? </p>\n\n<pre><code>A\n1\n2\nB\n2\n3\nC\n3\n</code></pre>\n"},{"tags":["xml","tsql","xpath","xml-parsing"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":29,"score":1,"question_id":12095981,"title":"How do I get the Data out of this XML in TSQL","body":"<p>In a sql query i run these commands and i keep getting NUll no matter what i try.</p>\n\n<pre><code>DECLARE @x AS XML\n\nSET @x = ' &lt;Data&gt; &lt;Preference&gt;Mail&lt;/Preference&gt;   &lt;Comment&gt;Changed Contact Communication Preference due to customer unsubscribed&lt;/Comment&gt;  &lt;/Data&gt; '\n\n\nSELECT @x.value('(//Data/@Preference)[0]','varchar(20)') AS Preference\n</code></pre>\n\n<p>what am i doing wrong?</p>\n"},{"tags":["sql-server-2008","query","tsql","subquery","queryanalyzer"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":66,"score":-1,"question_id":12088724,"title":"MS SQL 2008 R2 Queryanalyzer successful run in the code. Failed SQL code field within the LOGO application is running","body":"<p>Hi programmers and developers,</p>\n\n<p>MS SQL 2008 R2 Queryanalyzer successful run in the code. Failed SQL code field within the LOGO application is running.</p>\n\n<p>Error :   </p>\n\n<pre><code>\" The order by clause is invalid in views, inline functions,derived tables,subqueries and common table expressions,unless TOP or FOR XML is also specified\"\n</code></pre>\n\n<p>This will be displayed in a monospaced font. The first four spaces\n    will be stripped off, but all other whitespace will be preserved.</p>\n\n<p>My Code :</p>\n\n<pre><code>printf(\"goodbye world!\");  /* his suicide note\n                              was in C */\n\nSELECT PLN.[DATE_] AS 'TARH',\n          CC.DEFINITION_ AS 'Cari Kodu',\n          TANA.DONEM AS 'MNL_Dnem',\n          CASE \n        WHEN TANA.Oda_Tipleri='1' THEN 'Tek Kiilik'\n        WHEN TANA.Oda_Tipleri='2' THEN '2 kiilik'\n        WHEN TANA.Oda_Tipleri='3' THEN '3 kiilik'\n        WHEN TANA.Oda_Tipleri='4' THEN '4 kiilik'\n        WHEN TANA.Oda_Tipleri='5' THEN '2 kiilik odada TEK kii'\n        WHEN TANA.Oda_Tipleri='6' THEN '3 kiilik odada 2 kii'\n    ELSE 'SELMEM'\n END 'Oda_Tipi',\nCASE        WHEN TANA.Oda_Ozellik= '1'      THEN 'Da Bakan Oda ' \n        WHEN TANA.Oda_Ozellik= '2'  THEN 'Kurangleze Bakan Oda ' \n        WHEN TANA.Oda_Ozellik= '3'  THEN 'e Bakan Oda ' \n        WHEN TANA.Oda_Ozellik= '4'  THEN 'Arkaya Bakan Oda '\n        WHEN TANA.Oda_Ozellik= '5'  THEN 'ne Bakan Oda '\n    ELSE 'SELMEM'\nEND Oda_Ozellik,\n\nCASE\n        WHEN TANA.Sene_Bilgisi = '1' THEN '2011/2012 ' \n        WHEN TANA.Sene_Bilgisi = '2' THEN '2012/2013 ' \n        WHEN TANA.Sene_Bilgisi = '3' THEN '2013/2014 ' \n        WHEN TANA.Sene_Bilgisi = '4' THEN '2014/2015 ' \n        WHEN TANA.Sene_Bilgisi = '5' THEN '2015/2016 ' \n        WHEN TANA.Sene_Bilgisi = '6' THEN '2016/2017 ' \n        WHEN TANA.Sene_Bilgisi = '7' THEN '2017/2018 ' \n        WHEN TANA.Sene_Bilgisi = '8' THEN '2018/2019 ' \n        WHEN TANA.Sene_Bilgisi = '9' THEN '2019/2020 ' \n    ELSE 'SELMEM'\nEND Sene_Bilgisi,\nCASE \n        WHEN TANA.Donem_Bilgisi = '1' THEN 'Gz ' \n        WHEN TANA.Donem_Bilgisi = '2' THEN 'Bahar '\n        WHEN TANA.Donem_Bilgisi = '3' THEN 'Yaz '  \n    ELSE 'SELMEM'\nEND Donem_Bilgisi,\n\nCASE \n        WHEN TANA.Burs_Tipi = '1' THEN 'YK' \n        WHEN TANA.Burs_Tipi = '2' THEN '%25 Ynmetim Bursu' \n        WHEN TANA.Burs_Tipi = '3' THEN '%50 Ynmetim Bursu' \n        WHEN TANA.Burs_Tipi = '4' THEN '%75 Ynmetim Bursu' \n        WHEN TANA.Burs_Tipi = '5' THEN '%100 Ynmetim Bursu' \n        WHEN TANA.Burs_Tipi = '6' THEN '%50 Yurt Kredisi' \n        WHEN TANA.Burs_Tipi = '7' THEN '%100 Yurt Kredisi' \n        WHEN TANA.Burs_Tipi = '8' THEN '%100 Ynetim Burdu Mezuniyete Kadar' \n        WHEN TANA.Burs_Tipi = '9' THEN '%50 Burs %50 Yurt Kredisi' \n    ELSE 'Burssuz veya Seilmemi'\nEND Cinsiyet_Tipi,  \n\nCASE \n        WHEN TANA.Cinsiyet_Tipi = '1' THEN 'Erkek ' \n        WHEN TANA.Cinsiyet_Tipi = '2' THEN 'Kz ' \n    ELSE 'SELMEM'\nEND Cinsiyet_Tipi,\nCASE \n        WHEN TANA.Uyruk= '0' THEN 'TC ' \n        WHEN TANA.Uyruk= '1' THEN 'Dier ' \n        ELSE 'SELMEM'\nEND Uyruk,\n\nPLN.[FICHEREF] As 'Sipari Referans',\nSIP.SPECODE As 'Sip.K',\nSIP.FICHENO As 'Sip.No',\nSIP.DOCODE As 'Sip.Belge No',\nCASE WHEN (FAT.[FICHENO] IS NULL) THEN '0' WHEN (FAT.[FICHENO] IS NOT NULL) THEN FAT.[FICHENO] END AS 'Fatura No',\nPLN.[TRCODE],\nPLN.[TOTAL] AS 'PLN Taksit Tutar',\nCASE WHEN (FAT.[NETTOTAL] IS NULL) THEN '0' WHEN (FAT.[NETTOTAL] IS NOT NULL) THEN FAT.[NETTOTAL] END AS 'Kesilen.Fat.Tut',\nCASE WHEN (PLN.[TOTAL]- FAT.[NETTOTAL] IS NOT NULL) THEN '0' WHEN (PLN.[TOTAL]- FAT.[NETTOTAL] IS NULL) THEN 'Faturalanmam' END AS 'FARK',\nCASE WHEN (FAT.[TOTALVAT] IS NULL) THEN '0' WHEN (FAT.[TOTALVAT] IS NOT NULL) THEN FAT.[TOTALVAT] END AS 'Kesilen KDV',\nCASE WHEN (FAT.[TOTALVAT] IS NOT NULL) THEN '0' WHEN (FAT.[TOTALVAT]IS NULL) THEN ROUND((PLN.[TOTAL]-(PLN.[TOTAL]/1.08)),2) END AS 'KesileCEK KDV',\nPLN.[CANCELLED] As 'PTAL Durumu',\nPLN.[MODIFIED],\nPLN.[PAYNO] AS 'd.Pln.Satr',\nCASE WHEN (FAT.[TRACKNR] IS NULL) THEN 'Faturalanmam' WHEN (FAT.[TRACKNR] IS NOT NULL) THEN FAT.[TRACKNR] END AS 'FAT.SIRA.NO'\nFROM LG_011_01_PAYTRANS AS PLN \nLEFT OUTER JOIN LG_011_CLCARD CC ON\nCC.LOGICALREF = PLN.CARDREF LEFT OUTER JOIN\nLG_011_01_INVOICE AS FAT ON  PLN.FICHEREF=FAT.DOCTRACKINGNR AND FAT.TRACKNR=PLN.PAYNO     LEFT OUTER JOIN\nLG_011_01_ORFICHE AS SIP ON  PLN.FICHEREF=SIP.LOGICALREF INNER JOIN\nLG_XT1015_011 AS TANA ON CC.LOGICALREF=TANA.PARLOGREF\nWhere MODULENR=3 \nORDER BY  PLN.[DATE_] ASC\n</code></pre>\n\n<p>Also, any application for a report, t-sql code that runs smoothly, queryanalzer. If you stack overflow error can be identified right from the stack, then it might be possible that convert data? How is it? You can find a document that explains step by step on video?</p>\n\n<p>Error Detail:<br>\n<code>cpu registers: eax = 0d3e2f60 ebx = 0d40ef98 ecx = 00000000 edx = 0042967e esi = 00000019 edi = 0012fc24 eip = 0042967e esp = 0012efa8 ebp = 0012f004</code></p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":163,"score":-2,"question_id":12095355,"title":"Get inserted table identity value and update another table","body":"<p>I have two tables with foreign key constraint on TableB on TablesAs KeyA column. I was doing manual inserts till now as they were only few rows to be added. Now i need to do a bulk insert, so my question if i insert multiple rows in TableA how can i get all those identity values and insert them into TableB along with other column values. Please see the script below.</p>\n\n<pre><code>INSERT INTO Tablea\n       ([KeyA]\n       ,[Value] )\n    SELECT 4 ,'StateA'\nUNION ALL\nSELECT 5 ,'StateB'\nUNION ALL\nSELECT 6 ,'StateC'\n\nINSERT INTO Tableb\n       ([KeyB]\n       ,[fKeyA] //Get value from the inserted row from TableA\n       ,[Desc])\nSELECT 1 ,4,'Value1'\nUNION ALL\nSELECT 2 ,5,'Value2'\nUNION ALL\nSELECT 3 ,6, 'Value3'\n</code></pre>\n"},{"tags":["tsql","reporting-services","sql-server-2000"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":314,"score":0,"question_id":12094729,"title":"SSRS 2005 passing parameters to SQL Server 2000 stored procedure","body":"<p>Below is code that I built from an example I found online, I can't find the link, but the code is referenced in the answers on this stack overflow question: <a href=\"http://stackoverflow.com/questions/512105/passing-multiple-values-for-a-single-parameter-in-reporting-services\">Passing multiple values for a single parameter in Reporting Services</a>.  </p>\n\n<p>Here is the SQL code I am working with right now within my stored procedure, it was a long procedure so I summed it down to just the section I am working on, and added the <code>DECLARE</code> and <code>SET</code> for <code>@EMPLOYEES</code>, which are passed as a parameter from SSRS to make the code snippet run. </p>\n\n<pre><code>DECLARE @EMPLOYEES varchar(8000)\n\n-- EMPLOYEES is a comma separated list of EMPLOYEE IDS \n-- FROM SSRS Report Parameters. Each ID is 12 characters\n-- And there are 806 Employees to choose from, which \n-- when all are selected, the Comma separated string grows \n-- to 11,193 characters, much longer than 8000\nSET @EMPLOYEES = 'EMP000000001,EMP000000002,EMP000000003'\n\nCREATE TABLE #EMPLOYEEIDS\n(\n   EMPLOYEEID varchar(100) NOT NULL\n)\n\nDECLARE @CharIndex AS int\nDECLARE @Piece AS varchar(100)\n\n-- FILL THE #EMPLOYEEIDS TABLE WITH THE COMMA SEPARATED EMPLOYEE IDS\nSELECT @CharIndex = 1\nWHILE @CharIndex &gt; 0 AND LEN(@EMPLOYEES) &gt; 0\nBEGIN\n   SELECT @CharIndex = CHARINDEX(',', @EMPLOYEES)\n   IF @CharIndex &gt; 0\n      SELECT @Piece = LEFT(@EMPLOYEES, @CharIndex - 1)\n   ELSE\n      SELECT @Piece = @EMPLOYEES\n\n   INSERT INTO #EMPLOYEEIDS (EMPLOYEEID) VALUES (@Piece)\n   SELECT @EMPLOYEES = RIGHT(@EMPLOYEES, LEN(@EMPLOYEES) - @CharIndex)\nEND\n\nSELECT * FROM #EMPLOYEEIDS\n\nDROP TABLE #EMPLOYEEIDS\n</code></pre>\n\n<p>I had 6 sets of multi-values, all of them worked fine, until I found that the reports were missing much of the data for employees, to which I found that the <code>VARCHAR(8000)</code> was overflowed when selecting all the employees on the report parameters (there are over 800 of them).  The Report would run, SQL would happily truncate the <code>VARCHAR</code> to 8000 characters, and a quarter of the IDS were not parsed.</p>\n\n<p>So I tried to switch the <code>VARCHAR</code> to a text field, and none of the parsing functions would work when the field is set up as TEXT. I get errors like the following:</p>\n\n<blockquote>\n  <p>Msg 8116, Level 16, State 2, Procedure usp_QualityMonitoring_AllProfiles_SelectWithParameters, Line 89<br>\n  Argument data type text is invalid for argument 1 of left function.</p>\n</blockquote>\n\n<p>This is understandable, I know that many functions that work with <code>VARCHAR</code> will not work with <code>TEXT</code>. So, SQL is truncating everything after 8000 characters when I use a <code>VARCHAR</code>, and the procedure won't ever run if I switch it to <code>TEXT</code>. </p>\n\n<ul>\n<li>What other options to I have to pass multi-valued parameters from SSRS to a SQL Server stored procedure that can support this many options?</li>\n<li>OR is there a way to fix the code in the stored procedure to parse through <code>TEXT</code> instead of <code>VARCHAR</code>?</li>\n</ul>\n\n<p>Note:  I originally thought the SQL Server running the Stored Proc was 2005, but I have determined that it is not:</p>\n\n<pre><code>SELECT @@VERSION\n-- Microsoft SQL Server  2000 - 8.00.2039 (Intel X86)   May  3 2005 23:18:38   Copyright (c) 1988-2003 Microsoft Corporation  Standard Edition on Windows NT 5.2 (Build 3790: Service Pack 2) \n</code></pre>\n"},{"tags":["sql","sql-server","tsql","query","sql-server-2008-r2"],"answer_count":3,"favorite_count":3,"up_vote_count":6,"down_vote_count":1,"view_count":7279,"score":5,"question_id":5945360,"title":"SQL Server 2008: How to query all databases sizes?","body":"<p>I have MS SQL 2008 R2, 500 databases.\nWhat is the most efficient, easiest and 'modern' way to query all databases sizes.</p>\n\n<p>The output should have columns:</p>\n\n<ul>\n<li>DatabaseName</li>\n<li>DataFilesSize</li>\n<li>LogFilesSize</li>\n</ul>\n"},{"tags":["asp.net","sql-server","vb.net","tsql","stored-procedures"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":490,"score":-1,"question_id":12038689,"title":"Populate gridview with results of a SQL Server stored procedure that returns multiple recordsets","body":"<p>I have a stored procedure that returns multiple recordsets. It can be 1 recordset, 2 recordsets, or more. I don't know how many RS will come back.</p>\n\n<p>Here at stackoverflow I found the below sample</p>\n\n<pre><code>    Dim conn As New SqlConnection(ConfigurationManager.ConnectionStrings(\"myConnection\").ConnectionString)\n    Dim cmd As New SqlCommand\n    Dim Reader As SqlDataReader\n    cmd.Connection = conn\n    cmd.Parameters.AddWithValue(\"@ACTNbr\", tbACTNbr.Text.ToString.Trim)\n    cmd.Parameters.AddWithValue(\"@WTHNbr\", tbWTHNbr.Text.ToString.Trim)\n    cmd.CommandText = \"sp_search_def\"\n    cmd.CommandType = CommandType.StoredProcedure\n    conn.Open()\n    Reader = cmd.ExecuteReader()\n'The next part is what I found here at stackoverflow\nWhile Reader.Read() OrElse (Reader.NextResult() And Reader.Read())\n  For i As Integer = 0 To Reader.FieldCount - 1\n    Response.Write(Reader(i).ToString())\n    Response.Write(\" \")\n  Next\n  Response.Write(\"&lt;br /&gt;\")\nEnd While\n</code></pre>\n\n<p>The above <code>response.write</code>'s show the data I need perfectly. But I need to put that into a Gridview. i.e. I need to put the results of the stored procedure (and all of its result sets) into one gridview.</p>\n\n<p>My gridview is set to <code>AutoGenerateColumns = \"true\"</code>.</p>\n\n<p>I've tried:</p>\n\n<pre><code>myGridview.DataSource = Reader\nmyGridview.DataBind()\n</code></pre>\n\n<p>And of course I only get one of the recordsets.</p>\n\n<p>The results of the stored procedure are all formatted the same - same number of columns, headers, and so on.</p>\n\n<p>Can somebody point me in the right direction? I've been trying to figure this out, but give up and now I am asking here.</p>\n\n<p>I am new to this.</p>\n\n<p>Thank you.</p>\n"},{"tags":["sql-server","tsql","sql-server-2005","join","sql-execution-plan"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":76,"score":3,"question_id":12093714,"title":"a query using covering index, merge join, hash join","body":"<p>I am tuning a query on SQL Server 2005.\nPlease note the real question is at the end. \nI have following query, both pto and ph has about 30million rows. The query initially run very slow (3 mins). So I added two index on pto, ph respectively.</p>\n\n<pre><code>        SELECT \n            MAX(ph.txn_date_time)\n        FROM \n            pto AS pto WITH (NOLOCK) \n            INNER JOIN ph AS ph WITH (NOLOCK) ON ph.receipt_id = pto.receipt_id\n        WHERE \n                pto.subtype = 'ff'\n            AND pto.Units_No &gt; 0\n            AND ph.branch_id = 5\n\n\n\nCREATE NONCLUSTERED INDEX [IX_pto_subTypeUnitReceipt] ON [dbo].[pto] \n(\n    [SUBTYPE] ASC,\n    [Units_No] ASC,\n    [RECEIPT_ID] ASC\n\n)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = ON, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [Indexes]\n\n\nCREATE NONCLUSTERED INDEX [IX_ph_branchReceiptTxn] ON [dbo].[ph] \n(\n    [BRANCH_ID] ASC,\n    [RECEIPT_ID] ASC,\n    [TXN_DATE_TIME] ASC\n)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [Indexes]\n</code></pre>\n\n<p>Now the query runs in 350ms. Great. The execution plan is also very simple, it uses the created index from the two tables and did a Hash join on the receipt_id column then a Stream Aggregate to do the MAX(ph.txn_date_time). So every column in the query is covered by the two added index. </p>\n\n<p>The question is why it used a Hash join on the receipt_id column? I mean since RECEIPT_ID in both indexes are sorted the optimizer should have used a merge join. To figure out why I changed the first index to below (put RECEIPT_ID before Units_No). </p>\n\n<pre><code>CREATE NONCLUSTERED INDEX [IX_pto_subTypeUnitReceipt] ON [dbo].[pto] \n(\n[SUBTYPE] ASC,\n[RECEIPT_ID] ASC,\n[Units_No] ASC\n\n\n)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = ON, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [Indexes]\n</code></pre>\n\n<p>And now I see the Merge join on the RECEIPT_ID column. The query also runs in 170ms. Now obviously the optimizer think the RECEIPT_ID in both indexes are sorted so a merge join is used. But I don't understand why in the first case it doesn't think so?</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","optimization"],"answer_count":3,"favorite_count":3,"up_vote_count":22,"down_vote_count":0,"view_count":7015,"score":22,"question_id":1395275,"title":"Which is better: Bookmark/Key Lookup or Index Scan","body":"<p>I know that an index <strong>seek</strong> is better than an index <strong>scan</strong>, but which is preferable in SQL Server explain plans: Index seek or Key Lookup (Bookmark in SQL Server 2000)?</p>\n\n<p>Please tell me they didn't change the name again for SQL Server 2008...</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":68,"score":1,"question_id":12092307,"title":"SQL query to find the avg salary based on the nearest client dob's","body":"<p>I have a requirement with a below table.</p>\n\n<p>Conditions:</p>\n\n<ol>\n<li>I have to take the average of salaries clients, if the client has serial 3 days date of birth gap.  </li>\n<li>If there are no nearest 3 day dob's gap between the gap between the clients, then no need to take that client into consideration.  </li>\n</ol>\n\n<p>Example:<br>\nin the below table<br>\nclient 17 has previous clientid's WITH serial dob's with 1day gap -> in this case I'll TAKE salary AVG FOR 17 BY taking 15,16 &amp; 17 salaries.<br>\n                    client 18 has previous clientid's WITH serial dob's -> in this case I'll TAKE salary AVG FOR 18 BY taking 16,17 &amp; 18 salaries.  </p>\n\n<p>Table:    </p>\n\n<pre><code>JobType    ClientID     ClinetDOB's         Slaries\n.net        1           2012-03-14              300  \n.net        2           2012-04-11              400  \n.net        3           2012-04-12              200  \n.net        4           2012-07-29              400\n\n.net        5           2012-08-17              1200 \n.net        6           2012-08-18              1400 \n.net        7           2012-08-19              1400\n\njava        8           2012-04-10              400\njava        9           2012-07-29              400  \njava        10          2012-07-30              600  \n\njava        11          2012-08-14              1200  \njava        12          2012-08-15              1800  \njava        13          2012-08-16              1100\n\njava        14          2012-09-17              1200 \n\njava        15          2012-08-18              2400 \njava        16          2012-08-19              2400  \njava        17          2012-08-20              2400  \njava        18          2012-08-21              1500  \n</code></pre>\n\n<p>Result Should looks LIKE this:-</p>\n\n<pre><code> JobType   ClientID     ClinetDOB's         AVG(Slaries)\n.net        7           2012-08-19              1333\nJava        13          2012-08-16              1366        --This avg of 5,6,7 clientsId's(because they have serial 3days dob's)    \nJava        17          2012-08-20              2400        --This avg of 15,16,17 clientsId's(because they have serial 3days dob's)\nJava        18          2012-08-21              2100        --This avg of 16,17,18 clientsId's(because they have serial 3days dob's)\n</code></pre>\n\n<p>Below query giving the some messup results.  </p>\n\n<pre><code>select t1.ClientID,  \n       t1.ClinetDOBs, \n       (t1.Slaries + sum (t2.Slaries)) / (count (*) + 1) Avg_Slaries \n  from table1 t1 \n inner join table1 t2 \n    on (t1.ClinetDOBs = dateadd(day, 3, t2.ClinetDOBs) and t1.jobtype = t2.jobtype) \n group by t1.ClientID,  \n       t1.ClinetDOBs, \n       t1.Slaries \n</code></pre>\n\n<p>Please help.</p>\n\n<p>Thank You In advance!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":29,"score":0,"question_id":12093120,"title":"No Jobs Ran in the Last 12 Hours?","body":"<p>I noticed that none of my jobs on my server ran in the last 12 hours.  SQL Server Agent is online, but I have had to \"reset\" all of my job scheduels (go in change it to something new and then change the schedule back to it's original settings) for the jobs to start running again.  Has anyone ever had this problem before and know what causes it?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","gaps-and-islands"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":124,"score":1,"question_id":11983853,"title":"islands and gaps tsql","body":"<p>I have been struggling with a problem that should be pretty simple actually but after a full  week of reading, googling, experimenting and so on, my colleague and we cannot find the proper solution. :(</p>\n\n<p>The problem: We have a table with two values: \nan employeenumber (P_ID, int)  &lt;--- identification of employee\na date (starttime, datetime) &lt;--- time employee checked in</p>\n\n<ul>\n<li>We need to know what periods each employee has been working.</li>\n<li>When two dates are less then @gap days apart, they belong to the same period</li>\n<li>For each employee there can be multiple records for any given day but I just need to know which dates he worked, I am not interested in the time part</li>\n<li>As soon as there is a gap > @gap days, the next date is considered the start of a new range</li>\n<li>A range is at least 1 day (example: 21-9-2011 | 21-09-2011) but has no maximum length. (An employee checking in every @gap - 1 days should result in a period from the first day he checked in until today)</li>\n</ul>\n\n<p>What we think we need are the islands in this table where the gap in days is greater than @variable (@gap = 30 means 30 days)</p>\n\n<p>So an example:</p>\n\n<p>SOURCETABLE<br></p>\n\n<blockquote>\n  <p>-----P_ID----|----starttime----<br>\n  12121 | 24-03-2009 7:30<br>\n  12121 | 24-03-2009 14:25 <br>\n  12345 | 27-06-2011 10:00<br>\n  99999 | 01-05-2012 4:50 <br>\n  12345 | 27-06-2011 10:30<br>\n  12345 | 28-06-2011 11:00<br>\n  98765 | 13-04-2012 10:00<br>\n  12345 | 21-07-2011 9:00<br>\n  99999 | 03-05-2012 23:15<br>\n  12345 | 21-09-2011 12:00<br>\n  45454 | 12-07-2010 8:00<br>\n  12345 | 21-09-2011 17:00<br>\n  99999 | 06-05-2012 11:05<br>\n  99999 | 20-05-2012 12:45<br>\n  98765 | 26-04-2012 16:00<br>\n  12345 | 07-07-2012 14:00<br>\n  99999 | 01-06-2012 13:55<br>\n  12345 | 13-08-2012 13:00<br></p>\n</blockquote>\n\n<p>Now what I need as a result is:<br><br>\nPERIODS<br></p>\n\n<blockquote>\n  <p>----P_ID----|----Start----|----End----<br>\n  12121 | 24-03-2009 | 24-03-2009<br>\n  12345 | 27-06-2012 | 21-07-2012<br>\n  12345 | 21-09-2012 | 21-09-2012<br>\n  12345 | 07-07-2012 | (today) OR 13-08-2012  &lt;-- (less than @gap days ago) OR (last date in table)<br>\n  45454 | 12-07-2010 | 12-07-2010<br>\n  45454 | 17-06-2012 | 17-06-2012 <br>\n  98765 | 13-04-2012 | 26-04-2012<br>\n  99999 | 01-05-2012 | 01-06-2012<br></p>\n</blockquote>\n\n<p>I hope this is clear this way, I already thank you for reading this far, it would be great if you could contribute!</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2005"],"answer_count":7,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":4999,"score":1,"question_id":2927475,"title":"sql server - select top and bottom rows","body":"<p>I'm using Sql Server 2005 and i'm trying to achieve something like:\nIn the same select statement i want to get the first x rows and the last x rows.</p>\n\n<pre><code>SELECT TOP(5) BOTTOM(5)\n</code></pre>\n\n<p>Of course 'bottom' does not exist so i need other solution.\nI believe there is an easy and elegant solution that i'm not getting.\nDoing the select again with Group By Desc is not an option.</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":315,"score":0,"question_id":12083079,"title":"T-SQL SELECT query to return combined result of multiple tables","body":"<p>I am wondering if it is possible and more efficient to do something that I am presently doing in code, to do in T-SQL instead.</p>\n\n<p>I have a database with courses. Each course can have different offerings which are variations of the course at different locations and at different awards.</p>\n\n<p>Here's my (simplified) database structure and some sample data:</p>\n\n<pre><code>CREATE TABLE tblCourse (CourseId int, CourseName varchar(50))\nCREATE TABLE tblOffering (OfferingId int, CourseId int, LocationId int, AwardId int)\nCREATE TABLE tblLocation (LocationId int, LocationName varchar(50))\nCREATE TABLE tblAward (AwardId int, AwardName varchar(50))\n\nINSERT INTO tblCourse VALUES (1, 'Course A')\nINSERT INTO tblCourse VALUES (2, 'Course B')\n\nINSERT INTO tblOffering VALUES (1, 1, 1, 1)\nINSERT INTO tblOffering VALUES (2, 1, 2, 1)\nINSERT INTO tblOffering VALUES (3, 1, 3, 1)\nINSERT INTO tblOffering VALUES (4, 1, 1, 2)\nINSERT INTO tblOffering VALUES (5, 2, 3, 1)\n\nINSERT INTO tblLocation VALUES (1, 'Location A')\nINSERT INTO tblLocation VALUES (2, 'Location B')\nINSERT INTO tblLocation VALUES (3, 'Location C')\n\nINSERT INTO tblAward VALUES (1, 'Award A')\nINSERT INTO tblAward VALUES (2, 'Award B')\n</code></pre>\n\n<p>What I want to retrieve from SQL is a single row for each course/award combination. Each row would have columns for each location and whether a course of that CourseId/AwardId combination was available. There would be now rows for course/award combinations that have no offerings.</p>\n\n<p>The required result, from the sample data, would be a recordset like this:</p>\n\n<pre><code>CourseId | CourseName | AwardId | AwardName | LocationA | LocationB | LocationC\n---------+------------+---------+-----------+-----------+-----------+----------\n1        | Course A   | 1       | Award A   | True      | True      | True\n1        | Course A   | 2       | Award B   | True      | NULL      | NULL\n2        | Course B   | 1       | Award A   | NULL      | NULL      | True\n</code></pre>\n\n<p>(NULL could also be False)</p>\n\n<p>At present I am doing a simple SELECT statement with various JOINS which gives me multiple rows for each course/award combination, then I loop through all rows in my code and build the required result. However, I don't think this is so efficient as I also need to page results.</p>\n\n<p>I think I could do this fairly easily in a stored procedure by creating a temporary table and a bunch of separate queries, but I don't think that would be too efficient. Wondering if there is a better way of doing it in T-SQL???</p>\n\n<p>So to clarify, what I am looking for is a T-SQL query or stored procedure that will produce the above sample recordset, and which I could adapt paging to.</p>\n\n<p>NB. I am using SQL Server 2008</p>\n"},{"tags":["sql","performance","tsql","sql-server-2005"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12091019,"title":"WHERE in Sql, combining two fast conditions multiplies costs many times","body":"<p>I have a fairly complex sql that returns 2158 rows' id from a table with ~14M rows. I'm using CTEs for simplification. </p>\n\n<p>The <code>WHERE</code> consists of two conditions. If i comment out one of them, the other runs in ~2 second. If i leave them both (separated by <code>OR</code>) the query runs ~100 seconds. The first condition alone needs 1-2 seconds and returns 19 rows, the second condition alone needs 0 seconds and returns 2139 rows.</p>\n\n<p>What can be the reason?</p>\n\n<p>This is the complete SQL:</p>\n\n<pre><code>WITH fpcRepairs AS\n(\n    SELECT FPC_Row = ROW_NUMBER()OVER(PARTITION BY t.SSN_Number ORDER BY t.Received_Date, t.Claim_Creation_Date, t.Repair_Completion_Date, t.Claim_Submitted_Date)\n    ,   idData, Repair_Completion_Date, Received_Date, Work_Order, SSN_number, fiMaxActionCode, idModel,ModelName\n    ,   SP=(SELECT TOP 1 Reused_Indicator FROM tabDataDetail td INNER JOIN tabSparePart sp ON td.fiSparePart=sp.idSparePart\n            WHERE td.fiData=t.idData\n            AND (td.Material_Quantity &lt;&gt; 0) \n            AND (sp.SparePartName = '1254-3751'))\n    FROM   tabData AS t INNER JOIN\n       modModel AS m ON t.fiModel = m.idModel \n    WHERE (m.ModelName = 'LT26i') \n    AND EXISTS(\n        SELECT  NULL \n        FROM    tabDataDetail AS td \n        INNER JOIN tabSparePart AS sp ON td.fiSparePart = sp.idSparePart\n        WHERE  (td.fiData = t.idData) \n        AND (td.Material_Quantity &lt;&gt; 0) \n        AND (sp.SparePartName = '1254-3751')\n    ) \n), needToChange AS\n(\n    SELECT idData FROM tabData AS t INNER JOIN\n       modModel AS m ON t.fiModel = m.idModel\n    WHERE (m.ModelName = 'LT26i') \n    AND EXISTS(\n        SELECT  NULL \n        FROM    tabDataDetail AS td \n        INNER JOIN tabSparePart AS sp ON td.fiSparePart = sp.idSparePart\n        WHERE  (td.fiData = t.idData) \n        AND (td.Material_Quantity &lt;&gt; 0) \n        AND (sp.SparePartName IN ('1257-2741','1257-2742','1248-2338','1254-7035','1248-2345','1254-7042'))\n    ) \n)\nSELECT t.idData\nFROM tabData AS t INNER JOIN modModel AS m ON t.fiModel = m.idModel\nINNER JOIN needToChange ON t.idData = needToChange.idData  -- needs to change FpcAssy\nLEFT OUTER JOIN fpcRepairs rep ON t.idData = rep.idData\nWHERE   \nrep.idData IS NOT NULL          -- FpcAssy replaced, check if reused was claimed correctly\nAND rep.FPC_Row &gt; 1             -- other FpcAssy repair before\nAND (\n    SELECT SP FROM fpcRepairs lastRep\n    WHERE lastRep.SSN_Number = rep.SSN_Number\n    AND lastRep.FPC_Row = rep.FPC_Row - 1\n) = rep.SP                      -- same SP, must be rejected(reused+reused or new+new)\nOR      \nrep.idData IS NOT NULL          -- FpcAssy replaced, check if reused was claimed correctly\nAND rep.FPC_Row = 1             -- no other FpcAssy repair before\nAND rep.SP = 0                  -- not reused, must be rejected\norder by t.idData \n</code></pre>\n\n<p>Here's the execution plan:</p>\n\n<p>Download: <a href=\"http://www.filedropper.com/exeplanfpc\" rel=\"nofollow\">http://www.filedropper.com/exeplanfpc</a></p>\n"},{"tags":["tsql","triggers"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":2408,"score":1,"question_id":3213624,"title":"Reading inserted column names and values in a TSQL trigger","body":"<p>I've been asked to create history tables for every table in a database. Then create a trigger that will write to the history table whenever the primary table is updated.</p>\n\n<p>The history tables have the same structure as the primary table, but with a couple of extra rows ('id' and 'update type')</p>\n\n<p>I've never done anything with triggers before, but I would like to do is dynamically go through the columns in 'Inserted' and construct an insert statement to populate the history table.</p>\n\n<p>However I cannot work out how to read the names of the columns and their individual values.</p>\n\n<p>My half finished trigger currently looks like...</p>\n\n<pre><code>CREATE TRIGGER tr_address_history\nON address\nFOR UPDATE\nAS\n\nDECLARE @colCount int\nDECLARE @maxCols int\nSET @colCount = 0\nSET @maxCols = (SELECT COUNT(column_name) FROM INFORMATION_SCHEMA.columns WHERE TABLE_NAME = 'Inserted')\n\nPRINT 'Number of columns = ' + CONVERT(varChar(10),@maxCols)\nWHILE (@colCount &lt;= @maxCols)\nBEGIN\n    DECLARE @name varchar(255)\n    SELECT @name = column_name FROM INFORMATION_SCHEMA.columns WHERE TABLE_NAME = 'Inserted'\n    DECLARE @value varchar(255)\n    SELECT @value = @name FROM Inserted\n\n    PRINT 'name = ' + @name + ' and value = ' + @value\n    SET @colCount = @colCount + 1\nEND\nPRINT 'Done';\n</code></pre>\n\n<p>When the trigger runs it just says \"Number of columns = 0\"</p>\n\n<p>Can anyone tell me what's wrong with :</p>\n\n<pre><code>SELECT COUNT(column_name) FROM INFORMATION_SCHEMA.columns WHERE TABLE_NAME = 'Inserted'\n</code></pre>\n\n<p>Thanks...</p>\n"},{"tags":["sql-server-2008","tsql","xquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":83,"score":0,"question_id":12089558,"title":"xQuery, getting the value with namespaces?","body":"<p>I am just starting with xquery and currently I don't know, why the following is not working. I've created two XML files, they are identically, except that one has namespaces and the other doesn't:</p>\n\n<pre><code>&lt;Envelope&gt;\n    &lt;Header&gt;\n        &lt;JustAValue&gt;12345&lt;/JustAValue&gt;\n    &lt;/Header&gt;\n    &lt;Body&gt;\n        &lt;someBody&gt;\n            &lt;ValueIWant&gt;12345678910&lt;/ValueIWant&gt;\n        &lt;/someBody&gt;\n    &lt;/Body&gt;\n&lt;/Envelope&gt;\n\n\n&lt;env:Envelope xmlns:env='http://schemas.xmlsoap.org/soap/envelope/'&gt;\n    &lt;env:Header xmlns:wsa='http://www.w3.org/2005/08/addressing'&gt;\n        &lt;JustAValue&gt;12345&lt;/JustAValue&gt;\n    &lt;/env:Header&gt;\n    &lt;env:Body xmlns:wsu='http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd' wsu:Id='element-28-1344266615792-223644235'&gt;\n        &lt;ns1:someBody xmlns='http://someURL.com' xmlns:ns1='http://someURL.com'&gt;\n            &lt;ValueIWant&gt;12345678910&lt;/ValueIWant&gt;\n        &lt;/ns1:someBody&gt;\n    &lt;/env:Body&gt;\n&lt;/env:Envelope&gt;\n</code></pre>\n\n<p>Both xml files are in a xml field in the database.</p>\n\n<p>Now I try to get the \"ValueIWant\" and I do it like this:</p>\n\n<pre><code>DECLARE @xml xml\n\nSelect @xml = completexml from MyDB.dbo.Xml where PKxml = 3 -- XML without namespaces\n\ndeclare @somevalue nvarchar(max)\n\nset @somevalue = @xml.value('(/Envelope/Body/someBody/ValueIWant/text())[1]', 'nvarchar(max)');\n\nselect @somevalue -- -&gt; 12345678910\n\n\nSelect @xml = completexml from MyDB.dbo.Xml where PKxml = 2 -- XML with namespaces\n\nset @somevalue = @xml.value('\ndeclare namespace env=\"http://schemas.xmlsoap.org/soap/envelope/\"; \ndeclare namespace ns1=\"http://someURL.com\"; \n(/env:Envelope/env:Body/ns1:someBody/ValueIWant/text())[1]', 'nvarchar(max)');\n\nselect @somevalue -- -&gt; NULL\n</code></pre>\n\n<p><strong>What am I doing wrong here?</strong></p>\n\n<p>I've played around a bit with the XML:</p>\n\n<pre><code>&lt;env:Envelope xmlns:env='http://schemas.xmlsoap.org/soap/envelope/'&gt;\n    &lt;env:Header xmlns:wsa='http://www.w3.org/2005/08/addressing'&gt;\n        &lt;JustAValue&gt;12345&lt;/JustAValue&gt;\n    &lt;/env:Header&gt;\n    &lt;env:Body xmlns:wsu='http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd' wsu:Id='element-28-1344266615792-223644235'&gt;\n        &lt;ns1:someBody xmlns='http://someURL.com' xmlns:ns1='http://someURL.com'&gt;\n            &lt;ValueIWant&gt;12345678910&lt;/ValueIWant&gt;\n        &lt;/ns1:someBody&gt;\n        &lt;BodyValue&gt;BodyValue&lt;/BodyValue&gt;\n        &lt;env:BodyValue&gt;BodyValue&lt;/env:BodyValue&gt;\n    &lt;/env:Body&gt;\n    &lt;env:TestValue1&gt;TestValue&lt;/env:TestValue1&gt;\n    &lt;TestValue2&gt;TestValue2&lt;/TestValue2&gt;\n&lt;/env:Envelope&gt;\n</code></pre>\n\n<p>I can get all the values: BodyValue, TestValue1 and TestValue2. No problem at all, but as soon as I want to change into the ns1 namespace and get ValueIWant, it just returns NULL.</p>\n"},{"tags":["c#","sql","winforms","query","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":136,"score":1,"question_id":12088719,"title":"Any way to speed up this UPDATE? C#, SQL, T-SQL","body":"<p>SQL:</p>\n\n<pre><code>CREATE FUNCTION dbo.fnRandomForeNames ()\nRETURNS VARCHAR(50) \nAS\nBEGIN\nRETURN  (\n            SELECT TOP 1 [FirstName]\n            FROM [tmp_ForeNames] \n            ORDER BY (SELECT new_id from GetNewID)\n        )\nEND\nGO\n</code></pre>\n\n<p>Similar functions for dbo.fnRandomSurNames() etc.</p>\n\n<pre><code>UPDATE Table1\nSET firstname = dbo.fnRandomForeNames(),\n    lastname = dbo.fnRandomSurNames(),\n    address1 = dbo.fnRandomAddress1(),\n    address2 = dbo.fnRandomAddress2(),\n    address3 = dbo.fnRandomAddress3(),\n    birthdate = DATEADD(DAY, ABS(CHECKSUM(NEWID()) % 3650), '1990-01-01')\n</code></pre>\n\n<p>My C# Code:  </p>\n\n<pre><code>    private void RunThis(string connString, StreamReader sr)\n    {\n        sr.BaseStream.Position = 0;\n        string sqlQuery = sr.ReadToEnd();\n        using (SqlConnection connection = new SqlConnection(connString))\n        {\n            Server server = new Server(new ServerConnection(connection));\n            server.ConnectionContext.StatementTimeout = 4200;\n            server.ConnectionContext.ExecuteNonQuery(sqlQuery);\n        }\n        sr.Close();\n    }\n</code></pre>\n\n<p>........  </p>\n\n<pre><code> RunThis(e.Argument.ToString(), _updateClaim);\n</code></pre>\n\n<p>Where <code>e.Argument.ToString()</code> is the connection string.</p>\n\n<p>The <code>CREATE FUNCTION</code> scripts are run earlier, take very little time to run.\nAlso, names are stored in tmp databases, these are entered in C# via arrays.\nThese also take very little time to run.</p>\n\n<p>Table1 contains approx 140,000 rows and takes approx. 14 mins to complete.</p>\n\n<p>I have also tried using parameterised SQL queries, skipping the tmp tables and SQL functions and instead creating the SQL query and executing it from the code, such as the following:</p>\n\n<pre><code>UPDATE Table1\nSET lastname = '{0}',\n    firstname = '{1}',\n    birthdate = DATEADD(DAY, ABS(CHECKSUM(NEWID()) % 3650), '1990-01-01'),\n    address1 = '{2}',\n    address2 = '{3}',\n    address3 = '{4}'\n    WHERE u_id = '{6}'\n</code></pre>\n\n<p>And some C#:  </p>\n\n<pre><code> using (SqlConnection connection = new SqlConnection(connString))\n        {\n            connection.Open();\n            for (int i = 0; i &lt; arraySize; ++i)\n            {\n                string updateString = string.Format(updateString2, GetRandomSurname(), GetRandomForeName(), GetRandomAddress1(), GetRandomAddress2(), GetRandomAddress3(), \"\", ids[i]);\n                SqlCommand cmd = new SqlCommand(updateString, connection);\n                cmd.CommandType = CommandType.Text;\n                cmd.ExecuteNonQuery();\n            }\n        }\n</code></pre>\n\n<p>The latter method also taking upwards of 14 minutes.</p>\n\n<p>Any ideas on how to cut down the time it takes to update the table?</p>\n\n<p>Thanks.</p>\n"},{"tags":["tsql","sql-server-2005","datetime-format"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":916,"score":0,"question_id":10300647,"title":"How to convert a DateTime string to a DateTime in SQL Server","body":"<p>I have a DateTime varchar in this format: 2005-08-08T00:00:00+01:00.</p>\n\n<ol>\n<li>Does this format have a name? (it's not ISO8601. Is it RFC3339?)</li>\n<li>How can I convert it to a DateTime using Transact-Sql?</li>\n</ol>\n\n<p><strong>EDIT</strong>\nHere's a summary answer, cobbled together from others input:</p>\n\n<ol>\n<li>It <em>is</em> ISO8601 with a time offset from UTC. If it was UTC it would end with a 'Z' instead of '+01:00'.  <a href=\"http://en.wikipedia.org/wiki/ISO_8601#Time_offsets_from_UTC\" rel=\"nofollow\">wikipedia</a></li>\n<li><p>You can convert it to local time or to utc as follows:</p>\n\n<blockquote>\n  <p>DECLARE @d VARCHAR(25) SET @d = '2007-08-08T00:01:00+01:00' SET @d =\n  '2007-08-08T00:01:00-01:00' SET @d = '2007-08-08T00:01:00+05:30'</p>\n  \n  <p>SELECT @d as Input, CONVERT(DATETIME, LEFT(@d, 19), 126) AS LocalDate\n  , DATEADD(MINUTE  , -CAST((SUBSTRING(@d, 20, 1) + RIGHT(@d, 2)) AS\n  INT)  , DATEADD(HOUR \n         ,-CAST(SUBSTRING(@d, 20, 3) AS INT)\n         , CONVERT(DATETIME, LEFT(@d, 19), 126))) as UtcDate WHERE @d LIKE '<strong>_<em>-</strong>-</em>_T__:<strong>:</strong>[+-]<strong>:</strong>'</p>\n</blockquote></li>\n</ol>\n\n<p>Results:</p>\n\n<pre><code>Input                     LocalDate               UtcDate\n------------------------- ----------------------- -----------------------\n2007-08-08T00:01:00+01:00 2007-08-08 00:01:00.000 2007-08-07 23:01:00.000\n\n2007-08-08T00:01:00-01:00 2007-08-08 00:01:00.000 2007-08-08 01:01:00.000\n\n2007-08-08T00:01:00+05:30 2007-08-08 00:01:00.000 2007-08-07 18:31:00.000\n</code></pre>\n"},{"tags":["xml","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":42,"score":1,"question_id":12086720,"title":"TSQL for xml xml-tag just once","body":"<p>I've the following SELECT Query:</p>\n\n<pre><code>SELECT\n'2012' 'period',\nPerson.Name 'users/person'\nFROM Person\nFOR XML PATH(''), ROOT ('company')\n</code></pre>\n\n<p>this gives me the following XML:</p>\n\n<pre><code>&lt;company&gt;\n  &lt;period&gt;2012&lt;/period&gt;\n  &lt;users&gt;\n    &lt;person&gt;Dubach&lt;/person&gt;\n  &lt;/users&gt;\n  &lt;period&gt;2012&lt;/period&gt;\n  &lt;users&gt;\n    &lt;person&gt;Pletscher&lt;/person&gt;\n  &lt;/users&gt;\n  &lt;period&gt;2012&lt;/period&gt;\n  ....\n</code></pre>\n\n<p>I would like to have the \"period\"-tag just once at the beginning of the result XML. how can I achieve this?</p>\n"},{"tags":["tsql","datetime","sql-server-2000"],"answer_count":6,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":11973,"score":1,"question_id":3656492,"title":"Get the time of a datetime in TSQL?","body":"<p>how could I do this? I have a datetime in DB like this: <strong>2010-09-06 17:07:28.170</strong></p>\n\n<p>What I want is only <strong>17:07:28.170</strong>. Is there a function for that or something?</p>\n\n<p>Thanks :-)</p>\n"},{"tags":["sql","tsql","join"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":131,"score":1,"question_id":12068527,"title":"The multi-part identifier could not be bound (join sub query)","body":"<p>Possible duplicate, but providing no insight to this case:\n<a href=\"http://stackoverflow.com/questions/7314134/the-multi-part-identifier-could-not-be-bound\">The multi-part identifier could not be bound</a></p>\n\n<p>I have a query of the following form:</p>\n\n<pre><code>select l.id, l.foo, r.id, r.foo\nfrom tbl l \n    inner join storyevents r on l.id = r.id\n    right join (\n        select distinct foo from tbl where id= l.id\n    ) tmp on l.foo = tmp.foo\nwhere l.foo = 12345\n</code></pre>\n\n<p>But i get the following error:</p>\n\n<pre><code>The multi-part identifier \"l.id\" could not be bound.\n</code></pre>\n\n<p>in relation to the <code>right join</code> sub query.</p>\n\n<p>Bonus points:\nThis is an attempt to remove duplicate rows from the <code>inner join</code> based on a single column. Better way to do this?</p>\n"},{"tags":["sql","tsql","sql-server-2000"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":208,"score":-2,"question_id":12060501,"title":"Getting Incorrect syntax near ',' error in SQL Server 2000","body":"<p>I am running this query using SQL Query Analyzer in SQL Server 2000:</p>\n\n<pre><code>create table TABLENAME(\n        DBID_ bigint not null,\n        CLASS_ varchar(255) not null,\n        DBVERSION_ integer not null,\n        KEY_ varchar(255),\n        CONVERTER_ varchar(255),\n        HIST_ bit,\n        EXECUTION_ bigint,\n        TASK_ bigint,\n        LOB_ bigint,\n    DATE_VALUE_ timestamp,\n        DOUBLE_VALUE_ double,\n        CLASSNAME_ varchar(255),\n        LONG_VALUE_ bigint,\n        STRING_VALUE_ varchar(255),\n        TEXT_VALUE_ longvarchar,\n        EXESYS_ bigint,\n        primary key (DBID_)\n    );\n</code></pre>\n\n<p>But an error occurs:</p>\n\n<blockquote>\n  <p>Server: Msg 170, Level 15, State 1, Line 12 Line 12: Incorrect syntax near ','.</p>\n</blockquote>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","ssis"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":54,"score":0,"question_id":12080431,"title":"standard protocol on inserting data and querying data at the same time","body":"<p>every day we have an SSIS package running to import data into a database. </p>\n\n<p>sometimes people are querying the database at the same time.</p>\n\n<p>the loading (data import) times out because there's a table lock on the specific table.</p>\n\n<p><strong>what is the standard protocol on inserting data and querying data at the same time?</strong></p>\n"},{"tags":["sql","sql-server","tsql","table","foreign-keys"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":50,"score":0,"question_id":12080703,"title":"Best multi relationship table object type design","body":"<p>I have a table called Feed. That table will keep track social objects of different types (Photos, Events, Statuses, etc...) created by users. Now I have 2 design choices. </p>\n\n<h2>CHOICE 1: objectTypeId, objectId:</h2>\n\n<pre><code>CREATE TABLE [dbo].[Feed](\n[feedId] [int] IDENTITY(1,1) NOT NULL,\n[objectTypeId] [int] NULL,\n[objectId] [datetime] NOT NULL\n</code></pre>\n\n<p>)</p>\n\n<pre><code>CREATE TABLE [dbo].[ObjectType](\n[typeId] [int] IDENTITY(1,1) NOT NULL,\n[name] [NVARCHAR] NULL\n</code></pre>\n\n<p>)</p>\n\n<p>Object type would then hold a list of all the possible types. \nBut I hate this method. Reason is, I cannot enforce referential integrity on the database.</p>\n\n<p>If an object is deleted in one of the tables, the objectId value in Feed is pointing to a non-existing object. </p>\n\n<p>Plus, the Join statement here is a mess. You have to hard code tables with hard values like LEFT JOIN Events ON feed.objectTypeId=2 AND feed.objectId=Events.eventId etc...</p>\n\n<h2>CHOICE 2: ADD eventId NULL, photoId NULL, statusId NULL or any other objectTypeId to Feed Table</h2>\n\n<p>PRO: Referential integrity can be enforced. Null columns don't cause much problems since they store nothing. No need to create additional Object Type table. </p>\n\n<pre><code>CREATE TABLE [dbo].[Feed](\n[feedId] [int] IDENTITY(1,1) NOT NULL,\n[eventId] [int] NULL,\n[photoId] [int] NULL,\n[statusId] [int] NULL,\n)\n</code></pre>\n\n<p>but this table does not really feel normalized. </p>\n\n<p>So, what is the best way to do what I am trying to do, and accomplish my goals. Referential integrity without having to change the schema every time I add a new object type. </p>\n\n<p>Thanks in advance. </p>\n\n<h2>UPDATE:</h2>\n\n<p>Forgot to point out that there exist tables of those objects... I have tables</p>\n\n<pre><code>CREATE TABLE [Events](\n</code></pre>\n\n<p>eventId INT,\nother cols only dealing with events.\n)</p>\n\n<pre><code>CREATE TABLE [Photos](\n</code></pre>\n\n<p>photoId INT,\nother cols that only deal with photos\n)</p>\n\n<pre><code>CREATE TABLE [Status](\n</code></pre>\n\n<p>statusId INT,\nother cols that only deal with statuses\n)</p>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":138,"score":1,"question_id":12074638,"title":"TSQL Internal Rate of Return (IRR) from row instead of columns","body":"<p>I have a data table like this:</p>\n\n<pre><code>Group   ID    M0    M1    ...    M20\n------------------------------------\n    1    1    10    -2    ...     54\n    1    2    -8    10    ...    -20\n    2    6   -10    12    ...      0\n    2    4    45    52    ...      0\n    2    5    12   102    ...      0\n</code></pre>\n\n<p>I'm grouping my data by Group like so:</p>\n\n<pre><code>SELECT Group\n     , round(sum(M0+M1+M2+...+M20)/count(ID),2) as profit\n     , round(sum(M0),2) as M0\n     , round(sum(M1),2) as M1\n     , ...\n     , round(sum(M20),2) as M20\nFROM\n    data_table\nGROUP BY\n    Group\n</code></pre>\n\n<p>What I need to add is IRR based on M0 to M20 columns.</p>\n\n<p>I found an IRR function that looks like this:</p>\n\n<pre><code>CREATE FUNCTION [dbo].[ufn_IRR]\n  (\n   @strIDs VARCHAR(8000),\n   @guess DECIMAL(30,10)\n  )\nRETURNS DECIMAL(30, 10)\nAS \n  BEGIN\n    DECLARE @t_IDs TABLE (\n        id INT IDENTITY(0, 1),\n        value DECIMAL(30, 10)\n    )\n    DECLARE @strID VARCHAR(12),@sepPos INT,@NPV DECIMAL(30, 10)\n    SET @strIDs = COALESCE(@strIDs + ',', '')\n    SET @sepPos = CHARINDEX(',', @strIDs)\n    WHILE @sepPos &gt; 0 \n      BEGIN\n        SET @strID = LEFT(@strIDs, @sepPos - 1)\n        INSERT INTO @t_IDs ( value ) SELECT ( CAST(@strID AS DECIMAL(20, 10)) ) WHERE ISNUMERIC(@strID) = 1\n        SET @strIDs = RIGHT(@strIDs, DATALENGTH(@strIDs) - @sepPos)\n        SET @sepPos = CHARINDEX(',', @strIDs)\n      END\n\n    SET @guess = CASE WHEN ISNULL(@guess, 0) &lt;= 0 THEN 0.00001 ELSE @guess END\n\n    SELECT @NPV = SUM(value / POWER(1 + @guess, id)) FROM @t_IDs\n    WHILE @NPV &gt; 0 \n      BEGIN\n        SET @guess = @guess + 0.00001\n        SELECT @NPV = SUM(value / POWER(1 + @guess, id)) FROM @t_IDs\n      END\n    RETURN @guess\n  END\n</code></pre>\n\n<p>Sample usage looks like this:</p>\n\n<pre><code>SELECT  dbo.ufn_IRR('-4000,1200,1410,1875,1050',0.00001)\n</code></pre>\n\n<p>But in my case I would like to avoid creating string from my columns, as this:</p>\n\n<pre><code> SELECT  dbo.ufn_IRR(\n    cast(round(sum([M0]), 2) AS NVARCHAR)+','\n   +cast(round(sum([M1]), 2) AS NVARCHAR)+','\n   +cast(round(sum([M2]), 2) AS NVARCHAR)+','\n   +cast(round(sum([M3]), 2) AS NVARCHAR)+','\n   +cast(round(sum([M4]), 2) AS NVARCHAR)+','\n   +...+','\n   +cast(round(sum([M20]), 2) AS NVARCHAR)\n ,0.00001)\n</code></pre>\n\n<p>I think it is pointless to first create a string and then inside function cut it into table.<br />\nI would like to modify IRR function so than I can pass my columns, but I don't have Idea how I should do that :/</p>\n"},{"tags":["sql","sql-server","performance","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":199,"score":2,"question_id":12078202,"title":"When using GETDATE() in many places, is it better to use a variable?","body":"<p>By better, I mean does it improve performance by some non-marginal amount?</p>\n\n<p>That is to say, each time I call <code>GETDATE()</code>, what amount of <em>work</em> does the server do to return that value?</p>\n\n<p>If I'm using <code>GETDATE()</code> in many places in a stored procedure, should I instead be creating a variable to store the date of the transaction?</p>\n\n<pre><code>declare @transDate datetime = GETDATE()\n</code></pre>\n\n<p>Bench-marking data would be fantastic. </p>\n\n<p><strong>EDIT</strong> I want to clarify: I'm interested mainly in the actual performance differences between these two possibilities, and whether or not it is significant. </p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":82,"score":0,"question_id":12078868,"title":"Select with IN and Like","body":"<p>I have a very interesting problem. I have an SSRS report with a multiple select drop down.\nThe drop down allows to select more than one value, or all values.\nAll values is not the problem. </p>\n\n<p>The problem is 1 or the combination of more than 1 option</p>\n\n<p>When I select in the drop down 'AAA' it should return 3 values:  'AAA','AAA 1','AAA 2'</p>\n\n<p>Right now is only returning 1 value. </p>\n\n<p><strong>QUESTION:</strong></p>\n\n<p>How can make the IN statement work like a LIKE?</p>\n\n<pre><code>The Drop down select\n\nSELECT '(All)' AS team, '(All)' AS Descr \nUNION ALL\nSELECT 'AAA' , 'AAA' \nUNION ALL\nSELECT 'BBB' , 'BBB'  \n\n\nTable Mytable\n\nColumnA Varchar(5)\n\nValues for ColumnA\n'AAA'\n'AAA 1'\n'AAA 2'\n'BBB'\n'BBB 1'\n'BBB 2'\n\n\nSELECT * FROM Mytable\nWHERE ColumnA IN (SELECT * FROM SplitListString(@Team, ',')))\n\n\nSplit function\n\nCREATE FUNCTION [dbo].[SplitListString]\n (@InputString NVARCHAR(max), @SplitChar CHAR(1))\n RETURNS @ValuesList TABLE\n (\n param NVARCHAR(MAX)\n )\n AS\n BEGIN\n\n    DECLARE @ListValue     NVARCHAR(max)\n    DECLARE @TmpString     NVARCHAR(max) \n    DECLARE @PosSeparator  INT  \n    DECLARE @EndValues     BIT\n\n    SET @TmpString = LTRIM(RTRIM(@InputString));\n    SET @EndValues = 0\n\n    WHILE (@EndValues = 0) BEGIN\n        SET @PosSeparator = CHARINDEX(@SplitChar, @TmpString)\n\n        IF (@PosSeparator) &gt; 1 BEGIN\n            SELECT @ListValue = LTRIM(RTRIM(SUBSTRING(@TmpString, 1, @PosSeparator -1 )))\n        END\n        ELSE BEGIN\n            SELECT @ListValue = LTRIM(RTRIM(@TmpString))\n            SET @EndValues = 1\n        END\n\n        IF LEN(@ListValue) &gt; 0 BEGIN\n            INSERT INTO @ValuesList\n            SELECT @ListValue       \n        END\n\n        SET @TmpString = LTRIM(RTRIM(SUBSTRING(@TmpString, @PosSeparator + 1, LEN(@TmpString) - @PosSeparator)))\n    END\n\n    RETURN\nEND\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2008-express"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":61,"score":0,"question_id":12076632,"title":"how to use delete cascade in Store Proc?","body":"<p>I just need some in help to implement delete cascade on My store Proc because I have REFERENCE constraint error </p>\n\n<pre><code>Create PROCEDURE [dbo].[DeleteProject]\n@ProjectID uniqueidentifier\nAS\nBEGIN\n\n    -- Insert statements for procedure here\nDELETE FROM [TaskManagementSystem_DB].[dbo].[Projects]\n    WHERE projectID = @ProjectID\nEND\n</code></pre>\n"},{"tags":["tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":406,"score":0,"question_id":3924641,"title":"Poor Man's SQL Pivot. List Questions as Columns and Answers per User in one row","body":"<p><strong>Current query</strong>:<Br /></p>\n\n<pre><code>SELECT order_id AS OrderNumber, ordName, ordLastName, question, answer \nFROM cart_survey \nJOIN orders \n    ON cart_survey.order_id=orders.ordID \nJOIN survey_answers \n    ON survey_answers.id=cart_survey.answer_id \nJOIN survey_questions \n    ON survey_questions.id=cart_survey.question_id\n</code></pre>\n\n<p><strong>Results</strong>:</p>\n\n<pre>\nOrderNumber ordName ordLastName question                        answer\n8591        Larry   Marshburn   Type of Surgery:                Colostomy  \n8591        Larry   Marshburn   Month of Surgery:               2\n8591        Larry   Marshburn   Year of surgery:                2010\n8591        Larry   Marshburn   Current Ostomy System Brand:    ConvaTec  \n8591        Larry   Marshburn   Degree of Satisfaction:         Somewhat Satisfied  \n8593        Melvin  Belcher     Type of Surgery:                Urostomy\n8593        Melvin  Belcher     Month of Surgery:               9\n8593        Melvin  Belcher     Year of surgery:                2010\n8593        Melvin  Belcher     Current Ostomy System Brand:    ConvaTec  \n8593        Melvin  Belcher     Degree of Satisfaction:         Very Satisfied  \n</pre>\n\n<p>How do I properly query the tables to pull results that will look like this?\nName and Lastname on a single line and questions for columns and answers for each column.</p>\n\n<p><strong>Desired Results</strong></p>\n\n<pre>\nOrderNumber ordName ordLastName \"Type of Surgery\" \"Month of Surgery\" \"Year of Surgery\" etc.\n8591        Larry   Marshbourn   Colostomy         2                  2010\n8593        Melvin  Belcher      Urostomy          9                  2010\n</pre>\n"},{"tags":["sql-server","tsql","pivot"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":115,"score":3,"question_id":12074939,"title":"Get ROWS as COLUMNS","body":"<p>I'm using MS SQL 2008 R2, have three tables with following schema:</p>\n\n<p>Table 1: Contains workshift info for each worker</p>\n\n<pre><code>CREATE TABLE workshift (\n[ws_id] [bigint] NOT NULL,\n[start_date] [datetime] NOT NULL,\n[end_date] [datetime] NOT NULL,\n[worker_id] [bigint] NOT NULL\n)\n\nINSERT INTO workshift VALUES (1, '2012-08-20 08:30:00', '2012-08-20 14:30:00', 1)\nINSERT INTO workshift VALUES (2, '2012-08-20 14:30:00', '2012-08-20 22:30:00', 2)\n</code></pre>\n\n<p>Table 2: Contains monetary denominations</p>\n\n<pre><code>CREATE TABLE currency_denom (\n[cd_id] [decimal](7, 2) NOT NULL,\n[name] [nchar](100) NOT NULL\n)\n\nINSERT INTO currency_denom VALUES (1, '100.00')\nINSERT INTO currency_denom VALUES (2, '50.00')\nINSERT INTO currency_denom VALUES (3, '20.00')\nINSERT INTO currency_denom VALUES (4, '10.00')\nINSERT INTO currency_denom VALUES (5, '5.00')\nINSERT INTO currency_denom VALUES (6, '1.00')\n</code></pre>\n\n<p>Table 3: Contains the quantity of each denomination the worker has received in every workshift</p>\n\n<pre><code>CREATE TABLE currency_by_workshift (\n[cd_id] [decimal](7, 2) NOT NULL,\n[ws_id] [bigint] NOT NULL,\n[qty] [int] NOT NULL\n)\n\nINSERT INTO currency_by_workshift VALUES (1, 1, 1)\nINSERT INTO currency_by_workshift VALUES (2, 1, 2)\nINSERT INTO currency_by_workshift VALUES (3, 1, 2)\nINSERT INTO currency_by_workshift VALUES (2, 2, 3)\nINSERT INTO currency_by_workshift VALUES (4, 2, 4)\nINSERT INTO currency_by_workshift VALUES (5, 2, 2)\n</code></pre>\n\n<p>I need to get the currency_by_workshift values in columns instead of rows, along with the workshift values, that is:</p>\n\n<pre><code>workshift |     workshift       |     workshift       | 100.00 | 50.00 | 20.00 | 10.00 | 5.00 | 1.00 \n  ws_id   |     start_date      |     end_date        |        |       |       |       |      | \n\n    1     | 2012-08-20 08:30:00 | 2012-08-20 14:30:00 |    1   |   2   |   2   |   0   |   0  |   0\n    2     | 2012-08-20 14:30:00 | 2012-08-20 22:30:00 |    0   |   2   |   0   |   4   |   2  |   0\n</code></pre>\n\n<p>I'm not able to use a case to count quantities for each currency denomination because they are configurable, if a new denomination is added, the query should be modified. Same applies if using PIVOT function, or I'm wrong?</p>\n\n<p>How can I get the info that way?</p>\n"},{"tags":["tsql","index","sql-server-2008-r2"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":74,"score":0,"question_id":12074615,"title":"Long Running Rebuild Index","body":"<p>Have in index rebuild that has been running for 2 days. </p>\n\n<p>Is there a way to determine how far along the rebuild has come and estimate when it will finish? </p>\n\n<p>The first comment from Martin Smith was the answer.  It appears the rebuild was not running at all rather the GUI was just hung.   My lesson is to only rebuild with TSQL and then check sys.dm._exec_request as Martin Smith commented.   Rebuild does not show percent complete but at least I can see it running.</p>\n\n<p>The table is int32, int32, int32, byte with first three as the PK.\nTable has about 4 billion rows. \nPK has less than 1% fragmentation.</p>\n\n<p>The index I am rebuilding is the on the 2nd and 3rd int.</p>\n\n<p>Did the rebuild in SSMS right click rebuild.</p>\n\n<p>This is an index that was disabled.  The PK and this index are the only indexes on the table.  </p>\n\n<p>On a copy of the same database but only 1/10 the number of rows the index rebuild ran in 1 hour.   That index did what it needed for queries.  With 10 times the data I expected 10 hours.    This not a production database and has no activity. </p>\n\n<p>In hind site I think I should have used tempdb and online = off.  </p>\n"},{"tags":["sql-server-2008","tsql","alert","smartphone"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":82,"score":0,"question_id":12075592,"title":"Alternative and Best ways to format SQL query for phone alert messages","body":"<p>I'm creating an email alert that will most likely be routed to smart phones (either email or SMS) and be used to wake people up when we have production issues.  Email is send with EXEC msdb.dbo.sp_send_dbmail and providing the @query parameter which executes a stored proc. </p>\n\n<p>Currently, the report looks something like this, and as you can see, when things wrap around and are not in a Courier font, they look horrible. </p>\n\n<p>What is the best way to format this?  HTML emails instead with a table? \nAre there any T-SQL utilities to do that?  Is this perhaps a job for C# instead of T-SQL (I can code either). </p>\n\n<blockquote>\n<pre><code>&gt; Rating     Airline    Feed             LocalDateTimeLastMsgRcvd\n&gt; AlertMinutes CountMessageInLastHour AvgCountPerSameHour\n&gt; ---------- ---------- ---------------- ------------------------ ------------ ---------------------- ------------------- GOOD       ABC        Feed1             2012-08-22 07:15                   10               \n&gt; 420                 351 BAD        ABC        ABC-Feed2        \n&gt; 2012-08-22 07:04                   10                     48          \n&gt; 56 GOOD       ABC        ABC-Feed3         2012-08-22 06:40           \n&gt; 75                      1                   1 GOOD       DEF       \n&gt; DEF               2012-08-22 07:15                   10               \n&gt; 597                 858\n</code></pre>\n</blockquote>\n\n<p>I am considering three ideas: </p>\n\n<p>1) Use T-SQL to write each element on different line of temp table: </p>\n\n<pre><code>Row=1\nRating=Good\nFeed=ABC \nLocalDateTimeLastMsgRcvd=2012-08-22 07:04 \netc..\n</code></pre>\n\n<p>. </p>\n\n<p>2) Similar to above but use XML wrappers </p>\n\n<p>3) Similar to above but use <code>&lt;TR&gt;&lt;TD&gt;</code> wrappers to make HTML table. </p>\n\n<p>I'm currently looking at option c here: <a href=\"http://msdn.microsoft.com/en-us/library/ms190307.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/ms190307.aspx</a>, which will probably work for most smartphone emails, but probably not SMS.  Some people will forward this to their SMS. </p>\n"},{"tags":["sql-server","performance","tsql","optimization"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":107,"score":1,"question_id":12076121,"title":"Inline SQL versus stored procedure","body":"<p>I have a simple <code>SELECT</code> statement with a couple columns referenced in the <code>WHERE</code> clause. Normally I do these simple ones in the VB code (setup a Command object, set Command Type to text, set Command Text to the Select statement). However I'm seeing timeout problems. We've optimized just about everything we can with our tables, etc. </p>\n\n<p>I'm wondering if there'd be a big performance hit just because I'm doing the query this way, versus creating a simple stored procedure with a couple params. I'm thinking maybe the inline code forces SQL to do extra work compiling, creating query plan, etc. which wouldn't occur if I used a stored procedure.</p>\n\n<p>An example of the actual SQL being run:</p>\n\n<pre><code>SELECT TOP 1 * FROM MyTable WHERE Field1 = @Field1 ORDER BY ID DESC\n</code></pre>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":25,"score":0,"question_id":12076002,"title":"How to reference the PK of a newly inserted row","body":"<p>I have a query where a record gets added to the table channels. Each record there is then assigned a channelID which is the PK for the table, and auto increments. After a record is added to the channel table I want to insert strings associate with that record into another table called channel keywords. My problem is that I also need to pass in the channelID that created in the previous query as a parameter for the insert statement for the channelskeywords table, but I am not quite sure how to do this.</p>\n\n<pre><code>    IF @matchBy ='title'\n    BEGIN\n    insert into channels\n    (userID,matchTitle,matchTitleAbstract, fromMyPage)\n    values\n    (@userID,1,0,@fromMyPage)\n\n\n    END \n\n    IF @matchBy ='TitleAbstract'\n    insert into channels\n    (userID,matchTitle,matchTitleAbstract, fromMyPage)\n    values\n    (@userID,0,1,@fromMyPage)\n    BEGIN\n\n    IF (NULLIF(@keyword1, '')) IS NOT NULL\n    insert into channelsKeywords\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":12075056,"title":"sql server count() function?","body":"<p>I have this Sql Query to show me how many task under Project but the problem it doesn't display Projects with 0 task can someone help me?</p>\n\n<pre><code>SELECT Projects.projectName AS [Project Name],\n    COUNT(Projects_tasks.taskID) AS #tasks,\n    Projects.projectID AS [Project ID]\n\nFROM Projects\n\nINNER JOIN Projects_tasks\nON Projects.projectID = Projects_tasks.projectID \n\nGROUP BY Projects.projectName,\n    Projects_tasks.taskID,\n    Projects.projectID\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":297,"score":0,"question_id":12075263,"title":"TSQL: Split one column with semicolon separated values into multiple rows","body":"<p>Trying to migrate from an old database to a new one in which the way data is stored is a bit different.</p>\n\n<p>In one specific case I have a column with semicolon separated values that I would like to separate into multiple rows.</p>\n\n<p>Here is an example:</p>\n\n<pre><code>SELECT \n    p.idperson, \n    p.roleperson\nFROM person p\n</code></pre>\n\n<p>The TSQL above generates the following output</p>\n\n<pre><code>idperson roleperson\n1001    ;214401;\n1002    ;214201;214401;\n1003    ;212101;\n</code></pre>\n\n<p>I would like to convert this to:</p>\n\n<pre><code>idperson roleperson\n1001    214401\n1002    214401\n1002    214201\n1003    212101\n</code></pre>\n\n<p>That is, I want to split the row with multiple values into two rows. Is this possible without creating cursors or loops?</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":12074495,"title":"T-SQL - need to run update if only one record returned by query","body":"<p>I need to update a record IFF there is only one record matching my search criteria.  Here's what I have, but it's crude:</p>\n\n<pre><code>DECLARE @TestCount INT;\n\nSELECT @TestCount = COUNT(*)\nFROM TestRecords tr\nWHERE\n    tr.UnitSerial = @UnitSerial\n      AND\n    tr.PassFailStatus = 1;\n\nIF (@TestCount = 1)\nUPDATE\n    TestRecords\nSET\n    Invalid = 1\nWHERE\n    TestRecordID = \n           (SELECT TestRecordID\n            FROM TestRecords tr\n            WHERE\n            tr.UnitSerial = @UnitSerial\n              AND\n            tr.PassFailStatus = 1);\n</code></pre>\n\n<p>Of course this is example code - there are more restrictions and tables joins, etc in the SELECT statement, and it's all wrapped by a transaction, but this is the gist of the stored proc logic.</p>\n\n<p>I'm thinking there has to be a better way but I don't know what that is.  Any suggestions?</p>\n\n<p>Thanks, Dave</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":100,"score":0,"question_id":12066555,"title":"Which query is more appropriate?","body":"<pre>\n   TABLE T1                    TABLE T2\n   +----+------------+         +----+------------+\n   | Id |   Name     |         | Id |  Some_Data |\n   +----+------------+         +----+------------+\n   |    |            |         |    |            |\n</pre>\n\n<p>Query1: </p>\n\n<pre><code>SELECT * FROM T1 JOIN T2 ON T1.Id=T2.Id WHERE T1.Id=1001\n</code></pre>\n\n<p>Query2:</p>\n\n<pre><code>SELECT * FROM T1 JOIN T2 ON T1.Id=T2.Id WHERE T2.Id=1001\n</code></pre>\n\n<p>If T2 has 10 million rows of which only 100 has Id=1001, which of the above query is the more appropriate one to use?  Or it doesn't matter as SQL Server is smart enough to know what to do best?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":104,"score":2,"question_id":12070420,"title":"Fastest way to perform multiple \"IN\" queries in SQL","body":"<p>I have a fairly horrible query using 2 \"IN\" statements that needs running on our database.  Firstly the schema (Simplified for this example):</p>\n\n<pre><code>CREATE TABLE [dbo].[SystemUser]\n(\n    [SystemUserID] [int] IDENTITY(1,1) NOT NULL,\n    [FirstName] [nvarchar](50) NULL,\n    [Surname] [nvarchar](50) NULL\n    CONSTRAINT [PK_ApplicationUser] PRIMARY KEY CLUSTERED \n    (\n        [SystemUserID] ASC\n    )\n)\nGO\n\nCREATE TABLE [dbo].[Group]\n(\n    [GroupID] [int] IDENTITY(1,1) NOT NULL,\n    [Name] [nvarchar](50) NULL\n    CONSTRAINT [PK_Group] PRIMARY KEY CLUSTERED \n    (\n        [GroupID] ASC\n    )\n)\nGO\n\nCREATE TABLE [dbo].[GroupMembership]\n(\n    [SystemUserID] [int] NOT NULL,\n    [GroupID] [int] NOT NULL\n    CONSTRAINT [PK_GroupMembership] PRIMARY KEY CLUSTERED \n    (\n        [SystemUserID] ASC,\n        [GroupID] ASC\n    )\n)\nGO\n</code></pre>\n\n<p>What I want to do is find all \"SystemUser\" records that match a list of SystemUserIDs that do NOT have membership to a \"Group\" that is in a list of GroupIDs.</p>\n\n<p>So 2 seperate lists of IDs beng compared in one query.  The fastest way I can think of doing this currently is below:</p>\n\n<pre><code>SELECT SU.SystemUserID\nFROM [dbo].[SystemUser] SU \nLEFT JOIN\n(\n    SELECT GM.SystemUserID\n    FROM [dbo].[GroupMembership] GM\n    WHERE GM.GroupID IN\n    (\n        1, 7, 8, 10, 32\n    )\n) GM ON GM.SystemUserID = SU.SystemUserID\nWHERE SU.SystemUserID IN\n(\n    10, 61, 80, 93, 98\n)\nAND GM.SystemUserID IS NULL /* Not matched */\n</code></pre>\n\n<p>Is there anything I'm missing; would a \"WHERE NOT EXISTS\" check be more efficient?  Or can you think of a better way of processing and filtering by the two lists?</p>\n"},{"tags":["sql-server-2008","tsql","sql-server-2008-r2","for-xml-path"],"answer_count":1,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":101,"score":1,"question_id":12065594,"title":"Comma Delimited Result set + SQL Query","body":"<p>I got two tables with data as listed below:</p>\n\n<p>Table1: Student</p>\n\n<p><img src=\"http://i.stack.imgur.com/QglwM.jpg\" alt=\"enter image description here\"></p>\n\n<p>Table2: Subject</p>\n\n<p><img src=\"http://i.stack.imgur.com/H9swW.jpg\" alt=\"enter image description here\"></p>\n\n<p>I need the output as:</p>\n\n<p><img src=\"http://i.stack.imgur.com/1o0rC.jpg\" alt=\"enter image description here\"></p>\n\n<p>I got this acheived with below query using for XML PATH</p>\n\n<p>Code:</p>\n\n<pre><code>WITH    cte\n      AS ( SELECT   Stu.Student_Id ,\n                    Stu.Student_Name ,\n                    ( SELECT    Sub.[Subject] + ','\n                      FROM      [Subject] AS Sub\n                      WHERE     Sub.Student_Id = Stu.Student_Id\n                      ORDER BY  Sub.[Subject]\n                    FOR\n                      XML PATH('')\n                    ) AS [Subjects]\n           FROM     dbo.Student AS Stu\n         )\nSELECT  Student_id [Student Id] ,\n        student_name [Student Name] ,\n        SUBSTRING(Subjects, 1, ( LEN(Subjects) - 1 )) AS [Student Subjects]\nFROM    cte\n</code></pre>\n\n<p>My question is there a better way to do this without using XML Path?</p>\n"},{"tags":["sql","tsql","sql-server-2008","view","sql-order-by"],"answer_count":8,"favorite_count":0,"up_vote_count":6,"down_vote_count":0,"view_count":7919,"score":6,"question_id":1306359,"title":"ORDER BY in a Sql Server 2008 view","body":"<p>we have a view in our database which has an ORDER BY in it. \nNow, I realize views generally don't order, because different people may use it for different things, and want it differently ordered. This view however is used for a <strong>VERY SPECIFIC</strong> use-case which demands a certain order. (It is team standings for a soccer league.)</p>\n\n<p>The database is Sql Server 2008 Express, v.10.0.1763.0 on a Windows Server 2003 R2 box.</p>\n\n<p>The view is defined as such:  </p>\n\n<pre><code>CREATE VIEW season.CurrentStandingsOrdered\nAS\n    SELECT TOP 100 PERCENT *, season.GetRanking(TEAMID) RANKING   \n    FROM season.CurrentStandings \n    ORDER BY \n        GENDER, TEAMYEAR, CODE, POINTS DESC, \n        FORFEITS, GOALS_AGAINST, GOALS_FOR DESC, \n        DIFFERENTIAL, RANKING\n</code></pre>\n\n<p>It returns:  </p>\n\n<pre><code>GENDER, TEAMYEAR, CODE, TEAMID, CLUB, NAME,  \nWINS, LOSSES, TIES, GOALS_FOR, GOALS_AGAINST,  \nDIFFERENTIAL, POINTS, FORFEITS, RANKING\n</code></pre>\n\n<p>Now, when I run a <strong>SELECT</strong> against the view, it orders the results by <strong>GENDER, TEAMYEAR, CODE, TEAMID</strong>. Notice that it is ordering by <strong>TEAMID</strong> instead of <strong>POINTS</strong> as the order by clause specifies. </p>\n\n<p>However, if I copy the SQL statement and run it exactly as is in a new query window, it orders correctly as specified by the <strong>ORDER BY</strong> clause.</p>\n"},{"tags":["tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":52,"score":0,"question_id":12063003,"title":"Adding multiple filtering criteria to a T-SQL query","body":"<p>I need assistance filtering the results of the query below.  Specifically, I need to return only the results where <code>dbo.pertot_all.sort_method = 2</code> for all the dates specified in the where clause.  Currently, using what's provided below, it's returning other sort_methods. I am unfamiliar with the order/groupings of the AND/OR operators. Can someone offer some guidance?  Thanks kindly in advance. </p>\n\n<pre><code> SELECT     dbo.SiteDescription.Site, dbo.SiteDescription.Description AS SiteDescription, dbo.SiteDescription.LocationGroup, dbo.chart_all.acct, dbo.pertot_all.sf2, \n                  dbo.SSRS_sf2UnitCodes.sf2description, dbo.pertot_all.sf4, dbo.SSRS_sf4UnitCodes.sf4description, dbo.chart_all.description AS AccountDescription, \n                  dbo.pertot_all.amt, dbo.pertot_all.per_start, dbo.pertot_all.sort_method\n FROM         dbo.SSRS_sf2UnitCodes INNER JOIN\n                  dbo.pertot_all ON dbo.SSRS_sf2UnitCodes.sf2UnitCode = dbo.pertot_all.sf2 INNER JOIN\n                  dbo.SSRS_sf4UnitCodes ON dbo.pertot_all.sf4 = dbo.SSRS_sf4UnitCodes.sf4UnitCode RIGHT OUTER JOIN\n                  dbo.chart_all LEFT OUTER JOIN\n                  dbo.SiteDescription ON dbo.chart_all.site_ref = dbo.SiteDescription.Site ON dbo.pertot_all.site_ref = dbo.SiteDescription.Site AND \n                  dbo.pertot_all.sf1 = dbo.chart_all.acct\nWHERE     (1 = 1) AND (ISNULL(dbo.pertot_all.per_start, '2012-01-01 00:00:00.000') = '2012-01-01 00:00:00.000') AND (ISNULL(dbo.pertot_all.sort_method, 2) = 2) OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-02-01 00:00:00.000') = '2012-02-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-03-01 00:00:00.000') = '2012-03-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-04-01 00:00:00.000') = '2012-04-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-05-01 00:00:00.000') = '2012-05-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-06-01 00:00:00.000') = '2012-06-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-07-01 00:00:00.000') = '2012-07-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-08-01 00:00:00.000') = '2012-08-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-09-01 00:00:00.000') = '2012-09-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-10-01 00:00:00.000') = '2012-10-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-11-01 00:00:00.000') = '2012-11-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2012-12-01 00:00:00.000') = '2012-12-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-01-01 00:00:00.000') = '2011-01-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-02-01 00:00:00.000') = '2011-02-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-03-01 00:00:00.000') = '2011-03-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-04-01 00:00:00.000') = '2011-04-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-05-01 00:00:00.000') = '2011-05-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-06-01 00:00:00.000') = '2011-06-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-07-01 00:00:00.000') = '2011-07-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-08-01 00:00:00.000') = '2011-08-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-09-01 00:00:00.000') = '2011-09-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-10-01 00:00:00.000') = '2011-10-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-11-01 00:00:00.000') = '2011-11-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2011-12-01 00:00:00.000') = '2011-12-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-01-01 00:00:00.000') = '2010-01-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-02-01 00:00:00.000') = '2010-02-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-03-01 00:00:00.000') = '2010-03-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-04-01 00:00:00.000') = '2010-04-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-05-01 00:00:00.000') = '2010-05-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-06-01 00:00:00.000') = '2010-06-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-07-01 00:00:00.000') = '2010-07-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-08-01 00:00:00.000') = '2010-08-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-09-01 00:00:00.000') = '2010-09-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-10-01 00:00:00.000') = '2010-10-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-11-01 00:00:00.000') = '2010-11-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2010-12-01 00:00:00.000') = '2010-12-01 00:00:00.000') OR\n                  (ISNULL(dbo.pertot_all.per_start, '2009-12-01 00:00:00.000') = '2009-12-01 00:00:00.000')\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12063195,"title":"TSQL statement being skipped over","body":"<p>I am having a hard time figuring out why only the beginning part of my code is executing. I have inserted the statement '--Nothing after this point is executing' where the problem lies. Any help would be greatly appreciated</p>\n\n<pre><code>IF @i_numrecs = 0\nBEGIN \n    SET @nextid = dbo.Timesheetgetnextid(@EMP, @DATE)\n\n    IF @mode = @c_current\n    BEGIN\n\n        INSERT INTO timedetail (\n            ppenddate,tsdate,empnum,task1,\n            task2,task3,hours,minutes,\n            doecode,duration,SOURCE,enteredby,\n            enteredon,approved,completed,timein,\n            timeout,id)\n        VALUES(\n            @DATE,@DATE,@EMP,' ',\n            ' ',' ',0,0,\n            ' ',0,'BROWSER',@UID,\n            @actiondate,'N','Y',' ',\n            ' ',@nextid)\n\n    END\n    ELSE\n    BEGIN\n\n        INSERT INTO adjst_timedetail (\n            ppenddate,tsdate,empnum,task1,\n            task2,task3,hours,minutes,\n            doecode,duration,SOURCE,enteredby,\n            enteredon,approved,completed,timein,\n            timeout,id)\n        VALUES (\n            @DATE,@DATE,@EMP,' ',\n            ' ',' ',0,0,\n            ' ',0,'BROWSER',@UID,\n            @actiondate,'N','Y',' ',\n            ' ',@nextid)\n\n    END\n\n    --Nothing after this point is executing\n    INSERT INTO timesheetchangelog (\n        empnum,tsdate,tdid,changedate,\n        changeby,SOURCE,changetype)\n    VALUES(\n        @emp,@date,@nextid,@actiondate,\n        @UID,@TCPIP,'COMPLETION INSERT')\n\n    SELECT @changelogid = Scope_identity()\n\n    EXEC Auditrecordaction\n        @emp,\n        @date,\n        @payfrequency,\n        @c_insertaction,\n        @actiondate,\n        @UID,\n        @actionid OUT,\n        @doaudit OUT\n\n    SELECT @doaudit DoAudit, @actionid ActionID\n\n    IF Isnull(@doaudit, 0) &gt; 0\n    BEGIN \n\n        IF @mode = @c_current\n        BEGIN\n\n            INSERT INTO timedetail_audit (\n                EMPNUM,PPENDDATE,TSDATE,TASK1,\n                TASK2,TASK3,HOURS,MINUTES,\n                DOECODE,DURATION,SOURCE,TSGROUP,\n                DEPTCHRG,PAYRATE,TIMEIN,TIMEOUT,\n                ERRORS,COMPLETED,APPROVED,VERIFIED,\n                DELETED,PROCESSEDBYPAYROLL,ID,ENTEREDBY,\n                ENTEREDON,APPROVEDBY,APPROVEDON,PROCESSEDON,\n                QUANTITY,SHIFT,processed_pd,RUNNUMBER,\n                overnight,actionid,logid)\n            SELECT\n                EMPNUM,PPENDDATE,TSDATE,TASK1,\n                TASK2,TASK3,HOURS,MINUTES,\n                DOECODE,DURATION,SOURCE,TSGROUP,\n                DEPTCHRG,PAYRATE,TIMEIN,TIMEOUT,\n                ERRORS,COMPLETED,APPROVED,VERIFIED,\n                DELETED,PROCESSEDBYPAYROLL,ID,ENTEREDBY,\n                ENTEREDON,APPROVEDBY,APPROVEDON,PROCESSEDON,\n                QUANTITY,SHIFT,processed_pd,RUNNUMBER,\n                overnight,@actionid,@changelogid\n            FROM timedetail\n            WHERE empnum = @EMP\n                AND tsdate = @DATE\n                AND id = @nextid\n\n        END\n        ELSE\n        BEGIN\n\n            INSERT INTO timedetail_audit (\n                EMPNUM,PPENDDATE,TSDATE,TASK1,\n                TASK2,TASK3,HOURS,MINUTES,\n                DOECODE,DURATION,SOURCE,TSGROUP,\n                DEPTCHRG,PAYRATE,TIMEIN,TIMEOUT,\n                ERRORS,COMPLETED,APPROVED,VERIFIED,\n                DELETED,PROCESSEDBYPAYROLL,ID,ENTEREDBY,\n                ENTEREDON,APPROVEDBY,APPROVEDON,PROCESSEDON,\n                QUANTITY,SHIFT,processed_pd,RUNNUMBER,\n                overnight,actionid,logid)\n            SELECT\n                EMPNUM,PPENDDATE,TSDATE,TASK1,\n                TASK2,TASK3,HOURS,MINUTES,\n                DOECODE,DURATION,SOURCE,TSGROUP,\n                DEPTCHRG,PAYRATE,TIMEIN,TIMEOUT,\n                ERRORS,COMPLETED,APPROVED,VERIFIED,\n                DELETED,PROCESSEDBYPAYROLL,ID,ENTEREDBY,\n                ENTEREDON,APPROVEDBY,APPROVEDON,PROCESSEDON,\n                QUANTITY,SHIFT,processed_pd,RUNNUMBER,\n                overnight,@actionid,@changelogid\n            FROM adjst_timedetail\n            WHERE empnum = @EMP\n                AND tsdate = @DATE\n                AND id = @nextid\n\n        END\n    END \nEND \n</code></pre>\n"},{"tags":["database","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":71,"score":-1,"question_id":12062792,"title":"Change database context through variable","body":"<p>How can I use a variable as db context?</p>\n\n<pre><code>Create Procedure [dbo].[prName] (@dbname varchar(25)) as\nbegin\nuse master\nsome sql\n&lt;!--  I need to use master for some functions stored in master --&gt;\n\n\nuse @dbname\n\nexec('SELECT column_name FROM INFORMATION_SCHEMA.COLUMNS WHERE [TABLE_CATALOG] = '+@dbname+' and TABLE_NAME=table123')\n\nend\n\nGO\n</code></pre>\n\n<p>Thanks</p>\n"},{"tags":["c#","tsql","fetch"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":260,"score":2,"question_id":5851802,"title":"Create Get Set Properties from Table Name for Views in Class","body":"<p>The below code is a quick script in T-SQL which builds Get Set properties for use in a CLASS:</p>\n\n<pre><code>DECLARE @COLUMN_NAME varchar(250)\nDECLARE @DATA_TYPE varchar(250)\nDECLARE c1 CURSOR FOR\n\nselect COLUMN_NAME, DATA_TYPE from information_schema.columns\nwhere table_name = 'Members'\nOPEN c1\nFETCH NEXT FROM c1 INTO @COLUMN_NAME, @DATA_TYPE\nWHILE @@FETCH_STATUS = 0\nBEGIN\n\nIF @DATA_TYPE = 'nvarchar'\nBEGIN\n    SET @DATA_TYPE = 'string'\nEND\n\nIF @DATA_TYPE = 'ntext'\nBEGIN\n    SET @DATA_TYPE = 'string'\nEND\n\nIF @DATA_TYPE = 'datetime'\nBEGIN\n    SET @DATA_TYPE = 'DateTime'\nEND\n\n\nPRINT 'public ' + @DATA_TYPE + ' ' + @COLUMN_NAME + ' { get; set; }'\n\nFETCH NEXT FROM c1 INTO @COLUMN_NAME, @DATA_TYPE\n\nEND\nCLOSE c1\nDEALLOCATE c1\nGO\n</code></pre>\n\n<p>IF you can add to it or clean it up, it would be great!</p>\n\n<p><strong>UPDATE</strong>\nThe below code is working and I made some slight modification.</p>\n\n<pre><code>DECLARE @Script NVARCHAR(MAX) = ''\n\nSELECT @Script = @Script + '\npublic ' + CASE WHEN DATA_TYPE IN ('nvarchar','ntext') THEN 'string' \n                WHEN DATA_TYPE = 'datetime' THEN 'DateTime' \n                ELSE DATA_TYPE\n            END \n                        + ' ' \n                        + upper(substring(COLUMN_NAME,1,1))+\n                        + lower(substring(COLUMN_NAME,2,499))   \n                        + ' { get; set; }'\nFROM INFORMATION_SCHEMA.COLUMNS\nWHERE TABLE_NAME = 'SubCategory'\n\nPRINT @Script\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":145,"score":1,"question_id":12005383,"title":"Update two tables with a single query in SQL Server","body":"<p>I need to update some information which are stored in two tables. To update one of the table, a JOIN with the other table must be done. I was wondering, if I can update both with a single query. Some posts suggested using a trigger. I was hoping there's another way, since I will have to do it in C#. Also I saw other posts saying it's possible using something like this:</p>\n\n<pre><code>update pd, pr\nset pd.Name = 'Test',\npr.Date = '2012-07-31',\nfrom prDetail pd\nleft join pr on pd.ID = pr.ID\nwhere pd.Code = '45007'\nand pr = '2019'\nand pr.Item = '1'\n</code></pre>\n\n<p>This is not working for me (it's showing this error: <code>Incorrect syntax near ','</code>). Can this be achieved in some way?</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":74,"score":2,"question_id":12048219,"title":"How does sql evaluate ISNUMERIC(ISNULL(VALUE, 'blah'))","body":"<p>My assumption was that it would return a true if that value was numeric (within the isnumeric range) but <code>FALSE</code> if the <code>ISNULL</code> returns <code>'blah'</code>. Seems like my assumption was off...</p>\n\n<p>I'm using the it in the following way</p>\n\n<pre><code>             case\n                   when ISNULL(ISNUMERIC(c.npinumber), 'blah') = 1 then c.NPiNUmber\n                   else 'not valid: ' + c.NpiNumber\n              end as npi \n</code></pre>\n"},{"tags":["tsql","stored-procedures","sybase"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":52,"score":1,"question_id":12060797,"title":"Database chicken and egg issue","body":"<p>I am using Sybase DB with TSQL.</p>\n\n<p>I am trying to work between 2 SPROCS, one nested inside the other.</p>\n\n<p>My outer SPROC will create a temp table <code>#temp_table</code> and fill it up with values to 200. Once the temp table has been populated with 200 entries, it will be used by the inner SPROC for a <code>JOIN</code>.</p>\n\n<p>So essentially, my outer SPROC will have the following (simplified):</p>\n\n<pre><code>CREATE TABLE #temp_table \n(\n  ... columns ...\n)\n</code></pre>\n\n<p>and my inner SPROC will have the following:</p>\n\n<pre><code>SELECT\n  SOME_COLUMNS\nFROM\n  SOME_TABLE\nINNER JOIN\n  #temp_table\nON\n  SOME_CONDITION\n</code></pre>\n\n<p>When I try to test this, I run the script for my inner SPROC and it complains of <code>#temp_table</code> not existing, and fails to create the SPROC in the DB. So when I try to go run my outer SPROC, it will also fail.</p>\n\n<p>Could I please get some pointers on how to solve this problem?</p>\n"},{"tags":["sql-server","tsql","locking","hints"],"answer_count":1,"favorite_count":4,"up_vote_count":14,"down_vote_count":0,"view_count":6996,"score":14,"question_id":1524155,"title":"What effect does HOLDLOCK have on UPDLOCK?","body":"<p>I have seen many examples of the HOLDLOCK hint being used in combination with UPDLOCK (<a href=\"http://stackoverflow.com/questions/497049/which-lock-hints-should-i-use-t-sql/497066#497066\" title=\"example\">like this</a>). However as I read the documentation for these hints, it seems that HOLDLOCK should be redundant, since UPDLOCK already persists the lock until the end of the transaction. (Also it seems to say that HOLDLOCK only applies to shared locks anyway.)</p>\n\n<p><a href=\"http://technet.microsoft.com/en-us/library/ms187373.aspx\" rel=\"nofollow\">http://technet.microsoft.com/en-us/library/ms187373.aspx</a></p>\n\n<p>So how does HOLDLOCK affect the query, if at all?</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":91,"score":2,"question_id":12049281,"title":"Return a rowset and set a variable in an \"IN\" clause in SQL Server","body":"<p>I want use the SQL Server <code>IN</code> operator and also set a variable to a column value. Is this possible?</p>\n\n<p>My code is like this:</p>\n\n<pre><code>DECLARE @SubkindId as tinyint;\n\nSELECT NAME FROM SampleTable001 WHERE \nId in (SELECT Id, @SubkindId = Subkind FROM SampleTable002)\nORDER BY Name;\n</code></pre>\n\n<p>My issue is: I want to set the @SubkindId variable in the inner select statement.</p>\n"},{"tags":["sql","tsql","sql-server-2000"],"answer_count":2,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":1937,"score":1,"question_id":1871246,"title":"Stored Procedure consist Add column, Update data for that column, and Select all data from that table","body":"<p>I've written a stored procedure as following:</p>\n\n<pre><code>  CREATE PROC spSoNguoiThan \n   @SNT int\n    AS \n       begin \n    IF not exists (select column_name from  INFORMATION_SCHEMA.columns where\n                    table_name = 'NhanVien' and   column_name = 'SoNguoiThan')  \n\n        \tALTER TABLE NhanVien ADD   SoNguoiThan int\n    else \n           begin\n    \tUPDATE  NhanVien\n                SET  NhanVien.SoNguoiThan = (SELECT  Count(MaNguoiThan)FROM NguoiThan\n                                             WHERE MaNV=NhanVien.MaNV \n                                             GROUP BY  NhanVien.MaNV)   \n           end   \n\n    SELECT *\n        FROM NhanVien \n    WHERE    SoNguoiThan&gt;@SNT\n end \nGO\n</code></pre>\n\n<p>Then I get the error :</p>\n\n<pre><code>Server: Msg 207, Level 16, State 1, Procedure spSoNguoiThan, Line 12\nInvalid column name 'SoNguoiThan'.\nServer: Msg 207, Level 16, State 1, Procedure spSoNguoiThan, Line 15\nInvalid column name 'SoNguoiThan'.\n</code></pre>\n\n<p>Who can help me?</p>\n\n<p>Thanks!</p>\n"}]}
{"total":16599,"page":20,"pagesize":100,"questions":[{"tags":["sql-server","tsql","rename","exist"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":279,"score":0,"question_id":2793515,"title":"Rename the table Column","body":"<p>I am trying to execute the following query. I don't have 'CrewID' column so in that case it will by pass update part of the script. but it gives error Invalid object CrewID'. Can you please tell me why it excute update part even my if condition does not matched. Is there is another way to do the same. I have the requirement where need to rename the column but before rename i have to copied data in other column and need to excute script many times.</p>\n\n<pre><code>if exists (select * from syscolumns where name ='CrewID' and id in (select id from dbo.sysobjects where id = object_id(N'[dbo].[WorkPlanAssignees]') and OBJECTPROPERTY(id, N'IsUserTable') = 1))\nBEGIN   \nupdate A set A.TempCrewID=B.ID from WorkPlanAssignees A inner join Crew B on A.CrewID=B.ID\nEND\n</code></pre>\n"},{"tags":["sql","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":85,"score":3,"question_id":12058159,"title":"Alternatives to using dynamic sql","body":"<p>I have a sp which takes input @featuretype. @featuretype will be equal to either \"mobile\", \"login\", or \"index\", and will correspond to a column in the db.</p>\n\n<p>In my sp I have:</p>\n\n<pre><code>EXEC(\n    'select TOP 3 * from featuredtypes_v where'+' featuredtypes_v.'+@featuretype+'Page=1'+\n    ' order by featuredtypes_v.priority desc'\n    )\n</code></pre>\n\n<p>However, I've been told this opens up the db to a sql injection. My two questions are, why is this, and how else can I write this query in order to avoid this?</p>\n"},{"tags":["sql-server","tsql","ssis"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":133,"score":1,"question_id":12037357,"title":"T-SQL Conversion error in T-SQL Merge statement","body":"<p>I am trying to build an optimized Slowly Changing Dimension using the Merge statement in T-Sql. I have written the following code to handle SCD1 and SCD2 changes, and also normal inserts in the data table, with data coming from the source table, Name and Age are SCD1 columns, Animal and Blood are SCD2 columns:</p>\n\n<pre><code>DECLARE @LoadingDate DATETIME\nSET @LoadingDate = '2012-08-20 14:23:29.827'\n\n--Handle SCD1 Changes\nMERGE INTO Table_2 AS DIM\n USING SourceTable AS SRC\n ON (DIM.ID1 = SRC.ID1\n    AND DIM.ID2 = SRC.ID2)\n WHEN MATCHED\n    AND (DIM.Name &lt;&gt; SRC.Name \n      OR DIM.AGE &lt;&gt; SRC.AGE)\n    THEN \n    UPDATE \n    SET DIM.Name = SRC.Name,\n    DIM.Age = SRC.Age;\n\n--Handle SCD2 Changes\nINSERT INTO Table_2\n    (ID1, ID2, --Business Key\n     Name, Age, --SCD1 Columns\n     Animal, Blood, --SCD2 Columns\n     DateEffective, DateExpires)\n SELECT\n    ID1, ID2, --Business Key\n     Name, Age, --SCD1 Columns\n     Animal, Blood, --SCD2 Columns\n     DateEffective, DateExpires\nFROM (\nMERGE Table_2 AS DIM\n USING SourceTable AS SRC\n ON (DIM.ID1 = SRC.ID1\n    AND DIM.ID2 = SRC.ID2)\n WHEN NOT MATCHED\n  THEN INSERT VALUES \n  (SRC.ID1, SRC.ID2,\n   SRC.Name, SRC.Age,\n   SRC.Animal, SRC.Blood,\n   @LoadingDate, NULL)\n WHEN MATCHED \n   AND DIM.DateExpires IS NULL\n   AND (DIM.Animal != SRC.Animal\n    OR DIM.Blood != SRC.Blood)\n   THEN UPDATE SET DIM.DateExpires = @LoadingDate\n OUTPUT $action Action_Out,\n   SRC.ID1, SRC.ID2,\n   SRC.Name, SRC.Age,\n   SRC.Animal, SRC.Blood,\n   @LoadingDate AS DateEffective,\n   NULL AS DateExpires) AS MERGE_OUT\n WHERE MERGE_OUT.Action_Out = 'UPDATE';\n</code></pre>\n\n<p>The code works fine with SCD1 changes(first part of the code), but it gives me the error:\n<img src=\"http://i.stack.imgur.com/pCG4A.jpg\" alt=\"enter image description here\">\nThe error appears when it tries to insert a new row, for which the business keys ID1 and ID2 don't match with any other row from the Data Table, and \"Labus\" is the value in the name field.</p>\n\n<p>Both tables are designed like in the following picture, but the SourceTable doesn't have housekeeping columns:\n<img src=\"http://i.stack.imgur.com/txMh0.jpg\" alt=\"enter image description here\"></p>\n\n<p>I would really appreaciate some help.\nThanks!</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":75,"score":1,"question_id":12056472,"title":"Unable to get total count in my query","body":"<p>Here is my query for getting total count.</p>\n\n<pre><code>SELECT       \n    MemberShipMaster.Id,   \n    MemberShipMaster.Name,  \n    TotalCount = \n    (\n        SELECT\n            ISNULL(COUNT(MemberPortfolio.Id), 0) AS total\n        FROM\n            JFPMembers\n            INNER JOIN MemberPortfolio \n                ON JFPMembers.MemberID = MemberPortfolio.MemberId\n        WHERE\n            JFPMembers.MembershipType = MemberShipMaster.Id \n            AND JFPMembers.IsActive = 1\n            AND MemberPortfolio.IsActive = 1\n    )  \nFROM\n    MemberShipMaster\n    Left JOIN JFPMembers\n        ON MemberShipMaster.Id = JFPMembers.MembershipType   \nWHERE\n    MemberShipMaster.Id &lt;&gt; 6\nGROUP BY\n    MemberShipMaster.Id,\n    MemberShipMaster.Name\nOrder by\n    MemberShipMaster.Name   \n</code></pre>\n\n<p>Below are my table schema</p>\n\n<pre><code>SELECT [MemberID]        -- PK \n    ,[MembershipType]  --FK , table [MemberShipMaster]\nFROM JFPMembers\n\nSELECT [Id]       -- PK\n    ,[MemberId] -- FK OF Table JFPMembers         \nFROM MemberPortfolio\n\nSELECT [Id]  --PK\n    ,[Name]\nFROM MemberShipMaster\n</code></pre>\n\n<p>What I need is the Total Count of member Portfolios , by MembershipType, i.e my relationship is something like this, JFPMembers is primary table for holding member info. There are 3 categories of members, Premium, Corporate and General. These three types are stored in MemberShipMaster. Ids are 3,4,and 5 respectively. There is one more table for holding Portfolio which as MemberId to relate its respective member.</p>\n\n<p>But I am getting some multi valued or reference error with MemberShipMaster.Id . Please help me...</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":53,"score":2,"question_id":12057625,"title":"Difference Between \"When the Job Succeeds\" and \"When the Job Completes\"","body":"<p>What is the difference between the job notification options \"When the Job Succeeds\" and \"When the Job Completes\".  From the looks of it, I assume \"When the Job Completes\" option encompasses both job successes and job failures, while \"When the Job Succeeds\" option encompasses only when the job runs succesfully.  Is this correct?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":47,"score":0,"question_id":12056107,"title":"Selecting most recent child record from master table based on date","body":"<p>I'm trying to combine the data in two tables. The first (child) table contains some payment information with an effective date, employee number &amp; payment value. </p>\n\n<pre><code>emp_no  date_earn   Amount\n456789  03/10/2009  20\n456789  18/03/2010  30\n456789  17/03/2011  12\n456789  16/03/2012  34\n</code></pre>\n\n<p>The other (master) table contains employee number, effective date  &amp; job title.</p>\n\n<pre><code>emp_no  effective_date  job_title \n456789  01/01/2009      Tester\n456789  20/05/2010      Manager\n456789  01/04/2011      Snr Manager\n</code></pre>\n\n<p>I need to report on the pay information table &amp; display which job title was in place at the time of the pay informations effective date:</p>\n\n<pre><code>emp_no  date_earn   Amount  job_title \n456789  03/10/2009  20      Tester\n456789  18/03/2010  30      Manager\n456789  17/03/2011  12      Manager\n456789  16/03/2012  34      Snr Manager\n</code></pre>\n\n<p>I've tried using a correlated query such as: </p>\n\n<pre><code>select p.emp_no, p.date_earn, p.amount,\n(select top 1 e.job_title from emp_hist e\nwhere e.emp_no = p.emp_no\nand e.effective_date &lt;= p.date_earn ) as JOB_TITLE\nfrom \npay p where p.emp_no = 456789\n</code></pre>\n\n<p>but based on the example above would give me the job Tester for all rows. I'd really appreciate it if someone can help on this. Many thanks.</p>\n"},{"tags":["sql","sql-server-2008","tsql","date"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":55,"score":1,"question_id":12048638,"title":"Display dates from two fields","body":"<p>I have a table with two columns <code>startdate</code> and <code>enddate</code> (of type <code>DATETIME</code>). When I pass two parameters that is start and end date, I need to display all the dates between the two dates from two columns.</p>\n\n<p>i.e.. I have this table:</p>\n\n<pre><code> startdate  enddate\n ---------------------\n 6/1/2012   6/7/2012\n 6/5/2012   6/9/2012\n 6/10/2012  6/15/2012\n</code></pre>\n\n<p>When I pass two dates like <code>6/3/2012</code> and <code>6/20/2012</code>, I want to display this result set:</p>\n\n<pre><code>  6/5/2012\n  6/7/2012\n  6/9/2012\n  6/10/2012\n  6/15/2012\n</code></pre>\n\n<p>Thanks in advance</p>\n"},{"tags":["sql-server","tsql","triggers","primary-key"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":114,"score":0,"question_id":12055863,"title":"update null primary key in a trigger using SQL Server","body":"<p>I'm migrating our system from Oracle to SQL SERVER. In Oracle we have insert triggers that are resposnible for setting primary key if not set. Below you will find code from PL/SQL.</p>\n\n<pre><code>create or replace trigger trigg1\n before insert on table1\n  for each row\n   when (new.ID_T1 is null) -- if primary key is null\n begin\n   select OUR_SEQ.nextval into :new.ID_T1 from dual;\nend trigg1;\n</code></pre>\n\n<p>Now I have to do something similar in T-SQL. I found the solution, but unfortunatelly I have to list all the columns for the table trigger is created. This is something I want to avoid (model for the system is still very dynamic).</p>\n\n<p>Is it possible to implement such trigger without listing all the columns in trigger?</p>\n\n<p>Marcin</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":3755,"score":2,"question_id":1248512,"title":"How can I get the almost last substring from \"/\" delimited string in T-SQL?","body":"<p>If I've got a string that consists of other strings delimited with \"/\" character (xxx...xxx/xxx/xxxx) how can I get the last and the almost last (the one before last) part with t-sql? It should probably be some combination of charindex() and right(). </p>\n"},{"tags":["c#","xml","tsql","ado.net","sqlparameters"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":129,"score":1,"question_id":12034982,"title":"SQLParameter of XML type with whitespace elements, loses the whitespace?","body":"<p>I've got a problem with SQLParameter when I try to use one to store into a column of XML type. I am creating the parameter of SqlDbType.Xml. It appears that any XML Elements that are only white space are converted to closed elements. </p>\n\n<p>This is the same behaviour as </p>\n\n<pre><code>SELECT CAST('&lt;Cust&gt;&lt;Fname&gt;Andrew&lt;/Fname&gt;&lt;Lname&gt; &lt;/Lname&gt;&lt;/Cust&gt;' as XML) \nVS \nSELECT CONVERT(xml, '&lt;Cust&gt;&lt;Fname&gt;Andrew&lt;/Fname&gt;&lt;Lname&gt; &lt;/Lname&gt;&lt;/Cust&gt;', 1)\n</code></pre>\n\n<p>I'm surprised to see that as the default behaviour within SQLParameter. Is there some way to make a SQLParameter of SqlDbType.Xml care about its white space? As a shot in the dark i tried setting the Precision to 1, but that didn't help it...</p>\n\n<p>The code below ends up with this in the database</p>\n\n<pre><code>&lt;Cust&gt;&lt;Fname&gt;Andrew&lt;/Fname&gt;&lt;Lname /&gt;&lt;/Cust&gt;\n</code></pre>\n\n<p>As you can see it strips out the whitespace XML element</p>\n\n<pre><code>// CREATE TABLE T(c1 int primary key, c2 xml)\nstatic void Main(string[] args) {\n\nusing (var Connection = new System.Data.SqlClient.SqlConnection(\"Data Source=localhost;Initial Catalog=Test;Integrated Security=SSPI;\"))\n{\n    Connection.Open();\n\n    using (var Command = Connection.CreateCommand())\n    {\n      Command.CommandText = \"INSERT INTO T VALUES (1, @s)\";\n\n      var XmlParameter = Command.Parameters.Add(\"s\", System.Data.SqlDbType.Xml);\n      XmlParameter.Value = \"&lt;Cust&gt;&lt;Fname&gt;Andrew&lt;/Fname&gt;&lt;Lname&gt;  &lt;/Lname&gt;&lt;/Cust&gt;\";\n\n      Command.ExecuteNonQuery();\n    }\n\n    Connection.Close();\n}\n</code></pre>\n\n<p>Does anyone know of a way to solve it that isn't parsing the parameter in as binary and the converting it as part of the insert/update command?</p>\n\n<pre><code>Command.CommandText = \"INSERT INTO T VALUES (1, CONVERT(xml, @s, 1))\";\n</code></pre>\n\n<p>Any help or feedback would be greatly appreciated.</p>\n"},{"tags":["php","sql","sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":708,"score":0,"question_id":3348836,"title":"PHP with SQL Server: strtotime() with SQL Server DATETIME column","body":"<p>So I have SQL Server datetime field, and in PHP I want to use this as a UNIX TIMESTAMP, because I want to use it with strtotime, in order to add 14 days into it. Eg. If it is stored in the SQL Server database as: 2010-07-27 13:12:22.040    I want to add 14 days into it to become   2010-08-10 13:12:22.040</p>\n\n<p>How would I do that using PHP with SQL Server datetime field? strtotime() command takes only UNIX timestamp.</p>\n\n<p>If can't be done in PHP with SQL Server , how would I do it in SQL Server and then select it with the values I am selecting?</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":53,"score":1,"question_id":12052026,"title":"Compare two table ids and create third column based on same ids","body":"<p>I have two sql tables, one with id and name and other with id. I want to get as result - table with 3 columns, first id, second name, third true/false if id is in both tables or not. for example :</p>\n\n<pre>\nTable 1       Table 2   result ->   Table 3\n1   Mike      2                     1 Mike false \n2   John      4                     2 John true\n3   Roger                           3 Roger false\n4   Richard                         4 Richard true\n</pre>\n\n<p>this is what I wan`t to accomplish. Do you have any suggestions</p>\n"},{"tags":["sql-server","tsql","date"],"answer_count":8,"favorite_count":4,"up_vote_count":16,"down_vote_count":0,"view_count":29593,"score":16,"question_id":607817,"title":"Get dates from a week number in T-SQL","body":"<p>In Microsoft SQL Server, I have a week number </p>\n\n<pre><code>(from DATEPART(wk, datecol)) \n</code></pre>\n\n<p>but what I would like to do is turn this back into the date span for that week.</p>\n\n<p>For example, </p>\n\n<pre><code>SELECT DATEPART(wk, GETDATE())\n</code></pre>\n\n<p>yields 10.  I would like to derive 3/1/2009 and 3/7/2009 from this number.</p>\n\n<p>Is this possible?</p>\n"},{"tags":["sql-server","sql-server-2005","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":601,"score":0,"question_id":3627282,"title":"converting date field format","body":"<p>I have a field with birthday as either '7/08/1986' or '07/08/1986'.</p>\n\n<p>I want to convert the value to like this '1986/08/07'. Simply converting from <strong>DD/MM/YYYY</strong> to <strong>YYYY/MM/DD</strong>. Kindly note down this is all in SQL Server 2005.</p>\n\n<p>Additionally, if the date is in single digit means still the output shd be shown in double digit like '07' not '7'.</p>\n\n<p>How do I do this conversion?</p>\n\n<p>Your kind replies will help me out. My thanks in advance.</p>\n"},{"tags":["sql","tsql","pivot","sql-server-2012","data-manipulation"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":78,"score":2,"question_id":12049056,"title":"Pivot cateorical values into boolean columns SQL","body":"<p>I'm looking to 'flatten' my dataset in order to facilitate data mining.\nEach categorical column should be changed to multiple Boolean columns.\nI have a column with categorical values, e.g.:</p>\n\n<pre><code> ID    col1\n  1     A\n  2     B\n  3     A\n</code></pre>\n\n<p>I'm looking for a way to pivot this table, and have an aggregated function telling me whether this ID has value A or B:</p>\n\n<p>Result:</p>\n\n<pre><code> ID    col1A    col1B\n  1     1        0\n  2     0        1\n  3     1        0\n</code></pre>\n\n<p>I tried using PIVOT but have no idea which aggregated function to use inside it.</p>\n\n<p>Also looked for answers in SF but couldn't find any...</p>\n\n<p>I'm using MS-SQL 2012.</p>\n\n<p>Any help would be appreciated!\nOmri</p>\n\n<p>EDIT:</p>\n\n<p>The number of categories in col1 is unknown, therefore the solution must be dynamic.\nThanks :)</p>\n"},{"tags":["tsql","date","datetime","dynamic","time"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":47,"score":1,"question_id":12032117,"title":"How to format manipulated DateTime fields in dynamic TSQL","body":"<p>I have a query that looks basically like this, wrapped in a dynamic query to accommodate table names that can change.  I got the date functions in the middle converted but it doesn't like the LoadedDateTime and CallPlacedTime at the end.  I've tried every conversion and combination of quoting those lines that I can think of.  How can I accomplish this?</p>\n\n<pre><code>DECLARE @sql_TotalDialsNewLeads nvarchar(1000) = N'\n SELECT COUNT(*)\n   FROM ' + @tbl_CH + ' ch, ' + @tbl_CL + ' cl, ' + @tbl_DA + ' da\n  WHERE ch.IDENTITY = cl.IDENTITY\n    AND cl.CRMID = da.CRMID\n    AND CallPlacedTime BETWEEN ''' +  CONVERT(varchar(30),DATEADD(HOUR,-@TimezoneOffset,@StartDate),126) + '''\n                           AND ''' +  CONVERT(varchar(30),DATEADD(HOUR,-@TimezoneOffset,@EndDate),126) + '''\n    AND Product = ''' + @Product + '''\n    AND Country = ''' + @Country + '''\n    AND DATEPART(DayOfYear,DATEADD(HOUR,-@TimezoneOffset,LoadedDateTime))\n      = DATEPART(DayOfYear,DATEADD(HOUR,-@TimezoneOffset,CallPlacedTime))'\n\n EXECUTE(@sql_TotalDialsNewLeads);\n</code></pre>\n\n<p>Thanks,\nSean</p>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":120,"score":0,"question_id":12043549,"title":"inserting into two tables from one sp","body":"<p>I'm working on an sp that inserts data into two tables. The two tables are featured and featured type, both have a pk featuredid that gets auto incremented each time something is added. I have:</p>\n\n<pre><code>        insert into featured\n        (title,text,imageURL, priority )\n        values\n        (@title,@text,@imageURL, @priority),\n\n        insert into featuredtype\n        (loginPage, indexPage, mobilePage)\n        values\n        (@loginPage, @indexPage, @mobilePage)\n</code></pre>\n\n<p>However, it appears this is not the correct method for inserting into two tables from one sp.</p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":53,"score":0,"question_id":12009942,"title":"How do I save results from a pass through query to a local table?","body":"<p>I need to submit a series of queries to an Oracle server over ODBC from an MS SQL server and store the results as a table on the MS SQL server.</p>\n\n<p>It has to be a pass through because the query requires a server side function defined on the Oracle server.\nI can't save the table on the Oracle server and then access it via ODBC because of licensing restrictions from the vendor of the db running on Oracle.</p>\n\n<p>Here's the code that returns the correct results, but I don't know how to save them:</p>\n\n<pre><code>DECLARE @BibID AS bigint\n\nDECLARE BibList CURSOR FOR \n    SELECT BIB_ID FROM tblActiveSerialsThatHave740s\nOPEN BibList \n\nFETCH NEXT FROM BibList INTO @BibID\nWHILE @@FETCH_STATUS=0\nBEGIN\n    EXECUTE \n    ('SELECT \n        AMDB.BIB_DATA.BIB_ID As BIB_ID, \n        AMDB.GetAllBibTag(AMDB.BIB_DATA.BIB_ID, ''740'', ''2'') As F740_All \n    FROM \n        AMDB.BIB_DATA \n    WHERE\n        AMDB.BIB_DATA.BIB_ID = ' + @BibID + '\n    GROUP BY BIB_ID '\n    )\n    AT REPORT\n    FETCH NEXT FROM BibList INTO @BibID\nEND\n\nDEALLOCATE BibList\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":51,"score":-1,"question_id":12046603,"title":"joining on another table causes sum to be greater","body":"<p>when i join two tables together and get the sum, i am getting the correct figure:</p>\n\n<pre><code>select \n    d.accn_id,\n    cast(d.load_date as DATE) as LoadDate,\n    cast (d.final_rpt_date as DATE) as FinalReportDate,\n    sum(p.paid_amt) as SumPaidAmt\n\nfrom\n    accn_demographics d\njoin \n    accn_payments p\non \n    d.ACCN_ID=p.ACCN_ID\nwhere \n    p.POSTED='y'\n    and p.PMT_DATE between '20120501' and '20120531'\n\ngroup by \n    d.accn_id,\n    d.load_date,\n    d.final_rpt_date\n</code></pre>\n\n<p>however after i join ANOTHER table accn_payors:</p>\n\n<pre><code>select \n    d.accn_id,\n    cast(d.load_date as DATE) as LoadDate,\n    cast (d.final_rpt_date as DATE) as FinalReportDate,\n    sum(p.paid_amt) as SumPaidAmt\n    ,payors.PAYOR_ID\nfrom\n    accn_demographics d\njoin \n    accn_payments p\non \n    d.ACCN_ID=p.ACCN_ID\nleft join \n    accn_payors payors\non  \n    payors.X_PAYOR_ID=p.X_PRICED_PAYOR_ID \n    and payors.ACCN_ID = p.ACCN_ID\nwhere \n    p.POSTED='y'\n    and p.PMT_DATE between '20120501' and '20120531'\n\ngroup by \n    d.accn_id,\n    d.load_date,\n    d.final_rpt_date\n    ,payors.PAYOR_ID\n</code></pre>\n\n<p>i am getting an overstatement of <code>sum(p.paid_amt)</code></p>\n\n<p>the question is how can i adjust my join so that i am not joining multiple times?</p>\n"},{"tags":["c#","asp.net","sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":171,"score":3,"question_id":12045479,"title":"What is the best way to loop through sql (SQL or Asp.net C#)?","body":"<p>I am creating a list to send an e-mail to.  The individual who is logged in has a field in the database of who they report to (unless there is an error or they report to no one).</p>\n\n<p>So for instance if I am logged in and clicked the submit button in SQL it would say I report to 'John Doe'</p>\n\n<p>I then need to grab who 'John Doe' reports to and add that to the list.  I need to keep climbing the list until we reach the top of the company (the GID will be blank or null).</p>\n\n<p>Using me as an example, I report to <code>'John Doe'</code> who reports to <code>'Tom Doe'</code>.  Tom reports to no-one his <code>usrReportsTo</code> field is like this <code>'00000000-0000-0000-0000-000000000000'</code>.</p>\n\n<p>If the usrReportsTo field is <code>\"\"</code> or <code>NULL</code> or <code>'00000000-0000-0000-0000-000000000000'</code> the loop should terminate.</p>\n\n<p>Here is the sql I used.</p>\n\n<p>What is the cleanest/neatest/most effecient way to perform this loop and is it better to do it in SQL or ASP.net C#?</p>\n\n<pre><code>select usrReportsTo from dbo.CVT_Users_usr, usrEmailAddress\nWHERE RTRIM(usrFirstName) + ' ' + RTRIM(usrLastName) = 'James Wilson' \n-- Returns 'James Wilson' + email\n\nSELECT RTRIM(usrFirstName) + ' ' + RTRIM(usrLastName) as Name, usrEmailAddress, usrReportsTo from dbo.CVT_Users_usr\nWHERE usrGID = '38922F83-4B6E-499E-BF4F-EF0B094F47F7'\n-- Returns 'John Doe' + email + reportsTo\n\nSELECT RTRIM(usrFirstName) + ' ' + RTRIM(usrLastName) as Name, usrEmailAddress, usrReportsTo from dbo.CVT_Users_usr\nWHERE usrGID = 'FB8F4939-3956-4834-9D89-D72AFB8BF3E0'\n-- Returns 'Tom Doe' + email + reportsTo\n</code></pre>\n\n<p>Edit #3</p>\n\n<p>Working copy of SQL just doesn't return 100% true data.</p>\n\n<p>with cte\nAS\n(\nselect usrGID, RTRIM(usrFirstName) + ' ' + RTRIM(usrLastName) as Name, usrEmailAddress, usrReportsTo from dbo.CVT_Users_usr\nunion all\nselect u.usrGID, RTRIM(u.usrFirstName) + ' ' + RTRIM(u.usrLastName), cte.usrEmailAddress, cte.usrReportsTo from dbo.CVT_Users_usr u\n    inner join cte on u.usrReportsTo = cte.usrGID\n)\n    select * from cte\n    where Name = 'James Wilson'</p>\n\n<p>-- Returns</p>\n\n<p>usrGID                                    Name        usrEmailAddress   usrReportsTo\nE1DAFC11-BE35-4730-9961-68EEF8D85DE4    James Wilson                38922F83-4B6E-499E-BF4F-EF0B094F47F7\nE1DAFC11-BE35-4730-9961-68EEF8D85DE4    James Wilson    john@1234.com   FB8F4939-3956-4834-9D89-D72AFB8BF3E0\nE1DAFC11-BE35-4730-9961-68EEF8D85DE4    James Wilson    tom@1234.com    00000000-0000-0000-0000-000000000000</p>\n\n<p>Shouldn't the usrGID and name match the same way usrEmailAddress and usrReportsTo does?  I tried chaanging the sql to be cte.USRGID and cte.Name but it gave the max recursion error.</p>\n\n<p>Any ideas?</p>\n"},{"tags":["sql","sql-server-2005","tsql","stored-procedures"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":5450,"score":2,"question_id":6388489,"title":"Insert Into temp table from a stored procedure that returns multiple result sets","body":"<p>Consider the following sql</p>\n\n<p>A stored proc called myProc which returns two result sets.  Result set 1 returns column1, column2.  Result set 2 returns column 3, column 4, column 5.</p>\n\n<p>The following sql will fail since the temp table only has defined 2 int columns.</p>\n\n<pre><code>Create Table #temp1(\nColumn1 int,\nColumn2 int)\n\ninsert into #temp1 exec myProc\n</code></pre>\n\n<p>My question is is it possible to just insert the first result set into #temp1?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":0,"down_vote_count":1,"view_count":87,"score":-1,"question_id":12044673,"title":"joining table causes exponential increase in query time","body":"<p>my query has been running for 30 minutes so far:</p>\n\n<pre><code>SELECT \n   d.accn_id,\n   cast(d.load_date as DATE) as LoadDate,\n   cast (d.final_rpt_date as DATE) as FinalReportDate,\n   sum(p.paid_amt) as SumPaidAmt,\n   payors.PAYOR_ID\nFROM accn_demographics d\n    JOIN accn_payments p\n        ON d.ACCN_ID=p.ACCN_ID    \n    JOIN accn_payors payors\n        ON payors.X_PAYOR_ID=p.X_PAYMENT_PAYOR_ID\nWHERE\n      p.POSTED = 'y'\n  AND p.PMT_DATE between '20120401' and '20120430'    \nGROUP BY\n    d.accn_id,\n    d.load_date,\n    d.final_rpt_date,\n    payors.PAYOR_ID\n</code></pre>\n\n<p>before i add this table:</p>\n\n<pre><code>accn_payors\n</code></pre>\n\n<p>the query took a few minutes, but after adding this table, i am still waiting after 30 minutes.</p>\n\n<p>here are the 3 tables:</p>\n\n<pre><code>USE [zzzDataEOMTestingApril]\nGO\n\n/****** Object:  Table [dbo].[accn_payors]    Script Date: 08/20/2012 13:28:20 ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nSET ANSI_PADDING ON\nGO\n\nCREATE TABLE [dbo].[accn_payors](\n    [ACCN_ID] [varchar](40) NULL,\n    [PAYOR_PRIORITY] [int] NULL,\n    [PAYOR_ID] [varchar](15) NULL,\n    [PAYOR_NAME] [varchar](40) NULL,\n    [GROUP_ID] [varchar](40) NULL,\n    [PLAN_ID] [varchar](40) NULL,\n    [SUBSCRIBER_ID] [varchar](40) NULL,\n    [INSURED_RELATIONSHIP] [varchar](6) NULL,\n    [INSURED_L_NAME] [varchar](40) NULL,\n    [INSURED_F_NAME] [varchar](40) NULL,\n    [INSURED_HOME_PHN] [varchar](40) NULL,\n    [INSURED_WORK_PHN] [varchar](40) NULL,\n    [INSURED_ADDR1] [varchar](60) NULL,\n    [INSURED_ADDR2] [varchar](60) NULL,\n    [INSURED_CITY] [varchar](60) NULL,\n    [INSURED_STATE] [varchar](2) NULL,\n    [INSURED_ZIPCODE] [varchar](10) NULL,\n    [PAID_IN_FULL] [varchar](1) NULL,\n    [CLAIM_COMMENT] [varchar](4000) NULL,\n    [OTHER_INFO1] [varchar](4000) NULL,\n    [OTHER_INFO2] [varchar](4000) NULL,\n    [OTHER_INFO3] [varchar](4000) NULL,\n    [OTHER_INFO4] [varchar](4000) NULL,\n    [INTERNAL_NOTES] [varchar](4000) NULL,\n    [SYSTEM_ADDED_PAYOR] [varchar](1) NULL,\n    [ELIG_OK] [varchar](1) NULL,\n    [ELIG_STATUS] [varchar](40) NULL,\n    [ELIG_SERVICE] [varchar](40) NULL,\n    [ELIG_VERIF_ID] [varchar](15) NULL,\n    [AUD_REC_ID] [int] NOT NULL,\n    [INSURED_DOB] [varchar](50) NULL,\n    [INSURED_SEX] [varchar](3) NULL,\n    [EMPLOYER_NAME] [varchar](40) NULL,\n    [EMPLOYER_ADDR1] [varchar](60) NULL,\n    [EMPLOYER_ADDR2] [varchar](60) NULL,\n    [EMPLOYER_CITY] [varchar](60) NULL,\n    [EMPLOYER_STATE] [varchar](2) NULL,\n    [EMPLOYER_ZIPCODE] [varchar](10) NULL,\n    [EMPLOYER_COUNTRY] [varchar](40) NULL,\n    [EMPLOYER_PHONE] [varchar](40) NULL,\n    [EMPLOYMENT_STATUS] [varchar](40) NULL,\n    [GROUP_NAME] [varchar](40) NULL,\n    [X_PAYOR_ID] [int] NULL,\n    [AUDIT_DATE] [varchar](50) NULL,\n    [OCCURRENCE_CODE] [varchar](30) NULL,\n    [INSURED_SSN] [int] NULL,\n    [OCCURRENCE_CODE_DATE] [datetime] NULL,\n    [DELAY_REASON_CODE] [varchar](15) NULL,\n    [CASE_ID] [varchar](60) NULL,\n    [PAYOR_CODE_TYPE] [varchar](400) NULL,\n    [AUTH_NUM] [varchar](40) NULL,\n CONSTRAINT [PK_accn_payors] PRIMARY KEY CLUSTERED \n(\n    [AUD_REC_ID] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY]\n\nGO\n\nSET ANSI_PADDING OFF\nGO\n\n\nUSE [zzzDataEOMTestingApril]\nGO\n\n/****** Object:  Table [dbo].[accn_payments]    Script Date: 08/20/2012 13:28:35 ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nSET ANSI_PADDING ON\nGO\n\nCREATE TABLE [dbo].[accn_payments](\n    [ACCN_ID] [varchar](40) NULL,\n    [PMT_SEQUENCE] [int] NULL,\n    [DEPOSIT_ID] [int] NULL,\n    [DEPOSIT_BATCH_ID] [int] NULL,\n    [DEPOSIT_BATCH_SEQ] [int] NULL,\n    [PROC_CODE] [varchar](40) NULL,\n    [PMT_TYPE] [varchar](40) NULL,\n    [USER_ID] [varchar](20) NULL,\n    [NOTE] [varchar](4000) NULL,\n    [PMT_DATE] [datetime] NULL,\n    [CHECK_NUM] [varchar](40) NULL,\n    [RECEIPT_NUM] [varchar](40) NULL,\n    [ALLOWED_AMT] [float] NULL,\n    [DEDUCT_AMT] [float] NULL,\n    [PAID_AMT] [float] NULL,\n    [COPAY_AMT] [float] NULL,\n    [POSTED] [varchar](1) NULL,\n    [BULK] [varchar](1) NULL,\n    [UNITS_PAID] [int] NULL,\n    [BILL_AMT_FROM_EOB] [float] NULL,\n    [PAYMENT_PAYOR_ID] [varchar](15) NULL,\n    [PRICED_PAYOR_ID] [varchar](15) NULL,\n    [AUD_REC_ID] [int] NULL,\n    [X_ACCN_BILLED_PROCEDURE_ID] [int] NULL,\n    [X_PRICED_PAYOR_ID] [int] NULL,\n    [X_PAYMENT_PAYOR_ID] [int] NULL,\n    [CLIENT_PRIMARY_FACILITY_ID] [varchar](15) NULL,\n    [REMIT_FILE_NAME] [varchar](128) NULL,\n    [BATCH_POSTED] [varchar](1) NULL,\n    [DEPOSIT_POSTED] [varchar](1) NULL,\n    [AUDIT_DATE] [datetime] NULL,\n    [ACCEPT_ASSIGNMENT] [varchar](1) NULL,\n    [EXPECT_PRICE_DISCREPENCY_AMT] [float] NULL,\n    [PRINT_NOTE] [varchar](1) NULL,\n    [PATIENT_RESP_AMT] [float] NULL,\n    [EOB] [varchar](40) NULL,\n    [ICN] [varchar](30) NULL,\n    [DEPOSIT_NOTE] [varchar](40) NULL,\n    [NETWORK_ID] [varchar](100) NULL,\n    [USE_EXPECT_PRICE] [varchar](1) NULL,\n    [CO_INS_AMT] [float] NULL,\n    [REMIT_DATE] [datetime] NULL\n) ON [PRIMARY]\n\nGO\n\nSET ANSI_PADDING OFF\nGO\n\n\nUSE [zzzDataEOMTestingApril]\nGO\n\n/****** Object:  Table [dbo].[accn_demographics]    Script Date: 08/20/2012 13:28:48 ******/\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nSET ANSI_PADDING ON\nGO\n\nCREATE TABLE [dbo].[accn_demographics](\n    [ACCN_ID] [varchar](40) NULL,\n    [STATUS] [varchar](15) NULL,\n    [CLIENT_ID] [varchar](15) NULL,\n    [CLIENT_NAME] [varchar](60) NULL,\n    [REQ_ID] [varchar](20) NULL,\n    [DOS] [datetime] NULL,\n    [SEX] [varchar](3) NULL,\n    [PT_ID] [varchar](40) NULL,\n    [ORDERING UPIN] [bit] NULL,\n    [PT_L_NAME] [varchar](40) NULL,\n    [PT_F_NAME] [varchar](40) NULL,\n    [PT_AGE] [varchar](40) NULL,\n    [DOB] [date] NULL,\n    [PT_HOME_PHM] [varchar](40) NULL,\n    [PT_WORK_PHN] [varchar](40) NULL,\n    [PT_ADDR1] [varchar](60) NULL,\n    [PT_ADDR2] [varchar](60) NULL,\n    [PT_ZIPCODE] [varchar](10) NULL,\n    [PT_CITY] [varchar](60) NULL,\n    [PT_ST_ID] [varchar](2) NULL,\n    [PT_SSN] [int] NULL,\n    [RECEIPT_DATE] [datetime] NULL,\n    [INDIGENT_PCT] [float] NULL,\n    [PRICE_DATE] [datetime] NULL,\n    [EXPECT_PRICE] [float] NULL,\n    [BILL_PRICE] [float] NULL,\n    [GROSS_PRICE] [float] NULL,\n    [DUE_AMT] [float] NULL,\n    [ACCOUNTING_DATE] [datetime] NULL,\n    [FINAL_RPT_DATE] [datetime] NULL,\n    [TIME_OF_SERVICE] [varchar](20) NULL,\n    [NO_CHARGE] [varchar](1) NULL,\n    [AUD_REC_ID] [int] NULL,\n    [ORIGINAL_ACCOUNTING_DATE] [datetime] NULL,\n    [PT_COUNTRY] [varchar](40) NULL,\n    [PHLEB_FACILITY] [varchar](40) NULL,\n    [FASTING_TYPE] [varchar](40) NULL,\n    [PT_LOCATION] [varchar](40) NULL,\n    [PHLEB_USER_ID] [varchar](40) NULL,\n    [PRIMARY_CLIENT_ID] [varchar](15) NULL,\n    [PHYSICIAN_SOF] [varchar](1) NULL,\n    [PATIENT_SOF] [varchar](1) NULL,\n    [STAT] [varchar](1) NULL,\n    [CALLBACK] [varchar](1) NULL,\n    [PT_REPORT_COPY] [varchar](1) NULL,\n    [PT_EMAIL] [varchar](40) NULL,\n    [PAID_IN_FULL] [varchar](1) NULL,\n    [CLIENT_STATEMENT_DATE] [datetime] NULL,\n    [RETRO_BILL_PRICE] [float] NULL,\n    [PATIENT_TYPE] [varchar](40) NULL,\n    [REFERRING_UPIN] [bit] NULL,\n    [PRIMARY_UPIN] [bit] NULL,\n    [LOAD_DATE] [datetime] NULL,\n    [TRIP_STOPS] [int] NULL,\n    [TRIP_MILES] [int] NULL,\n    [ROUND_TRIP] [varchar](1) NULL,\n    [TRIP_PATIENT_COUNT] [int] NULL,\n    [ADMISSION_SOURCE] [varchar](40) NULL,\n    [EMERGENCY] [varchar](1) NULL,\n    [ACCIDENT_CAUSE] [varchar](40) NULL,\n    [PATIENT_MARITAL_STATUS] [varchar](40) NULL,\n    [ADMISSION_TYPE] [varchar](40) NULL,\n    [PATIENT_STATUS] [varchar](200) NULL,\n    [WORPCOMP_CASE_WORKER] [varchar](80) NULL,\n    [MRO] [varchar](40) NULL,\n    [X_CLIENT_ID] [int] NULL,\n    [X_PRIMARY_CLIENT_ID] [int] NULL,\n    [AUDIT_DATE] [datetime] NULL,\n    [ORDERING_NPI] [bit] NULL,\n    [REFERRING_NPI] [bit] NULL,\n    [PRIMARY_NPI] [bit] NULL,\n    [CLIENT_PRODUCT] [int] NULL,\n    [ONSET_DATE] [date] NULL,\n    [ONSET_TYPE] [varchar](10) NULL,\n    [ACCIDENT_STATE_ID] [varchar](2) NULL,\n    [TRADE_DISCOUNT_AMOUNT] [float] NULL,\n    [RETRO_TRADE_DISC_AMT] [float] NULL,\n    [PATIENT_PREGNANT] [varchar](1) NULL,\n    [PATIENT_GRAVIDA] [int] NULL,\n    [ORDERING_PHYS_NAME] [varchar](80) NULL,\n    [X_ORDERING_PHYS_ID] [int] NULL,\n    [REFERRING_PHYS_NAME] [varchar](80) NULL,\n    [X_ REFERRING_PHYS_ID] [int] NULL,\n    [PRIMARY_PHYS_NAME] [varchar](80) NULL,\n    [X_ PRIMARY _PHYS_ID] [int] NULL,\n    [ADMISSION_DT] [date] NULL,\n    [ADMISSION_TIME] [varchar](5) NULL,\n    [DISCHARGE_DT] [date] NULL,\n    [DISCHARGE_TIME] [varchar](5) NULL\n) ON [PRIMARY]\n\nGO\n\nSET ANSI_PADDING OFF\nGO\n</code></pre>\n\n<p><strong>question</strong> how can i speed up this query? are there some indexes that i am missing? why would adding just one table exponentially increase the time it takes to return results for this query? perhaps i should change some datatypes?</p>\n"},{"tags":["tsql","sybase"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":62,"score":0,"question_id":12045060,"title":"Improving the performance of the following TSQL code","body":"<p>I am using Sybase DB with TSQL.</p>\n\n<p>The follow snippet of TSQL code is very simple and I need to perform it several 100,000 times (large database) so I would really like to improve its performance in any way possible:</p>\n\n<pre><code>BEGIN TRANSACTION\nINSERT INTO\n  DESTINATION_TABLE\nSELECT\n  COLUMNS\nFROM\n  SOURCE_TABLE\nWHERE\n  ORDER_ID = @orderId\n\nDELETE FROM\n  SOURCE_TABLE\nWHERE\n  ORDER_ID = @orderId\nCOMMIT TRANSACTION\n</code></pre>\n\n<p>As one can see, I am inserting and removing the same set of rows based on the same condition.</p>\n\n<p>Is there a way to improve the performance of this simple query?</p>\n\n<p>Thanks.</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","case"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":122,"score":0,"question_id":12042918,"title":"SQL Server Case statement in WHERE Clause","body":"<p>I tried to google for CaseStatement in WHERE clause. But i didn't find similar to my scenario.</p>\n\n<p>Below is my SQL Statement with CASE Statement in WHERE clause. If <strong>PartName = B</strong>, then i should apply (<strong>RecoveraleFlag = 1</strong>) condition along with other conditions. Else This condition should not apply but all other conditions should remain.</p>\n\n<pre><code>FROM Rec.Communications A\n          INNER JOIN REC.CommunicationTypes B ON A.CommunicationTypeKey = B.CommunicationTypeKey   \n          INNER JOIN occ.Cases c ON a.CaseId = c.CaseId\n          INNER JOIN occ.Claims cl on a.CaseId = cl.CaseId\n          INNER JOIN ops.Concepts d ON c.ConceptKey = d.ConceptKey\n          INNER JOIN OPS.Regions f ON d.MODSRegionKey = f.MODSRegionKey \n          INNER JOIN COM.RepriceRequestOccurrences e ON a.CommunicationId = e.CommunicationId\n          INNER JOIN occ.Providers prv ON c.MODSProviderKey = prv.MODSProviderKey\n  WHERE \n**(\n    CASE WHEN f.PartName = 'B' and e.RecoverableFlag = 1 then 1\n    ELSE 0\n  END\n  ) = 1**\n  AND \n  b.CommunicationTypeCode = 'RREQ'\n      AND f.Region = @Region\n      AND a.CurrentFlag = 1\n</code></pre>\n\n<p>Here Case Statement in where clause is working fine if Partname = B. For Partname A, this will be 0=1  <strong>always false</strong>. Because of this it is not returning any data.\nCan anyone gives any alternatives.</p>\n\n<p>Appreciate your responses. \nThanks</p>\n"},{"tags":["linq","tsql","architecture","orm","telerik"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":79,"score":2,"question_id":12036272,"title":"Is using an ORM and LINQ architecturally unsound?","body":"<p>I'm currently using Telerik Open Access which is hateful, but that said is there not an architectural issue around the use of LINQ and ORMs in general?</p>\n\n<p>It occurs to me that what we are doing is moving the burden of data manipulation from the DBMS which is optimised to  perform that task to in my case a webserver which is not.</p>\n\n<p>Also, at least in Telerik's case we are restricting the flexibility of our coding model. In this project I have to extract and create complex data structures that do not map directly into a CRUD interface. \nIn Telerik Open Access at least, if I use a stored procedure to create the data and it does not map into a known entity I have to return the data as an object array.</p>\n\n<p>So instead I use the \"entities\" created by the ORM and manipulate them using LINQ. \nThe resulting code is ridiculously complex compared to the relatively simple equivalent SQL statement.</p>\n\n<p>I'd be interested in your views specifically around the advocacy of using an ORM and LINQ and whether this is architecturally unsound.</p>\n\n<p>It certainly feels it to me.</p>\n\n<p>I haven't included code samples because the actual code is irrelevant. That said it might be instructive to know that a 10 line T-SQL query (6 of those lines are joins) has turned into 300 lines (including whitespace) of LINQ statements to do the same thing.</p>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":55,"score":2,"question_id":12042164,"title":"What stored procedures update a table?","body":"<p>Is it possible to query the database somehow to find all stored procedures that update data in a specific table?</p>\n\n<p>I worked on an older system before called Cool Gen which did this exact thing and currently I am wanting something similar.</p>\n\n<p>I'm not interested in stored procedures that use the table (I have that list already, at it is very long).</p>\n"},{"tags":["tsql"],"answer_count":3,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":521,"score":1,"question_id":3707468,"title":"T-SQL: Stop processing rest of the query","body":"<p>I wonder if I could stop processing the rest of the query on a specific condition.</p>\n\n<p><strong>Scenario</strong></p>\n\n<pre><code>IF NOT EXISTS (SELECT  *\n        FROM\n            [dbo].[Updates] \n       WHERE \n            RevisionNumber='12.2457.2')\nBEGIN\n    IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TestProcedure]') AND type in (N'P', N'PC'))\n    DROP PROCEDURE [dbo].[TestProcedure]\n    GO\n\n    SET ANSI_NULLS ON\n    GO\n\n    SET QUOTED_IDENTIFIER ON\n    GO\n\n    CREATE PROCEDURE [dbo].[TestProcedure]\n    AS\n    BEGIN\n        PRINT 'Test';\n    END\n    GO\n\n    INSERT [dbo].[Updates]\n    SELECT '12.2457.2'\nEND\n</code></pre>\n\n<p>The above query will not work because a line following \"GO\" is treated as a new query. We release updates every day and want simplicity of installing updates.</p>\n\n<p>I am searching for something like \"RETURN\" statement. It works, but not with \"GO\"s.</p>\n\n<pre><code>IF EXISTS (SELECT  *\n        FROM\n            [dbo].[Updates] \n       WHERE \n            RevisionNumber='12.2457.2')\nBEGIN\n    PRINT 'The update ''12.2457.2'' was already installed.'\n    RETURN\nEND\n\nGO\n\nIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TestProcedure]') AND type in (N'P', N'PC'))\nDROP PROCEDURE [dbo].[TestProcedure]\nGO\n\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROCEDURE [dbo].[TestProcedure]\nAS\nBEGIN\n    PRINT 'Test';\nEND\nGO\n\nINSERT [dbo].[Updates]\nSELECT '12.2457.2'\n\nGO\n</code></pre>\n\n<p><strong>Workaround</strong></p>\n\n<pre><code>BEGIN TRANSACTION\n\nGO\n\nIF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TestProcedure]') AND type in (N'P', N'PC'))\nDROP PROCEDURE [dbo].[TestProcedure]\nGO\n\nSET ANSI_NULLS ON\nGO\n\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROCEDURE [dbo].[TestProcedure]\nAS\nBEGIN\n    PRINT 'Test';\nEND\nGO\n\n\nIF EXISTS(SELECT TOP 1 1 FROM [dbo].[Updates] WHERE RevisionNumber='12.2457.2')\nBEGIN\n    ROLLBACK TRANSACTION\n    PRINT 'The update was already present in the database. The transaction was rolled back.'\nEND \nELSE\nBEGIN\n\n    INSERT [dbo].[Updates]\n    SELECT '12.2457.2'\n\n    COMMIT TRANSACTION\n    PRINT 'The update was sucessfully installed.'\nEND\n</code></pre>\n\n<p>What I want is an idea to stop the execution of the rest of the lines, equivalent to \"RETURN/END\" keyword in Visual Basic. Please help!</p>\n"},{"tags":["sql","sql-server","tsql","table","cursor"],"answer_count":3,"favorite_count":0,"up_vote_count":3,"down_vote_count":1,"view_count":41,"score":2,"question_id":12040803,"title":"How to run an Insert statement for each item in the SQL Table?","body":"<p>I have a table variable as below:</p>\n\n<pre><code>declare @countries table (countryId int)\n</code></pre>\n\n<p>which has 5 records in it.</p>\n\n<p>I'd need to write a separate insert statement for each countryId in the list, like:</p>\n\n<pre><code>insert into Countries (ID) VALUES (countryId)\n</code></pre>\n\n<p>How would that be possible without using a cursor?</p>\n\n<p>is there any simpler way?</p>\n\n<p>Thanks,</p>\n"},{"tags":["sql-server","tsql","debugging","visual-studio-2012","visual-studio-debugging"],"answer_count":2,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":455,"score":2,"question_id":12016417,"title":"How to debug SQL Server T-SQL in Visual Studio 2012","body":"<p>How does one debug a T-SQL stored procedure in a multi-tier application in Visual Studio 2012? </p>\n\n<p>To be clear, I want to set a breakpoint in a sproc in VS 2012, and hit it when the sproc is called from an ASP.NET WebForms app in the same debugging session.</p>\n\n<p>When following the same steps as for VS 2010, the breakpoints aren't hit inside the sproc.</p>\n\n<p>Debugging T-SQL in a sproc on a SQL Server 2008 R2 Express database works as expected in Visual Studio 2010.</p>\n\n<p>To be sure everything was enabled properly, I went over the instructions for VS 2010 (<a href=\"http://msdn.microsoft.com/en-us/library/ms165059%28VS.100%29.aspx\" rel=\"nofollow\">here</a>), but no such page exists for VS 2012 or .NET 4.5.</p>\n\n<p>It seems the missing step is to enable \"Application Debugging\", but no such option exists in the Server Explorer > Data Connections context menu in VS 2012.</p>\n\n<h2>VS 2010 Application Debugging</h2>\n\n<p><img src=\"http://i.stack.imgur.com/Bwu6O.png\" alt=\"enter image description here\"></p>\n\n<h2>VS 2012 No Application Debugging</h2>\n\n<p><img src=\"http://i.stack.imgur.com/wGYRt.png\" alt=\"enter image description here\"></p>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":21,"score":0,"question_id":10425948,"title":"cont Other Associates Records of same category with the latest record in the category","body":"<p>I want to count all the records belong to a category &amp; get the data associated with the latest record as </p>\n\n<pre><code>CREATE TABLE #TestTable\n\n(\n\nSomeColumn VARCHAR(1)\n,data varchar(50)\n,CDate datetime\n)\n\nGO\n\nINSERT INTO #TestTable VALUES ('A','abdss',getdate())\nINSERT INTO #TestTable VALUES ('A','abserts',getdate())\nINSERT INTO #TestTable VALUES ('A','awabs',getdate())\nINSERT INTO #TestTable VALUES ('A','abrfgts',getdate())\nINSERT INTO #TestTable VALUES ('A','abasds',getdate())\nINSERT INTO #TestTable VALUES ('A','abasds',getdate())\nINSERT INTO #TestTable VALUES ('A','aberzsdsfs',getdate())\nINSERT INTO #TestTable VALUES ('A','abarfzdfs',getdate())\nINSERT INTO #TestTable VALUES ('B','abzdsfs',getdate())\n\n--SELECT * , COUNT(SomeColumn) From #TestTable\n--GROUP BY SomeColumn \n\ndrop table  #TestTable\n</code></pre>\n\n<p>the required output will be <br/></p>\n\n<pre><code>SomeColumn | Data          | Date              |Other Associates Records &lt;br/&gt;\nA          | abarfzdfs     |last A record date   |7&lt;br/&gt;\nB          | abzdsfs       |last B record date   |0&lt;br/&gt;\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":109,"score":0,"question_id":12034057,"title":"How to output tab [CHAR(9)] in EXEC","body":"<p>I know I can do the following:</p>\n\n<pre><code>DECLARE @Tab CHAR(1)\nSET @Tab = CHAR(9)\nEXEC('xp_cmdshell ''echo ' + @Tab + 'Some text&gt;&gt; C:\\test.txt'', NO_OUTPUT')\n</code></pre>\n\n<p>But is there a way to do this in 1 line? I.e. remove the need to declare and set tab, and output it directly in the EXEC?</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","database","query","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":11904909,"title":"SQL Combine query on information schema to help build large stored procedures","body":"<p>I'd like to use the <code>INFORMATION_SCHEMA.COLUMNS</code> to help me build stored procedures faster for tables with many, many columns.</p>\n\n<p>For example, for the update clause in my MERGE statement on a table with 100 columns, I have to do <code>COLUMN_1 = SOURCE.COLUMN1, COLUMN2...</code> 100 times, and that's not enjoyable.</p>\n\n<p>I know I can script update/create/etc statements from the object browser, but I'd like to control the formatting a little more.  So:</p>\n\n<p>This query outputs the update format for each column mentoined above:</p>\n\n<pre><code>select column_name + ' = SOURCE.' + column_name + ', ' \nfrom INFORMATION_SCHEMA.COLUMNS\nwhere TABLE_NAME = 'TableName'\n</code></pre>\n\n<p><em>Unfortunately, it does so as multiple results:</em></p>\n\n<pre><code>COLUMN_1 = SOURCE.COLUMN_1,\nCOLUMN_2 = SOURCE.COLUMN_2,\netc.\n</code></pre>\n\n<hr>\n\n<p><strong>The Question:</strong></p>\n\n<p>Can someone show me how I can modify the query above to <strong>concatenate all of the results</strong> so the output looks more like:</p>\n\n<pre><code>COLUMN_1 = SOURCE.COLUMN_1, COLUMN_2 = SOURCE.COLUMN_2, etc.\n</code></pre>\n\n<p><strong>PS:</strong> I know how to use a cursor to cycle through and achieve this result.  I'd like to find a way to do it in a query with a pivot or some T-SQL function for this purpose though if possible.</p>\n"},{"tags":["sql","sql-server","tsql","pivot"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":509,"score":0,"question_id":4020690,"title":"How to make Column to Row without an aggregate function in sql server 2005/8?","body":"<p>For example, I need to change from </p>\n\n<p><img src=\"http://i.stack.imgur.com/mBIuJ.png\" alt=\"alt text\"> </p>\n\n<p>to</p>\n\n<p><img src=\"http://i.stack.imgur.com/TH1f0.png\" alt=\"alt text\"> . </p>\n\n<p>I know PIVOT is for that, but it requires an aggregate function; and for my case, I donot need to aggregate only need column to row.</p>\n\n<p>You can use the following sample data:</p>\n\n<pre><code>    CREATE TABLE[StudentScores] \n( \n[UserName] NVARCHAR(20),\n[Subject] NVARCHAR(30),\n[Score]FLOAT,\n) \nGO\n\nINSERT INTO[StudentScores]SELECT'Nick','Chinese',80 \n\nINSERT INTO[StudentScores]SELECT'Nick','Maths',90 \n\nINSERT INTO[StudentScores]SELECT'Nick','English',70 \n\nINSERT INTO[StudentScores]SELECT'Nick','Biology',85 \n\nINSERT INTO[StudentScores]SELECT'Kent','Chinese',80 \n\nINSERT INTO[StudentScores]SELECT'Kent','Maths',90 \n\nINSERT INTO[StudentScores]SELECT'Kent','English',70 \n\nINSERT INTO[StudentScores]SELECT'Kent','Biology',85 \n</code></pre>\n"},{"tags":["asp.net","tsql","c#-4.0","ado.net"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":95,"score":2,"question_id":11954406,"title":"Error on ExecuteNonQuery();","body":"<p>I get the following error from <code>ExecuteNonQuery()</code></p>\n\n<pre><code>\"String or binary data would be truncated. The statement has been terminated.\"\n</code></pre>\n\n<p>The problem is the variable to be sent is bigger that the one in the DB.\nI am using the following code:</p>\n\n<pre><code>      protected void GridView1_RowUpdating(object sender, GridViewUpdateEventArgs e)\n    {\n        //GridViewRow row = GridView1.SelectedRow;\n        GridViewRow row = (GridViewRow)GridView1.Rows[e.RowIndex];\n        var Username = (Label)row.FindControl(\"Label3\");\n        var Password = (Label)row.FindControl(\"Label4\");\n        var Email = (Label)row.FindControl(\"Label5\");\n       // var ID_Inscricao = ((Label)row.FindControl(\"Label1\")).Text;\n        var ID_Inscricao = ((Label)row.FindControl(\"Label1\")).Text;\n\n\n        SqlConnection sqlConn = new SqlConnection(ConfigurationManager.ConnectionStrings[\"FormacaoConnectionString\"].ToString());\n        SqlCommand sqlComm = new SqlCommand();\n\n\n        sqlComm = sqlConn.CreateCommand();\n        sqlComm.Parameters.Add(\"@Username\", SqlDbType.Text);\n        sqlComm.Parameters.Add(\"@Password\", SqlDbType.Text);\n        sqlComm.Parameters.Add(\"@Email\", SqlDbType.Text);\n        sqlComm.Parameters.Add(\"@ID_Inscricao\", SqlDbType.Int);\n\n        sqlComm.Parameters[\"@Username\"].Value = Convert.ToString(Username);\n        sqlComm.Parameters[\"@Password\"].Value = Convert.ToString(Password);\n        sqlComm.Parameters[\"@Email\"].Value = Convert.ToString(Email);\n        sqlComm.Parameters[\"@ID_Inscricao\"].Value = Convert.ToInt32(ID_Inscricao);\n\n        string sql = \"INSERT INTO Utilizadores (Username, Password, Email, ID_Inscricao) VALUES (@Username, @Password, @Email, @ID_Inscricao)\";\n        sqlComm.CommandText = sql;\n        sqlConn.Open();\n        sqlComm.ExecuteNonQuery();\n        sqlConn.Close();\n    }\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":2687,"score":0,"question_id":5157819,"title":"Return only one row when multiple rows exist","body":"<p>I am working with a database that tracks field trip information for schools.  The query will run on a MS SQL 2005 Server.  There are a few cases when my query will return multiple rows for the same Field Trip.  So, what I want to do is filter my results so that <strong>if more than one row per TripID is returned, display only the row with the MIN StartDateTime.</strong></p>\n\n<p>I know there's something I can do with the PARTITION and MIN functions but I'm not sure how to go about it.</p>\n\n<p>Here is my code:</p>\n\n<pre><code> SELECT DISTINCT    \n        dbo.Trip_TripInformation.RecordID AS TripID,\n        dbo.Trip_TripInformation.TripDate,\n        Origin.LocationName AS Origin,\n        dbo.Trip_TripInformation.OriginDepartureTime AS StartDateTime,\n        dbo.Trip_TripInformation.OriginReturnTime AS ReturnDateTime, \n        ISNULL(dbo.Trip_TripInformation.NoOfStudents, 0) AS NumberOfStudents,\n        ISNULL(dbo.Trip_TripInformation.NoOfAdults, 0) AS NumberOfAdults,\n        ISNULL(dbo.Trip_TripInformation.NoOfStudents, 0) + ISNULL(dbo.Trip_TripInformation.NoOfAdults, 0) AS NumberOfPassengers,\n        Destination.LocationName AS Destination,\n        dbo.Vehicles.Vehicle,\n        Driver.LastName + ', ' + Driver.FirstName AS Driver    \nFROM dbo.Trip_TripInformation\nLEFT JOIN dbo.Trip_Location AS Origin ON Origin.RecordID = dbo.Trip_TripInformation.OriginLocationID    \nLEFT JOIN dbo.Trip_TripDestinations ON dbo.Trip_TripInformation.RecordID = dbo.Trip_TripDestinations.TripID    \nLEFT JOIN dbo.Trip_Location AS Destination ON Destination.RecordID = dbo.Trip_TripDestinations.LocationID    \nLEFT JOIN dbo.Trip_TripDriverVehicle ON dbo.Trip_TripInformation.RecordID = dbo.Trip_TripDriverVehicle.TripID \n                                    AND dbo.Trip_TripDriverVehicle.DestinationID = dbo.Trip_TripDestinations.RecordID    \nLEFT JOIN dbo.Vehicles ON dbo.Vehicles.RecordID = dbo.Trip_TripDriverVehicle.VehicleID    \nLEFT JOIN dbo.Employees AS Driver ON dbo.Trip_TripDriverVehicle.DriverID = Driver.RecordID    \nORDER BY TripID\n</code></pre>\n"},{"tags":["sql","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":234,"score":0,"question_id":12035062,"title":"IIF(...) not a recognized built-in function","body":"<p>I'm trying to use this in MS SQL 2008 R2:</p>\n\n<p><code>SET @SomeVar = @SomeOtherVar + IIF(@SomeBool, 'value when true', 'value when false')</code></p>\n\n<p>But I get a 'not a recognized built-in function' error. Is this only compatible with a later version or am I missing something?</p>\n\n<p><a href=\"http://msdn.microsoft.com/en-us/library/hh213574.aspx\" rel=\"nofollow\">http://msdn.microsoft.com/en-us/library/hh213574.aspx</a></p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":109,"score":1,"question_id":12007144,"title":"Getting SQL 'Arithmetic overflow error converting numeric to data type numeric.' On a statement that is tested for in-bound values","body":"<p>I have the following statement that is executed at the end of a really large stored procedure.</p>\n\n<pre><code>UPDATE myTable\nSET    DiffPerc = CAST(CASE\n                         WHEN ( CASE\n                                  WHEN SimExt = 0\n                                       AND StdExt = 0 THEN 0\n                                  WHEN StdExt = 0 THEN 99999\n                                  ELSE SimExt - StdExt / StdExt\n                                END ) * 100 &gt; 99999 THEN 99999\n                         ELSE ( CASE\n                                  WHEN SimExt = 0\n                                       AND StdExt = 0 THEN 0\n                                  WHEN StdExt = 0 THEN 99999\n                                  ELSE SimExt - StdExt / StdExt\n                                END ) * 100\n                       END AS DECIMAL(8, 2)) \n</code></pre>\n\n<p>The idea is that I have a fields that determines the percentage difference of one value over another.  The field <code>DiffPerc</code> is percentage difference of <code>SimExt</code> to <code>StdExt</code>.  This routine has worked every day, for well over a year, however, starting two days ago I started to getting the following error message:</p>\n\n<blockquote>\n  <p>Arithmetic overflow error converting numeric to data type numeric.</p>\n</blockquote>\n\n<p>I understand what this message means, but the whole point of the embedded case statement is to to both test for 0's in the denominator, as well as check for any grossly high value percentages before the value is packed into the <code>DECIMAL (8, 2)</code> field.</p>\n\n<p>What am I missing?  How can I update this statement to account for all possible edge cases and handle any overflow before it happens?</p>\n\n<p>Also, please note that the hard-coded <code>99999</code> value as a percent is a a flag to the end users that someone has screwed something up.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":48,"score":0,"question_id":12033387,"title":"How to include ' (quote) in EXEC","body":"<p>In the following T-SQL code, how can I enclose <code>@Name</code> and <code>P</code> in quotes?</p>\n\n<pre><code>EXEC('xp_cmdshell ''echo IF EXISTS(SELECT * FROM sys.objects WHERE name = ' + @Name + ' AND type = P)&gt;&gt; C:\\test.txt'', NO_OUTPUT')`\n</code></pre>\n\n<p>Thanks!</p>\n"},{"tags":["sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":136,"score":1,"question_id":12031989,"title":"If, Else or Case statement in SQL","body":"<p>I want to take the average of row only if the value is greater than zero. However, I am receiving the following error:</p>\n\n<blockquote>\n  <p><em>'Column 'Daily.Rad' is invalid in the select list because it is not contained in either an aggregate function or the GROUP BY...'</em></p>\n</blockquote>\n\n<p>Code:</p>\n\n<pre><code>SELECT Date,\n       AVG([Speed]) as [Speed], \n\n       CASE WHEN [Rad] &gt; 0.0\n            THEN AVG([Rad])\n            ELSE 0.0\n       END AS [Rad], \n\n       AVG([Pressure]) as [Pressure], \n\n       FROM Daily \nWHERE MONTH(Date) = MONTH('08/31/2011')  \nGROUP BY Date\n</code></pre>\n"},{"tags":["sql-server","tsql","ubuntu","odbc","freetds"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":310,"score":1,"question_id":12031897,"title":"Missing libtdsodbc.so in freetds-dev - MSSQL on Ubuntu","body":"<p>I'm trying to get MSSQL working on Ubuntu 12.04 via ODBC, and I've followed these steps to the letter:</p>\n\n<p><a href=\"http://jamesrossiter.wordpress.com/2011/03/08/connecting-to-microsoft-sql-server-using-odbc-from-ubuntu-server/\" rel=\"nofollow\">http://jamesrossiter.wordpress.com/2011/03/08/connecting-to-microsoft-sql-server-using-odbc-from-ubuntu-server/</a></p>\n\n<p>However, this omits both of these files that are pointed at in odbcinst.ini:</p>\n\n<pre><code>Driver = /usr/lib/odbc/libtdsodbc.so\nSetup = /usr/lib/odbc/libtdsS.so\n</code></pre>\n\n<p>So, I googled a bit and found this:</p>\n\n<p><a href=\"http://ubuntuforums.org/showthread.php?t=433435&amp;page=2\" rel=\"nofollow\">http://ubuntuforums.org/showthread.php?t=433435&amp;page=2</a></p>\n\n<p>So I followed those instructions and put libtdsodbc.so in /usr/lib/odbc/, but I still get this error:</p>\n\n<pre><code>Can't open lib '/usr/lib/odbc/libtdsodbc.so' : file not found, SQL state 01000 in SQLConnect\n</code></pre>\n\n<p>But...</p>\n\n<pre><code>root@ubuntu:/usr/lib/odbc# ls -la\ntotal 552\ndrwxr-xr-x  2 root root   4096 Aug 19 20:12 .\ndrwxr-xr-x 62 root root  12288 Aug 19 19:41 ..\n-rwxrwxr-x  1 root root 270608 Aug 19 20:00 libtdsodbc.so\n</code></pre>\n\n<p>I tried chmod 775 on that file, which explains the permissions. Still no luck.</p>\n\n<p>Any ideas? I'm stumped. Would really love to get this working on my Linux box.</p>\n\n<p>EDIT: I'm using Ubuntu 64-bit. I'm betting this is the problem. Hope that helps...</p>\n\n<p>EDIT2: I tried manually getting the 64-bit package from here:</p>\n\n<p><a href=\"http://www.ubuntuupdates.org/package/core/precise/main/base/tdsodbc\" rel=\"nofollow\">http://www.ubuntuupdates.org/package/core/precise/main/base/tdsodbc</a></p>\n\n<p>And then I saw there was a file called this:</p>\n\n<pre><code>/usr/lib/x86_64-linux-gnu/odbc/libtdsodbc.so\n</code></pre>\n\n<p>Woo, maybe a 64-bit version, right?</p>\n\n<p>So I pointed odbcinst.ini at it, and it didn't work.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":3851,"score":1,"question_id":2569998,"title":"to_date in SQL Server 2005","body":"<p>Does any one know how I would have to change the following to work with ms sql?</p>\n\n<pre><code>WHERE registrationDate between to_date ('2003/01/01', 'yyyy/mm/dd')\nAND to_date ('2003/12/31', 'yyyy/mm/dd');\n</code></pre>\n\n<p>What I have read implies I would have to construct it using DATEPART() which could become very long winded. Especially when the goal would be to compare on dates which I receive in the following format \"2003-12-30 10:07:42\". It would be nice to pass them off to the database as is.</p>\n\n<p>Any pointers appreciated.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":67,"score":2,"question_id":12029947,"title":"Difference in INNER join and cartesian join in SQL Server","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/3022713/difference-between-inner-join-full-join\">Difference between Inner Join &amp; Full join</a>  </p>\n</blockquote>\n\n\n\n<p>What is the difference between these two, especially within SQL Server 2008 -</p>\n\n<pre><code>select * from table1 t1, table2 t2 where t1.col1 = t2.col1\n</code></pre>\n\n<p>AND</p>\n\n<pre><code>select * from table1 t1 INNER JOIN table2 t2 ON t1.col1 = t2.col1\n</code></pre>\n"},{"tags":["sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":77,"score":0,"question_id":12029485,"title":"SQL Server 2008 - toggle value in table, based on children values. Triggers or computed column with sub query?","body":"<p>I have the following tables</p>\n\n<p><strong>Parent Table</strong></p>\n\n<pre><code>ds_id(pk)   / state\n-------------------------\n        1.       /    valid\n        2.       /    invalid\n</code></pre>\n\n<p><strong>Child Table</strong></p>\n\n<pre><code>d_id(pk)  /   ds_id(fk)  /  approve\n-----------------------------------------\n  1.     /       1.        /       false\n  2.     /       1.        /       true\n  3.     /       2.        /       false\n  4.     /       2.        /       false\n</code></pre>\n\n<p>The <code>state</code> column in the parent table should change to valid if one of its children in the child  table has its approved column set to true</p>\n\n<p>I want to find the simplest most efficient method for calculating  and setting the state column based on its children. </p>\n\n<p>I'm using SQL Server 2008. </p>\n\n<p>The change of state would need to be instant.</p>\n\n<p>It is expected that the system would have a few thousand parents, each with around 5 children. </p>\n\n<p>It is more likely that the children would be updated</p>\n"},{"tags":["sql","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":260,"score":0,"question_id":12028033,"title":"Cannot resolve the collation conflict between temp table and sys.objects","body":"<p>The following T-SQL code:</p>\n\n<pre><code>CREATE TABLE #exclude(name VARCHAR(256))\nINSERT INTO #exclude VALUES('someprefix_someprocedure')\n\nSELECT 'someschema.' + sys.objects.name\nFROM sys.objects\n  LEFT JOIN #exclude ON sys.objects.name = #exclude.name\nWHERE sys.objects.name LIKE 'someprefix_%'\n  AND type IN ('FN', 'TR', 'P')\n  AND #exclude.name IS NULL\nORDER BY sys.objects.name ASC\n</code></pre>\n\n<p>Returns this error:</p>\n\n<blockquote>\n  <p>Msg 468, Level 16, State 9, Line 4<br>\n  Cannot resolve the collation\n  conflict between \"Danish_Norwegian_CI_AS\" and\n  \"SQL_Latin1_General_CP1_CI_AS\" in the equal to operation.</p>\n</blockquote>\n\n<p>Changing the code to the following returns the same error:</p>\n\n<pre><code>CREATE TABLE #exclude(name VARCHAR(256))\nINSERT INTO #exclude VALUES('someprefix_someprocedure')\n\nSELECT 'someschema.' + sys.objects.name\nFROM sys.objects\n  LEFT JOIN #exclude ON sys.objects.name = #exclude.name\nWHERE sys.objects.name LIKE 'someprefix_%'\n  AND type IN ('FN', 'TR', 'P')\n  AND #exclude.name IS NULL\nORDER BY sys.objects.name COLLATE SQL_Latin1_General_CP1_CI_AS ASC\n</code></pre>\n\n<p>How can I fix this?</p>\n\n<p>Thanks!</p>\n"},{"tags":["sql","tsql","dynamic"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":131,"score":0,"question_id":12028680,"title":"T-SQL Newline String Concatenation For Exec()","body":"<p>So, I've come across a pretty annoying problem with T-SQL... Essentially, in a table, there are several T-SQL statements. I want a stored procedure to efficiently grab these rows and concatenate them to a variable. Then, execute the concatenated lines with EXEC(@TSQL)</p>\n\n<p>The problem is, string concatenation with newlines seem to be stripped when calling Exec...</p>\n\n<p>For example something like:</p>\n\n<pre><code>declare @sql nvarchar(max) = ''\nselect @sql += char(13) + char(10) + [sql] from [SqlTable]\nexec(@sql) -- Won't always do the right thing\nprint @sql -- Looks good\n</code></pre>\n\n<p>I don't want to butcher the code with a Cursor, is there any way around this? Thanks! </p>\n\n<p>Edit:\nOkay, so it looks like the issue is in fact only with the GO statement, for example:</p>\n\n<pre><code>declare @test nvarchar(max) = 'create table #test4(i int) ' + char(10) + char(13) + 'GO' + char(10) + char(13) +'create table #test5(i int)'\nexec(@test)\n</code></pre>\n\n<p>I guess this go will have to go (no pun intended) I just really didn't want to have to try and parse it in fear of special cases blowing up the whole thing.</p>\n"},{"tags":["sql","sql-server","sql-server-2005","tsql","casting"],"answer_count":5,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":4670,"score":4,"question_id":4936180,"title":"Cast integer and concatenate to varchar in TSQL","body":"<p>I'm trying to write a stored procedure to assist with development of our database, but I'm having some trouble using it. For example:</p>\n\n<pre><code>DECLARE @pID int;\nSET @pID = 1;\nEXEC WriteLog 'Component', 'Source', 'Could not find given id: ' + CAST(@pID AS varchar);\n</code></pre>\n\n<p>This yields the error (on SQL Server 2005)</p>\n\n<blockquote>\n  <p>Msg 102, Level 15, State 1, Line 4\n  Incorrect syntax near '+'.</p>\n</blockquote>\n\n<p>Can someone explain to me why my syntax is incorrect, and the right way to solve this problem?</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":124,"score":1,"question_id":12022387,"title":"RETURN inside a transaction with TRY-CATCH block ","body":"<p>I have the following and wondering as a generic example wondering if transaction is left open if it exits with <code>RETURN</code>. </p>\n\n<pre><code>BEGIN TRANSACTION\n    BEGIN TRY\n        IF NOT EXISTS(SELECT 1 FROM dbo.tblProducts WHERE intProductID = @intProductID)\n            BEGIN\n                SELECT 'Product does not exists' AS strMessage\n                RETURN\n            END\n\n        UPDATE dbo.tblProducts SET\n            curPrice = 10\n        WHERE\n            intProductID = @intProductID\n\n        SELECT 'Success' AS strMessage\n\n    END TRY \n\n    BEGIN CATCH\n        SELECT ERROR_MESSAGE() AS strMessage\n        IF @@TRANCOUNT &gt; 0\n            ROLLBACK TRANSACTION\n    END CATCH\n\nIF @@TRANCOUNT &gt; 0\n    COMMIT TRANSACTION\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":1,"up_vote_count":2,"down_vote_count":0,"view_count":138,"score":2,"question_id":12023933,"title":"CONCAT(column) OVER(PARTITION BY...)? Group-concatentating rows without grouping the result itself","body":"<p>I need a way to make a concatenation of all rows (per group) in a kind of window function like how you can do <code>COUNT(*) OVER(PARTITION BY...)</code> and the aggregate count of all rows per group will repeat across each particular group. I need something similar but a string concatenation of all values per group repeated across each group.</p>\n\n<p>Here is some example data and my desired result to better illustrate my problem:</p>\n\n<pre><code>grp  |  val\n------------\n1    |  a\n1    |  b\n1    |  c\n1    |  d\n2    |  x\n2    |  y\n2    |  z\n</code></pre>\n\n<p>And here is what I need (the desired result):</p>\n\n<pre><code>grp  |   val  |  groupcnct\n---------------------------------\n1    |   a    |  abcd\n1    |   b    |  abcd\n1    |   c    |  abcd\n1    |   d    |  abcd\n2    |   x    |  xyz\n2    |   y    |  xyz\n2    |   z    |  xyz\n</code></pre>\n\n<h2>Here is the really tricky part of this problem:</h2>\n\n<p>My particular situation prevents me from being able to reference the same table twice (I'm actually doing this within a recursive CTE, so I can't do a self-join of the CTE or it will throw an error). </p>\n\n<p>I'm fully aware that one can do something like:</p>\n\n<pre><code>SELECT      a.*, b.groupcnct\nFROM        tbl a\nCROSS APPLY (\n            SELECT STUFF((\n                        SELECT '' + aa.val \n                        FROM   tbl aa\n                        WHERE  aa.grp = a.grp\n                        FOR XML PATH('')\n                   ), 1, 0, '') AS groupcnct\n            ) b\n</code></pre>\n\n<p>But as you can see, that is referencing <code>tbl</code> <strong><em>two times</em></strong> in the query. </p>\n\n<p>I can only reference <code>tbl</code> <strong><em>once</em></strong>, hence why I'm wondering if windowing the group-concatenation is possible (I'm a bit new to TSQL since I come from a MySQL background, so not sure if something like that can be done).</p>\n\n<hr>\n\n<h3>Create Table:</h3>\n\n<pre><code>CREATE TABLE tbl\n    (grp int, val varchar(1));\n\nINSERT INTO tbl\n    (grp, val)\nVALUES\n    (1, 'a'),\n    (1, 'b'),\n    (1, 'c'),\n    (1, 'd'),\n    (2, 'x'),\n    (2, 'y'),\n    (2, 'z');\n</code></pre>\n"},{"tags":["tsql","group-by","data-warehouse","udf"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":10084025,"title":"How to set category based on items in a group-by clause in Transact-sql?","body":"<p>I have a set of records that once grouped together I'd like assigned a category based on the combinations of records in that group..</p>\n\n<p>Was wondering the best way to go about this..all I can think of is what I've got below but thought there may be a more clever way to do it (using UDFs maybe?)</p>\n\n<pre><code>SELECT *\n, case when productgroup in ('chihuaha','labrador') then 1 else 0 end AS Dog\n, case when productgroup in ('siamese', 'tabby') then 1 else 0 end  as Cat\nINTO #tmp_items\nFROM dbo.Items\n\nSELECT docket\n        , sum(value)\n        , case when sum(Dog) &gt; 0 and sum(Cat) &gt; 0 then 'Dog and Cat' \n               when sum(Dog) &gt; 0 and sum(Cat) = 0 then 'Dog Only'\n               when sum(Dog) = 0 and sum(Cat) &gt; 0 then 'Cat Only'\n          end\n          as Purchase_Type \nFROM #tmp_items\nGROUP BY docket\n</code></pre>\n"},{"tags":["query","tsql","sql-server-2012"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":65,"score":0,"question_id":12017670,"title":"Compare string on range in SQL Server","body":"<p>I'm trying to query a string to match within a range in the database. The table has 2 columns <code>FromCode</code> and <code>ToCode</code>.</p>\n\n<p>Below is the sample data (assume the table is called <code>CodeList</code>):</p>\n\n<pre><code>FromCode    ToCode\nIV1 0AA     IV9 9ZZ\nIV10 0AA    IV28 9ZZ\nIV30 0AA    IV32 9ZZ\nIV36 0AA    IV36 9ZZ\nIV40 0AA    IV49 9ZZ\nIV51 0AA    IV56 9ZZ\nIV63 0AA    IV63 9ZZ\n</code></pre>\n\n<p>So, if I run the query</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT *\nFROM CodeList\nWHERE FromCode &lt;= 'IV1 1AB' AND ToCode &gt;= 'IV1 1AB'\n</code></pre>\n\n<p>It would return the result</p>\n\n<pre><code>IV1 0AA   IV9 9ZZ \n</code></pre>\n\n<p>which is correct. But, when I run this:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT *\nFROM CodeList\nWHERE FromCode &lt;= 'IV2 1AB' AND ToCode &gt;= 'IV2 1AB'\n</code></pre>\n\n<p>The result I get back is</p>\n\n<pre><code>IV1 0AA    IV9 9ZZ\nIV10 0AA   IV28 9ZZ\n</code></pre>\n\n<p>So, to a human the string <code>IV2 2AB</code> is within <code>IV1 0AA - IV9 9ZZ</code> not <code>IV10 0AA - IV28 9ZZ</code>.</p>\n\n<p>If anyone could suggest a better way to search through the data it'd be much appreciated. Also, the engine I'm running this on is SQL Server 2012.</p>\n\n<p>Many thanks! </p>\n"},{"tags":["sql","sql-server","tsql","database-design","documentation"],"answer_count":4,"favorite_count":4,"up_vote_count":5,"down_vote_count":0,"view_count":1782,"score":5,"question_id":4273978,"title":"Why (and how) to split column using master..spt_values?","body":"<p>Subquestioning the answer to question <a href=\"http://stackoverflow.com/questions/4250475/split-one-column-into-multiple-rows/4250498#4250498\">\"Split one column into multiple rows\"</a> which I re-wrote here as [ 1 ].  </p>\n\n<p>What is the (meaning of) <code>Type = 'P'</code> and why to use undocumented master..spt_values for splitting a column? What is the benefit of it?  </p>\n\n<hr>\n\n<p>[ 1 ]  </p>\n\n<pre><code>CREATE TABLE dbo.Table1 \n(\n    Col1        CHAR(1),\n    Col2        CHAR(1),\n    Col3        CHAR(1),\n    Col4        VARCHAR(50)\n)\nGO\n\nINSERT INTO dbo.Table1 VALUES ('A','B','C','1,2,3')\nGO\nINSERT INTO dbo.Table1 VALUES ('D','E','F','6,7,8,9')\nGO\n\n\nSELECT\n    T.col1, RIGHT(LEFT(T.col4,Number-1),\n    CHARINDEX(',',REVERSE(LEFT(','+T.col4,Number-1))))\nFROM\n    master..spt_values,\n    table1 T\nWHERE\n    Type = 'P' AND Number BETWEEN 1 AND LEN(T.col4)+1 AND\n    (SUBSTRING(T.col4,Number,1) = ','\n    -- OR SUBSTRING(T.col4,Number,1)  = '') --this does not work correctly anyway\n</code></pre>\n\n<p>Related question:  </p>\n\n<ul>\n<li><a href=\"http://stackoverflow.com/questions/4273723/what-is-the-purpose-of-system-table-table-master-spt-values-and-what-are-the-m\">What is the purpose of system table table master..spt_values and what are the meanings of its values?</a></li>\n</ul>\n"},{"tags":["sql","sql-server","tsql","select","distinct"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":119,"score":0,"question_id":12016499,"title":"Select DISTINCT from two columns in t-SQL","body":"<p>Say, if I have the following table:</p>\n\n<pre><code>CREATE TABLE tbl (ID INT, Type UNIQUEIDENTIFIER)\nINSERT tbl VALUES\n(1, N'D9D09D5B-AF63-484C-8229-9762B52972D0'),\n(2, N'D9D09D5B-AF63-484C-8229-9762B52972D6'),\n(3, N'D9D09D5B-AF63-484C-8229-9762B52972D9'),\n(3, N'D9D09D5B-AF63-484C-8229-9762B52972D2'),\n(4, N'D9D09D5B-AF63-484C-8229-9762B52972D0')\n</code></pre>\n\n<p>and I need to select distinct ID columns but also whatever the Type column value that is associated with it. If I do the following:</p>\n\n<pre><code>select distinct id, type from tbl\n</code></pre>\n\n<p>It returns the whole table when I need only this:</p>\n\n<pre><code>1, N'D9D09D5B-AF63-484C-8229-9762B52972D0'\n2, N'D9D09D5B-AF63-484C-8229-9762B52972D6'\n3, N'D9D09D5B-AF63-484C-8229-9762B52972D9'\n4, N'D9D09D5B-AF63-484C-8229-9762B52972D0'\n</code></pre>\n\n<p>I know it must be something simple, but what am I missing here?</p>\n"},{"tags":["c#","sql-server","sql-server-2008","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":38,"score":0,"question_id":11929942,"title":"SQL DB Creation during deployment","body":"<p>I have designed my SQL Server tables through Microsoft SQL Management Studio and wrote a c# application based on the database created.\nWhile installing the application, I must create the database from a deployer.  Can Someone say about the easy way to get that done.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":87,"score":0,"question_id":12000393,"title":"How to arrange column of serial numbers into groups with a range of 1000 or less using TSQL?","body":"<p>How do I write a SQL statement that would arrange a column of serial numbers so that they are in groups with a range of 1000 or less (based on their serial numbers)? The numbers are not currently sorted but would end up like the example below. There are only two numbers in the first example group (having a difference of 31). The third number has a difference of 6443 from the second number placing it in a separate grouping (>1000). The next 4 numbers are grouped based on their range of ...4015 to ...4865 (diff of 850).</p>\n\n<p>I'm still a noob with &lt; 6 months of TSQL. I don't even know where to start with this one.</p>\n\n<pre><code>serial_num\n----------  \n33XG547909  \n33XG547940  \n\n33XG554383  \n\n33XG564015 \n33XG564282 \n33XG564289  \n33XG564308  \n33XG564314  \n33XG564353  \n33XG564865  \n\n33XG569023       \n\n34LT242788  \n34LT242812  \n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":678,"score":1,"question_id":4441828,"title":"Merge statement on a single record table","body":"<p>I need to write a single statement to insert or update a record in a single record table</p>\n\n<p>the merge statement allows me to write this:</p>\n\n<pre><code>create table t1 (n int)\n\n-- insert into t1 (n) Values (1);  -- uncomment to test the matched branch\n\nMERGE t1 AS P\nUSING (SELECT 3 AS n) AS S\nON 1 = 1\nWHEN MATCHED THEN\n    UPDATE SET n = S.n\nWHEN NOT MATCHED THEN\n    INSERT (n) \n    VALUES (S.n);\n\nselect * from t1    \n</code></pre>\n\n<p>this work, but I think that the 1=1 condition purpose is not very easy to understand.\nIs there a different syntax to insert a record when the table is empty or update the record when it does already exist?</p>\n"},{"tags":["tsql","sybase"],"answer_count":4,"favorite_count":0,"up_vote_count":4,"down_vote_count":0,"view_count":605,"score":4,"question_id":8753910,"title":"Sybase: Incorrect syntax near 'go' in a 'IF EXISTS' block","body":"<p>This is my sql statement </p>\n\n<pre><code>IF EXISTS (select 1 from sysobjects where name = 'PNL_VALUE_ESTIMATE')\n  drop table dbo.PNL_VALUE_ESTIMATE\ngo\n</code></pre>\n\n<p>isql bails out with this error message</p>\n\n<pre><code>Msg 102, Level 15, State 1:\nServer 'DB_SERVER', Line 3:\nIncorrect syntax near 'go'.\n</code></pre>\n\n<p>But the sql statement look correct to me. What's wrong?</p>\n\n<p>Sybase version is 15</p>\n"},{"tags":["sql-server","tsql","stored-procedures","nested-if"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":114,"score":1,"question_id":12011310,"title":"SQL nested IF's not working","body":"<p>From the looks of it I've wrapped everything in the proper BEGIN...END statements, however the code goes through and executes almost every single line of code. I've done print statements too to make sure that both @rows variables actually do contain values greater than 0. Can anyone help point me in the right direction? </p>\n\n<pre><code>    IF @rows &gt; '0'\n\n        --This agent's Tax ID number has been found to exist in AgentIdentification table\n        BEGIN \n\n            --Set UniqueAgentId according to mapped value from AgentIdentification table\n            SELECT @uniqueAgentId = UniqueAgentId\n            FROM AgentIdentification\n            WHERE AgentTaxId = @ssn\n\n            --Check to make sure this record exists in UniqueAgentIdToAgentId table\n            SELECT @rows = COUNT(*)\n            FROM UniqueAgentIdToAgentId\n            WHERE UniqueAgentId = @uniqueAgentId and AgentId = @agentId\n\n            PRINT @rows\n            IF @rows &gt; 0                \n                --Record exists in UniqueAgentIdToAgentId table\n                --Check to make sure correct UniqueAgentId is mapped to correct AgentId and vice versa\n                BEGIN \n                    SELECT @agentIdRows = COUNT(AgentId)\n                    FROM UniqueAgentIdToAgentId\n                    WHERE UniqueAgentId = @uniqueAgentId and AgentId &lt;&gt; @agentId\n\n                    SELECT @uniqueIdRows = COUNT(UniqueAgentId)\n                    FROM UniqueAgentIdToAgentId\n                    WHERE AgentId = @agentId and UniqueAgentId &lt;&gt; @uniqueAgentId\n\n                    IF @uniqueIdRows = 0 AND @agentIdRows = 0\n                        BEGIN           \n                            SET @returnValue = 1\n                        END\n                    ELSE IF @agentIdRows = 0 AND @uniqueIdRows &gt; 0\n                        BEGIN           \n                            SET @returnValue = 2\n                        END\n                    ELSE\n                        BEGIN\n                            SET @returnValue = 3\n                        END\n                END\n\n            --Record does not exist in UniqueAgentIdToAgentId and will be added\n            ELSE \n                BEGIN\n                    INSERT INTO UniqueAgentIdToAgentId (UniqueAgentId, AgentId, CompanyCode, LastChangeOperator, LastChangeDate)\n                    VALUES (@uniqueAgentId, @agentId, @companyCode, @lastChangeOperator, @LastChangeDate)\n                    SET @returnValue = 4\n                END\n        END\n    ELSE\n        BEGIN TRANSACTION\n\n            --This agent Tax ID number does not exist on AgentIdentification table\n            --Add record into Agent and AgentIdentification table\n            INSERT INTO Agent (EntityType, FirstName, LastName, NameSuffix, CorporateName, LastChangeOperator, LastChangeDate)\n            VALUES (@entityType, @firstName, @lastname, '', @corporateName, @lastChangeOperator, @LastChangeDate)\n\n            SELECT @uniqueAgentId = @@IDENTITY\n            SELECT UniqueAgentId\n            FROM Agent\n\n            INSERT INTO AgentIdentification (UniqueAgentId, TaxIdType, AgentTaxId, LastChangeOperator, LastChangeDate)\n            VALUES (@uniqueAgentId, @taxIdType, @ssn, @lastChangeOperator, @lastChangeDate)\n\n            --Check to make sure this record exists in UniqueAgentIdToAgentId table\n            SELECT @rows = COUNT(*)\n            FROM UniqueAgentIdToAgentId\n            WHERE UniqueAgentId = @uniqueAgentId and AgentId = @agentId\n\n            IF @rows &gt; 0\n                --Record exists in UniqueAgentIdToAgentId table\n                --Check to make sure correct UniqueAgentId is mapped to correct AgentId and vice versa\n                BEGIN \n                    SELECT @agentIdRows = COUNT(AgentId)\n                    FROM UniqueAgentIdToAgentId\n                    WHERE UniqueAgentId = @uniqueAgentId and AgentId &lt;&gt; @agentId\n\n                    SELECT @uniqueIdRows = COUNT(UniqueAgentId)\n                    FROM UniqueAgentIdToAgentId\n                    WHERE AgentId = @agentId and UniqueAgentId &lt;&gt; @uniqueAgentId\n\n                    IF @uniqueIdRows = 0 AND @agentIdRows = 0\n                        BEGIN   \n                            SET @returnValue = 5                        \n                        END\n                    ELSE IF @agentIdRows = 0 AND @uniqueIdRows &gt; 0\n                        BEGIN\n                            SET @returnValue = 6                        \n                        END\n                    ELSE\n                        BEGIN\n                            SET @returnValue = 7                        \n                        END\n                END\n\n            --Record does not exist in UniqueAgentIdToAgentId and will be added\n            ELSE \n                BEGIN\n                    INSERT INTO UniqueAgentIdToAgentId (UniqueAgentId, AgentId, CompanyCode, LastChangeOperator, LastChangeDate)\n                    VALUES (@uniqueAgentId, @agentId, @companyCode, @lastChangeOperator, @LastChangeDate)\n                    SET @returnValue = 8                \n                END\n    COMMIT TRANSACTION\n</code></pre>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":130,"score":1,"question_id":12009832,"title":"How to concatenate string when setting a parameter in Transact-SQL","body":"<p>First question here and is the following. I wrote the following code and everything works fine:</p>\n\n<pre><code>DECLARE @subject NVARCHAR(100)\nSET @subject = 'Report executed on ' + CONVERT(VARCHAR(12), GETDATE(), 107)\nSELECT @subject\n</code></pre>\n\n<p>Result: Report executed on Aug 17, 2012</p>\n\n<p>but when trying to concatenate the previous string while setting the parameter of msdb.dbo.sp_send_dbmail procedure, it fails</p>\n\n<pre><code>EXEC msdb.dbo.sp_send_dbmail @profile_name='XXX',\n@recipients='XXXX@XXXXX.com',\n@subject = 'Report executed on ' + CONVERT(VARCHAR(12), GETDATE(), 107),\n@body= @tableHTML,\n@body_format = 'HTML';\n</code></pre>\n\n<p>I know I could declare and send a variable to the parameter but I would like to understand why it fails when concatenating directly in the parameter. thank you for your time and knowledge</p>\n"},{"tags":["sql","sql-server","tsql","stored-procedures"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":50,"score":1,"question_id":12011529,"title":"Trouble with stored procedure for deleting least recent entries in a table","body":"<p>The query I have written is:    </p>\n\n<pre><code>delete from featured where featuredID IN(\nselect top(@removeAmnt) * from featured \norder by featured.createdon asc)\n</code></pre>\n\n<p>which doesn't appear to work. The error I get is, \"Only one expression can be specified in the select list when the subquery is not introduced with EXISTS.\". I'm not to familiar with sql queries. I'm basically trying to order these by their createdon field who's default value is the date function. also, the the sp allows a value removeAmnt to be passed in, which is the # of table entries that will be selected from the top to be deleted.</p>\n"},{"tags":["sql","tsql","inner-join","self-join"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":58,"score":1,"question_id":12010830,"title":"Return records that all match and all records where at least one doesn't match","body":"<p>Given a table of exam results, where 1 == PASS and 0 == FAIL</p>\n\n<pre><code>\nID    Name    Test   Result\n--------------------\n1     John    MATH   1\n2     John    ENGL   1\n3     Mary    MATH   1\n4     Mary    PSYC   0\n</code></pre>\n\n<p><strong>EDIT</strong>: assume that the name is unique.</p>\n\n<p>I need to get all records for people who <br/><br/>\n1) passed all tests<br/>\n2) failed at least one test<br/></p>\n\n<p>So, the 1st query should return John and all his records, and the 2nd query should return Mary and all her records (including the ones with PASS). </p>\n\n<p>I'm trying to do a <code>LEFT OUTER JOIN</code> with itself and compare counts, but don't seem to get a working query.</p>\n\n<pre><code>\nSELECT * FROM Results R1\nLEFT OUTER JOIN Results R2 on R1.ID=R2.ID and R2.Result=1\nWHERE ??? count of rows from R1 is compared to count of non-null rows from R2\n</code></pre>\n"},{"tags":["tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":88,"score":0,"question_id":11995327,"title":"Select statement after insert hangs?","body":"<p>In my stored procedure I am trying to insert records in to a temporary table</p>\n\n<p>In my stored procedure I am trying to insert records in to a temporary table</p>\n\n<pre><code>--Temporary table\ncreate table #CR_TMP\n    (\n\n         ct_co_id               int        NULL \n         , ct_nbr               int        NULL \n         , ctrct_srvc_type         char(4)    NULL \n     , start_date          datetime   NULL \n     , end_date            datetime   NULL \n    )\n\n  print 'Before insert' \n\nInsert into #CR_TMP\n select distinct col1,col2,......\nfrom tableName\nwhere conditions\n\nprint 'After insert'\nselect '#CR_TMP' as #CR_TMP, * from #CR_TMP\nprint 'here 1'\n</code></pre>\n\n<p>I ran the select query and it gives about 583 rows.\nBut when I execute the above procedure. I think it's getting stuck on the insert procedure.\nI do get the result 'After insert' but I don't get the results for print 'here 1'. \nI had this procedure executing for 2 hours and it was stuck at the same place. Any pointers here?</p>\n\n<p>I ran the select query and it gives about 583 rows.\nBut when I execute the above procedure. I think it's getting stuck on the insert procedure.\nI do get the result 'After insert' but I don't get the results for print 'here 1'. \nI had this procedure executing for 2 hours and it was stuck at the same place. Any pointers here?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":3601,"score":4,"question_id":5558582,"title":"SQL Server Output Clause into a scalar variable","body":"<p>Is there any \"simple\" way to do this or I need to pass by a table variable with the \"OUTPUT ... INTO\" syntax?</p>\n\n<pre><code>DECLARE @someInt int\n\nINSERT INTO MyTable2(AIntColumn)\nOUTPUT @SomeInt = Inserted.AIntColumn\nVALUES(12)\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2008-r2","type-conversion"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":83,"score":2,"question_id":12009884,"title":"TSQL derived column with date convert that checks for non-date convertible strings","body":"<p>I have a date column with dates stored as strings, such as 20120817. Unfortunately, the text form field that populates this column is free text, so I cannot guarantee that an occasional \"E\" or \"whatever\" shows up in this column. And more than a few already have.</p>\n\n<p>What I need to do is convert the string column into a date column. Of course the convert will reject the random string characters. Is there any way to create a derived column that will not only convert the strings but exclude the non-date convertible strings? </p>\n\n<p>If there were no non-date convertible strings in the table, the following would work:</p>\n\n<pre><code>ADD [convertedDate] AS CONVERT(DATE, [stringDate], 102)\n</code></pre>\n\n<p>And it does work perfectly in a test table I created. But when I introduce other non-convertible strings, I receive the dreaded \"Conversion failed when converting date and/or time from character string\" error for obvious reasons.</p>\n\n<p>Is there a function that will catch non-convertible elements that I can add on to this derived column code? Or is a view or function the only - or best - way to handle this? I played around with IsDate() with little luck. </p>\n\n<p>Thank you!</p>\n"},{"tags":["sql","tsql","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":64,"score":1,"question_id":12008045,"title":"Generating unique foreign key tuples","body":"<p>I have a table like this:</p>\n\n<pre><code>CREATE Table tblClassProperty (\n    ClassPropertyID integer IDENTITY(1,1) PRIMARY KEY,\n    Active bit DEFAULT 0 NOT NULL,\n    DEL bit DEFAULT 0 NOT NULL,\n    FINAL bit DEFAULT 0 NOT NULL,\n    Locked bit DEFAULT 0 NOT NULL,\n    _Project integer FOREIGN KEY REFERENCES tblProject(ProjectID),\n    _Property integer FOREIGN KEY REFERENCES tblProperty(PropertyID),\n    _Class integer FOREIGN KEY REFERENCES tblClass(ClassID)\n    CONSTRAINT CClassProperty UNIQUE(_Project,_Property,_Class))\n</code></pre>\n\n<p>I am migrating data from an old table (in another DB) into this one. For the most of the columns I am just copying the data from the other table. The foreign key columns don't exist in the old DB, they are just random values linked with the corresponding tables in the new DB. For your solution please take it for granted that the values for the columns _Project, _Property and _Class need to be generated the way they are now (with the <code>SELECT TOP 1 ...</code>)</p>\n\n<pre><code>INSERT INTO ClassDB..tblClassProperty (Active, DEL, FINAL, Locked, \n    _Project, _Property, _Class)\nSELECT Active, DEL, FINAL, Locked, \n    (SELECT TOP 1 ProjectID FROM ClassDB..tblProject ORDER BY NEWID()),\n    (SELECT TOP 1 PropertyID FROM ClassDB..tblProperty ORDER BY NEWID()),\n    (SELECT TOP 1 ClassID FROM ClassDB..tblClass ORDER BY NEWID()),\nFROM ClassDB_Access..tblClassProperty\n</code></pre>\n\n<p>Now, the <code>INSERT INTO</code> script won't run because of the unique constraint, and the constraint must stay as it is.</p>\n\n<p>My question: I need a script that copies the existing columns, generates the foreign keys as above, BUT the generated values for the tuple (<code>_Project, _Property, _Class</code>) will be unique as per constraint.</p>\n\n<p>The script has to run in SQL Server 2008 R2, and in the future also in Oracle.</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":84,"score":0,"question_id":12008290,"title":"Get Min and Max of Range","body":"<p>The following query will give me the list of IDs I need to perform an update immediately after running this:</p>\n\n<pre><code>SELECT TOP 5 WorkflowEventProcessingID\nFROM Master.WorkflowEventProcessing\nWHERE ProcessingToken IS NULL\nORDER BY WorkflowEventProcessingId\n</code></pre>\n\n<p><img src=\"http://i.stack.imgur.com/WXrYb.png\" alt=\"enter image description here\"></p>\n\n<p>Is there a way to get the min (55034) and max (55038) IDs of this range, in one select statement, so I can do something like this:</p>\n\n<pre><code>UPDATE WorkflowEventProcessing\nSET ProcessingToken = &lt;guid here&gt;\nWHERE WorkflowEventProcessingId &gt;= @minId\n  AND  WorkflowEventProcessingId &lt;= @maxId\n</code></pre>\n\n<p>I tried something like this, but I'm way off:</p>\n\n<pre><code>DECLARE @minId INT\nDECLARE @maxId INT\n\nSELECT TOP 5 @minId = min(WorkflowEventProcessingID), @maxId = MAX(WorkflowEventProcessingID)\nFROM Master.WorkflowEventProcessing\nWHERE ProcessingToken IS NULL\nORDER BY WorkflowEventProcessingId\n</code></pre>\n\n<p><strong>EDIT</strong></p>\n\n<p>I don't want to do an UPDATE with a sub-SELECT because I'm getting a deadlock on this. So I was told to separate the SELECT and UPDATE to give a separate DELETE process a chance to run between the UPDATE and SELECT.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":103,"score":1,"question_id":12007100,"title":"Declaring variables in CTEs SQL Server 2008","body":"<p>How can I implement something like the following:</p>\n\n<pre><code>declare @myInt int\nset @myInt=(select count(*) from x)\n;with x as\n\n(\nselect row_number() over(partition by c.patientid order by c.admissiondate) as rn\n    ,c.patientid,c.admissiondate\n    ,max(c.claimsfromdate)  as maxHemiDate\n    ,min(c.claimsfromdate) minHemiDate  \n    ,(\n        select max(c2.claimsfromdate)\n            from claims as c2\n            where c2.patientid=c.patientid\n            group by c2.patientid\n     ) as maxClaimsDate\n\n         ,p.drgCode\n         ,datediff(dd,min(c.claimsfromdate),max(c.claimsfromdate)) /7 as weeksWithHemi\n         from claims as c inner join icdclaims as ci on ci.id=c.id\n         inner join tblicd as t on t.icd_id=ci.icd_id\n         inner join patient as p on p.patientid=c.patientid\n         and p.admissiondate = c.admissiondate\n         and p.dischargedate = c.dischargedate\n         where t.icdText like '%X%'  and p.statecode='21'\n         group by c.patientid, c.admissiondate, p.drgCode\n)\n\nselect p.patientid, count(*)\n    from patient as p\n    left join x on x.patientid=p.patientid\n    where x.patientid is null\n    group by p.patientid\n</code></pre>\n\n<p>The error thrown when this is executed is </p>\n\n<blockquote>\n  <p><em>invalid object name x</em></p>\n</blockquote>\n\n<p>I kinda figured that this would happen since the variable declaration is outside of the CTE. If I move the declaration inside of the parentheses of <code>WITH</code> I get another error.  </p>\n\n<p>How can I assign a variable like this inside a CTE? Or can you not use a variable that draws data from the CTE at all?</p>\n"},{"tags":["sql","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":134,"score":0,"question_id":12007857,"title":"SQL Calculate Days between two dates in one table","body":"<p>I have a table <code>dbo.Trans</code> which contains an id called <code>bd_id</code>(varchar) and <code>transfer_date</code>(Datetime), also an identifier <code>member_id</code> pk is <code>trns_id</code> and is sequential</p>\n\n<p>Duplicates of <code>bd_id</code> and <code>member_id</code> exist in the table.</p>\n\n<pre><code>transfer_date       |bd_id| member_id | trns_id\n2008-01-01 00:00:00 | 432 | 111       | 1  \n2008-01-03 00:00:00 | 123 | 111       | 2  \n2008-01-08 00:00:00 | 128 | 111       | 3  \n2008-02-04 00:00:00 | 123 | 432       | 4\n.......\n</code></pre>\n\n<p>For each member_id, I want to get the amount of days between dates and for each <code>bd_id</code></p>\n\n<p>E.G., member <code>111</code> used <code>432</code> from <code>2008-01-01</code> until <code>2008-02-01</code> so return should be <code>2</code><br>\nThen next would be <code>5</code></p>\n\n<p>I know the <code>DATEDIFF()</code> function exists but I am not sure how to get the difference when dates are in the same table.</p>\n\n<p>Any help appreciated.</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":129,"score":1,"question_id":12008337,"title":"SQL Server Management Studio command line?","body":"<p>Is there a command line interface where I can run a script that says, for example:\nConnect to server a\nRun query 1\nConnect to server b\nRun query 2\nRun query 3</p>\n\n<p>I tried searching online but couldnt find anything built into SQL Server Management Studio.\nThanks!</p>\n"},{"tags":["sql-server","xml","tsql","xml-parsing"],"answer_count":2,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":63,"score":3,"question_id":11955867,"title":"XML Parsing in TSQL gives invalid column error?","body":"<p>I am trying to parse a simple XML file. As soon as I un comment the insert statement it gives me invalid column errors.</p>\n\n<pre><code>drop table #TEMP\ndrop table #TEMP_T\n\ndeclare @XMl_DATA AS XML\nset @XMl_DATA =\n'&lt;DocumentElement&gt;\n  &lt;Att_Table&gt;\n    &lt;L_ATTR_CD&gt;GAS_FLOW_START_DATE&lt;/L_ATTR_CD&gt;\n    &lt;L_ATTR_DESC&gt;GAS FLOW START DATE&lt;/L_ATTR_DESC&gt;\n    &lt;L_ATTR_VALUE&gt;01/01/2012&lt;/L_ATTR_VALUE&gt;\n    &lt;R_ATTR_CD&gt;EX_CTRCT_CO_ID&lt;/R_ATTR_CD&gt;\n    &lt;R_ATTR_DESC&gt;EXCLUDE GID(S)&lt;/R_ATTR_DESC&gt;\n    &lt;R_ATTR_VALUE /&gt;\n  &lt;/Att_Table&gt;\n  &lt;Att_Table&gt;\n    &lt;L_ATTR_CD&gt;GAS_FLOW_END_DATE&lt;/L_ATTR_CD&gt;\n    &lt;L_ATTR_DESC&gt;GAS FLOW END DATE&lt;/L_ATTR_DESC&gt;\n    &lt;L_ATTR_VALUE&gt;01/31/2012&lt;/L_ATTR_VALUE&gt;\n    &lt;R_ATTR_CD&gt;EX_CTRCT_NBR&lt;/R_ATTR_CD&gt;\n    &lt;R_ATTR_DESC&gt;EXCLUDE CONTRACT NUMBER(S)&lt;/R_ATTR_DESC&gt;\n    &lt;R_ATTR_VALUE /&gt;\n  &lt;/Att_Table&gt;\n  &lt;Att_Table&gt;\n    &lt;L_ATTR_CD&gt;CTRCT_CO_ID&lt;/L_ATTR_CD&gt;\n    &lt;L_ATTR_DESC&gt;GID(S)&lt;/L_ATTR_DESC&gt;\n    &lt;L_ATTR_VALUE /&gt;\n    &lt;R_ATTR_CD&gt;EX_RATE_CMPNT_CD&lt;/R_ATTR_CD&gt;\n    &lt;R_ATTR_DESC&gt;EXCLUDE RATE COMPONENT CODE(S)&lt;/R_ATTR_DESC&gt;\n    &lt;R_ATTR_VALUE /&gt;\n  &lt;/Att_Table&gt;\n  &lt;Att_Table&gt;\n    &lt;L_ATTR_CD&gt;CTRCT_NBR&lt;/L_ATTR_CD&gt;\n    &lt;L_ATTR_DESC&gt;DART STYLE CONTRACT NUMBER(S)&lt;/L_ATTR_DESC&gt;\n    &lt;L_ATTR_VALUE /&gt;\n    &lt;R_ATTR_CD&gt;EX_PT_ID_NBR&lt;/R_ATTR_CD&gt;\n    &lt;R_ATTR_DESC&gt;EXCLIDE POINT ID NUMBER(S)&lt;/R_ATTR_DESC&gt;\n    &lt;R_ATTR_VALUE /&gt;\n  &lt;/Att_Table&gt;\n  &lt;/DocumentElement&gt;'\n</code></pre>\n\n<p>Temp table:</p>\n\n<pre><code>CREATE TABLE #TEMP_T \n    (\n        ID INT IDENTITY(1,1), \n        ATT_CD VARCHAR(50), \n        ATT_CD_VALUE VARCHAR(1000)\n    )\n\nSELECT \n    cast(Colx.query('data(L_ATTR_CD)') as varchar(max))as L_ATTR_CD,\n    cast(Colx.query('data(L_ATTR_VALUE)') as varchar(max))as L_ATTR_CD_VALUE,\n    cast(Colx.query('data(R_ATTR_CD)') as varchar(max)) as R_ATTR_CD,\n    cast(Colx.query('data(R_ATTR_VALUE)') as varchar(max))as R_ATTR_CD_VALUE\n    INTO #TEMP \n    FROM @XMl_DATA.nodes('DocumentElement/Att_Table') AS T(Colx)\n\n    --INSERT INTO #TEMP_T(ATT_CD,ATT_CD_VALUE)\n    --SELECT LTRIM(RTRIM(L_ATT_CD)),LTRIM(RTRIM(L_ATT_CD_VALUE)) \n    --FROM #TEMP \n    --WHERE L_ATT_CD_VALUE &lt;&gt; 'NO_DATA'\n\n\n    --INSERT INTO #TEMP_T(ATT_CD,ATT_CD_VALUE)\n    --SELECT LTRIM(RTRIM(R_ATT_CD)),LTRIM(RTRIM(R_ATT_CD_VALUE)) \n    --FROM #TEMP \n    --WHERE R_ATT_CD_VALUE &lt;&gt;'NO_DATA'\n</code></pre>\n\n<p>Output:</p>\n\n<pre><code>     select * from #TEMP_T\n        select * from #TEMP \n</code></pre>\n"},{"tags":["sql-server","sql-server-2008","tsql","ssrs-2008","ssrs-reports"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":126,"score":1,"question_id":11995797,"title":"Passing Default Value into SSRS Query","body":"<p>In SSRS I have a report parameter that is a multi-select and has a default label of (None) and default value of 0. </p>\n\n<p>In my query I want to set it up so that I can pass in 0 or some other value(s). However, if I pass in 0, I don't want it to filter down the data.</p>\n\n<p>Normally you would add the below clause to your where statement, but I'm not sure if or how this is done with multiple values.</p>\n\n<p>(@Parameter = 0 OR table.column = @Parameter)</p>\n"},{"tags":["sql-server","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":86,"score":0,"question_id":12005673,"title":"SQL Server : insert a new row as ID of 1","body":"<p>I have a table called <code>ComplaintCodes</code> which contains about 15 rows and 2 columns: <code>ComplaintCodeId</code> and <code>ComplaintCodeText</code>. </p>\n\n<p>I want to insert a new row into that table but have its ID set to 1 which will also add 1 to all of the ID's that exist already. Is this possible?</p>\n\n<h2>EDIT</h2>\n\n<p>Using SQL Server and <code>ComplaintCodeId</code> is an identity / PK column</p>\n"},{"tags":["sql-server","sql-server-2008","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":112,"score":0,"question_id":12006273,"title":"Set IDENTITY_INSERT ON is not working","body":"<p>I want to copy a table <code>Equipment</code> from one database <code>MyDBQA</code> to our test database <code>MyDB</code>. There is an identity column in the table which is the primary key (int, not null).</p>\n\n<p>But I got an error:</p>\n\n<blockquote>\n  <p>Msg 8101, Level 16, State 1, Line 2<br>\n  An explicit value for the identity column in table 'MyDB.dbo.Equipment' can only be specified when a column list is used\n  and IDENTITY_INSERT is ON.</p>\n</blockquote>\n\n<p>My script:</p>\n\n<pre><code>SET IDENTITY_INSERT [MyDB].[dbo].[Equipment] ON\nINSERT INTO [MyDB].[dbo].[Equipment]  SELECT * FROM [MyDBQA].[dbo].[Equipment]\nSET IDENTITY_INSERT [MyDB].[dbo].[Equipment] OFF\n</code></pre>\n\n<p>Thank you.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":7,"favorite_count":0,"up_vote_count":5,"down_vote_count":0,"view_count":163,"score":5,"question_id":11991188,"title":"What does \"+=\" mean in T-SQL","body":"<p>What does the following variable assignment mean in T-SQL?</p>\n\n<pre><code>SET @myvariable += 'test'\n</code></pre>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":6,"favorite_count":1,"up_vote_count":3,"down_vote_count":0,"view_count":79,"score":3,"question_id":12003762,"title":"Query for fetching last n rows excluding the last row ","body":"<p>I have a table with 400 rows. I want to select last 6 rows excluding the last row.</p>\n\n<p>With the following code I am getting the last 6 rows but I don't want the last(400th) row to be there</p>\n\n<pre><code>SELECT * \nFROM ImagesInfo \nWHERE Image_Id IN \n     (    SELECT TOP 6 Image_Id \n          FROM ImagesInfo \n          ORDER BY Image_Id DESC )\n</code></pre>\n"},{"tags":["sql","tsql","sql-server-2005"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":203,"score":2,"question_id":12001783,"title":"TSQL Select Min & Max row when grouping","body":"<p>Lets say I have a table containing many many rows like this:</p>\n\n<pre><code>ID        Range         Range_begining        Profit\n----------------------------------------------------\n 1    (100-150)                    100           -20\n 2    (200-250)                    200          40.2\n 3    (100-150)                    100           100\n 4    (450-500)                    450           -90\n ...\n</code></pre>\n\n<p>I'm doing a simple query like this:</p>\n\n<pre><code>SELECT max([Range]) AS 'Range'\n     , count(ID) AS 'Count'\n     , round(avg([Profit]), 2) AS 'AVG Profit'\n    FROM\n        Orders\n    GROUP BY\n        Range_begining\n</code></pre>\n\n<p>After this query is run I get results like this:</p>\n\n<pre><code>Range        Count        AVG Profit\n------------------------------------\n(100-150)        2                40\n(200-250)        1              40.2\n(450-500)        1               -90\n ...\n</code></pre>\n\n<p>Quite simple :)</p>\n\n<p>What I need to do now is to select row with minimum and maximum profit where count is bigger than 10 (this is a parameter)</p>\n\n<p>I was able to get minimum value with this:</p>\n\n<pre><code>SELECT TOP 1 [Range], [AVG Profit] FROM (\n     SELECT max([Range]) AS 'Range'\n         , count(ID) AS 'Count'\n         , round(avg([Profit]), 2) AS 'AVG Profit'\n        FROM\n            Orders\n        GROUP BY\n            Range_begining) X\nWHERE\n    [Count]&gt;10\nORDER BY \n    [AVG Profit] ASC --or DESC if I want max profit\n</code></pre>\n\n<p>I was thinking of doing an <code>UNION</code> for above query with ORDER BY DESC, but it isn't the best solution.</p>\n\n<p>What I need to do:<br />\n<strong>Select 2 rows: one with minimum, second with maximum AVG Profit when grouping by Range.</strong></p>\n\n<p><strong>EDIT:</strong>\nIf I add 2 move columns to my main data table like this:</p>\n\n<pre><code>ID        Range         Range_begining        Profit        OrderDate     Company\n---------------------------------------------------------------------------------\n 1    (100-150)                    100           -20        2012-01-02          1\n 2    (200-250)                    200          40.2        2012-03-22          0\n 3    (100-150)                    100           100        2012-02-05          0\n 4    (450-500)                    450           -90        2012-05-12          1\n ...\n</code></pre>\n\n<p>And then try to add 2 more conditions like this:</p>\n\n<pre><code>; with ordering as (\n  SELECT max([Range]) AS 'Range'\n     , count(ID) AS 'Count'\n     , round(avg([Profit]), 2) AS 'AVG Profit'\n     , row_number() over (order by avg([Profit])) rn_min\n     , row_number() over (order by avg([Profit]) desc) rn_max\n    FROM\n        Orders\n    GROUP BY\n        Range_begining\n    HAVING COUNT(ID) &gt; 10\n    AND [Company]=@company\n    AND (@from= '' OR [OrderDate]&gt;=@from)\n    AND (@to= '' OR [OrderDate]&lt;=@to)\n)\nselect [range], [count], [avg profit]\n  from ordering\n where (rn_max = 1 or rn_min = 1)\n</code></pre>\n\n<p>I get an error because [Company] and [OrderDate] </p>\n\n<blockquote>\n  <p>is invalid in the HAVING clause because it is not contained in either\n  an aggregate function or the GROUP BY clause.</p>\n</blockquote>\n\n<p>How can I fix this?</p>\n\n<p><strong>EDIT2</strong>\nGot it working!</p>\n\n<pre><code>; with ordering as (\n  SELECT max([Range]) AS 'Range'\n     , count(ID) AS 'Count'\n     , round(avg([Profit]), 2) AS 'AVG Profit'\n     , row_number() over (order by avg([Profit])) rn_min\n     , row_number() over (order by avg([Profit]) desc) rn_max\n    FROM\n        Orders\n    WHERE\n    [Company]=@company\n    AND (@from= '' OR [OrderDate]&gt;=@from)\n    AND (@to= '' OR [OrderDate]&lt;=@to)\n    GROUP BY\n        Range_begining\n    HAVING COUNT(ID) &gt; 10\n)\nselect [range], [count], [avg profit]\n  from ordering\n where (rn_max = 1 or rn_min = 1)\n</code></pre>\n\n<p><strong>EDIT 3</strong>\nCan I return another column with description like this:</p>\n\n<pre><code>Range        AVG Profit               Description\n-------------------------------------------------\n(200-250)          40.2           Max profit here\n(450-500)           -90     Min profit, well done\n</code></pre>\n\n<p><strong>EDIT 4</strong>\nFast answer (based on @Nikola Markovinovi answer):</p>\n\n<pre><code>; with ordering as (\n  SELECT max([Range]) AS 'Range'\n     , count(ID) AS 'Count'\n     , round(avg([Profit]), 2) AS 'AVG Profit'\n     , row_number() over (order by avg([Profit])) rn_min\n     , row_number() over (order by avg([Profit]) desc) rn_max\n    FROM\n        Orders\n    WHERE\n    [Company]=@company\n    AND (@from= '' OR [OrderDate]&gt;=@from)\n    AND (@to= '' OR [OrderDate]&lt;=@to)\n    GROUP BY\n        Range_begining\n    HAVING COUNT(ID) &gt; 10\n)\n    SELECT\n    CASE WHEN rn_max=1 THEN 'This is max' ELSE 'Min' END AS 'Description'\n    ,[range]\n    ,[count]\n    ,[avg profit]\n    FROM ordering\n    WHERE (rn_max = 1 or rn_min = 1)\n</code></pre>\n"},{"tags":["tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":67,"score":0,"question_id":12000108,"title":"Incorrect syntax near the keyword 'truncate'. within a View","body":"<p>I get the error \"Incorrect syntax near the keyword 'truncate'.\" and not sure what's wrong with the syntax here, it's not obvious to me...probably something stupid but I need another set of eyes:</p>\n\n<pre><code>ALTER VIEW [dbo].[vw_All_Events]\nAS\n\ntruncate table Event\n\nSelect [event_id]\n      ,[site_id]\n      ,[autogenerated]\n      ,[creation_date]\n      ,[last_update_date]\nfrom Event\n\nGO\n</code></pre>\n"},{"tags":["tsql","function","parameters","return","openquery"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":207,"score":0,"question_id":11996018,"title":"Function with parameter in Openquery","body":"<p>I am trying to create a function that uses the parameter in an OpenQuery like below:</p>\n\n<pre><code>CREATE FUNCTION fnMyFunction (@myVar INT) RETURNS TABLE AS\n    DECLARE @Query VARCHAR(2000)\nSET @Query = 'SELECT * FROM OPENQUERY(myLinkedServer, ''SELECT num FROM tblMyTable WHERE\nmyTableNum = '+ @myVar + '  '')'\n\nRETURN EXEC(@Query)\n</code></pre>\n\n<p>The Openquery should return only a single integer. I've tried</p>\n\n<pre><code>...RETURNS INT AS\n...OPENQUERY...\nDECLARE @num INT\nSET @num = 0\n@num = EXEC(@Query)\nRETURN @num\n</code></pre>\n\n<p>and get A RETURN statement with a return value cannot be used in this context.</p>\n"},{"tags":["tsql","sql-server-2008","ssrs-2008"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":1328,"score":1,"question_id":3441088,"title":"Simple Way to View SQL Query (ies) Generated by SSRS Reports?","body":"<p>Is there a simple way to view the SQL Queries actually generated by SSRS other than running profile traces to capture them? </p>\n\n<p>Is there some way from within the BIDS editor to see this? </p>\n"},{"tags":["sql","tsql"],"answer_count":2,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":56,"score":0,"question_id":11980546,"title":"Unable to pivot table","body":"<p>I found this link <a href=\"http://blogs.msdn.com/b/spike/archive/2009/03/03/pivot-tables-in-sql-server-a-simple-sample.aspx\" rel=\"nofollow\">Pivot tables in SQL Server. A simple sample.</a> and did a conversion it to temp table. However, I got an error \"Incorrect syntax near '('.\" Can you help me on this? Below is the code:</p>\n\n<pre><code>IF OBJECT_ID('tempdb..#DailyIncome') IS NOT NULL\nBEGIN\ndrop table #DailyIncome\nEND\n\ncreate table #DailyIncome\n       (\n         VendorId nvarchar(10)\n         , IncomeDay nvarchar(10)\n         , IncomeAmount int\n       )\n\ninsert into #DailyIncome values ('SPIKE', 'FRI', 100)\ninsert into #DailyIncome values ('SPIKE', 'MON', 300)\ninsert into #DailyIncome values ('FREDS', 'SUN', 400)\ninsert into #DailyIncome values ('SPIKE', 'WED', 500)\ninsert into #DailyIncome values ('SPIKE', 'TUE', 200)\ninsert into #DailyIncome values ('JOHNS', 'WED', 900)\ninsert into #DailyIncome values ('SPIKE', 'FRI', 100)\ninsert into #DailyIncome values ('JOHNS', 'MON', 300)\ninsert into #DailyIncome values ('SPIKE', 'SUN', 400)\ninsert into #DailyIncome values ('JOHNS', 'FRI', 300)\ninsert into #DailyIncome values ('FREDS', 'TUE', 500)\ninsert into #DailyIncome values ('FREDS', 'TUE', 200)\ninsert into #DailyIncome values ('SPIKE', 'MON', 900)\ninsert into #DailyIncome values ('FREDS', 'FRI', 900)\ninsert into #DailyIncome values ('FREDS', 'MON', 500)\ninsert into #DailyIncome values ('JOHNS', 'SUN', 600)\ninsert into #DailyIncome values ('SPIKE', 'FRI', 300)\ninsert into #DailyIncome values ('SPIKE', 'WED', 500)\ninsert into #DailyIncome values ('SPIKE', 'FRI', 300)\ninsert into #DailyIncome values ('JOHNS', 'THU', 800)\ninsert into #DailyIncome values ('JOHNS', 'SAT', 800)\ninsert into #DailyIncome values ('SPIKE', 'TUE', 100)\ninsert into #DailyIncome values ('SPIKE', 'THU', 300)\ninsert into #DailyIncome values ('FREDS', 'WED', 500)\ninsert into #DailyIncome values ('SPIKE', 'SAT', 100)\ninsert into #DailyIncome values ('FREDS', 'SAT', 500)\ninsert into #DailyIncome values ('FREDS', 'THU', 800)\ninsert into #DailyIncome values ('JOHNS', 'TUE', 600)\n\nSELECT * FROM #DailyIncome\n\nSELECT *\nFROM #DailyIncome\npivot(avg(IncomeAmount) FOR IncomeDay IN (\n        [MON]\n        ,[TUE]\n        ,[WED]\n        ,[THU]\n        ,[FRI]\n        ,[SAT]\n        ,[SUN]\n        )) AS AvgIncomePerDay\n</code></pre>\n\n<p>Thanks guys!</p>\n\n<p><strong>[UPDATE]</strong></p>\n\n<p>Based on the comments, the database is created using SQL Server 2000. Is there a workaround for this?</p>\n"},{"tags":["sql","sql-server","tsql","sql-server-2008-r2","checksum"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":49,"score":0,"question_id":11994430,"title":"What conditions cause CHECKSUM_AGG to return 0?","body":"<p>It seems that there are a number of conditions that cause <code>CHECKSUM_AGG</code> to return 0 that I wouldn't have expected. I've only been able to find one discussed, which is that duplicate values will cause it. That can be solved via a <code>DISTINCT</code> or <code>GROUP BY</code>.</p>\n\n<p>I've also found a couple more scenarios that make less sense to me. One was provided by my boss and one I found <a href=\"http://social.msdn.microsoft.com/Forums/en/transactsql/thread/3e0c17ac-fc6b-469d-9542-940b0752fdf4\" rel=\"nofollow\">MSDN</a>. These I don't know how to explain. Here is some SQL that demonstrates the scenarios:</p>\n\n<pre><code>SELECT\n    CHECKSUM_AGG(T.Number) AS ChecksumAgggregate\nFROM\n(\n    VALUES\n        (2)\n        , (3)\n        , (4)\n        , (5)\n)AS T(Number)\n\nDECLARE @t TABLE \n(\n    Category VARCHAR(15),\n    Value VARCHAR(10)\n)\n\nINSERT @t \n(\n    Category\n    , Value\n)\nVALUES \n    ('OneCharacter','a')\n    ,('OneCharacter','b')\n    ,('OneCharacter','c')\n    ,('OneCharacter','d')\n\n    ,('TwoCharacters','aa')\n    ,('TwoCharacters','bb')\n    ,('TwoCharacters','cc')\n    ,('TwoCharacters','dd')\n\n    ,('ThreeCharacters','aaa')\n    ,('ThreeCharacters','bbb')\n    ,('ThreeCharacters','ccc')\n    ,('ThreeCharacters','ddd')\n\n    ,('SixCharacters','aaaaaa')\n    ,('SixCharacters','bbbbbb')\n    ,('SixCharacters','cccccc')\n    ,('SixCharacters','dddddd')\n\n    ,('AllValues','a')\n    ,('AllValues','b')\n    ,('AllValues','c')\n    ,('AllValues','d')\n    ,('AllValues','aa')\n    ,('AllValues','bb')\n    ,('AllValues','cc')\n    ,('AllValues','dd')\n    ,('AllValues','aaa')\n    ,('AllValues','bbb')\n    ,('AllValues','ccc')\n    ,('AllValues','ddd')\n    ,('AllValues','aaaaaa')\n    ,('AllValues','bbbbbb')\n    ,('AllValues','cccccc')\n    ,('AllValues','dddddd')\n\nselect \n    Category, CHECKSUM_AGG(CHECKSUM(Value)) \nfrom @t \ngroup by Category\n\nselect Category, Value, CHECKSUM(Value) ValueChecksum\nfrom @t\n</code></pre>\n\n<p>It's nothing but 0's in these examples from <code>CHECKSUM_AGG</code> from these queries. The last query shows that none of the <code>CHECKSUM</code> values that are getting input into the <code>CHECKSUM_AGG</code> call are duplicated.</p>\n\n<p>I'm hoping that whatever answer describes what causes <code>CHECKSUM_AGG</code> to return 0 will explain these situations as well.</p>\n"},{"tags":["tsql","recursion","sql-order-by","common-table-expression"],"answer_count":1,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":86,"score":2,"question_id":11979289,"title":"Recursive CTE with order by","body":"<p>I'm working with a hierarchical data and using a recursive CTE to list the items like this:</p>\n\n<pre><code>Eletronics\n    Televisions\n        Tube\n        LCD\n        Plasma\n    Portable Electronic\n        MP3 Players\n            Flash\n        CD Player\n        Two Way Radios\n</code></pre>\n\n<p>My question is:<br>\nHow to do this list ordered by the title and respecting the hierarchy?</p>\n\n<p>Like this:</p>\n\n<pre><code>Eletronics\n    Portable Electronic\n        CD Player\n        MP3 Players\n            Flash\n        Two Way Radios\n    Televisions\n        LCD\n        Plasma\n        Tube\n</code></pre>\n\n<p>Tks</p>\n"},{"tags":["sql","sql-server-2008","tsql","stored-procedures","sql-server-2008-r2"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":83,"score":0,"question_id":11983253,"title":"Stored procedure without cursors","body":"<p>How can I write the following sp without the cursor?. More over its not giving me the desired output. I didn't write this, I am trying to interpret what is wrong with this.</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[AccreditationExpiryCheck]\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    declare @taskTypeId int = 19 -- Accreditations, automated\n    declare @firstActionTypeId int = 23 -- Accreditation expiring\n    declare @nextActionTypeId int = 3 -- Call company\n\n    declare @companyId int\n    declare @accreditationId int\n    declare @comment nvarchar(max) = N' accreditation for this company has expired.'\n\n    -- find all companies and accreditations expiring\n    declare companies cursor local forward_only read_only for \n        select c.Company_Id, a.Accred_ID\n        from COMPANY c\n            inner join MEMBERSHIP m on c.Company_ID = m.Company_ID\n            inner join ACCREDITATION a on c.Company_ID = a.Company_ID\n        where\n            -- Accreditation expired yesterday\n            cast(a.Accred_ExpDate as DATE) = cast(DATEADD(DAY, -1, GETDATE()) as DATE)\n            and m.IsMember_Ind = 1\n            and (c.HQ_ID IS NULL OR c.HQ_ID = c.Company_ID)  -- FB4640: this isn't a 'team' co (with an HQ)\n            -- and there is no action of this type created within 1 day\n            -- of the expiry date\n            and not exists (\n                select * from TaskAction ta where\n                    ta.FirstActionTypeId = @firstActionTypeId and\n                    ta.TaskTypeId = @taskTypeId and\n                    ta.TaskCreatedOn BETWEEN a.Accred_ExpDate AND DATEADD(DAY, 1, a.Accred_ExpDate) and\n                    ta.EntityId = c.Company_ID and \n                    ta.EntityTypeId = 1 )\n\n    open companies\n\n    fetch next from companies into @companyId, @accreditationId\n\n    declare @title nvarchar(max) = \n        (select AccredType_Name from ACCREDITATION_TYPE at \n        inner join ACCREDITATION a on at.AccredType_ID = a.AccredType_ID\n        where a.Accred_ID = @accreditationId)\n\n    declare @comment2 nvarchar(max) = isnull(@title, '') + ' accreditation for this company has expired.'\n    while @@FETCH_STATUS = 0\n    begin\n        exec CreateSystemTask \n            @taskTypeId, \n            @firstActionTypeId,\n            @nextActionTypeId,\n            @companyid,\n            @comment2,\n            @title\n\n        fetch next from companies into @companyId,@accreditationId\n    end\n\n    close companies\n    deallocate companies\nEND\n</code></pre>\n\n<p>The following select statement from the above sp gives me the correct dataset, but the cursor which loops through gives me a different output. </p>\n\n<pre><code>select c.Company_Id, a.Accred_ID\n        from COMPANY c\n            inner join MEMBERSHIP m on c.Company_ID = m.Company_ID\n            inner join ACCREDITATION a on c.Company_ID = a.Company_ID\n        where\n            -- Accreditation expired yesterday\n            cast(a.Accred_ExpDate as DATE) = cast(DATEADD(DAY, -1, GETDATE()) as DATE)\n            and m.IsMember_Ind = 1\n            and (c.HQ_ID IS NULL OR c.HQ_ID = c.Company_ID)  -- FB4640: this isn't a 'team' co (with an HQ)\n            -- and there is no action of this type created within 1 day\n            -- of the expiry date\n            and not exists (\n                select * from TaskAction ta where\n                    ta.FirstActionTypeId = @firstActionTypeId and\n                    ta.TaskTypeId = @taskTypeId and\n                    ta.TaskCreatedOn BETWEEN a.Accred_ExpDate AND DATEADD(DAY, 1, a.Accred_ExpDate) and\n                    ta.EntityId = c.Company_ID and \n                    ta.EntityTypeId = 1 )\n</code></pre>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":1,"view_count":109,"score":0,"question_id":11991079,"title":"Select a Column in SQL not in Group By","body":"<p>I have been trying to find some info on how to select a non-aggregate column that is not contained in the Group By statement in SQL, but nothing I've found so far seems to answer my question. I have a table with three columns that I want from it. One is a create date, one is a ID that groups the records by a particular Claim ID, and the final is the PK. I want to find the record that has the max creation date in each group of claim IDs. I am selecting the MAX(creation date), and Claim ID (cpe.fmgcms_cpeclaimid), and grouping by the Claim ID. But I need the PK from these records (cpe.fmgcms_claimid), and if I try to add it to my select clause, I get an error. And I can't add it to my group by clause because then it will throw off my intended grouping. Does anyone know any workarounds for this? Here is a sample of my code:</p>\n\n<pre><code>Select MAX(cpe.createdon) As MaxDate, cpe.fmgcms_cpeclaimid \nfrom Filteredfmgcms_claimpaymentestimate cpe\nwhere cpe.createdon &lt; 'reportstartdate'\ngroup by cpe.fmgcms_cpeclaimid\n</code></pre>\n\n<p>This is the result I'd like to get:</p>\n\n<pre><code>Select MAX(cpe.createdon) As MaxDate, cpe.fmgcms_cpeclaimid, cpe.fmgcms_claimid \nfrom Filteredfmgcms_claimpaymentestimate cpe\nwhere cpe.createdon &lt; 'reportstartdate'\ngroup by cpe.fmgcms_cpeclaimid\n</code></pre>\n"},{"tags":["sql-server","tsql","stored-procedures"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":83,"score":0,"question_id":11983455,"title":"Writing the stored procedure without cursor","body":"<blockquote>\n  <p><strong>Possible Duplicate:</strong><br>\n  <a href=\"http://stackoverflow.com/questions/11983253/stored-procedure-without-cursors\">Stored procedure without cursors</a>  </p>\n</blockquote>\n\n\n\n<p>How can I write the following sp without the cursor?. More over its not giving me the desired output. I didn't write this, I am trying to interpret what is wrong with this.</p>\n\n<pre><code>ALTER PROCEDURE [dbo].[AccreditationExpiryCheck]\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    declare @taskTypeId int = 19 -- Accreditations, automated\n    declare @firstActionTypeId int = 23 -- Accreditation expiring\n    declare @nextActionTypeId int = 3 -- Call company\n\n    declare @companyId int\n    declare @accreditationId int\n    declare @comment nvarchar(max) = N' accreditation for this company has expired.'\n\n    -- find all companies and accreditations expiring\n    declare companies cursor local forward_only read_only for \n        select c.Company_Id, a.Accred_ID\n        from COMPANY c\n            inner join MEMBERSHIP m on c.Company_ID = m.Company_ID\n            inner join ACCREDITATION a on c.Company_ID = a.Company_ID\n        where\n            -- Accreditation expired yesterday\n            cast(a.Accred_ExpDate as DATE) = cast(DATEADD(DAY, -1, GETDATE()) as DATE)\n            and m.IsMember_Ind = 1\n            and (c.HQ_ID IS NULL OR c.HQ_ID = c.Company_ID)  -- FB4640: this isn't a 'team' co (with an HQ)\n            -- and there is no action of this type created within 1 day\n            -- of the expiry date\n            and not exists (\n                select * from TaskAction ta where\n                    ta.FirstActionTypeId = @firstActionTypeId and\n                    ta.TaskTypeId = @taskTypeId and\n                    ta.TaskCreatedOn BETWEEN a.Accred_ExpDate AND DATEADD(DAY, 1, a.Accred_ExpDate) and\n                    ta.EntityId = c.Company_ID and \n                    ta.EntityTypeId = 1 )\n\n    open companies\n\n    fetch next from companies into @companyId, @accreditationId\n\n    declare @title nvarchar(max) = \n        (select AccredType_Name from ACCREDITATION_TYPE at \n        inner join ACCREDITATION a on at.AccredType_ID = a.AccredType_ID\n        where a.Accred_ID = @accreditationId)\n\n    declare @comment2 nvarchar(max) = isnull(@title, '') + ' accreditation for this company has expired.'\n    while @@FETCH_STATUS = 0\n    begin\n        exec CreateSystemTask \n            @taskTypeId, \n            @firstActionTypeId,\n            @nextActionTypeId,\n            @companyid,\n            @comment2,\n            @title\n\n        fetch next from companies into @companyId,@accreditationId\n    end\n\n    close companies\n    deallocate companies\nEND\n</code></pre>\n\n<p>The following select statement from the above sp gives me the correct dataset, but the cursor which loops through gives me a different output.</p>\n\n<pre><code>select c.Company_Id, a.Accred_ID\n        from COMPANY c\n            inner join MEMBERSHIP m on c.Company_ID = m.Company_ID\n            inner join ACCREDITATION a on c.Company_ID = a.Company_ID\n        where\n            -- Accreditation expired yesterday\n            cast(a.Accred_ExpDate as DATE) = cast(DATEADD(DAY, -1, GETDATE()) as DATE)\n            and m.IsMember_Ind = 1\n            and (c.HQ_ID IS NULL OR c.HQ_ID = c.Company_ID)  -- FB4640: this isn't a 'team' co (with an HQ)\n            -- and there is no action of this type created within 1 day\n            -- of the expiry date\n            and not exists (\n                select * from TaskAction ta where\n                    ta.FirstActionTypeId = @firstActionTypeId and\n                    ta.TaskTypeId = @taskTypeId and\n                    ta.TaskCreatedOn BETWEEN a.Accred_ExpDate AND DATEADD(DAY, 1, a.Accred_ExpDate) and\n                    ta.EntityId = c.Company_ID and \n                    ta.EntityTypeId = 1 )\n</code></pre>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":41,"score":0,"question_id":11990695,"title":"\"OBJECT_NAME\" function no longer returns objects' names","body":"<p>I use the \"OBJECT_NAME' function in conjunction with systems tables to return the names of objects given their object_id.  Up until yesterday, this worked fine.  When I use the same function now, I get a null value in the column that is supposed to return the object name.  I tried reconnecting to the server and trying the function on different DBs, but I am getting the same results.  Does anyone know why this would occur?</p>\n"},{"tags":["sql-server","sql-server-2008","tsql","type-conversion"],"answer_count":1,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":81,"score":3,"question_id":11990447,"title":"How to safely convert NVARCHAR to MONEY","body":"<p>I have an existing table with a 'price_info' column of type <code>NVARCHAR</code>. I'd like to add a new column 'price' of type <code>MONEY</code> and (where possible) convert/copy the contents of the 'price_info' column into it.</p>\n\n<p>If 'price_info' contains only numeric data, then the value can easily be converted. But of course 'price_info' can also contain data which cannot be converted to type <code>MONEY</code> in which case an error occurs.</p>\n\n<p>Is there a way to copy only the values where the conversion to <code>MONEY</code> is successful, and silently ignore all other rows (or set the 'price' column to 0 in these cases)?</p>\n\n<p>E.g. what I'd like to have is something like this (pseudo-code):</p>\n\n<pre><code>update products set price = some_conversion_function(money, price_info, 0)\n</code></pre>\n\n<p>(where 0 is the default value to be used if the conversion fails).</p>\n"},{"tags":["sql-server","sql-server-2008","query","tsql"],"answer_count":3,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":42,"score":1,"question_id":11988395,"title":"Writing a query to select specific foreign key entries given a specific criteria","body":"<p>So I have a table that has a <code>FK</code> to a <code>UserId</code>, and a <code>FK</code> to a <code>ProductId</code>.</p>\n\n<p>Each <code>UserId</code> can be listed multiple times if they have multiple products.</p>\n\n<p>I need to query to get each <code>UserId</code> that has, for example, <code>ProductId 1</code>, but NOT <code>ProductId 2</code>.</p>\n\n<p>How can I get started writing a query like this?</p>\n\n<p><strong>Edit:</strong></p>\n\n<p>But here is the part I'm having problems with; all users who have Product 1 should have Product 2, but some don't, so I need to get the users who have Product 1 and NOT Product 2</p>\n"},{"tags":["sql","tsql","datetime","try-catch"],"answer_count":5,"favorite_count":0,"up_vote_count":3,"down_vote_count":0,"view_count":5906,"score":3,"question_id":920760,"title":"TRY CATCH on a CONVERT in a Select Statement","body":"<p>Is it possible to use TRY CATCH blocks in SQL Selects?</p>\n\n<p>For stuff similar to this for example:</p>\n\n<pre><code>select \n   order, \n   CONVERT(DATETIME, orderDate)\nfrom orders\n</code></pre>\n\n<p>What's the best  way of handling this scenario?</p>\n"},{"tags":["sql-server","tsql"],"answer_count":1,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":147,"score":0,"question_id":11985767,"title":"Conversion failed when converting the nvarchar value to data type int","body":"<p>I have a table of data with a primary key which generally takes the format of <code>$$$$#####$$</code>, although there a couple of exceptions to this where there is no number. I want to extract the number part of the key and then use it so I can generate unique primary keys.</p>\n\n<p>I therefore created a view which contained a column showing only the numeric value and ignored any items which could not convert to numbers.</p>\n\n<p>When I wrote a query to select a specific item from the view I get </p>\n\n<blockquote>\n  <p><em>Conversion failed when converting the nvarchar value to data type\n  int.</em></p>\n</blockquote>\n\n<p>and it would appear that although I specifically ignored the exceptions in the view they are still being references some how.</p>\n\n<p>Any help would greatly be appreciated.</p>\n\n<p>Matt</p>\n"},{"tags":["sql","sql-server-2008","tsql"],"answer_count":4,"favorite_count":1,"up_vote_count":4,"down_vote_count":0,"view_count":146,"score":4,"question_id":11981979,"title":"T-SQL using SUM for a running total","body":"<p>I have a simple table with some dummy data setup like:</p>\n\n<pre><code>|id|user|value|\n---------------\n 1  John   2\n 2  Ted    1\n 3  John   4\n 4  Ted    2\n</code></pre>\n\n<p>I can select a running total by executing the following sql(MSSQL 2008) statement:</p>\n\n<pre><code>SELECT a.id, a.user, a.value, SUM(b.value) AS total\nFROM table a INNER JOIN table b\nON a.id &gt;= b.id\nAND a.user = b.user\nGROUP BY a.id, a.user, a.value\nORDER BY a.id\n</code></pre>\n\n<p>This will give me results like:</p>\n\n<pre><code>|id|user|value|total|\n---------------------\n 1  John   2     2\n 3  John   4     6\n 2  Ted    1     1\n 4  Ted    2     3\n</code></pre>\n\n<p>Now is it possible to only retrieve the most recent rows for each user? So the result would be:</p>\n\n<pre><code>|id|user|value|total|\n---------------------\n 3  John   4     6\n 4  Ted    2     3\n</code></pre>\n\n<p>Am I going about this the right way? any suggestions or a new path to follow would be great!</p>\n"},{"tags":["asp.net","sql","sql-server","tsql"],"answer_count":4,"favorite_count":0,"up_vote_count":1,"down_vote_count":0,"view_count":87,"score":1,"question_id":11963905,"title":"Seeking advice on how to structure the SQL Server 2008 DB table with large amount of data?","body":"<p>I am planning a web application (programmed using ASP.NET) that manages the database of logged events. The database will be managed in an SQL Server 2008. Each event may come from a set of, let's call them, \"units.\" A user will be able to add and remove these \"units\" via the ASP.NET interface. </p>\n\n<p>Each of the \"units\" can potentially log up to a million entries, or maybe even more. (The cut off will be administered via a date. For instance:</p>\n\n<pre><code>DELETE FROM [tbl] WHERE [date] &lt; '01-01-2011'\n</code></pre>\n\n<p>The question I have is what is the best way to structure such database:</p>\n\n<ol>\n<li><p>By placing all entries for all \"units\" in a single table like this:</p>\n\n<pre><code>CREATE TABLE tblLogCommon (id INT PRIMARY INDEX, \n                           idUnit INT, \n                           dtIn DATETIME2, dtOut DATETIME2, etc INT)\n</code></pre></li>\n<li><p>Or, by separating tables for each \"unit\":</p>\n\n<pre><code>CREATE TABLE tblLogUnit_1 (id INT PRIMARY INDEX, dtIn DATETIME2, dtOut DATETIME2, etc INT)\nCREATE TABLE tblLogUnit_2 (id INT PRIMARY INDEX, dtIn DATETIME2, dtOut DATETIME2, etc INT)\nCREATE TABLE tblLogUnit_3 (id INT PRIMARY INDEX, dtIn DATETIME2, dtOut DATETIME2, etc INT)\n--and so on\nCREATE TABLE tblLogUnit_N (id INT PRIMARY INDEX, dtIn DATETIME2, dtOut DATETIME2, etc INT)\n</code></pre></li>\n</ol>\n\n<p>Approach #1 seems simpler from a standpoint of referencing entries because with approach #2 I'll have to deal with variable N number of tables (as I said users will be allowed to add and remove \"units.)</p>\n\n<p>But approach #1 may render access to those log entries later very inefficient. I will have to generate reports from those logs via the ASP.NET interface.</p>\n\n<p>So I'd like to hear your take on this before I begin coding?</p>\n\n<p><strong>EDIT:</strong> I didn't realize that the number of columns in a table makes a difference. My bad! The actual number of columns in a table is 16.</p>\n"},{"tags":["sql","sql-server","tsql","alter-table","create-table"],"answer_count":3,"favorite_count":0,"up_vote_count":0,"down_vote_count":2,"view_count":213,"score":-2,"question_id":11982678,"title":"T-SQL: modified CREATE TABLE script to ALTER TABLE script crashes","body":"<p>This script was generated from SQL Server Management Studio.  Why am I getting this error and how can I fix the ALTER script?  Note, that I changed the word \"CREATE\" to \"ALTER\".  So I'm guessing the CREATE syntax is slightly different from the ALTER syntax, or has less restrictions.  I'm using SQL Server 2008 Express.  I see it's telling me to end with a semicolon, but I want to make sure terminating the statement won't cause me any issues later.  If you can describe what each piece of the query does and what we're changing, bonus points awarded.</p>\n\n<pre><code>SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n--CREATE TABLE [dbo].[defect](\nALTER TABLE [dbo].[defect](\n    [defect_id] [bigint] IDENTITY(1,1) NOT NULL,\n    [defect_number] [nvarchar](50) NULL,\n    [defect_type] [nvarchar](50) NULL,\n    [date_created] [datetime] NULL,\n    [user_identified_by] [nvarchar](50) NULL,\n    [status] [nvarchar](50) NULL,\n    [date_modified] [datetime] NULL,\n    [user_qa] [nvarchar](50) NULL,\n    [severity] [nvarchar](50) NULL,\n    [environment] [nvarchar](50) NULL,\n    [user_assigned] [nvarchar](50) NULL,\n    [project] [nvarchar](50) NULL,\n    [target_table_affected] [nvarchar](50) NULL,\n    [required_for_go_live] [nvarchar](50) NULL,\n    [project_phase] [nvarchar](50) NULL,\n    [completion_hours] [nvarchar](50) NULL,\n    [date_migrate_prod] [datetime] NULL,\n    [description] [text] NULL,\n    [table_columns_affected] [text] NULL,\n    [sample_data] [text] NULL,\n    [action_taken] [text] NULL,\n    [supp_detail_links] [text] NULL,\n    [supp_detail_links_dtml] [text] NULL,\n    [thread] [bigint] NULL,\n CONSTRAINT [PK_defect] PRIMARY KEY CLUSTERED \n(\n    [defect_id] ASC\n)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]\n) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]\nGO\n</code></pre>\n\n<p>Error:</p>\n\n<blockquote>\n  <p><em>Msg 102, Level 15, State 1, Line 1<br>\n  Incorrect syntax near '('.<br>\n  Msg 319, Level 15, State 1, Line 29<br>\n  Incorrect syntax near the keyword 'with'. If this statement is a common table  expression, an xmlnamespaces clause or a change tracking\n  context clause, the previous statement must be terminated with a\n  semicolon.</em></p>\n</blockquote>\n"},{"tags":["sql-server","tsql"],"answer_count":2,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":85,"score":2,"question_id":11981883,"title":"Converting arithmetic formula in a string into a values","body":"<p>I have a table in which all entries are in form of arithmetic formulas (i.e. <code>1+2+3</code> etc). </p>\n\n<p>In this table all columns are of type <code>varchar</code>. The table has many columns like this. </p>\n\n<p>I want to calculate formula and insert the values into another. Any suggestions on how to achieve this? </p>\n"},{"tags":["java","sql-server-2008","tsql","sql-server-2005","teradata"],"answer_count":5,"favorite_count":1,"up_vote_count":0,"down_vote_count":0,"view_count":139,"score":0,"question_id":11965633,"title":"Getting distinct values from Resultset","body":"<p>I have the following table Employee and records as follows:</p>\n\n<pre><code>Eid      Ename     Phone\n------------------------     \n 1         A        043\n 1         A        067\n 2         B        073\n 2         B        072\n 3         C        753 \n 3         C        464\n</code></pre>\n\n<p>What I've got so far:</p>\n\n<pre><code>SELECT *\nFROM   (SELECT Row_number() OVER (ORDER BY Eid ASC) AS rownum,\n               Eid,\n               Ename,\n               Phone\n        FROM   Employee\n        WHERE  Eid IN(SELECT DISTINCT(Eid)\n                      FROM   Employee\n                      GROUP  BY Eid)) AS RESULTSET\nWHERE  rownum BETWEEN 0 AND 3\n</code></pre>\n\n<p>Actually the inner query is returning the <code>distinct</code> results but it is not reflected when I am getting the result in final <code>RESULTSET</code>.</p>\n\n<p>Please advise on how to get the distinct RESULTSET. My output should return like below:</p>\n\n<pre><code>Eid      Ename     Phone\n------------------------     \n 1         A         043\n 2         B         073\n 3         C         753\n</code></pre>\n"},{"tags":["sql","sql-server","tsql","sql-server-2000"],"answer_count":8,"favorite_count":3,"up_vote_count":8,"down_vote_count":0,"view_count":2932,"score":8,"question_id":1794697,"title":"Find last sunday","body":"<p>How will you find last sunday of a month in sql 2000?</p>\n"},{"tags":["sql-server","tsql","vbscript","ms-access-2007"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":79,"score":0,"question_id":11979470,"title":"MSAccess and SQL Server Backend, Compare and Update production database schema","body":"<p>I am running an MSACCESS 2007 front end database with a SQLEXpress back end, this is for a university research project. So cheap/free is good, as is my dev time (free).....</p>\n\n<p>I would like a T-sql (or vbscript) to compare and update the production database.</p>\n\n<p>I am working in a development database making changes and want a simple way for the changes in dev to be propogated into Prod. Unfortunately I am not available to manually update production.</p>\n\n<p>So i think the process would be:</p>\n\n<p>1) Restore Dev to prod sql server\n2) Compare Prod vs Dev database (Schema only)\n3) Update Prod to equal Dev (Schema only)\n4) Check with Step 2.</p>\n\n<p>Option 2:</p>\n\n<p>Compare Generate SQL scripts locally using a database compare to:\nRun the SQL scripts</p>\n\n<p>No data entry at this stage</p>\n\n<p>I am aware of the DB compare tools (by Red-Gate)</p>\n\n<p>Anyhow, thanks for any pointers.</p>\n\n<p>Roger</p>\n"},{"tags":["sql","sql-server","sql-server-2008","tsql","sql-server-2005"],"answer_count":3,"favorite_count":0,"up_vote_count":2,"down_vote_count":0,"view_count":106,"score":2,"question_id":11972350,"title":"Crosstab multi columns","body":"<p>Hello I have a problem with SQL in SQL Server 2005.</p>\n\n<p>Suppose that I have a table called myTable with data as below:</p>\n\n<pre><code>|   NAME | CREDIT | GRADE | YEAR | SEMESTER |\n---------------------------------------------\n|  Name1 |      1 |     A |    1 |        1 |\n|  Name2 |      4 |     B |    1 |        1 |\n|  Name3 |      2 |     E |    1 |        1 |\n|  Name4 |      7 |     F |    1 |        1 |\n|  Name5 |      4 |     A |    1 |        2 |\n|  Name6 |      3 |     C |    1 |        2 |\n|  Name7 |      6 |     D |    1 |        2 |\n|  Name8 |      1 |     A |    1 |        2 |\n|  Name9 |      1 |     A |    1 |        2 |\n| Name10 |      1 |     A |    1 |        2 |\n| Name11 |      3 |     C |    2 |        1 |\n| Name12 |      6 |     E |    2 |        1 |\n| Name13 |      4 |     C |    2 |        1 |\n| Name14 |      2 |     B |    2 |        2 |\n| Name15 |      1 |     A |    2 |        2 |\n| Name16 |      1 |     A |    2 |        2 |\n| Name17 |      1 |     A |    2 |        2 |\n| Name18 |      5 |     D |    3 |        1 |\n| Name19 |      1 |     A |    3 |        1 |\n| Name20 |      1 |     A |    3 |        1 |\n| Name18 |      5 |     D |    3 |        2 |\n| Name19 |      1 |     A |    3 |        2 |\n| Name20 |      1 |     A |    3 |        2 |\n</code></pre>\n\n<p>I want to output the result as below:</p>\n\n<pre><code>|  NAM1 | CRDT1 | GRD1 | YEAR1 | SEMER1 | NAM2 | CRDT2 | GRD2 | YEAR2 | SEMES2 |\n   -----------------------------------------------------------------------------\n|  Name1|     1 |    A |     1 |      1 |Name5 |     4 |    A |     1 |      2 |\n|  Name2|     4 |    B |     1 |      1 |Name6 |     3 |    C |     1 |      2 |\n|  Name3|     2 |    E |     1 |      1 |Name7 |     6 |    D |     1 |      2 |\n|  Name4|     7 |    F |     1 |      1 |Name8 |     1 |    A |     1 |      2 |\n                                        |Name9 |     1 |    A |     1 |      2 |\n                                        |Name10|     1 |    A |     1 |      2 |\n| Name11|    3 |     C |     2 |      1 |Name14|     2 |    B |     2 |      2 |\n| Name12|    6 |     E |     2 |      1 |Name15|     1 |    A |     2 |      2 |\n| Name13|    4 |     C |     2 |      1 |Name16|     1 |    A |     2 |      2 |\n                                        |Name17|     1 |    A |     2 |      2 | \n| Name18|    5 |     D |     3 |      1 |Name18|     5 |    D |     3 |      2 |\n| Name19|    1 |     A |     3 |      1 |Name19|     1 |    A |     3 |      2 |\n| Name20|    1 |     A |     3 |      1 |Name20|     1 |    A |     3 |      2 |   \n</code></pre>\n\n<p>Where </p>\n\n<pre><code>- Nam1= Name in Semester 1\n- CRDT1= Credit in Semester 1\n- GRD1= Grade in Semester 1\n- Year1= Year in Semester 1 \n- Semer1 = Semester in Semester 1\n\n- Nam2= Name in Semester 2\n- CRDT2= Credit in Semester 2\n- GRD2= Grade in Semester 2\n- Year2= Year in Semester 2 \n- Semer2 = Semester in Semester 2\n</code></pre>\n\n<p>Please go to this URL to test this SQL: <a href=\"http://sqlfiddle.com/#!3/196c6/1\" rel=\"nofollow\">http://sqlfiddle.com/#!3/196c6/1</a> <br /><br />\nHow Can I create SQL to make output like this?</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":5,"favorite_count":1,"up_vote_count":1,"down_vote_count":0,"view_count":73,"score":1,"question_id":11977283,"title":"Finding multiple ID matches in a single table","body":"<p>In SQL Server (2008), I'd like to find all employees in a single table that have skillids of 3, 4, 5 or 4, 5, 6.  They need to have one of those sets.  Just having skillid=4, for example, should not produce a match.  How do I construct this type of query?</p>\n\n<p>An example table:</p>\n\n<pre><code>pkid, empid, skillid\n 1     2       3\n 2     2       4\n 3     2       5\n 4     5       6\n</code></pre>\n\n<p>In the above example, empid=2 is a match for the set 3,4,5.  empid=5 is not.</p>\n"},{"tags":["sql","sql-server","tsql"],"answer_count":8,"favorite_count":2,"up_vote_count":5,"down_vote_count":1,"view_count":20923,"score":4,"question_id":2072086,"title":"(T-SQL) Check if a procedure exists before creating it","body":"<p>I decided to edit my post since people didn't quite get what I'm trying to do (I suppose it was not irrelevant to say why I needed it after all):</p>\n\n<p>Ok, there we go. The thing is, I have a HUGE SQL script which many clients use and it has to be ran thoroughly every time a client executes the \"database management\" functionality that our software provides. So some of these clients might already have the procedure stored upon running the script, and some may not. I know this is stupid, I don't actually need this procedure to remain unstored, I can just check if it exists and create it if it doesn't. However, it doesn't matter how much I try to bend T-SQL syntax, there's always an error (always related to the fact that \"CREATE/ALTER PROCEDURE' must be the first statement in a query batch\"). That's why I came up with the drop before create thing. And I read around the web that it's the only way to do it, but I don't like the way it's done (suppose that should have been my post in the first place). </p>\n\n<p>Original Post:</p>\n\n<p>Hello. After some research, I found info only regarding PL/SQL on the matter, but what is proposed there doesn't work with T-SQL. I think it's irrelevant to point out why I need a non-stored procedure so you'll just gonna have to take my word when I say that I do. For now, I'm doing this:</p>\n\n<pre><code>IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'MyProc')\nDROP PROCEDURE MyProc\nGO\n\nCREATE PROCEDURE MyProc\n...\n</code></pre>\n\n<p>It works, but I wanted to know if there's a more effective/elegant way to do it?</p>\n"},{"tags":[".net","tsql","reporting-services","ssas","cube"],"answer_count":0,"favorite_count":0,"up_vote_count":0,"down_vote_count":0,"view_count":69,"score":0,"question_id":11976465,"title":"SSRS - CUBE - .NET : Passing parameters in URL","body":"<p>Have a bunch of parameters for a report. I am trying to pass one parameter to URL. When I press ENTER, I get \"Select a Value\" in dropdown parameter box.</p>\n\n<p>Source = Cube\nSSRS .rdl file\nTrying to run this on ReportServer</p>\n\n<p>At the end of url, I typed &amp;Parametername=Parametervalue (case sensitivity is correct).</p>\n\n<p>What am I doing wrong?</p>\n"}]}
